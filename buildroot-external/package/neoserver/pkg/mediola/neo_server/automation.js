var HARDWARE_VERSION="A1",FIRMWARE_VERSION="2.14.0",TASKMANAGER_VERSION="2.14.0",PLATFORM="CCU3",hasLocalStorage=!0;"undefined"!=typeof localStorage&&null!=localStorage||(hasLocalStorage=!1,localStorage={}),require("x.core.js");var v5Logger=require("x.logger.js").getLogger("x.v5plus");catchGlobalErrors(),v5Logger.log("info",new Date().toString()+" ===========> started");var os=require("os"),fs=require("fs"),path=require("path"),async=require("async"),ls=require("node-localstorage").LocalStorage,xhub=require("x.hub.js"),v5=require("x.hub.v5.js"),miot=require("xnm.aio.m10T.js"),pluginManager=require("x.hub.pluginmanager.js"),xnm=xnm||{};function _loadCompilerConfig(){void 0!==HARDWARE_VERSION&&HARDWARE_VERSION&&(global.HARDWARE_VERSION=HARDWARE_VERSION),void 0!==FIRMWARE_VERSION&&FIRMWARE_VERSION&&(global.FIRMWARE_VERSION=FIRMWARE_VERSION),"undefined"!=typeof FIRMWARE_BUILD&&FIRMWARE_BUILD&&(global.FIRMWARE_BUILD=FIRMWARE_BUILD),void 0!==TASKMANAGER_VERSION&&TASKMANAGER_VERSION&&(global.TASKMANAGER_VERSION=TASKMANAGER_VERSION),void 0!==PLATFORM&&PLATFORM&&(global.PLATFORM=PLATFORM),"undefined"!=typeof NAME&&NAME&&(global.NAME=NAME),"undefined"!=typeof VID&&VID&&(global.VID=VID),"undefined"!=typeof CLOUD_URL&&CLOUD_URL&&(global.CLOUD_URL=CLOUD_URL),"undefined"!=typeof CONTROL_SERVER&&CONTROL_SERVER&&(global.CONTROL_SERVER=CONTROL_SERVER),"undefined"!=typeof LOAD_MODULES&&LOAD_MODULES&&(global.LOAD_MODULES=LOAD_MODULES);}function _loadProgrammEnv(){if(process&&process.env){process.env.HARDWARE_VERSION&&(global.HARDWARE_VERSION=process.env.HARDWARE_VERSION),process.env.FIRMWARE_VERSION&&(global.FIRMWARE_VERSION=process.env.FIRMWARE_VERSION),process.env.FIRMWARE_BUILD&&(global.FIRMWARE_BUILD=process.env.FIRMWARE_BUILD),process.env.TASKMANAGER_VERSION&&(global.TASKMANAGER_VERSION=process.env.TASKMANAGER_VERSION),process.env.PLATFORM&&(global.PLATFORM=process.env.PLATFORM),process.env.NAME&&(global.NAME=process.env.NAME),process.env.VID&&(global.VID=process.env.VID),process.env.SYSTEM_ROOT&&(global.SYSTEM_ROOT=process.env.SYSTEM_ROOT);var e=require("path");process.env.DATA_FOLDER&&(global.DATA_FOLDER=e.isAbsolute(process.env.DATA_FOLDER)?process.env.DATA_FOLDER:e.resolve(__dirname,process.env.DATA_FOLDER)),process.env.APP_FOLDER&&(global.APP_FOLDER=e.isAbsolute(process.env.APP_FOLDER)?process.env.APP_FOLDER:e.resolve(__dirname,process.env.APP_FOLDER)),process.env.LOG_ROOT&&(global.LOG_ROOT=e.isAbsolute(process.env.LOG_ROOT)?process.env.LOG_ROOT:e.resolve(__dirname,process.env.LOG_ROOT));}}function _loadConfigFile(){function e(e){if(e)for(var r in e)e.hasOwnProperty(r)&&(global[r]="DATA_FOLDER"==r||"APP_FOLDER"==r||"LOG_ROOT"==r?path.isAbsolute(e[r])?e[r]:path.resolve(__dirname,e[r]):e[r]);}switch(global.HARDWARE_VERSION){case"A1":!function(){try{var r=require("./package.json");r&&e(r.config);}catch(r){}}();break;case"EA":case"CA":!function(){try{e(require("./config.json"));}catch(e){}}();}}function _loadRuntimeConfig(){switch(global.HARDWARE_VERSION){case"A1":if(null==global.PLATFORM)switch(os.platform()){case"darwin":global.PLATFORM="MAC";break;case"win32":global.PLATFORM="WIN";break;default:global.PLATFORM="LINUX";}null==global.NAME&&(global.NAME="NEO SERVER"),null==global.VID&&(global.VID=null),null==global.CLOUD_URL&&(global.CLOUD_URL="https://webservice.mediola.com"),null==global.CONTROL_SERVER&&(global.CONTROL_SERVER="v5ws.mediola.com"),null==global.LOAD_MODULES&&(global.LOAD_MODULES=["knx","sonos"]),null==global.DATA_FOLDER&&(global.DATA_FOLDER=null),null==global.APP_FOLDER&&(global.APP_FOLDER=null),null==global.LOG_ROOT&&(global.LOG_ROOT=null),null==global.LOG_LEVEL&&(global.LOG_LEVEL="fatal"),null==global.WEB_SERVER_PORT&&(global.WEB_SERVER_PORT=8088),null==global.HM_CHIP&&(global.HM_CHIP=null),null==global.HM_LOCAL_PORT&&(global.HM_LOCAL_PORT=9099),null==global.ENOCEAN_PORT&&(global.ENOCEAN_PORT=null),null==global.ZWAVE2_URL&&(global.ZWAVE2_URL=null),null==global.ZWAVE2_PORT&&(global.ZWAVE2_PORT=null),null==global.ZIGBEE_URL&&(global.ZIGBEE_URL=null),null==global.STM&&(global.STM=null);break;case"EA":if(null==global.PLATFORM&&(global.PLATFORM="A20"),null==global.NAME&&(global.NAME="AIO GATEWAY V5+"),null==global.VID&&(global.VID=null),null==global.CLOUD_URL&&(global.CLOUD_URL="https://webservice.mediola.com"),null==global.CONTROL_SERVER&&(global.CONTROL_SERVER="v5ws.mediola.com"),null==global.LOAD_MODULES&&(global.LOAD_MODULES=["enocean","zway","knx","zigbee","sonos"]),null==global.DATA_FOLDER&&(global.DATA_FOLDER=path.resolve(__dirname,"./data")),null==global.APP_FOLDER&&(global.APP_FOLDER=path.resolve(__dirname,"./")),null==global.LOG_ROOT&&(global.LOG_ROOT="/var/log"),null==global.LOG_LEVEL&&(global.LOG_LEVEL="fatal"),null==global.WEB_SERVER_PORT&&(global.WEB_SERVER_PORT=80),null==global.HM_CHIP&&(global.HM_CHIP="127.0.0.1"),null==global.HM_LOCAL_PORT&&(global.HM_LOCAL_PORT=9099),null==global.ENOCEAN_PORT&&(global.ENOCEAN_PORT=null),null==global.ZWAVE2_URL&&(global.ZWAVE2_URL="127.0.0.1"),null==global.ZWAVE2_PORT&&(global.ZWAVE2_PORT=9e3),null==global.ZIGBEE_URL&&(global.ZIGBEE_URL="127.0.0.1"),!global.STM)switch(global.PLATFORM){case"MAC":case"WIN":global.STM=null;break;case"A20":global.STM="/dev/ttyS2";break;case"PI2":global.STM="/dev/spidev0.1";break;default:global.STM="/dev/ttyACM0";}break;case"CA":null==global.PLATFORM&&(global.PLATFORM="PI-CM3+"),null==global.NAME&&(global.NAME="AIO GATEWAY V6+"),null==global.VID&&(global.VID=null),null==global.CLOUD_URL&&(global.CLOUD_URL="https://webservice.mediola.com"),null==global.CONTROL_SERVER&&(global.CONTROL_SERVER="v6p-ccs.mediola.com"),null==global.LOAD_MODULES&&(global.LOAD_MODULES=["enocean","zway","knx","sonos","mbus"]),null==global.DATA_FOLDER&&(global.DATA_FOLDER=path.resolve(__dirname,"./data")),null==global.APP_FOLDER&&(global.APP_FOLDER=path.resolve(__dirname,"./")),null==global.LOG_ROOT&&(global.LOG_ROOT="/var/log"),null==global.LOG_LEVEL&&(global.LOG_LEVEL="fatal"),null==global.WEB_SERVER_PORT&&(global.WEB_SERVER_PORT=80),null==global.HM_CHIP&&(global.HM_CHIP=null),null==global.HM_LOCAL_PORT&&(global.HM_LOCAL_PORT=9099),null==global.ENOCEAN_PORT&&(global.ENOCEAN_PORT=null),null==global.ZWAVE2_URL&&(global.ZWAVE2_URL="127.0.0.1"),null==global.ZWAVE2_PORT&&(global.ZWAVE2_PORT=9e3),null==global.ZIGBEE_URL&&(global.ZIGBEE_URL="127.0.0.1"),global.STM||("PI-CM3+"===global.PLATFORM?global.STM="/dev/ttyAMA0":global.STM="/dev/ttyACM0");}void 0!==global.CONTROL_SERVER&&global.CONTROL_SERVER&&(require("x.hub.v5.js").CloudConnect.prototype.CLOUD_SERVER=global.CONTROL_SERVER),void 0!==global.CLOUD_URL&&global.CLOUD_URL&&(require("x.hub.taskman.js").Cloud.prototype.URL=global.CLOUD_URL),void 0!==global.TASKMANAGER_VERSION&&global.TASKMANAGER_VERSION&&(require("x.hub.taskman.js").TaskManager.NS_VERSION=global.TASKMANAGER_VERSION);}function _setupServer(){var e=null;switch(global.HARDWARE_VERSION){case"CA":e=new xhub.ServerV6(global.STM),pluginManager.init(e);break;case"A1":e=new xhub.ServerNEO(global.STM);break;default:switch(global.PLATFORM){case"MAC":case"WIN":case"A20":default:e=new xhub.Server(global.STM);break;case"PI2":e=new xhub.Server(global.STM,null,"gpio26");break;case"PI-CM3+":e=new xhub.ServerV6(global.STM),pluginManager.init(e);}}e.hostType=global.PLATFORM,xhub.server=e,v5.server=e,e.HWV=global.HARDWARE_VERSION,e.VERSION=global.FIRMWARE_VERSION,e.BUILD=global.FIRMWARE_BUILD,e.DEFAULT_NAME=global.NAME;var r=null,n=Date.now();e.on("serialevent",function(t,a){require("x.logger.js").getLogger("x.hub.m.gateway.Serial").log("trace","SERIAL EVENT: "+t);var o=r,s=Date.now()-n;if(n=Date.now(),r=t,!(o==t&&s<1e3)){var i=null;try{i=JSON.parse(t);}catch(e){}i&&(require("x.hub.eventbus.js").emit("gatewayevent",i,{address:"ST"},a),"EVT"!=a&&"STA"!=a||e.sendUDPMessage(a+":"+JSON.stringify(i)+"\r\n"));}});var t=require("x.hub.v6.js");t._centralUnit=new t.CentralUnit(e),t._centralUnit.init(),e.setCmdFunc("refreshhm",function(e,r){r(JSON.stringify({XC_SUC:{}}));}),"EA"==global.HARDWARE_VERSION&&e.setCmdFunc("resethm",function(e,r){require("x.hub.m.hm.js").resetChip(function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("addSensor",function(e,r){e.query.type&&"ENOCEAN"==e.query.type.toUpperCase()&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.enocean.js").addSensor(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{}}));}):r(null);}),e.setCmdFunc("LearnSC",function(e,r){if(e.query.type&&"HM"==e.query.type.toUpperCase()&&"CA"!=global.HARDWARE_VERSION){var n=require("x.hub.m.hm.js");e.query.key&&e.query.sgtin?n.learnIPDevice(null,e.query.sgtin,e.query.key,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{devices:e.data}}));}):e.query.qrkey?n.learnIPDeviceQR(null,e.query.qrkey,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{devices:e.data}}));}):e.query.adr?n.learnRFDeviceSN(null,e.query.adr,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{devices:e.data}}));}):n.learnRFDevice(null,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{devices:e.data}}));});}else e.query.type&&"ENOCEAN"==e.query.type.toUpperCase()&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.enocean.js").learnDevice(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:e.data}));}):e.query.type&&"ZIGBEE"==e.query.type.toUpperCase()?require("x.hub.m.zigbee.js").learnDevice(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:e.data}));}):r(null);}),e.setCmdFunc("SendSC",function(r,n){if(r.query.type&&"HM"==r.query.type.toUpperCase()&&"CA"!=global.HARDWARE_VERSION){if(!r.query.address||!r.query.data)return void n(JSON.stringify({XC_ERR:{code:"001000",msg:"address or data invalid"}}));require("x.hub.m.hm.js").executeCommandLegacy(null,r.query.address,r.query.data,function(e){e.error?n(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):n(JSON.stringify({XC_SUC:{}}));});}else if(r.query.type&&"ENOCEAN"==r.query.type.toUpperCase()&&"CA"!=global.HARDWARE_VERSION){if(!r.query.address||!r.query.data)return void n(JSON.stringify({XC_ERR:{code:"001000",msg:"address or data invalid"}}));require("x.hub.m.enocean.js").executeCommandLegacy(null,r.query.address,r.query.data,function(e){e.error?n(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):n(JSON.stringify({XC_SUC:{}}));});}else if(r.query.type&&"ZWAVE"==r.query.type.toUpperCase()){if(!r.query.address||!r.query.data||!r.query.devicetype)return void n(JSON.stringify({XC_ERR:{code:"001000",msg:"address or data or devicetype invalid"}}));require("x.hub.m.zwave.js").executeCommandLegacy(null,r.query.address,r.query.devicetype,r.query.data,function(e){e.error?n(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):n(JSON.stringify({XC_SUC:{}}));});}else r.query.type&&"ZWAVE2"==r.query.type.toUpperCase()?require("x.hub.m.zway.js").executeCommandLegacy(r.query.address,r.query.data,function(e){e.error?n(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):n(JSON.stringify({XC_SUC:{}}));}):r.query.type&&"KNX"==r.query.type.toUpperCase()?require("x.hub.m.knx.js").executeCommandLegacy(r.query.address,r.query.data,function(e){e.error?n(JSON.stringify({XC_ERR:{code:e.error.code?e.error.code:"001000",msg:e.error.message}})):n(JSON.stringify({XC_SUC:{}}));}):r.query.type&&"ZIGBEE"==r.query.type.toUpperCase()?require("x.hub.m.zigbee.js").executeCommandLegacy(r.query.address,r.query.data,function(e){e.error?n(JSON.stringify({XC_ERR:{code:e.error.code?e.error.code:"001000",msg:e.error.message}})):n(JSON.stringify({XC_SUC:{}}));}):r.query.type&&"RGB"==r.query.type.toUpperCase()&&"CA"==global.HARDWARE_VERSION?e.setLED(r.query.data,function(e){n(e?JSON.stringify({XC_ERR:{code:e.code?e.code:"001000",msg:e.message}}):JSON.stringify({XC_SUC:{}}));}):r.query.type&&"MBUS"==r.query.type.toUpperCase()?require("x.hub.m.mbus.js").executeCommandLegacy(r.query,function(e){e.error?n(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):n(JSON.stringify({XC_SUC:{}}));}):n(null);}),e.setCmdFunc("delSensor",function(e,r){if(e.query.type&&"HM"==e.query.type.toUpperCase()&&"CA"!=global.HARDWARE_VERSION){if(!e.query.adr)return void r(JSON.stringify({XC_ERR:{code:"001000",msg:"adr invalid"}}));require("x.hub.m.hm.js").deleteDevice(null,e.query.adr,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{}}));});}else e.query.type&&"ENOCEAN"==e.query.type.toUpperCase()&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.enocean.js").delSensor(e.query.address,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{}}));}):e.query.type&&"ZIGBEE"==e.query.type.toUpperCase()&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.zigbee.js").removeDevice(e.query.address,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{}}));}):r(null);}),e.setCmdFunc("setVar",function(e,r){require("x.hub.sysvarman.js").setVar(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("delVar",function(e,r){require("x.hub.sysvarman.js").delVar(e.query.id,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCommandFunc("setVar",function(e,r){require("x.hub.sysvarman.js").setVar(e.query,function(e){e.error?r.send("{XC_ERR}"+JSON.stringify({code:"010000",msg:e.error.message})):r.send("{XC_SUC}{}");});}),e.setCommandFunc("delVar",function(e,r){require("x.hub.sysvarman.js").delVar(e.query.id,function(e){e.error?r.send("{XC_ERR}"+JSON.stringify({code:"010000",msg:e.error.message})):r.send("{XC_SUC}{}");});});var a=[],o=null;return e.setCmdFunc("getStates",function(e,r){var n=function n(e,r){e&&(v5Logger.log("error","error in get states"),v5Logger.log("error",e));var n=a;a=[],e?n.forEach(function(r){r(JSON.stringify({XC_ERR:{code:"001000",msg:e.message}}));}):r.length>0?n.forEach(function(e){e(JSON.stringify({XC_SUC:r}));}):n.forEach(function(e){e(JSON.stringify({XC_SUC:{}}));});},t=[],s=[],i=[],u=a.length,l=new Date().getTime();0!=u&&l-o>18e4&&(n(new Error("get states dead lock")),u=a.length),-1==a.indexOf(r)&&a.push(r),0==u&&(o=new Date().getTime(),async.parallel([function(r){var n=function n(r){var n=e.url;if("POST"==e.method&&e.json){var t=require("url"),a=t.parse(n,!0);if(a.query)for(var o in e.json)a.query[o]=e.json[o];n=t.format(a);}var s=setTimeout(function(){r&&(r({type:"ST_ERROR",state:"st timeout"}),r=null);},1e4);xhub.server._doSTMCommandRequest(n,!1,function(e){if(s&&(clearTimeout(s),s=null),r){try{var n=[],t=JSON.parse(e);t.XC_SUC?(Array.isArray(t.XC_SUC)?n=n.concat(t.XC_SUC):Object.keys(t.XC_SUC).length>0&&(n=n.push(t.XC_SUC)),r(null,n)):r({type:"ST_ERROR",state:"st return:"+e});}catch(e){r({type:"ST_ERROR",state:"st return invalid json"});}r=null;}});};if("EA"==global.HARDWARE_VERSION||"CA"==global.HARDWARE_VERSION){if(localStorage&&"true"==localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"))return void r();n(function(e,t){e?(v5Logger.log("error","retry get states #1 due to ST error:"+JSON.stringify(e)),n(function(e,t){e?(v5Logger.log("error","retry get states #2 due to ST error:"+JSON.stringify(e)),n(function(e,n){e?s.push(e):s=s.concat(n),r();})):(s=s.concat(t),r());})):(s=s.concat(t),r());});}else r();},function(e){"EA"!=global.HARDWARE_VERSION?e():require("x.hub.m.hm.js").getAllStatesLegacy(function(r){r.error?(t.push({type:"HM_ERROR",state:r.error}),e()):(t=t.concat(r.data),e());});},function(r){-1==global.LOAD_MODULES.indexOf("enocean")||"CA"==global.HARDWARE_VERSION?r():require("x.hub.m.enocean.js").getAllStatesLegacy(function(e){e.error?(t.push({type:"ENOCEAN_ERROR",state:e.error}),r()):(t=t.concat(e.data),r());},e.query);},function(e){-1==global.LOAD_MODULES.indexOf("zwave")?e():require("x.hub.m.zwave.js").getAllStatesLegacy(function(r){r.error?(t.push({type:"ZWAVE_ERROR",state:r.error}),e()):(t=t.concat(r.data),e());});},function(e){-1==global.LOAD_MODULES.indexOf("zway")?e():require("x.hub.m.zway.js").getAllStatesLegacy(function(r){r.error?(t.push({type:"ZWAVE2_ERROR",state:r.error}),e()):(t=t.concat(r.data),e());});},function(e){-1==global.LOAD_MODULES.indexOf("mbus")?e():require("x.hub.m.mbus.js").getAllStatesLegacy(function(r){r.error?(t.push({type:"MBUS_ERROR",state:r.error}),e()):(t=t.concat(r.data),e());});},function(e){-1==global.LOAD_MODULES.indexOf("knx")?e():require("x.hub.m.knx.js").getAllStatesLegacy(function(r){r.error?(t.push({type:"KNX_ERROR",state:r.error}),e()):(t=t.concat(r.data),e());});},function(e){-1==global.LOAD_MODULES.indexOf("zigbee")?e():require("x.hub.m.zigbee.js").getAllStatesLegacy(function(r){r.error?(t.push({type:"ZIGBEE_ERROR",state:r.error}),e()):(t=t.concat(r.data),e());});},function(e){require("x.hub.taskman.js").readAllTasks(function(r){if(r.error)t.push({type:"TASK_ERROR",state:r.error}),e();else{var n=[];r.data.forEach(function(e){e&&n.push({type:"TASK",id:e.id,active:e.active});}),t=t.concat(n),e();}});},function(e){require("x.hub.sysvarman.js").getSysvarStates(function(r){r.error?(t.push({type:"SYSVAR_ERROR",state:r.error}),e()):(i=i.concat(r.data),e());});}],function(e){e?n(e,t):s&&s.length>0?require("x.hub.sysvarman.js").processSysvarST(xhub.server,s,function(r){r&&!r.error&&r.data&&r.data.length>0&&(t=t.concat(r.data)),n(e,t);}):(i&&i.length>0&&(t=t.concat(i)),n(e,t));}));}),e.setCmdFunc("GetSI",function(r,n){e.getTimeZoneCompatiable(function(r,t){e.doSTMCommand("XC_FNC=GetSI",function(a){a&&a.XC_SUC&&(a.XC_SUC.HWV=e.HWV,a.XC_SUC.FWV_ST=a.XC_SUC.FWV,a.XC_SUC.FWV=e.VERSION,!r&&t&&(a.XC_SUC.TZ=t+"")),n(JSON.stringify(a));});});}),e.setCommandFunc("GetSI",function(r,n){e.getTimeZoneCompatiable(function(r,t){e.doSTMCommand("XC_FNC=GetSI",function(a){a&&a.XC_SUC?(a.XC_SUC.HWV=e.HWV,!r&&t&&(a.XC_SUC.TZ=t+""),n.send("{XC_SUC}"+JSON.stringify(a.XC_SUC))):n.send("{XC_ERR}");});});}),e.setCommandFunc("setTZ",function(r,n){var t=r.query.data;e.setTimeZoneCompatiable(t,function(e){e?n.send("{XC_ERR}"):n.send("{XC_SUC}");});}),e.setCmdFunc("setTZ",function(r,n){var t=r.query.data;e.setTimeZoneCompatiable(t,function(e){n(e?JSON.stringify({XC_ERR:{}}):JSON.stringify({XC_SUC:{}}));});}),e.setCommandFunc("setLocation",function(r,n){var t=r.query;e.setLocation(t?t.lat:null,t?t["long"]:null,function(e){n(e?JSON.stringify({XC_ERR:{code:e.code?e.code:"000000",msg:e.message}}):JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("setLocation",function(r,n){var t=r.query;e.setLocation(t?t.lat:null,t?t["long"]:null,function(e){n(e?JSON.stringify({XC_ERR:{code:e.code?e.code:"000000",msg:e.message}}):JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("SendM",function(e,r){if(e.query&&e.query.m&&e.query.cmd){var n=e.query.m,t=e.query.cmd;delete e.query.XC_FNC,delete e.query.m,delete e.query.cmd;var a=null;try{a=require("x.hub.m."+n+".js");}catch(e){}a&&a.executeCommand?a.executeCommand(e.query,t,function(){r('{"XC_SUC":{}}');}):r('{"XC_ERR":{"code":"000000","msg":"internal error"}}');}else r('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),e.setCmdFunc("GetM",function(e,r){if(e.query&&e.query.m){var n=e.query.m;delete e.query.XC_FNC,delete e.query.m;var t=null;try{t=require("x.hub.m."+n+".js");}catch(e){}t&&t.updateStates?t.updateStates(e.query,function(e){r(e?'{"XC_SUC":'+JSON.stringify(e)+"}":'{"XC_SUC":{}}');}):r('{"XC_ERR":{"code":"000000","msg":"internal error"}}');}else r('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),e.setCmdFunc("SendRM",function(e,r){require("x.logger.js").getLogger("x.hub.v5.CloudConnect").log("debug","execute command:"+JSON.stringify(e.query)),e.query?require("x.hub.commandman.js").commandHandler2.executeCommandWithIdx(e.query.device,e.query.gateway,e.query.command,function(e){e.error?r('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):r('{"XC_SUC":{}}');}):r('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),e.setCmdFunc("GetRM",function(e,r){require("x.logger.js").getLogger("x.hub.v5.CloudConnect").log("debug","get states:"+JSON.stringify(e.query)),e.query?require("x.hub.commandman.js").commandHandler2.getStateWithIdx(e.query.device,e.query.gateway,e.query.status,function(e){e.error?r('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):r('{"XC_SUC":'+JSON.stringify(e.data)+"}");}):r('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),e.setCmdFunc("DoMacroRM",function(e,r){require("x.logger.js").getLogger("x.hub.v5.CloudConnect").log("debug","execute macro:"+JSON.stringify(e.query)),e.query?require("x.hub.macroman.js").executeWithIdx2(e.query.groupIdx,e.query.macroIdx,function(e){e.error?r('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):r('{"XC_SUC":{}}');}):r('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),e.setCmdFunc("GetTask",function(e,r){require("x.hub.taskman.js").doWebRequest("Read",e,r);}),e.setCmdFunc("CreateTask",function(e,r){require("x.hub.taskman.js").doWebRequest("Create",e,r);}),e.setCmdFunc("UpdateTask",function(e,r){require("x.hub.taskman.js").doWebRequest("Update",e,r);}),e.setCmdFunc("DeleteTask",function(e,r){require("x.hub.taskman.js").doWebRequest("Delete",e,r);}),e.setCmdFunc("DoTask",function(e,r){require("x.hub.taskman.js").doWebRequest("Do",e,r);}),e.setCmdFunc("CancelTask",function(e,r){require("x.hub.taskman.js").doWebRequest("Cancel",e,r);}),e.setCmdFunc("IsTaskRunning",function(e,r){require("x.hub.taskman.js").doWebRequest("isRunning",e,r);}),e.setCmdFunc("SetTaskActive",function(e,r){require("x.hub.taskman.js").doWebRequest("SetTaskActive",e,r);}),e.setCmdFunc("ToggleTaskActive",function(e,r){require("x.hub.taskman.js").doWebRequest("ToggleTaskActive",e,r);}),e.setCmdFunc("SetAlarmActive",function(e,r){require("x.hub.taskman.js").doWebRequest("SetAlarmActive",e,r);}),e.setCmdFunc("SetAlarmDelay",function(e,r){require("x.hub.taskman.js").doWebRequest("SetAlarmDelay",e,r);}),e.setCmdFunc("GetAlarmInfo",function(e,r){require("x.hub.taskman.js").doWebRequest("GetAlarmInfo",e,r);}),e.setCmdFunc("SelectAlarmTask",function(e,r){require("x.hub.taskman.js").doWebRequest("SelectAlarmTask",e,r);}),e.setCmdFunc("SetAlarmPin",function(e,r){require("x.hub.taskman.js").doWebRequest("SetAlarmPin",e,r);}),e.setCmdFunc("GetCloudServer",function(e,r){require("x.hub.taskman.js").doWebRequest("GetCloudServer",e,r);}),e.setCmdFunc("SetCloudServer",function(e,r){require("x.hub.taskman.js").doWebRequest("SetCloudServer",e,r);}),e.setCmdFunc("GetCloudDeviceTriggerGateway",function(e,r){require("x.hub.taskman.js").doWebRequest("GetCloudDeviceTriggerGateway",e,r);}),e.setCommandFunc("SendSC",function(r,n){r.query.type&&"RGB"==r.query.type.toUpperCase()&&"CA"==global.HARDWARE_VERSION?e.setLED(r.query.data,function(e){e?n.send("{XC_ERR}"+JSON.stringify({code:e.code?e.code:"001000",msg:e.message})):n.send("{XC_SUC}"+JSON.stringify({}));}):e._doSTMCommandRequest(r.url,!0,function(e){n.send(e);});}),"EA"==global.HARDWARE_VERSION&&(e.setCmdFunc("RehauPinChallenge",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauPinChallenge",e,r);}),e.setCmdFunc("RehauGetAlarmInfo",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauGetAlarmInfo",e,r);}),e.setCmdFunc("RehauSetAlarmDelay",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauSetAlarmDelay",e,r);}),e.setCmdFunc("RehauSetDoorAlarmDelay",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauSetDoorAlarmDelay",e,r);}),e.setCmdFunc("RehauSetNewPin",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauSetNewPin",e,r);}),e.setCmdFunc("RehauSelectAssociateTaskAlarm",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauSelectAssociateTaskAlarm",e,r);}),e.setCmdFunc("RehauSelectAssociateTaskPreAlarm",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauSelectAssociateTaskPreAlarm",e,r);}),e.setCmdFunc("RehauSetAlarmActive",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauSetAlarmActive",e,r);}),e.setCmdFunc("RehauAddAlarmKey",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauAddAlarmKey",e,r);}),e.setCmdFunc("RehauUpdateAlarmKey",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauUpdateAlarmKey",e,r);}),e.setCmdFunc("RehauDeleteAlarmKey",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauDeleteAlarmKey",e,r);}),e.setCmdFunc("RehauAddAlarmDoor",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauAddAlarmDoor",e,r);}),e.setCmdFunc("RehauUpdateAlarmDoor",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauUpdateAlarmDoor",e,r);}),e.setCmdFunc("RehauDeleteAlarmDoor",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauDeleteAlarmDoor",e,r);}),e.setCmdFunc("RehauSetAlarmConfirmation",function(e,r){require("x.hub.taskman.js").doWebRequest("RehauSetAlarmConfirmation",e,r);})),e.setCmdFunc("AddEventListener",function(e,r){var n=e.query.data;if(n&&n.sys){var t=require("x.hub.moduleman.js").modulemanager.getModule(n.sys);t?t.addStateDevice(n,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"000000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{}}));}):r(JSON.stringify({XC_ERR:{code:"000000",msg:"no module for sys:"+n.sys}}));}else r(JSON.stringify({XC_ERR:{code:"000000",msg:"device format invalid"}}));}),e.setCmdFunc("GetMetaInfo",function(e,r){var n=require("x.hub.taskman.js").taskManager,t={XC_SUC:{version:String(n.version),deploy:{time:localStorage.getItem("x.hub.hubsyncman.SyncManager.TIMESTAMP"),userid:localStorage.getItem("x.hub.hubsyncman.SyncManager.USERID"),appid:localStorage.getItem("x.hub.hubsyncman.SyncManager.APPID")}}};"A1"==global.HARDWARE_VERSION&&(t.XC_SUC.trial=n._mode%31!=0),r(JSON.stringify(t));}),e.setCmdFunc("GetUSBDevices",function(e,r){require("x.hub.peripheralman.js").getUSBDevices(function(e){e.error?r(JSON.stringify({XC_ERR:{message:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("SetLogger",function(e,r){e.query.level?require("x.hub.logman.js").setLoggger(e.query.tag,e.query.level,function(){r(JSON.stringify({XC_SUC:{}}));}):r(JSON.stringify({XC_ERR:{message:"parameter invalid",code:"010001"}}));}),e.setCmdFunc("GetLogger",function(e,r){var n=require("x.logger.js").getAll();r(JSON.stringify({XC_SUC:n}));}),e.setCmdFunc("DummyEvent",function(e,r){var n=require("x.hub.eventbus.js"),t=e.query.data,a=e.query.type;switch(a||(a="status"),a){case"status":n.emit("status",t);break;case"gatewayevent":var o=e.query.rinfo,s=e.query.tag;n.emit("gatewayevent",t,o,s);break;case"hm":require("x.hub.m.hm.js").onDeviceEvent(t,!0);break;default:n.emit(a,t);}r(JSON.stringify({XC_SUC:{}}));}),e.setCmdFunc("DummyTaskmanEvent",function(e,r){var n=e.query.event,t=e.query.meta;require("x.hub.taskman.js").onStatusEvt(n,t),r(JSON.stringify({XC_SUC:{}}));}),e.setCmdFunc("DirectEvent",function(e,r){var n=e.query.event,t=e.query.tag;require("x.hub.m.gateway.js")._onEvent(n,{address:"http call"},t),r(JSON.stringify({XC_SUC:{}}));}),e.setCmdFunc("GetHmMonitors",function(e,r){require("x.hub.m.hm.js").getMonitorStates(function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),"EA"==global.HARDWARE_VERSION?(e.setCmdFunc("gethmconfig",function(e,r){e.query.address?require("x.hub.m.hm.js").getConfig({address:e.query.address},function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{config:e.data}}));}):r(null);}),e.setCmdFunc("sethmconfig",function(e,r){e.query.address&&e.query.config?require("x.hub.m.hm.js").setConfig({address:e.query.address},e.query.config,function(e){e.error?r(JSON.stringify({XC_ERR:{code:"001000",msg:e.error.message}})):r(JSON.stringify({XC_SUC:{}}));}):r(null);}),e.setCmdFunc("GetHmDevices",function(e,r){require("x.hub.m.hm.js").getAllDevices(function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ConfigSiegeniaWindow",function(e,r){require("x.hub.m.enocean.js").configSiegeniaWindow(null,null,function(e){e.error?r(JSON.stringify({XC_ERR:{message:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("AddEnoceanVirtualDevice",function(e,r){require("x.hub.m.enocean.js").generateVirtualDevice(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("AddEnoceanDevice",function(e,r){require("x.hub.m.enocean.js").addSensor(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("UpdateEnoceanDevice",function(e,r){var n=require("x.hub.m.enocean.js"),t=e.query.address,a=e.query.device;n.updateSensor(t,a,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("TeachinEnocean",function(e,r){require("x.hub.m.enocean.js").teachinDevice(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("EnOceanSDK",function(e,r){require("x.hub.m.enocean.js")._doSDK(e.query.data,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ResetEnOceanSenderID",function(e,r){require("x.hub.m.enocean.js").resetDefaultSenderID(function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("SetRehauInoventHumidityAccessory",function(e,r){require("x.hub.m.enocean.js").setInoventHumidityAccessory(e.query.inoventID,e.query.humiditySensorID,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("SetRehauInoventCo2Accessory",function(e,r){require("x.hub.m.enocean.js").setInoventCo2Accessory(e.query.inoventID,e.query.co2SensorID,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("GetRehauInoventAccessories",function(e,r){require("x.hub.m.enocean.js").getInoventAccessories(e.query.inoventID,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("RawEnoceanPacket",function(e,r){var n=e.query.data;require("x.hub.m.enocean.js").__simulateRawEnoceanPacket(n,function(e){r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("SendESPFrame",function(e,r){var n=e.query.type,t=e.query.data,a=e.query.optData,o=e.query.requireResponse;require("x.hub.m.enocean.js").__sendEspFrame(n,t,a,o,function(e){e.error?r(JSON.stringify({XC_ERROR:{message:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});})):"CA"==global.HARDWARE_VERSION&&e.setCmdFunc("SetFGW14Baudrate",function(e,r){var n=require("x.hub.m.enocean.js");e.query&&e.query.baudrate&&!isNaN(parseInt(e.query.baudrate))?n.setFGW14Baudrate(parseInt(e.query.baudrate),function(e){e.error?r(JSON.stringify({XC_ERR:{message:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:{}}));}):r(JSON.stringify({XC_ERR:{message:"invalid request",code:"000000"}}));}),e.setCmdFunc("ZWaveInclusion",function(e,r){require("x.hub.m.zway.js").learnDevice(e.query,function(e,r,n){console.log("learn zwave procedure",e,r,n);},function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ZWaveExclusion",function(e,r){require("x.hub.m.zway.js").removeDevice(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ZWaveListDevices",function(e,r){require("x.hub.m.zway.js").listDevices(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ZWaveListInterviewResults",function(e,r){require("x.hub.m.zway.js").listInterviewResults(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ZWaveResetController",function(e,r){require("x.hub.m.zway.js").resetController(function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ZWaveSetDeviceSetting",function(e,r){require("x.hub.m.zway.js").setDeviceSetting(e.query.deviceID,e.query.setting,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ZWaveGetDeviceSetting",function(e,r){require("x.hub.m.zway.js").getDeviceSetting(e.query.deviceID,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ZWaveForcePollDevices",function(e,r){var n=require("x.hub.m.zway.js");if(e.query.deviceIDs){var t=e.query.deviceIDs.split(",");n.forcePoll(t,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}else r(JSON.stringify({XC_ERR:{msg:"no device id list",code:"000000"}}));}),e.setCmdFunc("GetZwaveStates",function(e,r){var n=e.query.devices;require("x.hub.m.zwave.js").__getStates(n,function(e){e.error?r(JSON.stringify({XC_ERROR:{message:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("GetKnxIpGateways",function(e,r){require("x.hub.m.knx.js").getIPGateways(function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("AddKnxIpGateway",function(e,r){var n=e.query.data;require("x.hub.m.knx.js").addIPGateway(n,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("UptateKnxIpGateway",function(e,r){var n=e.query.data;require("x.hub.m.knx.js").updateIPGateway(n,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("DeleteKnxIpGateway",function(e,r){var n=e.query.data;require("x.hub.m.knx.js").deleteIPGateway(n,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("GetKnxDevices",function(e,r){require("x.hub.m.knx.js").getDevices(function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("AddKnxDevice",function(e,r){var n=e.query.data;require("x.hub.m.knx.js").addDevice(n,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("UptateKnxDevice",function(e,r){var n=e.query.data;require("x.hub.m.knx.js").updateDevice(n,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("DeleteKnxDevice",function(e,r){var n=e.query.data;require("x.hub.m.knx.js").deleteDevice(n,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("ListKnxMonitors",function(e,r){require("x.hub.m.knx.js").listMonitors(function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("SearchKnxIpGateways",function(e,r){require("x.hub.m.knx.js").searchKNXGateway(function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("DoZigbeeNativeCommandRaw",function(e,r){require("x.hub.m.zigbee.js").executeCommandNativeRaw(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("ListZigbeeDevices",function(e,r){require("x.hub.m.zigbee.js").listDevices(e.query,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:e.data}));});}),e.setCmdFunc("RefreshMbusDeviceStates",function(e,r){var n=e.query.address;require("x.hub.m.mbus.js").updateStates(n,function(e){e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:{}}));});}),e.setCmdFunc("DummyMbusMessage",function(e,r){var n=e.query.message;require("x.hub.m.mbus.js").dummyMbusMessage(n,function(e){e&&e.error?r(JSON.stringify({XC_ERR:{msg:e.error.message,code:e.error.code}})):r(JSON.stringify({XC_SUC:{}}));});}),"EA"==global.HARDWARE_VERSION&&(e.setCommandFunc("AddGroup",function(e,r){r.send("{XC_SUC}");}),e.setCommandFunc("setTaskDeviceAddress",function(e,r){var n=e.query.device,t=e.query.address;n&&t&&devices[n]&&(devices[n].address=t,localStorage&&localStorage.setItem("xnm.aio.xhub.siegenia."+n,t)),r.send("{XC_SUC}");}),e.setCommandFunc("getTaskDeviceAddress",function(e,r){var n="{XC_ERR}",t=e.query.device;t&&devices[t]&&(n='{XC_SUC}{"address":"'+devices[t].address+'"}'),r.send(n);}),e.setCommandFunc("setAlarmGroup",function(e,r){for(var n in taskmanager._tasks)n>=80&&("1"==e.query.active?taskmanager._tasks[n].active=!0:taskmanager._tasks[n].active=!1);r.send("{XC_SUC}");}),e.setCommandFunc("DelGroup",function(e,r){var n="{XC_ERR}",t=parseInt(e.query.id),a=parseInt(e.query.nid);taskmanager._tasks[t]&&e.query.nid&&(taskmanager._tasks[a]=taskmanager._tasks[t],delete taskmanager._tasks[t],n="{XC_SUC}"),r.send(n);}),e.setCommandFunc("saveGroup",function(e,r){var n="{XC_ERR}",t=parseInt(e.query.id);taskmanager._tasks[t]&&("1"==e.query.active?taskmanager._tasks[t].active=!0:taskmanager._tasks[t].active=!1,n="{XC_SUC}"),r.send(n);}),e.setCommandFunc("GetAll",function(e,r){var n="",t=1,a=1;for(var o in taskmanager._tasks){var s=taskmanager._tasks[o],i="0";s.active&&(i="1");var u="",l="",c=0;for(c=0;c<s.trigger.length;c++)s.trigger[c],l+=XC.getHexVal(t,2),""!=n&&(n+=","),n+='{"sys":"EVENT","id":"'+XC.getHexVal(t++,2)+'","code":""}';for(c=0;c<s.action.length;c++)s.action[c],u+=XC.getHexVal(a,2),""!=n&&(n+=","),n+='{"sys":"ACTION","id":"'+XC.getHexVal(a++,2)+'","code":""}';""!=n&&(n+=","),n+='{"sys":"GROUP","id":"'+XC.getHexVal(o,2)+'","name":"'+s.name+'","active":"'+i+'","triggerids":"'+l+'","actionids":"'+u+'"}';}n="{XC_SUC}["+n+"]",r.send(n);})),e;}function _setupAutomationManagerMode(e){function r(e){var r=require("crypto"),n=new Buffer("fO4gAeDjh4HwO0D8+/9Bfw==","base64"),t=new Buffer("+ubtPBJR9uejkjXiN6c1Bg==","base64"),a=r.createDecipheriv("aes-128-cbc",n,t);a.setAutoPadding(!0);var o=[a.update(new Buffer(e,"base64"))];return o.push(a["final"]()),Buffer.concat(o).toString("utf8");}function n(e){if(!e)return 31*t(23,76)+2;try{var n=r(e);if(n.length<10||"t"!=n.charAt(0)||"a"!=n.charAt(2)||"k"!=n.charAt(9))return 31*t(23,76)+2;var a=n.charAt(1)+""+n.charAt(5)+n.charAt(6);return 31*parseInt(a);}catch(e){return 31*t(23,76)+2;}}function t(e,r){return e=Math.ceil(e),r=Math.floor(r),Math.floor(Math.random()*(r-e))+e;}var a=e,o=require("x.hub.taskman.js"),s=localStorage.getItem("info");o.taskManager.version=global.TASKMANAGER_VERSION,o.taskManager._mode=s?n(s):n();var i=require("body-parser");a._app.use("/xhub/activate/do",i.text({limit:"100kb"})),a._app.post("/xhub/activate/req",function(e,r){global.TMP_TOKEN=t(1,5e3),setTimeout(function(){global.TMP_TOKEN=null;},3e4),r.json({status:"success",data:global.TMP_TOKEN});}),a._app.post("/xhub/activate/do",function(e,t){if(global.TMP_TOKEN){if(e.body)try{var a=r(e.body),s=""+global.TMP_TOKEN,i=a.substr(a.length-s.length);if(a.length<s.length||i!=s)return void t.json({status:"fail",message:"invalid token",code:0});localStorage.setItem("info",e.body),o.taskManager._mode=n(e.body),t.json({status:"success"});}catch(e){t.json({status:"fail",message:"invalid request body",code:0});}else t.json({status:"fail",message:"no request body",code:0});}else t.json({status:"fail",message:"token expired",code:0});});}function _setupDebugSite(e){var r=e,n=require("x.hub.fileman.js"),t=n.fileManager,a=require("express"),o=require("path"),s=require("ws").Server,i=o.join(__dirname,"site");r._app.use("/debug",a["static"](i+"/debug")),r._app.use("/js",a["static"](i+"/js")),this._wss=new s({server:r._httpserver,path:"/debug/tracker/ws"}),this._wss.on("error",function(e){v5Logger.log("error","web socket server error:"+e.stack);}.bind(this)),this._wss.on("connection",function(e){e.__watchDog=setTimeout(function(){e.close();},6e4),e.on("error",function(r){v5Logger.log("error","web socket error:"+r.stack),e.close();}.bind(this)),e.on("close",function(){if(e.__tags){var r=require("x.logger.js");e.__tags.forEach(function(n){r.removeLogTracker(n,e.__tracker);});}e.__tail&&e.__tail.unwatch();}),e.on("message",function(r,n){try{var a=JSON.parse(r);if("main"==a.system){var s=new(0,require("tail").Tail)(o.resolve(t.getUserLogPath(),"v5plus_daemon"));return e.__tail=s,s.on("line",function(r){e.send(r+"\r\n");}),void s.on("error",function(e){v5Logger.log("error",e);});}var i=[];switch(a.system){case"homematic":i=["x.hub.m.hm","xnm.aio.hm"];break;case"knx":i=["x.hub.m.knx","xnm.aio.knx"];break;case"zwave":i=["x.hub.m.zway"];break;case"enocean":i=["x.hub.m.enocean"];break;case"zigbee":i=["x.hub.m.zigbee"];break;case"aio":i=["x.hub.m.gateway"];break;case"taskmanager":i=["x.hub.taskman"];break;case"script":i=["x.hub.scriptman"];break;case"rf":i=["x.hub.v5.USBSerial","x.hub.v6.STM"];}if(i.length>0){e.__watchDog&&(clearTimeout(e.__watchDog),e.__watchDog=null),e.__tags=i,e.__tracker=function(r){e.send(r+"\r\n");};var u=require("x.logger.js");i.forEach(function(r){u.setLogTracker(r,e.__tracker);});}}catch(r){e.send(JSON.stringify({error:r.message})),e.close();}}.bind(this));}.bind(this)),r._app.get("/debug/tracker/log",function(e,r){var t;switch(e.query.system){case"taskmanager":t="v5p_taskmanager.log";break;case"homematic":t="v5p_homematic.log";break;case"knx":t="v5p_knx.log";break;case"zigbee":t="v5p_zigbee.log";break;case"zwave":t="v5p_zwave.log";break;case"enocean":t="v5p_enocean.log";break;case"aio":t="v5p_aiogateway.log";break;case"rf":t="v5p_rf_st.log";break;case"main":t="v5plus_daemon";break;default:r.status(404).send("system unknow");}var a=n.fileManager,s=o.join(a.getUserLogPath(),t);r.sendFile(s);}),i=o.join(__dirname,"site/debug/enocean"),r._app.use("/debug/enocean/tracker",a["static"](i));var u=o.join(__dirname,"resources");r._app.use("/resources",a["static"](u)),this._wss=new s({server:r._httpserver,path:"/debug/enocean/ws"}),this._wss.on("error",function(e){v5Logger.log("error","web socket server error:"+e.stack);}.bind(this)),this._wss.on("connection",function(e){v5Logger.log("info","web socket connected");var r={onFrame:function onFrame(r,n){e.send("+++++++++++++++++++++++++++++++++\r\n"),e.send("EnOcean Frame:"),e.send(n+"\r\n"),e.send(JSON.stringify(r.toJSON())+"\r\n"),e.send("+++++++++++++++++++++++++++++++++\r\n");},onTelegram:function onTelegram(r){e.send("########################################################\r\n"),e.send("EnOcean Telegram:\r\n"),e.send(JSON.stringify(r.toJSON())+"\r\n"),e.send("########################################################\r\n");},onResolveEvents:function onResolveEvents(r,n){e.send("===============================\r\n"),e.send("Resolved Events from:"+r+"\r\n"),n.forEach(function(r){e.send(JSON.stringify(r)+"\r\n");}),e.send("===============================\r\n");}},n=require("x.hub.m.enocean.js");n.__addTelegramTracker(r),e.on("error",function(r){v5Logger.log("error","web socket error:"+r.stack),e.close();}.bind(this)),e.on("close",function(){n.__removeTelegramTracker(r);}),e.on("message",function(e,r){}.bind(this));}.bind(this)),this._wss2=new s({server:r._httpserver,path:"/siegenia/enocean/windowconfig"}),this._wss2.on("error",function(e){v5Logger.log("error","web socket server error:"+e.stack);}.bind(this)),this._wss2.on("connection",function(e){var r=require("x.hub.m.enocean.js");e.__watchDog=setTimeout(function(){e.close();},3e5),e.on("error",function(n){v5Logger.log("error","web socket error:"+n.stack),r._siegeniaHandler.stopCalibateWindow(),e.close();}.bind(this)),e.on("close",function(){clearTimeout(e.__watchDog),r._siegeniaHandler.stopCalibateWindow();}),e.on("message",function(n,t){try{var a=JSON.parse(n);"start"==a.command&&(r._siegeniaHandler.startCalibateWindow(a.windowID,function(r,n,t){r?e.send(JSON.stringify({error:r.message})):e.send(JSON.stringify({windowID:n,message:t}));}),r._siegeniaHandler.configWindow(a.params,a.windowID,function(r){r&&e.send(JSON.stringify({error:r.message,code:r.code}));}));}catch(r){e.send(JSON.stringify({error:r.message}));}}.bind(this));}.bind(this)),this._wss3=new s({server:r._httpserver,path:"/zwave2/inclusion"}),this._wss3.on("error",function(e){v5Logger.log("error","web socket server zwaveinclusion error:"+e.stack);}.bind(this)),this._wss3.on("connection",function(e){var r=require("x.hub.m.zway.js");e.__watchDog=setTimeout(function(){e.close();},3e5),e.on("error",function(r){v5Logger.log("error","web socket error:"+r.stack),e.close();}.bind(this)),e.on("close",function(){clearTimeout(e.__watchDog);}),e.on("message",function(n,t){try{var a=JSON.parse(n);if("start"==a.command)r.learnDevice(null,function(r,n,t){e.send(JSON.stringify({progress:r,subprogress:n,message:t}));},function(r){r.error?e.send(JSON.stringify({finish:!0,error:r.error.message,code:r.error.code,device:r.data})):e.send(JSON.stringify({finish:!0,device:r.data})),e.close();});else if("updateInterview"==a.command){if(!a.address)return void e.send(JSON.stringify({finish:!0,error:"no address parameter",code:"08999"}));r.updateInterview(a.address,a.instanceID,a.commandClassID,function(r,n,t){e.send(JSON.stringify({progress:r,subprogress:n,message:t}));},function(r){r.error?e.send(JSON.stringify({finish:!0,error:r.error.message,code:r.error.code,device:r.data})):e.send(JSON.stringify({finish:!0,device:r.data})),e.close();});}}catch(r){e.send(JSON.stringify({error:r.message}));}}.bind(this));}.bind(this)),this._wss4=new s({server:r._httpserver,path:"/taskman/tracker"}),this._wss4.on("error",function(e){v5Logger.log("error","web socket server error:"+e.stack);}.bind(this)),this._wss4.on("connection",function(e){var r=require("url").parse(e.upgradeReq.url),n=require("querystring").parse(r.query);n.taskID||e.close(),e.__taskID=n.taskID,e.__watchDog=setTimeout(function(){e.close();},6e4),e.__tmListener=function(r){e.send(r+"\r\n");};var t=require("x.hub.taskman.js");t.startTaskTrace(e.__taskID,e.__tmListener,function(r){r&&r.error&&(e.send(JSON.stringify({error:r.error.message})),e.close());}),e.on("error",function(r){v5Logger.log("error","web socket error:"+r.stack),e.close();}.bind(this)),e.on("close",function(){e.__taskID&&e.__tmListener&&t.stopTaskTrace(e.__taskID,e.__tmListener);}),e.on("message",function(r,n){try{JSON.parse(r).alive&&(e.__watchDog&&(clearTimeout(e.__watchDog),e.__watchDog=null),e.__watchDog=setTimeout(function(){e.close();},6e4));}catch(r){e.send(JSON.stringify({error:r.message})),e.close();}}.bind(this));}.bind(this));}xnm.aio=xnm.aio||{},xnm.aio.xhub=xnm.aio.xhub||{},global.HARDWARE_VERSION="EA",global.FIRMWARE_VERSION="development",global.TASKMANAGER_VERSION="2.5.3",global.FIRMWARE_BUILD="0000",global.PLATFORM=null,global.NAME=null,global.VID=null,global.CLOUD_URL="https://webservice.mediola.com",global.CONTROL_SERVER=null,global.LOAD_MODULES=null,global.SYSTEM_ROOT=null,global.DATA_FOLDER=null,global.APP_FOLDER=null,global.LOG_ROOT=null,global.LOG_LEVEL=null,global.WEB_SERVER_PORT=80,global.STM=null,global.HM_CHIP=null,global.HM_CHIP_USERNAME=null,global.HM_CHIP_PASSWORD=null,global.HM_LOCAL_PORT=9099,global.ENOCEAN_PORT=null,global.ZWAVE2_URL=null,global.ZWAVE2_PORT=null,global.ZIGBEE_URL=null,global.MBUS_PORT=null,global.SAFE_MODE=!1,_loadCompilerConfig(),_loadProgrammEnv(),_loadConfigFile(),_loadRuntimeConfig();var fm=require("x.hub.fileman.js");function catchGlobalErrors(){process.on("uncaughtException",function(e){v5Logger.log("error",e.stack);}),process.on("SIGINT",function(){v5Logger.log("error","Got SIGINT."),-1!=global.LOAD_MODULES.indexOf("knx")?require("x.hub.m.knx.js").clean(function(){v5Logger.log("error","SIGINT callback."),process.exit(1);}):process.exit(1);}),process.on("SIGTERM",function(){v5Logger.log("error","Got SIGTERM."),-1!=global.LOAD_MODULES.indexOf("knx")?require("x.hub.m.knx.js").clean(function(){v5Logger.log("error","SIGINT callback."),process.exit(1);}):process.exit(1);});}fm.init("A1"==global.HARDWARE_VERSION?"NEO SERVER":"v5plus",function(){var e=fm.fileManager,r=require("node-localstorage").LocalStorage;if("EA"==global.HARDWARE_VERSION)fs.existsSync("./data")||fs.mkdirSync("./data"),localStorage=new r("./data/localstorage"),fs.existsSync("./localstorage")&&fs.rmdirRecursiveSync("./localstorage");else if("CA"==global.HARDWARE_VERSION){var n=e.getUserRootDataPath();fs.existsSync(n)||fs.mkdirSync(n),localStorage=new r(n+"/localstorage"),fs.existsSync("./localstorage")&&fs.rmdirRecursiveSync("./localstorage");}else if("A1"==global.HARDWARE_VERSION&&!hasLocalStorage)try{localStorage=new r(e.getUserRootDataPath()+path.sep+"localstorage");}catch(e){}require("x.hub.logman.js").init(e,function(){var r=_setupServer();if(_setupDebugSite(r),"EA"==global.HARDWARE_VERSION&&"A20"==global.PLATFORM){v5Logger.log("info",new Date().toString()+" ===========> LED Start Sequence");var n=new miot.STMUpdater();n.hostType=r.hostType,n.resetST(),setTimeout(function(){r.startSTM(function(e){r.doSTMCommand("XC_FNC=SendSC&type=RGB&data=040305");});},500),0==v5.Native.checkResetPin()&&(v5Logger.log("info",new Date().toString()+" ===========> reset button pressed, start safe mode"),global.SAFE_MODE=!0);}else if("CA"==global.HARDWARE_VERSION){v5Logger.log("info",new Date().toString()+" ===========> LED Start Sequence");var t=require("x.hub.v6.js");t.init(r),t._led.startSystemInit();}else global.STM&&setTimeout(function(){r.startSTM(function(e){});},500);require("x.hub.resource.js").init(r._app,e),require("x.hub.rule.js").init(r._app,e),require("x.hub.group.js").init(r._app,e),require("x.hub.action.js").init(r._app,e),require("x.hub.password.js").init(e),require("x.hub.deviceman.js").init(r._app,e,function(){require("x.hub.macroman.js").init(r._app,e),require("x.hub.scriptman.js").init(r._app,r._httpserver,function(e){e&&v5Logger.log("error",e);}),require("x.hub.commandman.js").init(r._app);var n=require("x.hub.taskman.js");global.SAFE_MODE&&(v5Logger.log("info","!!! run task manager in safe mode"),n.lock()),n.init(),require("x.hub.sysvarman.js").init(r._app,e),"A1"==global.HARDWARE_VERSION&&_setupAutomationManagerMode(r),r.startWebserver(global.WEB_SERVER_PORT,function(){"EA"==global.HARDWARE_VERSION&&"A20"==global.PLATFORM?r.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0400"):"CA"==global.HARDWARE_VERSION&&require("x.hub.v6.js")._led.stopSystemInit();}),r.enableCloudConnect(new v5.CloudConnect()),"A20"==global.PLATFORM&&"EA"==global.HARDWARE_VERSION&&v5.Native.watchResetPin(r,function(e){XC.debugf("RESET: "+e),"reboot"==e?r.restart(0):"network"==e?v5.Native.resetNetwork(function(){r.restart(0);}):"passwords"==e?v5.reset(r,e,function(){r.restart(0);}):"factory"==e&&v5.reset(r,e,function(){v5.Native.resetHM(function(){v5.Native.resetZway(function(){v5.Native.resetZigbee(function(){v5.Native.resetNetwork(function(){r.restart(0);});});});});});});}),"A20"==global.PLATFORM&&"EA"==global.HARDWARE_VERSION&&require("x.hub.datastore.js").init(e),require("x.hub.peripheralman.js").init(r._app,r._httpserver),require("x.hub.hubsyncman.js").init(r._app,e);var a=require("x.hub.moduleman.js");global.LOAD_MODULES.forEach(function(e){a.Modules.push(e);}),a.init(),a.initModules();var o=require("xnm.aio.gateway.js");o._autoSearchInterval&&clearInterval(o._autoSearchInterval);});});