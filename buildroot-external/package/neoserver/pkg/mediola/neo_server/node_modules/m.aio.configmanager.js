var m=m||{};m.aio=m.aio||{};m.aio.configmanager=m.aio.configmanager||{};m.aio.configmanager.Path=function(){this._routes=[]};m.aio.configmanager.Path.prototype.isEmpty=function(){return 0===this._routes.length};m.aio.configmanager.Path.prototype.pop=function(){return 0===this._routes.length?null:this._routes.splice(0,1)[0]};
m.aio.configmanager.Path.resolve=function(a){if(!a)return null;var b=new m.aio.configmanager.Path;a=a.split("/");for(var c=0;c<a.length;c++)if(0===a[c].length){if(0!==c&&c!==a.length-1)return null}else b._routes.push(a[c]);return b};m.aio.configmanager.Path.trace=function(a,b){for(var c=null,d=a,e;null!==(e=b.pop());)if(d=d.getChild(e))c=d;else return null;return c};m.aio.configmanager.Node=function(a){this.index=-1;this.classid="";this.parent=a};
m.aio.configmanager.Node.prototype.getChild=function(a){return a&&"string"===typeof a?this[a]:null};m.aio.configmanager.ListNode=function(a){m.aio.configmanager.Node.call(this,a);this.children=[]};m.aio.configmanager.ListNode.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.ListNode.prototype.constructor=m.aio.configmanager.ListNode;m.aio.configmanager.ListNode.prototype.size=function(){return this.children.length};m.aio.configmanager.ListNode.prototype.get=function(a){return this.children[a]};
m.aio.configmanager.License=function(a){m.aio.configmanager.Node.call(this,a);this.type=this.licenseTxt=this.id=this.parent=null;this.duration=0;this.valid=!1;this.version=0;this.features=null};m.aio.configmanager.License.TYPE={NORMAL:"normal",TEST:"test"};m.aio.configmanager.License.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.License.prototype.constructor=m.aio.configmanager.License;
m.aio.configmanager.License.prototype.getDaysLeft=function(){if(this.type!=m.aio.configmanager.License.TYPE.TEST||!this.licenseTxt||!m.aio.configmanager.CM.filemanager)return 0;if(1==this.version&&0==this.id)return-1;var a=m.aio.configmanager.CM.filemanager.Preference.read(this.licenseTxt);if(!a)return-1;a=new Date(parseInt(a));a=Math.floor(((new Date).getTime()-a.getTime())/1E3/60/60/24);return 0>=7*this.duration-a?0:7*this.duration-a};
m.aio.configmanager.License.prototype.saveStartDate=function(){if(this.licenseTxt&&this.valid&&m.aio.configmanager.CM){var a=m.aio.configmanager.CM.filemanager.Preference;if(!a.read(this.licenseTxt)){var b=(new Date).getTime();a.save(this.licenseTxt,b.toString())}}};m.aio.configmanager.License.prototype.getStartDate=function(){if(this.licenseTxt&&this.valid&&m.aio.configmanager.CM)return m.aio.configmanager.CM.filemanager.Preference.read(this.licenseTxt)};
m.aio.configmanager.License.prototype.saveStartDateWithDate=function(a){m.aio.configmanager.CM.filemanager.Preference.save(this.licenseTxt,a)};m.aio.configmanager.License.prototype.isTestLicense=function(){return this.type==m.aio.configmanager.License.TYPE.TEST};m.aio.configmanager.License.prototype.isExpired=function(){return this.type==m.aio.configmanager.License.TYPE.TEST&&0==this.getDaysLeft()?!0:!1};m.aio.configmanager.License.prototype.getFeatureModules=function(){return require("m.aio.infomanager.js").getFeatureModules(this)};
m.aio.configmanager.License.prototype.getFeatureModulesSUS=function(){return require("m.aio.infomanager.js").getFeatureModulesSUS(this)};m.aio.configmanager.License.prototype.getSUSFlatrate=function(){return require("m.aio.infomanager.js").getSUSFlatrate(this)};m.aio.configmanager.License.prototype.isUltimateTestLicense=function(){return this.isTestLicense()?1==this.version&&0==this.id:!1};
m.aio.configmanager.License.prototype.isPartnerUltimateLicense=function(){return this.isTestLicense()||2!=this.version||!this.features?!1:this.features.readUInt8(0)>>7&1};
m.aio.configmanager.LicenseManager={BLOCKED:[],UUENCODE_MAP:"MXBPWG7QJD6K3R4S2U98ETFH51AZNCYV",resolve:function(a){if(!a)return null;a=a.toUpperCase();var b=new m.aio.configmanager.License;b.licenseTxt=a;var c=a.replace(/-/g,"");if(20!=c.length)return b.valid=!1,b;c=this._uudecode(c);if(!c)return b.valid=!1,b;c=this._decrypt(c);if(!c)return b.valid=!1,b;if(c=this._resolve(c))return this._isBlocked(c)&&(c.valid=!1),c.licenseTxt=a,c;b.valid=!1;return b},_isBlocked:function(a){if(require("m.aio.infomanager.js").isLicenseBlocked(a))return!0;
if(0!=a.version)return!1;var b=m.aio.configmanager.CM.filemanager.getPref().read("blockedid");b||(b=this.BLOCKED);b.length<this.BLOCKED.length&&(b=this.BLOCKED);for(var c=0;c<b.length;c++)if(a.id==b[c])return!0;return!1},_uudecode:function(a){var b=require("big-integer")(0),c;for(c=0;20>c;c++){var d=this.UUENCODE_MAP.indexOf(a.charAt(c));if(-1==d)return null;b=b.shiftLeft(5).add(d)}return b},_decrypt:function(a){var b=require("big-integer");if(15!=a.and(15).toJSNumber())return null;a=a.shiftRight(4);
var c=b("43138825561077299640793988347"),b=b("23300244857271456227675018177"),b=a.modPow(b,c);return 7!=b.shiftRight(92).toJSNumber()?null:b},_resolve:function(a){var b=new m.aio.configmanager.License;a=a.toString(16);0!=a.length%2&&(a="0"+a);a=new Buffer(a,"hex");b.version=a.readUInt8(0)&15;var c=a.readUInt8(1);b.type=c>>7?m.aio.configmanager.License.TYPE.TEST:m.aio.configmanager.License.TYPE.NORMAL;switch(b.type){case m.aio.configmanager.License.TYPE.TEST:b.duration=c>>4&7;b.id=(a.readUInt8(1)<<
16)+(a.readUInt8(2)<<8)+a.readUInt8(3)&1048575;break;case m.aio.configmanager.License.TYPE.NORMAL:b.id=(a.readUInt8(1)<<16)+(a.readUInt8(2)<<8)+a.readUInt8(3)&8388607}b.features=a.slice(4);"test"==b.type&&1==b.id&&(a=b.features.readUInt8(7),a|=192,c=b.features.readUInt8(6),c|=63,b.features.writeUInt8(a,7),b.features.writeUInt8(c,6));b.valid=!0;return b},permit:function(a,b){if(!b)return!1;if(b instanceof m.aio.configmanager.Config||b instanceof m.aio.configmanager.Tenants||b instanceof m.aio.configmanager.Tenant||
b instanceof m.aio.configmanager.License&&b.parent)return!0;var c=this._getTenant(b);return c&&c.license&&c.license.valid?!(c.license.isTestLicense()&&c.license.isExpired()):!1},permitFeature:function(a,b,c,d,e){return"delete"==a?!0:require("m.aio.infomanager.js").permitFeature(a,b,c,d,e)},_getTenant:function(a){for(;a;){if(a instanceof m.aio.configmanager.Tenant)return a;a=a.parent}return null}};
m.aio.configmanager.LicenseHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.LicenseJSONHandler.toJSON(a));break;case "update":if(!a){d&&d(Error("license is null"));break}if(!c){d&&d(Error("data is null"));break}if(!a.parent){d&&d(Error("license is isolated"));break}b=m.aio.configmanager.TenantJSONHandler.toJSON(a.parent);b.license=c;m.aio.configmanager.TenantHandler.execute(a.parent,"update",b,function(a,b){a?d&&d(a):d&&d(null,b.license)});break;default:d(Error("no such method"))}}};
m.aio.configmanager.LicenseJSONHandler={fromJSON:function(a){return a&&a.classid&&"license"===a.classid&&a.license?m.aio.configmanager.LicenseManager.resolve(a.license):null},toJSON:function(a){a={classid:"license",license:a.licenseTxt,partner_ultimate:a.isPartnerUltimateLicense(),type:a.type,duration:a.duration,valid:a.valid,daysLeft:a.getDaysLeft(),features:a.getFeatureModules(),features_sus:a.getFeatureModulesSUS(),features_sus_flatrate:a.getSUSFlatrate()};-1==a.daysLeft&&delete a.daysLeft;return a}};
m.aio.configmanager.Config=function(a){m.aio.configmanager.Node.call(this,null);this.folder=a;this.tenants=new m.aio.configmanager.Tenants(this)};m.aio.configmanager.Config.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.Config.prototype.constructor=m.aio.configmanager.Config;m.aio.configmanager.Config.SETTING="settings";m.aio.configmanager.Config.prototype.getFolderPath=function(){return this.folder};
m.aio.configmanager.ConfigHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.ConfigJSONHandler.toJSON(a));break;default:d(Error("no such method"))}}};m.aio.configmanager.ConfigJSONHandler={toJSON:function(a){return a?{classid:"config",tenants:a.tenants?m.aio.configmanager.TenantsJSONHandler.toJSON(a.tenants):null}:null}};
m.aio.configmanager.ConfigPersistHandler={save:function(a,b){var c=a.getFolderPath();if(c){var d=require("async"),e=require("fs");d.series([function(a){e.exists(c,function(b){b?e.stat(c,function(b,d){b?a(b):d.isDirectory()?a():a(Error(c+" is not a folder"))}):require("fs-extra").mkdirs(c,function(b){a(b)})})},function(a){var b=require("path");e.writeFile(c+b.sep+m.aio.configmanager.Config.SETTING,JSON.stringify({}),function(b){a(b)})}],function(a){b(a)})}else b(Error("folder of the config is invalid"))},
load:function(a,b){var c=new m.aio.configmanager.Config,d=require("path");this._loadSettings(a+d.sep+m.aio.configmanager.Config.SETTING,function(d){d?b(d):(c.folder=a,m.aio.configmanager.TenantsPersistHandler.load(c,a,function(a,d){a?b(a):(d.parent=c,c.tenants=d,b(null,c))}))})},_loadSettings:function(a,b){var c=require("fs");c.exists(a,function(d){d?c.readFile(a,function(a,c){if(a)b(a);else{var d={};if(0<c.length)try{d=JSON.parse(c.toString())}catch(g){b(null,{});return}b(null,d)}}):b(null,{})})}};
m.aio.configmanager.Tenants=function(a){m.aio.configmanager.ListNode.call(this,a);this.children=[]};m.aio.configmanager.Tenants.prototype=Object.create(m.aio.configmanager.ListNode.prototype);m.aio.configmanager.Tenants.prototype.constructor=m.aio.configmanager.Tenants;m.aio.configmanager.Tenants.prototype.getFolderPath=function(){return this.parent?this.parent.getFolderPath():null};m.aio.configmanager.Tenants.prototype.getChildren=function(){return this.children};
m.aio.configmanager.Tenants.prototype.getChild=function(a){for(var b=0;b<this.children.length;b++){var c=this.children[b];if(c.index==a)return c}return null};m.aio.configmanager.Tenants.prototype.removeChild=function(a){for(var b=-1,c=0;c<this.children.length;c++)if(this.children[c].index==a.index){b=c;break}0<=b&&this.children.splice(b,1);a.parent=null};
m.aio.configmanager.Tenants.prototype.sort=function(){var a=this.children.length-1,b=!1;do for(var b=!1,c=0;c<a;++c)this.children[c].index>this.children[c+1].index&&(b=this.children[c],this.children[c]=this.children[c+1],this.children[c+1]=b,b=!0);while(b)};
m.aio.configmanager.TenantsHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.TenantsJSONHandler.toJSON(a));break;case "create":(b=m.aio.configmanager.TenantJSONHandler.fromJSON(c))?this._add(a,b,function(a,b){a?d(a):(b&&b.license&&!b.license.isTestLicense()&&require("m.aio.infomanager.js").retrieveInfo(),d(null,m.aio.configmanager.TenantJSONHandler.toJSON(b)))}):d(Error("json format invalid"));break;default:d(Error("no such method"))}},_add:function(a,b,c){var d=
this;require("async").waterfall([function(c){d._preAddNode(a,b,c)},function(b,c){d._addNode(a,b,c)},function(b,c){d._postAddNode(a,b,c)}],function(a,b){c(a,b)})},_preAddNode:function(a,b,c){var d=1;if(b.name)if(b.license)if(b.license.valid)if(b.license.isTestLicense()&&b.license.isExpired())c(Error("test license is expired"));else{for(var e=0;e<a.children.length;e++){var f=a.children[e];if(f.index==b.index){c(Error("tenant with same id exists","configmanager.js"));return}if(f.name==b.name){c(Error("remote with same name exists",
"configmanager.js"));return}if(f.license&&b.license&&f.license.licenseTxt&&b.license.licenseTxt&&f.license.type==b.license.type&&f.license.id==b.license.id&&f.license.version==b.license.version){c(Error("tenant with same license exists","configmanager.js"));return}f.index==d&&d++}if(!b.index||0>=b.index)b.index=d;m.aio.configmanager.TenantPersistHandler.save(a,b,function(a){b.license&&b.license.valid&&b.license.isTestLicense()&&b.license.saveStartDate();c(a,b)})}else c(Error("license is invalid"));
else c(Error("license is null"));else c(Error("name is null"))},_addNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postAddNode:function(a,b,c){a.sort();a=require("m.aio.devicemanager.js");var d=require("m.aio.macromanager.js");a.addTenant(b,function(a){a?c&&c(a):d.addTenant(b,function(a){c&&c(a,b)})})}};
m.aio.configmanager.TenantsJSONHandler={toJSON:function(a){if(!a)return null;for(var b=[],c=0;c<a.children.length;c++)b.push(m.aio.configmanager.TenantJSONHandler.toJSON(a.children[c]));return b}};
m.aio.configmanager.TenantsPersistHandler={load:function(a,b,c){var d=new m.aio.configmanager.Tenants;d.parent=a;var e=this,f=require("fs");f.readdir(b,function(a,g){a?c(a):require("async").eachSeries(g,function(a,c){var h=require("path");f.stat(b+h.sep+a,function(f,g){!f&&g.isDirectory()?m.aio.configmanager.TenantPersistHandler.load(d,b+h.sep+a,function(a,b){b?e._load(d,b,function(a,b){c(a,b)}):c()}):c()})},function(a){a?c(a):(d.sort(),c(null,d))})})},_load:function(a,b,c){var d=this;require("async").waterfall([function(c){d._preLoadNode(a,
b,c)},function(b,c){d._loadNode(a,b,c)},function(b,c){d._postLoadNode(a,b,c)}],function(a,b){c(a,b)})},_preLoadNode:function(a,b,c){var d=!1;if(!b.index||0>b.index)b.index=1,d=!0;b.name||(b.name="new_config",d=!0);var e=!1;do for(var e=!1,f=0;f<a.children.length;f++){var h=a.children[f];h.index==b.index&&(b.index++,e=d=!0);h.name==b.name&&(d=/[(]{1}[\d]+[)]{1}$/,d.test(b.name)?(e=b.name.match(d)[0],e=parseInt(e),e++,b.name=b.name.replace(d,"("+e+")")):b.name+="(0)",e=d=!0);h.license&&h.license.licenseTxt&&
b.license&&b.license.licenseTxt&&h.license.type==b.license.type&&h.license.id==b.license.id&&h.license.version==b.license.version&&(b.license=null,e=d=!0)}while(e);d&&(b._changed=!0);c(null,b)},_loadNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postLoadNode:function(a,b,c){b._changed?m.aio.configmanager.TenantPersistHandler.save(a,b,function(a){delete b._changed;c(a,b)}):c(null,b)}};
m.aio.configmanager.Tenant=function(a){m.aio.configmanager.Node.call(this,a);this.parent=a;this.index=-1;this.license=this.name=this.folder=null;this.default=!1;this.remotes=new m.aio.configmanager.Remotes(this)};m.aio.configmanager.Tenant.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.Tenant.prototype.constructor=m.aio.configmanager.Tenant;m.aio.configmanager.Tenant.SETTING="settings";m.aio.configmanager.Tenant.REMOTES="remotes";
m.aio.configmanager.Tenant.prototype.getFolder=function(){this.folder||(this.folder=Math.round((new Date).getTime()/1E3).toString());return this.folder};m.aio.configmanager.Tenant.prototype.getFolderPath=function(){var a=this.parent?this.parent.getFolderPath():null,b=this.getFolder(),c=require("path");return a&&b?a+c.sep+b:null};m.aio.configmanager.Tenant.prototype.getDeviceFile=function(){var a=this.getFolderPath();if(!a)return a;var b=require("path");return a+b.sep+"device_db"};
m.aio.configmanager.Tenant.prototype.getMacrosFile=function(){var a=this.getFolderPath();if(!a)return a;var b=require("path");return a+b.sep+"macros_db"};m.aio.configmanager.Tenant.prototype.getDeviceinfoFile=function(){var a=this.getFolderPath();if(!a)return a;var b=require("path");return a+b.sep+"deviceinfo.xml"};m.aio.configmanager.Tenant.prototype.getRemotes=function(){return this.remotes};
m.aio.configmanager.Tenant.prototype.isAccessible=function(){return this.license&&this.license.valid?!(this.license.isTestLicense()&&this.license.isExpired()):!1};m.aio.configmanager.Tenant.prototype.isDefault=function(){return this.default};
m.aio.configmanager.Tenant.prototype.reloadRemotes=function(a){var b=require("path"),c=this.getFolderPath(),d=this;m.aio.configmanager.RemotesPersistHandler.load(this,c+b.sep+m.aio.configmanager.Tenant.REMOTES,function(b,c){b?a&&a(b):(d.remotes.parent=null,c.parent=d,d.remotes=c,a&&a(null))})};
m.aio.configmanager.TenantHandler={execute:function(a,b,c,d){var e=a.parent;switch(b){case "read":d(null,m.aio.configmanager.TenantJSONHandler.toJSON(a));break;case "delete":if(!e){d(Error("tenant is isolated"));break}m.aio.configmanager.TenantPersistHandler.remove(e,a,function(b){if(b)d(b);else{b=require("m.aio.devicemanager.js");var c=require("m.aio.macromanager.js");b.removeTenant(a,function(){c.removeTenant(a,function(){e.removeChild(a);d(null,{success:!0})})})}});break;case "update":if(!e){d(Error("tenant is isolated"));
break}b=m.aio.configmanager.TenantJSONHandler.fromJSON(c);if(!b){d(Error("data format invalid"));break}var f,h=null,g=!1;if(b.name&&a.name!=b.name){for(c=0;c<e.children.length;c++)if(f=e.children[c],f.name==b.name){d(Error("tenant name is already existed"));return}g=!0;h=a.name;a.name=b.name}var l=!1,n=null;if(b.default){l=!0;for(c=0;c<e.children.length;c++)if(f=e.children[c],f.default){f.default=!1;n=f;break}a.default=b.default}var p=null,k=!1;if(b.license&&b.license.licenseTxt&&(!a.license||a.license.licenseTxt!=
b.license.licenseTxt)){if(!b.license.valid){d(Error("license invalid"));break}for(c=0;c<e.children.length;c++)if(f=e.children[c],f.index!=b.index&&f.license&&f.license.type==b.license.type&&f.license.id==b.license.id&&f.license.version==b.license.version){d(Error("tenant license is already existed"));return}k=!0;p=a.license;a.license=b.license}g||k||l?m.aio.configmanager.TenantPersistHandler.save(e,a,function(b){b?(g&&(a.id=h),k&&(a.license=p),l&&(a.default=!1,n&&(n.default=!0)),d(b)):(k&&a.license&&
!a.license.isTestLicense()&&require("m.aio.infomanager.js").retrieveInfo(),k&&a.license&&a.license.isTestLicense()&&(p&&p.id==a.license.id?(b=p.getStartDate(),a.license.saveStartDateWithDate(b)):a.license.saveStartDate()),l&&n?m.aio.configmanager.TenantPersistHandler.save(e,n,function(b){d(b,m.aio.configmanager.TenantJSONHandler.toJSON(a))}):d(null,m.aio.configmanager.TenantJSONHandler.toJSON(a)))}):d(null,m.aio.configmanager.TenantJSONHandler.toJSON(a));break;default:d(Error("no such method"))}}};
m.aio.configmanager.TenantJSONHandler={fromJSON:function(a){if(!a||!a.classid||"tenant"!==a.classid)return null;var b=new m.aio.configmanager.Tenant;b.index=a.index?a.index:-1;b.name=a.name;b.default=a.default?!0:!1;b.license=null;a.license&&(b.license=m.aio.configmanager.LicenseJSONHandler.fromJSON(a.license),b.license&&(b.license.parent=b));return b},toJSON:function(a){return{classid:"tenant",index:a.index,name:a.name,default:a.default,folder:a.getFolderPath(),license:a.license?m.aio.configmanager.LicenseJSONHandler.toJSON(a.license):
null,remotes:a.remotes?m.aio.configmanager.RemotesJSONHandler.toJSON(a.remotes):null}}};
m.aio.configmanager.TenantPersistHandler={save:function(a,b,c){a=a.getFolderPath();var d=b.getFolder();if(a)if(d){var e=require("path"),d=a+e.sep+d;a=require("async");var f=require("fs");a.series([function(a){f.exists(d,function(b){b?f.stat(d,function(b,c){b?a(b):c.isDirectory()?a():a(Error(d+" is not a folder"))}):require("fs-extra").mkdirs(d,function(b){a(b)})})},function(a){f.writeFile(d+e.sep+m.aio.configmanager.Tenant.SETTING,JSON.stringify({index:b.index,name:b.name,default:b.default?!0:!1,
license:b.license?b.license.licenseTxt:null}),function(b){a(b)})}],function(a){c(a)})}else c(Error("tenant folder is null"));else c(Error("parent folder path is null"))},load:function(a,b,c){var d=new m.aio.configmanager.Tenant;d.parent=a;var e=require("path");this._loadSettings(b+e.sep+m.aio.configmanager.Tenant.SETTING,function(a,h){if(a)c(a);else if(h){d.index=h.index?h.index:-1;var g=b.lastIndexOf(e.sep);d.folder=b.substr(g+1);d.name=h.name;d.license=h.license;d.default=h.default?!0:!1;d&&d.license&&
(d.license.parent=d,d.license.isTestLicense()&&!d.license.getStartDate()&&d.license.saveStartDate());m.aio.configmanager.RemotesPersistHandler.load(d,b+e.sep+m.aio.configmanager.Tenant.REMOTES,function(a,b){a?c(a):(b.parent=d,d.remotes=b,c(null,d))})}else c(null,null)})},_loadSettings:function(a,b){var c=require("fs");c.exists(a,function(d){d?c.readFile(a,function(a,c){if(a)b(a);else{var d={};if(0<c.length)try{d=JSON.parse(c.toString())}catch(g){b(null,d);return}d.license&&(d.license=m.aio.configmanager.LicenseManager.resolve(d.license));
b(null,d)}}):b(null,null)})},remove:function(a,b,c){a=a.getFolderPath();b=b.getFolder();if(a)if(b){var d=require("path");b=a+d.sep+b;require("fs-extra").remove(b,function(a){c(a)})}else c(Error("tenant folder is null"));else c(Error("parent folder path is null"))}};m.aio.configmanager.Remotes=function(a){m.aio.configmanager.ListNode.call(this,a);this.parent=a;this.children=[]};m.aio.configmanager.Remotes.prototype=Object.create(m.aio.configmanager.ListNode.prototype);
m.aio.configmanager.Remotes.prototype.constructor=m.aio.configmanager.Remotes;m.aio.configmanager.Remotes.FOLDER="remotes";m.aio.configmanager.Remotes.prototype.size=function(){return this.children?this.children.length:0};m.aio.configmanager.Remotes.prototype.getChildren=function(){return this.children};m.aio.configmanager.Remotes.prototype.getFolderPath=function(){if(!this.parent)return null;var a=this.parent.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+m.aio.configmanager.Remotes.FOLDER};
m.aio.configmanager.Remotes.prototype.getChild=function(a){for(var b=0;b<this.children.length;b++){var c=this.children[b];if(c.index==a)return c}return null};m.aio.configmanager.Remotes.prototype.removeChild=function(a){for(var b=-1,c=0;c<this.children.length;c++)if(this.children[c].index==a.index){b=c;break}0<=b&&this.children.splice(b,1);a.parent=null};
m.aio.configmanager.Remotes.prototype.sort=function(){var a=this.children.length-1,b=!1;do for(var b=!1,c=0;c<a;++c)this.children[c].index>this.children[c+1].index&&(b=this.children[c],this.children[c]=this.children[c+1],this.children[c+1]=b,b=!0);while(b)};
m.aio.configmanager.RemotesHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.RemotesJSONHandler.toJSON(a));break;case "create":(b=m.aio.configmanager.RemoteJSONHandler.fromJSON(c))?this._add(a,b,function(a,b){a?d(a):d(null,m.aio.configmanager.RemoteJSONHandler.toJSON(b))}):d(Error("json format invalid"));break;default:d(Error("no such method"))}},_getFreeIndex:function(a){a.sort();for(var b=1,c=0;c<a.children.length;c++)a.children[c].index==b&&b++;return b},_add:function(a,
b,c){var d=this;require("async").waterfall([function(c){d._preAddNode(a,b,c)},function(c,f){d._addNode(a,b,f)},function(c,f){d._postAddNode(a,b,f)}],function(a,b){c(a,b)})},_preAddNode:function(a,b,c){var d=1;if(b.id)if(b.id.match(m.aio.configmanager.Util.FILENAME_REGEX))c(Error("remote id has invalid character"));else{for(var e=0;e<a.children.length;e++){var f=a.children[e];if(f.index==b.index){c(Error("remote with same index exists","configmanager.js"));return}if(f.id==b.id){c(Error("remote with same id exists",
"configmanager.js"));return}f.index==d&&d++}if(!b.index||0>=b.index)b.index=d;m.aio.configmanager.RemotePersistHandler.save(a,b,function(a){c(a,b)})}else c(Error("id is null"))},_addNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postAddNode:function(a,b,c){a.sort();c(null,b)}};m.aio.configmanager.RemotesJSONHandler={toJSON:function(a){if(!a)return null;for(var b=[],c=0;c<a.children.length;c++){var d=m.aio.configmanager.RemoteJSONHandler.toJSON(a.children[c]);d&&b.push(d)}return b}};
m.aio.configmanager.RemotesPersistHandler={load:function(a,b,c){var d=new m.aio.configmanager.Remotes;d.parent=a;var e=this,f=require("fs");f.exists(b,function(a){a?f.readdir(b,function(a,h){if(a)c(a);else{var n=require("async"),p=require("path");n.eachSeries(h,function(a,c){f.stat(b+p.sep+a,function(f,h){!f&&h.isDirectory()?m.aio.configmanager.RemotePersistHandler.load(d,b+p.sep+a,function(a,b){b?e._load(d,b,function(a,b){c(a,b)}):c()}):c()})},function(a){a?c(a):(d.sort(),c(null,d))})}}):c(null,
d)})},_load:function(a,b,c){var d=this;require("async").waterfall([function(c){d._preLoadNode(a,b,c)},function(b,c){d._loadNode(a,b,c)},function(b,c){d._postLoadNode(a,b,c)}],function(a,b){c(a,b)})},_preLoadNode:function(a,b,c){var d=!1;if(!b.index||0>b.index)b.index=1,d=!0;var e=!1;do for(var e=!1,f=0;f<a.children.length;f++)a.children[f].index==b.index&&(b.index++,e=d=!0);while(e);d&&(b._changed=!0);c(null,b)},_loadNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postLoadNode:function(a,
b,c){b._changed?m.aio.configmanager.RemotePersistHandler.save(a,b,function(a){delete b._changed;c(a,b)}):c(null,b)}};m.aio.configmanager.Remote=function(a){m.aio.configmanager.Node.call(this,a);this.parent=a;this.index=-1;this.skin=this.id=null;this.info={};this.pages=new m.aio.configmanager.Pages(this)};m.aio.configmanager.Remote.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.Remote.prototype.constructor=m.aio.configmanager.Remote;
m.aio.configmanager.Remote.SETTING="settings";m.aio.configmanager.Remote.PAGES="controls";m.aio.configmanager.Remote.prototype.getFolder=function(){return this.id};m.aio.configmanager.Remote.prototype.getFolderPath=function(){if(!this.parent)return null;var a=this.parent.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+this.id};m.aio.configmanager.Remote.prototype.getSettingsFile=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+"settings"};
m.aio.configmanager.Remote.prototype.getDeviceFile=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+"device_db"};m.aio.configmanager.Remote.prototype.getMacrosFile=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+"macros_db"};m.aio.configmanager.Remote.prototype.getDeviceinfoFile=function(){var a=this.getFolderPath();if(!a)return a;var b=require("path");return a+b.sep+"deviceinfo.xml"};
m.aio.configmanager.Remote.prototype.getResourcesFolderPath=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+"resources"};m.aio.configmanager.Remote.prototype.getPagesFolderPath=function(){var a=this.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+m.aio.configmanager.Remote.PAGES};
m.aio.configmanager.Remote.prototype.processResourceList=function(a,b){this.pages?this.pages.children?require("async").each(this.pages.children,function(b,d){b.processResourceList(a,function(a){d(a)})},function(a){b&&b(a)}):b&&b(null):b&&b(null)};
m.aio.configmanager.RemoteHandler={execute:function(a,b,c,d){var e=a.parent;switch(b){case "read":d(null,m.aio.configmanager.RemoteJSONHandler.toJSON(a));break;case "delete":if(!e){d(Error("remote is isolated"));break}m.aio.configmanager.RemotePersistHandler.remove(e,a,function(b){b?d(b):(e.removeChild(a),d(null,{success:!0}))});break;case "update":if(!e){d(Error("remote is isolated"));break}var f=m.aio.configmanager.RemoteJSONHandler.fromJSON(c);if(!f){d(Error("data format invalid"));break}if(!f.id){d(Error("data format invalid:id is empty"));
break}if(f.id.match(m.aio.configmanager.Util.FILENAME_REGEX)){d(Error("remote id has invalid character"));break}console.log("start update remote");require("async").series([function(b){console.log("start check skin");if(f.skin)if(a.skin&&f.skin.id==a.skin.id&&f.skin.inRemote==a.skin.id)b();else{var c=a.skin;a.skin=f.skin;m.aio.configmanager.RemotePersistHandler.save(e,a,function(d){d&&(a.skin=c);b(d)})}else b()},function(b){if(f.info&&"object"==typeof f.info){var c=a.info;a.info=f.info;m.aio.configmanager.RemotePersistHandler.save(e,
a,function(d){d&&(a.info=c);b(d)})}else b()},function(b){console.log("start check remote name");if(a.id==f.id)b();else{for(var c=0;c<e.children.length;c++)if(e.children[c].id==f.id){b(Error("remote id is already existed"));return}e.getFolderPath()?m.aio.configmanager.RemotePersistHandler.move(e,a,f.id,function(c){console.log("finish move remote folder:"+c);c?b(c):(a.id=f.id,b())}):b(Error("remotes folder invalid"))}}],function(b){d(b,m.aio.configmanager.RemoteJSONHandler.toJSON(a))});break;case "create":this.saveRemote(a,
c,d);break;default:d(Error("no such method"))}},saveRemote:function(a,b,c){var d=a.parent;if(d){var e=m.aio.configmanager.RemoteJSONHandler.fromJSON(b);e?e.id?e.id.match(m.aio.configmanager.Util.FILENAME_REGEX)?c(Error("remote id has invalid character")):require("async").waterfall([function(b){if(e.info&&"object"==typeof e.info){var c=a.info;a.info=e.info;m.aio.configmanager.RemotePersistHandler.save(d,a,function(d){d&&(a.info=c);b(d)})}else b()},function(b){if(a.id!=e.id){for(var c=0;c<d.children.length;c++)if(d.children[c].id==
e.id){b(Error("remote id is already existed"));return}var c=require("path"),g=d.getFolderPath()+c.sep+e.id;m.aio.configmanager.RemotePersistHandler.copy(d,a,e.id,function(c){c?b(c):m.aio.configmanager.RemotePersistHandler.load(d,g,function(c,e){c?b(c):(e.index=a.index,a.index=m.aio.configmanager.RemotesHandler._getFreeIndex(a.parent),m.aio.configmanager.RemotePersistHandler._saveSettings(a,function(a){a?b(a):m.aio.configmanager.RemotesHandler._add(d,e,function(a,c){b(a,e)})}))})})}else b(null,a)}.bind(this),
function(a,b){var c=require("m.aio.devicemanager.js");c.saveRemote(a,function(d){c.clearRemoteDB(a,function(){b(d,a)})})}.bind(this),function(a,b){require("m.aio.macromanager.js").saveRemote(a,function(c){b(c,a)})}.bind(this),function(a,b){require("m.aio.skinmanager.js").saveRemote(a,e,function(c,e){c?b(c):(a.skin=e.skin,m.aio.configmanager.RemotePersistHandler.save(d,a,function(c){b(c,m.aio.configmanager.RemoteJSONHandler.toJSON(a))}))})}.bind(this)],function(a,b){c&&c(a,b)}):c(Error("data format invalid:id is empty")):
c(Error("data format invalid"))}else c(Error("remote is isolated"))}};
m.aio.configmanager.RemoteJSONHandler={fromJSON:function(a){if(!a||!a.classid||"remote"!==a.classid)return null;var b=new m.aio.configmanager.Remote;b.index=a.index?a.index:-1;b.id=a.id;b.skin=a.skin;a.info&&"object"==typeof a.info&&(b.info=a.info);return b},toJSON:function(a){return{classid:"remote",index:a.index,id:a.id,info:a.info,skin:a.skin,folder:a.getFolderPath(),pages:a.pages?m.aio.configmanager.PagesJSONHandler.toJSON(a.pages):null}}};
m.aio.configmanager.RemotePersistHandler={save:function(a,b,c){a=a.getFolderPath();var d=b.getFolder();if(a)if(d){var e=require("path"),d=a+e.sep+d;a=require("async");var f=require("fs");a.series([function(a){f.exists(d,function(b){b?f.stat(d,function(b,c){b?a(b):c.isDirectory()?a():a(Error(d+" is not a folder"))}):require("fs-extra").mkdirs(d,function(b){a(b)})})},function(a){f.writeFile(d+e.sep+m.aio.configmanager.Remote.SETTING,JSON.stringify({index:b.index,info:b.info,skin:b.skin}),function(b){a(b)})}],
function(a){c(a)})}else c(Error("remote folder is null"));else c(Error("parent folder path is null"))},_saveSettings:function(a,b){var c=a.parent;if(c){var c=c.getFolderPath(),d=a.getFolder();if(c)if(d){var e=require("path"),d=c+e.sep+d;require("fs").writeFile(d+e.sep+m.aio.configmanager.Remote.SETTING,JSON.stringify({index:a.index,info:a.info,skin:a.skin}),function(a){b(a)})}else b(Error("remote folder is null"));else b(Error("parent folder path is null"))}else b(Error("remote is isolated"))},load:function(a,
b,c){var d=new m.aio.configmanager.Remote;d.parent=a;var e=require("path");this._loadSettings(b+e.sep+m.aio.configmanager.Remote.SETTING,function(a,h){if(a)c(a);else if(h){d.index=h.index?h.index:-1;d.skin=h.skin?h.skin:null;d.info=h.info?h.info:{};var g=b.lastIndexOf(e.sep);d.id=b.substr(g+1);m.aio.configmanager.PagesPersistHandler.load(d,b+e.sep+m.aio.configmanager.Remote.PAGES,function(a,b){a?c(a):(b.parent=d,d.pages=b,c(null,d))})}else c(null,null)})},_loadSettings:function(a,b){var c=require("fs");
c.exists(a,function(d){d?c.readFile(a,function(a,c){if(a)b(a);else{var d={};if(0<c.length)try{d=JSON.parse(c.toString())}catch(g){b(null,d);return}b(null,d)}}):b(null,null)})},remove:function(a,b,c){var d=function(a){for(var b=require("fs"),c=require("path"),e=b.readdirSync(a),f=0;f<e.length;f++){var k=c.join(a,e[f]);console.log("try to delete:"+k);var q=b.statSync(k);"."!=k&&".."!=k&&(q.isDirectory()?(console.log(k+" is folder"),d(k)):(b.unlinkSync(k),console.log(k+" deleted ("+f+"/"+e.length+")")))}console.log("try to delete folder:"+
a);b.rmdirSync(a);console.log("folder:"+a+" deleted")};a=a.getFolderPath();b=b.getFolder();if(a)if(b){var e=require("path");b=a+e.sep+b;try{d(b),c()}catch(f){console.error(f),c(f)}}else c(Error("remote folder is null"));else c(Error("parent folder path is null"))},move:function(a,b,c,d){a=a.getFolderPath();b=b.getFolder();if(a)if(b){var e=require("path");b=a+e.sep+b;c=a+e.sep+c;require("fs-extra");a=require("fs");console.log("start to move remote folder");a.rename(b,c,function(a){d(a)})}else d(Error("remote folder is null"));
else d(Error("parent folder path is null"))},copy:function(a,b,c,d){var e=require("path");(b=b.getFolderPath())?(a=a.getFolderPath()+e.sep+c,require("fs-extra").copy(b,a,function(a){d&&d(a)})):d&&d(Error("remote folder invalid"))}};m.aio.configmanager.Pages=function(a){m.aio.configmanager.ListNode.call(this,a);this.parent=a;this.children=[]};m.aio.configmanager.Pages.prototype=Object.create(m.aio.configmanager.ListNode.prototype);m.aio.configmanager.Pages.prototype.constructor=m.aio.configmanager.Pages;
m.aio.configmanager.Pages.prototype.getFolderPath=function(){if(!this.parent)return null;var a=this.parent.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+m.aio.configmanager.Remote.PAGES};m.aio.configmanager.Pages.prototype.getChild=function(a){for(var b=0;b<this.children.length;b++){var c=this.children[b];if(c.index==a)return c}return null};
m.aio.configmanager.Pages.prototype.removeChild=function(a){for(var b=-1,c=0;c<this.children.length;c++)if(this.children[c].index==a.index){b=c;break}0<=b&&this.children.splice(b,1);a.parent=null};m.aio.configmanager.Pages.prototype.sort=function(){var a=this.children.length-1,b=!1;do for(var b=!1,c=0;c<a;++c)this.children[c].index>this.children[c+1].index&&(b=this.children[c],this.children[c]=this.children[c+1],this.children[c+1]=b,b=!0);while(b)};
m.aio.configmanager.PagesHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.PagesJSONHandler.toJSON(a));break;case "create":(b=m.aio.configmanager.PageJSONHandler.fromJSON(c))?this._add(a,b,function(a,b){a?d(a):d(null,m.aio.configmanager.PageJSONHandler.toJSON(b))}):d(Error("json format invalid"));break;default:d(Error("no such method"))}},_add:function(a,b,c){var d=this;require("async").waterfall([function(c){d._preAddNode(a,b,c)},function(c,f){d._addNode(a,b,f)},
function(c,f){d._postAddNode(a,b,f)}],function(a,b){c(a,b)})},_preAddNode:function(a,b,c){var d=1;if(b.id)if(b.id.match(m.aio.configmanager.Util.FILENAME_REGEX))c(Error("page id has invalid character"));else{for(var e=0;e<a.children.length;e++){var f=a.children[e];if(f.index==b.index){c(Error("page with same index exists","configmanager.js"));return}if(f.id==b.id){c(Error("page with same name exists","configmanager.js"));return}f.index==d&&d++}if(!b.index||0>=b.index)b.index=d;m.aio.configmanager.PagePersistHandler.save(a,
b,function(a){c(a,b)})}else c(Error("name is null"))},_addNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postAddNode:function(a,b,c){a.sort();c(null,b)}};m.aio.configmanager.PagesJSONHandler={toJSON:function(a){if(!a)return null;for(var b=[],c=0;c<a.children.length;c++){var d=m.aio.configmanager.PageJSONHandler.toJSON(a.children[c]);d&&b.push(d)}return b}};
m.aio.configmanager.PagesPersistHandler={load:function(a,b,c){var d=new m.aio.configmanager.Pages;d.parent=a;var e=this,f=require("fs");f.exists(b,function(a){a?f.readdir(b,function(a,h){if(a)c(a);else{var n=require("async"),p=require("path");n.eachLimit(h,10,function(a,c){".p"==p.extname(a)?f.stat(b+p.sep+a,function(f,g){!f&&g.isFile()?m.aio.configmanager.PagePersistHandler.load(d,b+p.sep+a,function(a,b){b?e._load(d,b,function(a,b){c(a,b)}):c()}):c()}):c()},function(a){d.sort();a?c(a):c(null,d)})}}):
c(null,d)})},_load:function(a,b,c){var d=this;require("async").waterfall([function(c){d._preLoadNode(a,b,c)},function(b,c){d._loadNode(a,b,c)},function(c,f){d._postLoadNode(a,b,f)}],function(a,b){c(a,b)})},_preLoadNode:function(a,b,c){var d=!1;if(!b.index||0>b.index)b.index=1,d=!0;var e=!1;do for(var e=!1,f=0;f<a.children.length;f++)a.children[f].index==b.index&&(b.index++,e=d=!0);while(e);d&&(b._changed=!0);c(null,b)},_loadNode:function(a,b,c){b.parent=a;a.children.push(b);c(null,b)},_postLoadNode:function(a,
b,c){b._changed?m.aio.configmanager.PagePersistHandler.save(a,b,function(a){delete b._changed;c(a,b)}):c(null,b)}};m.aio.configmanager.Page=function(a){m.aio.configmanager.Node.call(this,a);this.parent=a;this.index=-1;this.id=null};m.aio.configmanager.Page.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.Page.prototype.constructor=m.aio.configmanager.Page;
m.aio.configmanager.Page.prototype.getChild=function(a){return a&&"string"===typeof a?"pagecontent"==a?(a=m.aio.configmanager.PageContentPersistHandler.loadSync(this.getFolderPath()),a.parent=this,a):this[a]:null};m.aio.configmanager.Page.prototype.getFile=function(){return this.id};m.aio.configmanager.Page.prototype.getFolderPath=function(){if(!this.parent)return null;var a=this.parent.getFolderPath();if(!a)return null;var b=require("path");return a+b.sep+this.id+".p"};
m.aio.configmanager.Page.prototype.processResourceList=function(a,b){var c=this;m.aio.configmanager.PageContentPersistHandler.load(this.getFolderPath(),function(d,e){d?b&&b(d):e.processResourceList(c,a,function(a){b&&b(a)})})};
m.aio.configmanager.PageHandler={execute:function(a,b,c,d){var e=a.parent;switch(b){case "read":d(null,m.aio.configmanager.PageJSONHandler.toJSON(a));break;case "delete":if(!e){d(Error("page is isolated"));break}m.aio.configmanager.PagePersistHandler.remove(e,a,function(b){b?d(b):(e.removeChild(a),d(null,{success:!0}))});break;case "update":if(!e){d(Error("page is isolated"));break}var f=m.aio.configmanager.PageJSONHandler.fromJSON(c);if(!f){d(Error("data format invalid"));break}if(!f.id){d(Error("data format invalid:id is empty"));
break}if(f.id.match(m.aio.configmanager.Util.FILENAME_REGEX)){d(Error("page id has invalid character"));break}if(a.id==f.id){d(null,m.aio.configmanager.PageJSONHandler.toJSON(a));break}for(b=0;b<e.children.length;b++)if(e.children[b].id==f.id){d(Error("page id is already existed"));return}m.aio.configmanager.PagePersistHandler.move(e,a,f.id,function(b){b?d(b):(a.id=f.id,d(null,m.aio.configmanager.PageJSONHandler.toJSON(a)))});break;default:d(Error("no such method"))}}};
m.aio.configmanager.PageJSONHandler={fromJSON:function(a){if(!a||!a.classid||"page"!==a.classid)return null;var b=new m.aio.configmanager.Page;b.index=a.index?a.index:-1;b.id=a.id;return b},toJSON:function(a){return{classid:"page",index:a.index,id:a.id}}};
m.aio.configmanager.PagePersistHandler={save:function(a,b,c){var d=a.getFolderPath(),e=b.getFile();if(d)if(e){var f=require("path"),e=d+f.sep+e+".p";m.aio.configmanager.PageContentPersistHandler.load(e,function(d,e){d?c(d):(e.content||(e.content={}),e.content.index=b.index,m.aio.configmanager.PageContentPersistHandler.save(a,b,e,function(a){c(a,b)}))})}else c(Error("page file is null"));else c(Error("parent folder path is null"))},load:function(a,b,c){var d=this,e=new m.aio.configmanager.Page;e.parent=
a;var f=require("fs");f.exists(b,function(a){a?f.readFile(b,function(a,f){if(a)c(a);else{var h=require("path"),h=b.lastIndexOf(h.sep),p=b.substr(h+1),h=p.indexOf(".p");if(-1==h||h!=p.length-2)c(null,null);else{e.id=p.replace(".p","");if(0<f.length)try{var k=JSON.parse(f.toString());e.index=k.index}catch(q){d.saveDamageFile(b,f,function(){c(null,e)});return}c(null,e)}}}):c(null,null)})},saveDamageFile:function(a,b,c){require("fs").writeFile(a+".bk",b,c)},remove:function(a,b,c){a=a.getFolderPath();
b=b.getFile();if(a)if(b){var d=require("path");b=a+d.sep+b+".p";require("fs-extra").remove(b,function(a){c(a)})}else c(Error("page file is null"));else c(Error("parent folder path is null"))},move:function(a,b,c,d){a=a.getFolderPath();var e=b.getFile();a?e?(b=require("path"),e=a+b.sep+e+".p",c=a+b.sep+c+".p",require("fs-extra").move(e,c,function(a){d(a)})):d(Error("page file is null")):d(Error("parent folder path is null"))}};
m.aio.configmanager.PageContent=function(a){m.aio.configmanager.Node.call(this,a);this.content=null};m.aio.configmanager.PageContent.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.PageContent.prototype.constructor=m.aio.configmanager.PageContent;
m.aio.configmanager.PageContent.prototype.processResourceList=function(a,b,c){var d=function(a,b,c){return b?a.processResourceSync(b,c):null},e=function(a,b){if(b&&b.states&&"object"===typeof b.states){var c="string"===typeof b.path?b.path.length:0,e;for(e in b.states){var f=b.states[e];if(f&&"object"===typeof f&&"string"===typeof f.i){var h=0!==f.p&&"string"===typeof b.path;g=d(a,h?b.path+"/"+f.i:f.i,f.s);l=l||!!g;g&&(f=h?c+1:0,0===f&&"/"==g[0]&&f++,b.states[e].i=g.substr(f))}}}},f=function(a,b){if(b&&
b.info&&"object"===typeof b.info){var c="string"===typeof b.info.path?b.info.path+"/":"",e;for(e in b.info){var f=b.info[e];"path"!=e&&f&&"string"===typeof f&&(g=d(a,c+f,b.img_skin),l=l||!!g,g&&(b.info[e]=g.substr(0<c.length?c.length:1)))}}};try{var h,g,l=!1;this.content&&(this.content.widget&&this.content.widget.bgimg&&(g=d(b,this.content.widget.bgimg,this.content.widget.bgimg_skin),l=l||!!g,g&&(this.content.widget.bgimg=g)),this.content.infos&&this.content.infos.forEach(function(c){if(c.widget){g=
d(b,c.widget.img,c.widget.img_skin);l=l||!!g;g&&(c.widget.img=g);g=d(b,c.widget.bgimg,c.widget.bgimg_skin);l=l||!!g;g&&(c.widget.bgimg=g);if(c.widget.path&&c.widget.images)for(h=0;h<c.widget.images.length;h++){var k=c.widget.images[h];if(k){var n=0<=k.indexOf("/")?"":c.widget.path+"/";g=d(b,n+k,c.widget.img_skin);l=l||!!g;g&&(c.widget.images[h]=g.substr(n))}}e(b,c.widget);f(b,c.widget);"string"===typeof c.widget.stateRuleRef&&a&&a.parent&&(k=(k=a.parent.parent)&&k.info&&k.info.stateRules)&&k[c.widget.stateRuleRef]&&
e(b,k[c.widget.stateRuleRef])}}),this.content.buttons&&this.content.buttons.forEach(function(c){if(c.widget){g=d(b,c.widget.img,c.widget.img_skin);l=l||!!g;g&&(c.widget.img=g);g=d(b,c.widget.bgimg,c.widget.bgimg_skin);l=l||!!g;g&&(c.widget.bgimg=g);if(c.widget.path&&c.widget.images)for(h=0;h<c.widget.images.length;h++){var k=c.widget.images[h];if(k){var n=0<=k.indexOf("/")?"":c.widget.path+"/";g=d(b,n+k,c.widget.img_skin);l=l||!!g;g&&(c.widget.images[h]=g.substr(n))}}e(b,c.widget);f(b,c.widget);"string"===
typeof c.widget.stateRuleRef&&a&&a.parent&&(k=(k=a.parent.parent)&&k.info&&k.info.stateRules)&&k[c.widget.stateRuleRef]&&e(b,k[c.widget.stateRuleRef])}}),this.content.selects&&this.content.selects.forEach(function(a){a.widget&&(g=d(b,a.widget.img_n,a.widget.img_skin_n),l=l||!!g,g&&(a.widget.img_n=g),g=d(b,a.widget.img_y,a.widget.img_skin_y),l=l||!!g,g&&(a.widget.img_y=g),g=d(b,a.widget.bgimg,a.widget.bgimg_skin),l=l||!!g,g&&(a.widget.bgimg=g))}),this.content.sliders&&this.content.sliders.forEach(function(a){a.widget&&
(a=a.widget)&&b.processWidgetSync(a)}),this.content.roundsliders&&this.content.roundsliders.forEach(function(a){a.widget&&(a=a.widget)&&b.processWidgetSync(a)}),this.content.colorchoosers&&this.content.colorchoosers.forEach(function(a){a.widget&&(a=a.widget)&&b.processWidgetSync(a)}),this.content.analogmeters&&this.content.analogmeters.forEach(function(a){a.widget&&(a=a.widget)&&b.processWidgetSync(a)}),this.content.amps&&this.content.amps.forEach(function(a){a.widget&&(a=a.widget)&&b.processWidgetSync(a)}));
l?m.aio.configmanager.PageContentPersistHandler.save(a.parent,a,this,function(a){c&&c(a)}):c&&c(null)}catch(n){c&&c(n)}};
m.aio.configmanager.PageContentHandler={execute:function(a,b,c,d){switch(b){case "read":d(null,m.aio.configmanager.PageContentJSONHandler.toJSON(a));break;case "update":b=m.aio.configmanager.PageContentJSONHandler.fromJSON(c);if(!b){d(Error("data format invalid"));break}c=a.parent;if(!c){d(Error("page content is isolated"));break}var e=c.parent;if(!e){d(Error("page content is isolated"));break}m.aio.configmanager.PageContentPersistHandler.save(e,c,b,function(b){d(b,m.aio.configmanager.PageContentJSONHandler.toJSON(a))});
break;default:d(Error("no such method"))}}};m.aio.configmanager.PageContentJSONHandler={fromJSON:function(a){if(!a||!a.classid||"control"!==a.classid)return null;var b=new m.aio.configmanager.PageContent;b.content=a;return b},toJSON:function(a){return a.content}};
m.aio.configmanager.PageContentPersistHandler={save:function(a,b,c,d){a=a.getFolderPath();var e=b.getFile();if(a)if(e){var f=require("path"),e=a+f.sep+e+".p";if(c){var h=c.content;h||(h={});h.classid&&"control"===h.classid||(h.classid="control");h.index=b.index;b=require("fs-extra");var g=require("fs");b.ensureFile(e,function(a){a?d(a):(a=require("unorm").nfc(JSON.stringify(h)),g.writeFile(e,a,function(a){d(a)}))})}else d(Error("content is null"))}else d(Error("page file is null"));else d(Error("parent folder path is null"))},
load:function(a,b){var c=new m.aio.configmanager.PageContent,d=require("fs");d.exists(a,function(e){e?d.readFile(a,function(a,d){if(a)b(a);else{if(0<d.length)try{c.content=JSON.parse(d.toString())}catch(e){b(null,c);return}b(null,c)}}):b(null,c)})},loadSync:function(a){var b=new m.aio.configmanager.PageContent,c=require("fs");try{var d=c.readFileSync(a);0<d.length&&(b.content=JSON.parse(d.toString()))}catch(e){}return b}};m.aio.configmanager.Util={FILENAME_REGEX:/[\\/:"*?<>|]+/g};
m.aio.configmanager.ConfigManager=function(){m.aio.configmanager.Node.call(this,null);this.filemanager=this.config=null};m.aio.configmanager.ConfigManager.USER_CONFIG="";m.aio.configmanager.ConfigManager.prototype=Object.create(m.aio.configmanager.Node.prototype);m.aio.configmanager.ConfigManager.prototype.constructor=m.aio.configmanager.ConfigManager;
m.aio.configmanager.ConfigManager.prototype.init=function(a,b){var c=require("path"),d=require("fs");this.filemanager=a;m.aio.configmanager.ConfigManager.USER_CONFIG=a.getUserRootDataPath()+c.sep+"tenants";var e=this;require("async").series([function(a){var b=m.aio.configmanager.ConfigManager.USER_CONFIG;d.exists(b,function(c){c?d.stat(b,function(c,e){c?a(c):e.isDirectory()?a():d.unlink(b,function(c){c?a(c):d.mkdir(b,function(b){a(b)})})}):d.mkdir(b,function(b){a(b)})})},function(a){m.aio.configmanager.ConfigPersistHandler.load(m.aio.configmanager.ConfigManager.USER_CONFIG,
function(b,c){b?a(b):(e.config=c,a())})},function(a){if(e.config&&e.config.tenants&&0!=e.config.tenants.size())a();else{e.config.tenants||(e.config.tenants=new m.aio.configmanager.Tenants,e.config.tenants.parent=e.config);var b=new m.aio.configmanager.Tenant;b.index=1;b.name="default";b.parent=e.config.tenants;e.config.tenants.children.push(b);m.aio.configmanager.TenantPersistHandler.save(e.config.tenants,b,function(b){a(b)})}},function(a){if(e.config&&e.config.tenants&&0<e.config.tenants.size()){for(var b=
!1,c,d=0;d<e.config.tenants.size();d++)if(c=e.config.tenants.get(d),c.default){b=!0;break}b?a():(c=e.config.tenants.get(0),c.default=!0,m.aio.configmanager.TenantPersistHandler.save(e.config.tenants,c,function(b){a(b)}))}else a()}],function(a){b&&b(a)})};
m.aio.configmanager.ConfigManager.prototype.execute=function(a,b,c,d){if(b=m.aio.configmanager.Path.resolve(b))if(b=m.aio.configmanager.Path.trace(this,b)){var e=this._getCRUDHandler(b);e?m.aio.configmanager.LicenseManager.permit(a,b)?e.execute(b,a,c,function(a,b){a?d(a):d(null,b)}):d(Error("not permitted")):d(Error("no handler"))}else d(Error("no such route"));else d(Error("invalid route format"))};
m.aio.configmanager.ConfigManager.prototype.trace=function(a,b){var c=m.aio.configmanager.Path.resolve(a);c?(c=m.aio.configmanager.Path.trace(this,c))?b&&b(null,c):b&&b(Error("no such route")):b&&b(Error("invalid route format"))};m.aio.configmanager.ConfigManager.prototype.getChild=function(a){switch(a.toLowerCase()){case "config":return this.config;default:return null}};
m.aio.configmanager.ConfigManager.prototype._getCRUDHandler=function(a){return a instanceof m.aio.configmanager.Config?m.aio.configmanager.ConfigHandler:a instanceof m.aio.configmanager.License?m.aio.configmanager.LicenseHandler:a instanceof m.aio.configmanager.Tenants?m.aio.configmanager.TenantsHandler:a instanceof m.aio.configmanager.Tenant?m.aio.configmanager.TenantHandler:a instanceof m.aio.configmanager.Remotes?m.aio.configmanager.RemotesHandler:a instanceof m.aio.configmanager.Remote?m.aio.configmanager.RemoteHandler:
a instanceof m.aio.configmanager.Pages?m.aio.configmanager.PagesHandler:a instanceof m.aio.configmanager.Page?m.aio.configmanager.PageHandler:a instanceof m.aio.configmanager.PageContent?m.aio.configmanager.PageContentHandler:null};
m.aio.configmanager.ConfigManager.prototype.updateBlockedLicenses=function(a,b){if(this.config&&this.config.tenants&&this.config.tenants.children)for(var c=0;c<this.config.tenants.children.length;c++){var d=this.config.tenants.children[c];if(d.license)for(var e=0;e<a.length;e++)if(d.license.id==a[e].id&&d.license.version==a[e].version&&d.license.type==(a[e].type?m.aio.configmanager.License.TYPE.TEST:m.aio.configmanager.License.TYPE.NORMAL)){d.license.valid=!1;break}}b&&b()};
m.aio.configmanager.ConfigManager.prototype.getAllLicenses=function(){if(!this.config||!this.config.tenants)return null;var a=this.config.tenants.getChildren();if(!a||0==a.length)return[];for(var b=[],c=0;c<a.length;c++){var d=a[c];d&&d.license&&b.push(d.license)}return b};m.aio.configmanager.CM=new m.aio.configmanager.ConfigManager;m.aio.configmanager.CM.License=m.aio.configmanager.License;m.aio.configmanager.CM.LicenseManager=m.aio.configmanager.LicenseManager;m.aio.configmanager.CM.Config=m.aio.configmanager.Config;
m.aio.configmanager.CM.ConfigPersistHandler=m.aio.configmanager.ConfigPersistHandler;m.aio.configmanager.CM.ConfigJSONHandler=m.aio.configmanager.ConfigJSONHandler;m.aio.configmanager.CM.Tenants=m.aio.configmanager.Tenants;m.aio.configmanager.CM.TenantsPersistHandler=m.aio.configmanager.TenantsPersistHandler;m.aio.configmanager.CM.TenantsHandler=m.aio.configmanager.TenantsHandler;m.aio.configmanager.CM.Tenant=m.aio.configmanager.Tenant;m.aio.configmanager.CM.TenantPersistHandler=m.aio.configmanager.TenantPersistHandler;
m.aio.configmanager.CM.TenantHandler=m.aio.configmanager.TenantHandler;m.aio.configmanager.CM.Remotes=m.aio.configmanager.Remotes;m.aio.configmanager.CM.RemotesPersistHandler=m.aio.configmanager.RemotesPersistHandler;m.aio.configmanager.CM.RemotesHandler=m.aio.configmanager.RemotesHandler;m.aio.configmanager.CM.Remote=m.aio.configmanager.Remote;m.aio.configmanager.CM.RemotePersistHandler=m.aio.configmanager.RemotePersistHandler;m.aio.configmanager.CM.RemoteHandler=m.aio.configmanager.RemoteHandler;
m.aio.configmanager.CM.Pages=m.aio.configmanager.Pages;m.aio.configmanager.CM.PagesPersistHandler=m.aio.configmanager.PagesPersistHandler;m.aio.configmanager.CM.PagesHandler=m.aio.configmanager.PagesHandler;m.aio.configmanager.CM.Page=m.aio.configmanager.Page;m.aio.configmanager.CM.PagePersistHandler=m.aio.configmanager.PagePersistHandler;m.aio.configmanager.CM.PageHandler=m.aio.configmanager.PageHandler;m.aio.configmanager.CM.PageContent=m.aio.configmanager.PageContent;
m.aio.configmanager.CM.PageContentHandler=m.aio.configmanager.PageContentHandler;"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.configmanager.CM);
