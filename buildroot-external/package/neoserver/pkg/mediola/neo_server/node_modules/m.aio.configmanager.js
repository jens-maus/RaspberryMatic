function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o;}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o;},_typeof(o);}var m=m||{};m.aio=m.aio||{},m.aio.configmanager=m.aio.configmanager||{},m.aio.configmanager.Path=function(){this._routes=[];},m.aio.configmanager.Path.prototype.isEmpty=function(){return 0===this._routes.length;},m.aio.configmanager.Path.prototype.pop=function(){return 0===this._routes.length?null:this._routes.splice(0,1)[0];},m.aio.configmanager.Path.resolve=function(e){if(!e)return null;for(var n=new m.aio.configmanager.Path(),i=e.split("/"),a=0;a<i.length;a++)if(0===i[a].length){if(0!==a&&a!==i.length-1)return null;}else n._routes.push(i[a]);return n;},m.aio.configmanager.Path.trace=function(e,n){for(var i,a=null,t=e;null!==(i=n.pop());){var r=t.getChild(i);if(!r)return null;a=r,t=r;}return a;},m.aio.configmanager.Node=function(e){this.index=-1,this.classid="",this.parent=e;},m.aio.configmanager.Node.prototype.getChild=function(e){return e&&"string"==typeof e?this[e]:null;},m.aio.configmanager.ListNode=function(e){m.aio.configmanager.Node.call(this,e),this.children=[];},m.aio.configmanager.ListNode.prototype=Object.create(m.aio.configmanager.Node.prototype),m.aio.configmanager.ListNode.prototype.constructor=m.aio.configmanager.ListNode,m.aio.configmanager.ListNode.prototype.size=function(){return this.children.length;},m.aio.configmanager.ListNode.prototype.get=function(e){return this.children[e];},m.aio.configmanager.License=function(e){m.aio.configmanager.Node.call(this,e),this.parent=null,this.id=null,this.licenseTxt=null,this.type=null,this.duration=0,this.valid=!1,this.version=0,this.features=null;},m.aio.configmanager.License.TYPE={NORMAL:"normal",TEST:"test"},m.aio.configmanager.License.prototype=Object.create(m.aio.configmanager.Node.prototype),m.aio.configmanager.License.prototype.constructor=m.aio.configmanager.License,m.aio.configmanager.License.prototype.getDaysLeft=function(){if(this.type!=m.aio.configmanager.License.TYPE.TEST)return 0;if(!this.licenseTxt)return 0;if(!m.aio.configmanager.CM.filemanager)return 0;if(1==this.version&&0==this.id)return-1;var e=m.aio.configmanager.CM.filemanager.Preference.read(this.licenseTxt);if(!e)return-1;var n=new Date(parseInt(e)),i=new Date(),a=Math.floor((i.getTime()-n.getTime())/1e3/60/60/24);return 7*this.duration-a<=0?0:7*this.duration-a;},m.aio.configmanager.License.prototype.saveStartDate=function(){if(this.licenseTxt&&this.valid&&m.aio.configmanager.CM){var e=m.aio.configmanager.CM.filemanager.Preference;if(!e.read(this.licenseTxt)){var n=new Date().getTime();e.save(this.licenseTxt,n.toString());}}},m.aio.configmanager.License.prototype.getStartDate=function(){if(this.licenseTxt&&this.valid&&m.aio.configmanager.CM)return m.aio.configmanager.CM.filemanager.Preference.read(this.licenseTxt);},m.aio.configmanager.License.prototype.saveStartDateWithDate=function(e){m.aio.configmanager.CM.filemanager.Preference.save(this.licenseTxt,e);},m.aio.configmanager.License.prototype.isTestLicense=function(){return this.type==m.aio.configmanager.License.TYPE.TEST;},m.aio.configmanager.License.prototype.isExpired=function(){return this.type==m.aio.configmanager.License.TYPE.TEST&&0==this.getDaysLeft();},m.aio.configmanager.License.prototype.getFeatureModules=function(){return require("m.aio.infomanager.js").getFeatureModules(this);},m.aio.configmanager.License.prototype.getFeatureModulesSUS=function(){return require("m.aio.infomanager.js").getFeatureModulesSUS(this);},m.aio.configmanager.License.prototype.getSUSFlatrate=function(){return require("m.aio.infomanager.js").getSUSFlatrate(this);},m.aio.configmanager.License.prototype.isUltimateTestLicense=function(){return!!this.isTestLicense()&&1==this.version&&0==this.id;},m.aio.configmanager.License.prototype.isPartnerUltimateLicense=function(){return!this.isTestLicense()&&2==this.version&&!!this.features&&this.features.readUInt8(0)>>7&1;},m.aio.configmanager.LicenseManager={BLOCKED:[],UUENCODE_MAP:"MXBPWG7QJD6K3R4S2U98ETFH51AZNCYV",resolve:function resolve(e){if(!e)return null;e=e.toUpperCase();var n=new m.aio.configmanager.License();n.licenseTxt=e;var i=e.replace(/-/g,"");if(20!=i.length)return n.valid=!1,n;var a=this._uudecode(i);return a&&(a=this._decrypt(a))&&(a=this._resolve(a))?(this._isBlocked(a)&&(a.valid=!1),a.licenseTxt=e,a):(n.valid=!1,n);},_isBlocked:function _isBlocked(e){if(require("m.aio.infomanager.js").isLicenseBlocked(e))return!0;if(0!=e.version)return!1;var n=m.aio.configmanager.CM.filemanager.getPref().read("blockedid");n||(n=this.BLOCKED),n.length<this.BLOCKED.length&&(n=this.BLOCKED);for(var i=0;i<n.length;i++)if(e.id==n[i])return!0;return!1;},_uudecode:function _uudecode(e){var n,i=require("big-integer")(0);for(n=0;n<20;n++){var a=this.UUENCODE_MAP.indexOf(e.charAt(n));if(-1==a)return null;i=i.shiftLeft(5).add(a);}return i;},_decrypt:function _decrypt(e){var n=require("big-integer");if(15!=e.and(15).toJSNumber())return null;var i=e.shiftRight(4),a=n("43138825561077299640793988347"),t=n("23300244857271456227675018177"),r=i.modPow(t,a);return 7!=r.shiftRight(92).toJSNumber()?null:r;},_resolve:function _resolve(e){var n=new m.aio.configmanager.License(),i=e.toString(16);i.length%2!=0&&(i="0"+i);var a=new Buffer(i,"hex");n.version=15&a.readUInt8(0);var t=a.readUInt8(1);switch(n.type=t>>7?m.aio.configmanager.License.TYPE.TEST:m.aio.configmanager.License.TYPE.NORMAL,n.type){case m.aio.configmanager.License.TYPE.TEST:n.duration=t>>4&7,n.id=(a.readUInt8(1)<<16)+(a.readUInt8(2)<<8)+a.readUInt8(3)&1048575;break;case m.aio.configmanager.License.TYPE.NORMAL:n.id=(a.readUInt8(1)<<16)+(a.readUInt8(2)<<8)+a.readUInt8(3)&8388607;}if(n.features=a.slice(4),"test"==n.type&&1==n.id){var r=n.features.readUInt8(7);r|=192;var o=n.features.readUInt8(6);o|=63,n.features.writeUInt8(r,7),n.features.writeUInt8(o,6);}return n.valid=!0,n;},permit:function permit(e,n){if(!n)return!1;if(n instanceof m.aio.configmanager.Config||n instanceof m.aio.configmanager.Tenants||n instanceof m.aio.configmanager.Tenant)return!0;if(n instanceof m.aio.configmanager.License&&n.parent)return!0;var i=this._getTenant(n);return!(!(i&&i.license&&i.license.valid)||i.license.isTestLicense()&&i.license.isExpired());},permitFeature:function permitFeature(e,n,i,a,t,r){return"delete"==e||require("m.aio.infomanager.js").permitFeature(e,n,i,a,t,r);},_getTenant:function _getTenant(e){for(var n=e;n;){if(n instanceof m.aio.configmanager.Tenant)return n;n=n.parent;}return null;}},m.aio.configmanager.LicenseHandler={execute:function execute(e,n,i,a){switch(n){case"read":a(null,m.aio.configmanager.LicenseJSONHandler.toJSON(e));break;case"update":if(!e)return void(a&&a(new Error("license is null")));if(!i)return void(a&&a(new Error("data is null")));if(!e.parent)return void(a&&a(new Error("license is isolated")));var t=m.aio.configmanager.TenantJSONHandler.toJSON(e.parent);t.license=i,m.aio.configmanager.TenantHandler.execute(e.parent,"update",t,function(e,n){e?a&&a(e):a&&a(null,n.license);});break;default:a(new Error("no such method"));}}},m.aio.configmanager.LicenseJSONHandler={fromJSON:function fromJSON(e){return e&&e.classid&&"license"===e.classid&&e.license?m.aio.configmanager.LicenseManager.resolve(e.license):null;},toJSON:function toJSON(e){var n={classid:"license",license:e.licenseTxt,partner_ultimate:e.isPartnerUltimateLicense(),type:e.type,duration:e.duration,valid:e.valid,daysLeft:e.getDaysLeft(),features:e.getFeatureModules(),features_sus:e.getFeatureModulesSUS(),features_sus_flatrate:e.getSUSFlatrate()};return-1==n.daysLeft&&delete n.daysLeft,n;}},m.aio.configmanager.Config=function(e){m.aio.configmanager.Node.call(this,null),this.folder=e,this.tenants=new m.aio.configmanager.Tenants(this);},m.aio.configmanager.Config.prototype=Object.create(m.aio.configmanager.Node.prototype),m.aio.configmanager.Config.prototype.constructor=m.aio.configmanager.Config,m.aio.configmanager.Config.SETTING="settings",m.aio.configmanager.Config.prototype.getFolderPath=function(){return this.folder;},m.aio.configmanager.ConfigHandler={execute:function execute(e,n,i,a){"read"===n?a(null,m.aio.configmanager.ConfigJSONHandler.toJSON(e)):a(new Error("no such method"));}},m.aio.configmanager.ConfigJSONHandler={toJSON:function toJSON(e){return e?{classid:"config",tenants:e.tenants?m.aio.configmanager.TenantsJSONHandler.toJSON(e.tenants):null}:null;}},m.aio.configmanager.ConfigPersistHandler={save:function save(e,n){var i=e.getFolderPath();if(i){var a=require("async"),t=require("fs");a.series([function(e){t.exists(i,function(n){n?t.stat(i,function(n,a){n?e(n):a.isDirectory()?e():e(new Error(i+" is not a folder"));}):require("fs-extra").mkdirs(i,function(n){e(n);});});},function(e){var n=require("path");t.writeFile(i+n.sep+m.aio.configmanager.Config.SETTING,JSON.stringify({}),function(n){e(n);});}],function(e){n(e);});}else n(new Error("folder of the config is invalid"));},load:function load(e,n){var i=new m.aio.configmanager.Config(),a=require("path");this._loadSettings(e+a.sep+m.aio.configmanager.Config.SETTING,function(a){a?n(a):(i.folder=e,m.aio.configmanager.TenantsPersistHandler.load(i,e,function(e,a){e?n(e):(a.parent=i,i.tenants=a,n(null,i));}));});},_loadSettings:function _loadSettings(e,n){var i=require("fs");i.exists(e,function(a){a?i.readFile(e,function(e,i){if(e)n(e);else{var a={};if(i.length>0)try{a=JSON.parse(i.toString());}catch(e){return void n(null,{});}n(null,a);}}):n(null,{});});}},m.aio.configmanager.Tenants=function(e){m.aio.configmanager.ListNode.call(this,e),this.children=[];},m.aio.configmanager.Tenants.prototype=Object.create(m.aio.configmanager.ListNode.prototype),m.aio.configmanager.Tenants.prototype.constructor=m.aio.configmanager.Tenants,m.aio.configmanager.Tenants.prototype.decideOnDefault=function(e){for(var n=!1,i=[],a=0;a<this.children.length;a++){var t=this.children[a];t["default"]&&(t.license?n=!0:i.push(t));}if(n&&i.length>0){var r=this,o=function o(n){if(n>=i.length)e();else{var a=i[n];a["default"]=!1,m.aio.configmanager.TenantPersistHandler.save(r,a,function(e){o(n+1);});}};o(0);}else e();},m.aio.configmanager.Tenants.prototype.getFolderPath=function(){return this.parent?this.parent.getFolderPath():null;},m.aio.configmanager.Tenants.prototype.getChildren=function(){return this.children;},m.aio.configmanager.Tenants.prototype.getChild=function(e){for(var n=0;n<this.children.length;n++){var i=this.children[n];if(i.index==e)return i;}return null;},m.aio.configmanager.Tenants.prototype.removeChild=function(e){for(var n=-1,i=0;i<this.children.length;i++)if(this.children[i].index==e.index){n=i;break;}n>=0&&this.children.splice(n,1),e.parent=null;},m.aio.configmanager.Tenants.prototype.sort=function(){var e=this.children.length-1,n=!1;do{n=!1;for(var i=0;i<e;++i)if(this.children[i].index>this.children[i+1].index){var a=this.children[i];this.children[i]=this.children[i+1],this.children[i+1]=a,n=!0;}}while(n);},m.aio.configmanager.TenantsHandler={execute:function execute(e,n,i,a){switch(n){case"read":a(null,m.aio.configmanager.TenantsJSONHandler.toJSON(e));break;case"create":var t=m.aio.configmanager.TenantJSONHandler.fromJSON(i);t?this._add(e,t,function(e,n){e?a(e):(n&&n.license&&!n.license.isTestLicense()&&require("m.aio.infomanager.js").retrieveInfo(),a(null,m.aio.configmanager.TenantJSONHandler.toJSON(n)));}):a(new Error("json format invalid"));break;default:a(new Error("no such method"));}},_add:function _add(e,n,i){var a=this;require("async").waterfall([function(i){a._preAddNode(e,n,i);},function(n,i){a._addNode(e,n,i);},function(n,i){a._postAddNode(e,n,i);}],function(e,n){i(e,n);});},_preAddNode:function _preAddNode(e,n,i){var a=1;if(n.name){if(n.license){if(n.license.valid){if(n.license.isTestLicense()&&n.license.isExpired())i(new Error("test license is expired"));else{for(var t=0;t<e.children.length;t++){var r=e.children[t];if(r.index==n.index)return void i(new Error("tenant with same id exists","configmanager.js"));if(r.name==n.name)return void i(new Error("remote with same name exists","configmanager.js"));if(r.license&&n.license&&r.license.licenseTxt&&n.license.licenseTxt&&r.license.type==n.license.type&&r.license.id==n.license.id&&r.license.version==n.license.version)return void i(new Error("tenant with same license exists","configmanager.js"));r.index==a&&a++;}(!n.index||n.index<=0)&&(n.index=a),m.aio.configmanager.TenantPersistHandler.save(e,n,function(e){n.license&&n.license.valid&&n.license.isTestLicense()&&n.license.saveStartDate(),i(e,n);});}}else i(new Error("license is invalid"));}else i(new Error("license is null"));}else i(new Error("name is null"));},_addNode:function _addNode(e,n,i){n.parent=e,e.children.push(n),i(null,n);},_postAddNode:function _postAddNode(e,n,i){e.sort();var a=require("m.aio.devicemanager.js"),t=require("m.aio.macromanager.js");a.addTenant(n,function(e){e?i&&i(e):t.addTenant(n,function(e){i&&i(e,n);});});}},m.aio.configmanager.TenantsJSONHandler={toJSON:function toJSON(e){if(!e)return null;for(var n=[],i=0;i<e.children.length;i++){var a=e.children[i];n.push(m.aio.configmanager.TenantJSONHandler.toJSON(a));}return n;}},m.aio.configmanager.TenantsPersistHandler={load:function load(e,n,i){var a=new m.aio.configmanager.Tenants();a.parent=e;var t=this,r=require("fs");r.readdir(n,function(e,o){e?i(e):require("async").eachSeries(o,function(e,i){var o=require("path");r.stat(n+o.sep+e,function(r,s){!r&&s.isDirectory()?m.aio.configmanager.TenantPersistHandler.load(a,n+o.sep+e,function(e,n){n?t._load(a,n,function(e,n){i(e,n);}):i();}):i();});},function(e){e?i(e):(a.sort(),a.decideOnDefault(function(){i(null,a);}));});});},_load:function _load(e,n,i){var a=this;require("async").waterfall([function(i){a._preLoadNode(e,n,i);},function(n,i){a._loadNode(e,n,i);},function(n,i){a._postLoadNode(e,n,i);}],function(e,n){i(e,n);});},_preLoadNode:function _preLoadNode(e,n,i){var a=!1;(!n.index||n.index<0)&&(n.index=1,a=!0),n.name||(n.name="new_config",a=!0);var t=!1;do{t=!1;for(var r=0;r<e.children.length;r++){var o=e.children[r];if(o.index==n.index&&(n.index++,a=!0,t=!0),o.name==n.name){var s=/[(]{1}[\d]+[)]{1}$/;if(s.test(n.name)){var g=n.name.match(s)[0];g=parseInt(g),g++,n.name=n.name.replace(s,"("+g+")");}else n.name+="(0)";a=!0,t=!0;}o.license&&o.license.licenseTxt&&n.license&&n.license.licenseTxt&&o.license.type==n.license.type&&o.license.id==n.license.id&&o.license.version==n.license.version&&(n.license=null,a=!0,t=!0);}}while(t);a?(n._changed=!0,i(null,n)):i(null,n);},_loadNode:function _loadNode(e,n,i){n.parent=e,e.children.push(n),i(null,n);},_postLoadNode:function _postLoadNode(e,n,i){n._changed?m.aio.configmanager.TenantPersistHandler.save(e,n,function(e){delete n._changed,i(e,n);}):i(null,n);}},m.aio.configmanager.Tenant=function(e){m.aio.configmanager.Node.call(this,e),this.parent=e,this.index=-1,this.folder=null,this.name=null,this.license=null,this["default"]=!1,this.remotes=new m.aio.configmanager.Remotes(this);},m.aio.configmanager.Tenant.prototype=Object.create(m.aio.configmanager.Node.prototype),m.aio.configmanager.Tenant.prototype.constructor=m.aio.configmanager.Tenant,m.aio.configmanager.Tenant.SETTING="settings",m.aio.configmanager.Tenant.REMOTES="remotes",m.aio.configmanager.Tenant.prototype.getFolder=function(){return this.folder||(this.folder=Math.round(new Date().getTime()/1e3).toString()),this.folder;},m.aio.configmanager.Tenant.prototype.getFolderPath=function(){var e=this.parent?this.parent.getFolderPath():null,n=this.getFolder(),i=require("path");return e&&n?e+i.sep+n:null;},m.aio.configmanager.Tenant.prototype.getDeviceFile=function(){var e=this.getFolderPath();return e?e+require("path").sep+"device_db":e;},m.aio.configmanager.Tenant.prototype.getMacrosFile=function(){var e=this.getFolderPath();return e?e+require("path").sep+"macros_db":e;},m.aio.configmanager.Tenant.prototype.getDeviceinfoFile=function(){var e=this.getFolderPath();return e?e+require("path").sep+"deviceinfo.xml":e;},m.aio.configmanager.Tenant.prototype.getRemotes=function(){return this.remotes;},m.aio.configmanager.Tenant.prototype.isAccessible=function(){return!(!this.license||!this.license.valid||this.license.isTestLicense()&&this.license.isExpired());},m.aio.configmanager.Tenant.prototype.isDefault=function(){return this["default"];},m.aio.configmanager.Tenant.prototype.reloadRemotes=function(e){var n=require("path"),i=this.getFolderPath(),a=this;m.aio.configmanager.RemotesPersistHandler.load(this,i+n.sep+m.aio.configmanager.Tenant.REMOTES,function(n,i){n?e&&e(n):(a.remotes.parent=null,i.parent=a,a.remotes=i,e&&e(null));});},m.aio.configmanager.TenantHandler={execute:function execute(e,n,i,a){var t=e.parent;switch(n){case"read":a(null,m.aio.configmanager.TenantJSONHandler.toJSON(e));break;case"delete":if(!t)return void a(new Error("tenant is isolated"));m.aio.configmanager.TenantPersistHandler.remove(t,e,function(n){if(n)a(n);else{var i=require("m.aio.devicemanager.js"),r=require("m.aio.macromanager.js");i.removeTenant(e,function(){r.removeTenant(e,function(){t.removeChild(e),a(null,{success:!0});});});}});break;case"update":if(!t)return void a(new Error("tenant is isolated"));var r,o,s=m.aio.configmanager.TenantJSONHandler.fromJSON(i);if(!s)return void a(new Error("data format invalid"));var g=null,c=!1;if(s.name&&e.name!=s.name){for(r=0;r<t.children.length;r++)if((o=t.children[r]).name==s.name)return void a(new Error("tenant name is already existed"));c=!0,g=e.name,e.name=s.name;}var f=!1,l=null;if(s["default"]){for(f=!0,r=0;r<t.children.length;r++)if((o=t.children[r])["default"]){o["default"]=!1,l=o;break;}e["default"]=s["default"];}var d=null,u=!1;if(s.license&&s.license.licenseTxt&&(!e.license||e.license.licenseTxt!=s.license.licenseTxt)){if(!s.license.valid)return void a(new Error("license invalid"));for(r=0;r<t.children.length;r++)if((o=t.children[r]).index!=s.index&&o.license&&o.license.type==s.license.type&&o.license.id==s.license.id&&o.license.version==s.license.version)return void a(new Error("tenant license is already existed"));u=!0,d=e.license,e.license=s.license;}c||u||f?m.aio.configmanager.TenantPersistHandler.save(t,e,function(n){if(n)c&&(e.id=g),u&&(e.license=d),f&&(e["default"]=!1,l&&(l["default"]=!0)),a(n);else{if(u&&e.license&&!e.license.isTestLicense()&&require("m.aio.infomanager.js").retrieveInfo(),u&&e.license&&e.license.isTestLicense())if(d&&d.id==e.license.id){var i=d.getStartDate();e.license.saveStartDateWithDate(i);}else e.license.saveStartDate();f&&l?m.aio.configmanager.TenantPersistHandler.save(t,l,function(n){a(n,m.aio.configmanager.TenantJSONHandler.toJSON(e));}):a(null,m.aio.configmanager.TenantJSONHandler.toJSON(e));}}):a(null,m.aio.configmanager.TenantJSONHandler.toJSON(e));break;default:a(new Error("no such method"));}}},m.aio.configmanager.TenantJSONHandler={fromJSON:function fromJSON(e){if(!e||!e.classid||"tenant"!==e.classid)return null;var n=new m.aio.configmanager.Tenant();return n.index=e.index?e.index:-1,n.name=e.name,n["default"]=!!e["default"],n.license=null,e.license&&(n.license=m.aio.configmanager.LicenseJSONHandler.fromJSON(e.license),n.license&&(n.license.parent=n)),n;},toJSON:function toJSON(e){return{classid:"tenant",index:e.index,name:e.name,"default":e["default"],folder:e.getFolderPath(),license:e.license?m.aio.configmanager.LicenseJSONHandler.toJSON(e.license):null,remotes:e.remotes?m.aio.configmanager.RemotesJSONHandler.toJSON(e.remotes):null};}},m.aio.configmanager.TenantPersistHandler={save:function save(e,n,i){var a=e.getFolderPath(),t=n.getFolder();if(a){if(t){var r=require("path");t=a+r.sep+t;var o=require("async"),s=require("fs");o.series([function(e){s.exists(t,function(n){n?s.stat(t,function(n,i){n?e(n):i.isDirectory()?e():e(new Error(t+" is not a folder"));}):require("fs-extra").mkdirs(t,function(n){e(n);});});},function(e){var i={index:n.index,name:n.name,"default":!!n["default"],license:n.license?n.license.licenseTxt:null};s.writeFile(t+r.sep+m.aio.configmanager.Tenant.SETTING,JSON.stringify(i),function(n){e(n);});}],function(e){i(e);});}else i(new Error("tenant folder is null"));}else i(new Error("parent folder path is null"));},load:function load(e,n,i){var a=new m.aio.configmanager.Tenant();a.parent=e;var t=require("path");this._loadSettings(n+t.sep+m.aio.configmanager.Tenant.SETTING,function(e,r){if(e)i(e);else if(r){a.index=r.index?r.index:-1;var o=n.lastIndexOf(t.sep);a.folder=n.substr(o+1),a.name=r.name,a.license=r.license,a["default"]=!!r["default"],a&&a.license&&(a.license.parent=a,a.license.isTestLicense()&&!a.license.getStartDate()&&a.license.saveStartDate()),m.aio.configmanager.RemotesPersistHandler.load(a,n+t.sep+m.aio.configmanager.Tenant.REMOTES,function(e,n){e?i(e):(n.parent=a,a.remotes=n,i(null,a));});}else i(null,null);});},_loadSettings:function _loadSettings(e,n){var i=require("fs");i.exists(e,function(a){a?i.readFile(e,function(e,i){if(e)n(e);else{var a={};if(i.length>0)try{a=JSON.parse(i.toString());}catch(e){return void n(null,a);}a.license?(a.license=m.aio.configmanager.LicenseManager.resolve(a.license),n(null,a)):n(null,a);}}):n(null,null);});},remove:function remove(e,n,i){var a=e.getFolderPath(),t=n.getFolder();a?t?(t=a+require("path").sep+t,require("fs-extra").remove(t,function(e){i(e);})):i(new Error("tenant folder is null")):i(new Error("parent folder path is null"));}},m.aio.configmanager.Remotes=function(e){m.aio.configmanager.ListNode.call(this,e),this.parent=e,this.children=[];},m.aio.configmanager.Remotes.prototype=Object.create(m.aio.configmanager.ListNode.prototype),m.aio.configmanager.Remotes.prototype.constructor=m.aio.configmanager.Remotes,m.aio.configmanager.Remotes.FOLDER="remotes",m.aio.configmanager.Remotes.prototype.size=function(){return this.children?this.children.length:0;},m.aio.configmanager.Remotes.prototype.getChildren=function(){return this.children;},m.aio.configmanager.Remotes.prototype.getFolderPath=function(){if(!this.parent)return null;var e=this.parent.getFolderPath();return e?e+require("path").sep+m.aio.configmanager.Remotes.FOLDER:null;},m.aio.configmanager.Remotes.prototype.getChild=function(e){for(var n=0;n<this.children.length;n++){var i=this.children[n];if(i.index==e)return i;}return null;},m.aio.configmanager.Remotes.prototype.removeChild=function(e){for(var n=-1,i=0;i<this.children.length;i++)if(this.children[i].index==e.index){n=i;break;}n>=0&&this.children.splice(n,1),e.parent=null;},m.aio.configmanager.Remotes.prototype.sort=function(){var e=this.children.length-1,n=!1;do{n=!1;for(var i=0;i<e;++i)if(this.children[i].index>this.children[i+1].index){var a=this.children[i];this.children[i]=this.children[i+1],this.children[i+1]=a,n=!0;}}while(n);},m.aio.configmanager.RemotesHandler={execute:function execute(e,n,i,a){switch(n){case"read":a(null,m.aio.configmanager.RemotesJSONHandler.toJSON(e));break;case"create":var t=m.aio.configmanager.RemoteJSONHandler.fromJSON(i);t?this._add(e,t,function(e,n){e?a(e):a(null,m.aio.configmanager.RemoteJSONHandler.toJSON(n));}):a(new Error("json format invalid"));break;default:a(new Error("no such method"));}},_getFreeIndex:function _getFreeIndex(e){e.sort();for(var n=1,i=0;i<e.children.length;i++)e.children[i].index==n&&n++;return n;},_add:function _add(e,n,i){var a=this;require("async").waterfall([function(i){a._preAddNode(e,n,i);},function(i,t){a._addNode(e,n,t);},function(i,t){a._postAddNode(e,n,t);}],function(e,n){i(e,n);});},_preAddNode:function _preAddNode(e,n,i){var a=1;if(n.id){if(n.id.match(m.aio.configmanager.Util.FILENAME_REGEX))i(new Error("remote id has invalid character"));else{for(var t=0;t<e.children.length;t++){var r=e.children[t];if(r.index==n.index)return void i(new Error("remote with same index exists","configmanager.js"));if(r.id==n.id)return void i(new Error("remote with same id exists","configmanager.js"));r.index==a&&a++;}(!n.index||n.index<=0)&&(n.index=a),m.aio.configmanager.RemotePersistHandler.save(e,n,function(e){i(e,n);});}}else i(new Error("id is null"));},_addNode:function _addNode(e,n,i){n.parent=e,e.children.push(n),i(null,n);},_postAddNode:function _postAddNode(e,n,i){e.sort(),i(null,n);}},m.aio.configmanager.RemotesJSONHandler={toJSON:function toJSON(e){if(!e)return null;for(var n=[],i=0;i<e.children.length;i++){var a=m.aio.configmanager.RemoteJSONHandler.toJSON(e.children[i]);a&&n.push(a);}return n;}},m.aio.configmanager.RemotesPersistHandler={load:function load(e,n,i){var a=new m.aio.configmanager.Remotes();a.parent=e;var t=this,r=require("fs");r.exists(n,function(e){e?r.readdir(n,function(e,o){if(e)i(e);else{var s=require("async"),g=require("path");s.eachSeries(o,function(e,i){r.stat(n+g.sep+e,function(r,o){!r&&o.isDirectory()?m.aio.configmanager.RemotePersistHandler.load(a,n+g.sep+e,function(e,n){n?t._load(a,n,function(e,n){i(e,n);}):i();}):i();});},function(e){e?i(e):(a.sort(),i(null,a));});}}):i(null,a);});},_load:function _load(e,n,i){var a=this;require("async").waterfall([function(i){a._preLoadNode(e,n,i);},function(n,i){a._loadNode(e,n,i);},function(n,i){a._postLoadNode(e,n,i);}],function(e,n){i(e,n);});},_preLoadNode:function _preLoadNode(e,n,i){var a=!1;(!n.index||n.index<0)&&(n.index=1,a=!0);var t=!1;do{t=!1;for(var r=0;r<e.children.length;r++)e.children[r].index==n.index&&(n.index++,a=!0,t=!0);}while(t);a?(n._changed=!0,i(null,n)):i(null,n);},_loadNode:function _loadNode(e,n,i){n.parent=e,e.children.push(n),i(null,n);},_postLoadNode:function _postLoadNode(e,n,i){n._changed?m.aio.configmanager.RemotePersistHandler.save(e,n,function(e){delete n._changed,i(e,n);}):i(null,n);}},m.aio.configmanager.Remote=function(e){m.aio.configmanager.Node.call(this,e),this.parent=e,this.index=-1,this.id=null,this.skin=null,this.info={},this.pages=new m.aio.configmanager.Pages(this);},m.aio.configmanager.Remote.prototype=Object.create(m.aio.configmanager.Node.prototype),m.aio.configmanager.Remote.prototype.constructor=m.aio.configmanager.Remote,m.aio.configmanager.Remote.SETTING="settings",m.aio.configmanager.Remote.PAGES="controls",m.aio.configmanager.Remote.prototype.getFolder=function(){return this.id;},m.aio.configmanager.Remote.prototype.getFolderPath=function(){if(!this.parent)return null;var e=this.parent.getFolderPath();return e?e+require("path").sep+this.id:null;},m.aio.configmanager.Remote.prototype.getSettingsFile=function(){var e=this.getFolderPath();return e?e+require("path").sep+"settings":null;},m.aio.configmanager.Remote.prototype.getDeviceFile=function(){var e=this.getFolderPath();return e?e+require("path").sep+"device_db":null;},m.aio.configmanager.Remote.prototype.getMacrosFile=function(){var e=this.getFolderPath();return e?e+require("path").sep+"macros_db":null;},m.aio.configmanager.Remote.prototype.getDeviceinfoFile=function(){var e=this.getFolderPath();return e?e+require("path").sep+"deviceinfo.xml":e;},m.aio.configmanager.Remote.prototype.getResourcesFolderPath=function(){var e=this.getFolderPath();return e?e+require("path").sep+"resources":null;},m.aio.configmanager.Remote.prototype.getPagesFolderPath=function(){var e=this.getFolderPath();return e?e+require("path").sep+m.aio.configmanager.Remote.PAGES:null;},m.aio.configmanager.Remote.prototype.processResourceList=function(e,n){this.pages&&this.pages.children?require("async").each(this.pages.children,function(n,i){n.processResourceList(e,function(e){i(e);});},function(e){n&&n(e);}):n&&n(null);},m.aio.configmanager.RemoteHandler={execute:function execute(e,n,i,a){var t=e.parent;switch(n){case"read":a(null,m.aio.configmanager.RemoteJSONHandler.toJSON(e));break;case"delete":if(!t)return void a(new Error("remote is isolated"));m.aio.configmanager.RemotePersistHandler.remove(t,e,function(n){n?a(n):(t.removeChild(e),a(null,{success:!0}));});break;case"update":if(!t)return void a(new Error("remote is isolated"));var r=m.aio.configmanager.RemoteJSONHandler.fromJSON(i);if(!r)return void a(new Error("data format invalid"));if(!r.id)return void a(new Error("data format invalid: id is empty"));if(r.id.match(m.aio.configmanager.Util.FILENAME_REGEX))return void a(new Error("remote id has invalid character"));console.log("start update remote"),require("async").series([function(n){if(console.log("start check skin"),r.skin){if(e.skin&&r.skin.id==e.skin.id&&r.skin.inRemote==e.skin.id)n();else{var i=e.skin;e.skin=r.skin,m.aio.configmanager.RemotePersistHandler.save(t,e,function(a){a&&(e.skin=i),n(a);});}}else n();},function(n){if(r.info&&"object"==_typeof(r.info)){var i=e.info;e.info=r.info,m.aio.configmanager.RemotePersistHandler.save(t,e,function(a){a&&(e.info=i),n(a);});}else n();},function(n){if(console.log("start check remote name"),e.id!=r.id){for(var i=0;i<t.children.length;i++)if(t.children[i].id==r.id)return void n(new Error("remote id is already existed"));t.getFolderPath()?m.aio.configmanager.RemotePersistHandler.move(t,e,r.id,function(i){console.log("finish move remote folder:"+i),i?n(i):(e.id=r.id,n());}):n(new Error("remotes folder invalid"));}else n();}],function(n){a(n,m.aio.configmanager.RemoteJSONHandler.toJSON(e));});break;case"create":this.saveRemote(e,i,a);break;default:a(new Error("no such method"));}},saveRemote:function saveRemote(e,n,i){var a=e.parent;if(a){var t=m.aio.configmanager.RemoteJSONHandler.fromJSON(n);t?t.id?t.id.match(m.aio.configmanager.Util.FILENAME_REGEX)?i(new Error("remote id has invalid character")):require("async").waterfall([function(n){if(t.info&&"object"==_typeof(t.info)){var i=e.info;e.info=t.info,m.aio.configmanager.RemotePersistHandler.save(a,e,function(a){a&&(e.info=i),n(a);});}else n();},function(n){if(e.id!=t.id){for(var i=0;i<a.children.length;i++)if(a.children[i].id==t.id)return void n(new Error("remote id is already existed"));var r=require("path"),o=a.getFolderPath()+r.sep+t.id;m.aio.configmanager.RemotePersistHandler.copy(a,e,t.id,function(i){i?n(i):m.aio.configmanager.RemotePersistHandler.load(a,o,function(i,t){i?n(i):(t.index=e.index,e.index=m.aio.configmanager.RemotesHandler._getFreeIndex(e.parent),m.aio.configmanager.RemotePersistHandler._saveSettings(e,function(e){e?n(e):m.aio.configmanager.RemotesHandler._add(a,t,function(e,i){n(e,t);});}));});});}else n(null,e);}.bind(this),function(e,n){var i=require("m.aio.devicemanager.js");i.saveRemote(e,function(a){i.clearRemoteDB(e,function(){n(a,e);});});}.bind(this),function(e,n){require("m.aio.macromanager.js").saveRemote(e,function(i){n(i,e);});}.bind(this),function(e,n){require("m.aio.skinmanager.js").saveRemote(e,t,function(i,t){i?n(i):(e.skin=t.skin,m.aio.configmanager.RemotePersistHandler.save(a,e,function(i){n(i,m.aio.configmanager.RemoteJSONHandler.toJSON(e));}));});}.bind(this)],function(e,n){i&&i(e,n);}):i(new Error("data format invalid: id is empty")):i(new Error("data format invalid"));}else i(new Error("remote is isolated"));}},m.aio.configmanager.RemoteJSONHandler={fromJSON:function fromJSON(e){if(!e||!e.classid||"remote"!==e.classid)return null;var n=new m.aio.configmanager.Remote();return n.index=e.index?e.index:-1,n.id=e.id,n.skin=e.skin,e.info&&"object"==_typeof(e.info)&&(n.info=e.info),n;},toJSON:function toJSON(e){return{classid:"remote",index:e.index,id:e.id,info:e.info,skin:e.skin,folder:e.getFolderPath(),pages:e.pages?m.aio.configmanager.PagesJSONHandler.toJSON(e.pages):null};}},m.aio.configmanager.RemotePersistHandler={save:function save(e,n,i){var a=e.getFolderPath(),t=n.getFolder();if(a){if(t){var r=require("path");t=a+r.sep+t;var o=require("async"),s=require("fs");o.series([function(e){s.exists(t,function(n){n?s.stat(t,function(n,i){n?e(n):i.isDirectory()?e():e(new Error(t+" is not a folder"));}):require("fs-extra").mkdirs(t,function(n){e(n);});});},function(e){var i={index:n.index,info:n.info,skin:n.skin};s.writeFile(t+r.sep+m.aio.configmanager.Remote.SETTING,JSON.stringify(i),function(n){e(n);});}],function(e){i(e);});}else i(new Error("remote folder is null"));}else i(new Error("parent folder path is null"));},_saveSettings:function _saveSettings(e,n){var i=e.parent;if(i){var a=i.getFolderPath(),t=e.getFolder();if(a){if(t){var r=require("path");t=a+r.sep+t;var o=require("fs"),s={index:e.index,info:e.info,skin:e.skin};o.writeFile(t+r.sep+m.aio.configmanager.Remote.SETTING,JSON.stringify(s),function(e){n(e);});}else n(new Error("remote folder is null"));}else n(new Error("parent folder path is null"));}else n(new Error("remote is isolated"));},load:function load(e,n,i){var a=new m.aio.configmanager.Remote();a.parent=e;var t=require("path");this._loadSettings(n+t.sep+m.aio.configmanager.Remote.SETTING,function(e,r){if(e)i(e);else if(r){a.index=r.index?r.index:-1,a.skin=r.skin?r.skin:null,a.info=r.info?r.info:{};var o=n.lastIndexOf(t.sep);a.id=n.substr(o+1),m.aio.configmanager.PagesPersistHandler.load(a,n+t.sep+m.aio.configmanager.Remote.PAGES,function(e,n){e?i(e):(n.parent=a,a.pages=n,i(null,a));});}else i(null,null);});},_loadSettings:function _loadSettings(e,n){var i=require("fs");i.exists(e,function(a){a?i.readFile(e,function(e,i){if(e)n(e);else{var a={};if(i.length>0)try{a=JSON.parse(i.toString());}catch(e){return void n(null,a);}n(null,a);}}):n(null,null);});},remove:function remove(e,n,i){var a=function a(e){for(var n=require("fs"),i=require("path"),t=n.readdirSync(e),r=0;r<t.length;r++){var o=i.join(e,t[r]);console.log("try to delete:"+o);var s=n.statSync(o);"."==o||".."==o||(s.isDirectory()?(console.log(o+" is folder"),a(o)):(n.unlinkSync(o),console.log(o+" deleted ("+r+"/"+t.length+")")));}console.log("try to delete folder:"+e),n.rmdirSync(e),console.log("folder:"+e+" deleted");},t=e.getFolderPath(),r=n.getFolder();if(t){if(r){r=t+require("path").sep+r;try{a(r),i();}catch(e){console.error(e),i(e);}}else i(new Error("remote folder is null"));}else i(new Error("parent folder path is null"));},move:function move(e,n,i,a){var t=e.getFolderPath(),r=n.getFolder();if(t){if(r){var o=require("path"),s=t+o.sep+r,g=t+o.sep+i,c=require("fs");console.log("start to move remote folder"),c.rename(s,g,function(e){a(e);});}else a(new Error("remote folder is null"));}else a(new Error("parent folder path is null"));},copy:function copy(e,n,i,a){var t=require("path"),r=n.getFolderPath();if(r){var o=e.getFolderPath()+t.sep+i;require("fs-extra").copy(r,o,function(e){a&&a(e);});}else a&&a(new Error("remote folder invalid"));}},m.aio.configmanager.Pages=function(e){m.aio.configmanager.ListNode.call(this,e),this.parent=e,this.children=[];},m.aio.configmanager.Pages.prototype=Object.create(m.aio.configmanager.ListNode.prototype),m.aio.configmanager.Pages.prototype.constructor=m.aio.configmanager.Pages,m.aio.configmanager.Pages.prototype.getFolderPath=function(){if(!this.parent)return null;var e=this.parent.getFolderPath();return e?e+require("path").sep+m.aio.configmanager.Remote.PAGES:null;},m.aio.configmanager.Pages.prototype.getChild=function(e){for(var n=0;n<this.children.length;n++){var i=this.children[n];if(i.index==e)return i;}return null;},m.aio.configmanager.Pages.prototype.removeChild=function(e){for(var n=-1,i=0;i<this.children.length;i++)if(this.children[i].index==e.index){n=i;break;}n>=0&&this.children.splice(n,1),e.parent=null;},m.aio.configmanager.Pages.prototype.sort=function(){var e=this.children.length-1,n=!1;do{n=!1;for(var i=0;i<e;++i)if(this.children[i].index>this.children[i+1].index){var a=this.children[i];this.children[i]=this.children[i+1],this.children[i+1]=a,n=!0;}}while(n);},m.aio.configmanager.PagesHandler={execute:function execute(e,n,i,a){switch(n){case"read":a(null,m.aio.configmanager.PagesJSONHandler.toJSON(e));break;case"create":var t=m.aio.configmanager.PageJSONHandler.fromJSON(i);t?this._add(e,t,function(e,n){e?a(e):a(null,m.aio.configmanager.PageJSONHandler.toJSON(n));}):a(new Error("json format invalid"));break;default:a(new Error("no such method"));}},_add:function _add(e,n,i){var a=this;require("async").waterfall([function(i){a._preAddNode(e,n,i);},function(i,t){a._addNode(e,n,t);},function(i,t){a._postAddNode(e,n,t);}],function(e,n){i(e,n);});},_preAddNode:function _preAddNode(e,n,i){var a=1;if(n.id){if(n.id.match(m.aio.configmanager.Util.FILENAME_REGEX))i(new Error("page id has invalid character"));else{for(var t=0;t<e.children.length;t++){var r=e.children[t];if(r.index==n.index)return void i(new Error("page with same index exists","configmanager.js"));if(r.id==n.id)return void i(new Error("page with same name exists","configmanager.js"));r.index==a&&a++;}(!n.index||n.index<=0)&&(n.index=a),m.aio.configmanager.PagePersistHandler.save(e,n,function(e){i(e,n);});}}else i(new Error("name is null"));},_addNode:function _addNode(e,n,i){n.parent=e,e.children.push(n),i(null,n);},_postAddNode:function _postAddNode(e,n,i){e.sort(),i(null,n);}},m.aio.configmanager.PagesJSONHandler={toJSON:function toJSON(e){if(!e)return null;for(var n=[],i=0;i<e.children.length;i++){var a=m.aio.configmanager.PageJSONHandler.toJSON(e.children[i]);a&&n.push(a);}return n;}},m.aio.configmanager.PagesPersistHandler={load:function load(e,n,i){var a=m.aio.configmanager.Page.FILE_EXT,t=new m.aio.configmanager.Pages();t.parent=e;var r=this,o=require("fs");o.exists(n,function(e){e?o.readdir(n,function(e,s){if(e)i(e);else{var g=require("async"),c=require("path");g.eachLimit(s,10,function(e,i){var s=c.extname(e);if(s===a.PAGE||s===a.POPUP){var g=n+c.sep+e;o.stat(g,function(e,n){!e&&n.isFile()?m.aio.configmanager.PagePersistHandler.load(t,g,function(e,n){n?r._load(t,n,function(e,n){i(e,n);}):i();}):i(e);});}else i();},function(e){t.sort(),e?i(e):i(null,t);});}}):i(null,t);});},_load:function _load(e,n,i){var a=this;require("async").waterfall([function(i){a._preLoadNode(e,n,i);},function(n,i){a._loadNode(e,n,i);},function(i,t){a._postLoadNode(e,n,t);}],function(e,n){i(e,n);});},_preLoadNode:function _preLoadNode(e,n,i){var a=!1;(!n.index||n.index<0)&&(n.index=1,a=!0);var t=!1;do{t=!1;for(var r=0;r<e.children.length;r++)e.children[r].index==n.index&&(n.index++,a=!0,t=!0);}while(t);a&&(n._changed=!0),i(null,n);},_loadNode:function _loadNode(e,n,i){n.parent=e,e.children.push(n),i(null,n);},_postLoadNode:function _postLoadNode(e,n,i){n._changed?m.aio.configmanager.PagePersistHandler.save(e,n,function(e){delete n._changed,i(e,n);}):i(null,n);}},m.aio.configmanager.Page=function(e){m.aio.configmanager.Node.call(this,e),this.parent=e,this.index=-1,this.id=null,this.isPopup=!1;},m.aio.configmanager.Page.prototype=Object.create(m.aio.configmanager.Node.prototype),m.aio.configmanager.Page.prototype.constructor=m.aio.configmanager.Page,m.aio.configmanager.Page.FILE_EXT={PAGE:".p",POPUP:".popup"},m.aio.configmanager.Page.prototype.getChild=function(e){if(!e||"string"!=typeof e)return null;if("pagecontent"==e){var n=m.aio.configmanager.PageContentPersistHandler.loadSync(this.getFolderPath());return n.parent=this,n;}return this[e];},m.aio.configmanager.Page.prototype.getFile=function(e){return this.id&&!0===e?this.id+this.getFileExt():this.id;},m.aio.configmanager.Page.prototype.getFileExt=function(){return this.isPopup?m.aio.configmanager.Page.FILE_EXT.POPUP:m.aio.configmanager.Page.FILE_EXT.PAGE;},m.aio.configmanager.Page.prototype.getFolderPath=function(){if(!this.parent)return null;var e=this.parent.getFolderPath();return e?e+require("path").sep+this.getFile(!0):null;},m.aio.configmanager.Page.prototype.processResourceList=function(e,n){var i=this;m.aio.configmanager.PageContentPersistHandler.load(this.getFolderPath(),function(a,t){a?n&&n(a):t.processResourceList(i,e,function(e){n&&n(e);});});},m.aio.configmanager.PageHandler={execute:function execute(e,n,i,a){var t=e.parent;switch(n){case"read":a(null,m.aio.configmanager.PageJSONHandler.toJSON(e));break;case"delete":if(!t)return void a(new Error("page is isolated"));m.aio.configmanager.PagePersistHandler.remove(t,e,function(n){n?a(n):(t.removeChild(e),a(null,{success:!0}));});break;case"update":if(!t)return void a(new Error("page is isolated"));var r=m.aio.configmanager.PageJSONHandler.fromJSON(i);if(!r)return void a(new Error("data format invalid"));if(!r.id)return void a(new Error("data format invalid:id is empty"));if(r.id.match(m.aio.configmanager.Util.FILENAME_REGEX))return void a(new Error("page id has invalid character"));if(e.id==r.id)return void a(null,m.aio.configmanager.PageJSONHandler.toJSON(e));for(var o=0;o<t.children.length;o++)if(t.children[o].id==r.id)return void a(new Error("page id is already existed"));m.aio.configmanager.PagePersistHandler.move(t,e,r.id,function(n){n?a(n):(e.id=r.id,a(null,m.aio.configmanager.PageJSONHandler.toJSON(e)));});break;default:a(new Error("no such method"));}}},m.aio.configmanager.PageJSONHandler={fromJSON:function fromJSON(e){if(!e||!e.classid||"page"!==e.classid)return null;var n=new m.aio.configmanager.Page();return n.index=e.index?e.index:-1,n.id=e.id,n.isPopup=!!e.isPopup,n;},toJSON:function toJSON(e){return{classid:"page",index:e.index,id:e.id,isPopup:!!e.isPopup};}},m.aio.configmanager.PagePersistHandler={save:function save(e,n,i){var a=e.getFolderPath(),t=n.getFile(!0);a?t?(t=a+require("path").sep+t,m.aio.configmanager.PageContentPersistHandler.load(t,function(a,t){a?i(a):(t.content||(t.content={}),t.content.index=n.index,m.aio.configmanager.PageContentPersistHandler.save(e,n,t,function(e){i(e,n);}));})):i(new Error("page file is null")):i(new Error("parent folder path is null"));},load:function load(e,n,i){var a=this,t=m.aio.configmanager.Page.FILE_EXT,r=new m.aio.configmanager.Page();r.parent=e;var o=require("fs");o.exists(n,function(e){e?o.readFile(n,function(e,o){if(e)i(e);else{var s=require("path"),g=n.lastIndexOf(s.sep),c=n.substr(g+1),f=!1;if((g=c.indexOf(t.PAGE))>=0&&g===c.length-t.PAGE.length&&(f=!0,r.id=c.replace(t.PAGE,"")),(g=c.indexOf(t.POPUP))>=0&&g===c.length-t.POPUP.length&&(f=!0,r.id=c.replace(t.POPUP,""),r.isPopup=!0),!f)return void i(null,null);if(o.length>0)try{var l=JSON.parse(o.toString());r.index=l.index;}catch(e){return void a.saveDamageFile(n,o,function(){i(null,r);});}i(null,r);}}):i(null,null);});},saveDamageFile:function saveDamageFile(e,n,i){require("fs").writeFile(e+".bk",n,i);},remove:function remove(e,n,i){var a=e.getFolderPath(),t=n.getFile(!0);a?t?(t=a+require("path").sep+t,require("fs-extra").remove(t,function(e){i(e);})):i(new Error("page file is null")):i(new Error("parent folder path is null"));},move:function move(e,n,i,a){var t=e.getFolderPath(),r=n.getFile();if(t){if(r){var o=require("path"),s=n.getFileExt(),g=t+o.sep+r+s,c=t+o.sep+i+s;require("fs-extra").move(g,c,function(e){a(e);});}else a(new Error("page file is null"));}else a(new Error("parent folder path is null"));}},m.aio.configmanager.PageContent=function(e){m.aio.configmanager.Node.call(this,e),this.content=null;},m.aio.configmanager.PageContent.prototype=Object.create(m.aio.configmanager.Node.prototype),m.aio.configmanager.PageContent.prototype.constructor=m.aio.configmanager.PageContent,m.aio.configmanager.PageContent.prototype.processResourceList=function(e,n,i){var a=function a(e,n,i){return n?e.processResourceSync(n,i):null;},t=function t(e,n){n&&e.processWidgetSync(n);},r=function r(e,n){if(n&&n.states&&"object"==_typeof(n.states)){var i="string"==typeof n.path?n.path.length:0;for(var t in n.states){var r=n.states[t];if(r&&"object"==_typeof(r)&&"string"==typeof r.i){var o=0!==r.p&&"string"==typeof n.path,s=o?n.path+"/"+r.i:r.i;if(c=a(e,s,r.s),f=f||!!c,c){var g=o?i+1:0;0===g&&"/"==c[0]&&g++,n.states[t].i=c.substr(g);}}}}},o=function o(e,n){if(n&&n.info&&"object"==_typeof(n.info)){var i="string"==typeof n.info.path?n.info.path+"/":"";for(var t in n.info){var r=n.info[t];"path"!=t&&r&&"string"==typeof r&&(c=a(e,i+r,n.img_skin),f=f||!!c,c&&(n.info[t]=c.substr(i.length>0?i.length:1)));}}},s=function s(e,n){return!!n&&e!==n;};try{var g,c,f=!1;if(this.content&&(this.content.widget&&this.content.widget.bgimg&&(c=a(n,this.content.widget.bgimg,this.content.widget.bgimg_skin),f=f||!!c,c&&(this.content.widget.bgimg=c)),this.content.infos&&this.content.infos.forEach(function(i){if(i.widget){if(c=a(n,i.widget.img,i.widget.img_skin),f=f||s(i.widget.img,c),c&&(i.widget.img=c),c=a(n,i.widget.bgimg,i.widget.bgimg_skin),f=f||s(i.widget.bgimg,c),c&&(i.widget.bgimg=c),i.widget.path&&i.widget.images)for(g=0;g<i.widget.images.length;g++){var t=i.widget.images[g];if(t){var l=t.indexOf("/")>=0?"":i.widget.path+"/";c=a(n,l+t,i.widget.img_skin),f=f||s(l+t,c),c&&(i.widget.images[g]=c.substr(l.length));}}if(i.widget._default&&"string"==typeof i.widget._default&&n.processDefaultImageSync(i.widget),r(n,i.widget),o(n,i.widget),"string"==typeof i.widget.stateRuleRef&&e&&e.parent){var m=e.parent.parent,d=m&&m.info&&m.info.stateRules;if(d&&d[i.widget.stateRuleRef]){var u=d[i.widget.stateRuleRef];r(n,u);}}}}),this.content.buttons&&this.content.buttons.forEach(function(i){if(i.widget){if(c=a(n,i.widget.img,i.widget.img_skin),f=f||s(i.widget.img,c),c&&(i.widget.img=c),c=a(n,i.widget.bgimg,i.widget.bgimg_skin),f=f||s(i.widget.bgimg,c),c&&(i.widget.bgimg=c),i.widget.path&&i.widget.images)for(g=0;g<i.widget.images.length;g++){var t=i.widget.images[g];if(t){var l=t.indexOf("/")>=0?"":i.widget.path+"/";c=a(n,l+t,i.widget.img_skin),f=f||s(l+t,c),c&&(i.widget.images[g]=c.substr(l.length));}}if(i.widget._default&&"string"==typeof i.widget._default&&n.processDefaultImageSync(i.widget),r(n,i.widget),o(n,i.widget),"string"==typeof i.widget.stateRuleRef&&e&&e.parent){var m=e.parent.parent,d=m&&m.info&&m.info.stateRules;if(d&&d[i.widget.stateRuleRef]){var u=d[i.widget.stateRuleRef];r(n,u);}}}}),this.content.selects&&this.content.selects.forEach(function(e){e.widget&&(c=a(n,e.widget.img_n,e.widget.img_skin_n),f=f||s(e.widget.img_n,c),c&&(e.widget.img_n=c),c=a(n,e.widget.img_y,e.widget.img_skin_y),f=f||s(e.widget.img_y,c),c&&(e.widget.img_y=c),c=a(n,e.widget.bgimg,e.widget.bgimg_skin),f=f||s(e.widget.bgimg,c),c&&(e.widget.bgimg=c));}),this.content.selectdevices&&this.content.selectdevices.forEach(function(e){e.widget&&(c=a(n,e.widget.img_n,e.widget.img_skin_n),f=f||s(e.widget.img_n,c),c&&(e.widget.img_n=c),c=a(n,e.widget.img_y,e.widget.img_skin_y),f=f||s(e.widget.img_y,c),c&&(e.widget.img_y=c),c=a(n,e.widget.bgimg,e.widget.bgimg_skin),f=f||s(e.widget.bgimg,c),c&&(e.widget.bgimg=c));}),this.content.sliders&&this.content.sliders.forEach(function(e){e.widget&&t(n,e.widget);}),this.content.roundsliders&&this.content.roundsliders.forEach(function(e){e.widget&&t(n,e.widget);}),this.content.colorchoosers&&this.content.colorchoosers.forEach(function(e){e.widget&&t(n,e.widget);}),this.content.analogmeters&&this.content.analogmeters.forEach(function(e){e.widget&&t(n,e.widget);}),this.content.amps&&this.content.amps.forEach(function(e){e.widget&&t(n,e.widget);})),!f)return void(i&&i(null));m.aio.configmanager.PageContentPersistHandler.save(e.parent,e,this,function(e){i&&i(e);});}catch(e){i&&i(e);}},m.aio.configmanager.PageContentHandler={execute:function execute(e,n,i,a){switch(n){case"read":a(null,m.aio.configmanager.PageContentJSONHandler.toJSON(e));break;case"update":var t=m.aio.configmanager.PageContentJSONHandler.fromJSON(i);if(!t)return void a(new Error("data format invalid"));var r=e.parent;if(!r)return void a(new Error("page content is isolated"));var o=r.parent;if(!o)return void a(new Error("page content is isolated"));m.aio.configmanager.PageContentPersistHandler.save(o,r,t,function(n){a(n,m.aio.configmanager.PageContentJSONHandler.toJSON(e));});break;default:a(new Error("no such method"));}}},m.aio.configmanager.PageContentJSONHandler={fromJSON:function fromJSON(e){if(!e||!e.classid||"control"!==e.classid)return null;var n=new m.aio.configmanager.PageContent();return n.content=e,n;},toJSON:function toJSON(e){return e.content;}},m.aio.configmanager.PageContentPersistHandler={save:function save(e,n,i,a){var t=e.getFolderPath(),r=n.getFile(!0);if(t){if(r){if(i){if(i.content&&"object"==_typeof(i.content)){var o=require("fs-extra"),s=require("path"),g=require("unorm"),c=i.content;c.index=n.index,c.classid&&"control"===c.classid||(c.classid="control");var f=null;try{f=g.nfc(JSON.stringify(c));}catch(e){return void a(e);}if(f){var l="[m.aio.configmanager.PageContentPersistHandler.save]",m=null;r=t+s.sep+r;try{o.existsSync(r)&&(m=r+"-"+Date.now()+".old",o.copySync(r,m));}catch(e){return XC.debugf(l+" Could either not check file or copy it."+e.message,"error"),void a(e);}var d=function d(){if(m)try{XC.debugf(l+' Trying to restore backup "'+m+'" ...'),o.moveSync(m,r,{overwrite:!0}),XC.debugf(l+" Restored file as "+r),m=null;}catch(e){XC.debugf(l+" Failed to restore backup: "+e.message,"error");}};o.ensureFile(r,function(e){if(e)return d(),void a(e);o.writeFile(r,f,function(e){if(e)d();else if(m)try{o.unlinkSync(m);}catch(e){XC.debugf(l+" Failed to delete backup file: "+e.message,"error");}a(e);});});}else a(new Error("Stringified and normalized data is empty."));}else a(new Error("missing page content"));}else a(new Error("content is null"));}else a(new Error("page file is null"));}else a(new Error("parent folder path is null"));},load:function load(e,n){var i=new m.aio.configmanager.PageContent(),a=require("fs");a.exists(e,function(t){t?a.readFile(e,function(e,a){if(e)n(e);else{if(a.length>0)try{i.content=JSON.parse(a.toString());}catch(e){return void n(e,i);}n(null,i);}}):n(null,i);});},loadSync:function loadSync(e){var n=new m.aio.configmanager.PageContent(),i=require("fs");try{var a=i.readFileSync(e);a.length>0?n.content=JSON.parse(a.toString()):XC.debugf("[m.aio.configmanager.PageContentPersistHandler.loadSync] Page content is empty of file: "+e,"warn");}catch(e){XC.debugf("[m.aio.configmanager.PageContentPersistHandler.loadSync] "+e.message,"error");}return n;}},m.aio.configmanager.Util={FILENAME_REGEX:/[\\/:"*?<>|]+/g},m.aio.configmanager.ConfigManager=function(){m.aio.configmanager.Node.call(this,null),this.config=null,this.filemanager=null;},m.aio.configmanager.ConfigManager.USER_CONFIG="",m.aio.configmanager.ConfigManager.prototype=Object.create(m.aio.configmanager.Node.prototype),m.aio.configmanager.ConfigManager.prototype.constructor=m.aio.configmanager.ConfigManager,m.aio.configmanager.ConfigManager.prototype.init=function(e,n){var i=require("path"),a=require("fs");this.filemanager=e,m.aio.configmanager.ConfigManager.USER_CONFIG=e.getUserRootDataPath()+i.sep+"tenants";var t=this;require("async").series([function(e){var n=m.aio.configmanager.ConfigManager.USER_CONFIG;a.exists(n,function(i){i?a.stat(n,function(i,t){i?e(i):t.isDirectory()?e():a.unlink(n,function(i){i?e(i):a.mkdir(n,function(n){e(n);});});}):a.mkdir(n,function(n){e(n);});});},function(e){m.aio.configmanager.ConfigPersistHandler.load(m.aio.configmanager.ConfigManager.USER_CONFIG,function(n,i){n?e(n):(t.config=i,e());});},function(e){if(t.config&&t.config.tenants&&0!=t.config.tenants.size())e();else{t.config.tenants||(t.config.tenants=new m.aio.configmanager.Tenants(),t.config.tenants.parent=t.config);var n=new m.aio.configmanager.Tenant();n.index=1,n.name="default",n.parent=t.config.tenants,t.config.tenants.children.push(n),m.aio.configmanager.TenantPersistHandler.save(t.config.tenants,n,function(n){e(n);});}},function(e){if(t.config&&t.config.tenants&&t.config.tenants.size()>0){for(var n,i=!1,a=0;a<t.config.tenants.size();a++)if((n=t.config.tenants.get(a))["default"]){i=!0;break;}i?e():((n=t.config.tenants.get(0))["default"]=!0,m.aio.configmanager.TenantPersistHandler.save(t.config.tenants,n,function(n){e(n);}));}else e();}],function(e){n&&n(e);});},m.aio.configmanager.ConfigManager.prototype.execute=function(e,n,i,a){var t=m.aio.configmanager.Path.resolve(n);if(t){var r=m.aio.configmanager.Path.trace(this,t);if(r){var o=this._getCRUDHandler(r);o?m.aio.configmanager.LicenseManager.permit(e,r)?o.execute(r,e,i,function(e,n){e?a(e):a(null,n);}):a(new Error("not permitted")):a(new Error("no handler"));}else a(new Error("no such route"));}else a(new Error("invalid route format"));},m.aio.configmanager.ConfigManager.prototype.trace=function(e,n){var i=m.aio.configmanager.Path.resolve(e);if(i){var a=m.aio.configmanager.Path.trace(this,i);a?n&&n(null,a):n&&n(new Error("no such route"));}else n&&n(new Error("invalid route format"));},m.aio.configmanager.ConfigManager.prototype.getChild=function(e){return"config"===e.toLowerCase()?this.config:null;},m.aio.configmanager.ConfigManager.prototype._getCRUDHandler=function(e){return e instanceof m.aio.configmanager.Config?m.aio.configmanager.ConfigHandler:e instanceof m.aio.configmanager.License?m.aio.configmanager.LicenseHandler:e instanceof m.aio.configmanager.Tenants?m.aio.configmanager.TenantsHandler:e instanceof m.aio.configmanager.Tenant?m.aio.configmanager.TenantHandler:e instanceof m.aio.configmanager.Remotes?m.aio.configmanager.RemotesHandler:e instanceof m.aio.configmanager.Remote?m.aio.configmanager.RemoteHandler:e instanceof m.aio.configmanager.Pages?m.aio.configmanager.PagesHandler:e instanceof m.aio.configmanager.Page?m.aio.configmanager.PageHandler:e instanceof m.aio.configmanager.PageContent?m.aio.configmanager.PageContentHandler:null;},m.aio.configmanager.ConfigManager.prototype.updateBlockedLicenses=function(e,n){if(this.config&&this.config.tenants&&this.config.tenants.children)for(var i=0;i<this.config.tenants.children.length;i++){var a=this.config.tenants.children[i];if(a.license)for(var t=0;t<e.length;t++)if(a.license.id==e[t].id&&a.license.version==e[t].version&&a.license.type==(e[t].type?m.aio.configmanager.License.TYPE.TEST:m.aio.configmanager.License.TYPE.NORMAL)){a.license.valid=!1;break;}}n&&n();},m.aio.configmanager.ConfigManager.prototype.getAllLicenses=function(){if(!this.config||!this.config.tenants)return null;var e=this.config.tenants.getChildren();if(!e||0==e.length)return[];for(var n=[],i=0;i<e.length;i++){var a=e[i];a&&a.license&&n.push(a.license);}return n;},m.aio.configmanager.CM=new m.aio.configmanager.ConfigManager(),m.aio.configmanager.CM.License=m.aio.configmanager.License,m.aio.configmanager.CM.LicenseManager=m.aio.configmanager.LicenseManager,m.aio.configmanager.CM.Config=m.aio.configmanager.Config,m.aio.configmanager.CM.ConfigPersistHandler=m.aio.configmanager.ConfigPersistHandler,m.aio.configmanager.CM.ConfigJSONHandler=m.aio.configmanager.ConfigJSONHandler,m.aio.configmanager.CM.Tenants=m.aio.configmanager.Tenants,m.aio.configmanager.CM.TenantsPersistHandler=m.aio.configmanager.TenantsPersistHandler,m.aio.configmanager.CM.TenantsHandler=m.aio.configmanager.TenantsHandler,m.aio.configmanager.CM.Tenant=m.aio.configmanager.Tenant,m.aio.configmanager.CM.TenantPersistHandler=m.aio.configmanager.TenantPersistHandler,m.aio.configmanager.CM.TenantHandler=m.aio.configmanager.TenantHandler,m.aio.configmanager.CM.Remotes=m.aio.configmanager.Remotes,m.aio.configmanager.CM.RemotesPersistHandler=m.aio.configmanager.RemotesPersistHandler,m.aio.configmanager.CM.RemotesHandler=m.aio.configmanager.RemotesHandler,m.aio.configmanager.CM.Remote=m.aio.configmanager.Remote,m.aio.configmanager.CM.RemotePersistHandler=m.aio.configmanager.RemotePersistHandler,m.aio.configmanager.CM.RemoteHandler=m.aio.configmanager.RemoteHandler,m.aio.configmanager.CM.Pages=m.aio.configmanager.Pages,m.aio.configmanager.CM.PagesPersistHandler=m.aio.configmanager.PagesPersistHandler,m.aio.configmanager.CM.PagesHandler=m.aio.configmanager.PagesHandler,m.aio.configmanager.CM.Page=m.aio.configmanager.Page,m.aio.configmanager.CM.PagePersistHandler=m.aio.configmanager.PagePersistHandler,m.aio.configmanager.CM.PageHandler=m.aio.configmanager.PageHandler,m.aio.configmanager.CM.PageContent=m.aio.configmanager.PageContent,m.aio.configmanager.CM.PageContentHandler=m.aio.configmanager.PageContentHandler,"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.configmanager.CM);