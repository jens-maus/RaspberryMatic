var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(c.call(b,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in b||(b[e]={});b=b[e]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6","es3");$jscomp.checkStringArgs=function(a,c,b){if(null==a)throw new TypeError("The 'this' value for String.prototype."+b+" must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype."+b+" must not be a regular expression");return a+""};
$jscomp.polyfill("String.prototype.endsWith",function(a){return a?a:function(a,b){var c=$jscomp.checkStringArgs(this,a,"endsWith");a+="";void 0===b&&(b=c.length);b=Math.max(0,Math.min(b|0,c.length));for(var e=a.length;0<e&&0<b;)if(c[--b]!=a[--e])return!1;return 0>=e}},"es6","es3");var m=m||{};m.aio=m.aio||{};m.aio.devicemanager=m.aio.devicemanager||{};m.aio.devicemanager._configmanager=null;
m.aio.devicemanager.DeviceInfo=function(){var a=function(){this._rootnode=null};a.prototype.getIPCams=function(){return this._rootnode?this._rootnode.find("cam"):[]};a.prototype.getDevices=function(){return this._rootnode?this._rootnode.find("device"):[]};a.prototype.find=function(a){return this._rootnode?this._rootnode.find(a):null};a.parse=function(c){try{var b=new a;b._rootnode=$($.parseXML(c));b._xml=c;return b}catch(d){return console.log(d),null}};return a}();
m.aio.devicemanager.DMError=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};m.aio.devicemanager.DMError.prototype=Error();m.aio.devicemanager.DMError.prototype.name="DeviceManagerError";m.aio.devicemanager.DMError.prototype.code=0;m.aio.devicemanager.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,NAME_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,NOT_PERMITTED:6};m.aio.devicemanager.Filter=function(a){this.type=a};
m.aio.devicemanager.Filter.build=function(a){switch(a.filter){case "ui":return m.aio.devicemanager.UIFilter.build(a);case "prop":return m.aio.devicemanager.PropertyFilter.build(a);case "ipevt":return m.aio.devicemanager.IPEventFilter.build(a);case "neoserver":return m.aio.devicemanager.NeoServerFilter.build(a);default:return null}};m.aio.devicemanager.PropertyFilter=function(a){m.aio.devicemanager.Filter.call(this,"prop");this.properties=a;delete this.properties.filter};
m.aio.devicemanager.PropertyFilter.prototype=new m.aio.devicemanager.Filter;m.aio.devicemanager.PropertyFilter.prototype.constructor=m.aio.devicemanager.PropertyFilter;m.aio.devicemanager.PropertyFilter.prototype.match=function(a){var c=!0,b=this.properties,d;for(d in b){if(b.hasOwnProperty(d))for(var e=a,f=d.split("."),g=0;g<f.length;g++){var h=f[g];if(!e.hasOwnProperty(h)){c=c&&!1;break}e=e[h];if(!e&&g<f.length-1){c=c&&!1;break}if(g==f.length-1){c=e==b[d]?c&&!0:c&&!1;break}}if(!c)break}return c};
m.aio.devicemanager.PropertyFilter.build=function(a){return new m.aio.devicemanager.PropertyFilter(a)};m.aio.devicemanager.UIFilter=function(a,c){m.aio.devicemanager.Filter.call(this,"ui");this.catagory=a;this.elems=c};m.aio.devicemanager.UIFilter.prototype=new m.aio.devicemanager.Filter;m.aio.devicemanager.UIFilter.prototype.constructor=m.aio.devicemanager.UIFilter;
m.aio.devicemanager.UIFilter.build=function(a){if(!a.f_ui_type||!a.f_ui_elem)return null;var c=a.f_ui_elem.split(",");return new m.aio.devicemanager.UIFilter(a.f_ui_type,c)};m.aio.devicemanager.IPEventFilter=function(){m.aio.devicemanager.Filter.call(this,"ipevt")};m.aio.devicemanager.IPEventFilter.prototype=new m.aio.devicemanager.Filter;m.aio.devicemanager.IPEventFilter.prototype.constructor=m.aio.devicemanager.IPEventFilter;
m.aio.devicemanager.IPEventFilter.build=function(a){return"ipevt"!=a.filter?null:new m.aio.devicemanager.IPEventFilter};m.aio.devicemanager.NeoServerFilter=function(a,c){m.aio.devicemanager.Filter.call(this,"neoserver");this.catagory=a;this.elems=c};m.aio.devicemanager.NeoServerFilter.prototype=new m.aio.devicemanager.Filter;m.aio.devicemanager.NeoServerFilter.prototype.constructor=m.aio.devicemanager.NeoServerFilter;
m.aio.devicemanager.NeoServerFilter.build=function(a){if(!a.f_ui_type||!a.f_ui_elem)return null;var c=a.f_ui_elem.split(",");return new m.aio.devicemanager.NeoServerFilter(a.f_ui_type,c)};m.aio.devicemanager.IntHandler=function(a,c,b){this.dm=a;this.tenant=c;this.data=b;this.deviceinfo=null};m.aio.devicemanager.IntHandler.prototype.setDeviceInfo=function(a){this.deviceinfo=m.aio.devicemanager.DeviceInfo.parse(a)};m.aio.devicemanager.IntHandler.prototype.getDeviceInfo=function(){return this.deviceinfo};
m.aio.devicemanager.IntHandler.prototype.findDevice=function(a,c){return this._findDevice(a,c,!1)};m.aio.devicemanager.IntHandler.prototype.findDeviceIgnoreLicense=function(a,c){return this._findDevice(a,c,!0)};
m.aio.devicemanager.IntHandler.prototype._findDevice=function(a,c,b){var d=m.aio.devicemanager.PropertyFilter.build({filter:"prop",name:a});d=m.aio.devicemanager._RoomHandler._readSync(d,this);if(!d||!d[0]||!d[0].index)return null;a="read";b&&(a="readWithoutLicense");d=m.aio.devicemanager.PropertyFilter.build({filter:"prop",room:d[0].index,name:c});return(c=this.executeSync(a,"device",d))&&c[0]?c[0]:null};
m.aio.devicemanager.IntHandler.prototype.findDeviceWithIndex=function(a){return this._findDeviceWithIndex(a,!1)};m.aio.devicemanager.IntHandler.prototype.findDeviceWithIndexIngnoreLicense=function(a){return this._findDeviceWithIndex(a,!0)};m.aio.devicemanager.IntHandler.prototype._findDeviceWithIndex=function(a,c){a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",index:a});var b="read";c&&(b="readWithoutLicense");return(c=this.executeSync(b,"device",a))&&c[0]?c[0]:null};
m.aio.devicemanager.IntHandler.prototype.findGateway=function(a){return this._findGateway(a,!1)};m.aio.devicemanager.IntHandler.prototype.findGatewayIgnoreLicense=function(a){return this._findGateway(a,!0)};m.aio.devicemanager.IntHandler.prototype._findGateway=function(a,c){a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",name:a});var b="read";c&&(b="readWithoutLicense");return(c=this.executeSync(b,"gateway",a))&&c[0]?c[0]:null};
m.aio.devicemanager.IntHandler.prototype.findGatewayWithIndex=function(a){return this._findGatewayWithIndex(a,!1)};m.aio.devicemanager.IntHandler.prototype.findGatewayWithIndexIngnoreLicense=function(a){return this._findGatewayWithIndex(a,!0)};m.aio.devicemanager.IntHandler.prototype._findGatewayWithIndex=function(a,c){a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",index:a});var b="read";c&&(b="readWithoutLicense");return(c=this.executeSync(b,"gateway",a))&&c[0]?c[0]:null};
m.aio.devicemanager.IntHandler.prototype.findRoomWithIndex=function(a){return this._findRoomWithIndex(a,!1)};m.aio.devicemanager.IntHandler.prototype._findRoomWithIndex=function(a,c){a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",index:a});var b="read";c&&(b="readWithoutLicense");return(c=this.executeSync(b,"room",a))&&c[0]?c[0]:null};
m.aio.devicemanager.IntHandler.prototype.execute=function(a,c,b,d){var e=m.aio.devicemanager.DMError,f=m.aio.devicemanager.DMError.ERROR_CODE;if("readWithoutLicense"==a||this.tenant.license)if("readWithoutLicense"==a||this._permit(this.tenant)){switch(a){case "create":a="_create";break;case "read":a="_read";b&&b.filter&&(b=m.aio.devicemanager.Filter.build(b));break;case "readWithoutLicense":a="_read";b&&b.filter&&(b=m.aio.devicemanager.Filter.build(b));b||(b={});b.ignoreLicense=!0;break;case "update":a=
"_update";break;case "delete":a="_delete";break;default:d&&d(new e(f.UNKNOW,"op "+a+" unknow"));return}switch(c){case "gateway":m.aio.devicemanager._GatewayHandler[a](b,this,d);break;case "device":m.aio.devicemanager._DeviceHandler[a](b,this,d);break;case "room":m.aio.devicemanager._RoomHandler[a](b,this,d);break;case "gatewaytype":m.aio.devicemanager._GatewaytypeHandler[a](b,this,d);break;case "gatewaydevicetype":m.aio.devicemanager._GatewayDeviceTypeHandler[a](b,this,d);break;case "ipdevicetype":m.aio.devicemanager._IpdevicetypeHandler[a](b,
this,d);break;case "deviceinfo":m.aio.devicemanager._DeviceInfoHandler[a](b,this,d);break;default:d&&d(new e(f.UNKNOW,"type "+c+" unknow"))}}else d(Error("not permitted"));else d(new e(f.INVALID,"no license"))};
m.aio.devicemanager.IntHandler.prototype.executeSync=function(a,c,b){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if("readWithoutLicense"!=a&&!this.tenant.license)throw new d(e.INVALID,"no license");if("readWithoutLicense"!=a&&!this._permit(this.tenant))throw Error("not permitted");switch(a){case "read":a="_read";b&&b.filter&&(b=m.aio.devicemanager.Filter.build(b));break;case "readWithoutLicense":a="_read";b&&b.filter&&(b=m.aio.devicemanager.Filter.build(b));b||(b={});
b.ignoreLicense=!0;break;case "create":case "update":case "delete":throw new d(e.UNKNOW,"op "+a+" do not have synchronized method");default:throw new d(e.UNKNOW,"op "+a+" unknow");}switch(c){case "gateway":return m.aio.devicemanager._GatewayHandler[a+"Sync"](b,this);case "device":return m.aio.devicemanager._DeviceHandler[a+"Sync"](b,this);case "room":return m.aio.devicemanager._RoomHandler[a+"Sync"](b,this);case "gatewaytype":case "gatewaydevicetype":case "ipdevicetype":case "deviceinfo":throw new d(e.UNKNOW,
"type "+c+" do not have synchronized method");default:throw new d(e.UNKNOW,"type "+c+" unknow");}};m.aio.devicemanager.IntHandler.prototype.deleteUnlicensed=function(a){var c=this;if(this.data){var b=null;try{b=JSON.parse(JSON.stringify(this.data))}catch(d){a&&a(d);return}b?m.aio.devicemanager._GatewayHandler._deleteUnlicensed(this,b,function(d){d?a&&a(d):m.aio.devicemanager._DeviceHandler._deleteUnlicensed(c,b,function(c){a&&a(c,b)})}):a&&a(null,{})}else a&&a(null,{})};
m.aio.devicemanager.IntHandler.prototype._permit=function(a){return a&&a.parent&&a.license&&a.license.valid?!(a.license.isTestLicense()&&a.license.isExpired()):!1};m.aio.devicemanager.IntHandler.prototype._insertIntoArray=function(a,c){for(var b=-1,d=0;d<c.length;d++)if(c[d].index>a.index){b=d;break}-1===b?c.push(a):c.splice(b,0,a)};
m.aio.devicemanager.IntHandler.prototype._save=function(a){var c=require("fs"),b=require("path"),d=this.tenant.getFolderPath()+b.sep+m.aio.devicemanager.DeviceManager.DB,e=this,f=this.data;this.dm.writeFileEncrypted(d+".enc",JSON.stringify(f),function(b){b?a(b):(b=e.dm.removeAuthDataFromJSON(f),c.writeFile(d,JSON.stringify(b),function(c){a(c)}))})};
m.aio.devicemanager.IntHandler.prototype._sort=function(a){var c=a.length-1;do{var b=!1;for(var d=0;d<c;++d)a[d].index>a[d+1].index&&(b=a[d],a[d]=a[d+1],a[d+1]=b,b=!0)}while(1==b)};m.aio.devicemanager.IntHandler.prototype._saveDeviceInfo=function(a){var c=require("fs"),b=require("path");b=this.tenant.getFolderPath()+b.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO;c.writeFile(b,this.deviceinfo._xml,function(c){a(c)})};
m.aio.devicemanager._GatewayHandler={_create:function(a,c,b){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a.name){if(a.index&&"string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{b(new d(e.INVALID,"index "+a.index+" invalid"));return}if(a.info)if(a.info.sys)if(m.aio.devicemanager._configmanager.LicenseManager.permitFeature("create",a.info,c.tenant.license)){var f=c.data.gateways;f||(c.data.gateways=[],f=c.data.gateways);for(var g=
1,h=0;h<f.length;h++){var k=f[h];k.index===g&&g++;if(0<a.index&&k.index===a.index){b(new d(e.INDEX_EXISTS,"index "+a.index+" exists"));return}if(k.name===a.name){b(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}}if(!a.index||0>=a.index)a.index=g;if(f=c.dm.getModule(a.info.sys))if(f.devicemanager){var l={index:a.index,name:a.name,info:a.info};f.devicemanager.createGateway(l.info,c,function(a,d){a?b(a):(l.info=d,c._insertIntoArray(l,c.data.gateways),c._save(function(a){b(a,l)}))})}else b(new d(e.INVALID,
"sys "+a.info.sys+" do not have device manager implementation"));else b(new d(e.UNKNOW,"sys "+a.info.sys+" unknow"))}else b(new d(e.NOT_PERMITTED,"sys "+a.info.sys+" not permitted"));else b(new d(e.INVALID,"sys "+a.info.sys+" invalid"));else b(new d(e.INVALID,"info "+a.info+" invalid"))}else b(new d(e.INVALID,"name "+a.name+" invalid"))},_read:function(a,c,b){var d=[],e=c.data.gateways;a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?e.forEach(function(c){a.match(c)&&d.push(c)}):a&&a instanceof
m.aio.devicemanager.UIFilter?e.forEach(function(b){b=JSON.parse(JSON.stringify(b));if(b.info&&b.info.sys){var e=c.dm.getModule(b.info.sys);e&&e.devicemanager&&e.devicemanager.applyUIFilterGateway&&(e=e.devicemanager.applyUIFilterGateway(b.info,a,c.deviceinfo))&&(b.info=e,d.push(b))}}):a&&a instanceof m.aio.devicemanager.NeoServerFilter?e.forEach(function(b){b=JSON.parse(JSON.stringify(b));if(b.info&&b.info.sys){var e=c.dm.getModule(b.info.sys);e&&e.devicemanager&&e.devicemanager.applyNeoServerFilterGateway&&
(e=e.devicemanager.applyNeoServerFilterGateway(b.info,a,c.deviceinfo))&&(b.info=e,d.push(b))}}):a&&a instanceof m.aio.devicemanager.IPEventFilter?e.forEach(function(b){b=JSON.parse(JSON.stringify(b));if(b.info&&b.info.sys){var e=c.dm.getModule(b.info.sys);e&&e.devicemanager&&e.devicemanager.applyIPEventFilterGateway&&(e=e.devicemanager.applyIPEventFilterGateway(b.info,a,c.deviceinfo))&&(b.info=e,d.push(b))}}):d=e;if(a&&a.ignoreLicense)b(null,d);else{var f=[],g=m.aio.devicemanager._configmanager.LicenseManager;
d.forEach(function(a){var b=JSON.parse(JSON.stringify(a));g.permitFeature("read",a.info,c.tenant.license)||(b._no_permission=!0);f.push(b)});b(null,f)}},_readSync:function(a,c){var b=[],d=c.data.gateways;a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?d.forEach(function(c){a.match(c)&&b.push(c)}):a&&a instanceof m.aio.devicemanager.UIFilter?d.forEach(function(d){d=JSON.parse(JSON.stringify(d));if(d.info&&d.info.sys){var e=c.dm.getModule(d.info.sys);e&&e.devicemanager&&e.devicemanager.applyUIFilterGateway&&
(e=e.devicemanager.applyUIFilterGateway(d.info,a,c.deviceinfo))&&(d.info=e,b.push(d))}}):a&&a instanceof m.aio.devicemanager.NeoServerFilter?d.forEach(function(d){d=JSON.parse(JSON.stringify(d));if(d.info&&d.info.sys){var e=c.dm.getModule(d.info.sys);e&&e.devicemanager&&e.devicemanager.applyNeoServerFilterGateway&&(e=e.devicemanager.applyNeoServerFilterGateway(d.info,a,c.deviceinfo))&&(d.info=e,b.push(d))}}):a&&a instanceof m.aio.devicemanager.IPEventFilter?d.forEach(function(d){d=JSON.parse(JSON.stringify(d));
if(d.info&&d.info.sys){var e=c.dm.getModule(d.info.sys);e&&e.devicemanager&&e.devicemanager.applyIPEventFilterGateway&&(e=e.devicemanager.applyIPEventFilterGateway(d.info,a,c.deviceinfo))&&(d.info=e,b.push(d))}}):b=d;if(a&&a.ignoreLicense)return b;var e=[],f=m.aio.devicemanager._configmanager.LicenseManager;b.forEach(function(a){var b=JSON.parse(JSON.stringify(a));f.permitFeature("read",a.info,c.tenant.license)||(b._no_permission=!0);e.push(b)});return e},_update:function(a,c,b){var d=m.aio.devicemanager.DMError,
e=m.aio.devicemanager.DMError.ERROR_CODE;if(a.index){if("string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{b(new d(e.INVALID,"index "+a.index+" invalid"));return}if(a.name)if(a.info)if(a.info.sys){var f=m.aio.devicemanager._configmanager.LicenseManager;if(f.permitFeature("update",a.info,c.tenant.license)){var g,h=c.data.gateways;for(g=0;g<h.length;g++)if(a.index==h[g].index)var k=h[g];else if(a.name==h[g].name){b(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}k?
f.permitFeature("update",k.info,c.tenant.license)?(f=c.dm.getModule(a.info.sys))?f.devicemanager?f.devicemanager.updateGateway(k.info,a.info,c,function(d,e){if(d)b(d);else{k.name=a.name;k.info=e;for(var h in a)a.hasOwnProperty(h)&&"name"!=h&&"info"!=h&&"index"!=h&&a[h]&&(k[h]=a[h]);c._save(function(a){b(a,k)})}}):b(new d(e.INVALID,"sys "+a.info.sys+" do not have device manager implementation")):b(new d(e.UNKNOW,"sys "+a.info.sys+" unknow")):b(new d(e.NOT_PERMITTED,"sys "+k.info.sys+" not permitted")):
b(new d(e.NOT_FOUND,"no gateway has index "+a.index))}else b(new d(e.NOT_PERMITTED,"sys "+a.info.sys+" not permitted"))}else b(new d(e.INVALID,"sys "+a.info.sys+" invalid"));else b(new d(e.INVALID,"info "+a.info+" invalid"));else b(new d(e.INVALID,"name "+a.name+" invalid"))}else b(new d(e.INVALID,"index "+a.index+" invalid"))},_delete:function(a,c,b){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a){if(a&&"string"===typeof a)if(a.match(/^[-]?\d+$/))a=parseInt(a);else{b(new d(e.INVALID,
"index "+a+" invalid"));return}for(var f=c.data.gateways,g,h,k=0;k<f.length;k++)a===f[k].index&&(g=f[k],h=k);g?m.aio.devicemanager._configmanager.LicenseManager.permitFeature("delete",g.info,c.tenant.license)?(f=c.dm.getModule(g.info.sys))?f.devicemanager?f.devicemanager.deleteGateway(g.info,c,function(d){d?b(d):(c.data.gateways.splice(h,1),c.data.devices&&c.data.devices.forEach(function(c){c.info&&c.info.gateway&&c.info.gateway==a&&(c.info.gateway=0)}),c._save(function(a){b(a,g)}))}):b(new d(e.INVALID,
"sys "+g.info.sys+" do not have device manager implementation")):b(new d(e.UNKNOW,"sys "+g.info.sys+" unknow")):b(new d(e.NOT_PERMITTED,"sys "+g.info.sys+" not permitted")):b(new d(e.NOT_FOUND,"no gateway has index "+a))}else b(new d(e.INVALID,"index "+a+" invalid"))},_deleteUnlicensed:function(a,c,b){var d=[],e=c.gateways;if(e){for(var f=m.aio.devicemanager._configmanager.LicenseManager,g=0;g<e.length;g++){var h=e[g];f.permitFeature("add",h.info,a.tenant.license)&&d.push(h)}c.gateways=d}b&&b()}};
m.aio.devicemanager._DeviceHandler={_create:function(a,c,b){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE,f=c.data.devices;if(m.aio.devicemanager._configmanager.LicenseManager.permitFeature("create",a.info,c.tenant.license,a.index,f))if(a.name){if(a.index&&"string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{b(new d(e.INVALID,"index "+a.index+" invalid"));return}if(a.room){var g=c.data.rooms;g||(c.data.rooms=[],g=c.data.rooms);for(var h=
!1,k=0;k<g.length;k++)if(g[k].index==a.room){h=!0;break}if(h)if(a.info)if(a.info.sys)if(f||(c.data.devices=[],f=c.data.devices),g=require("m.aio.infomanager").getDeviceCount(a.info,c.tenant.license),0==g)b(Error("allow device count is 0"));else{if(-1!=g){for(k=h=0;k<f.length;k++){var l=f[k];l.info&&l.info.sys==a.info.sys&&h++}if(h>=g){b(Error("reach maximum device count "+g));return}}g=1;for(h=0;h<f.length;h++){k=f[h];k.index===g&&g++;if(0<a.index&&k.index===a.index){b(new d(e.INDEX_EXISTS,"index "+
a.index+" exists"));return}if(k.name===a.name&&k.room===a.room){b(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}}if(!a.index||0>=a.index)a.index=g;(f=c.dm.getModule(a.info.sys))?f.devicemanager?f.devicemanager.createDevice(a.info,c,function(d,e){d?b(d):(a.info=e,c._insertIntoArray(a,c.data.devices),c._save(function(c){b(c,a)}))}):b(new d(e.INVALID,"sys "+a.info.sys+" do not have device manager implementation")):b(new d(e.UNKNOW,"sys "+a.info.sys+" unknow"))}else b(new d(e.INVALID,"sys "+a.info.sys+
" invalid"));else b(new d(e.INVALID,"info "+a.info+" invalid"));else b(new d(e.INVALID,"room "+a.room+" do not exist"))}else b(new d(e.INVALID,"room "+a.room+" invalid"))}else b(new d(e.INVALID,"name "+a.name+" invalid"));else b(new d(e.NOT_PERMITTED,"sys "+a.info.sys+" not permitted"))},_read:function(a,c,b){var d=[],e=c.data.devices;a&&a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?e.forEach(function(c){a.match(c)&&d.push(c)}):a&&a instanceof m.aio.devicemanager.UIFilter?e.forEach(function(b){b=
JSON.parse(JSON.stringify(b));if(b.info&&b.info.sys){var e=c.dm.getModule(b.info.sys);e&&e.devicemanager&&e.devicemanager.applyUIFilter&&(e=e.devicemanager.applyUIFilter(b.info,a,c.deviceinfo,c))&&(b.info=e,d.push(b))}}):a&&a instanceof m.aio.devicemanager.NeoServerFilter?e.forEach(function(b){b=JSON.parse(JSON.stringify(b));if(b.info&&b.info.sys){var e=c.dm.getModule(b.info.sys);e&&e.devicemanager&&e.devicemanager.applyNeoServerFilter&&(e=e.devicemanager.applyNeoServerFilter(b.info,a,c.deviceinfo,
c))&&(b.info=e,d.push(b))}}):a&&a instanceof m.aio.devicemanager.IPEventFilter?e.forEach(function(b){b=JSON.parse(JSON.stringify(b));if(b.info&&b.info.sys){var e=null;b.info.gateway&&c&&(e=c.findGatewayWithIndexIngnoreLicense(b.info.gateway));var f=c.dm.getModule(b.info.sys);f&&f.devicemanager&&f.devicemanager.applyIPEventFilter&&(e=f.devicemanager.applyIPEventFilter(b.info,a,c.deviceinfo,c,e?e.info:null))&&(b.info=e,d.push(b))}}):d=e;if(a&&a.ignoreLicense)b(null,d);else{var f=[],g=m.aio.devicemanager._configmanager.LicenseManager;
d.forEach(function(a){var b=JSON.parse(JSON.stringify(a));g.permitFeature("read",a.info,c.tenant.license,a.index,e)||(b._no_permission=!0);f.push(b)});b(null,f)}},_readSync:function(a,c){var b=[],d=c.data.devices;a&&a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?d.forEach(function(c){a.match(c)&&b.push(c)}):a&&a instanceof m.aio.devicemanager.UIFilter?d.forEach(function(d){d=JSON.parse(JSON.stringify(d));if(d.info&&d.info.sys){var e=c.dm.getModule(d.info.sys);e&&e.devicemanager&&e.devicemanager.applyUIFilter&&
(e=e.devicemanager.applyUIFilter(d.info,a,c.deviceinfo,c))&&(d.info=e,b.push(d))}}):a&&a instanceof m.aio.devicemanager.NeoServerFilter?d.forEach(function(d){d=JSON.parse(JSON.stringify(d));if(d.info&&d.info.sys){var e=c.dm.getModule(d.info.sys);e&&e.devicemanager&&e.devicemanager.applyNeoServerFilter&&(e=e.devicemanager.applyNeoServerFilter(d.info,a,c.deviceinfo,c))&&(d.info=e,b.push(d))}}):a&&a instanceof m.aio.devicemanager.IPEventFilter?d.forEach(function(d){d=JSON.parse(JSON.stringify(d));if(d.info&&
d.info.sys){var e=null;d.info.gateway&&c&&(e=c.findGatewayWithIndexIngnoreLicense(d.info.gateway));var f=c.dm.getModule(d.info.sys);f&&f.devicemanager&&f.devicemanager.applyIPEventFilter&&(e=f.devicemanager.applyIPEventFilter(d.info,a,c.deviceinfo,c,e?e.info:null))&&(d.info=e,b.push(d))}}):b=d;if(a&&a.ignoreLicense)return b;var e=[],f=m.aio.devicemanager._configmanager.LicenseManager;b.forEach(function(a){var b=JSON.parse(JSON.stringify(a));f.permitFeature("read",a.info,c.tenant.license,a.index,d)||
(b._no_permission=!0);e.push(b)});return e},_update:function(a,c,b){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE,f=c.data.devices;if(a.index){if("string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{b(new d(e.INVALID,"index "+a.index+" invalid"));return}if(a.name)if(a.room)if(a.info)if(a.info.sys){var g=m.aio.devicemanager._configmanager.LicenseManager;if(g.permitFeature("update",a.info,c.tenant.license,a.index,f)){var h,k=c.data.rooms,
l;for(h=0;h<k.length;h++)a.room===k[h].index&&(l=k[h]);if(l){var n=-1;for(h=0;h<f.length;h++)if(a.index===f[h].index){var p=f[h];n=h}else if(f[h].name===a.name&&f[h].room===a.room){b(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}p?g.permitFeature("update",p.info,c.tenant.license,p.index,f)?(g=c.dm.getModule(a.info.sys))?g.devicemanager?g.devicemanager.updateDevice(a.info,c,function(d,e){d?b(d):(a.info=e,f[n]=a,c._save(function(c){b(c,a)}))}):b(new d(e.INVALID,"sys "+a.info.sys+" do not have device manager implementation")):
b(new d(e.UNKNOW,"sys "+a.info.sys+" unknow")):b(new d(e.NOT_PERMITTED,"sys "+p.info.sys+" not permitted")):b(new d(e.NOT_FOUND,"no device has index "+a.index))}else b(new d(e.NOT_FOUND,"no room has index "+a.index))}else b(new d(e.NOT_PERMITTED,"sys "+a.info.sys+" not permitted"))}else b(new d(e.INVALID,"sys "+a.info.sys+" invalid"));else b(new d(e.INVALID,"info "+a.info+" invalid"));else b(new d(e.INVALID,"room "+a.room+" invalid"));else b(new d(e.INVALID,"name "+a.name+" invalid"))}else b(new d(e.INVALID,
"index "+a.index+" invalid"))},_delete:function(a,c,b){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a){if(a&&"string"===typeof a)if(a.match(/^[-]?\d+$/))a=parseInt(a);else{b(new d(e.INVALID,"index "+a+" invalid"));return}for(var f=c.data.devices,g,h,k=0;k<f.length;k++)a===f[k].index&&(g=f[k],h=k);g?m.aio.devicemanager._configmanager.LicenseManager.permitFeature("delete",g.info,c.tenant.license)?(a=c.dm.getModule(g.info.sys))?a.devicemanager?a.devicemanager.deleteDevice(g.info,
c,function(a){a?b(a):(c.data.devices.splice(h,1),c._save(function(a){b(a,g)}))}):b(new d(e.INVALID,"sys "+g.info.sys+" do not have device manager implementation")):b(new d(e.UNKNOW,"sys "+g.info.sys+" unknow")):b(new d(e.NOT_PERMITTED,"sys "+g.info.sys+" not permitted")):b(new d(e.NOT_FOUND,"no device has index "+a))}else b(new d(e.INVALID,"index "+a+" invalid"))},_deleteUnlicensed:function(a,c,b){var d=[],e=c.devices;if(e){for(var f=m.aio.devicemanager._configmanager.LicenseManager,g=0;g<e.length;g++){var h=
e[g];f.permitFeature("add",h.info,a.tenant.license,h.index,e)&&d.push(h)}c.devices=d}b&&b()}};
m.aio.devicemanager._RoomHandler={_create:function(a,c,b){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a.name){if(a.index&&"string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{b(new d(e.INVALID,"index "+a.index+" invalid"));return}var f=c.data.rooms;f||(c.data.rooms=[],f=c.data.rooms);for(var g=1,h=0;h<f.length;h++){var k=f[h];k.index===g&&g++;if(0<=a.index&&k.index===a.index){b(new d(e.INDEX_EXISTS,"index "+a.index+" exists"));return}if(k.name===
a.name){b(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}}if(!a.index||0>=a.index)a.index=g;c._insertIntoArray(a,c.data.rooms);c._save(function(c){b(c,a)})}else b(new d(e.INVALID,"name "+a.name+" invalid"))},_read:function(a,c,b){var d=[];c=c.data.rooms;a&&a instanceof m.aio.devicemanager.PropertyFilter&&a.properties?(c.forEach(function(b){a.match(b)&&d.push(b)}),b(null,d)):b(null,c)},_readSync:function(a,c){var b=[];c=c.data.rooms;return a&&a instanceof m.aio.devicemanager.PropertyFilter&&
a.properties?(c.forEach(function(c){a.match(c)&&b.push(c)}),b):c},_update:function(a,c,b){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a.index){if("string"===typeof a.index)if(a.index.match(/^[-]?\d+$/))a.index=parseInt(a.index);else{b(new d(e.INVALID,"index "+a.index+" invalid"));return}if(a.name){var f,g=c.data.rooms;for(f=0;f<g.length;f++)if(a.index===g[f].index)var h=g[f];else if(a.name===g[f].name){b(new d(e.NAME_EXISTS,"name "+a.name+" exists"));return}h?h.name!==
a.name?(h.name=a.name,c._save(function(a){b(a,h)})):b(null,h):b(new d(e.NOT_FOUND,"no room has index "+a.index))}else b(new d(e.INVALID,"name "+a.name+" invalid"))}else b(new d(e.INVALID,"index "+a.index+" invalid"))},_delete:function(a,c,b){var d=m.aio.devicemanager.DMError,e=m.aio.devicemanager.DMError.ERROR_CODE;if(a){if(a&&"string"===typeof a)if(a.match(/^[-]?\d+$/))a=parseInt(a);else{b(new d(e.INVALID,"index "+a+" invalid"));return}var f=c.data.rooms,g=-1,h;for(h=0;h<f.length;h++)if(a===f[h].index){var k=
f[h];g=h}if(k){d=c.data.devices;for(h=0;h<d.length;h++)a===d[h].room&&(d[h].room=0);0<=g&&(c.data.rooms.splice(g,1),c._save(function(a){b(a,k)}))}else b(new d(e.NOT_FOUND,"no room has index "+a))}else b(new d(e.INVALID,"index "+a+" invalid"))}};
m.aio.devicemanager._GatewaytypeHandler={_read:function(a,c,b){a=[];var d={};for(g in c.dm.modules)if(c.dm.modules.hasOwnProperty(g)){var e=c.dm.modules[g];var f=require("xnm.aio."+e+".js");e&&f&&(d[e]=f)}var g=m.aio.devicemanager._configmanager.LicenseManager;for(var h in d)d.hasOwnProperty(h)&&(f=d[h]),f.devicemanager&&"function"===typeof f.devicemanager.getGatewayType&&(e=f.devicemanager.getGatewayType({lm:g,license:c.tenant.license}))&&(a=a.concat(e));f=[];for(h=0;h<a.length;h++)g.permitFeature("read",
a[h],c.tenant.license)&&f.push(a[h]);b(null,f)}};
m.aio.devicemanager._GatewayDeviceTypeHandler={_create:function(a,c,b){if(a.sys){var d=c.dm.modules[a.sys];if(d){var e=require("xnm.aio."+d+".js");if(e)if(e.devicemanager&&"function"==typeof e.devicemanager.getGatewayDeviceType){var f=m.aio.devicemanager._configmanager.LicenseManager;"gateway"==d?e.devicemanager.getGatewayDeviceType2(a,{lm:f,license:c.tenant.license},function(a,c){b(a,c)}):(a=e.devicemanager.getGatewayDeviceType(a,{lm:f,license:c.tenant.license}),b(null,a))}else b&&b(Error("module has no gateway device"));
else b&&b(Error("no such module "+a.sys))}else b&&b(Error("do not support sys "+a.sys))}else b&&b(Error("parameter sys is null"))}};
m.aio.devicemanager._IpdevicetypeHandler={_read:function(a,c,b){a=[];var d={};for(g in c.dm.modules)if(c.dm.modules.hasOwnProperty(g)){var e=c.dm.modules[g];var f=require("xnm.aio."+e+".js");e&&f&&(d[e]=f)}var g=m.aio.devicemanager._configmanager.LicenseManager;for(var h in d)d.hasOwnProperty(h)&&(f=d[h]),f.devicemanager&&"function"===typeof f.devicemanager.getIPDeviceType&&(e=f.devicemanager.getIPDeviceType(c.deviceinfo,{lm:g,license:c.tenant.license}))&&(a=a.concat(e));f=[];for(h=0;h<a.length;h++)g.permitFeature("read",
a[h],c.tenant.license)&&f.push(a[h]);b(null,f)}};
m.aio.devicemanager._DeviceInfoHandler={_read:function(a,c,b){a&&a.ignoreLicense||m.aio.devicemanager._configmanager.LicenseManager.permitFeature("read",{sys:"ip"},c.tenant.license)?c.deviceinfo&&c.deviceinfo._xml?b(null,c.deviceinfo._xml):b&&b(null,""):b&&b(Error("do not permit to access device info"))},_update:function(a,c,b){m.aio.devicemanager._configmanager.LicenseManager.permitFeature("update",{sys:"ip"},c.tenant.license)?(a=m.aio.devicemanager.DeviceInfo.parse(a))?(c.deviceinfo=a,c._saveDeviceInfo(function(a){b&&
b(a,c.deviceinfo._xml)})):b&&b(Error("device info format invalid")):b&&b(Error("do not permit to access device info"))}};m.aio.devicemanager.DeviceManager=function(){this.handlers=[];this.modules={}};m.aio.devicemanager.DeviceManager.DB="device_db";m.aio.devicemanager.DeviceManager.DEVICE_INFO="deviceinfo.xml";m.aio.devicemanager.DeviceManager.DEFAULT_DEVICE_INFO='<?xml version="1.0" encoding="UTF-8" ?>\r\n<deviceinfo update="1432810745">\r\n\t<device id="xbmc_frodo" name="XBMC (Frodo)" controlurl="/jsonrpc?request=%7B%22jsonrpc%22%3A%20%222.0%22%2C%20%22method%22%3A%20%22Input.ExecuteAction%22%2C%20%22params%22%3A%20%7B%20%22action%22%3A%20%22%@%22%7D%2C%20%22id%22%3A%201%7D" upnptype="generic" controlport="80" tpl="320x460:264:3378@3|1024x748:265:3382@3" icon="dmr">\r\n    <key id="volumeDown" code="volumedown"/>\r\n    <key id="volumeUp" code="volumeup"/>\r\n    <key id="mute" code="mute"/>\r\n    <key id="left" code="left"/>\r\n    <key id="right" code="right"/>\r\n    <key id="up" code="up"/>\r\n    <key id="down" code="down"/>\r\n    <key id="back" code="back"/>\r\n    <key id="select" code="select"/>\r\n    <key id="enter" code="enter"/>\r\n    <key id="return" code="backspace"/>\r\n    <key id="prevPage" code="pageup"/>\r\n    <key id="nextPage" code="pagedown"/>\r\n    <key id="play" code="play"/>\r\n    <key id="pause" code="pause"/>\r\n    <key id="play_pause" code="playpause"/>\r\n    <key id="stop" code="stop"/>\r\n    <key id="info" code="info"/>\r\n    <key id="hidesubmenu" code="hidesubmenu"/>\r\n    <key id="popupmenu" code="contextmenu"/>\r\n    <key id="exit" code="close"/>\r\n    <key id="fastForward" code="fastforward"/>\r\n    <key id="rewind" code="rewind"/>\r\n    <key id="next" code="skipnext"/>\r\n    <key id="previous" code="skipprevious"/>\r\n    <key id="stepForward" code="stepforward"/>\r\n    <key id="stepBack" code="stepback"/>\r\n    <key id="bigStepForwart" code="bigstepforward"/>\r\n    <key id="bigStepBack" code="bigstepback"/>\r\n    <key id="subtitle" code="showsubtitles"/>\r\n    <key id="nextSubtitle" code="nextsubtitle"/>\r\n    <key id="channelUp" code="channelup"/>\r\n    <key id="channelDown" code="channeldown"/>\r\n    <key id="previousPicture" code="previouspicture"/>\r\n    <key id="nextPicture" code="nextpicture"/>\r\n    <key id="scrollUp" code="scrollup"/>\r\n    <key id="scrollDown" code="scrolldown"/>\r\n    <key id="previousScene" code="previousscene"/>\r\n    <key id="nextScene" code="nextscene"/>\r\n    <key id="fullscreen" code="fullscreen"/>\r\n    <key id="videoMode" code="togglefullscreen"/>\r\n    <key id="ratio" code="aspectratio"/>\r\n    <key id="1" code="number1"/>\r\n    <key id="2" code="number2"/>\r\n    <key id="3" code="number3"/>\r\n    <key id="4" code="number4"/>\r\n    <key id="5" code="number5"/>\r\n    <key id="6" code="number6"/>\r\n    <key id="7" code="number7"/>\r\n    <key id="8" code="number8"/>\r\n    <key id="9" code="number9"/>\r\n    <key id="0" code="number0"/>\r\n    <key id="red" code="red"/>\r\n    <key id="green" code="green"/>\r\n    <key id="yellow" code="yellow"/>\r\n    <key id="blue" code="blue"/>\r\n    <key id="osd" code="osd"/>\r\n    <key id="osdLeft" code="osdleft"/>\r\n    <key id="osdrRight" code="osdright"/>\r\n    <key id="osdUp" code="osdup"/>\r\n    <key id="osdDown" code="osddown"/>\r\n    <key id="osdSelect" code="osdselect"/>\r\n    <key id="osdValuePlus" code="osdvalueplus"/>\r\n    <key id="osdValueMinus" code="osdvalueminus"/>\r\n  </device>\r\n\t<device id="denon_3808" name="Denon AVR" tpl="320x460:253:3380@3|1024x748:254:3384@3" icon="avr" controlport="23" tcptype="textnl">\r\n    <key id="volumeUp" code="MVUP"/>\r\n    <key id="volumeDown" code="MVDOWN"/>\r\n    <key id="mainZoneOn" code="ZMON"/>\r\n    <key id="mainZoneOff" code="ZMOFF"/>\r\n    <key id="muteOn" code="MUON"/>\r\n    <key id="muteOff" code="MUOFF"/>\r\n    <key id="INPUT_PHONO" code="SIPHONO"/>\r\n    <key id="INPUT_CD" code="SICD"/>\r\n    <key id="INPUT_TUNER" code="SITUNER"/>\r\n    <key id="INPUT_DVD" code="SIDVD"/>\r\n    <key id="INPUT_BD" code="SIBD"/>\r\n    <key id="INPUT_TV" code="SITV"/>\r\n    <key id="INPUT_SATCBL" code="SISAT/CBL"/>\r\n    <key id="INPUT_DVR" code="SIDVR"/>\r\n    <key id="INPUT_GAME" code="SIGAME"/>\r\n    <key id="INPUT_VAUX" code="SIV.AUX"/>\r\n    <key id="INPUT_DOCK" code="SIDOCK"/>\r\n    <key id="INPUT_NETUSB" code="SINET/USB"/>\r\n    <key id="INPUT_USB_IPOD" code="SIUSB/IPOD"/>\r\n    <key id="DIRECT" code="MSDIRECT"/>\r\n    <key id="PURE_DIRECT" code="MSPURE DIRECT"/>\r\n    <key id="STEREO" code="MSSTEREO"/>\r\n    <key id="STANDARD" code="MSSTANDARD"/>\r\n    <key id="DOLBY_DIGITAL" code="MSDOLBY DIGITAL"/>\r\n    <key id="DTS_SURROUND" code="MSDTS SURROUND"/>\r\n    <key id="SUPER_STADIUM" code="MSSUPER STADIUM"/>\r\n    <key id="ROCK_ARENA" code="MSROCK ARENA"/>\r\n    <key id="JAZZCLUB" code="MSJAZZ CLUB"/>\r\n    <key id="CLASSIC_CONCERT" code="MSCLASSIC CONCERT"/>\r\n    <key id="VIDEOGAME" code="MSVIDEO GAME"/>\r\n    <key id="zone2PowerOn" code="Z2ON"/>\r\n    <key id="zone2PowerOff" code="Z2OFF"/>\r\n    <key id="zone2VolumeUp" code="Z2UP"/>\r\n    <key id="zone2VolumeDown" code="Z2DOWN"/>\r\n    <key id="zone2MuteOn" code="Z2MUON"/>\r\n    <key id="zone2MuteOff" code="Z2MUOFF"/>\r\n    <key id="powerOn" code="PWON"/>\r\n    <key id="powerOff" code="PWSTANDBY"/>\r\n  </device>\r\n\t<device id="reelbox" name="Reelbox" udptype="textnl" controlport="2004">\r\n    <key id="channelDown" code="Channel- "/>\r\n    <key id="channelUp" code="Channel+ "/>\r\n    <key id="up" code="Up "/>\r\n    <key id="down" code="Down "/>\r\n    <key id="left" code="Left "/>\r\n    <key id="right" code="Right "/>\r\n    <key id="enter" code="Ok "/>\r\n    <key id="menu" code="Menu "/>\r\n    <key id="back" code="Back "/>\r\n    <key id="volumeDown" code="Volume- "/>\r\n    <key id="volumeUp" code="Volume+ "/>\r\n    <key id="mute" code="Mute "/>\r\n    <key id="play" code="Play "/>\r\n    <key id="pause" code="Pause "/>\r\n    <key id="stop" code="Stop "/>\r\n    <key id="record" code="Record "/>\r\n    <key id="rewind" code="FastRew "/>\r\n    <key id="fastForward" code="FastFwd "/>\r\n    <key id="eject" code="Eject "/>\r\n    <key id="DVB" code="DVB "/>\r\n    <key id="DVD" code="DVD "/>\r\n    <key id="PVR" code="PVR "/>\r\n    <key id="Reel" code="Reel "/>\r\n    <key id="teletext" code="TT "/>\r\n    <key id="pip" code="PiP "/>\r\n    <key id="aspect" code="Aspect "/>\r\n    <key id="help" code="Help "/>\r\n    <key id="info" code="Info "/>\r\n    <key id="search" code="Search "/>\r\n    <key id="audio" code="Audio "/>\r\n    <key id="setup" code="Setup "/>\r\n    <key id="timer" code="Timer "/>\r\n    <key id="greater" code="Greater "/>\r\n    <key id="1" code="1 "/>\r\n    <key id="2" code="2 "/>\r\n    <key id="3" code="3 "/>\r\n    <key id="4" code="4 "/>\r\n    <key id="5" code="5 "/>\r\n    <key id="6" code="6 "/>\r\n    <key id="7" code="7 "/>\r\n    <key id="8" code="8 "/>\r\n    <key id="9" code="9 "/>\r\n    <key id="0" code="0 "/>\r\n    <key id="red" code="Red "/>\r\n    <key id="green" code="Green "/>\r\n    <key id="yellow" code="Yellow "/>\r\n    <key id="blue" code="Blue "/>\r\n    <key id="powerOn" code="Startup "/>\r\n    <key id="powerOff" code="Poweroff "/>\r\n    <key id="standby" code="Standby "/>\r\n  </device>\r\n</deviceinfo>';
m.aio.devicemanager.DeviceManager.prototype.init=function(a,c,b){if(a&&a.children){m.aio.devicemanager._configmanager=c;var d=this;require("async").each(a.children,function(a,b){d._loadTenant(a,b)},function(a){b(a)})}else b()};m.aio.devicemanager.DeviceManager.prototype.addTenant=function(a,c){this._loadTenant(a,c)};
m.aio.devicemanager.DeviceManager.prototype.removeTenant=function(a,c){for(var b=-1,d=0;d<this.handlers.length;d++)if(this.handlers[d].tenant.index==a.index){b=d;break}-1!=b&&this.handlers.splice(b,1);c()};m.aio.devicemanager.DeviceManager.prototype.register=function(a,c){if(!a)throw Error("sys is invalid");if(!c)throw Error("module name is invalid");this.modules[a]=c};m.aio.devicemanager.DeviceManager.prototype.getModuleName=function(a){return a?this.modules[a]:null};
m.aio.devicemanager.DeviceManager.prototype.getModule=function(a){return(a=this.getModuleName(a))?require("xnm.aio."+a+".js"):null};m.aio.devicemanager.DeviceManager.prototype.getDeviceInfo=function(a){for(var c=0;c<this.handlers.length;c++){var b=this.handlers[c];if(b.tenant.index==a)return b.deviceinfo}return null};
m.aio.devicemanager.DeviceManager.prototype.reloadTenant=function(a,c){for(var b=-1,d=0;d<this.handlers.length;d++){var e=this.handlers[d];if(e&&e.tenant&&e.tenant.index==a.index){b=d;break}}-1!=b&&this.handlers.splice(b,1);this._loadTenant(a,c)};m.aio.devicemanager.DeviceManager.prototype.execute=function(a,c,b,d,e){for(var f=null,g=0;g<this.handlers.length;g++){var h=this.handlers[g];if(h.tenant&&h.tenant.index==c){f=h;break}}f?f.execute(a,b,d,function(a,b){e(a,b)}):e(Error("no such tenant"))};
m.aio.devicemanager.DeviceManager.prototype.executeSync=function(a,c,b,d){for(var e=null,f=0;f<this.handlers.length;f++){var g=this.handlers[f];if(g.tenant&&g.tenant.index==c){e=g;break}}if(!e)throw Error("no such tenant");return e.executeSync(a,b,d)};
m.aio.devicemanager.DeviceManager.prototype.deleteUnlicensed=function(a,c){for(var b=null,d=this,e=0;e<this.handlers.length;e++){var f=this.handlers[e];if(f.tenant&&f.tenant.index==a){b=f;break}}b?m.aio.devicemanager._configmanager.trace("config/tenants/"+a,function(a,e){if(a)c&&c(a);else if(e.isAccessible()){var f=e.getRemotes();f&&0!=f.size()?(f=f.getChildren(),b.deleteUnlicensed(function(a,b){a?c&&c(a):f&&0!=f.length?require("async").each(f,function(a,c){d.saveRemoteWithDB(a,b,function(a){c(a)})},
function(a){c&&c(a)}):c&&c()})):c&&c(null)}else c&&c(Error("not permitted"))}):c(Error("no such tenant"))};m.aio.devicemanager.DeviceManager.prototype.getDeviceDBForRemote=function(a,c){for(var b=null,d=0;d<this.handlers.length;d++){var e=this.handlers[d];if(e.tenant&&e.tenant.index==a){b=e;break}}b?m.aio.devicemanager._configmanager.trace("config/tenants/"+a,function(a,d){a?c&&c(a):d.isAccessible()?b.deleteUnlicensed(function(a,b){c&&c(a,b)}):c&&c(Error("not permitted"))}):c(Error("no such tenant"))};
m.aio.devicemanager.DeviceManager.prototype.getIntHandler=function(a){for(var c=0;c<this.handlers.length;c++){var b=this.handlers[c];if(b.tenant&&b.tenant.index==a)return b}return null};
m.aio.devicemanager.DeviceManager.prototype.saveRemote=function(a,c){if(a.parent){var b=a.parent.parent;if(b){for(var d=null,e=0;e<this.handlers.length;e++){var f=this.handlers[e];if(f.tenant&&f.tenant.index==b.index){d=f;break}}if(d){var g=this;d.deleteUnlicensed(function(b,d){b?c&&c(b):g.saveRemoteWithDB(a,d,function(a){c&&c(a)})})}else c(Error("no such tenant"))}else c&&c(Error("remote do not belong to any tenant"))}else c&&c(Error("remote is isolated"))};
m.aio.devicemanager.DeviceManager.prototype.saveRemoteWithDB=function(a,c,b){if(a.parent){var d=a.parent.parent;if(d){var e=d.getFolderPath();if(e){var f=a.getFolderPath();a=require("fs");var g=require("path"),h=this,k=e+g.sep+m.aio.devicemanager.DeviceManager.DB,l=f+g.sep+m.aio.devicemanager.DeviceManager.DB;a.writeFile(l,JSON.stringify(c),function(a){a?b&&b(a):(k=e+g.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO,l=f+g.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO,h._copyFile(k,l,function(a){b&&
b(a)}))})}else b&&b(Error("invalid tenant folder"))}else b&&b(Error("remote do not belong to any tenant"))}else b&&b(Error("remote is isolated"))};m.aio.devicemanager.DeviceManager.prototype.clearRemoteDB=function(a,c){var b=require("fs-extra"),d=require("path");a=a.getFolderPath()+d.sep+m.aio.devicemanager.DeviceManager.DB;b.remove(a,c)};m.aio.devicemanager.DeviceManager.prototype.prepareContentForWriting=function(a){return require("x.crypt").AES.encodeString(a,this.ml_v1_info())};
m.aio.devicemanager.DeviceManager.prototype.removeAuthDataFromJSON=function(a){var c={};Array.isArray(a)&&(c=[]);var b="accessToken password pwd refreshToken token user username".split(" "),d;for(d in a){var e=a[d];null!==e&&"object"===typeof e?c[d]=this.removeAuthDataFromJSON(e):0<=b.indexOf(d)?c[d]="":c[d]=e}return c};
m.aio.devicemanager.DeviceManager.prototype.writeFileEncrypted=function(a,c,b){var d=require("fs"),e=require("x.crypt");try{c=e.AES.encodeString(c,this.ml_v1_info()),d.writeFile(a,c,function(a){b&&b(a)})}catch(f){b&&b(f)}};m.aio.devicemanager.DeviceManager.prototype._copyFile=function(a,c,b){var d=require("fs-extra");d.exists(a,function(e){e?d.copy(a,c,function(a){b&&b(a)}):b&&b()})};
m.aio.devicemanager.DeviceManager.prototype._loadTenant=function(a,c){var b=function(a,b){require("fs").writeFile(a,m.aio.devicemanager.DeviceManager.DEFAULT_DEVICE_INFO,function(a){b(a)})},d=function(a,c,d){var e=require("fs");e.exists(c,function(f){f?e.readFile(c,{encoding:"utf8"},function(b,c){b||0<c.length&&a.setDeviceInfo(c);d()}):b(c,function(b){b?d():e.readFile(c,{encoding:"utf8"},function(b,c){b||0<c.length&&a.setDeviceInfo(c);d()})})})},e=this,f=require("path"),g=a.getFolderPath();if(g){var h=
new m.aio.devicemanager.IntHandler(e,a,{devices:[],rooms:[],gateways:[]});this.handlers.push(h);a=g+f.sep+m.aio.devicemanager.DeviceManager.DB;var k=g+f.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO,l=require("fs-extra"),n=!1;l.existsSync(a+".enc")&&(a+=".enc",n=!0);var p=function(){d(h,k,function(){c&&c()})};(function(a,b,c){var d=require("fs");d.exists(b,function(f){f?d.readFile(b,{encoding:"utf8"},function(d,f){if(!d&&0<f.length)try{String(b).endsWith(".enc")&&(f=require("x.crypt").AES.decodeString(f,
e.ml_v1_info()));var g=JSON.parse(f);g&&(a.data=g,a.data.devices||(a.data.devices=[]),a._sort(a.data.devices),a.data.gateways||(a.data.gateways=[]),a._sort(a.data.gateways),a.data.rooms||(a.data.rooms=[]),a._sort(a.data.rooms))}catch(r){console.error(r)}c()}):d.writeFile(b,"",function(){c()})})})(h,a,function(){n?p():h._save(function(){var a=f.join(g,"cloud"),b=f.join(g,"automation"),c=f.join(g,"remotes");if(l.existsSync(a))try{l.remove(a)}catch(q){console.error(q)}if(l.existsSync(b))try{var d=l.readdirSync(b);
for(a=0;a<d.length;a++){var e=d[a];if(l.statSync(f.join(b,e)).isDirectory()){var h=f.join(b,e,"db");l.existsSync(h)&&l.remove(h)}}}catch(q){console.error(q)}if(l.existsSync(c))try{var k=l.readdirSync(c);for(b=0;b<k.length;b++){var n=k[b];if(l.statSync(f.join(c,n)).isDirectory()){var r=f.join(c,n,"device_db");l.existsSync(r)&&l.remove(r)}}}catch(q){console.error(q)}p()})})}else c()};
m.aio.devicemanager.DeviceManager.prototype.supportSmartWidget=function(a){if(!a||!a.info)return!1;var c=this.getModule(a.info.sys);return c&&c.devicemanager&&c.devicemanager.supportSmartWidget?(a=JSON.parse(JSON.stringify(a.info)),c.devicemanager.supportSmartWidget(a)):!1};
m.aio.devicemanager.DeviceManager.prototype.applySmartWidgetFilter=function(a,c,b,d){var e=this.getIntHandler(a);if(e)if(a=e.findDeviceWithIndex(c))if(a.info){var f=e.findRoomWithIndex(a.room);e=null;f&&(e=f.name);var g=this.getModule(a.info.sys);if(g&&g.devicemanager&&g.devicemanager.applySmartWidgetFilter){f=JSON.parse(JSON.stringify(a));if(c=g.devicemanager.applySmartWidgetFilter(a.info,b,{index:c,name:a.name,room:e}))f.smartwidget=c;d&&d(null,f)}else d&&d(null,[])}else d&&d(null,[]);else c=Error("can not read device with id:"+
c),c.code=500,d&&d(c);else c=Error("no such tenant with index:"+a),c.code=500,d&&d(c)};
m.aio.devicemanager.DeviceManager.prototype.applySmartWidgetFilterForGateway=function(a,c,b,d){var e=this.getIntHandler(a);if(e)if(e=e.findGatewayWithIndex(c))if(e.info){var f=this.getModule(e.info.sys);if(f&&f.devicemanager&&f.devicemanager.applySmartWidgetFilterForGateway){a=JSON.parse(JSON.stringify(e));if(c=f.devicemanager.applySmartWidgetFilterForGateway(e.info,b,{index:c,name:e.name}))a.smartwidget=c;d&&d(null,a)}else d&&d(null,[])}else d&&d(null,[]);else c=Error("can not read device with id:"+
c),c.code=500,d&&d(c);else c=Error("no such tenant with index:"+a),c.code=500,d&&d(c)};m.aio.devicemanager.DeviceManager.prototype.ml_v1_info=function(){return require("x.crypt").SHA1("0cc6c6df12537fc79522a1ac15f1f592e93fdeb3")};
m.aio.devicemanager.DeviceManager.prototype.toGeneralDevice=function(a,c,b,d){var e=this.getIntHandler(a);e?(a=b?e.findDeviceWithIndexIngnoreLicense(c):e.findDeviceWithIndex(c))?a.info?(c=this.getModule(a.info.sys))&&c.devicemanager&&c.devicemanager.toGeneralDevice?(e=c.devicemanager.toGeneralDevice(a.info,e.deviceinfo),d&&d(null,e)):d&&d(null,null):d&&d(null,null):(e=Error("can not read device with id:"+c),e.code=500,d&&d(e)):(e=Error("no such tenant with index:"+a),e.code=500,d&&d(e))};
m.aio.devicemanager.DeviceManager.prototype.Handler=m.aio.devicemanager.IntHandler;m.aio.devicemanager.DeviceManager.prototype.Filter=m.aio.devicemanager.Filter;m.aio.devicemanager.Handler=m.aio.devicemanager.DeviceManager;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.devicemanager.Handler);
