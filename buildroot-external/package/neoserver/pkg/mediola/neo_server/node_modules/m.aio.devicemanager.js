function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o;}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o;},_typeof(o);}var m=m||{};m.aio=m.aio||{},m.aio.devicemanager=m.aio.devicemanager||{},m.aio.devicemanager._configmanager=null,m.aio.devicemanager.DeviceInfo=function(){var e=function e(){this._rootnode=null;};return e.prototype.getIPCams=function(){return this._rootnode?this._rootnode.find("cam"):[];},e.prototype.getDevices=function(){return this._rootnode?this._rootnode.find("device"):[];},e.prototype.find=function(e){return this._rootnode?this._rootnode.find(e):null;},e.parse=function(n){try{var i=new e();return i._rootnode=$($.parseXML(n)),i._xml=n,i;}catch(n){return console.log(n),null;}},e;}(),m.aio.devicemanager.DMError=function(e,n){this.code=e,this.message=n,this.stack=new Error().stack;},m.aio.devicemanager.DMError.prototype=new Error(),m.aio.devicemanager.DMError.prototype.name="DeviceManagerError",m.aio.devicemanager.DMError.prototype.code=0,m.aio.devicemanager.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,NAME_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,NOT_PERMITTED:6},m.aio.devicemanager.Filter=function(e){this.type=e;},m.aio.devicemanager.Filter.build=function(e){switch(e.filter){case"ui":return m.aio.devicemanager.UIFilter.build(e);case"prop":return m.aio.devicemanager.PropertyFilter.build(e);case"ipevt":return m.aio.devicemanager.IPEventFilter.build(e);case"neoserver":return m.aio.devicemanager.NeoServerFilter.build(e);default:return null;}},m.aio.devicemanager.PropertyFilter=function(e){m.aio.devicemanager.Filter.call(this,"prop"),this.properties=e,delete this.properties.filter;},m.aio.devicemanager.PropertyFilter.prototype=new m.aio.devicemanager.Filter(),m.aio.devicemanager.PropertyFilter.prototype.constructor=m.aio.devicemanager.PropertyFilter,m.aio.devicemanager.PropertyFilter.prototype.match=function(e){var n=!0,i=this.properties;for(var a in i){if(i.hasOwnProperty(a))for(var r=e,o=a.split("."),t=0;t<o.length;t++){var d=o[t];if(!r.hasOwnProperty(d)){n=n&&!1;break;}if(!(r=r[d])&&t<o.length-1){n=n&&!1;break;}if(t==o.length-1){if(r==i[a]){n=n&&!0;break;}n=n&&!1;break;}}if(!n)break;}return n;},m.aio.devicemanager.PropertyFilter.build=function(e){return new m.aio.devicemanager.PropertyFilter(e);},m.aio.devicemanager.UIFilter=function(e,n){m.aio.devicemanager.Filter.call(this,"ui"),this.catagory=e,this.elems=n;},m.aio.devicemanager.UIFilter.prototype=new m.aio.devicemanager.Filter(),m.aio.devicemanager.UIFilter.prototype.constructor=m.aio.devicemanager.UIFilter,m.aio.devicemanager.UIFilter.build=function(e){if(!e.f_ui_type||!e.f_ui_elem)return null;var n=e.f_ui_elem.split(",");return new m.aio.devicemanager.UIFilter(e.f_ui_type,n);},m.aio.devicemanager.IPEventFilter=function(){m.aio.devicemanager.Filter.call(this,"ipevt");},m.aio.devicemanager.IPEventFilter.prototype=new m.aio.devicemanager.Filter(),m.aio.devicemanager.IPEventFilter.prototype.constructor=m.aio.devicemanager.IPEventFilter,m.aio.devicemanager.IPEventFilter.build=function(e){return"ipevt"!=e.filter?null:new m.aio.devicemanager.IPEventFilter();},m.aio.devicemanager.NeoServerFilter=function(e,n){m.aio.devicemanager.Filter.call(this,"neoserver"),this.catagory=e,this.elems=n;},m.aio.devicemanager.NeoServerFilter.prototype=new m.aio.devicemanager.Filter(),m.aio.devicemanager.NeoServerFilter.prototype.constructor=m.aio.devicemanager.NeoServerFilter,m.aio.devicemanager.NeoServerFilter.build=function(e){if(!e.f_ui_type||!e.f_ui_elem)return null;var n=e.f_ui_elem.split(",");return new m.aio.devicemanager.NeoServerFilter(e.f_ui_type,n);},m.aio.devicemanager.IntHandler=function(e,n,i){this.dm=e,this.tenant=n,this.data=i,this.deviceinfo=null;},m.aio.devicemanager.IntHandler.prototype.setDeviceInfo=function(e){this.deviceinfo=m.aio.devicemanager.DeviceInfo.parse(e);},m.aio.devicemanager.IntHandler.prototype.getDeviceInfo=function(){return this.deviceinfo;},m.aio.devicemanager.IntHandler.prototype.findDevice=function(e,n){return this._findDevice(e,n,!1);},m.aio.devicemanager.IntHandler.prototype.findDeviceIgnoreLicense=function(e,n){return this._findDevice(e,n,!0);},m.aio.devicemanager.IntHandler.prototype._findDevice=function(e,n,i){var a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",name:e}),r=m.aio.devicemanager._RoomHandler._readSync(a,this);if(!r||!r[0]||!r[0].index)return null;var o="read";i&&(o="readWithoutLicense"),a=m.aio.devicemanager.PropertyFilter.build({filter:"prop",room:r[0].index,name:n});var t=this.executeSync(o,"device",a);return t&&t[0]?t[0]:null;},m.aio.devicemanager.IntHandler.prototype.findDeviceWithIndex=function(e){return this._findDeviceWithIndex(e,!1);},m.aio.devicemanager.IntHandler.prototype.findDeviceWithIndexIngnoreLicense=function(e){return this._findDeviceWithIndex(e,!0);},m.aio.devicemanager.IntHandler.prototype._findDeviceWithIndex=function(e,n){var i=m.aio.devicemanager.PropertyFilter.build({filter:"prop",index:e}),a="read";n&&(a="readWithoutLicense");var r=this.executeSync(a,"device",i);return r&&r[0]?r[0]:null;},m.aio.devicemanager.IntHandler.prototype.findGateway=function(e){return this._findGateway(e,!1);},m.aio.devicemanager.IntHandler.prototype.findGatewayIgnoreLicense=function(e){return this._findGateway(e,!0);},m.aio.devicemanager.IntHandler.prototype._findGateway=function(e,n){var i=m.aio.devicemanager.PropertyFilter.build({filter:"prop",name:e}),a="read";n&&(a="readWithoutLicense");var r=this.executeSync(a,"gateway",i);return r&&r[0]?r[0]:null;},m.aio.devicemanager.IntHandler.prototype.findGatewayWithIndex=function(e){return this._findGatewayWithIndex(e,!1);},m.aio.devicemanager.IntHandler.prototype.findGatewayWithIndexIngnoreLicense=function(e){return this._findGatewayWithIndex(e,!0);},m.aio.devicemanager.IntHandler.prototype._findGatewayWithIndex=function(e,n){var i=m.aio.devicemanager.PropertyFilter.build({filter:"prop",index:e}),a="read";n&&(a="readWithoutLicense");var r=this.executeSync(a,"gateway",i);return r&&r[0]?r[0]:null;},m.aio.devicemanager.IntHandler.prototype.findRoomWithIndex=function(e){return this._findRoomWithIndex(e,!1);},m.aio.devicemanager.IntHandler.prototype._findRoomWithIndex=function(e,n){var i=m.aio.devicemanager.PropertyFilter.build({filter:"prop",index:e}),a="read";n&&(a="readWithoutLicense");var r=this.executeSync(a,"room",i);return r&&r[0]?r[0]:null;},m.aio.devicemanager.IntHandler.prototype.execute=function(e,n,i,a,r){var o=m.aio.devicemanager.DMError,t=m.aio.devicemanager.DMError.ERROR_CODE;if("readWithoutLicense"==e||this.tenant.license){if("readWithoutLicense"==e||this._permit(this.tenant)){var d;switch(e){case"create":d="_create";break;case"read":d="_read",i&&i.filter&&(i=m.aio.devicemanager.Filter.build(i));break;case"readWithoutLicense":d="_read",i&&i.filter&&(i=m.aio.devicemanager.Filter.build(i)),i||(i={}),i.ignoreLicense=!0;break;case"update":d="_update";break;case"delete":d="_delete";break;default:return void(a&&a(new o(t.UNKNOW,"op "+e+" unknown")));}switch(n){case"gateway":m.aio.devicemanager._GatewayHandler[d](i,this,a,r);break;case"device":m.aio.devicemanager._DeviceHandler[d](i,this,a,r);break;case"room":m.aio.devicemanager._RoomHandler[d](i,this,a,r);break;case"gatewaytype":m.aio.devicemanager._GatewaytypeHandler[d](i,this,a);break;case"gatewaydevicetype":m.aio.devicemanager._GatewayDeviceTypeHandler[d](i,this,a);break;case"ipdevicetype":m.aio.devicemanager._IpdevicetypeHandler[d](i,this,a);break;case"deviceinfo":m.aio.devicemanager._DeviceInfoHandler[d](i,this,a);break;default:a&&a(new o(t.UNKNOW,"type "+n+" unknown"));}}else a(new Error("not permitted"));}else a(new o(t.INVALID,"no license"));},m.aio.devicemanager.IntHandler.prototype.executeSync=function(e,n,i){var a,r=m.aio.devicemanager.DMError,o=m.aio.devicemanager.DMError.ERROR_CODE;if("readWithoutLicense"!=e&&!this.tenant.license)throw new r(o.INVALID,"no license");if("readWithoutLicense"!=e&&!this._permit(this.tenant))throw new Error("not permitted");switch(e){case"read":a="_read",i&&i.filter&&(i=m.aio.devicemanager.Filter.build(i));break;case"readWithoutLicense":a="_read",i&&i.filter&&(i=m.aio.devicemanager.Filter.build(i)),i||(i={}),i.ignoreLicense=!0;break;case"create":case"update":case"delete":throw new r(o.UNKNOW,"op "+e+" do not have synchronized method");default:throw new r(o.UNKNOW,"op "+e+" unknown");}switch(n){case"gateway":return m.aio.devicemanager._GatewayHandler[a+"Sync"](i,this);case"device":return m.aio.devicemanager._DeviceHandler[a+"Sync"](i,this);case"room":return m.aio.devicemanager._RoomHandler[a+"Sync"](i,this);case"gatewaytype":case"gatewaydevicetype":case"ipdevicetype":case"deviceinfo":throw new r(o.UNKNOW,"type "+n+" do not have synchronized method");default:throw new r(o.UNKNOW,"type "+n+" unknown");}},m.aio.devicemanager.IntHandler.prototype.deleteUnlicensed=function(e){var n=this;if(this.data){var i=null;try{i=JSON.parse(JSON.stringify(this.data));}catch(n){return void(e&&e(n));}i?m.aio.devicemanager._GatewayHandler._deleteUnlicensed(this,i,function(a){a?e&&e(a):m.aio.devicemanager._DeviceHandler._deleteUnlicensed(n,i,function(n){e&&e(n,i);});}):e&&e(null,{});}else e&&e(null,{});},m.aio.devicemanager.IntHandler.prototype._permit=function(e){return!(!e||!e.parent||!e.license||!e.license.valid||e.license.isTestLicense()&&e.license.isExpired());},m.aio.devicemanager.IntHandler.prototype._insertIntoArray=function(e,n){for(var i=-1,a=0;a<n.length;a++)if(n[a].index>e.index){i=a;break;}-1===i?n.push(e):n.splice(i,0,e);},m.aio.devicemanager.IntHandler.prototype._save=function(e){var n=require("fs"),i=require("path"),a=this.tenant.getFolderPath()+i.sep+m.aio.devicemanager.DeviceManager.DB,r=this,o=this.data;this.dm.writeFileEncrypted(a+".enc",JSON.stringify(o),function(i){if(i)e(i);else{var t=r.dm.removeAuthDataFromJSON(o);n.writeFile(a,JSON.stringify(t),function(n){e(n);});}});},m.aio.devicemanager.IntHandler.prototype._sort=function(e){var n=e.length-1,i=!1;do{i=!1;for(var a=0;a<n;++a)if(e[a].index>e[a+1].index){var r=e[a];e[a]=e[a+1],e[a+1]=r,i=!0;}}while(1==i);},m.aio.devicemanager.IntHandler.prototype._saveDeviceInfo=function(e){var n=require("fs"),i=require("path"),a=this.tenant.getFolderPath()+i.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO;n.writeFile(a,this.deviceinfo._xml,function(n){e(n);});},m.aio.devicemanager._GatewayHandler={_create:function _create(e,n,i){var a=m.aio.devicemanager.DMError,r=m.aio.devicemanager.DMError.ERROR_CODE;if(e.name){if(e.index&&"string"==typeof e.index){if(!e.index.match(/^[-]?\d+$/))return void i(new a(r.INVALID,"index "+e.index+" invalid"));e.index=parseInt(e.index);}if(e.info){if(e.info.sys){if(m.aio.devicemanager._configmanager.LicenseManager.permitFeature("create",e.info,n.tenant.license)){var o=n.data.gateways;o||(n.data.gateways=[],o=n.data.gateways);for(var t=1,d=0;d<o.length;d++){var c=o[d];if(c.index===t&&t++,e.index>0&&c.index===e.index)return void i(new a(r.INDEX_EXISTS,"index "+e.index+" exists"));if(c.name===e.name)return void i(new a(r.NAME_EXISTS,"name "+e.name+" exists"));}(!e.index||e.index<=0)&&(e.index=t);var s=n.dm.getModule(e.info.sys);if(s){if(s.devicemanager){var f={index:e.index,name:e.name,info:e.info};s.devicemanager.createGateway(f.info,n,function(e,a){e?i(e):(f.info=a,n._insertIntoArray(f,n.data.gateways),n._save(function(e){i(e,f);}));});}else i(new a(r.INVALID,"sys "+e.info.sys+" do not have device manager implementation"));}else i(new a(r.UNKNOW,"sys "+e.info.sys+" unknown"));}else i(new a(r.NOT_PERMITTED,"sys "+e.info.sys+" not permitted"));}else i(new a(r.INVALID,"sys "+e.info.sys+" invalid"));}else i(new a(r.INVALID,"info "+e.info+" invalid"));}else i(new a(r.INVALID,"name "+e.name+" invalid"));},_read:function _read(e,n,i){var a=[],r=n.data.gateways;if(e instanceof m.aio.devicemanager.PropertyFilter&&e.properties?r.forEach(function(n){e.match(n)&&a.push(n);}):e&&e instanceof m.aio.devicemanager.UIFilter?r.forEach(function(i){var r=JSON.parse(JSON.stringify(i));if(r.info&&r.info.sys){var o=n.dm.getModule(r.info.sys);if(o&&o.devicemanager&&o.devicemanager.applyUIFilterGateway){var t=o.devicemanager.applyUIFilterGateway(r.info,e,n.deviceinfo);t&&(r.info=t,a.push(r));}}}):e&&e instanceof m.aio.devicemanager.NeoServerFilter?r.forEach(function(i){var r=JSON.parse(JSON.stringify(i));if(r.info&&r.info.sys){var o=n.dm.getModule(r.info.sys);if(o&&o.devicemanager&&o.devicemanager.applyNeoServerFilterGateway){var t=o.devicemanager.applyNeoServerFilterGateway(r.info,e,n.deviceinfo);t&&(r.info=t,a.push(r));}}}):e&&e instanceof m.aio.devicemanager.IPEventFilter?r.forEach(function(i){var r=JSON.parse(JSON.stringify(i));if(r.info&&r.info.sys){var o=n.dm.getModule(r.info.sys);if(o&&o.devicemanager&&o.devicemanager.applyIPEventFilterGateway){var t=o.devicemanager.applyIPEventFilterGateway(r.info,e,n.deviceinfo);t&&(r.info=t,a.push(r));}}}):a=r,e&&e.ignoreLicense)i(null,a);else{var o=[],t=m.aio.devicemanager._configmanager.LicenseManager;a.forEach(function(e){var i=JSON.parse(JSON.stringify(e));t.permitFeature("read",e.info,n.tenant.license)||(i._no_permission=!0),o.push(i);}),i(null,o);}},_readSync:function _readSync(e,n){var i=[],a=n.data.gateways;if(e instanceof m.aio.devicemanager.PropertyFilter&&e.properties?a.forEach(function(n){e.match(n)&&i.push(n);}):e&&e instanceof m.aio.devicemanager.UIFilter?a.forEach(function(a){var r=JSON.parse(JSON.stringify(a));if(r.info&&r.info.sys){var o=n.dm.getModule(r.info.sys);if(o&&o.devicemanager&&o.devicemanager.applyUIFilterGateway){var t=o.devicemanager.applyUIFilterGateway(r.info,e,n.deviceinfo);t&&(r.info=t,i.push(r));}}}):e&&e instanceof m.aio.devicemanager.NeoServerFilter?a.forEach(function(a){var r=JSON.parse(JSON.stringify(a));if(r.info&&r.info.sys){var o=n.dm.getModule(r.info.sys);if(o&&o.devicemanager&&o.devicemanager.applyNeoServerFilterGateway){var t=o.devicemanager.applyNeoServerFilterGateway(r.info,e,n.deviceinfo);t&&(r.info=t,i.push(r));}}}):e&&e instanceof m.aio.devicemanager.IPEventFilter?a.forEach(function(a){var r=JSON.parse(JSON.stringify(a));if(r.info&&r.info.sys){var o=n.dm.getModule(r.info.sys);if(o&&o.devicemanager&&o.devicemanager.applyIPEventFilterGateway){var t=o.devicemanager.applyIPEventFilterGateway(r.info,e,n.deviceinfo);t&&(r.info=t,i.push(r));}}}):i=a,e&&e.ignoreLicense)return i;var r=[],o=m.aio.devicemanager._configmanager.LicenseManager;return i.forEach(function(e){var i=JSON.parse(JSON.stringify(e));o.permitFeature("read",e.info,n.tenant.license)||(i._no_permission=!0),r.push(i);}),r;},_update:function _update(e,n,i){var a=m.aio.devicemanager.DMError,r=m.aio.devicemanager.DMError.ERROR_CODE;if(e.index){if("string"==typeof e.index){if(!e.index.match(/^[-]?\d+$/))return void i(new a(r.INVALID,"index "+e.index+" invalid"));e.index=parseInt(e.index);}if(e.name){if(e.info){if(e.info.sys){var o=m.aio.devicemanager._configmanager.LicenseManager;if(o.permitFeature("update",e.info,n.tenant.license)){var t,d,c=n.data.gateways;for(t=0;t<c.length;t++)if(e.index==c[t].index)d=c[t];else if(e.name==c[t].name)return void i(new a(r.NAME_EXISTS,"name "+e.name+" exists"));if(d){if(o.permitFeature("update",d.info,n.tenant.license)){var s=n.dm.getModule(e.info.sys);s?s.devicemanager?s.devicemanager.updateGateway(d.info,e.info,n,function(a,r){if(a)i(a);else{for(var o in d.name=e.name,d.info=r,e)e.hasOwnProperty(o)&&"name"!=o&&"info"!=o&&"index"!=o&&e[o]&&(d[o]=e[o]);n._save(function(e){i(e,d);});}}):i(new a(r.INVALID,"sys "+e.info.sys+" do not have device manager implementation")):i(new a(r.UNKNOW,"sys "+e.info.sys+" unknown"));}else i(new a(r.NOT_PERMITTED,"sys "+d.info.sys+" not permitted"));}else i(new a(r.NOT_FOUND,"no gateway has index "+e.index));}else i(new a(r.NOT_PERMITTED,"sys "+e.info.sys+" not permitted"));}else i(new a(r.INVALID,"sys "+e.info.sys+" invalid"));}else i(new a(r.INVALID,"info "+e.info+" invalid"));}else i(new a(r.INVALID,"name "+e.name+" invalid"));}else i(new a(r.INVALID,"index "+e.index+" invalid"));},_delete:function _delete(e,n,i){var a=m.aio.devicemanager.DMError,r=m.aio.devicemanager.DMError.ERROR_CODE;if(e){if(e&&"string"==typeof e){if(!e.match(/^[-]?\d+$/))return void i(new a(r.INVALID,"index "+e+" invalid"));e=parseInt(e);}for(var o,t,d=n.data.gateways,c=0;c<d.length;c++)e===d[c].index&&(o=d[c],t=c);if(o){if(m.aio.devicemanager._configmanager.LicenseManager.permitFeature("delete",o.info,n.tenant.license)){var s=n.dm.getModule(o.info.sys);s?s.devicemanager?s.devicemanager.deleteGateway(o.info,n,function(a){a?i(a):(n.data.gateways.splice(t,1),n.data.devices&&n.data.devices.forEach(function(n){n.info&&n.info.gateway&&n.info.gateway==e&&(n.info.gateway=0);}),n._save(function(e){i(e,o);}));}):i(new a(r.INVALID,"sys "+o.info.sys+" do not have device manager implementation")):i(new a(r.UNKNOW,"sys "+o.info.sys+" unknown"));}else i(new a(r.NOT_PERMITTED,"sys "+o.info.sys+" not permitted"));}else i(new a(r.NOT_FOUND,"no gateway has index "+e));}else i(new a(r.INVALID,"index "+e+" invalid"));},_deleteUnlicensed:function _deleteUnlicensed(e,n,i){var a=[],r=n.gateways;if(!r)return void(i&&i());var o=m.aio.devicemanager._configmanager.LicenseManager;for(var _n=0;_n<r.length;_n++){var _i=r[_n];_i.info&&o.permitFeature("add",_i.info,e.tenant.license)&&a.push(_i);}n.gateways=a,i&&i();}},m.aio.devicemanager._DeviceHandler={_findGateway:function _findGateway(e,n){if(!e||!e.data)return null;var i=e.data.gateways;if(!i)return null;for(var a=0;a<i.length;a++){var r=i[a];if(r&&r.index==n)return r;}return null;},_create:function _create(e,n,i,a){var r=m.aio.devicemanager.DMError,o=m.aio.devicemanager.DMError.ERROR_CODE,t=n.data.devices,d=m.aio.devicemanager._configmanager.LicenseManager,c=null;if(e.info&&e.info.gateway&&(c=this._findGateway(n,e.info.gateway)),d.permitFeature("create",e.info,n.tenant.license,e.index,t,c?c.info:null)){if(e.name){if(e.index&&"string"==typeof e.index){if(!e.index.match(/^[-]?\d+$/))return void i(new r(o.INVALID,"index "+e.index+" invalid"));e.index=parseInt(e.index);}if(e.room){var s=n.data.rooms;s||(n.data.rooms=[],s=n.data.rooms);for(var f=!1,l=0;l<s.length;l++)if(s[l].index==e.room){f=!0;break;}if(f){if(e.info){if(e.info.sys){t||(n.data.devices=[],t=n.data.devices);var v=require("m.aio.infomanager").getDeviceCount(e.info,n.tenant.license);if(0!=v){if(-1!=v){for(var u=0,g=0;g<t.length;g++){var y=t[g];y.info&&y.info.sys==e.info.sys&&u++;}if(u>=v)return void i(new Error("reach maximum device count "+v));}for(var p=1,h=0;h<t.length;h++){var w=t[h];if(w.index===p&&p++,e.index>0&&w.index===e.index)return void i(new r(o.INDEX_EXISTS,"index "+e.index+" exists"));if(w.name===e.name&&w.room===e.room)return void i(new r(o.NAME_EXISTS,"name "+e.name+" exists"));}(!e.index||e.index<=0)&&(e.index=p);var I=n.dm.getModule(e.info.sys);I?I.devicemanager?I.devicemanager.createDevice(e.info,n,function(r,o){r?i(r):(e.info=o,n._insertIntoArray(e,n.data.devices),a?i(null,e):n._save(function(n){i(n,e);}));}):i(new r(o.INVALID,"sys "+e.info.sys+" do not have device manager implementation")):i(new r(o.UNKNOW,"sys "+e.info.sys+" unknown"));}else i(new Error("allow device count is 0"));}else i(new r(o.INVALID,"sys "+e.info.sys+" invalid"));}else i(new r(o.INVALID,"info "+e.info+" invalid"));}else i(new r(o.INVALID,"room "+e.room+" do not exist"));}else i(new r(o.INVALID,"room "+e.room+" invalid"));}else i(new r(o.INVALID,"name "+e.name+" invalid"));}else i(new r(o.NOT_PERMITTED,"sys "+e.info.sys+" not permitted"));},_read:function _read(e,n,i){var a=[],r=n.data.devices;if(e&&e instanceof m.aio.devicemanager.PropertyFilter&&e.properties?r.forEach(function(n){e.match(n)&&a.push(n);}):e&&e instanceof m.aio.devicemanager.UIFilter?r.forEach(function(i){var r=JSON.parse(JSON.stringify(i));if(r.info&&r.info.sys){var o=null;r.info.gateway&&n&&(o=n.findGatewayWithIndexIngnoreLicense(r.info.gateway));var t=n.dm.getModule(r.info.sys);if(t&&t.devicemanager&&t.devicemanager.applyUIFilter){var d=t.devicemanager.applyUIFilter(r.info,e,n.deviceinfo,n,o?o.info:null);d&&(r.info=d,a.push(r));}}}):e&&e instanceof m.aio.devicemanager.NeoServerFilter?r.forEach(function(i){var r=JSON.parse(JSON.stringify(i));if(r.info&&r.info.sys){var o=n.dm.getModule(r.info.sys);if(o&&o.devicemanager&&o.devicemanager.applyNeoServerFilter){var t=o.devicemanager.applyNeoServerFilter(r.info,e,n.deviceinfo,n);t&&(r.info=t,a.push(r));}}}):e&&e instanceof m.aio.devicemanager.IPEventFilter?r.forEach(function(i){var r=JSON.parse(JSON.stringify(i));if(r.info&&r.info.sys){var o=null;r.info.gateway&&n&&(o=n.findGatewayWithIndexIngnoreLicense(r.info.gateway));var t=n.dm.getModule(r.info.sys);if(t&&t.devicemanager&&t.devicemanager.applyIPEventFilter){var d=t.devicemanager.applyIPEventFilter(r.info,e,n.deviceinfo,n,o?o.info:null);d&&(r.info=d,a.push(r));}}}):a=r,e&&e.ignoreLicense)i(null,a);else{var o=[],t=m.aio.devicemanager._configmanager.LicenseManager,d=this;a.forEach(function(e){var i=null;e.info&&e.info.gateway&&(i=d._findGateway(n,e.info.gateway));var a=JSON.parse(JSON.stringify(e));t.permitFeature("read",e.info,n.tenant.license,e.index,r,i?i.info:null)||(a._no_permission=!0),o.push(a);}),i(null,o);}},_readSync:function _readSync(e,n){var i=[],a=n.data.devices;if(e&&e instanceof m.aio.devicemanager.PropertyFilter&&e.properties?a.forEach(function(n){e.match(n)&&i.push(n);}):e&&e instanceof m.aio.devicemanager.UIFilter?a.forEach(function(a){var r=JSON.parse(JSON.stringify(a));if(r.info&&r.info.sys){var o=n.dm.getModule(r.info.sys);if(o&&o.devicemanager&&o.devicemanager.applyUIFilter){var t=o.devicemanager.applyUIFilter(r.info,e,n.deviceinfo,n);t&&(r.info=t,i.push(r));}}}):e&&e instanceof m.aio.devicemanager.NeoServerFilter?a.forEach(function(a){var r=JSON.parse(JSON.stringify(a));if(r.info&&r.info.sys){var o=n.dm.getModule(r.info.sys);if(o&&o.devicemanager&&o.devicemanager.applyNeoServerFilter){var t=o.devicemanager.applyNeoServerFilter(r.info,e,n.deviceinfo,n);t&&(r.info=t,i.push(r));}}}):e&&e instanceof m.aio.devicemanager.IPEventFilter?a.forEach(function(a){var r=JSON.parse(JSON.stringify(a));if(r.info&&r.info.sys){var o=null;r.info.gateway&&n&&(o=n.findGatewayWithIndexIngnoreLicense(r.info.gateway));var t=n.dm.getModule(r.info.sys);if(t&&t.devicemanager&&t.devicemanager.applyIPEventFilter){var d=t.devicemanager.applyIPEventFilter(r.info,e,n.deviceinfo,n,o?o.info:null);d&&(r.info=d,i.push(r));}}}):i=a,e&&e.ignoreLicense)return i;var r=[],o=m.aio.devicemanager._configmanager.LicenseManager,t=this;return i.forEach(function(e){var i=null;e.info&&e.info.gateway&&(i=t._findGateway(n,e.info.gateway));var d=JSON.parse(JSON.stringify(e));o.permitFeature("read",e.info,n.tenant.license,e.index,a,i?i.info:null)||(d._no_permission=!0),r.push(d);}),r;},_update:function _update(e,n,i,a){var r=m.aio.devicemanager.DMError,o=m.aio.devicemanager.DMError.ERROR_CODE,t=n.data.devices;if(e.index){if("string"==typeof e.index){if(!e.index.match(/^[-]?\d+$/))return void i(new r(o.INVALID,"index "+e.index+" invalid"));e.index=parseInt(e.index);}if(e.name){if(e.room){if(e.info){if(e.info.sys){var d=null;e.info&&e.info.gateway&&(d=this._findGateway(n,e.info.gateway));var c=m.aio.devicemanager._configmanager.LicenseManager;if(c.permitFeature("update",e.info,n.tenant.license,e.index,t,d?d.info:null)){var s,f,l=n.data.rooms;for(s=0;s<l.length;s++)e.room===l[s].index&&(f=l[s]);if(f){var v,u=-1;for(s=0;s<t.length;s++)if(e.index===t[s].index)v=t[s],u=s;else if(t[s].name===e.name&&t[s].room===e.room)return void i(new r(o.NAME_EXISTS,"name "+e.name+" exists"));if(v){if(v.info&&v.info.gateway&&(d=this._findGateway(n,v.info.gateway)),c.permitFeature("update",v.info,n.tenant.license,v.index,t,d?d.info:null)){var g=n.dm.getModule(e.info.sys);g?g.devicemanager?g.devicemanager.updateDevice(e.info,n,function(r,o){r?i(r):(e.info=o,t[u]=e,a?i(null,e):n._save(function(n){i(n,e);}));}):i(new r(o.INVALID,"sys "+e.info.sys+" do not have device manager implementation")):i(new r(o.UNKNOW,"sys "+e.info.sys+" unknown"));}else i(new r(o.NOT_PERMITTED,"sys "+v.info.sys+" not permitted"));}else i(new r(o.NOT_FOUND,"no device has index "+e.index));}else i(new r(o.NOT_FOUND,"no room has index "+e.index));}else i(new r(o.NOT_PERMITTED,"sys "+e.info.sys+" not permitted"));}else i(new r(o.INVALID,"sys "+e.info.sys+" invalid"));}else i(new r(o.INVALID,"info "+e.info+" invalid"));}else i(new r(o.INVALID,"room "+e.room+" invalid"));}else i(new r(o.INVALID,"name "+e.name+" invalid"));}else i(new r(o.INVALID,"index "+e.index+" invalid"));},_delete:function _delete(e,n,i,a){var r=m.aio.devicemanager.DMError,o=m.aio.devicemanager.DMError.ERROR_CODE;if(e){if(e&&"string"==typeof e){if(!e.match(/^[-]?\d+$/))return void i(new r(o.INVALID,"index "+e+" invalid"));e=parseInt(e);}for(var t,d,c=n.data.devices,s=0;s<c.length;s++)e===c[s].index&&(t=c[s],d=s);if(t){var f=null;if(t.info&&t.info.gateway&&(f=this._findGateway(n,t.info.gateway)),m.aio.devicemanager._configmanager.LicenseManager.permitFeature("delete",t.info,n.tenant.license,t.index,c,f?f.info:null)){var l=n.dm.getModule(t.info.sys);l?l.devicemanager?l.devicemanager.deleteDevice(t.info,n,function(e){e?i(e):(n.data.devices.splice(d,1),a?i(null,t):n._save(function(e){i(e,t);}));}):i(new r(o.INVALID,"sys "+t.info.sys+" do not have device manager implementation")):i(new r(o.UNKNOW,"sys "+t.info.sys+" unknown"));}else i(new r(o.NOT_PERMITTED,"sys "+t.info.sys+" not permitted"));}else i(new r(o.NOT_FOUND,"no device has index "+e));}else i(new r(o.INVALID,"index "+e+" invalid"));},_deleteUnlicensed:function _deleteUnlicensed(e,n,i){var a=[],r=n.devices;if(!r)return void(i&&i());var o=m.aio.devicemanager._configmanager.LicenseManager;var t=!0;for(var _n2=0;_n2<r.length;_n2++){var _i2=r[_n2];var d=null;_i2.info&&_i2.info.gateway&&(d=this._findGateway(e,_i2.info.gateway)),t=o.permitFeature("add",_i2.info,e.tenant.license,_i2.index,r,d?d.info:null),t&&a.push(_i2);}n.devices=a,i&&i();}},m.aio.devicemanager._RoomHandler={_create:function _create(e,n,i){var a=m.aio.devicemanager.DMError,r=m.aio.devicemanager.DMError.ERROR_CODE;if(e.name){if(e.index&&"string"==typeof e.index){if(!e.index.match(/^[-]?\d+$/))return void i(new a(r.INVALID,"index "+e.index+" invalid"));e.index=parseInt(e.index);}var o=n.data.rooms;o||(n.data.rooms=[],o=n.data.rooms);for(var t=1,d=0;d<o.length;d++){var c=o[d];if(c.index===t&&t++,e.index>=0&&c.index===e.index)return void i(new a(r.INDEX_EXISTS,"index "+e.index+" exists"));if(c.name===e.name)return void i(new a(r.NAME_EXISTS,"name "+e.name+" exists"));}(!e.index||e.index<=0)&&(e.index=t),n._insertIntoArray(e,n.data.rooms),n._save(function(n){i(n,e);});}else i(new a(r.INVALID,"name "+e.name+" invalid"));},_read:function _read(e,n,i){var a=[],r=n.data.rooms;e&&e instanceof m.aio.devicemanager.PropertyFilter&&e.properties?(r.forEach(function(n){e.match(n)&&a.push(n);}),i(null,a)):i(null,r);},_readSync:function _readSync(e,n){var i=[],a=n.data.rooms;return e&&e instanceof m.aio.devicemanager.PropertyFilter&&e.properties?(a.forEach(function(n){e.match(n)&&i.push(n);}),i):a;},_update:function _update(e,n,i){var a=m.aio.devicemanager.DMError,r=m.aio.devicemanager.DMError.ERROR_CODE;if(e.index){if("string"==typeof e.index){if(!e.index.match(/^[-]?\d+$/))return void i(new a(r.INVALID,"index "+e.index+" invalid"));e.index=parseInt(e.index);}if(e.name){var o,t,d=n.data.rooms;for(o=0;o<d.length;o++)if(e.index===d[o].index)t=d[o];else if(e.name===d[o].name)return void i(new a(r.NAME_EXISTS,"name "+e.name+" exists"));if(t){var c=t.name!==e.name;e.info&&"object"==_typeof(e.info)?(c=!0,t.info=e.info):t.info&&(c=!0,delete t.info),c?(t.name=e.name,n._save(function(e){i(e,t);})):i(null,t);}else i(new a(r.NOT_FOUND,"no room has index "+e.index));}else i(new a(r.INVALID,"name "+e.name+" invalid"));}else i(new a(r.INVALID,"index "+e.index+" invalid"));},_delete:function _delete(e,n,i){var a=m.aio.devicemanager.DMError,r=m.aio.devicemanager.DMError.ERROR_CODE;if(e){if(e&&"string"==typeof e){if(!e.match(/^[-]?\d+$/))return void i(new a(r.INVALID,"index "+e+" invalid"));e=parseInt(e);}var o,t,d=n.data.rooms,c=-1;for(t=0;t<d.length;t++)e===d[t].index&&(o=d[t],c=t);if(o){var s=n.data.devices;for(t=0;t<s.length;t++)e===s[t].room&&(s[t].room=0);c>=0&&(n.data.rooms.splice(c,1),n._save(function(e){i(e,o);}));}else i(new a(r.NOT_FOUND,"no room has index "+e));}else i(new a(r.INVALID,"index "+e+" invalid"));}},m.aio.devicemanager._GatewaytypeHandler={_read:function _read(e,n,i){var a,r=[],o={};for(var t in n.dm.modules)if(n.dm.modules.hasOwnProperty(t)){var d=n.dm.modules[t];a=require("xnm.aio."+d+".js"),d&&a&&(o[d]=a);}var c=m.aio.devicemanager._configmanager.LicenseManager;for(var s in o)if(o.hasOwnProperty(s)&&(a=o[s]),a.devicemanager&&"function"==typeof a.devicemanager.getGatewayType){var f=a.devicemanager.getGatewayType({lm:c,license:n.tenant.license});f&&(r=r.concat(f));}for(var l=[],v=0;v<r.length;v++)c.permitFeature("read",r[v],n.tenant.license)&&l.push(r[v]);i(null,l);}},m.aio.devicemanager._GatewayDeviceTypeHandler={_create:function _create(e,n,i){if(e.sys){var a=n.dm.modules[e.sys];if(a){var r=require("xnm.aio."+a+".js");if(r){if(r.devicemanager&&"function"==typeof r.devicemanager.getGatewayDeviceType){var o=m.aio.devicemanager._configmanager.LicenseManager;if("gateway"==a)r.devicemanager.getGatewayDeviceType2(e,{lm:o,license:n.tenant.license},function(e,n){i(e,n);});else{var t=r.devicemanager.getGatewayDeviceType(e,{lm:o,license:n.tenant.license});i(null,t);}}else i&&i(new Error("module has no gateway device"));}else i&&i(new Error("no such module "+e.sys));}else i&&i(new Error("do not support sys "+e.sys));}else i&&i(new Error("parameter sys is null"));}},m.aio.devicemanager._IpdevicetypeHandler={_read:function _read(e,n,i){var a,r=[],o={};for(var t in n.dm.modules)if(n.dm.modules.hasOwnProperty(t)){var d=n.dm.modules[t];a=require("xnm.aio."+d+".js"),d&&a&&(o[d]=a);}var c=m.aio.devicemanager._configmanager.LicenseManager;for(var s in o)if(o.hasOwnProperty(s)&&(a=o[s]),a.devicemanager&&"function"==typeof a.devicemanager.getIPDeviceType){var f=a.devicemanager.getIPDeviceType(n.deviceinfo,{lm:c,license:n.tenant.license});f&&(r=r.concat(f));}for(var l=[],v=0;v<r.length;v++)c.permitFeature("read",r[v],n.tenant.license)&&l.push(r[v]);i(null,l);}},m.aio.devicemanager._DeviceInfoHandler={_read:function _read(e,n,i){e&&e.ignoreLicense||m.aio.devicemanager._configmanager.LicenseManager.permitFeature("read",{sys:"ip"},n.tenant.license)?n.deviceinfo&&n.deviceinfo._xml?i(null,n.deviceinfo._xml):i&&i(null,""):i&&i(new Error("do not permit to access device info"));},_update:function _update(e,n,i){if(m.aio.devicemanager._configmanager.LicenseManager.permitFeature("update",{sys:"ip"},n.tenant.license)){var a=m.aio.devicemanager.DeviceInfo.parse(e);a?(n.deviceinfo=a,n._saveDeviceInfo(function(e){i&&i(e,n.deviceinfo._xml);})):i&&i(new Error("device info format invalid"));}else i&&i(new Error("do not permit to access device info"));}},m.aio.devicemanager.DeviceManager=function(){this.handlers=[],this.modules={};},m.aio.devicemanager.DeviceManager.DB="device_db",m.aio.devicemanager.DeviceManager.DEVICE_INFO="deviceinfo.xml",m.aio.devicemanager.DeviceManager.DEFAULT_DEVICE_INFO='<?xml version="1.0" encoding="UTF-8" ?>\r\n<deviceinfo update="1432810745">\r\n\t<device id="xbmc_frodo" name="XBMC (Frodo)" controlurl="/jsonrpc?request=%7B%22jsonrpc%22%3A%20%222.0%22%2C%20%22method%22%3A%20%22Input.ExecuteAction%22%2C%20%22params%22%3A%20%7B%20%22action%22%3A%20%22%@%22%7D%2C%20%22id%22%3A%201%7D" upnptype="generic" controlport="80" tpl="320x460:264:3378@3|1024x748:265:3382@3" icon="dmr">\r\n    <key id="volumeDown" code="volumedown"/>\r\n    <key id="volumeUp" code="volumeup"/>\r\n    <key id="mute" code="mute"/>\r\n    <key id="left" code="left"/>\r\n    <key id="right" code="right"/>\r\n    <key id="up" code="up"/>\r\n    <key id="down" code="down"/>\r\n    <key id="back" code="back"/>\r\n    <key id="select" code="select"/>\r\n    <key id="enter" code="enter"/>\r\n    <key id="return" code="backspace"/>\r\n    <key id="prevPage" code="pageup"/>\r\n    <key id="nextPage" code="pagedown"/>\r\n    <key id="play" code="play"/>\r\n    <key id="pause" code="pause"/>\r\n    <key id="play_pause" code="playpause"/>\r\n    <key id="stop" code="stop"/>\r\n    <key id="info" code="info"/>\r\n    <key id="hidesubmenu" code="hidesubmenu"/>\r\n    <key id="popupmenu" code="contextmenu"/>\r\n    <key id="exit" code="close"/>\r\n    <key id="fastForward" code="fastforward"/>\r\n    <key id="rewind" code="rewind"/>\r\n    <key id="next" code="skipnext"/>\r\n    <key id="previous" code="skipprevious"/>\r\n    <key id="stepForward" code="stepforward"/>\r\n    <key id="stepBack" code="stepback"/>\r\n    <key id="bigStepForwart" code="bigstepforward"/>\r\n    <key id="bigStepBack" code="bigstepback"/>\r\n    <key id="subtitle" code="showsubtitles"/>\r\n    <key id="nextSubtitle" code="nextsubtitle"/>\r\n    <key id="channelUp" code="channelup"/>\r\n    <key id="channelDown" code="channeldown"/>\r\n    <key id="previousPicture" code="previouspicture"/>\r\n    <key id="nextPicture" code="nextpicture"/>\r\n    <key id="scrollUp" code="scrollup"/>\r\n    <key id="scrollDown" code="scrolldown"/>\r\n    <key id="previousScene" code="previousscene"/>\r\n    <key id="nextScene" code="nextscene"/>\r\n    <key id="fullscreen" code="fullscreen"/>\r\n    <key id="videoMode" code="togglefullscreen"/>\r\n    <key id="ratio" code="aspectratio"/>\r\n    <key id="1" code="number1"/>\r\n    <key id="2" code="number2"/>\r\n    <key id="3" code="number3"/>\r\n    <key id="4" code="number4"/>\r\n    <key id="5" code="number5"/>\r\n    <key id="6" code="number6"/>\r\n    <key id="7" code="number7"/>\r\n    <key id="8" code="number8"/>\r\n    <key id="9" code="number9"/>\r\n    <key id="0" code="number0"/>\r\n    <key id="red" code="red"/>\r\n    <key id="green" code="green"/>\r\n    <key id="yellow" code="yellow"/>\r\n    <key id="blue" code="blue"/>\r\n    <key id="osd" code="osd"/>\r\n    <key id="osdLeft" code="osdleft"/>\r\n    <key id="osdrRight" code="osdright"/>\r\n    <key id="osdUp" code="osdup"/>\r\n    <key id="osdDown" code="osddown"/>\r\n    <key id="osdSelect" code="osdselect"/>\r\n    <key id="osdValuePlus" code="osdvalueplus"/>\r\n    <key id="osdValueMinus" code="osdvalueminus"/>\r\n  </device>\r\n\t<device id="denon_3808" name="Denon AVR" tpl="320x460:253:3380@3|1024x748:254:3384@3" icon="avr" controlport="23" tcptype="textnl">\r\n    <key id="volumeUp" code="MVUP"/>\r\n    <key id="volumeDown" code="MVDOWN"/>\r\n    <key id="mainZoneOn" code="ZMON"/>\r\n    <key id="mainZoneOff" code="ZMOFF"/>\r\n    <key id="muteOn" code="MUON"/>\r\n    <key id="muteOff" code="MUOFF"/>\r\n    <key id="INPUT_PHONO" code="SIPHONO"/>\r\n    <key id="INPUT_CD" code="SICD"/>\r\n    <key id="INPUT_TUNER" code="SITUNER"/>\r\n    <key id="INPUT_DVD" code="SIDVD"/>\r\n    <key id="INPUT_BD" code="SIBD"/>\r\n    <key id="INPUT_TV" code="SITV"/>\r\n    <key id="INPUT_SATCBL" code="SISAT/CBL"/>\r\n    <key id="INPUT_DVR" code="SIDVR"/>\r\n    <key id="INPUT_GAME" code="SIGAME"/>\r\n    <key id="INPUT_VAUX" code="SIV.AUX"/>\r\n    <key id="INPUT_DOCK" code="SIDOCK"/>\r\n    <key id="INPUT_NETUSB" code="SINET/USB"/>\r\n    <key id="INPUT_USB_IPOD" code="SIUSB/IPOD"/>\r\n    <key id="DIRECT" code="MSDIRECT"/>\r\n    <key id="PURE_DIRECT" code="MSPURE DIRECT"/>\r\n    <key id="STEREO" code="MSSTEREO"/>\r\n    <key id="STANDARD" code="MSSTANDARD"/>\r\n    <key id="DOLBY_DIGITAL" code="MSDOLBY DIGITAL"/>\r\n    <key id="DTS_SURROUND" code="MSDTS SURROUND"/>\r\n    <key id="SUPER_STADIUM" code="MSSUPER STADIUM"/>\r\n    <key id="ROCK_ARENA" code="MSROCK ARENA"/>\r\n    <key id="JAZZCLUB" code="MSJAZZ CLUB"/>\r\n    <key id="CLASSIC_CONCERT" code="MSCLASSIC CONCERT"/>\r\n    <key id="VIDEOGAME" code="MSVIDEO GAME"/>\r\n    <key id="zone2PowerOn" code="Z2ON"/>\r\n    <key id="zone2PowerOff" code="Z2OFF"/>\r\n    <key id="zone2VolumeUp" code="Z2UP"/>\r\n    <key id="zone2VolumeDown" code="Z2DOWN"/>\r\n    <key id="zone2MuteOn" code="Z2MUON"/>\r\n    <key id="zone2MuteOff" code="Z2MUOFF"/>\r\n    <key id="powerOn" code="PWON"/>\r\n    <key id="powerOff" code="PWSTANDBY"/>\r\n  </device>\r\n\t<device id="reelbox" name="Reelbox" udptype="textnl" controlport="2004">\r\n    <key id="channelDown" code="Channel- "/>\r\n    <key id="channelUp" code="Channel+ "/>\r\n    <key id="up" code="Up "/>\r\n    <key id="down" code="Down "/>\r\n    <key id="left" code="Left "/>\r\n    <key id="right" code="Right "/>\r\n    <key id="enter" code="Ok "/>\r\n    <key id="menu" code="Menu "/>\r\n    <key id="back" code="Back "/>\r\n    <key id="volumeDown" code="Volume- "/>\r\n    <key id="volumeUp" code="Volume+ "/>\r\n    <key id="mute" code="Mute "/>\r\n    <key id="play" code="Play "/>\r\n    <key id="pause" code="Pause "/>\r\n    <key id="stop" code="Stop "/>\r\n    <key id="record" code="Record "/>\r\n    <key id="rewind" code="FastRew "/>\r\n    <key id="fastForward" code="FastFwd "/>\r\n    <key id="eject" code="Eject "/>\r\n    <key id="DVB" code="DVB "/>\r\n    <key id="DVD" code="DVD "/>\r\n    <key id="PVR" code="PVR "/>\r\n    <key id="Reel" code="Reel "/>\r\n    <key id="teletext" code="TT "/>\r\n    <key id="pip" code="PiP "/>\r\n    <key id="aspect" code="Aspect "/>\r\n    <key id="help" code="Help "/>\r\n    <key id="info" code="Info "/>\r\n    <key id="search" code="Search "/>\r\n    <key id="audio" code="Audio "/>\r\n    <key id="setup" code="Setup "/>\r\n    <key id="timer" code="Timer "/>\r\n    <key id="greater" code="Greater "/>\r\n    <key id="1" code="1 "/>\r\n    <key id="2" code="2 "/>\r\n    <key id="3" code="3 "/>\r\n    <key id="4" code="4 "/>\r\n    <key id="5" code="5 "/>\r\n    <key id="6" code="6 "/>\r\n    <key id="7" code="7 "/>\r\n    <key id="8" code="8 "/>\r\n    <key id="9" code="9 "/>\r\n    <key id="0" code="0 "/>\r\n    <key id="red" code="Red "/>\r\n    <key id="green" code="Green "/>\r\n    <key id="yellow" code="Yellow "/>\r\n    <key id="blue" code="Blue "/>\r\n    <key id="powerOn" code="Startup "/>\r\n    <key id="powerOff" code="Poweroff "/>\r\n    <key id="standby" code="Standby "/>\r\n  </device>\r\n</deviceinfo>',m.aio.devicemanager.DeviceManager.prototype.init=function(e,n,i){if(e&&e.children){m.aio.devicemanager._configmanager=n;var a=this;require("async").each(e.children,function(e,n){a._loadTenant(e,n);},function(e){i(e);});}else i();},m.aio.devicemanager.DeviceManager.prototype.addTenant=function(e,n){this._loadTenant(e,n);},m.aio.devicemanager.DeviceManager.prototype.removeTenant=function(e,n){for(var i=-1,a=0;a<this.handlers.length;a++)if(this.handlers[a].tenant.index==e.index){i=a;break;}-1!=i&&this.handlers.splice(i,1),n();},m.aio.devicemanager.DeviceManager.prototype.register=function(e,n){if(!e)throw new Error("sys is invalid");if(!n)throw new Error("module name is invalid");this.modules[e]=n;},m.aio.devicemanager.DeviceManager.prototype.getModuleName=function(e){return e?this.modules[e]:null;},m.aio.devicemanager.DeviceManager.prototype.getModule=function(e){var n=this.getModuleName(e);return n?require("xnm.aio."+n+".js"):null;},m.aio.devicemanager.DeviceManager.prototype.getDeviceInfo=function(e){for(var n=0;n<this.handlers.length;n++){var i=this.handlers[n];if(i.tenant.index==e)return i.deviceinfo;}return null;},m.aio.devicemanager.DeviceManager.prototype.reloadTenant=function(e,n){for(var i=-1,a=0;a<this.handlers.length;a++){var r=this.handlers[a];if(r&&r.tenant&&r.tenant.index==e.index){i=a;break;}}-1!=i&&this.handlers.splice(i,1),this._loadTenant(e,n);},m.aio.devicemanager.DeviceManager.prototype.execute=function(e,n,i,a,r,o){for(var t=null,d=0;d<this.handlers.length;d++){var c=this.handlers[d];if(c.tenant&&c.tenant.index==n){t=c;break;}}t?t.execute(e,i,a,function(e,n){r(e,n);},o):r(new Error("no such tenant"));},m.aio.devicemanager.DeviceManager.prototype.batchModeEnd=function(e,n){for(var i=null,a=0;a<this.handlers.length;a++){var r=this.handlers[a];if(r.tenant&&r.tenant.index==e){i=r;break;}}i?i._save(n):callback(new Error("no such tenant"));},m.aio.devicemanager.DeviceManager.prototype.executeSync=function(e,n,i,a){for(var r=null,o=0;o<this.handlers.length;o++){var t=this.handlers[o];if(t.tenant&&t.tenant.index==n){r=t;break;}}if(!r)throw new Error("no such tenant");return r.executeSync(e,i,a);},m.aio.devicemanager.DeviceManager.prototype.deleteUnlicensed=function(e,n){for(var i=null,a=this,r=0;r<this.handlers.length;r++){var o=this.handlers[r];if(o.tenant&&o.tenant.index==e){i=o;break;}}i?m.aio.devicemanager._configmanager.trace("config/tenants/"+e,function(e,r){if(e)n&&n(e);else if(r.isAccessible()){var o=r.getRemotes();o&&0!=o.size()?(o=o.getChildren(),i.deleteUnlicensed(function(e,i){e?n&&n(e):o&&0!=o.length?require("async").each(o,function(e,n){a.saveRemoteWithDB(e,i,function(e){n(e);});},function(e){n&&n(e);}):n&&n();})):n&&n(null);}else n&&n(new Error("not permitted"));}):n(new Error("no such tenant"));},m.aio.devicemanager.DeviceManager.prototype.getDeviceDBForRemote=function(e,n){for(var i=null,a=0;a<this.handlers.length;a++){var r=this.handlers[a];if(r.tenant&&r.tenant.index==e){i=r;break;}}i?m.aio.devicemanager._configmanager.trace("config/tenants/"+e,function(e,a){e?n&&n(e):a.isAccessible()?i.deleteUnlicensed(function(e,i){n&&n(e,i);}):n&&n(new Error("not permitted"));}):n(new Error("no such tenant"));},m.aio.devicemanager.DeviceManager.prototype.getIntHandler=function(e){for(var n=0;n<this.handlers.length;n++){var i=this.handlers[n];if(i.tenant&&i.tenant.index==e)return i;}return null;},m.aio.devicemanager.DeviceManager.prototype.saveRemote=function(e,n){if(e.parent){var i=e.parent.parent;if(i){for(var a=null,r=0;r<this.handlers.length;r++){var o=this.handlers[r];if(o.tenant&&o.tenant.index==i.index){a=o;break;}}if(a){var t=this;a.deleteUnlicensed(function(i,a){i?n&&n(i):t.saveRemoteWithDB(e,a,function(e){n&&n(e);});});}else n(new Error("no such tenant"));}else n&&n(new Error("remote do not belong to any tenant"));}else n&&n(new Error("remote is isolated"));},m.aio.devicemanager.DeviceManager.prototype.saveRemoteWithDB=function(e,n,i){if(e.parent){var a=e.parent.parent;if(a){var r=a.getFolderPath();if(r){var o=e.getFolderPath(),t=require("fs"),d=require("path"),c=this,s=r+d.sep+m.aio.devicemanager.DeviceManager.DB,f=o+d.sep+m.aio.devicemanager.DeviceManager.DB;t.writeFile(f,JSON.stringify(n),function(e){e?i&&i(e):(s=r+d.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO,f=o+d.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO,c._copyFile(s,f,function(e){i&&i(e);}));});}else i&&i(new Error("invalid tenant folder"));}else i&&i(new Error("remote do not belong to any tenant"));}else i&&i(new Error("remote is isolated"));},m.aio.devicemanager.DeviceManager.prototype.clearRemoteDB=function(e,n){var i=require("fs-extra"),a=require("path"),r=e.getFolderPath()+a.sep+m.aio.devicemanager.DeviceManager.DB;i.remove(r,n);},m.aio.devicemanager.DeviceManager.prototype.prepareContentForWriting=function(e){return require("x.crypt").AES.encodeString(e,this.ml_v1_info());},m.aio.devicemanager.DeviceManager.prototype.removeAuthDataFromJSON=function(e){var n={};Array.isArray(e)&&(n=[]);var i=["accessToken","password","pwd","refreshToken","token","user","username"];for(var a in e){var r=e[a];null!==r&&"object"==_typeof(r)?n[a]=this.removeAuthDataFromJSON(r):i.indexOf(a)>=0?n[a]="":n[a]=r;}return n;},m.aio.devicemanager.DeviceManager.prototype.writeFileEncrypted=function(e,n,i){var a=require("fs"),r=require("x.crypt");try{n=r.AES.encodeString(n,this.ml_v1_info()),a.writeFile(e,n,function(e){i&&i(e);});}catch(e){i&&i(e);}},m.aio.devicemanager.DeviceManager.prototype._copyFile=function(e,n,i){var a=require("fs-extra");a.exists(e,function(r){r?a.copy(e,n,function(e){i&&i(e);}):i&&i();});},m.aio.devicemanager.DeviceManager.prototype._loadTenant=function(e,n){var i=this,a=require("path"),r=e.getFolderPath();if(r){var o=new m.aio.devicemanager.IntHandler(i,e,{devices:[],rooms:[],gateways:[]});this.handlers.push(o);var t=r+a.sep+m.aio.devicemanager.DeviceManager.DB,d=r+a.sep+m.aio.devicemanager.DeviceManager.DEVICE_INFO,c=require("fs-extra"),s=!1;c.existsSync(t+".enc")&&(t+=".enc",s=!0);var f=function f(){!function(e,n,i){var a=require("fs");a.exists(n,function(r){r?a.readFile(n,{encoding:"utf8"},function(n,a){n||a.length>0&&e.setDeviceInfo(a),i();}):function(e,n){require("fs").writeFile(e,m.aio.devicemanager.DeviceManager.DEFAULT_DEVICE_INFO,function(e){n(e);});}(n,function(r){r?i():a.readFile(n,{encoding:"utf8"},function(n,a){n||a.length>0&&e.setDeviceInfo(a),i();});});});}(o,d,function(){n&&n();});};!function(e,n,a){var r=require("fs");r.exists(n,function(o){o?r.readFile(n,{encoding:"utf8"},function(r,o){if(r)a();else{if(o.length>0)try{String(n).endsWith(".enc")&&(o=o.replace(/[\r\n]/g,""),o=require("x.crypt").AES.decodeString(o,i.ml_v1_info()));var t=JSON.parse(o);t&&(e.data=t,e.data.devices||(e.data.devices=[]),e._sort(e.data.devices),e.data.gateways||(e.data.gateways=[]),e._sort(e.data.gateways),e.data.rooms||(e.data.rooms=[]),e._sort(e.data.rooms));}catch(e){console.error(e);}a();}}):r.writeFile(n,"",function(){a();});});}(o,t,function(){s?f():o._save(function(){(function(){var e=a.join(r,"cloud"),n=a.join(r,"automation"),i=a.join(r,"remotes");if(c.existsSync(e))try{c.remove(e);}catch(e){console.error(e);}if(c.existsSync(n))try{!function(e){for(var n=c.readdirSync(e),i=0;i<n.length;i++){var r=n[i];if(c.statSync(a.join(e,r)).isDirectory()){var o=a.join(e,r,"db");c.existsSync(o)&&c.remove(o);}}}(n);}catch(e){console.error(e);}if(c.existsSync(i))try{!function(e){for(var n=c.readdirSync(e),i=0;i<n.length;i++){var r=n[i];if(c.statSync(a.join(e,r)).isDirectory()){var o=a.join(e,r,"device_db");c.existsSync(o)&&c.remove(o);}}}(i);}catch(e){console.error(e);}})(),f();});});}else n();},m.aio.devicemanager.DeviceManager.prototype.supportSmartWidget=function(e,n){if(!e||!e.info)return!1;var i=null;if(e.info.gateway&&n){var a=this.getIntHandler(n);if(a){var r=a.findGatewayWithIndex(e.info.gateway);r&&(i=r);}}return require("m.aio.smartwidget.js").supportSmartWidget(e.info,i?i.info:null);},m.aio.devicemanager.DeviceManager.prototype.applySmartWidgetFilter=function(e,n,i,a){var r,o=this.getIntHandler(e);if(!o)return(r=new Error("no such tenant with index:"+e)).code=500,void(a&&a(r));var t=o.findDeviceWithIndex(n);if(!t)return(r=new Error("can not read device with id:"+n)).code=500,void(a&&a(r));if(t.info){var d=o.findRoomWithIndex(t.room),c=null;d&&(c=d.name);var s=null;t.info.gateway&&o&&(s=o.findGatewayWithIndex(t.info.gateway));var f=require("m.aio.smartwidget.js"),m=JSON.parse(JSON.stringify(t)),l=f.applySmartWidgetFilter(t.info,s?s.info:null,i,{index:n,name:t.name,room:c});l&&(m.smartwidget=l),a&&a(null,m);}else a&&a(null,[]);},m.aio.devicemanager.DeviceManager.prototype.applySmartWidgetFilterForGateway=function(e,n,i,a){var r,o=this.getIntHandler(e);if(!o)return(r=new Error("no such tenant with index:"+e)).code=500,void(a&&a(r));var t=o.findGatewayWithIndex(n);if(!t)return(r=new Error("can not read device with id:"+n)).code=500,void(a&&a(r));if(t.info){var d=this.getModule(t.info.sys);if(d&&d.devicemanager&&d.devicemanager.applySmartWidgetFilterForGateway){var c=JSON.parse(JSON.stringify(t)),s=d.devicemanager.applySmartWidgetFilterForGateway(t.info,i,{index:n,name:t.name});s&&(c.smartwidget=s),a&&a(null,c);}else a&&a(null,[]);}else a&&a(null,[]);},m.aio.devicemanager.DeviceManager.prototype.ml_v1_info=function(){return require("x.crypt").SHA1("0cc6c6df12537fc79522a1ac15f1f592e93fdeb3");},m.aio.devicemanager.DeviceManager.prototype.toGeneralDevice=function(e,n,i,a){var r,o=this.getIntHandler(e);if(!o)return(r=new Error("no such tenant with index:"+e)).code=500,void(a&&a(r));var t=i?o.findDeviceWithIndexIngnoreLicense(n):o.findDeviceWithIndex(n);if(!t)return(r=new Error("can not read device with id:"+n)).code=500,void(a&&a(r));if(t.info){var d=this.getModule(t.info.sys);if(d&&d.devicemanager&&d.devicemanager.toGeneralDevice){var c=d.devicemanager.toGeneralDevice(t.info,o.deviceinfo);a&&a(null,c);}else a&&a(null,null);}else a&&a(null,null);},m.aio.devicemanager.DeviceManager.prototype.Handler=m.aio.devicemanager.IntHandler,m.aio.devicemanager.DeviceManager.prototype.Filter=m.aio.devicemanager.Filter,m.aio.devicemanager.Handler=m.aio.devicemanager.DeviceManager,"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.devicemanager.Handler());