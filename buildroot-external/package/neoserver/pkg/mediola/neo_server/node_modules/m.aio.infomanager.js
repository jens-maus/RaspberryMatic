var m=m||{};m.aio=m.aio||{};m.aio.infomanager=m.aio.infomanager||{};
m.aio.infomanager.Manager=function(){var y=-1,f={},v=[],C="webservice.mediola.com",z=443,F="/creatorneo/license/getlicensesummary",G="/creatorneo/license/getblocked2",H=["mcontrol","xs1","cloud_device"],q=["aio","hm","hue","harmony","instar","ip","telefunken","konine","contronics","7links","dlink","hama","foscam","edimax","ipsync","wemo","sonos","redeye","itach","irtrans","digitus","dmx4all","easysh","moehlenhoff","internorm","siegenia","miele","rwe","ez","vera","knx","synco","bub","rademacher","max",
"nueva","osram","netatmo","intertechno","brennenstuhl","spro","milight","aio_upgrade","hm_upgrade",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"ultimate","tado","denon","pioneer","yamaha","onkyo","marantz","doorbird","homewizard","rehau","fritz","qivicon","mobotix","ipcam","netatmo_welcome","yellowstone","samsung","esco","mydlink","orvibo","raumfeld","bose","axis","neoserver","nuki","warema","feller","enocean","zwave","tahoma","fibaro","zigbee","digitalstrom",
"mystrom","hautau","brelag","hm_ccu3","wir","iobroker","kopp","enoceanip","cloud_device","gealan","nanoleaf","shelly","selve","openhab","bosch","homekit"],R=["neo","neo2"],g=function(b,c){for(var a=0;a<b.length;a++)if(b[a]===c)return!0;return!1},w=function(b){var c=require("crypto"),a=new Buffer("fO4gAeDjh4HwO0D8+/9Bfw==","base64"),d=new Buffer("+ubtPBJR9uejkjXiN6c1Bg==","base64");c=c.createCipheriv("aes-128-cbc",a,d);c.setAutoPadding(!0);b=[c.update(b,"utf8")];b.push(c.final());return Buffer.concat(b).toString("base64")},
D=function(b){var c=require("crypto"),a=new Buffer("fO4gAeDjh4HwO0D8+/9Bfw==","base64"),d=new Buffer("+ubtPBJR9uejkjXiN6c1Bg==","base64");c=c.createDecipheriv("aes-128-cbc",a,d);c.setAutoPadding(!0);b=[c.update(new Buffer(b,"base64"))];b.push(c.final());b=Buffer.concat(b).toString("utf8");return JSON.parse(b)},I=function(b,c){var a={"aio@10":{full:0,upgrade:42},"hm@10":{full:1,upgrade:43}};if(c&&b&&0!==c.length)for(var d in a){var e=a[d];if(e){var k=c.indexOf(d);if(!(0>k)){var h=b.indexOf(e.upgrade);
0<=h?(c.splice(k,1),0>b.indexOf(e.full)&&(b.splice(h,1),b.push(e.full))):0<=b.indexOf(e.full)&&c.splice(k,1)}}}},L=function(b){for(var c=[],a=0;a<b.length;a++){var d=-1;for(var e=0;e<q.length;e++)if(q[e]==b[a]){d=e;break}-1!=d&&(g(c,d)||c.push(d))}return c},M=function(b,c){var a=[],d;for(d=0;d<b.length;d++)a.push(b[d]);for(d=0;d<c.length;d++)g(b,c[d])||a.push(c[d]);return a},S=function(b){var c="",a=require("https").request({host:C,port:z,path:G,method:"GET",timeout:2E4,headers:{"User-Agent":"mediola",
Connection:"close"}},function(d){d.setEncoding("utf8");d.on("data",function(e){c+=e});d.on("end",function(){b&&(200==d.statusCode?b(null,c):b(Error("equest failed:"+c)));b=null})});if(a.on&&"function"==typeof a.on)a.on("error",function(d){b&&b(d);b=null});a.setTimeout&&a.setTimeout(2E4);a.end()},N=function(b,c,a){S(function(d,e){if(d)a&&a(d);else{if(e){try{v=JSON.parse(e)}catch(k){}c&&c.updateBlockedLicenses(v,function(){});b&&v&&b.save("blocked",w(JSON.stringify(v)))}a&&a()}})},J=function(b,c,a){var d=
require("https");443!=z&&(d=require("http"));var e=2E4;a&&a.timeout&&(e=a.timeout);a={host:C,port:z,path:F,method:"POST",timeout:e,headers:{"User-Agent":"mediola",Connection:"close"}};m.aio.infomanager.IM._logger.log("trace","try to download info from "+a.host+":"+a.port);var k="";d=d.request(a,function(h){h.setEncoding("utf8");h.on("data",function(n){k+=n});h.on("end",function(){if(200==h.statusCode)m.aio.infomanager.IM._logger.log("trace","download info success"),c&&c(null,k);else{m.aio.infomanager.IM._logger.log("trace",
"download info failed:"+h.statusCode+" :"+k);var n=Error("request failed:"+k);n.code="http";c&&c(n)}c=null})});d.on("error",function(h){h.code="connection";m.aio.infomanager.IM._logger.log("trace","download info error:"+h.stack);c&&c(h);c=null});d.setTimeout(e,function(){m.aio.infomanager.IM._logger.log("trace","download info timeout");var h=Error("http timeout");h.code="timeout";c&&c(h);c=null});d.write(b);d.end()},K=function(b){b=D(b);var c={},a;for(a in b)if(b.hasOwnProperty(a)){var d=b[a],e={};
c[a]=e;e.feature=d.feature;e.blocked=d.blocked;e.skins=d.skins;e.sus_info=d.sus_info;e.sus_flatrate=d.sus_flatrate;e.codes={};if(d.codes)for(var k in d.codes)if(d.codes.hasOwnProperty(k)){var h=d.codes[k];e.codes[k]={};h.op&&(e.codes[k].op=D(h.op));e.codes[k].blocked=h.blocked}}return c},O=function(b,c,a){c.trace("config/tenants",function(d,e){if(d)a&&a(d);else if(e)if((d=e.getChildren())&&0!=d.length){e=[];for(var k=0;k<d.length;k++){var h=d[k];h&&h.license&&h.license.licenseTxt&&e.push(h.license.licenseTxt)}0==
e.length?a&&a():(d=e.join(":"),d=w(d),J(d,function(n,l){if(n)a&&a(n);else{if(l)try{var r=K(l),t;for(t in f)f.hasOwnProperty(t)&&r&&!r[t]&&(r[t]=f[t]);r&&(f=r);b&&f&&(m.aio.infomanager.IM._logger.log("trace","save pref"),b.save("info",w(JSON.stringify(f))))}catch(x){m.aio.infomanager.IM._logger.log("trace","decode info error:"+x.stack)}a&&a()}}))}else a&&a();else a&&a()})},P=function(b){if(!b||!b.valid)return[];var c=A(b),a=E(b),d=!1;b=b.version+":"+("normal"==b.type?0:1)+":"+b.id;f&&f[b]&&f[b].sus_info&&
(b=f[b].sus_info,b.hm&&b.hm.lite&&(d=!0));d?(d=c.indexOf(1),-1!=d&&c.splice(d,1)):I(c,a);d=[];if(g(c,63)){for(b=0;b<q.length;b++)42!=b&&43!=b&&109!=b&&d.push(q[b]);g(c,109)&&d.push(q[109])}else{for(b=0;b<c.length;b++)63!=c[b]&&(42==c[b]?g(c,0)||d.push(q[0]):43==c[b]?g(c,1)||d.push(q[1]):d.push(q[c[b]]));for(b=0;b<a.length;b++)c=a[b].split("@"),2==c.length&&g(q,c[0])&&10>=parseInt(c[1])&&d.push(c[0]+"_lite")}d=M(d,H);a=[];for(b=0;b<d.length;b++)d[b]&&a.push(d[b]);a&&-1!=a.indexOf("hm_ccu3")&&-1==a.indexOf("hm")&&
a.push("hm");return a},A=function(b){var c=b.version+":"+("normal"==b.type?0:1)+":"+b.id,a=[],d=[];if(f)for(var e in f)if(f.hasOwnProperty(e)&&e==c){var k=f[e].codes;if(k)for(var h in k)if(k.hasOwnProperty(h)&&k[h]&&k[h].op){var n=k[h],l=n.op;l.features&&0<l.features.length&&(n.blocked?a=a.concat(l.features):d=d.concat(l.features))}}a=L(a);d=L(d);if(b&&b.valid)if(c=[],e=b.features,0==b.version)for(b=0;b<e.length;b++)for(k=e.readUInt8(e.length-1-b),h=0;8>h;h++)k>>h&1&&c.push(8*b+h);else 1==b.version?
(b=e.readUInt8(7),b&1&&c.push(0),b>>1&1&&c.push(1),b=e.readUInt8(3),b>>2&1&&c.push(34),b>>3&1&&c.push(35),b>>6&1&&c.push(38),b>>7&1&&c.push(39),b=e.readUInt8(2),b&1&&c.push(40),b>>2&1&&c.push(42),b>>3&1&&c.push(43),b=e.readUInt8(0),b>>7&1&&c.push(63)):2==b.version&&(b=e.readUInt8(0),b>>7&1&&c.push(63));else c=[];b=[];for(e=0;e<c.length;e++)g(a,c[e])||b.push(c[e]);return c=M(b,d)},T=function(b){var c=m.aio.infomanager.IM.hasPartnerUltimate(),a=b.version+":"+("normal"==b.type?0:1)+":"+b.id,d=[];if(f&&
f[a]&&f[a].sus_info){d=[];b=f[a].sus_info;if(b.ultimate)return[63];for(var e in b)b.hasOwnProperty(e)&&(a=b[e],!a.lite&&a.deadline>=y||-1==a.deadline||c)&&(a=q.indexOf(e),d.push(a))}else e=A(b),-1!=e.indexOf(63)?d=e:c?d=e:1504223999E3>=y&&(d=e);return d},U=function(b){var c=m.aio.infomanager.IM.hasPartnerUltimate(),a=b.version+":"+("normal"==b.type?0:1)+":"+b.id,d=[];if(f&&f[a]&&f[a].sus_info){d=[];b=f[a].sus_info;for(var e in b)b.hasOwnProperty(e)&&(a=b[e],(a.lite&&a.deadline>=y||-1==a.deadline||
c)&&d.push(e+"@"+a.devCount))}else e=E(b),1504223999E3>=y?d=e:c&&(d=e);return d},V=function(b){var c=m.aio.infomanager.IM.hasPartnerUltimate(),a=b.version+":"+("normal"==b.type?0:1)+":"+b.id,d=null;if(f&&f[a]&&f[a].sus_info){d={};b=f[a].sus_info;a=!1;b.ultimate&&(a=!0);for(var e in b)if(b.hasOwnProperty(e)){var k=b[e];k.lite?(d[e+"_lite"]=k.deadline,c&&(d[e+"_lite"]=-1)):(d[e]="openhab"!=e?a?-1:k.deadline:k.deadline,c&&(d[e]=-1))}H.forEach(function(n){d[n]=-1})}else{var h=1504216799E3;e=A(b);g(e,
63)&&(h=-1);e=P(b);d={};e.forEach(function(n){-1!=H.indexOf(n)?d[n]=-1:(d[n]=h,c&&(d[n]=-1))})}d.hm_ccu3&&(d.hm||(d.hm=d.hm_ccu3),d.hm&&d.hm<d.hm_ccu3&&(d.hm=d.hm_ccu3));return d},E=function(b){var c=b.version+":"+("normal"==b.type?0:1)+":"+b.id;b=[];if(f)for(var a in f)if(f.hasOwnProperty(a)&&a==c){var d=f[a].codes;if(d)for(var e in d)if(d.hasOwnProperty(e)&&d[e]&&d[e].op){var k=d[e],h=k.op;h.features_lite&&0<h.features_lite.length&&(k.blocked||(b=b.concat(h.features_lite)))}}a=[];for(e=0;e<b.length;e++)g(a,
b[e])||a.push(b[e]);return a},p=function(){this._configmanager=this.preference=null;this._logger=require("x.logger.js").getLogger("m.aio.infomanager.Manager")};p.prototype.init=function(b,c,a,d){a&&(y=a);this._configmanager=c;if(b&&b.Preference){this.preference=b.Preference;if(c=b.Preference.read("info"))try{f=D(c)}catch(e){}if(b=b.Preference.read("blocked"))try{v=D(b)}catch(e){}}switch(process.env.CLOUD){case "local":C=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"localhost";z=8080;F="/webservice"+
F;G="/webservice"+G;break;case "dev":C=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"mediola-dev.elasticbeanstalk.com";z=80;break;default:C=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"webservice.mediola.com",z=443}d&&d()};p.prototype.retrieveInfo=function(b){var c=require("m.aio.configmanager.js"),a=this,d=2;O(this.preference,c,function(){setInterval(function(){O(a.preference,c)},9E5);d--;0==d&&(b&&b(),b=null)});N(this.preference,c,function(){setInterval(function(){N(a.preference,c)},9E5);d--;
0==d&&(b&&b(),b=null)})};p.prototype.permitSkin=function(b,c){if(!b||!c)return!1;var a=A(c);if(g(a,63)||g(R,b))return!0;c=c.version+":"+("normal"==c.type?0:1)+":"+c.id;return f&&f[c]&&f[c].skins?g(f[c].skins,b):!1};p.prototype.permitFeature=function(b,c,a,d,e,k){var h=function(t){switch(t){case "telefunken":return 6;case "konine":return 7;case "abus":return 0;case "7links":return 9;case "dlink":return 10;case "hama":return 11;case "foscam":return 12;case "instar":return 4;case "edimax":return 13;
case "nueva":return 35;case "digitus":return 20;case "doorbird":return 70;case "mobotix":return 75;case "generic":return 76;case "netatmo":return 77;case "axis":return 85;default:return-1}},n=function(t,x){if(!r||!t)return 0;for(var u=0;u<x.length;u++)if(x[u]&&0==x[u].indexOf(t))return parseInt(x[u].replace(t+"@",""));return 0};b=function(t,x,u){var Q=-1;if(u)for(var B=0;B<u.length&&(!u[B]||!u[B].info||u[B].info.sys!=t||(Q++,u[B].index!==x));B++);return Q};if(!a)return!1;if(-1==y){var l=A(a);var r=
E(a);if(g(l,63))return!0;I(l,r)}else if(l=T(a),r=U(a),g(l,63))return!0;a=0;switch(c.sys){case "mcontrol":case "xs1":case "virtualdevice":case "neoserver":case "cloudservice":return!0;case "hcgw":if(null!=c.ip&&"undefined"!=typeof c.ip)switch(c.vendor){case "brennenstuhl":a=39;break;case "intertechno":a=38;break;default:a=40}else{if(g(l,38)||g(l,39))return!0;a=40}break;case "netatmo":a=37;break;case "lightify":a=36;break;case "max":a=34;break;case "homepilot1":case "homepilot2":case "homepilot2v5":a=
33;break;case "orvibo_ir":switch(c.vendor){case "orvibo":a=82;break;default:a=35}break;case "orvibo_socket":a=82;break;case "execengine":a=8;break;case "siegenia":a=25;break;case "aio":if(c.gateway_vendor||null!=c.ip&&"undefined"!=typeof c.ip){if("KNX"==c.type)return g(l,30);switch(c.gateway_vendor){case "siegenia":a=25;break;case "internorm":a=24;break;case "nueva":a=35;break;case "brelag":a=98;break;case "wir":a=100;break;case "kopp":a=102;break;case "selve":a=108;break;default:if("EA"==c.version&&
g(l,24)||"E2"==c.version&&g(l,102)||"E7"==c.version&&g(l,108)||g(l,42)||g(l,90)||g(l,91)||g(l,94)||g(l,30))return!0;if(c=n(q[1],r))return d=b("aio",d,e),d<c;a=0}}else switch(c.type){case "CM":case "IV":a=108;break;case "IN":case "IW":a=24;break;case "SIAU":a=25;break;case "QA":a=80;break;case "ENOCEAN":if(k&&"aio"==k.sys&&k.version&&("C1"==k.version||"C2"==k.version||"CA"==k.version))return!0;a=90;break;case "ZWAVE2":a=91;break;case "KNX":a=30;break;case "ZIGBEE":a=94;break;case "BG":a=98;break;default:if(g(l,
24)||g(l,25)||g(l,35)||g(l,42)||g(l,98)||g(l,100)||g(l,102)||g(l,108)||n(q[0],r))return!0;a=0}break;case "hm":if(g(l,43)||g(l,99))return!0;if(c=n(q[1],r))return d=b("hm",d,e),d<c;a=1;break;case "hue":a=2;break;case "easyled":a=22;break;case "milight":case "milightv6":a=41;break;case "wifiled2":a=21;break;case "dmx4all":a=21;break;case "artnet":a=21;break;case "itach":a=18;break;case "irtrans":a=19;break;case "redeye":a=17;break;case "harmony":a=3;break;case "ip":a=5;break;case "edimax":a=13;break;
case "ipsync":a=14;break;case "wemo":a=15;break;case "sonos":a=16;break;case "alpha2":a=23;break;case "tado":a=64;break;case "denon":case "heos":a=65;break;case "pioneer":a=66;break;case "yamaha":a=67;break;case "onkyo":a=68;break;case "marantz":a=69;break;case "homewizard":a=71;break;case "neasmart":a=72;break;case "fritz":a=73;break;case "qivicon":a=74;break;case "rwe":a=27;break;case "cloudy":a=78;break;case "samsung_smarthome":a=79;break;case "dlink":a=81;break;case "raumfeld":a=83;break;case "bose":a=
84;break;case "nuki":a=87;break;case "warema":a=88;break;case "feller":a=89;break;case "tahoma":a=92;break;case "fibaro":a=93;break;case "digitalstrom":a=95;break;case "mystrom":a=96;break;case "hautau":a=97;break;case "ioBroker":a=101;break;case "dcgw":a=103;break;case "cloud_service":a=104;break;case "gealan":a=105;break;case "nanoleaf":a=106;break;case "shelly":a=107;break;case "openhab":a=109;break;case "homekit":a=111;break;case "cam":switch(c.type){case "jpeg":return!0;case "system":switch(c.manufacturer){case "7links":case "hama":if(g(l,
76))return!0}a=h(c.manufacturer);if(-1==a)return!1;break;case "custom":a=5;break;case null:case void 0:return!0}break;case "webpage":return!0;default:if(a=h(c.sys),-1==a)return!1}return g(l,a)};p.prototype.getFeatureModules=function(b){return P(b)};p.prototype.getFeatureModulesSUS=function(b){return-1==y?null:V(b)};p.prototype.getSUSFlatrate=function(b){b=b.version+":"+("normal"==b.type?0:1)+":"+b.id;b=f&&f[b]&&f[b].sus_flatrate?f[b].sus_flatrate:null;return b};p.prototype.getDeviceCount=function(b,
c){if(!c||!b)return-1;var a=A(c);c=E(c);I(a,c);if(g(a,63))return-1;switch(b.sys){case "aio":switch(b.type){case "IN":case "IW":return-1;case "SIAU":return-1;default:if(g(a,0)||g(a,24)||g(a,25)||g(a,35)||g(a,30))return-1;if(g(a,42))return 10;if(g(a,90)||g(a,91)||g(a,94)||g(a,98)||g(a,100)||g(a,102)||g(a,108))return-1;b=q[0]}break;case "hm":if(g(a,1)||g(a,99))return-1;if(g(a,43))return 10;b=q[1];break;default:return-1}if(!b)return-1;for(var d=a=0;d<c.length;d++){var e=c[d].split("@");2==e.length&&e[0]==
b&&(e=parseInt(e[1]),e>a&&(a=e))}return a};p.prototype.getDeviceCount2=function(b,c,a){b&&c?(c=require("m.aio.configmanager.js").LicenseManager.resolve(c))?(b=this.getDeviceCount(b,c),a&&a(null,b)):a&&a(Error("resolve license fail")):a&&a(Error("argument is null"))};p.prototype.updateLicense=function(b,c){if(b){var a=this;b=w(b);J(b,function(d,e){if(d)c&&c(d);else{if(e)try{var k=K(e),h;for(h in f)f.hasOwnProperty(h)&&k&&!k[h]&&(k[h]=f[h]);k&&(f=k);a.preference&&f&&a.preference.save("info",w(JSON.stringify(f)))}catch(n){}c&&
c()}})}else c&&c(Error("license is empty"))};p.prototype.updateCodeOld=function(b,c,a,d){if(b&&c&&a)if(c=require("m.aio.configmanager.js").LicenseManager.resolve(c)){c=c.version+":"+("normal"==c.type?0:1)+":"+c.id;f||(f={});f[c]||(f[c]={blocked:!1,codes:{}});f[c].codes||(f[c].codes={});f[c].codes[b]={op:D(a),blocked:!1};if(f[c].codes[b].op&&f[c].codes[b].op.skins&&0<f[c].codes[b].op.skins.length)for(f[c].skins||(f[c].skins=[]),b=f[c].codes[b].op.skins,a=0;a<b.length;a++)b[a]&&!g(f[c].skins,b[a])&&
f[c].skins.push(b[a]);this.preference&&this.preference.save("info",w(JSON.stringify(f)));d&&d()}else d&&d(Error("resolve license fail"));else d&&d(Error("argument is null"))};p.prototype.updateCode=function(b,c,a,d){if(c){b=w(c);var e=this;J(b,function(k,h){if(k)d&&d(k);else{if(h)try{var n=K(h),l;for(l in f)f.hasOwnProperty(l)&&n&&!n[l]&&(n[l]=f[l]);n&&(f=n);e.preference&&e.preference.save("info",w(JSON.stringify(f)))}catch(r){}d&&d()}})}else d&&d(Error("argument is null"))};p.prototype.updateDownloadSkin=
function(b,c,a){b&&c?(b=b.version+":"+("normal"==b.type?0:1)+":"+b.id,f||(f={}),f[b]||(f[b]={blocked:!1,codes:{},skins:[]}),f[b].skins||(f[b].skins=[]),g(f[b].skins,c)||f[b].skins.push(c),this.preference&&this.preference.save("info",w(JSON.stringify(f))),a&&a()):a&&a(Error("argument is null"))};p.prototype.isLicenseBlocked=function(b){if(!v)return!1;for(var c=0;c<v.length;c++)if(v[c].version==b.version&&v[c].id==b.id&&v[c].type==("test"==b.type?1:0))return!0;return!1};p.prototype.hasPartnerUltimate=
function(){var b=this._configmanager.getAllLicenses();if(!b||0==b.length)return!1;for(var c=0;c<b.length;c++){var a=b[c];if(a&&a.isPartnerUltimateLicense())return!0}return!1};return p}();m.aio.infomanager.IM=new m.aio.infomanager.Manager;"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.infomanager.IM);
