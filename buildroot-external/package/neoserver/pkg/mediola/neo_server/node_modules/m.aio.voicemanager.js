var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(e){var a=0;return function(){return a<e.length?{done:!1,value:e[a++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,a,b){e!=Array.prototype&&e!=Object.prototype&&(e[a]=b.value)};$jscomp.getGlobal=function(e){e=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,e];for(var a=0;a<e.length;++a){var b=e[a];if(b&&b.Math==Math)return b}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(e,a){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function e(b){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(b||"")+"_"+a++,b)}var a=0;return e}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.asyncIterator;e||(e=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};
$jscomp.iteratorFromArray=function(e,a){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var b=0,c={next:function(){if(b<e.length){var f=b++;return{value:a(f,e[f]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(e,a,b,c){if(a){b=$jscomp.global;e=e.split(".");for(c=0;c<e.length-1;c++){var f=e[c];f in b||(b[f]={});b=b[f]}e=e[e.length-1];c=b[e];a=a(c);a!=c&&null!=a&&$jscomp.defineProperty(b,e,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");$jscomp.owns=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)};
$jscomp.polyfill("Object.values",function(e){return e?e:function(a){var b=[],c;for(c in a)$jscomp.owns(a,c)&&b.push(a[c]);return b}},"es8","es3");var m=m||{};m.aio=m.aio||{};m.aio.voicemanager=m.aio.voicemanager||{};
m.aio.voicemanager.Util={clearHttpOptionForLog:function(e){try{var a=JSON.parse(JSON.stringify(e));a.auth&&(a.auth="xxxxxx:xxxxxx");if(a.headers)for(var b in headers)if(b&&"authorization"==b.toLocaleLowerCase()){var c=headers[b];if(c){var f=c.indexOf(" ");headers[b]=-1==f?"xxxxxx":c.substr(0,f)+" xxxxxx"}}return a}catch(d){return e}}};
m.aio.voicemanager.CloudConfigHandler=function(){var e=function(b,c){this._devicemanager=b;this._macromanager=c};e.prototype._getCloudDeviceConfig=function(b,c,a){var d=null;if(c){var f=require("xnm.aio.cloudservice.js").resolveGateway(c);f?this._getCloudDevicesFromDB(b,f,function(c,b){c?a&&a(c):b&&0!=b.length?(c=b.map(function(c){c=c.info;delete c.gateway;delete c.commands;delete c.states;return c}),f.toCloudDevice(c,function(c,d){if(c)c.code=40003,a&&a(c);else if(d&&0!=d.length){c={};for(var f=
0;f<b.length;f++){var h=b[f];if(h)for(var k=0;k<d.length;k++){var g=d[k];g&&(g.data&&h.info.module==g.data.mod&&h.info.connection==g.data.connection&&h.info.id==g.data.id?(g.name=h.__cloudref,c[h.__cloudref]=g):h.info.module==g.mod&&h.info.connection==g.connection&&h.info.id==g.id&&(g.name=h.__cloudref,g.data={mod:g.mod,connection:g.connection,id:g.id},delete g.mod,delete g.connection,delete g.id,c[h.__cloudref]=g))}}a&&a(null,c)}else a&&a(null,{})})):a&&a(null,{})}):(d=Error("cloud json invalid"),
d.code=4E4,a&&a(d))}else d=Error("cloud json invalid"),d.code=4E4,a&&a(d)};e.prototype._mergeConfig=function(b,c){var a={},d;if(b)for(d in b)a[d]=b[d];if(c)for(d in c)a[d]=c[d];return a};e.prototype._getCloudDevicesFromDB=function(b,c,a){var d=function(c,b){for(var a=0;a<b.length;a++){var d=b[a];if(d&&d.index==c)return d}return null},f=this,n=require("xnm.aio.cloudservice.js"),g={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",b,"device",g,function(h,
k){h?(h.code=40001,a&&a(h)):k&&0!=k.length?(g={filter:"prop","info.sys":"cloudservice"},f._devicemanager.execute("read",b,"gateway",g,function(h,g){h?(h.code=40001,a&&a(h)):g&&0!=g.length?f._devicemanager.execute("read",b,"room",null,function(b,f){if(b)b.code=40001,a&&a(b);else if(f&&0!=f.length){b=[];for(var h=0;h<k.length;h++){var l=k[h];if(l&&l.info&&l.info.gateway){var e=d(l.info.gateway,g);if(e&&e.info&&(e=n.resolveGateway(e.info))){if(!e.equalsTo(c)){b=Error("cloud device "+l.index+" belongs to another account");
b.code=40002;a&&a(b);return}var q=d(l.room,f);q&&(e=l.name,q=q.name,e=(q?q+" ":"")+(e?e:""),l.cloud.alias&&(e=l.cloud.alias),l=JSON.parse(JSON.stringify(l)),l.__cloudref=e,b.push(l))}}}a&&a(null,b)}else a&&a(null,[])}):a&&a(null,[])})):a&&a(null,[])})};e.prototype._getCloudEnabledDevices=function(b,c){this._devicemanager.execute("read",b,"device",{filter:"prop","cloud.enabled":!0},function(b,a){c&&c(b,a)})};e.prototype._getGateways=function(b,c){this._devicemanager.execute("read",b,"gateway",null,
function(b,a){c&&c(b,a)})};e.prototype._getRooms=function(b,c){this._devicemanager.execute("read",b,"room",null,function(b,a){c&&c(b,a)})};e.prototype._getGatewayInfo=function(b,c){if(b)if("aio"!=b.sys&&"neoserver"!=b.sys)c&&c(Error("gateway type invalid"));else{var a=this,d=require("xnm.aio.gateway.js");if("neoserver"==b.sys){b=JSON.parse(JSON.stringify(b));b.sys="aio";b.version="EA";var k=d.resolveGateway(b,!0)}else k=d.resolveGateway(b);k?d.Admin.getGatewaySID(k,function(f,g){f?(a._logger.log("warn",
"get gateway sid error:"+f.message),f.code="50001",f.message="get gateway sid error:"+f.message,c&&c(f)):g?b.password?d.Admin.V5.getInfo(k,function(d,f){d?(a._logger.log("warn","get gateway info error:"+d.message),d.message="get gateway info error:"+d.message,d.code="50101",c&&c(d)):f&&f.server?!f.cfg||parseInt(f.cfg,16)&64?(a._logger.log("warn","gateway cloud server is deactivated"),d=Error("gateway cloud server is deactivated"),d.code="50103",c&&c(d)):a._getAccessToken(f.server,g,b.password,!1,
function(d,h){d?(d=Error("get accesss token error:"+d.message),d.code="50003",c&&c(d)):h?c&&c(null,h,f.server,g):a._getAccessToken(f.server,g,b.password,!0,function(b,a){b?(b=Error("generate accesss token error:"+b.message),b.code="50004",c&&c(b)):a?c&&c(null,a,f.server,g):c&&c(Error("access token empty"))})}):(a._logger.log("warn","gateway has no cloud server"),d=Error("gateway has no cloud server"),d.code="50102",c&&c(d))}):(f=Error("gateway has no password"),f.code="50002",c&&c(f)):(f=Error("gateway has no sid"),
f.code="50002",c&&c(f))}):c&&c(Error("gateway json invalid"))}else c&&c(Error("gateway json is null"))};e.prototype._getAccessToken=function(b,c,a,d,k){b=this._parseCCS(b);var f=b.port;"https"==b.protocol&&80==f&&(f=443);c={host:b.host,port:f,path:"/getAccessToken?sid="+c,method:"GET",timeout:3E4,auth:"user:"+a,user:"user",password:a,headers:{Authorization:"Basic "+(new Buffer("user:"+a)).toString("base64")}};d&&(c.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(c)));
var g=this,h=require(b.protocol).request(c,function(b){b.setEncoding("utf8");var c="";b.on("data",function(b){c+=b});b.on("end",function(){if(200==b.statusCode){g._logger.log("trace","get access token reponse:"+c);try{var a=JSON.parse(c);a.XC_ERR?k&&k(Error(a.XC_ERR.msg)):a.XC_SUC?k&&k(null,a.XC_SUC.at):k&&k(Error("invalid response"))}catch(r){k&&k(r)}}else g._logger.log("warn","get access token error +"+b.statusCode+":"+c),k&&k(Error("http response:"+b.statusCode))})});if(h.on)h.on("error",function(b){g._logger.log("warn",
"get access token error:"+b.message);k&&k(b);k=null});h.setTimeout&&h.setTimeout(5E3,function(){h.abort();g._logger.log("warn","get access token timeout");k&&k(Error("http timeout"));k=null});h.end()};e.prototype._parseCCS=function(b){var c=b.indexOf(":");if(-1==c)return{protocol:"https",host:b,port:443};var a=b.substr(0,c);b=b.substr(c+1);8080==b?b=8443:80==b&&(b=443);return{protocol:"https",host:a,port:b}};var a=function(b,c){e.call(this,b,c);this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.V5ConfigHandler");
this._targetGatewayJSON=null;this._gatewayDetail={};this._currentMacroGatewayIndex=this._tenantIdx=null};a.prototype=new e;a.prototype.constructor=a;a.prototype.setTargetGateway=function(b){this._targetGatewayJSON=b};a.prototype.exportConfig=function(b,c,a){var d=this;this._gatewayDetail={};this._tenantIdx=b;this._currentMacroGatewayIndex=null;this._getCloudDeviceConfig(b,c,function(c,f){c?a&&a(c):d._getGatewayDeviceConfig(b,function(c,h){c?a&&a(c):d._getMacrosConfig(b,function(b,c){b?a&&a(b):(b=
d._mergeConfig(f,h),b=d._mergeConfig(c,b),a&&a(null,b))})})})};a.prototype._isSameAsTargetGateway=function(b){return this._targetGatewayJSON?b.ip==this._targetGatewayJSON.ip&&b.sid==this._targetGatewayJSON.sid:!1};a.prototype._getGatewayDeviceConfig=function(b,c){var a=function(b,c){if(!c||0==c.length)return null;for(var a=c.length;a--;){var d=c[a];if(d&&d.index==b)return d}return null},d=this;this._getDevicesDetail(b,function(b,f){if(b)c&&c(b);else{var g=f.devices,h=f.gateways,k=f.rooms,e={};for(b=
0;b<h.length;b++)(f=h[b])&&f.info&&"aio"==f.info.sys&&f.info.version&&!("C"!=f.info.version.charAt(0)&&"E"!=f.info.version.charAt(0)||"EA"==f.info.version||d._targetGatewayJSON&&!d._isSameAsTargetGateway(f.info))&&(e[f.index]=f);0==Object.keys(e)?c&&c(null,{}):d._getGatewaysDetail(Object.values(e),function(b){if(b)c&&c(b);else if(g&&0!=g.length){for(var f=[],l=0;l<g.length;l++)if((b=g[l])&&b.info&&"aio"==b.info.sys&&b.info.gateway){var n=a(b.info.gateway,h);if(n&&e[b.info.gateway]){var q=a(b.room,
k);f.push({device:b,gateway:n,room:q})}}if(0==f.length)c&&c(null,{});else{var p={};l=0;var x=function(b,a){!b&&a&&(p=d._mergeConfig(p,a));l++;l<f.length?d._genDeviceConfig(f[l].device,f[l].gateway,f[l].room,x):c&&c(null,p)};d._genDeviceConfig(f[l].device,f[l].gateway,f[l].room,x)}}else c&&c(null,{})})}})};a.prototype._genDeviceConfig=function(b,c,a,d){if(b&&b.info&&b.info.sys)if(c&&c.index){var f=this._gatewayDetail[c.index];if(f){var e=b.info.sys,g=this._devicemanager.getModule(e);g&&g.devicemanager&&
g.devicemanager.toGeneralDevice?(e=g.devicemanager.toGeneralDevice(b.info,null,"v5"))?(e.name=this._genDeviceName(b,a),e.local="http://"+c.info.ip+(c.info.port?":"+c.info.port:""),e.baseurl=this._genBaseUrl(f),e.data||(e.data={}),e.data.sid=f.sid,b={},b[e.name]=e,d&&d(null,b)):d&&d(null,null):d&&d(Error("sys "+e+" can not be convert to general device"))}else d&&d(Error("no gateway detail info"))}else d&&d(Error("invalid gateway json"));else d&&d(Error("invalid device json"))};a.prototype._genDeviceName=
function(b,c){if(b.cloud&&b.cloud.alias)return b.cloud.alias;b=b.name;c=c.name;return b?c?c+" "+b:b:c};a.prototype._genBaseUrl=function(b){var c=this._parseCCS(b.ccs);return c.protocol+"://"+c.host+"/rapi/"+b.token};a.prototype._getDevicesDetail=function(b,c){var a=this;this._getCloudEnabledDevices(b,function(d,f){d?c&&c(d):a._getGateways(b,function(d,g){d?c&&c(d):a._getRooms(b,function(b,a){c&&c(b,{devices:f,gateways:g,rooms:a})})})})};a.prototype._getGatewaysDetail=function(b,a){var c=this,d=0,
e=function(f,g,h,k){f?a&&a(f):(c._gatewayDetail[b[d].index]={sid:k,ccs:h,token:g},d++,d<b.length?c._getGatewayInfo(b[d].info,e):a&&a())};c._getGatewayInfo(b[d].info,e)};a.prototype._getMacrosConfig=function(b,a){var c=this;this._macromanager.execute(b,"read",null,null,null,function(b,f){if(b)a&&a(b);else if(f&&f.groups&&0!=f.groups.length){var d={};for(b=0;b<f.groups.length;b++){var g=f.groups[b];if(g&&g.macros&&0<g.macros.length){var h=0,e=function(b,a,f){!b&&a&&f&&(d[a]=f);h++;h<g.macros.length&&
c._getMacroConfig(g,g.macros[h],e)};c._getMacroConfig(g,g.macros[h],e)}}a&&a(null,d)}else a&&a(null,{})})};a.prototype._getMacroConfig=function(b,a,f){if(a&&a.cloud&&a.cloud.enabled){var c=b.name+" "+a.name;a.cloud.alias&&(c=a.cloud.alias);var e={name:c,type:"scene",commands:{on:{type:"POST",url:null,data:[]}}};this._currentMacroGatewayIndex=null;var n=this;if(a.commands&&0<a.commands.length){var g=0,h=function(b,d,k){!b&&d&&e.commands.on.data.push(d);g++;g<a.commands.length?n._convertMacroCommand(a.commands[g],
h):(b=n._gatewayDetail[n._currentMacroGatewayIndex])?(e.commands.on.url=n._genBaseUrl(b)+"/macro",f&&f(null,c,e)):f&&f(Error("no main gateway"))};this._convertMacroCommand(a.commands[g],h)}}else f&&f(null,null,null)};a.prototype._convertMacroCommand=function(b,a){if(b&&b.classid)switch(b.classid){case "sleep":a(null,{P:b.time});break;case "command":if(!b.action||!b.action.device){a(Error("invalid macro device command"));break}this._convertMacroDeviceCommand(b,a);break;default:a(Error("unknown macro command"))}else a(Error("invalid macro command"))};
a.prototype._convertMacroDeviceCommand=function(b,a){var c=this;this._devicemanager.execute("read",this._tenantIdx,"device",{filter:"prop",index:b.action.device.index},function(d,f){if(d)a(d);else if(f&&0!=f.length){var e=f[0];e&&e.info&&e.info.sys?"aio"==e.info.sys?c._devicemanager.execute("read",c._tenantIdx,"gateway",{filter:"prop",index:e.info.gateway},function(d,f){if(d)a(d);else if(f&&0!=f.length)if((d=f[0])&&d.info&&d.index)if(c._gatewayDetail[d.index]&&!c._currentMacroGatewayIndex&&(c._currentMacroGatewayIndex=
d.index),f=require("xnm.aio.gateway.js").devicemanager.getSystem(e.info,d.info)){var h={value:b.action.value,ext:b.action.ext};if(f.buildQuery)if(f=f.buildQuery(d.info,e.info,h)){h={};if("SendGenericCmd"==f.XC_FNC){var g="/cmd?XC_FNC=SendGenericCmd&id="+f.id;if(f.data)for(var k in f.data)g+="&"+k+"="+(null==f.data[k]||void 0==f.data[k]?"":encodeURIComponent(f.data[k]))}else if("/api/command"==f.fnc)g="/api/command?json=",f.data&&(g+=encodeURIComponent(JSON.stringify(f.data)));else for(k in g="/cmd?",
f)g+="&"+k+"="+(null==f[k]||void 0==f[k]?"":encodeURIComponent(f[k]));d.index==c._currentMacroGatewayIndex?h.C=g:h.A={host:d.info.ip,cmd:g};a(null,h)}else a(Error("invalid device command"));else a(Error("system do not support command"))}else a(Error("unknown device type"));else a(Error("invalid gateway json"));else a(Error("no such gateway"))}):a(null,null):a(Error("invalid device json"))}else a(Error("no such device"))})};return{V5:a}}();
m.aio.voicemanager.AlexaHandler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Cloud");this._customMap=null};e.LANG=["en","de"];e.MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],up:["up","up"],down:["down","down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],dimup:["up","up"],dimdown:["down","down"],dimto:["value","value"],"move up":["up","up"],"move down":["down","down"],"move to":["value","value"],moveup:["up",
"up"],movedown:["down","down"],moveto:["value","value"],stop:["off","off"],brightness:["value","value"],"brightness up":["up","up"],"brightness down":["down","down"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set temperature":["value","value"],temperature:["value","value"],"mode auto":["auto","auto"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],auto:["auto","auto"],"mode manu":["manu","manu"],"set manual mode":["manu","manu"],
"manu mode":["manu","manu"],manu:["manu","manu"],"mode boost":["boost","boost"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],boost:["boost","boost"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],mode:["mode","mode"],"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off",
"off"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"],"volume to":["value","value"]};e.HM_MAP={"short press":["short press","kurz dr\u00fccken"],"long press":["long press","lange dr\u00fccken"],"set value":["value","value"],red:["red","rot"],green:["green","gr\u00fcn"],orange:["orange","orange"],on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"move up":["up",
"up"],"move down":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"set manual mode":["manu","manu"],"set manu mode":["manu","manu"],"set boost mode":["boost","boost"],"set comfort mode":["comfort",
"komfort"],"lamella up":["lamella up","lamella up"],"lamella down":["lamella down","lamella down"],"lamella to":["lamella to","lamella to"]};e.AIO_MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"mode auto":["auto","auto"],"mode manu":["manu","manu"],"mode toggle":["toggle","toggle"],up:["up","up"],down:["down","down"],"up step bit":["step up","step up"],"down step bit":["step down","step down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"dim off":["off",
"off"],Auf:["up","up"],Ab:["down","down"],Stop:["off","off"],"move up":["up","up"],"move down":["down","down"],"move in":["up","up"],"move out":["down","down"],"level up":["up","up"],"level down":["down","down"],"start dim":["up","up"],"stop dim":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],close:["close","schlie\u00dfen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],
"temperature up":["up","up"],"temperature down":["down","down"],"set temperature":["value","value"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],"boost off":["boost off","boost aus"],"heater on":["heater on","heizung an"],"heater off":["heater off","heizung aus"],"led on":["led on","led an"],"led off":["led off",
"led aus"],"chime on":["chime on","chime an"],"chime off":["chime off","chime aus"],"panic alarm on":["panic on","panic an"],"panic alarm off":["panic off","panic aus"],disarmed:["disarm","entsch\u00e4rfen"],"all armed":["arm","scharf schalten"],"lamella up":["lamella up","lamella hoch"],"lamella down":["lamella down","lamella runter"],"lamella step up":["lamella step up","lamella step up"],"lamella step down":["lamella step down","lamella step down"],"lamella to":["lamella to","lamella to"],lamella:["lamella to",
"lamella to"],"tilt to":["lamella to","lamella to"],"preset position":["position to","position to"],activate:["on","on"],deactivate:["off","off"],A:["off","off"],B:["off","off"],C:["off","off"],"do scene":["do scene","scene starten"],brightness:["value","value"],color:["color","farblich"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],position:["value",
"value"],"position 1":["position 1","position 1"],"position 2":["position 2","position 2"],"brightness up":["up","up"],"brightness down":["down","down"],"set value":["value","value"]};e.SONOS_MAP={play:["play","play"],pause:["pause","pause"],stop:["off","off"],previous:["previous","previous"],next:["next","next"],"shuffle on":["shuffle on","shuffle on"],"shuffle off":["shuffle off","shuffle off"],"repeat off":["repeat off","repeat off"],"repeat all":["repeat all","repeat all"],"repeat one":["repeat one",
"repeat one"],"group volume":["value","value"],"group volume up":["up","up"],"group volume down":["down","down"],"group mute":["mute","mute"],"group unmute":["unmute","unmute"],volume:["value","value"],"volume up":["up","up"],"volume down":["down","down"],mute:["mute","mute"],unmute:["unmute","unmute"]};e.HUE_MAP={"color temperature":["color temperature","color temperatur"]};e.MILIGHT_MAP={"disco speed up":["faster","schneller"],"disco speed down":["slower","langsamer"],"speed up":["faster","schneller"],
"speed down":["slower","langsamer"],"mode up":["next mode","n\u00e4chste mode"],"mode down":["previous mode","vorherige mode"],"full brightness":["max","max"],"warm white up":["warmer","w\u00e4rmer"],"cool white up":["cooler","k\u00e4lter"],"max brightness":["max","max"],"night mode":["night mode","nacht mode"],"night light on":["night mode","nacht mode"],warmer:["warmer","w\u00e4rmer"],cooler:["cooler","k\u00e4lter"]};e.OSRAM_MAP={"color temperature":["color temperature","color temperatur"],"do scene":["scene",
"szene"]};e.HARMONY_MAP={"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],stop:["stop","stop"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"]};e.AV_MAP={stop:["stop","stop"]};e.TADO_MAP={"set manu temperature":["value","value"],manu:["value","value"]};e.NETATMO_MAP={manu:["value","value"]};e.FIBAROHC_MAP={"set value":["value","value"]};e.REMOTE_SERVER="https://cloud.mediola.com";e.prototype._getAccessToken=
function(a,b,c,f,d){a={host:require("url").parse("https://"+a).hostname,port:443,path:"/getAccessToken?sid="+b,method:"GET",timeout:3E4,auth:"user:"+c,user:"user",password:c,headers:{Authorization:"Basic "+(new Buffer("user:"+c)).toString("base64")}};f&&(a.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(a)));var e=this,n=require("https").request(a,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=
a});a.on("end",function(){if(200==a.statusCode){e._logger.log("trace","get access token reponse:"+b);try{var c=JSON.parse(b);c.XC_ERR?d&&d(Error(c.XC_ERR.msg)):c.XC_SUC?d&&d(null,c.XC_SUC.at):d&&d(Error("invalid response"))}catch(q){d&&d(q)}}else e._logger.log("warn","get access token error +"+a.statusCode+":"+b),d&&d(Error("http response:"+a.statusCode))})});if(n.on)n.on("error",function(a){e._logger.log("warn","get access token error:"+a.message);d&&d(a);d=null});n.setTimeout&&n.setTimeout(5E3,
function(){n.abort();e._logger.log("warn","get access token timeout");d&&d(Error("http timeout"));d=null});n.end()};e.prototype._processHMCommands=function(a,b,c){return this._processCommandsFromMap(e.HM_MAP,a,b,c)};e.prototype._processAIOCommands=function(a,b,c){return this._processCommandsFromMap(e.AIO_MAP,a,b,c)};e.prototype._processSonosCommands=function(a,b,c){return this._processCommandsFromMap(e.SONOS_MAP,a,b,c)};e.prototype._processHueCommands=function(a,b,c){return this._processCommandsFromMap(e.HUE_MAP,
a,b,c)};e.prototype._processMilightCommands=function(a,b,c,f){return this._processCommandsFromMap(e.MILIGHT_MAP,a,b,c,f)};e.prototype._processOsramCommands=function(a,b,c){return this._processCommandsFromMap(e.OSRAM_MAP,a,b,c)};e.prototype._processHarmonyCommands=function(a,b,c,f){return this._processCommandsFromMap(e.HARMONY_MAP,a,b,c,f)};e.prototype._processMcontrolCommands=function(a,b,c){if(a&&a.info&&a.info.command){var f=JSON.parse(JSON.stringify(a.info.command));a.info.command=f;a.info.command.push({type:"enum",
name:"on",ref:{value:"do",ext:"on"}});a.info.command.push({type:"enum",name:"off",ref:{value:"do",ext:"off"}});a.info.command.push({type:"enum",name:"up",ref:{value:"do",ext:"up"}});a.info.command.push({type:"enum",name:"down",ref:{value:"do",ext:"down"}});a.info.command.push({type:"int",name:"move to",ref:{value:"setInt",ext:"%d"}})}return this._processCommandsFromMap(null,a,b,c)};e.prototype._processFibaroHCCommands=function(a,b,c){if(c&&"blind"==c.type&&a&&a.info&&a.info.command){for(var f=JSON.parse(JSON.stringify(a.info.command)),
d=0;d<f.length;d++){var k=f[d];switch(k.name){case "open":k.name="up";break;case "close":k.name="down";break;case "up":k.name="step up";break;case "down":k.name="step down";break;case "stop":k.name="off"}}a.info.command=f}return this._processCommandsFromMap(e.FIBAROHC_MAP,a,b,c)};e.prototype._processAVCommands=function(a,b,c,f){return this._processCommandsFromMap(e.AV_MAP,a,b,c,f)};e.prototype._processTadoCommands=function(a,b,c){return this._processCommandsFromMap(e.TADO_MAP,a,b,c)};e.prototype._processNetatmoCommands=
function(a,b,c){return this._processCommandsFromMap(e.NETATMO_MAP,a,b,c)};e.prototype._processCommandsFromMap=function(a,b,c,f,d){c||(c="de");c=c.toLowerCase();for(var k={},n=e.LANG.indexOf(c),g=0;g<b.info.command.length;g++){var h=b.info.command[g];if("string"!=h.type||"aio"==b.info.sys&&"STRING"==b.info.type)if("root"==h.type)this._processRootCommandsFromMap(k,h,a,b,c,f,d);else{var l={type:"POST",url:"/cmd",original:h.name,data:{XC_FNC:"SendRM",device:b.index,command:JSON.parse(JSON.stringify(h.ref))}},
q=h.name.toLowerCase(),p=e.MAP[q]?e.MAP[q][n]:null;(q=a&&a[q]?a[q][n]:null)&&(p=q);var r=null;q=b.info.sys;if(this._customMap&&q&&this._customMap[q]){var t=this._customMap[q];r=t[h.name]?t[h.name][n]:null}r&&(p=r);if("%d"==h.ref.ext||"%f"==h.ref.ext||"%s"==h.ref.ext)l.data.command.ext="{val}","%f"==h.ref.ext&&(l["float"]=1),h.ref.extMeta&&(r=h.ref.extMeta.indexOf("-",1),-1!=r&&(q=parseFloat(h.ref.extMeta.substr(0,r)),r=parseFloat(h.ref.extMeta.substr(r+1)),l.min=q,l.max=r)),h.ref.scale&&(l.step=parseFloat(h.ref.scale)),
p||(p=h.name),"value"==p?k[p]=l:(f&&!f.values&&(f.values={}),f&&f.values&&(f.values[p]=l));else if("%e"==h.ref.ext){if(p||(p=h.name),h.ref.extMeta&&0<h.ref.extMeta.length)for(r=0;r<h.ref.extMeta.length;r++){var u=JSON.parse(JSON.stringify(l));u.data.command.ext=h.ref.extMeta[r];u.original+=" "+h.ref.extMeta[r];var v=p+" "+h.ref.extMeta[r];this._customMap&&q&&this._customMap[q]&&(t=this._customMap[q],(t=t[u.original]?t[u.original][n]:null)&&(v=t));k[v]=u}}else"rgb"==h.type||"rgbw"==h.type?(l=JSON.parse(JSON.stringify(l)),
l.data.command.ext="FF0000",k[e.MAP.red[n]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FF00FF",k[e.MAP.purple[n]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="0000FF",k[e.MAP.blue[n]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="00FFFF",k[e.MAP.cyan[n]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="00FF00",k[e.MAP.green[n]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FFFF00",k[e.MAP.yellow[n]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FF8C00",
k[e.MAP.orange[n]]=l,"rgbw"==h.type&&(l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FFFFFF",k[e.MAP.white[n]]=l)):(p||(p=h.name),k[p]=l,r&&(l.mappedCustom=!0))}}return k};e.prototype._processRootCommandsFromMap=function(a,b,c,f,d,k,n){d||(d="de");d=d.toLowerCase();d=e.LANG.indexOf(d);if(b&&b.value&&b.children&&0!=b.children.length){if("mainzone"!=b.value&&"global"!=b.value){a=k.name+" "+b.name;var g={name:a,type:k.type,sys:k.sys,baseurl:k.baseurl,commands:{}};n[a]=g;a=g.commands}for(n=0;n<b.children.length;n++)if(g=
b.children[n],("string"!=g.type||"aio"==f.info.sys&&"STRING"==f.info.type)&&"root"!=g.type){var h={type:"POST",url:"/cmd",original:g.name,data:{XC_FNC:"SendRM",device:f.index,command:JSON.parse(JSON.stringify(g.ref))}};h.data.command.path=[b.value];var l=g.name.toLowerCase(),q=e.MAP[l]?e.MAP[l][d]:null;(l=c&&c[l]?c[l][d]:null)&&(q=l);var p=null;l=f.info.sys;if(this._customMap&&l&&this._customMap[l]){var r=this._customMap[l];p=r[g.name]?r[g.name][d]:null}p&&(q=p);if("%d"==g.ref.ext||"%f"==g.ref.ext||
"%s"==g.ref.ext)h.data.command.ext="{val}","%f"==g.ref.ext&&(h["float"]=1),g.ref.extMeta&&(p=g.ref.extMeta.indexOf("-",1),-1!=p&&(l=parseFloat(g.ref.extMeta.substr(0,p)),p=parseFloat(g.ref.extMeta.substr(p+1)),h.min=l,h.max=p)),g.ref.scale&&(h.step=parseFloat(g.ref.scale)),q||(q=g.name),"value"!=q&&(k&&!k.values&&(k.values={}),k&&k.values&&(k.values[q]=h));else if("%e"==g.ref.ext){if(q||(q=g.name),g.ref.extMeta&&0<g.ref.extMeta.length)for(p=0;p<g.ref.extMeta.length;p++){var t=JSON.parse(JSON.stringify(h));
t.data.command.ext=g.ref.extMeta[p];t.original+=" "+g.ref.extMeta[p];var u=q+" "+g.ref.extMeta[p];this._customMap&&l&&this._customMap[l]&&(r=this._customMap[l],(r=r[t.original]?r[t.original][d]:null)&&(u=r));a[u]=t}}else"rgb"==g.type||"rgbw"==g.type?(h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FF0000",a[e.MAP.red[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FF00FF",a[e.MAP.purple[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="0000FF",a[e.MAP.blue[d]]=h,h=JSON.parse(JSON.stringify(h)),
h.data.command.ext="00FFFF",a[e.MAP.cyan[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="00FF00",a[e.MAP.green[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FFFF00",a[e.MAP.yellow[d]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FF8C00",a[e.MAP.orange[d]]=h,"rgbw"==g.type&&(h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FFFFFF",a[e.MAP.white[d]]=h)):(q||(q=g.name),a[q]=h,p&&(h.mappedCustom=!0))}return a}};e.prototype._isDeviceHeater=function(a){var b="HM-CC-RT-DN;HM-CC-RT-DN-BoM;HM-CC-TC;ZEL STG RM FWT;HM-TC-IT-WM-W-EU;HMIP-WTH;HmIP-WTH-2;HmIP-WTH-B;HMIP-eTRV;HmIP-eTRV-2;HmIP-eTRV-B;HmIP-eTRV-B1;HmIP-STHD;HmIP-STH;HmIP-BWTH;HmIP-BWTH24;HM-CC-VG-1;HmIP-HEATING;HmIPW-STHD;HmIPW-STH;HmIPW-WTH".split(";"),
c="heater thermostat wallthermo wallthermostat ip_heater ip_wallthermo ip_wallthermo2".split(" ");if(!a||!a.info)return!1;a=a.info;if("hm"==a.sys){if(-1!=b.indexOf(a.type))return!0}else if("aio"==a.sys)if("HM"==a.type){if(-1!=c.indexOf(a.data))return!0}else{if("FHT80b"==a.type)return!0}else if("max"==a.sys){if(1==a.type||2==a.type||3==a.type)return!0}else if("tado"==a.sys||"netatmo"==a.sys&&"NATherm1"==a.type)return!0;return!1};e.prototype._isDeviceScene=function(a){return a&&a.info&&"hm"==a.info.sys?
"Prog"==a.info.type:!1};e.prototype._getDeviceCatagory=function(a){if(!a||!a.info)return null;if(this._isDeviceHeater(a))return"heater";if(this._isDeviceScene(a))return"scene";if(!a.info.command)return null;if("fibaro"==a.info.sys)return this._getFibaroHCDeviceCatagory(a);for(var b=a.info.command,c=!1,f=0;f<b.length;f++){var d=b[f];if(d&&d.name){d=d.name.toLowerCase();if(("hue"==a.info.sys||"osram"==a.info.sys)&&"brightness"==d)return"light";if("moveto"==d||"move to"==d||"position to"==d||"positionto"==
d)return"blind";if("dimto"==d||"dim to"==d||"levelto"==d||"level to"==d)return"light";"on"==d&&(c=!0)}}return c||c?"switch":null};e.prototype._getFibaroHCDeviceCatagory=function(a){a=a.info.command;for(var b=[],c=0;c<a.length;c++){var f=a[c];f&&f.name&&(f=f.name.toLowerCase(),-1==b.indexOf(f)&&b.push(f))}return-1!=b.indexOf("open")&&-1!=b.indexOf("close")?"blind":-1!=b.indexOf("up")&&-1!=b.indexOf("down")&&-1!=b.indexOf("set value")?"light":-1!=b.indexOf("on")&&-1!=b.indexOf("off")?"switch":null};
e.prototype._convertDeviceToCloudFormat=function(a,b,c,f,d){var e=a.info.sys,n=a.info.type,g=this._getDeviceCatagory(a);g&&(n=g);n={name:b,type:n,module:e,sys:e,baseurl:c,commands:{},states:{}};if("aio"==e&&"TASK"==a.info.type)return{name:b,type:"scene",module:e,sys:e,baseurl:c,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:a.index,command:{value:"run"}}}}};if("hm"==e&&"Prog"==a.info.type)return n={name:b,type:"scene",module:e,sys:e,baseurl:c,commands:{on:{type:"POST",
url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:a.index,command:{value:"progExec"}}}}};if(a.info.command&&0<a.info.command.length){switch(e){case "hm":b=this._processHMCommands(a,f,n,d);break;case "aio":b=this._processAIOCommands(a,f,n,d);break;case "sonos":b=this._processSonosCommands(a,f,n,d);break;case "hue":b=this._processHueCommands(a,f,n,d);break;case "easyled":case "milight":case "milightv6":b=this._processMilightCommands(a,f,n,d);break;case "lightify":b=this._processOsramCommands(a,
f,n,d);break;case "harmony":b=this._processHarmonyCommands(a,f,n,d);break;case "pioneer":case "onkyo":case "denon":case "yamaha":b=this._processHarmonyCommands(a,f,n,d);break;case "mcontrol":b=this._processMcontrolCommands(a,f,n,d);break;case "fibaro":b=this._processFibaroHCCommands(a,f,n,d);break;case "tado":b=this._processTadoCommands(a,f,n,d);break;case "netatmo":b=this._processNetatmoCommands(a,f,n,d);break;default:b=this._processCommandsFromMap(null,a,f,n,d)}n.commands=b}a.info.status&&0<Object.keys(a.info.status).length&&
(n.states=a.info.status);return n};e.prototype._resovleDeviceID=function(a,b,c){var f=a.name;c=c[a.room];if("_cameras"==f.substr(0,8)){c=null;var d=f.indexOf(":");f=f.substr(d+1)}"_progs&sysvars"==c&&(c=b[a.info.gateway],"gw"==f.substr(0,2)&&(d=f.indexOf("_"),f=f.substr(d+1)));b=(c?c+" ":"")+(f?f:"");a.cloud.alias&&(b=a.cloud.alias);return b};e.prototype._resovleBaseUrl=function(a,b){var c=a,f=a.indexOf(":");-1!=f&&(c=a.substr(0,f));return"https://"+c+"/rapi/"+b};e.prototype.getAccessToken=function(a,
b){if(a)if("aio"!=a.sys&&"neoserver"!=a.sys)b&&b(Error("gateway type invalid"));else{var c=this,f=require("xnm.aio.gateway.js");if("neoserver"==a.sys){a=JSON.parse(JSON.stringify(a));a.sys="aio";a.version="EA";var d=f.resolveGateway(a,!0)}else d=f.resolveGateway(a);d?f.Admin.getGatewaySID(d,function(e,n){e?(c._logger.log("warn","get gateway sid error:"+e.message),e.code="50001",e.message="get gateway sid error:"+e.message,b&&b(e)):n?a.password?f.Admin.V5.getInfo(d,function(d,f){d?(c._logger.log("warn",
"get gateway info error:"+d.message),d.message="get gateway info error:"+d.message,d.code="50101",b&&b(d)):f&&f.server?!f.cfg||parseInt(f.cfg,16)&64?(c._logger.log("warn","gateway cloud server is deactivated"),d=Error("gateway cloud server is deactivated"),d.code="50103",b&&b(d)):c._getAccessToken(f.server,n,a.password,!1,function(d,e){d?(d=Error("get accesss token error:"+d.message),d.code="50003",b&&b(d)):e?b&&b(null,e,f.server,n):c._getAccessToken(f.server,n,a.password,!0,function(a,c){a?(a=Error("generate accesss token error:"+
a.message),a.code="50004",b&&b(a)):c?b&&b(null,c,f.server,n):b&&b(Error("access token empty"))})}):(c._logger.log("warn","gateway has no cloud server"),d=Error("gateway has no cloud server"),d.code="50102",b&&b(d))}):(e=Error("gateway has no password"),e.code="50002",b&&b(e)):(e=Error("gateway has no sid"),e.code="50002",b&&b(e))}):b&&b(Error("gateway json invalid"))}else b&&b(Error("gateway json is null"))};e.prototype.generateConfig=function(a,b,c,f,d,e,n,g,h,l){var k=require("url").parse("https://"+
g),p=function(a){for(var b=a.length,c={};b--;){var d=a[b];c[d.index]=d.name}return c}(b),r=function(a){for(var b=a.length,c={};b--;){var d=a[b];c[d.index]=d.name}return c}(c);c={};g=this._resovleBaseUrl(g,e);b=h=null;for(var t=0;t<a.length;t++){var u=a[t];!u||!u.info||"cloudservice"==u.info.sys&&u.info.module||"_webpages"==u.name.substr(0,9)||(h=this._resovleDeviceID(u,r,p),b=this._convertDeviceToCloudFormat(u,h,g,d,c),b.data={mod:"mediola",ccs:k.hostname,accessToken:e,deviceID:u.index},c[h]=b)}a=
{};d=null;if(f&&f.groups)for(e=0;e<f.groups.length;e++)if((k=f.groups[e])&&k.macros&&0!=k.macros.length)for(p=k.name,r=0;r<k.macros.length;r++)if(b=k.macros[r],h=b.name,b.cloud&&b.cloud.enabled){h=(p?p+" ":"")+(h?h:"");b.cloud.alias&&(h=b.cloud.alias);d="";t=h.toLowerCase();u="on off an aus up down auf ab hoch runter ein".split(" ");for(var v=0;v<u.length;v++){var w=u[v],x=t.substr(t.length-w.length);t.length>w.length&&x==w&&(d=h.substr(0,t.length-w.length).trim(),a[d]||(a[d]=[]),a[d].push({original_id:h,
command:w}))}b={name:h,type:"scene",baseurl:g,local:"http://"+n.ip+(n.port?":"+n.port:""),commands:{on:{type:"POST",url:"/cmd",data:{XC_FNC:"DoMacroRM",groupIdx:k.index,macroIdx:b.index}}}};c[h]=b}for(d in a){f=a[d];b={name:d,type:"scene",baseurl:g,local:"http://"+n.ip+(n.port?":"+n.port:""),commands:{}};e=h=!1;for(k=0;k<f.length;k++)if((p=f[k])&&p.original_id&&p.command&&(r=p.original_id,t=c[r],delete c[r],t)){r=t.commands.on;t=p.command;switch(p.command){case "on":case "an":case "ein":h=!0;t="on";
break;case "off":case "aus":h=!0;t="off";break;case "up":case "auf":case "hoch":e=!0;t="up";break;case "down":case "ab":case "runter":e=!0,t="down"}b.commands[t]=r}h?b.type="switch":e&&(b.type="blind");c[d]=b}l&&l(null,c)};e.prototype.uploadConfig=function(a,b,c){b={type:"mediola",configuration:b};var f=a.ip;f||(f=require("url").parse(e.REMOTE_SERVER).host);var d=a.port;d||(d=443);var k=a.username?a.username:"";a=a.password?a.password:"";a={host:f,port:d,path:"/alexa/setConfiguration",method:"POST",
timeout:3E4,auth:k+":"+a,user:k,password:a,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(k+":"+a)).toString("base64"),Connection:"close"}};var n=this;this._logger.log("trace","upload config to:"+JSON.stringify(a));a=require("https").request(a,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){if(200==a.statusCode){n._logger.log("trace","upload config reponse:"+b);try{var d=JSON.parse(b);if(d.XC_ERR){var f=Error(d.XC_ERR.msg);
f.code=d.XC_ERR.code;c&&c(f)}else d.XC_SUC&&c&&c()}catch(p){c&&c(p)}}else n._logger.log("warn","upload config error +"+a.statusCode+":"+b),c&&c(Error("http response:"+a.statusCode))})});if(a.on)a.on("error",function(a){n._logger.log("warn","upload config error:"+a.message);c&&c(a);c=null});a.write(JSON.stringify(b));a.end()};e.prototype.setCustomCommandMap=function(a){this._customMap=a};e.prototype.loadCustomComamndMap=function(a,b){var c=require("fs-extra");c.ensureFile(a,function(f){f?b&&b(null,
{}):c.readFile(a,"utf8",function(a,c){if(a)b&&b(a);else if(c)try{var d=JSON.parse(c);b&&b(null,d)}catch(g){b&&b(null,{})}else b&&b(null,{})})})};e.prototype.saveCustomCommandMap=function(a,b,c){var f=require("fs-extra");f.ensureFile(a,function(d){if(d)c&&c(null,{});else try{var e=JSON.stringify(b,null,2);f.writeFile(a,e,function(a){c&&c(a)})}catch(n){c&&c(n)}})};return e}();
m.aio.voicemanager.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Handler");this._devicemanager=this._configmanager=null;this._alexaHandler=new m.aio.voicemanager.AlexaHandler;this.CLOUD_PROTOCOL="https";this.CLOUD_HOST="webservice.mediola.com";this.CLOUD_PORT=443;this.CLOUD_PATH="/account/bindLicense"};e.prototype.CUSTOM_CMD_MAP_FILE="cloud_service_command.map";e.prototype.init=function(a,b,c,f){this._configmanager=a;this._devicemanager=b;this._macromanager=
c;f&&f()};e.prototype.loadCustomComamndMap=function(a,b){var c=this;this._configmanager.trace("/config/tenants/"+a,function(a,d){a?(a.code="50100",b&&b(a)):(a=require("path"),(d=d.getFolderPath())?(d=a.join(d,c.CUSTOM_CMD_MAP_FILE),c._alexaHandler.loadCustomComamndMap(d,function(a,c){b&&b(a,c)})):(a=Error("tenant folder is null"),a.code="50100",b&&b(a)))})};e.prototype.saveCustomComamndMap=function(a,b,c){var f=this;this._configmanager.trace("/config/tenants/"+a,function(a,e){a?(a.code="50100",c&&
c(a)):(a=require("path"),e=e.getFolderPath(),e=a.join(e,f.CUSTOM_CMD_MAP_FILE),f._alexaHandler.saveCustomCommandMap(e,b,function(a){c&&c(a)}))})};e.prototype.getLocalDeviceConfig=function(a,b,c,f){if(b){var d=this;this._alexaHandler.getAccessToken(b,function(e,n,g,h){e?f&&f(e):d._getDeviceWithCommandAndStatus(a,function(e,k){e?(e.code="50005",f&&f(e)):d._devicemanager.execute("read",a,"gateway",null,function(e,l){e?(e.code="50007",f&&f(e)):d._devicemanager.execute("read",a,"room",null,function(e,
p){e?(e.code="50008",f&&f(e)):d._macromanager.execute(a,"read",null,null,null,function(e,q){e?(e.code="50009",f&&f(e)):d.loadCustomComamndMap(a,function(a,e){if(a||!e)e=null;d._alexaHandler.setCustomCommandMap(e);d._alexaHandler.generateConfig(k,p,l,q,c,n,b,g,h,function(a,b){a?(d._logger.log("warn","generate configuration error:"+a.message),a.code="50010",f&&f(a)):f&&f(null,b)})})})})})})})}else f&&f(null,null)};e.prototype.getCloudDeviceConfig=function(a,b,c){var f=null;if(b){var d=require("xnm.aio.cloudservice.js").resolveGateway(b);
d?this._getCloudDevicesFromDB(a,d,function(a,b){a?c&&c(a):b&&0!=b.length?(a=b.map(function(a){a=a.info;delete a.gateway;delete a.commands;delete a.states;return a}),d.toCloudDevice(a,function(a,d){if(a)a.code=40003,c&&c(a);else if(d&&0!=d.length){a={};for(var f=0;f<b.length;f++){var e=b[f];if(e)for(var h=0;h<d.length;h++){var g=d[h];g&&(g.data&&e.info.module==g.data.mod&&e.info.connection==g.data.connection&&e.info.id==g.data.id?(g.name=e.__cloudref,a[e.__cloudref]=g):e.info.module==g.mod&&e.info.connection==
g.connection&&e.info.id==g.id&&(g.name=e.__cloudref,g.data={mod:g.mod,connection:g.connection,id:g.id},delete g.mod,delete g.connection,delete g.id,a[e.__cloudref]=g))}}c&&c(null,a)}else c&&c(null,{})})):c&&c(null,{})}):(f=Error("cloud json invalid"),f.code=4E4,c&&c(f))}else f=Error("cloud json invalid"),f.code=4E4,c&&c(f)};e.prototype._getCloudDevicesFromDB=function(a,b,c){var f=function(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d&&d.index==a)return d}return null},d=this,e=require("xnm.aio.cloudservice.js"),
n={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",a,"device",n,function(g,h){g?(g.code=40001,c&&c(g)):h&&0!=h.length?(n={filter:"prop","info.sys":"cloudservice"},d._devicemanager.execute("read",a,"gateway",n,function(g,k){g?(g.code=40001,c&&c(g)):k&&0!=k.length?d._devicemanager.execute("read",a,"room",null,function(a,d){if(a)a.code=40001,c&&c(a);else if(d&&0!=d.length){a=[];for(var g=0;g<h.length;g++){var l=h[g];if(l&&l.info&&l.info.gateway){var n=f(l.info.gateway,
k);if(n&&n.info&&(n=e.resolveGateway(n.info))){if(!n.equalsTo(b)){a=Error("cloud device "+l.index+" belongs to another account");a.code=40002;c&&c(a);return}var p=f(l.room,d);p&&(n=l.name,p=p.name,n=(p?p+" ":"")+(n?n:""),l.cloud.alias&&(n=l.cloud.alias),l=JSON.parse(JSON.stringify(l)),l.__cloudref=n,a.push(l))}}}c&&c(null,a)}else c&&c(null,[])}):c&&c(null,[])})):c&&c(null,[])})};e.prototype.previewAlexaConfig=function(a,b,c,e,d){if(c&&c.username)if(e&&e.version&&"C"==e.version.charAt(0)){var f=new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,
this._macromanager);f.setTargetGateway(e);f.exportConfig(a,c,function(a,b){d&&d(a,b)})}else{var n=this;this.getCloudDeviceConfig(a,c,function(c,f){c?d&&d(c):n.getLocalDeviceConfig(a,e,b,function(a,b){if(a)d&&d(a);else{a={};var c;if(f)for(c in f)a[c]=f[c];if(b)for(c in b)a[c]=b[c];(b=Object.keys(a))&&0!=b.length?d&&d(null,a):(n._logger.log("warn","generate empty configuration"),a=Error("empty configuration"),a.code="50011",d&&d(a))}})})}else d&&d(Error("username is null"))};e.prototype.exportAlexaConfig=
function(a,b,c,e,d){if(c&&c.username)if(e){var f=this;this.previewAlexaConfig(a,b,c,e,function(b,e){if(b)d&&d(b);else{var h={};if(e)for(var g in e)b=e[g],delete b.sys,delete b.module,h[g]=b;f._configmanager.execute("read","/config/tenants/"+a,null,function(a,b){if(a)a.code="50013",d&&d(a);else{var e=null;b.license&&"normal"==b.license.type&&b.license.valid&&b.license.license&&(e=b.license.license);f._alexaHandler.uploadConfig(c,h,function(a){a?(f._logger.log("warn","upload configuration error:"+a.message),
a.code="000009"==a.code?"50014":"50012",d&&d(a)):e?f.bindLicense(c.username,c.password,e,function(a){a&&f._logger.log("warn","bind user license error:"+a.message);d&&d(null,h)}):d&&d(null,h)})}})}})}else d&&d(Error("gateway invalid"));else d&&d(Error("username is null"))};e.prototype._getDeviceWithCommandAndStatus=function(a,b){var c={filter:"prop","cloud.enabled":!0},e=this,d={};this._devicemanager.execute("read",a,"device",{filter:"ui",f_ui_elem:"*",f_ui_type:"command"},function(f,n){if(f)b(f);
else{if(n&&0<n.length)for(f=0;f<n.length;f++){var g=n[f];g&&g.cloud&&g.cloud.enabled&&g.info&&g.info.command&&0!=g.info.command.length&&(d[g.index]=g)}e._devicemanager.execute("read",a,"device",c,function(c,f){if(c)b(c);else if(f&&0!=f.length){var g=0,h=function(c,k){!c&&k&&(d[f[g].index]?d[f[g].index].info.status=k.states:(d[f[g].index]=f[g],f[g].info.status=k.states));g++;g<f.length?e._devicemanager.toGeneralDevice(a,f[g].index,!1,h):(c=Object.values(d),b(null,c))};e._devicemanager.toGeneralDevice(a,
f[g].index,!1,h)}else c=Object.values(d),b(null,c)})}})};e.prototype.bindLicense=function(a,b,c,e){b={host:this.CLOUD_HOST,port:this.CLOUD_PORT,path:this.CLOUD_PATH+"?license="+c,method:"GET",timeout:3E4,auth:a+":"+b,user:a,password:b,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(a+":"+b)).toString("base64"),Connection:"close"}};var d=this;this._logger.log("trace","bind license "+c+" to:"+a);a=require(this.CLOUD_PROTOCOL).request(b,function(a){a.setEncoding("utf8");
var b="";a.on("data",function(a){b+=a});a.on("end",function(){200==a.statusCode?(d._logger.log("trace","bind license success"),e&&e()):(d._logger.log("warn","bind license success +"+a.statusCode+":"+b),e&&e(Error("http response:"+a.statusCode)));e=null})});if(a.on)a.on("error",function(a){d._logger.log("warn","upload config error:"+a.message);e&&e(a);e=null});a.setTimeout(3E4,function(){e&&e(Error("timeout"));e=null});a.end()};e.prototype.uploadDeviceDB=function(a,b,c,e){this._uploadFile(a,b,"device_db",
c,e)};e.prototype.uploadMacroDB=function(a,b,c,e){this._uploadFile(a,b,"macros_db",c,e)};e.prototype._uploadFile=function(a,b,c,e,d){a="/xhub/xhubsync/upload2?gatewayid="+a+"&fileName="+c+"&auth=";b.password&&(a+=b.password);b={host:b.ip,port:b.port,path:a,method:"POST",timeout:3E4,headers:{"Content-Type":"text/plain",Connection:"close"}};var f=this;this._logger.log("trace","upload "+c+" to:"+JSON.stringify(b));b=require("http").request(b,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=
a});a.on("end",function(){if(200==a.statusCode){f._logger.log("trace","upload "+c+" reponse:"+b);try{"success"==JSON.parse(b).status?d&&d():d&&d(Error("failed to upload "+c))}catch(h){d&&d(h)}}else f._logger.log("warn","upload "+c+" error +"+a.statusCode+":"+b),d&&d(Error("http response:"+a.statusCode))})});if(b.on)b.on("error",function(a){f._logger.log("warn","upload "+c+" error:"+a.message);d&&d(a);d=null});b.write(JSON.stringify(e));b.end()};e.prototype.exportV5Config=function(a,b,c,e,d){if(c&&
c.username)if(e){var f=this;(new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager)).exportConfig(a,c,function(b,e){b?(f._logger.log("error","generate configuration error:"+b.message),b.code="50012",d&&d(b)):f._configmanager.execute("read","/config/tenants/"+a,null,function(a,b){if(a)a.code="50013",d&&d(a);else{var g=null;b.license&&"normal"==b.license.type&&b.license.valid&&b.license.license&&(g=b.license.license);f._alexaHandler.uploadConfig(c,e,function(a){a?(f._logger.log("warn",
"upload configuration error:"+a.message),a.code="000009"==a.code?"50014":"50012",d&&d(a)):g?f.bindLicense(c.username,c.password,g,function(a){a&&f._logger.log("warn","bind user license error:"+a.message);d&&d(null,e)}):d&&d(null,e)})}})})}else d&&d(Error("gateway invalid"));else d&&d(Error("username is null"))};return e}();"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.voicemanager.Handler);
