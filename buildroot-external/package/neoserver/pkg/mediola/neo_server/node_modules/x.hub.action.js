var util=require("util"),commandman=require("x.hub.commandman.js"),x=x||{};x.hub=x.hub||{};x.hub.action=x.hub.action||{};
x.hub.action.ActionManager=function(){var f=function(a,b,c){this._id=a;this._number=b;this._logger=require("x.logger.js").getLogger("x.hub.action.Action.["+a+"#"+b+"]");this._actionPool=c;this._state=0;this._actions=[];this._delayTimeout=this._callback=null};f.prototype.getId=function(){return this._id};f.prototype.run=function(){var a=0,b=this;this._state=1;var c=function(g){b._logger.log("trace","finish item("+a+")"+(g?" failed:"+g.message:" success"));a++;if(2==b._state){if(b._state=3,b._logger.log("trace",
"action canceled"),b._actionPool._onActionFinish(b),b._callback){try{b._callback(Error("action canceled"))}catch(h){}b._callback=null}}else if(3!=b._state)if(a==b._actions.length){if(b._state=3,b._actionPool._onActionFinish(b),b._callback){try{b._callback()}catch(h){}b._callback=null}}else b._do(a,c)};this._logger.log("trace","do item("+a+")");this._do(a,c)};f.prototype.cancel=function(){this._logger.log("trace","cancel action");1==this._state&&(this._state=2);if(this._delayTimeout&&(clearTimeout(this._delayTimeout),
this._delayTimeout=null,this._state=3,this._logger.log("trace","action canceled"),this._actionPool._onActionFinish(self),this._callback))try{this._callback(Error("action canceled"))}catch(a){}};f.prototype._do=function(a,b){if(a=this._actions[a]){var c=this;void 0!=a.delay&&null!=a.delay?this._delayTimeout=setTimeout(function(){c._delayTimeout=null;b()},a.delay):commandman.commandHandlerV6.executeCommandWithCommandInfo(a,function(a){b(a)})}else b()};var e=function(){this._pool=[];this._count=0};e.prototype.runAction=
function(a,b,c){b?(this._count++,65535<this._count&&(this._count=1),a=new f(a,this._count,this),Array.isArray(b)?a._actions=b:a._actions=[b],a._callback=c,this._pool.push(a),a.run()):c&&c()};e.prototype.cancelAction=function(a){this._pool=this._pool.filter(function(b){return b&&b.getId()==a?(b.cancel(),!1):!0})};e.prototype._onActionFinish=function(a){a=this._pool.indexOf(a);-1!=a&&this._pool.splice(a,1)};var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.action.ActionManager");
this._actionPool=this._actions=this._dataFolder=null;this._writing=!1;this._writeCallbacks=[]};d.FILE_NAME="action.json";d.prototype.init=function(a,b){this._logger.log("info","init action manager");this._dataFolder=a.getUserRootDataPath();this._actionPool=new e(this);this._loadActions(function(a){b&&b(a)})};d.prototype.getActions=function(){return this._actions};d.prototype.getAction=function(a){return this._actions?this._actions[a]:null};d.prototype.setAction=function(a,b,c){void 0==a||null==a?
c&&c(Error("invalid action id")):(b?this._actions[a]=b:delete this._actions[a],this._writeActions(function(a){c&&c(a,b)}))};d.prototype.executeActionWithId=function(a,b){var c=this.getAction(a);c?this._actionPool.runAction("act:"+a,c,b):b&&b(Error("no such action "+a))};d.prototype.executeAction=function(a,b,c){this._actionPool.runAction(a,b,c)};d.prototype.executeActionSingelton=function(a,b,c){this._actionPool.cancelAction(a);this._actionPool.runAction(a,b,c)};d.prototype._loadActions=function(a){var b=
require("fs-extra"),c=this._getFile(),d=this;b.ensureFile(c,function(b){b?a(b):d._loadFile(function(b,c){b?a(b):(d._actions=c?c:{},a())})})};d.prototype._writeActions=function(a){a&&-1==this._writeCallbacks.indexOf(a)&&this._writeCallbacks.push(a);if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var b=this._writeCallbacks;this._writeCallbacks=[];var c=this;this._writeFile(this._actions,function(a){c._writing=!1;b.forEach(function(b){try{b&&b(a)}catch(k){}});c._writeActions()})}};d.prototype._getFile=
function(){return require("path").resolve(this._dataFolder,d.FILE_NAME)};d.prototype._loadFile=function(a){var b=require("fs"),c=this._getFile();b.readFile(c,"utf8",function(b,c){if(b)a(b);else if(c)try{var d=JSON.parse(c);a(null,d)}catch(l){a(null,{})}else a(null,{})})};d.prototype._writeFile=function(a,b){var c=require("fs"),d=this._getFile();c.writeFile(d,JSON.stringify(a,null,2),function(a){b&&b(a)})};return d}();
x.hub.action.Handler=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.action.Handler");this._actionManager=new x.hub.action.ActionManager};f.prototype.init=function(e,d,a){"CA"==global.HARDWARE_VERSION&&this._initHttpApi(e);this._actionManager.init(d,function(b){b&&a(b)})};f.prototype.getActionManager=function(){return this._actionManager};f.prototype._initHttpApi=function(){var e=this,d=require("x.hub.js").getServer();d.addRoute("/api/actions",{method:"GET"},function(a,
b,c){a=e._actionManager.getActions();b.json({XC_SUC:a?a:{}})});d.addRoute("/api/action",{method:"GET"},function(a,b,c){var d=a.query?a.query.id:null;e._actionManager.executeActionWithId(d,function(a){a?b.json({XC_ERR:{code:"000101",msg:"failed to execute action "+d+":"+a.message}}):b.json({XC_SUC:{}})})});d.addRoute("/data/act/",{method:"GET"},function(a,b,c){a=a.path.substr(10);(a=e._actionManager.getAction(a))?b.json({XC_SUC:a}):b.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});d.addRoute("/data/act/",
{method:"POST"},function(a,b){var c=a.path.substr(10);try{e._actionManager.setAction(c,a.json,function(c,d){c?b.json({XC_ERR:{code:"000101",msg:"failed to set action:"+c.message}}):d?b.json({XC_SUC:{bytes:a.size}}):b.json({XC_SUC:{bytes:0}})})}catch(g){b.json({XC_ERR:{code:"000101",msg:"failed to set action:"+g.message}})}})};return f}();module.exports=new x.hub.action.Handler;
