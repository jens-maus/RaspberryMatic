var x=x||{};x.hub=x.hub||{},x.hub.fileman=x.hub.fileman||{},x.hub.fileman._Util={inNodeWebkit:function inNodeWebkit(){return process.versions["node-webkit"];},getUserHome:function getUserHome(){return process.env["win32"==process.platform?"USERPROFILE":"HOME"];},getUserDocumentFolder:function getUserDocumentFolder(e){var r=require("path"),o=this;switch(process.platform){case"win32":var t=require("winreg");new t({hive:t.HKCU,key:"\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"}).values(function(r,t){if(r)return console.error(r.message),void o.getUserDocumentFolderNoWinReg(e);var a=null;if(!r&&t)for(var i=0;i<t.length;i++)if("Personal"==t[i].name&&t[i].value){a=t[i].value;break;}a||(r=new Error("win32 do not have user document folder registry")),e&&e(r,a);});break;case"darwin":var a=this.getUserHome();e(null,a+r.sep+"Documents");break;default:e(null,this.getUserHome());}},getUserDocumentFolderNoWinReg:function getUserDocumentFolderNoWinReg(e){var r=null;if("win32"!=process.platform)return r=new Error("[getUserDocumentFolderFallback] No fallback for "+process.platform),void(e&&e(r,null));var o=require("path"),t=require("os"),a=require("fs"),i=t.homedir(),n=o.join(i,"Documents");a.existsSync(n)||(n=o.join(i,"My Documents"),a.existsSync(n)||(r=new Error("Could not find documents folder."),n=null)),e&&e(r,n);},getUserDocumentFolderOld:function getUserDocumentFolderOld(e){var r=require("path");switch(process.platform){case"win32":require("regedit").list("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders",function(r,o){if(r)e(r);else{var t=o["HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"];if(t){var a=t.values;a?a.Personal&&a.Personal.value?e(null,a.Personal.value):e(new Error("win32 do not have user document folder registry")):e(new Error('"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" has no records'));}else e(new Error('"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" not found'));}});break;case"darwin":var o=this.getUserHome();e(null,o+r.sep+"Documents");break;default:e(null,this.getUserHome());}},getWindowsCommonAppDataFolder:function getWindowsCommonAppDataFolder(e){var r=require("winreg");new r({hive:r.HKLM,key:"\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"}).values(function(r,o){r&&console.error("read windows common app data registry error",r);var t=null;if(!r&&o)for(var a=0;a<o.length;a++)if("Common AppData"==o[a].name&&o[a].value){t=o[a].value;break;}if(!t){var i=require("os").release().split(".");t=parseInt(i[0])<6?"C:\\Documents and Settings\\All Users":"C:\\ProgramData";}e&&e(null,t);});},getWindowsCommonAppDataFolderOld:function getWindowsCommonAppDataFolderOld(e){require("regedit").list("HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders",function(r,o){if(r)e(r);else{var t=o["HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"];if(t){var a=t.values;if(a){if(!a["Common AppData"]||!a["Common AppData"].value)try{var i=require("os").release().split(".");return parseInt(i[0])<6?void e(null,"C:\\Documents and Settings\\All Users"):void e(null,"C:\\ProgramData");}catch(r){return void e(new Error("win32 do not have common appdata folder registry"));}e(null,a["Common AppData"].value);}else e(new Error('"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" has no records'));}else e(new Error('"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" not found'));}});}},x.hub.fileman._NativeFileManager={logger:null,_pkgName:null,_userDir:null,_userDoc:{},_winCommonAppData:null,init:function init(e,r){this._logger||(this._logger=require("x.logger.js").getLogger("x.hub.fileman._NativeFileManager")),this._logger.log("trace","init"),this._pkgName=e;var o=require("async"),t=this;try{var a=require("../src/filemanager");this._userDir=a._userDir,this._logger.log("trace","Using userDir set in filemanager.");}catch(e){}o.series([function(e){if(t._logger.log("trace","get user document folder"),this._userDir){var r=require("path");if(r.resolve(this._userDir)==r.normalize(this._userDir))return this._userDoc[process.platform]=r.normalize(this._userDir),void e();}x.hub.fileman._Util.getUserDocumentFolder(function(r,o){r?(t._logger.log("trace","get user document folder error:"+r.message),e(r)):(t._logger.log("trace","user document folder: ("+process.platform+"):"+o),this._userDoc[process.platform]=o,e());}.bind(this));}.bind(this),function(e){"win32"==process.platform?(t._logger.log("trace","get windows common app data folder"),x.hub.fileman._Util.getWindowsCommonAppDataFolder(function(r,o){r?(t._logger.log("trace","get windows common app data folder error:"+r.message),e(r)):(t._logger.log("trace","windows common app data folder:"+o),this._winCommonAppData=o,e());}.bind(this))):e();}.bind(this)],function(e){r&&r(e);});},getAppRootDataPath:function getAppRootDataPath(){return x.hub.fileman._Util.inNodeWebkit()?this._getNodeWebkitRootDataPath():this._getNodeRootDataPath();},getUserRootDataPath:function getUserRootDataPath(){var e=require("path");return this._userDoc[process.platform]+e.sep+this._pkgName;},getTmpDir:function getTmpDir(){return require("os").tmpdir();},_getNodeRootDataPath:function _getNodeRootDataPath(){var e=require("path");switch(process.platform){case"darwin":return"/Library/Application Support/"+this._pkgName;case"win32":return this._winCommonAppData+e.sep+this._pkgName;default:return x.hub.fileman._Util.getUserHome()+e.sep+this._pkgName;}},_getNodeWebkitRootDataPath:function _getNodeWebkitRootDataPath(){var e=require("path");switch(process.platform){case"darwin":return x.hub.fileman._Util.getUserHome()+"/Library/Application Support/"+this._pkgName;case"win32":return this._winCommonAppData+e.sep+this._pkgName;default:return x.hub.fileman._Util.getUserHome()+e.sep+this._pkgName;}}},x.hub.fileman.FileManager=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("x.hub.fileman.FileManager"),this._packageName=null,this._cwd=null,this._appFolder=null;};return e.prototype.init=function(e,r){this._logger.log("info","init filemanager"),this._packageName=e;var o=this;x.hub.fileman._NativeFileManager.init(e,function(e){if(e)return o._logger.log("warn","init naive filemanager error:"+e.message),void(r&&r(e));require("m.aio.filemanager.js").init(o,function(e){if(e)return o._logger.log("warn","init filemanager module error:"+e.message),void(r&&r(e));var t=o.getUserRootDataPath();o._logger.log("info","user root folder:"+t);var a=require("fs-extra");a.ensureDir(t,function(e){if(e)r&&r(e);else{var t=o.getAppRootDataPath();o._logger.log("info","app root folder:"+t),a.ensureDir(t,function(e){if(e)r&&r(e);else{var t=o.getLogFile();o._logger.log("info","log file:"+t),a.ensureFile(t,function(e){r&&r(e);});}});}});});});},e.prototype.getUserRootDataPath=function(){if(global&&global.DATA_FOLDER)return global.DATA_FOLDER;var e=require("path"),r=x.hub.fileman._NativeFileManager.getUserRootDataPath();return r||(r="userroot"),r+e.sep+"data";},e.prototype.getAppRootDataPath=function(){if(global&&global.APP_FOLDER)return global.APP_FOLDER;var e=x.hub.fileman._NativeFileManager.getAppRootDataPath();return e||(e="approot"),e;},e.prototype.getTmpDir=function(){return x.hub.fileman._NativeFileManager.getTmpDir();},e.prototype.getLogFile=function(){var e=require("path");return global&&global.LOG_ROOT?global.LOG_ROOT+e.sep+this._packageName+".log":global&&global.DATA_FOLDER?global.DATA_FOLDER+e.sep+"log"+e.sep+this._packageName+".log":require("m.aio.filemanager.js").getUserLogPath()+e.sep+this._packageName+".log";},e.prototype.getUserLogPath=function(){var e=require("path");return global&&global.LOG_ROOT?global.LOG_ROOT:global&&global.DATA_FOLDER?global.DATA_FOLDER+e.sep+"log":require("m.aio.filemanager.js").getUserLogPath();},e.prototype.getCWD=function(){return this._cwd||(this._cwd=process.cwd()),this._cwd;},e.prototype.getAppFolder=function(){return global&&global.APP_FOLDER?global.APP_FOLDER:(this._appFolder||(this._appFolder=require("path").dirname(__dirname)),this._appFolder);},e;}(),x.hub.fileman.Handler=function(){this.fileManager=new x.hub.fileman.FileManager();},x.hub.fileman.Handler.prototype.FileManager=x.hub.fileman.FileManager,x.hub.fileman.Handler.prototype.init=function(e,r){this.fileManager.init(e,r);},module.exports=new x.hub.fileman.Handler();