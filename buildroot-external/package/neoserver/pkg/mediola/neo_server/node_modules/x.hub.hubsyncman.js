var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.hubsyncman=x.hub.hubsyncman||{};x.hub.hubsyncman.Error=function(f,a){Error.call(this,f);this.code=a};util.inherits(x.hub.hubsyncman.Error,Error);
x.hub.hubsyncman.SyncManager=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.SyncManager");this._tenant2=this._tenant=null};f.prototype.init=function(a,b){this._logger.log("info","init hub sync managaer");var e=require("m.aio.configmanager.js");a=this._generateTenantParent(a);this._tenant=new e.Tenant(a);this._tenant.license="dummy";this._tenant.folder="db";this._tenant2=new e.Tenant(a);this._tenant2.license="dummy";this._tenant2.folder="db2";b&&b()};f.prototype.deploy=
function(a,b,e,d,c){var h=this;require("async").waterfall([function(d){h._writeZip(a,d)},function(d,b){var a=require("x.hub.fileman.js").fileManager.getUserRootDataPath(),e=require("path"),g=require("fs-extra");a=e.resolve(a,"db");if(g.existsSync(a))try{var c=g.lstatSync(a);if(c.isDirectory(a)){var f=e.resolve(a,"device_db");g.existsSync(f)&&(c=g.lstatSync(f),c.isFile()||g.removeSync(f));var k=e.resolve(a,"macros_db");g.existsSync(k)&&(c=g.lstatSync(k),c.isFile()||g.removeSync(k))}else g.removeSync(a)}catch(m){}h._unzip(d,
b)},function(a){h._encryptDeviceDB(a)},function(a){require("x.hub.taskman.js").taskManager.clear();a()},function(a){require("x.hub.deviceman.js").deviceManager.reload(a)},function(a){require("x.hub.macroman.js").macroManager.reload(a)},function(a){require("x.hub.taskman.js").taskManager.reload(a)},function(a){require("x.hub.scriptman.js").scriptManager.reload(a)},function(a){localStorage.setItem("x.hub.hubsyncman.SyncManager.TIMESTAMP",(new Date).getTime());localStorage.setItem("x.hub.hubsyncman.SyncManager.USERID",
b);localStorage.setItem("x.hub.hubsyncman.SyncManager.APPID",e);d&&(localStorage.setItem("x.hub.m.gateway.DB1NeoIdx",d),require("x.hub.m.gateway.js").updateGatewayNeoIndex());a()}],function(a){c&&c(a)})};f.prototype._encryptDeviceDB=function(a){var b=require("path"),e=require("x.hub.fileman.js").fileManager.getUserRootDataPath(),d=b.join(e,"db","device_db");b=b.join(e,"db2","device_db");this._encryptDeviceDBFileSync(d);this._encryptDeviceDBFileSync(b);a&&a()};f.prototype._encryptDeviceDBFileSync=
function(a){var b=require("fs"),e=require("x.crypt"),d=require("m.aio.devicemanager");try{if(b.existsSync(a)){this._logger.log("trace","[_encryptDeviceDB] Encrypting "+a);var c=b.readFileSync(a,"utf8");c&&(c=e.AES.encodeString(c,d.ml_v1_info()),b.writeFileSync(a+".enc",c),b.unlinkSync(a))}}catch(h){console.error(h),this._logger.log("error","[_encryptDeviceDB] "+h.message)}};f.prototype.deploy2=function(a,b,e,d,c){var h=this;require("async").waterfall([function(d){h._writeZip(a,d)},function(a,d){var b=
require("x.hub.fileman.js").fileManager.getUserRootDataPath(),e=require("path"),c=require("fs-extra");b=e.resolve(b,"db2");if(c.existsSync(b))try{var g=c.lstatSync(b);if(g.isDirectory(b)){var f=e.resolve(b,"device_db");c.existsSync(f)&&(g=c.lstatSync(f),g.isFile()||c.removeSync(f));var k=e.resolve(b,"macros_db");c.existsSync(k)&&(g=c.lstatSync(k),g.isFile()||c.removeSync(k))}else c.removeSync(b)}catch(m){}h._unzip(a,d)},function(a){h._encryptDeviceDB(a)},function(a){require("x.hub.deviceman.js").deviceManager2.reload(a)},
function(a){require("x.hub.macroman.js").macroManager2.reload(a)},function(a){localStorage.setItem("x.hub.hubsyncman.SyncManager2.TIMESTAMP",(new Date).getTime());localStorage.setItem("x.hub.hubsyncman.SyncManager2.USERID",b);localStorage.setItem("x.hub.hubsyncman.SyncManager2.APPID",e);d&&(localStorage.setItem("x.hub.m.gateway.DB2NeoIdx",d),require("x.hub.m.gateway.js").updateGatewayNeoIndex());a()}],function(a){c&&c(a)})};f.prototype._writeZip=function(a,b){var e=require("os"),d=require("fs"),c=
require("path"),h="nam_"+Math.round((new Date).getTime()/1E3)+".zip",g=c.join(e.tmpdir(),h);this._logger.log("trace","create temp deploy zip:"+g);e=d.createWriteStream(g);a.pipe(e);var f=b;e.on("error",function(a){f&&f(a);f=null});e.on("close",function(){f&&f(null,g);f=null})};f.prototype._unzip=function(a,b){var e=require("adm-zip"),d=require("x.hub.fileman.js").fileManager.getUserRootDataPath();require("path");var c=require("fs-extra");try{(new e(a)).extractAllTo(d,!0),b&&b()}catch(h){b&&b(h)}c.remove(a)};
f.prototype.writeFile=function(a,b,e){var d=this._tenant.getFolderPath(),c=require("path"),h=require("fs-extra"),g=d+c.sep+a,f=this;h.writeFile(g,b,function(a){a?(f._logger.log("warn","write file:"+g+" error:"+a.message),e&&e(a)):require("x.hub.deviceman.js").deviceManager.reload(function(a){a?(f._logger.log("warn","reload device error:"+a.message),e&&e(a)):require("x.hub.macroman.js").macroManager.reload(function(a){a&&f._logger.log("warn","reload macro error:"+a.message);e&&e(a)})})})};f.prototype.writeFile2=
function(a,b,e,d){var c=this._tenant2.getFolderPath(),h=require("path"),f=require("fs-extra"),k=c+h.sep+a,l=this;f.writeFile(k,b,function(b){b?(l._logger.log("warn","write file:"+k+" error:"+b.message),d&&d(b)):("device_db"==a&&l._encryptDeviceDBFileSync(k),require("x.hub.deviceman.js").deviceManager2.reload(function(b){b?(l._logger.log("warn","reload device error:"+b.message),d&&d(b)):require("x.hub.macroman.js").macroManager2.reload(function(b){b&&l._logger.log("warn","reload macro error:"+b.message);
e&&"device_db"==a&&(localStorage.setItem("x.hub.m.gateway.DB2NeoIdx",e),require("x.hub.m.gateway.js").updateGatewayNeoIndex());d&&d(b)})}))})};f.prototype._generateTenantParent=function(a){return{fileManager:a,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};return f}();
x.hub.hubsyncman.Handler=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.Handler");this.syncManager=new x.hub.hubsyncman.SyncManager};f.prototype.SyncManager=x.hub.hubsyncman.SyncManager;f.prototype.init=function(a,b,e){"CA"==global.HARDWARE_VERSION?this._configNew(a):this._config(a);this.syncManager.init(b,e)};f.prototype._configNew=function(a){var b=this;a=require("x.hub.js").getServer();a.addRoute("/xhub/xhubsync/upload",{method:"POST"},function(a,d){var c=
a.query.fileName;c?b.syncManager.writeFile(c,a.body,function(a){d.send(b._toRestfulResponse(a,"ok"))}):d.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))});a.addRoute("/xhub/xhubsync/deploy",{method:"POST",source:1,body:"stream"},function(a,d){var c=a.query.userid;c?b.syncManager.deploy(a,c,a.query.appid,a.query.gatewayid,function(a){d.send(b._toRestfulResponse(a,"ok"))}):d.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))});a.addRoute("/xhub/xhubsync/upload2",
{method:"POST"},function(a,d){var c=a.query.fileName;c?b.syncManager.writeFile2(c,a.body,a.query.gatewayid,function(a){d.send(b._toRestfulResponse(a,"ok"))}):d.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))});a.addRoute("/xhub/xhubsync/deploy2",{method:"POST",source:1,body:"stream"},function(a,d){var c=a.query.userid;c?b.syncManager.deploy2(a,c,a.query.appid,a.query.gatewayid,function(a){d.send(b._toRestfulResponse(a,"ok"))}):d.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))})};
f.prototype._config=function(a){var b=this,e=require("body-parser");a.use("/xhub/xhubsync/",function(a,b,e){var d=require("x.hub.js").server,c=!0;if(d._pwd&&0<d._pwd.length){c=!1;if(!a.query.at&&a.query.auth){var f=require("x.crypt.js");a.query.at=f.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))}a.query.at&&a.query.at==d._pwd&&(c=!0)}c?e():b.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')});a.use("/xhub/xhubsync/upload",e.text({limit:"50mb"}));a.post("/xhub/xhubsync/upload",function(a,
c){var d=a.query.fileName;d?b.syncManager.writeFile(d,a.body,function(a){c.send(b._toRestfulResponse(a,"ok"))}):c.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))}.bind(this));a.post("/xhub/xhubsync/deploy",function(a,c){var d=a.query.userid;d?this.syncManager.deploy(a,d,a.query.appid,a.query.gatewayid,function(a){c.send(b._toRestfulResponse(a,"ok"))}):c.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))}.bind(this));a.use("/xhub/xhubsync/upload2",e.text({limit:"50mb"}));
a.post("/xhub/xhubsync/upload2",function(a,c){var d=a.query.fileName;d?b.syncManager.writeFile2(d,a.body,a.query.gatewayid,function(a){c.send(b._toRestfulResponse(a,"ok"))}):c.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))}.bind(this));a.post("/xhub/xhubsync/deploy2",function(a,c){var d=a.query.userid;d?this.syncManager.deploy2(a,d,a.query.appid,a.query.gatewayid,function(a){c.send(b._toRestfulResponse(a,"ok"))}):c.send(b._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))}.bind(this))};
f.prototype._toRestfulResponse=function(a,b){return a?{status:"fail",message:a.message,code:a.code?a.code:0}:{status:"success",data:b}};return f}();module.exports=new x.hub.hubsyncman.Handler;
