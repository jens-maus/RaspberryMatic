var util=require("util"),EventEmitter=require("events"),crypto=require("crypto"),fs_extra=require("fs-extra"),fileman=require("x.hub.fileman.js"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.enocean=x.hub.m.enocean||{},x.hub.m.enocean.SENDER_ID=null,x.hub.m.enocean.MANUFACTURE_ID=2047,x.hub.m.enocean._CRC8Table=[0,7,14,9,28,27,18,21,56,63,54,49,36,35,42,45,112,119,126,121,108,107,98,101,72,79,70,65,84,83,90,93,224,231,238,233,252,251,242,245,216,223,214,209,196,195,202,205,144,151,158,153,140,139,130,133,168,175,166,161,180,179,186,189,199,192,201,206,219,220,213,210,255,248,241,246,227,228,237,234,183,176,185,190,171,172,165,162,143,136,129,134,147,148,157,154,39,32,41,46,59,60,53,50,31,24,17,22,3,4,13,10,87,80,89,94,75,76,69,66,111,104,97,102,115,116,125,122,137,142,135,128,149,146,155,156,177,182,191,184,173,170,163,164,249,254,247,240,229,226,235,236,193,198,207,200,221,218,211,212,105,110,103,96,117,114,123,124,81,86,95,88,77,74,67,68,25,30,23,16,5,2,11,12,33,38,47,40,61,58,51,52,78,73,64,71,82,85,92,91,118,113,120,127,106,109,100,99,62,57,48,55,34,37,44,43,6,1,8,15,26,29,20,19,174,169,160,167,178,181,188,187,150,145,152,159,138,141,132,131,222,217,208,215,194,197,204,203,230,225,232,239,250,253,244,243],x.hub.m.enocean.CRC8=function(e){for(var t=0,a=0;a<e.length;a++)t=x.hub.m.enocean._CRC8Table[t^e[a]];return t;},x.hub.m.enocean.Serial=function(){var e=function e(_e2,t){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.Serial.("+_e2+")"),this._port=_e2,this._serialPort=null,this._baudrate=t,this._baudrate||(this._baudrate=57600);};return e.prototype.getPort=function(){return this._port;},e.prototype.setListener=function(e){this._listener=e;},e.prototype.open=function(e){if(this._serialPort)return this._logger.log("warn","port:"+this._port+" already opened"),void(e&&e());var t=e;try{this._logger.log("trace","try to listen to port:"+this._port);var a,r=require("serialport");if(!r)return this._logger.log("warn","no seiralport module"),void(e&&e(new Error("no seiralport modul")));a=r.SerialPort?new r.SerialPort(this._port,{baudrate:this._baudrate}):new r(this._port,{baudRate:this._baudrate});var n=this;a.on("open",function(){n._logger.log("trace","port:"+n._port+" opened"),n._serialPort=a,a.flush(function(){t&&t(),t=null;});}),a.on("error",function(e){n._logger.log("warn","enocean error:"+e.message),n._serialPort=null,t?(t&&t(e),t=null):n._listener&&n._listener.onSerialError&&n._listener.onSerialError(e);}),a.on("data",function(e){n._logger.log("trace","receive data "+e.toString("hex")),n._listener&&n._listener.onSerialData&&n._listener.onSerialData(e);}),a.on("close",function(){n._logger.log("trace","port closed");});}catch(e){this._logger.log("warn","init enocean via "+this._port+" error:"+e.message),t&&t(e),t=null;}},e.prototype.close=function(){this._listener=null;try{this._serialPort&&this._serialPort.close();}catch(e){this._logger.log("warn","close enocean via "+this._port+" error:"+e.message);}this._serialPort=null;},e.prototype.sendPacket=function(e,t){this._serialPort?this._serialPort.write(e,t):t&&t(new Error("port not opened"));},e;}(),x.hub.m.enocean.ReComm=function(){var e=function e(_e3){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.ReComm"),this._esp3=_e3;};return e.prototype.sendRawSysEx=function(e,t,a,r){var n=this,s=new x.hub.m.enocean.ESP3.Telegram.ADT(197,e,t,a);this._esp3.sendTelegram(s,!0,function(e,t){setTimeout(function(){return e?(n._logger.log("warn","ReComm command failed with err:"+e.message),void(r&&r(e))):t&&0!=t.retCode?(n._logger.log("warn","ReComm command failed with retCode:"+t.retCode),(e=new Error("ReComm command failed:"+t.retCode)).code=t.retCode,void(r&&r(e,t))):void(r&&r(null,t));},50);});},e;}(),x.hub.m.enocean.SecurityHandler=function(){var e=new Buffer("3410de8f1aba3eff9f5a117172eacabd","hex"),t=function t(){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.SecurityHandler"),this._secInfo={},this._unsync={};};return t.prototype.SECURITY_FILE="enocean_sec.json",t.prototype.init=function(e){this._logger.log("trace","init");var t=this;this._loadSec(function(a,r){a&&t._logger.log("warn","init error:"+a.message),r&&(t._secInfo=r),e&&e();});},t.prototype.getUnsyncDevice=function(){return this._unsync;},t.prototype.isSecureDevice=function(e){return this._secInfo[e];},t.prototype.secureTeachIn=function(e,t,a){this._logger.log("trace","secure teach-in:"+e),e&&(t.key&&delete t.key,this._secInfo[e]=t),this._saveSec(this._secInfo,a);},t.prototype.resolve=function(e){if(!e)return null;switch(e.rorg){case 53:return this._resolveSecureTeachIn(e);case 49:return this._resolveSecureMessage(e);default:return null;}},t.prototype._resolveSecureTeachIn=function(e){var t={},a=e.userData,r=a.readUInt8(0);if(t.teachInInfo={},t.teachInInfo.idx=r>>6&3,t.teachInInfo.cnt=r>>4&3,t.teachInInfo.psk=r>>3&1,t.teachInInfo.type=r>>2&1,t.teachInInfo.info=3&r,0==t.teachInInfo.idx){var n=a.readUInt8(1);t.slf={},t.slf.rlc_algo=n>>6&3,t.slf.rlc_tx=n>>5&1,t.slf.mac_alro=n>>3&3,t.slf.data_enc=7&n;var s=0;1==t.slf.rlc_algo?s=2:2==t.slf.rlc_algo&&(s=3),s&&(t.rlc=a.slice(2,2+s)),t.key=a.slice(2+s),t.completeKey=null;}else t.key=a.slice(1);return t;},t.prototype._resolveSecureMessage=function(t){var a=t.senderID,r=this._secInfo[a];if(!r)return null;if(!r.completeKey)return null;var n=0,s=0;1==r.slf.mac_alro?n=3:2==r.slf.mac_alro&&(n=4),1==r.slf.rlc_tx&&(1==r.slf.rlc_algo?s=2:2==r.slf.rlc_algo&&(s=3));var o,i=t.userData.length-n-s,l=t.userData.slice(0,i),u=null,c=null;s&&(c=t.userData.slice(i,i+s)),n&&(u=t.userData.slice(i+s)),o=c||r.rlc;var h=!1,_=!0;if(u){var p=this.checkCmac(t.rorg,l,o,r.completeKey,u);p.rlc&&o.toString("hex")!=p.rlc.toString("hex")&&(o=p.rlc,r.rlc=p.rlc,h=!0),p&&p.ok?(this._logger.log("trace","receive from "+a+" with cmac rlc:"+o.toString("hex")),delete this._unsync[a]):(_=!1,this._logger.log("warn","receive from "+a+" with cmac out of snyc, last rlc:"+o.toString("hex")),this._unsync[a]=o.toString("hex"));}var d=null;if(_&&3==r.slf.data_enc){var v=this.decryptVAES(o,e,r.completeKey,l);d=t.convertToPacket(v).toRadioTelegram();}return r.rlc=this._incRLC(o),h=!0,this._logger.log("trace","senderID next rlc:"+r.rlc.toString("hex")),h&&this._saveSec(this._secInfo),d;},t.prototype.decryptVAES=function(e,t,a,r){for(var n=r.length,s=Math.ceil(n/16),o=[],i=null,l=0;l<s;l++){var u=16*l,c=u+16;c>n&&(c=n);var h=r.slice(u,c),_=this._doVAESblock(e,t,a,i,h);o.push(_.data),i=_.enc;}return Buffer.concat(o);},t.prototype._doVAESblock=function(e,t,a,r,n){var s=this._xor(e,t);r&&(s=this._xor(s,r));var o=this._doAES128(a,null,s),i=this._xor(o,n);return{data:i=i.slice(0,n.length),enc:o};},t.prototype.checkCmac=function(e,t,a,r,n){if(a){for(var s=this._bufToInt(a),o=0;o<128;o++){if(0!=o){s+=1;var i=65535;3==a.length&&(i=16777215),s>i&&(s=0);}var l=this._intToBuf(s,a.length);if(this.calcCmac(e,t,l,r,n.length).toString("hex")==n.toString("hex"))return{ok:!0,rlc:this._intToBuf(s,a.length)};}return{ok:!1,rlc:this._intToBuf(s,a.length)};}return this.calcCmac(e,t,null,r,n.length).toString("hex")==n.toString("hex")?{ok:!0}:{ok:!1};},t.prototype.calcCmac=function(e,t,a,r,n){var s=this._getCmacSubkey(r),o=new Buffer(1);o.writeUInt8(e),o=Buffer.concat([o,t]),a&&(o=Buffer.concat([o,a]));for(var i,l=o.length,u=Math.ceil(l/16),c=null,h=0;h<u;h++){var _=16*h,p=_+16;p>l&&(p=l);var d=o.slice(_,p);c=i=this._doCmacBlock(r,s.k1,s.k2,d,c);}return i.slice(0,n);},t.prototype._doCmacBlock=function(e,t,a,r,n){for(var s=new Buffer(16),o=0;o<16;o++)o<r.length?s.writeUInt8(r.readUInt8(o),o):o==r.length?s.writeUInt8(128,o):s.writeUInt8(0,o);return n&&(s=this._xor(s,n)),s=r.length<16?this._xor(s,a):this._xor(s,t),this._doAES128(e,null,s);},t.prototype._getCmacSubkey=function(e){var t,a,r=new Buffer("00000000000000000000000000000000","hex"),n=new Buffer("00000000000000000000000000000087","hex"),s=this._doAES128(e,null,r);return t=new Buffer(s.toString("hex"),"hex"),this._bufShiftLeft(t,1),128&s.readUInt8(0)&&(t=this._xor(t,n)),a=new Buffer(t.toString("hex"),"hex"),this._bufShiftLeft(a,1),128&t.readUInt8(0)&&(a=this._xor(a,n)),{k1:t,k2:a};},t.prototype._doAES128=function(e,t,a){t||(t=new Buffer("00000000000000000000000000000000","hex"));var r=crypto.createCipheriv("aes128",e,t);r.setAutoPadding(!1);var n=r.update(a),s=r["final"]();return Buffer.concat([n,s]);},t.prototype._xor=function(e,t){for(var a=Math.max(e.length,t.length),r=new Buffer(a),n=0;n<a;n++){var s,o=0,i=0;n<e.length&&(o=e.readUInt8(n)),n<t.length&&(i=t.readUInt8(n)),s=o^i,r.writeUInt8(s,n);}return r;},t.prototype._bufShiftLeft=function(e,t){if(t!==(0|t))throw new Error("shiftBits must be a 32 bit int");for(var a=2*((t>>4)+(0!=(15&t))),r=8*a-t,n=0,s=0;s-a<e.length;s+=2)if(n<<=16,s<e.length-1?n|=e.readUInt16BE(s):s<e.length&&(n|=e[s]<<8),s-a>=0){if(s-a<e.length-1)e.writeUInt16BE(n>>>r&65535,s-a);else{if(s-a!=e.length-1)throw new Error();e[s-a]=n>>>r+8;}}else s-a==-1&&(e[0]=n>>>r);},t.prototype._bufToInt=function(e){var t=e.toString("hex");return parseInt(t,16);},t.prototype._intToBuf=function(e,t){for(var a=e.toString(16);a.length<2*t;)a="0"+a;return new Buffer(a,"hex");},t.prototype._incRLC=function(e){var t=this._bufToInt(e);t+=1;var a=65535;return 3==e.length&&(a=16777215),t>a&&(t=0),this._intToBuf(t,e.length);},t.prototype._getFile=function(){var e=require("x.hub.fileman.js").fileManager,t=require("path"),a=(require("fs"),e.getUserRootDataPath());return t.resolve(a,this.SECURITY_FILE);},t.prototype._loadSec=function(e){var t=this._getFile();fs_extra.ensureFile(t,function(a){a?e&&e(a):fs_extra.readFile(t,"utf8",function(t,a){if(t)e&&e(t);else{var r;try{for(var n in r=JSON.parse(a))if(r.hasOwnProperty(n)){var s=r[n];s.rlc&&(s.rlc=new Buffer(s.rlc,"hex")),s.completeKey&&(s.completeKey=new Buffer(s.completeKey,"hex"));}}catch(e){}e&&e(null,r);}});});},t.prototype._saveSec=function(e,t){var a=this._getFile(),r={};for(var n in e)r[n]={},r[n].teachInInfo=e[n].teachInInfo,r[n].slf=e[n].slf,r[n].rlc=e[n].rlc.toString("hex"),r[n].completeKey=e[n].completeKey.toString("hex");fs_extra.writeFile(a,JSON.stringify(r,null,2),function(e){t&&t(e);});},t;}(),x.hub.m.enocean.LearnHandler=function(){var e,t=((e=function e(_e4){this._handler=_e4;}).prototype.onTelegram=function(e){var t=this;if(176===e.rorg){if(!this._isProfileMatch(e.getManufacturerId(),e.getProductId()))return;var a={address:e.senderID,data:this._getLearnProfile(),vendor:this._getLearnVendor(),senderID:x.hub.m.enocean.SENDER_ID,gpInfo:e.toJSON()};0==e.purpose?this._handler._controller._deviceHandler.onLearnDevice(null,a,function(a,r){a?t._sendTeachInResponse(0,null,x.hub.m.enocean.SENDER_ID,e.senderID,function(){t._handler._learnFinish(a,-1,r);}):t._sendTeachInResponse(1,null,x.hub.m.enocean.SENDER_ID,e.senderID,function(){t._handler._learnFinish(a,0,r);});}):1==e.purpose?this._handler._controller._deviceHandler.deleteDevice(a,function(a,r){a?t._sendTeachInResponse(0,null,x.hub.m.enocean.SENDER_ID,e.senderID,function(){t._handler._learnFinish(a,-1,r);}):t._sendTeachInResponse(2,null,x.hub.m.enocean.SENDER_ID,e.senderID,function(){t._handler._learnFinish(a,1,r);});}):2==e.purpose&&this._handler._controller._deviceHandler.onLearnAddDeleteDevice(a,function(a,r,n){a?t._sendTeachInResponse(0,null,x.hub.m.enocean.SENDER_ID,e.senderID,function(){t._handler._learnFinish(a,r,n);}):t._sendTeachInResponse(0==r?1:2,null,x.hub.m.enocean.SENDER_ID,e.senderID,function(){t._handler._learnFinish(a,r,n);});});}},e.prototype._sendTeachInResponse=function(e,t,a,r,n){a||(a=x.hub.m.enocean.SENDER_ID);var s=new x.hub.m.enocean.ESP3.Telegram.GP_TR(2047,e,t,a,0);s.setDstId(r),this._handler._controller._esp3.sendTelegram(s,!0,function(e){n&&n(e);});},e.prototype._isProfileMatch=function(e,t){var a=this._handler._learnProfile;if(!a)return!0;if("gp"==a)return!0;var r=x.hub.m.enocean.profiles[a];if(!r)return!1;var n=new r();return n._data==a&&(!n.isGPMatch||n.isGPMatch(e,t));},e.prototype._getLearnProfile=function(){return this._handler._learnProfile?this._handler._learnProfile:"gp";},e.prototype._getLearnVendor=function(){return this._handler._learnVendor;},e),a=function a(e){this._controller=e,this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.LearnHandler"),this._learning=!1,this._learnCallback=null,this._learnProfile=null,this._learnAddress=null,this._learnSenderID=null,this._learnVendor=null,this._saParams=null,this._secTeachInFrames={},this._teaching=!1,this._teachCallback=null,this._teachProfile=null,this._teachID=null,this._teachSenderID=null,this._teachVendor=null,this._teachingTO=null;var a=this;this._teachinTelegramCB={_onEOTelegram:function _onEOTelegram(e){a.onTeachInResponseTelegram(e);}},this._gpLearn=new t(this);};return a.prototype.learn=function(e,t,a,r,n,s,o){if(this._learning)s&&s(new Error("learning process running"));else if(this._teaching)s&&s(new Error("teach-in process running"));else{if((!n||n<=0)&&(n=3e4),this._learning=!0,this._learnCallback=s,this._learnProfile=e?e.toLowerCase():null,this._learnAddress=t?t.toLowerCase():null,this._learnVendor=r||"general",this._learnSenderID=a?a.toLowerCase():null,this._secTeachInFrames={},this._saParams=null,e&&("bb-aa-cc"==e.toLowerCase()||"d2-06-10"==e.toLowerCase()||"d2-06-ff"==e.toLowerCase()||"smartguard2"==e.toLowerCase())&&(this._saParams={extended:1},o&&void 0!==o.saLearnMode&&null!=o.saLearnMode)){var i=parseInt(o.saLearnMode);isNaN(i)&&(i=1),i<0&&(i=1),i>2&&(i=1),this._saParams.extended=i;}var l=this;this._controller._esp3.startLearn(this,n,this._saParams,function(e){if(e){var t=l._learnCallback;l._learning=!1,l._learnProfile=null,l._learnCallback=null,l._secTeachInFrames={},t&&t(e);}});}},a.prototype.onLearnTimeout=function(){this._learnFinish(new Error("learn timeout"));},a.prototype.onTelegram=function(e){if(e){var t;if(this._learnProfile){var a=x.hub.m.enocean.profiles[this._learnProfile];if(a){var r=new a();if(r.handleLearnTelegram)return void r.handleLearnTelegram(this,e);}}switch(e.rorg){case 212:if(0==e.cmd)return void this._learnUTE(e);break;case 213:0==e.getLearnBit()&&this._learn1BS(e);break;case 165:0==e.getLearnBit()&&this._learn4BS(e);break;case 176:case 177:this._gpLearn.onTelegram(e);break;case 246:this._learnRPS(e);break;case 53:var n=this._controller._secHandler.resolve(e);t=e.senderID;var s=this._secTeachInFrames[t];if(this._logger.log("trace","ts"),this._logger.log("trace",n),n&&(n.teachInInfo&&0==n.teachInInfo.idx?(s||(this._secTeachInFrames[t]=[],s=this._secTeachInFrames[t]),s.push(n)):n.teachInInfo&&0!=n.teachInInfo.idx&&s&&s.push(n)),s&&s[0]){var o=s[0];if(o&&o.teachInInfo){var i=o.teachInInfo.cnt;if(i&&s.length==i){if(i>1){for(var l=[],u=0;u<s.length;u++){var c=s[u];l.push(c.key);}o.completeKey=Buffer.concat(l);}else o.completeKey=o.key;this._controller._secHandler.secureTeachIn(t,o);}}}}}},a.prototype.onEvent=function(e){if(e&&e instanceof x.hub.m.enocean.ESP3.Event.SA_CONFIRM_LEARN){var t=e.getEEP();if(this._learnProfile&&!this._isLearningProfileEquals(t))return;var a=this._learnProfile?this._learnProfile:t;"d2-06-ff"==t&&"smartguard2"==this._learnProfile&&(a="d2-06-ff");var r,n=this,s=x.hub.m.enocean.profiles[a];s||(r=new x.hub.m.enocean.ESP3.Response.Response_OK_SA_CONFIRM_LEARN(500,17),this._controller._esp3.sendResponse(r,function(e){n._learnFinish(new Error("eep not supported"));})),s=new s();var o=e.getPMCandidateId();o||(o=s.UNIQUE_GATEWAY_SENDERID?this._controller._deviceHandler.getNextFreeSenderId():x.hub.m.enocean.SENDER_ID);var i={address:e.getSAClientId(),data:a,vendor:this._learnVendor,senderID:o,hopCount:e.getHopCount(),saLearnMode:this._saParams?this._saParams.extended:null,originalEEP:t};this._controller._deviceHandler.onLearnAddDeleteDevice(i,function(t,a,s){if(t)return r=new x.hub.m.enocean.ESP3.Response.Response_OK_SA_CONFIRM_LEARN(500,19),void n._controller._esp3.sendResponse(r,function(e){n._learnFinish(e);});var o=0;1==a&&(o=32);var i=128*(e.getHopCount()+1);r=new x.hub.m.enocean.ESP3.Response.Response_OK_SA_CONFIRM_LEARN(i,o),n._controller._esp3.sendResponse(r,function(e){n._learnFinish(e,a,s);});});}},a.prototype.onTeachInResponseTelegram=function(e){if(e&&this._teaching){var t=this;if(this._teachProfile){var a=x.hub.m.enocean.profiles[this._teachProfile];if(a){var r=new a();if(r.handleTeachinTelegram)return void r.handleTeachinTelegram(this,e);}}if(165===e.rorg&&0==e.getLearnBit()&&1==e.getLearnStatus()){var n=e.getFunc(),s=e.getType();if(this._toProfileStr(165,n,s),1==e.getLearnResult())this._controller._deviceHandler.onLearnDevice({address:this._teachID,senderID:this._teachSenderID,data:this._teachProfile,vendor:this._teachVendor},{address:e.senderID,senderID:this._teachSenderID,data:this._teachProfile,vendor:this._teachVendor},function(e,a){t._teachFinish(e,a);});else if(0==e.getLearnResult()){var o=this._controller._deviceHandler.getDevice(this._teachID);t._teachFinish(null,o,1);}}}},a.prototype._learnRPS=function(e){var t=this._getRealProfile(this._learnProfile),a=this;t&&"f6"!=t.substr(0,2)||((t=this._learnProfile)||(t="f6-??-??"),this._controller._deviceHandler.onLearnDevice({address:this._learnAddress,senderID:this._learnSenderID,data:this._learnProfile,vendor:this._learnVendor},{address:e.senderID,senderID:this._learnSenderID,data:t,vendor:this._learnVendor},function(e,t){a._learnFinish(e,0,t);}));},a.prototype._learn1BS=function(e){var t=this,a=this._getRealProfile(this._learnProfile);a&&"d5"!=a.substr(0,2)||((a=this._learnProfile)||(a="d5-??-??"),this._controller._deviceHandler.onLearnDevice({address:this._learnAddress,senderID:this._learnSenderID,data:this._learnProfile,vendor:this._learnVendor},{address:e.senderID,senderID:this._learnSenderID,data:a,vendor:this._learnVendor},function(e,a){t._learnFinish(e,0,a);}));},a.prototype._learn4BS=function(e){if(0==e.getLearnType())this._learn4BSV1(e);else{var t=e.getFunc(),a=e.getType(),r=this._toProfileStr(165,t,a),n=x.hub.m.enocean.profiles[r];n&&(3==new n().TEACH_IN_VARIATION?this._learn4BSV3(e):this._learn4BSV2(e));}},a.prototype._learn4BSV1=function(e){var t=this._getRealProfile(this._learnProfile);if(t){if("a5"!=t.substr(0,2))return;var a=x.hub.m.enocean.profiles[this._learnProfile];if(!a)return;if(1!=new a().TEACH_IN_VARIATION)return;}var r=this;(t=this._learnProfile)||(t="a5-??-??"),this._controller._deviceHandler.onLearnDevice({address:this._learnAddress,senderID:this._learnSenderID,data:this._learnProfile,vendor:this._learnVendor},{address:e.senderID,senderID:this._learnSenderID,data:t,vendor:this._learnVendor},function(e,t){r._learnFinish(e,0,t);});},a.prototype._learn4BSV2=function(e){var t=e.getFunc(),a=e.getType(),r=this._toProfileStr(165,t,a);if(!this._learnProfile||this._isLearningProfileEquals(r)){r=this._learnProfile?this._learnProfile:r;var n=x.hub.m.enocean.profiles[r];if(n)if(3!=new n().TEACH_IN_VARIATION){var s=this,o=r;this._controller._deviceHandler.onLearnDevice({address:this._learnAddress,senderID:this._learnSenderID,data:this._learnProfile,vendor:this._learnVendor},{address:e.senderID,senderID:this._learnSenderID,data:o,vendor:this._learnVendor},function(e,t){s._learnFinish(e,0,t);});}else this._learn4BSV3(e);}},a.prototype._learn4BSV3=function(e){var t=e.getFunc(),a=e.getType(),r=this._toProfileStr(165,t,a);if(!this._learnProfile||this._isLearningProfileEquals(r)){r=this._learnProfile?this._learnProfile:r;var n=x.hub.m.enocean.profiles[r],s=this;if(n){n=new n();var o=s._learnSenderID;!o&&n.UNIQUE_GATEWAY_SENDERID&&(o=require("x.hub.m.enocean.js")._deviceHandler.getNextFreeSenderId()),this._controller._deviceHandler.onLearnDevice({address:this._learnAddress,senderID:o,data:this._learnProfile,vendor:this._learnVendor},{address:e.senderID,senderID:o,data:r,vendor:this._learnVendor},function(t,a){t?s._send4BSResponse(null,1,0,e,function(){s._learnFinish(t,0,a);}):s._send4BSResponse(o,1,1,e,function(){s._learnFinish(null,0,a);});});}else this._send4BSResponse(null,0,0,e,function(){s._learnFinish(new Error("eep not supported"));});}},a.prototype._send4BSResponse=function(e,t,a,r,n){e||(e=x.hub.m.enocean.SENDER_ID);var s=r.getFunc(),o=r.getType(),i=(r.getManufacturerId(),(63&s)<<2|o>>5&3),l=(31&o)<<3|x.hub.m.enocean.MANUFACTURE_ID>>8&7,u=255&x.hub.m.enocean.MANUFACTURE_ID,c=128|t<<6|a<<5|16,h=new x.hub.m.enocean.ESP3.Telegram.BS4(new Buffer([i,l,u,c]),e,0);h.setDstId(r.senderID),this._controller._esp3.sendTelegram(h,!0,function(e){n&&n(e);});},a.prototype._learnUTE=function(e){var t,a=this._toProfileStr(e.eepRorg,e.eepFunc,e.eepType),r=this;if(!this._learnProfile||this._isLearningProfileEquals(a)){a=this._learnProfile?this._learnProfile:a;var n=x.hub.m.enocean.profiles[a];if(n){n=new n(),(t=this._learnSenderID)||(t=n.UNIQUE_GATEWAY_SENDERID?require("x.hub.m.enocean.js")._deviceHandler.getNextFreeSenderId():x.hub.m.enocean.SENDER_ID);var s={address:e.senderID,data:a,vendor:this._learnVendor,senderID:t};switch(e.subtype){case 0:this._controller._deviceHandler.onLearnDevice({address:this._learnAddress,senderID:this._learnSenderID,data:this._learnProfile,vendor:this._learnVendor},s,function(a,n){if(0==e.rspExpected){var s=0;a&&404==a.errorCode?s=3:a||(s=1),r._sendUTEResponse(t,s,e,function(){r._learnFinish(a,0,n);});}else r._learnFinish(a,0,n);});break;case 1:this._controller._deviceHandler.deleteDevice(s,function(a,n){if(0==e.rspExpected){var s=0;a&&404==a.errorCode?s=3:a||(s=2),r._sendUTEResponse(t,s,e,function(){r._learnFinish(a,1,n);});}else r._learnFinish(a,1,n);});break;case 2:this._controller._deviceHandler.onLearnAddDeleteDevice(s,function(a,n,s){if(0==e.rspExpected){var o=0;a&&404==a.errorCode?o=3:a||(0==n?o=1:1==n&&(o=2)),r._sendUTEResponse(t,o,e,function(){r._learnFinish(a,n,s);});}else r._learnFinish(a,n,s);});}}}},a.prototype._sendUTEResponse=function(e,t,a,r){e||(e=x.hub.m.enocean.SENDER_ID);var n=new x.hub.m.enocean.ESP3.Telegram.UTE(1,a.ute,0,t,a.numChannel,a.manufactureID,a.eepType,a.eepFunc,a.eepRorg,e,0);n.setDstId(a.senderID),this._controller._esp3.sendTelegram(n,!0,function(e){r&&r(e);});},a.prototype._learnFinish=function(e,t,a){var r=this._learnCallback;this._learning=!1,this._learnCallback=null,this._learnProfile=null,this._learnAddress=null,this._learnSenderID=null,this._learnVendor=null,this._secTeachInFrames={};var n=this._saParams;this._saParams=null,this._controller._esp3.stopLearn(this,n,function(){}),r&&r(e,t,a),!e&&0==t&&a&&a.init&&setTimeout(function(){a.init();},1e3);},a.prototype._toProfileStr=function(e,t,a){for(var r=e.toString(16);r.length<2;)r="0"+r;for(var n=t.toString(16);n.length<2;)n="0"+n;for(var s=a.toString(16);s.length<2;)s="0"+s;return(r+"-"+n+"-"+s).toLowerCase();},a.prototype._fromProfileStr=function(e){var t=e.split("-");return{rorg:parseInt(t[0],16),func:parseInt(t[1],16),type:parseInt(t[2],16)};},a.prototype._getRealProfile=function(e){if(!e)return null;var t=x.hub.m.enocean.profiles[e];if(!t)return e;var a=new t();return a._eepAlias?a._eepAlias:e;},a.prototype._isLearningProfileEquals=function(e){if(!this._learnProfile)return!1;if(this._learnProfile==e)return!0;if("bb-aa-cc"==this._learnProfile&&"d2-06-10"==e)return!0;if("d2-06-10"==this._learnProfile&&"bb-aa-cc"==e)return!0;if("smartguard2"==this._learnProfile&&"d2-06-11"==e)return!0;if("smartguard2"==this._learnProfile&&"d2-06-ff"==e)return!0;var t=x.hub.m.enocean.profiles[this._learnProfile];return!!t&&new t()._eepAlias==e;},a.prototype.teachin=function(e,t,a,r,n){if(this._teaching)n&&n(new Error("teach-in process running"));else if(this._learning)n&&n(new Error("learning process running"));else if(e){e=e.toLowerCase(),t||(t=this._controller._deviceHandler.getNextFreeAddress());var s=this;this._teachCallback=n,this._teachProfile=e,this._teachID=t,this._teachSenderID=a,this._teachVendor=r||"general",this._teaching=!0,this._teachingTO=setTimeout(function(){s._teachFinish(new Error("teach-in timeout"));},3e4);var o,i=e,l=x.hub.m.enocean.profiles[i];if(l&&((l=new l()).getTeachinType&&(o=l.getTeachinType()),l.isTeachinBidirectional&&l.isTeachinBidirectional()),o||(i=this._getRealProfile(i),(l=x.hub.m.enocean.profiles[i])&&((l=new l()).getTeachinType&&(o=l.getTeachinType()),l.isTeachinBidirectional&&l.isTeachinBidirectional())),!o)switch(i.substr(0,2)){case"f6":o="RPS";break;case"d5":o="1BS";break;case"a5":o="4BS";}switch(o){case"RPS":this._teachinRPS(e,t,a);break;case"1BS":this._teachin1BS(e,t,a);break;case"4BS":this._teachin4BS(e,t,a);break;case"UTE":this._teachinUTE(e,t,a);break;default:this._teachFinish(new Error("profile not supported"));}}else n&&n(new Error("profile is null"));},a.prototype._teachinRPS=function(e,t,a){this._teachFinish(new Error("RPS teach-in should be done by execute command directly"));},a.prototype._teachin1BS=function(e,t,a){},a.prototype._teachin4BS=function(e,t,a){var r=2,n=e,s=x.hub.m.enocean.profiles[n];switch(s?r=new s().TEACH_IN_VARIATION:(n=this._getRealProfile(n),(s=x.hub.m.enocean.profiles[e])&&(r=new s().TEACH_IN_VARIATION)),r){case 1:this._teachin4BSV1(e,t,a);break;case 2:this._teachin4BSV2(e,t,a);break;case 3:this._teachin4BSV3(e,t,a);break;default:this._teachFinish(new Error("no supported"));}},a.prototype._teachin4BSV1=function(e,t,a){},a.prototype._teachin4BSV2=function(e,t,a){var r=a;if(a||(r=require("x.hub.m.enocean.js")._deviceHandler.getNextFreeSenderId())){var n,s=e,o=x.hub.m.enocean.profiles[s];if(o||(s=this._getRealProfile(s),o=x.hub.m.enocean.profiles[e]),o&&(o=new o())._eepAlias&&(e=o._eepAlias),o&&o.getTeachinTelegram)n=o.getTeachinTelegram(t,r,x.hub.m.enocean.MANUFACTURE_ID);else{var i=this._fromProfileStr(e),l=(63&i.func)<<2|i.type>>6&2,u=(31&i.type)<<3|x.hub.m.enocean.MANUFACTURE_ID>>8&7,c=255&x.hub.m.enocean.MANUFACTURE_ID,h=new Buffer([l,u,c,128]);n=new x.hub.m.enocean.ESP3.Telegram.BS4(h,r,0);}var _=this;this._controller._esp3.sendTelegram(n,!0,function(e){e?_._teachFinish(e):(t||(t=r),_._controller._deviceHandler.addDevice({address:t,data:_._teachProfile,senderID:r,vendor:_._teachVendor},function(e,t){_._teachFinish(e,t);}));});}else this._teachFinish(new Error("no more sender ID available"));},a.prototype._teachin4BSV3=function(e,t,a){var r=a;if(!a){if(!(r=require("x.hub.m.enocean.js")._deviceHandler.getNextFreeSenderId()))return void this._teachFinish(new Error("no more sender ID available"));this._teachSenderID=r;}var n,s=e,o=x.hub.m.enocean.profiles[s];if(o||(s=this._getRealProfile(s),o=x.hub.m.enocean.profiles[e]),o&&(o=new o())._eepAlias&&(e=o._eepAlias),o&&o.getTeachinTelegram)n=o.getTeachinTelegram(t,r,x.hub.m.enocean.MANUFACTURE_ID);else{var i=this._fromProfileStr(e),l=(63&i.func)<<2|i.type>>6&2,u=(31&i.type)<<3|x.hub.m.enocean.MANUFACTURE_ID>>8&7,c=255&x.hub.m.enocean.MANUFACTURE_ID,h=new Buffer([l,u,c,128]);n=new x.hub.m.enocean.ESP3.Telegram.BS4(h,r,0);}var _=this;this._controller._esp3.addListener(this._teachinTelegramCB),this._controller._esp3.sendTelegram(n,!0,function(e){e&&_._teachFinish(e);});},a.prototype._teachinUTE=function(e,t,a){var r=a;if(!a){if(!(r=require("x.hub.m.enocean.js")._deviceHandler.getNextFreeSenderId()))return void this._teachFinish(new Error("no more sender ID available"));this._teachSenderID=r;}var n=e,s=x.hub.m.enocean.profiles[n];s||(n=this._getRealProfile(n),s=x.hub.m.enocean.profiles[e]),s&&(s=new s())._eepAlias&&(e=s._eepAlias);var o=e.split("-"),i=new x.hub.m.enocean.ESP3.Telegram.UTE(0,1,0,2,255,x.hub.m.enocean.MANUFACTURE_ID,parseInt(o[2],16),parseInt(o[1],16),parseInt(o[0],16),r,0);i.setDstId(reqTelegram.senderID),this._controller._esp3.sendTelegram(i,!0,function(e){e&&self._teachFinish(e);});},a.prototype._teachFinish=function(e,t,a){this._controller._esp3.removeListener(this._teachinTelegramCB);var r=this._teachCallback;this._teachingTO&&clearTimeout(this._teachingTO),this._teachingTO=null,this._teaching=!1,this._teachCallback=null,this._teachProfile=null,this._teachID=null,this._teachSenderID=null,this._teachVendor=null,this._saParams=null,r&&r(e,t,a);},a;}(),x.hub.m.enocean.DeviceHandler=function(){var e=function e(_e5){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.DeviceHandler"),this._controller=_e5,this._devices={};};return util.inherits(e,EventEmitter),e.prototype.SENSOR_FILE="enocean.json",e.prototype.UNKNOWN_PROFILE_ERR=404,e.prototype.ALREADY_EXISTS_ERR=400,e.prototype.init=function(e){this._logger.log("trace","init");var t=this;this._loadDevices(function(a,r){a&&t._logger.log("warn","init error:"+a.message),r&&(t._devices=r),t._initDevices(),e&&e();});},e.prototype._initDevices=function(){var e=Object.keys(this._devices),t=0,a=this,r=function r(){++t<e.length&&(a._devices[e[t]]&&a._devices[e[t]].init?a._devices[e[t]].init(r):r());};this._devices[e[t]]&&this._devices[e[t]].init?this._devices[e[t]].init(r):r();},e.prototype.getDevice=function(e){if(!e)return null;var t=this._devices[e];if(t)return t;var a=parseInt(e,16);for(a=(a-=1).toString(16);a.length<8;)a="0"+a;return(t=this._devices[a])&&t instanceof x.hub.m.enocean.profiles.eltako_f6t?t:null;},e.prototype.getAllDevices=function(){return this._devices;},e.prototype.findDevice=function(e){return e&&e.address?this._devices[e.address]:null;},e.prototype.findDeviceWithData=function(e){if(!e)return null;var t=[];for(var a in this._devices){var r=this._devices[a];r&&r.getData()==e&&t.push(r);}return t;},e.prototype.addDevice=function(e,t){var a;if(!e||!e.data)return a=new Error("device json invalid"),void(t&&t(a));e.address||(e.address=this.getNextFreeAddress()),e.address=e.address.toLowerCase(),e.senderID&&(e.senderID=e.senderID.toLowerCase());var r=x.hub.m.enocean.profiles.parseJson(e);if(!r)return(a=new Error("unknow profile")).errorCode=this.UNKNOWN_PROFILE_ERR,void(t&&t(a));var n=r._address,s=this._devices[n];s&&s._data==r._data&&(r._states=s._states),this._devices[n]=r,this._saveDevices(this._devices,function(e){t&&t(e,r);});},e.prototype.updateDevice=function(e,t,a){var r;if(!e)return r=new Error("address invalid"),void(a&&a(r));if(!t||!t.data)return r=new Error("device json invalid"),void(a&&a(r));var n=this._devices[e];t.address||(t.address=e),t.address=t.address.toLowerCase(),t.senderID&&(t.senderID=t.senderID.toLowerCase());var s=x.hub.m.enocean.profiles.parseJson(t);if(!s)return(r=new Error("unknow profile")).errorCode=this.UNKNOWN_PROFILE_ERR,void(a&&a(r));n&&n._data==s._data&&(s._params=n._params,s._states=n._states),this._devices[t.address]=s,t.address!=e&&delete this._devices[e],this._saveDevices(this._devices,function(e){a&&a(e,s);});},e.prototype.deleteDevice=function(e,t){if(e&&e.address&&this._devices[e.address]){var a=this._devices[e.address];a&&a.finalize&&a.finalize();var r=this._devices[e.address];delete this._devices[e.address],this.emit("deleteDevice",r),this._saveDevices(this._devices,function(e){t&&t(e,a);});}else t&&t();},e.prototype.onLearnAddDeleteDevice=function(e,t){e&&e.address?this._devices[e.address]?this.deleteDevice(e,function(e,a){t&&t(e,1,a);}):this.onLearnDevice(null,e,function(e,a){t&&t(e,0,a);}):t&&t();},e.prototype.onLearnDevice=function(e,t,a){var r;if(!t||!t.address||!t.data)return r=new Error("device json invalid"),void(a&&a(r));var n=x.hub.m.enocean.profiles.parseJson(t);if(!n)return(r=new Error("unknow profile")).errorCode=this.UNKNOWN_PROFILE_ERR,void(a&&a(r));var s=t.address;if(this._devices[s]){var o=this._devices[s],i=o.toJSON();return i.data!=t.data||i.vendor!=t.vendor?((r=new Error("address "+t.address+" already exists, please delete it first")).errorCode=this.ALREADY_EXISTS_ERR,void(a&&a(r))):i.senderID!=t.senderID?(o._senderID=t.senderID,"bb-aa-cc"==o._data||"d2-06-10"==o._data||"d2-06-ff"==o._data||"smartguard2"==n._data?(o.executeCommand(null,{value:"alertOn"}),o.executeCommand(null,{value:"preAlarmOn"})):"afriso_water_eco"==n._data&&n.onLearn(),void this._saveDevices(this._devices,function(e){a&&a(e,o);})):void(a&&a(null,o));}if(e){var l=e.address;l&&l!=s&&this._devices[l]&&delete this._devices[l];}this._devices[s]=n,"bb-aa-cc"==n._data||"d2-06-10"==n._data||"d2-06-ff"==n._data||"smartguard2"==n._data?(n.executeCommand(null,{value:"alertOn"}),n.executeCommand(null,{value:"preAlarmOn"})):"afriso_water_eco"==n._data&&n.onLearn(),this._saveDevices(this._devices,function(e){a&&a(e,n);});},e.prototype.deviceParamsUpdated=function(e,t){this._saveDevices(this._devices,function(e){t&&t(e);});},e.prototype.isVirtual=function(e){var t=x.hub.m.enocean.SENDER_ID;if(!t)return!1;var a=parseInt(t,16)+1,r=parseInt(t,16)+128,n=parseInt(e,16);return n>=a&&n<=r;},e.prototype.getVirtualSenderID=function(){var e=x.hub.m.enocean.SENDER_ID;if(!e)return[];var t=parseInt(e,16)+1,a=parseInt(e,16)+128,r=[],n=this._devices;for(var s in n){var o=n[s];if(o&&o._senderID){var i=parseInt(o._senderID,16);i>=t&&i<=a&&r.push(i);}}return r;},e.prototype.getVirtualAddress=function(){var e=[],t=this._devices;for(var a in t)if("x"==a.charAt(0)){var r=parseInt(a.substr(1),16);r>=0&&r<=268435455&&e.push(a);}return e;},e.prototype.getFreeSenderIdCount=function(){return 128-this.getVirtualSenderID().length;},e.prototype.getNextFreeSenderId=function(){var e=x.hub.m.enocean.SENDER_ID;if(!e)return null;for(var t=parseInt(e,16)+1,a=parseInt(e,16)+128,r=this.getVirtualSenderID(),n=null,s=t;s<=a;s++)if(-1==r.indexOf(s)){n=s;break;}if(n)for(n=n.toString(16).toLowerCase();n.length<8;)n="0"+n;return n;},e.prototype.getNextFreeAddress=function(){for(var e=this.getVirtualAddress(),t=null,a=0;a<=268435455;a++){for(var r=a.toString(16);r.length<7;)r="0"+r;if(r="x"+r,-1==e.indexOf(r)){t=r;break;}}return t;},e.prototype.generateVirtual=function(e,t){if(e&&e.data){var a=e.senderID;if(a||(a=this.getNextFreeSenderId())){e.senderID=a,e.address=a,e.virtual=!0;var r=this.findDevice(e);if(r){var n=r.toJSON();return e.data!=n.data?void(t&&t(new Error("device of another type with the same address exists"))):e.vendor&&e.vendor!=n.vendor?void(t&&t(new Error("device of another vendor with the same address exists"))):void(t&&t(null,r));}var s=x.hub.m.enocean.profiles.parseJson(e);s?this.addDevice(s.toJSON(),function(e,a){t&&t(e,a);}):t&&t(new Error("unknow profile"));}else t&&t(new Error("no sender id available"));}else t&&t(new Error("query is null"));},e.prototype._getFile=function(){var e=fileman.fileManager,t=require("path"),a=e.getUserRootDataPath();return t.resolve(a,this.SENSOR_FILE);},e.prototype._loadDevices=function(e){var t=require("fs-extra"),a=this._getFile();t.ensureFile(a,function(r){r?e&&e(r):t.readFile(a,"utf8",function(t,a){if(t)e&&e(t);else if(a)try{var r={},n=JSON.parse(a);for(var s in n){var o=n[s],i=x.hub.m.enocean.profiles.parseDBJson(o);i&&(r[s]=i);}e&&e(null,r);}catch(t){e&&e(t);}else e&&e(null,{});});});},e.prototype._saveDevices=function(e,t){var a=this._getFile(),r={};for(var n in e){var s=e[n];r[n]=s.toDBJSON();}fs_extra.writeFile(a,JSON.stringify(r,null,2),function(e){t&&t(e);});},e;}(),x.hub.m.enocean.ESP3=function(){var e=function e(_e6,t,a){this.type=_e6,this.data=t,this.optData=a;};e.TYPE={1:"RADIO_ERP1",2:"RESPONSE",3:"RADIO_SUB_TEL",4:"EVENT",5:"COMMAND_COMMAND",6:"SMART_ACK_COMMAND",7:"REMOTE_MAN_COMMAND",9:"RADIO_MESSAGE",10:"RADIO_ERP2",16:"RADIO_802_15_4",17:"COMMAND_2_4"},e.prototype.toBuffer=function(){var e=new Buffer(6);e.writeUInt8(85,0),e.writeUInt16BE(this.data.length,1),e.writeUInt8(this.optData?this.optData.length:0,3),e.writeUInt8(this.type,4),e.writeUInt8(0,5);var t=x.hub.m.enocean.CRC8(e.slice(1,5));e.writeUInt8(t,5);var a=this.optData?Buffer.concat([this.data,this.optData],this.data.length+this.optData.length):this.data,r=x.hub.m.enocean.CRC8(a),n=Buffer.concat([e,a],6+a.length+1);return n.writeUInt8(r,n.length-1),n;},e.prototype.toJSON=function(){return{dataLen:this.data.length,optLen:this.optData?this.optData.length:0,type:this.type,typeName:e.TYPE[this.type],data:this.data.toString("hex"),optData:this.optData?this.optData.toString("hex"):null};},e.prototype.toPacket=function(){return t.resolve(this);};var t=function t(){};t.resolve=function(e){switch(e.type){case 1:return r.resolve(e);case 2:return a.resolve(e);case 4:return o.resolve(e);case 5:return s.resolve(e);case 6:return n.resolve(e);default:return null;}};var a=function a(e,t,_a2){this.retCode=e,this.resData=t,this.optData=_a2;};a.CODE={0:"RET_OK",1:"RET_ERROR",2:"RET_NOT_SUPPORTED",3:"RET_WRONG_PARAM",4:"RET_OPERATION_DENIED",5:"RET_LOCK_SET",6:"RET_BUFFER_TO_SMALL",7:"RET_NO_FREE_BUFFER"},a.prototype.toJSON=function(){return{retCodeName:a.CODE[this.retCode],retCode:this.retCode.toString(16),resData:this.resData?this.resData.toString("hex"):null,optData:this.optData?this.optData.toString("hex"):null};},a.prototype.toFrame=function(){var t=new Buffer(1);return t.writeUInt8(this.retCode,0),this.resData&&(t=Buffer.concat([t,this.resData])),new e(2,t,this.optData);},a.prototype.toResponse=function(){return T.resolve(this);},a.resolve=function(e){var t,r,n;return t=e.data.readUInt8(0),e.data.length>1&&(r=e.data.slice(1)),n=e.optData,new a(t,r,n);};var r=function r(e,t,a,_r,n,s){this.data=e,this.hasOpt=t,t&&(this.subTelNum=a,this.dstId=_r,this.dBm=n,this.securityLvl=s);};r.prototype.toJSON=function(){var e={data:this.data.toString("hex")};return this.hasOpt&&(e.subTelNum=this.subTelNum.toString(16),e.dstId=this.dstId,e.dBm=this.dBm.toString(16),e.securityLvl=this.securityLvl),e;},r.prototype.toFrame=function(){var t=this.data,a=null;return this.hasOpt&&(a=new Buffer([this.subTelNum]),a=Buffer.concat([a,new Buffer(this.dstId,"hex")]),a=Buffer.concat([a,new Buffer([this.dBm,this.securityLvl])])),new e(1,t,a);},r.prototype.toRadioTelegram=function(){return i.resolve(this);},r.resolve=function(e){var t,a,n,s,o=!1;return e.optData&&(o=!0,t=e.optData.readUInt8(0),a=e.optData.slice(1,5).toString("hex"),n=e.optData.readUInt8(5),s=e.optData.readUInt8(6)),new r(e.data,o,t,a,n,s);};var n=function n(e){this.data=e;};n.prototype.toJSON=function(){return{data:this.data.toString("hex")};},n.prototype.toFrame=function(){var t=this.data;return new e(6,t,null);},n.prototype.toSACommand=function(){return O.resolve(this);},n.resolve=function(e){return new n(e.data);};var s=function s(e){this.data=e;};s.prototype.toJSON=function(){return{data:this.data.toString("hex")};},s.prototype.toFrame=function(){var t=this.data;return new e(5,t,null);},s.prototype.toCommandCommand=function(){return A.resolve(this);},s.resolve=function(e){return new s(e.data);};var o=function o(e){this.data=e;};o.prototype.toJSON=function(){return{data:this.data.toString("hex")};},o.prototype.toFrame=function(){var t=this.data;return new e(4,t,null);},o.prototype.toEvent=function(){return D.resolve(this);},o.resolve=function(e){return new o(e.data);};var i=function i(e,t){this.rorg=e,this.optData=t,this.optData||(this.optData={subTelNum:1,dstId:"FFFFFFFF",dBm:255,securityLvl:0});};i.prototype.setDstId=function(e){this.optData.dstId=e||"FFFFFFFF";},i.resolve=function(e){if(!e.data)return null;switch(e.data.readUInt8(0)){case 208:return d.resolve(e);case 246:return v.resolve(e);case 213:return f.resolve(e);case 165:return m.resolve(e);case 210:return g.resolve(e);case 212:return y.resolve(e);case 53:return S.resolve(e);case 49:return b.resolve(e);case 64:return p.resolve(e);case 176:return c.resolve(e);case 178:return _.resolve(e);default:return null;}};var l,u,c=function(){var e=function e(_e7,t,a){a>=8&&(a=8),a<=0&&(a=1);var r=Math.floor(t/8),n=t%8,s=Math.pow(2,a)-1,o=0;return n+a>8?(o=16-n-a,_e7.readUInt16BE(r)>>o&s):(o=8-n-a,_e7.readUInt8(r)>>o&s);},t=function t(e){this.type=e;};t.prototype.getType=function(){return this.type;},t.resolve=function(t,r){if(r+2>8*t.length)return null;var o=e(t,r,2),i=null;switch(o){case 0:i=a.resovle(t,r);break;case 1:i={type:o,sigType:t.readUInt16BE(0)>>6&255,valueType:t.readUInt16BE(0)>>2&3,resolution:15&t.readUInt16BE(0),engMin:t.readUInt8(2),scalingMin:t.readUInt16BE(3)>>12&15,engMax:t.readUInt16BE(3)>>4&255,scalingMax:15&t.readUInt16BE(3)};break;case 2:i=n.resovle(t,r);break;case 3:i=s.resovle(t,r);}return i;};var a=function a(e,_a3,r){t.call(this,0),this.sigType=e,this.dataLen=_a3,this.data=r;};a.prototype=new t(),a.prototype.constructor=a,a.prototype.getBitLength=function(){return 2==this.sigType?50:(this.sigType,18);},a.prototype.getProductID=function(){return 2==this.sigType&&this.data?this.data.readUInt32BE(0):null;},a.resovle=function(t,r){if(r+18>8*t.legnth)return null;var n=e(t,r+2,8),s=e(t,r+10,8),o=null;if(2==n){if(r+50>8*t.legnth)return null;var i=new Buffer(4);i.writeUInt8(e(t,r+18,8),0),i.writeUInt8(e(t,r+26,8),1),i.writeUInt8(e(t,r+34,8),2),i.writeUInt8(e(t,r+42,8),3),o=i;}else 1==n&&(o=null);return new a(n,s,o);};var r=function r(e,a,_r2,n,s,o,i){t.call(this,1),this.sigType=e,this.valueType=a,this.resolution=_r2,this.engMin=n,this.scalMin=s,this.engMax=o,this.scalMax=i;};(r.prototype=new t()).constructor=r,r.prototype.getBitLength=function(){return 40;},r.prototype.toJSON=function(){return{sigType:this.sigType,valueType:this.valueType,resolution:this.resolution,engMin:this.engMin,scalMin:this.scalMin,engMax:this.engMax,scalMax:this.scalMax};},r.resovle=function(t,a){if(a+40>8*t.length)return null;var n=e(t,a+2,8),s=e(t,a+10,2),o=e(t,a+12,4),i=e(t,a+16,8),l=e(t,a+24,4),u=e(t,a+28,8),c=e(t,a+36,4);return new r(n,s,o,i,l,u,c);};var n=function n(e,a){t.call(this,2),this.sigType=e,this.valueType=a;};n.prototype=new t(),n.prototype.constructor=n,n.prototype.getBitLength=function(){return 12;},n.resovle=function(t,a){if(a+12>8*t.length)return null;var r=e(t,a+2,8),s=e(t,a+10,2);return new n(r,s);},n.prototype.toJSON=function(){return{sigType:this.sigType,valueType:this.valueType};};var s=function s(e,a,r){t.call(this,3),this.sigType=e,this.valueType=a,this.resolution=r;};s.prototype=new t(),s.prototype.constructor=s,s.prototype.getBitLength=function(){return 16;},s.prototype.toJSON=function(){return{sigType:this.sigType,valueType:this.valueType,resolution:this.resolution};},s.resovle=function(t,a){if(a+16>8*t.length)return null;var r=e(t,a+2,8),n=e(t,a+10,2),o=e(t,a+12,4);return new s(r,n,o);};var o=function o(e,t,a){i.call(this,176),this.manufacturerID=e,this.dataDirection=t,this.purpose=a,this.productID=null,this.outboudChannels={},this.inboundChannels={},this.senderID=null,this.status=null;};return(o.prototype=new i()).constructor=o,o.prototype.getManufacturerId=function(){return this.manufacturerID;},o.prototype.getProductId=function(){return this.productID;},o.prototype.toJSON=function(){var e={manufacturerID:this.manufacturerID,dataDirection:this.dataDirection,purpose:this.purpose,productID:this.productID,outboudChannels:{},inboundChannels:{}};for(var t in this.outboudChannels)e.outboudChannels[t]=this.outboudChannels[t].toJSON();for(var t in this.inboundChannels)e.inboundChannels[t]=this.inboundChannels[t].toJSON();return e;},o.resolve=function(e){var a=e.data,r=a.readUInt16BE(1)>>5&2047,n=a.readUInt16BE(1)>>4&1,s=a.readUInt16BE(1)>>2&3,i=new o(r,n,s),l=a.slice(3,a.length-5),u=a.slice(a.length-5,a.length-1),c=a.readUInt8(a.length-1);i.senderID=u.toString("hex"),i.status=c;for(var h=0,_=0,p=0;;){var d=t.resolve(l,_);if(!d)break;0==h?0==d.getType()?i.productID=d.getProductID():(i.outboudChannels[p]=d,p++,h=1):1==h?0==d.getType()?h=2:(i.outboudChannels[p]=d,p++,h=1):2==h&&(i.inboundChannels[p]=d,p++),_+=d.getBitLength();}return i;},o;}(),h=(((l=function l(e,t,a,r,n){i.call(this,177),this.manufacturerID=e,this.result=t,this.chnAcknoledgement=a,this.senderID=r,this.status=n;}).prototype=new i()).constructor=l,l.prototype.toPacket=function(){var e=new Buffer(3);if(e.writeUInt8(this.rorg,0),e.writeUInt16BE(this.manufacturerID<<5|this.result<<3,1),3==this.result){var t=[];if(this.chnAcknoledgement){for(var a=Math.ceil(this.chnAcknoledgement.length/8),n=0;n<a.length;n++)t.push(0);for(var s=0;s<this.chnAcknoledgement.length;s++){var o=Math.floor(s/8),i=8-s%8-1;t[o]=chnAcknoledgement[s]<<i|t[o];}}e=Buffer.concat([e,new Buffer(t)]);}e=Buffer.concat([e,new Buffer(this.senderID,"hex")]),e=Buffer.concat([e,new Buffer([this.status])]);var l=1,u="FFFFFFFF",c=255,h=0;return this.optData&&(l=this.optData.subTelNum,u=this.optData.dstId,c=this.optData.dBm,h=this.optData.securityLvl),new r(e,!0,l,u,c,h);},l.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),manufacturerID:this.manufacturerID.toString(16),result:this.result,chnAcknoledgement:this.chnAcknoledgement,senderID:this.senderID,receiverID:this.receiverID};},l),_=(((u=function u(e,t,a){i.call(this,178),this.data=e,this.senderID=t,this.status=a;}).prototype=new i()).constructor=u,u.prototype.toPacket=function(){var e=new Buffer(1);e.writeUInt8(this.rorg,0),this.data&&(e=Buffer.concat([e,this.data])),e=Buffer.concat([e,new Buffer(this.senderID,"hex")]),e=Buffer.concat([e,new Buffer([this.status])]);var t=1,a="FFFFFFFF",n=255,s=0;return this.optData&&(t=this.optData.subTelNum,a=this.optData.dstId,n=this.optData.dBm,s=this.optData.securityLvl),new r(e,!0,t,a,n,s);},u.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),data:this.data?this.data.toString("hex"):null,senderID:this.senderID,status:this.status};},u.resolve=function(e){var t=e.data,a=t.slice(1,t.length-5),r=t.slice(t.length-5,t.length-1),n=t.readUInt8(t.length-1);return new u(a,r.toString("hex"),n);},u),p=function p(e,t,a,r,n,s,o,l){i.call(this,64,l),this.seq=e,this.idx=t,this.len=a,this.crorg=r,this.data=n,this.senderID=s,this.status=o;};p.prototype=new i(),p.prototype.constructor=p,p.prototype.getSenderID=function(){return this.senderID;},p.prototype.getSeq=function(){return this.seq;},p.prototype.getIdx=function(){return this.idx;},p.prototype.getLen=function(){return this.len;},p.prototype.getCRORG=function(){return this.crorg;},p.prototype.getData=function(){return this.data;},p.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),seq:this.seq,idx:this.idx,len:this.len,crorg:this.crorg?this.crorg.toString(16):null,data:this.data.toString("hex"),senderID:this.senderID,status:this.status};},p.resolve=function(e){var t,a,r,n,s,o,i=e.data,l=i.readUInt8(1)>>6&3,u=63&i.readUInt8(1);return 0==u?(t=i.readUInt16BE(2),a=i.readUInt8(4),r=i.slice(5,i.length-5),n=i.slice(i.length-5,i.length-1).toString("hex"),s=i.readUInt8(i.length-1)):(t=null,a=null,r=i.slice(2,i.length-5),n=i.slice(i.length-5,i.length-1).toString("hex"),s=i.readUInt8(i.length-1)),e.hasOpt&&(o={subTelNum:e.subTelNum,dstId:e.dstId,dBm:e.dBm,securityLvl:e.securityLvl}),new p(l,u,t,a,r,n,s,o);};var d=function d(e,t,a,r){i.call(this,208,r),this.messageIndex=e,this.userData=t,this.senderID=a;};d.prototype=new i(),d.prototype.constructor=d,d.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),messageIndex:this.messageIndex,userData:this.userData?this.userData.toString("hex"):null,senderID:this.senderID};},d.prototype.toPacket=function(){var e=new Buffer(2);e.writeUInt8(this.rorg,0),e.writeUInt8(this.messageIndex,1),this.userData&&(e=Buffer.concat([e,this.userData])),e=Buffer.concat([e,new Buffer(this.senderID,"hex")]);var t=1,a="FFFFFFFF",n=255,s=0;return this.optData&&(t=this.optData.subTelNum,a=this.optData.dstId,n=this.optData.dBm,s=this.optData.securityLvl),new r(e,!0,t,a,n,s);},d.resolve=function(e){var t,a=e.data,r=a.readUInt8(1),n=null,s=null;switch(r){case 1:n=0,s=a.slice(2,6).toString("hex");break;case 4:case 6:n=a.slice(2,3),s=a.slice(3,7).toString("hex");}return e.hasOpt&&(t={subTelNum:e.subTelNum,dstId:e.dstId,dBm:e.dBm,securityLvl:e.securityLvl}),new d(r,n,s,t);};var v=function v(e,t,a,r,n,s){i.call(this,246,s),this.userData=e||0,this.senderID=t,this.t21=a||0,this.nu=r||0,this.rc=n||0;};v.prototype=new i(),v.prototype.constructor=v,v.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),userData:this.userData.toString(16),senderID:this.senderID,t21:this.t21,nu:this.nu,rc:this.rc};},v.prototype.toPacket=function(){var e=new Buffer(2);e.writeUInt8(this.rorg,0),e.writeUInt8(this.userData,1),e=Buffer.concat([e,new Buffer(this.senderID,"hex")]);var t=this.t21<<5|this.nu<<4||this.rc;e=Buffer.concat([e,new Buffer([t])]);var a=1,n="FFFFFFFF",s=255,o=0;return this.optData&&(a=this.optData.subTelNum,n=this.optData.dstId,s=this.optData.dBm,o=this.optData.securityLvl),new r(e,!0,a,n,s,o);},v.resolve=function(e){var t,a=e.data,r=a.readUInt8(1),n=a.slice(2,6).toString("hex"),s=a.readUInt8(6)>>5&1,o=a.readUInt8(6)>>4&1,i=15&a;return e.hasOpt&&(t={subTelNum:e.subTelNum,dstId:e.dstId,dBm:e.dBm,securityLvl:e.securityLvl}),new v(r,n,s,o,i,t);};var f=function f(e,t,a,r){i.call(this,213,r),this.userData=e,this.senderID=t,this.rc=a||0;};f.prototype=new i(),f.prototype.constructor=f,f.prototype.getLearnBit=function(){return this.userData>>3&1;},f.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),userData:this.userData.toString(16),learn:this.getLearnBit(),senderID:this.senderID,rc:this.rc};},f.prototype.toPacket=function(){var e=new Buffer(2);e.writeUInt8(this.rorg,0),e.writeUInt8(this.userData,1),e=Buffer.concat([e,new Buffer(this.senderID,"hex")]);var t=this.rc;e=Buffer.concat([e,new Buffer([t])]);var a=1,n="FFFFFFFF",s=255,o=0;return this.optData&&(a=this.optData.subTelNum,n=this.optData.dstId,s=this.optData.dBm,o=this.optData.securityLvl),new r(e,!0,a,n,s,o);},f.resolve=function(e){var t,a=e.data,r=a.readUInt8(1),n=a.slice(2,6).toString("hex"),s=15&a.readUInt8(6);return e.hasOpt&&(t={subTelNum:e.subTelNum,dstId:e.dstId,dBm:e.dBm,securityLvl:e.securityLvl}),new f(r,n,s,t);};var m=function m(e,t,a,r){i.call(this,165,r),this.userData=e,this.senderID=t,this.rc=a||0;};m.prototype=new i(),m.prototype.constructor=m,m.prototype.getLearnType=function(){return this.userData.readUInt8(3)>>7&1;},m.prototype.getLearnBit=function(){return this.userData.readUInt8(3)>>3&1;},m.prototype.getLearnStatus=function(){return this.userData.readUInt8(3)>>4&1;},m.prototype.getLearnResult=function(){return this.userData.readUInt8(3)>>5&1;},m.prototype.getEEPResult=function(){return this.userData.readUInt8(3)>>6&1;},m.prototype.getFunc=function(){return this.userData.readUInt8(0)>>2&63;},m.prototype.getType=function(){return(3&this.userData.readUInt8(0))<<5|this.userData.readUInt8(1)>>3&31;},m.prototype.getManufacturerId=function(){return(7&this.userData.readUInt8(1))<<8|this.userData.readUInt8(2);},m.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),userData:this.userData.toString("hex"),learnType:this.getLearnType(),learn:this.getLearnBit(),learnStatus:this.getLearnStatus(),learnResult:this.getLearnResult(),eepResult:this.getEEPResult(),func:this.getFunc(),type:this.getType(),manufacturerId:this.getManufacturerId(),senderID:this.senderID,rc:this.rc};},m.prototype.toPacket=function(){var e=new Buffer(1);e.writeUInt8(this.rorg,0),e=Buffer.concat([e,this.userData]),e=Buffer.concat([e,new Buffer(this.senderID,"hex")]);var t,a=15&this.rc;if(e=Buffer.concat([e,new Buffer([a])]),this.optData){var n=this.optData.subTelNum,s=this.optData.dstId,o=this.optData.dBm,i=this.optData.securityLvl;t=new r(e,!0,n,s,o,i);}else t=new r(e,!1);return t;},m.resolve=function(e){var t,a=e.data,r=a.slice(1,5),n=a.slice(5,9).toString("hex"),s=15&a.readUInt8(9);return e.hasOpt&&(t={subTelNum:e.subTelNum,dstId:e.dstId,dBm:e.dBm,securityLvl:e.securityLvl}),new m(r,n,s,t);};var g=function g(e,t,a,r){i.call(this,210,r),this.userData=e,this.senderID=t,this.status=a;};g.prototype=new i(),g.prototype.constructor=g,g.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),userData:this.userData.toString("hex"),senderID:this.senderID,status:this.status,optData:this.optData};},g.prototype.toPacket=function(){var e,t=new Buffer(1);if(t.writeUInt8(this.rorg,0),t=Buffer.concat([t,this.userData]),t=Buffer.concat([t,new Buffer(this.senderID,"hex")]),t=Buffer.concat([t,new Buffer([this.status])]),this.optData){var a=this.optData.subTelNum,n=this.optData.dstId,s=this.optData.dBm,o=this.optData.securityLvl;e=new r(t,!0,a,n,s,o);}else e=new r(t,!1);return e;},g.resolve=function(e){var t,a=e.data,r=a.slice(1,a.length-5),n=a.slice(a.length-5,a.length-1).toString("hex"),s=a.readUInt8(a.length-1);return e.hasOpt&&(t={subTelNum:e.subTelNum,dstId:e.dstId,dBm:e.dBm,securityLvl:e.securityLvl}),new g(r,n,s,t);};var w=function w(e,t,a,r,n){i.call(this,166),this.rorg_en=e,this.data=t,this.dstID=a,this.senderID=r,this.status=n;};(w.prototype=new i()).constructor=w,w.prototype.toPacket=function(){var e=new Buffer(2);return e.writeUInt8(this.rorg,0),e.writeUInt8(this.rorg_en,1),e=Buffer.concat([e,this.data]),e=Buffer.concat([e,new Buffer(this.dstID,"hex")]),e=Buffer.concat([e,new Buffer(this.senderID,"hex")]),e=Buffer.concat([e,new Buffer([this.status])]),new r(e,!1);};var y=function y(e,t,a,r,n,s,o,l,u,c,h){i.call(this,212),this.cmd=e,this.ute=t,this.rspExpected=a,this.subtype=r,this.numChannel=n,this.manufactureID=s,this.eepType=o,this.eepFunc=l,this.eepRorg=u,this.senderID=c,this.status=h;};y.prototype=new i(),y.prototype.constructor=y,y.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),ute:this.ute,rspExpected:this.rspExpected,subtype:this.subtype,cmd:this.cmd,numChannel:this.numChannel,manufactureID:this.manufactureID,eepType:this.eepType.toString(16),eepFunc:this.eepFunc.toString(16),eepRorg:this.eepRorg.toString(16),senderID:this.senderID,status:this.status};},y.prototype.toPacket=function(){var e=new Buffer(8);e.writeUInt8(this.rorg,0);var t,a=this.ute<<7|this.rspExpected<<6|this.subtype<<4|this.cmd;if(e.writeUInt8(a,1),e.writeUInt8(this.numChannel,2),e.writeUInt16BE(parseInt(this.manufactureID,16),3),e.writeUInt8(this.eepType,5),e.writeUInt8(this.eepFunc,6),e.writeUInt8(this.eepRorg,7),e=Buffer.concat([e,new Buffer(this.senderID,"hex")]),e=Buffer.concat([e,new Buffer([this.status])]),this.optData){var n=this.optData.subTelNum,s=this.optData.dstId,o=this.optData.dBm,i=this.optData.securityLvl;t=new r(e,!0,n,s,o,i);}else t=new r(e,!1);return t;},y.resolve=function(e){var t=e.data.slice(1,8),a=e.data.slice(8,12).toString("hex"),r=e.data.readUInt8(12),n=t.readUInt8(0)>>7&1,s=15&t.readUInt8(0),o=t.readUInt8(1),i=t.slice(2,4).toString("hex"),l=t.readUInt8(4),u=t.readUInt8(5),c=t.readUInt8(6),h=t.readUInt8(0)>>6&1,_=t.readUInt8(0)>>4&3,p=new y(s,n,h,_,o,i,l,u,c,a,r);if(e.hasOpt){var d={subTelNum:e.subTelNum,dstId:e.dstId,dBm:e.dBm,securityLvl:e.securityLvl};p.optData=d;}return p;};var S=function S(e,t,a,r){i.call(this,53,r),this.userData=e,this.senderID=t,this.status=a;};S.prototype=new i(),S.prototype.constructor=S,S.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),userData:this.userData.toString("hex"),senderID:this.senderID,status:this.status,optData:this.optData};},S.resolve=function(e){var t,a=e.data,r=a.slice(1,a.length-5),n=a.slice(a.length-5,a.length-1).toString("hex"),s=a.readUInt8(a.length-1);return e.hasOpt&&(t={subTelNum:e.subTelNum,dstId:e.dstId,dBm:e.dBm,securityLvl:e.securityLvl}),new S(r,n,s,t);};var b=function b(e,t,a,r){i.call(this,49,r),this.userData=e,this.senderID=t,this.status=a;};b.prototype=new i(),b.prototype.constructor=b,b.prototype.toJSON=function(){return{rorg:this.rorg.toString(16),userData:this.userData.toString("hex"),senderID:this.senderID,status:this.status,optData:this.optData};},b.prototype.convertToPacket=function(e){var t,a=Buffer.concat([e,new Buffer(this.senderID,"hex"),new Buffer([this.status])]);if(this.optData){var n=this.optData.subTelNum,s=this.optData.dstId,o=this.optData.dBm,i=this.optData.securityLvl;t=new r(a,!0,n,s,o,i);}else t=new r(a,!1);return t;},b.resolve=function(e){var t,a=e.data,r=a.slice(1,a.length-5),n=a.slice(a.length-5,a.length-1).toString("hex"),s=a.readUInt8(a.length-1);return e.hasOpt&&(t={subTelNum:e.subTelNum,dstId:e.dstId,dBm:e.dBm,securityLvl:e.securityLvl}),new b(r,n,s,t);},i.SIG=d,i.RPS=v,i.BS1=f,i.BS4=m,i.VLD=g,i.ADT=w,i.UTE=y,i.TS=S,i.SM=b,i.GP_TI=c,i.GP_TR=h,i.GP_CD=_;var T=function T(e,t){this._code=e,this._rspData=t;};T.CODE={0:"RET_OK",1:"RET_ERROR",2:"RET_NOT_SUPPORTED",3:"RET_WRONG_PARAM",4:"RET_OPERATION_DENIED",5:"RET_LOCK_SET",6:"RET_BUFFER_TO_SMALL",7:"RET_NO_FREE_BUFFER"},T.prototype.toJSON=function(){return{code:this._code,rspData:this._rspData?this._rspData.toString("hex"):null};},T.prototype.toPacket=function(){return new a(this._code,this._rspData);},T.resolve=function(e){return new T(e.retCode,e.resData);};var I=function I(e,t){T.call(this,0),this._responseTime=e,this._confirmCode=t;};I.prototype.toPacket=function(){var e=new Buffer(3);return e.writeUInt16BE(this._responseTime,0),e.writeUInt8(this._confirmCode,2),new a(this._code,e);},I.prototype.toJSON=function(){return{code:this._code,responseTime:this._responseTime,confirmCode:this._confirmCode};},T.Response_OK_SA_CONFIRM_LEARN=I;var D=function D(e){this._code=e;};D.resolve=function(e){if(!e.data)return null;switch(e.data.readUInt8(0)){case 1:return E.resolve(e);case 2:return k.resolve(e);default:return null;}};var E=function E(){D.call(this,1);};E.prototype=new D(),E.prototype.constructor=E,E.prototype.toJSON=function(){return{code:this._code};},E.prototype.toPacket=function(){var e=new Buffer(1);return e.writeUInt8(this._code,0),new o(e);},E.resolve=function(e){return new E();};var k=function k(e,t,a,r,n,s,o){D.call(this,2),this._priority=e,this._manufacturerId=t,this._eep=a,this._rssi=r,this._pm_candidateId=n,this._sa_clientId=s,this._hop_count=o;};k.prototype=new D(),k.prototype.constructor=k,k.prototype.getEEP=function(){return this._eep?this._eep.substr(0,2)+"-"+this._eep.substr(2,2)+"-"+this._eep.substr(4,2):null;},k.prototype.getPMCandidateId=function(){return this._pm_candidateId;},k.prototype.getSAClientId=function(){return this._sa_clientId;},k.prototype.getHopCount=function(){return this._hop_count;},k.prototype.toJSON=function(){return{code:this._code,priority:this._priority,manufacturerId:this._manufacturerId,eep:this.getEEP(),rssi:this._rssi,pm_candidateId:this._pm_candidateId,sa_clientId:this._sa_clientId,hop_count:this._hop_count};},k.prototype.toPacket=function(){var e=new Buffer(4);return e.writeUInt8(this._code,0),e.writeUInt8(this._priority,1),e.writeUInt16BE(1023&this._manufacturerId,2),e=Buffer.concat([e,new Buffer(this._eep,"hex")]),e=Buffer.concat([e,new Buffer([this._rssi])]),e=Buffer.concat([e,new Buffer(this._pm_candidateId,"hex")]),e=Buffer.concat([e,new Buffer(this._sa_clientId,"hex")]),e=Buffer.concat([e,new Buffer([this._hop_count])]),new o(e);},k.resolve=function(e){var t=e.data,a=t.readUInt8(1),r=1023&t.readUInt16BE(2),n=t.slice(4,7).toString("hex"),s=t.readUInt8(7),o=t.slice(8,12).toString("hex"),i=t.slice(12,16).toString("hex"),l=t.readUInt8(16);return new k(a,r,n,s,o,i,l);},D.SA_RECLAIM_NOT_SUCCESSFUL=E,D.SA_CONFIRM_LEARN=k;var A=function A(e){this._code=e;};A.resolve=function(e){return e.data&&9===e.data.readUInt8(0)?CO_WR_REPEATER.resolve(e):null;},CO_WR_REPEATER=function CO_WR_REPEATER(e,t){A.call(this,9),this._enable=e,this._level=t;},CO_WR_REPEATER.prototype=new A(),CO_WR_REPEATER.prototype.constructor=CO_WR_REPEATER,CO_WR_REPEATER.prototype.toJSON=function(){return{code:this._code,enable:this._enable,level:this._level};},CO_WR_REPEATER.prototype.toPacket=function(){var e=new Buffer(3);return e.writeUInt8(this._code,0),e.writeUInt8(this._enable,1),e.writeUInt8(this._level,2),new s(e);},CO_WR_REPEATER.resolve=function(e){var t=e.data.readUInt8(1),a=CO_WR_REPEATER.readUInt8(2);return new CO_WR_REPEATER(t,a);},A.CO_WR_REPEATER=CO_WR_REPEATER;var O=function O(e){this._code=e;};O.resolve=function(e){if(!e.data)return null;switch(e.data.readUInt8(0)){case 1:return C.resolve(e);case 6:return R.resolve(e);case 8:return B.resolve(e);default:return null;}};var C=function C(e,t,a){O.call(this,1),this._enable=e,this._extended=t,this._timeout=a;};C.prototype=new O(),C.prototype.constructor=C,C.prototype.toJSON=function(){return{code:this._code,enable:this._enable,extended:this._extended,timeout:this._timeout};},C.prototype.toPacket=function(){var e=new Buffer(7);return e.writeUInt8(this._code,0),e.writeUInt8(this._enable,1),e.writeUInt8(this._extended,2),e.writeUInt32BE(this._timeout,3),new n(e);},C.resolve=function(e){var t=e.data,a=t.readUInt8(1),r=t.readUInt8(2),n=t.readUInt32BE(3);return new C(a,r,n);};var P=function P(e){O.call(this,5),this._saClientId=e;};(P.prototype=new O()).constructor=P,P.prototype.toJSON=function(){return{code:this._code,clientId:this._saClientId};},P.prototype.toPacket=function(){var e=new Buffer(1);return e.writeUInt8(this._code,0),e=Buffer.concat([e,new Buffer(this._saClientId,"hex")]),new n(e);},P.resolve=function(e){var t=e.data.slice(1,5).toString("hex");return new P(t);};var R=function R(){O.call(this,6);};R.prototype=new O(),R.prototype.constructor=R,R.prototype.toJSON=function(){return{code:this._code};},R.prototype.toPacket=function(){var e=new Buffer(1);return e.writeUInt8(this._code,0),new n(e);},R.resolve=function(e){return e.data,new R();};var B=function B(e){O.call(this,8),this._mailBoxCount=e;};B.prototype=new O(),B.prototype.constructor=B,B.prototype.toJSON=function(){return{code:this._code,mailBoxCount:this._mailBoxCount};},B.prototype.toPacket=function(){var e=new Buffer(2);return e.writeUInt8(this._code,0),e.writeUInt8(this._mailBoxCount,1),new n(e);},B.resolve=function(e){var t=e.data.readUInt8(1);return new B(t);},O.SA_WR_LEARNMODE=C,O.SA_WR_RESET=P,O.SA_RD_LEARNEDCLIENTS=R,O.SA_WR_POSTMASTER=B;var N,U=((N=function N(e){this._esp3=e,this._buffer={};}).prototype.receiveChainedTelegram=function(e){var t=e.getSenderID(),a=e.getSeq(),r=e.getIdx();this._buffer[t]||(this._buffer[t]={});var n=this._buffer[t];n[a]||(n[a]=[]);for(var s=n[a],o=0;o<=r;o++)o!=r?s.length<r&&(s[o]=null):s[o]=e;this._checkChain(t,a);},N.prototype._checkChain=function(e,t){var a=this._buffer[e][t];if(a[0]){var n=a[0],s=n.getLen(),o=n.getCRORG(),i=0,l=new Buffer(1);l.writeUInt8(o);for(var u=0;u<a.length;u++){var c=a[u];if(!c)return;var h=c.getData();i+=h.length,l=Buffer.concat([l,h]);}if(i>=s){delete this._buffer[e][t],l=Buffer.concat([l,new Buffer(e,"hex")]),l=Buffer.concat([l,new Buffer("00","hex")]);var _=new r(l,!1);this._esp3._onEORadio_ERP1(_);}}},N),M=function M(e){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.ESP3"),this._controller=e,this._listeners=[],e&&this._listeners.push(e),this._recomm=new x.hub.m.enocean.ReComm(this),this._serial=null,this._baseID=null,this._rdata=new Buffer([]),this._frameBuffer=[],this._learnHandler=null,this._learning=!1,this._learnTO=null,this._cdmHandler=new U(this);};return M.RESPONSE_TO=1500,M.prototype.attachSerial=function(e,t){var a=this;this._serial=new x.hub.m.enocean.Serial(e),this._serial.setListener(this),this._serial.open(function(e){if(e)return a._serial.setListener(null),a._serial=null,void(t&&t(e));a.readBaseID(function(e,r){e?(a._serial.setListener(null),a._serial.close(),a._serial=null,t&&t(e)):(x.hub.m.enocean.SENDER_ID||(x.hub.m.enocean.SENDER_ID=r,localStorage&&localStorage.setItem("x.hub.m.enocean.SENDER_ID",r)),a._baseID=r,t&&t());});});},M.prototype.removeSerial=function(e,t){this._serial.setListener(null),this._serial.close(),this._serial=null,this._baseID=null,t&&t();},M.prototype.getSerial=function(){return this._serial;},M.prototype.addListener=function(e){e&&-1==this._listeners.indexOf(e)&&this._listeners.push(e);},M.prototype.removeListener=function(e){if(e){var t=this._listeners.indexOf(e);-1!=t&&this._listeners.splice(t,1);}},M.prototype.readBaseID=function(t){var a=this,r=new e(5,new Buffer("08","hex"));this.sendFrame(r,!0,function(e,r){if(e)return a._logger.log("warn","read base id error:"+e.stack),void(t&&t(e));if(r&&r.retCode)return(e=new Error("read BaseID error")).code=r.retCode,a._logger.log("warn","read base id error return code:"+r.retCode),void(t&&t(e));var n=r.resData.toString("hex");t&&t(null,n.toLowerCase());},8e3);},M.prototype.startLearn=function(e,t,a,r){if(this._serial){if((!t||t<=0)&&(t=3e4),this._learning)r&&r(new Error("learning another type right now"));else{this._learnHandler=e,this._learning=!0;var n=this;if(this._learnTO=setTimeout(function(){n._learning=!1,n._learnTO=null;var e=n._learnHandler;n._learnHandler=null,e&&e.onLearnTimeout&&e.onLearnTimeout();},t),a){var s=new C(1,a.extended?a.extended:0,0);this.sendSACommand(s,!0,function(e){r&&r(e);});}else r&&r();}}else r&&r(new Error("port not opened"));},M.prototype.stopLearn=function(e,t,a){if(this._learnTO&&clearTimeout(this._learnTO),this._learning=!1,this._learnHandler=null,this._learnTO=null,t){a&&a();var r=this;setTimeout(function(){var e=new C(0,t.extended?t.extended:0,0);r.sendSACommand(e,!0,function(e){a&&a(e);});},2e3);}else a&&a();},M.prototype.sendTelegram=function(e,t,a){this.sendPacket(e.toPacket(),t,a);},M.prototype.sendResponse=function(e,t){this._logger.log("trace","send RESPONSE:"+JSON.stringify(e.toJSON())),this.sendPacket(e.toPacket(),!1,t);},M.prototype.sendSACommand=function(e,t,a){this._logger.log("trace","send SA_COMMAND:"+JSON.stringify(e.toJSON())),this.sendPacket(e.toPacket(),t,a);},M.prototype.sendCommandCommand=function(e,t,a){this._logger.log("trace","send COMMAND_COMMAND:"+JSON.stringify(e.toJSON())),this.sendPacket(e.toPacket(),t,a);},M.prototype.sendPacket=function(e,t,a){this.sendFrame(e.toFrame(),t,a);},M.prototype.sendFrame=function(e,t,a,r){var n={frame:e,callback:a,timeout:null,response:t,to:r},s=this._frameBuffer.length;this._frameBuffer.push(n),0==s&&this._sendNextFrame();},M.prototype._sendNextFrame=function(){if(0!=this._frameBuffer.length){var e=this._frameBuffer[0],t=e.frame,a=e.callback,r=e.response;if(!this._serial)return a&&a(new Error("port not opened")),this._frameBuffer.splice(0,1),void this._sendNextFrame();var n=this,s=t.toBuffer();this._logger.log("trace","send raw frame:"+s.toString("hex")),this._serial.sendPacket(s,function(t){if(t||!r){try{a&&a(t);}catch(e){}n._frameBuffer.splice(0,1),n._sendNextFrame();}else{var s=e.to;s||(s=M.RESPONSE_TO),e.timeout=setTimeout(function(){var e=n._frameBuffer[0];if(e){var t=e.callback,a=new Error("enocean response timeout");a.code=100;try{t&&t(a);}catch(e){}}n._frameBuffer.splice(0,1),n._sendNextFrame();},s);}});}},M.prototype.onSerialData=function(t){this._rdata=Buffer.concat([this._rdata,t]);for(var a=this._rdata,r=0;r<a.length;)if(85==a[r]){if(r+6>=a.length)break;var n=(a[r+1]<<8)+a[r+2],s=a[r+3],o=a[r+5];if(a.length<r+n+s+7)break;if(x.hub.m.enocean.CRC8(a.slice(r+1,r+5))==o){var i=a[r+n+s+6];if(x.hub.m.enocean.CRC8(a.slice(r+6,r+6+n+s))==i){var l={type:a[r+4],dataLen:n,optLen:s,radioType:a[r+6],data:a.slice(r+6,r+6+n),optData:a.slice(r+6+n,r+6+n+s),rawByte:a.slice(0,r+6+n+s+1).toString("hex")},u=new e(l.type,l.data,l.optData);166!=l.radioType&&210!=l.radioType&&165!=l.radioType&&246!=l.radioType&&213!=l.radioType||(l.senderId=l.data.slice(n-5,n-1).toString("hex"));try{this._onEOFrame(u,l);}catch(t){this._logger.log("warn","process frame exception:"+t.stack);}r=r+6+n+s+1;}else r++;}else r++;}else r++;0!=r&&a.length>0&&r<=a.length&&(a=a.slice(r)),this._rdata=a;},M.prototype.onSerialError=function(e){this._serial.setListener(null),this._serial=null;},M.prototype._onEOFrame=function(e,t){this._logger.log("trace","receive raw frame:"+t.rawByte),this._logger.log("debug","receive enocean frame:"+JSON.stringify(e.toJSON())),this._listeners.forEach(function(a){a._onEOFrame&&a._onEOFrame(e,t.rawByte);});var a=e.toPacket();a&&this._onEOPacket(a);},M.prototype._onEOPacket=function(e){this._logger.log("debug","receive enocean packet:"+JSON.stringify(e.toJSON())),this._listeners.forEach(function(t){t._onEOPacket&&t._onEOPacket(e);}),e instanceof r?this._onEORadio_ERP1(e):e instanceof a?this._onEOResponse_Packet(e):e instanceof o&&this._onEOEvent_Packet(e);},M.prototype._onEORadio_ERP1=function(e){var t=e.toRadioTelegram();t&&this._onEO_ERP1_Telegram(t);},M.prototype._onEOResponse_Packet=function(e){try{var t=e.toResponse();this._onEO_Response(t);}catch(e){}if(0!=this._frameBuffer.length){var a=this._frameBuffer[0],r=a.callback,n=a.timeout;n&&clearTimeout(n);try{r&&r(null,e);}catch(e){}this._frameBuffer.splice(0,1),this._sendNextFrame();}},M.prototype._onEOEvent_Packet=function(e){var t=e.toEvent();t&&this._onEO_Event(t);},M.prototype._onEO_ERP1_Telegram=function(e){this._logger.log("debug","receive enocean telegram:"+JSON.stringify(e.toJSON())),64!=e.rorg?(this._listeners.forEach(function(t){t._onEOTelegram&&t._onEOTelegram(e);}),49==e.rorg&&(e=this._controller._secHandler.resolve(e))&&this._listeners.forEach(function(t){t._onEOTelegram&&t._onEOTelegram(e);}),this._learning&&this._learnHandler&&this._learnHandler.onTelegram&&this._learnHandler.onTelegram(e)):this._cdmHandler.receiveChainedTelegram(e);},M.prototype._onEO_Response=function(e){this._logger.log("debug","receive enocean response:"+JSON.stringify(e.toJSON()));},M.prototype._onEO_Event=function(e){this._logger.log("debug","receive enocean event:"+JSON.stringify(e.toJSON())),this._learning&&this._learnHandler&&this._learnHandler.onEvent&&this._learnHandler.onEvent(e);},M.ESP3_Frame=e,M.Telegram=i,M.RADIO_ERP1_Packet=r,M.Event=D,M.Response=T,M.COMMAND_COMMAND=A,M.SA_COMMAND=O,M;}(),x.hub.m.enocean.ESP2=function(){var e=function e(_e8,t){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.ESP2.Telegram"),this._type=_e8,this._data=t;};e.prototype.toBuffer=function(){var e=new Buffer(3+this._data.length+1),t=0;e.writeUInt8(165,0),e.writeUInt8(90,1);var a=this._type<<5|this._data.length+1&31;t+=a,e.writeUInt8(a,2);for(var r=0;r<this._data.length;r++){var n=this._data.readUInt8(r);e.writeUInt8(n,r+3),t+=n;}return t&=255,e.writeUInt8(t,e.length-1),e;},e.resolve=function(e,t){switch(e){case 0:return n.resolve(t);case 3:return r.resolve(t);case 4:return s.resolve(t);case 5:return o.resolve(t);default:return null;}};var t,a,r=(a=function a(t){e.call(this,3,t);},(a.prototype=new e()).constructor=a,a.prototype.getData=function(){return this._data.slice(1,5);},a.prototype.getSenderID=function(){return this._data.slice(5,9).toString("hex");},a.prototype.getStatus=function(){return this._data.readUInt8(9);},a.prototype.toJSON=function(){return{type:"TRT",org:"0x"+this._data.slice(0,1).toString("hex"),data:this.getData().toString("hex"),senderID:this.getSenderID(),status:this.getStatus()};},a.prototype.fromPayload=function(e){this._data=e._data;},a.resolve=function(e){return e&&e.length?new a(e):null;},a),n=(t=function t(_t2){e.call(this,0,_t2);},(t.prototype=new e()).constructor=t,t.prototype.getData=function(){return this._data.slice(1,5);},t.prototype.getSenderID=function(){return this._data.slice(5,9).toString("hex");},t.prototype.getStatus=function(){return this._data.readUInt8(9);},t.prototype.toJSON=function(){return{type:"RRT",org:"0x"+this._data.slice(0,1).toString("hex"),data:this.getData().toString("hex"),senderID:this.getSenderID(),status:this.getStatus()};},t.prototype.toPayload=function(){return i.resolve(this._data);},t.resolve=function(e){return e&&e.length?new t(e):null;},t),s=function(){var t=function t(_t3){e.call(this,4,_t3);};(t.prototype=new e()).constructor=t,t.prototype.toJSON=function(){return{type:"RCT",org:"0x"+this._data.readUInt8(0).toString(16)};},t.resolve=function(e){if(!e||!e.length)return null;var t=e[0];switch(t){case 88:return new a();case 25:return new r();case 34:return new s();case 26:return new o();case 8:case 11:case 9:case 10:return new n(t);case 152:return new i(e.slice(1,5).toString("hex"));case 136:return new l(e[2]);case 140:return new u(e.slice(1));default:return null;}};var a=function a(){t.call(this,new Buffer([88,0,0,0,0,0,0,0,0]));};a.prototype=new t(),a.prototype.constructor=a,a.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="OK",e;};var r=function r(){t.call(this,new Buffer([25,0,0,0,0,0,0,0,0]));};r.prototype=new t(),r.prototype.constructor=r,r.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="ERR",e;};var n=function n(e){t.call(this,new Buffer([e,0,0,0,0,0,0,0,0]));};n.prototype=new t(),n.prototype.constructor=n,n.prototype.getField=function(){return this._data.readUInt8(0);},n.prototype.getFieldName=function(){switch(this._data.readUInt8(0)){case 8:return"H_SEQ";case 9:return"LENGTH";case 10:return"CHKSUM";case 11:return"ORG";default:return"UNKNOWN";}},n.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="ERR_SYNTAX",e.field=this.getFieldName(),e;};var s=function s(){t.call(this,new Buffer([34,0,0,0,0,0,0,0,0]));};s.prototype=new t(),s.prototype.constructor=s,s.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="ERR_TX_IDRANGE",e;};var o=function o(){t.call(this,new Buffer([26,0,0,0,0,0,0,0,0]));};o.prototype=new t(),o.prototype.constructor=o,o.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="ERR_IDRANGE",e;};var i=function i(e){t.call(this,new Buffer("98"+e+"00000000","hex"));};i.prototype=new t(),i.prototype.constructor=i,i.prototype.getBaseID=function(){return this._data.slice(1,5).toString("hex");},i.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="INF_BASEID",e.baseID=this.getBaseID(),e;};var l=function l(e){t.call(this,new Buffer([136,255&e,0,0,0,0,0,0,0]));};l.prototype=new t(),l.prototype.constructor=l;var u=function u(e){t.call(this,new Buffer("8C"+e.toString("hex"),"hex"));};return u.prototype=new t(),u.prototype.constructor=u,t.OK=a,t.ERR=r,t.ERR_SYNTAX=n,t.ERR_TX_IDRANGE=s,t.ERR_IDRANGE=o,t.INF_BASEID=i,t.INF_RX_SENSITIVITY=l,t.INF_SW_VER=u,t;}(),o=function(){var t=function t(_t4){e.call(this,5,_t4);};(t.prototype=new e()).constructor=t,t.prototype.toJSON=function(){return{type:"TCT",org:"0x"+this._data.readUInt8(0).toString(16)};},t.resolve=function(e){if(!e||!e.length)return null;switch(e[0]){case 24:return new a(e.slice(1,4).toString("hex"));case 88:return new r();case 8:return new n(e[2]);case 72:return new s();case 75:return new i();case 10:return new o();default:return null;}};var a=function a(e){t.call(this,new Buffer("18"+e+"0000000000","hex"));};a.prototype=new t(),a.prototype.constructor=a,a.prototype.getBaseID=function(){return this._data.slice(1,5).toString("hex");},a.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="SET_BASEID",e.baseID=this.getBaseID(),e;};var r=function r(){t.call(this,new Buffer("58000000000000000000","hex"));};r.prototype=new t(),r.prototype.constructor=r,r.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="RD_BASEID",e;};var n=function n(e){t.call(this,new Buffer([8,255&e,0,0,0,0,0,0,0,0]));};n.prototype=new t(),n.prototype.constructor=n,n.prototype.getSensitivity=function(){return this._data.readUInt8(1);},n.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="SET_RX_SENSITIVITY",e.sensitivity=this.getSensitivity(),e;};var s=function s(){t.call(this,new Buffer("48000000000000000000","hex"));};s.prototype=new t(),s.prototype.constructor=s,s.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="RD_RX_SENSITIVITY",e;};var o=function o(){t.call(this,new Buffer("0A000000000000000000","hex"));};o.prototype=new t(),o.prototype.constructor=o,o.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="RESET",e;};var i=function i(){t.call(this,new Buffer("4B000000000000000000","hex"));};return i.prototype=new t(),i.prototype.constructor=i,i.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.subtype="RD_SW_VER",e;},t.SET_BASEID=a,t.RD_BASEID=r,t.SET_RX_SENSITIVITY=n,t.RD_RX_SENSITIVITY=s,t.RESET=o,t.RD_SW_VER=i,t;}(),i=function(){var e=function e(_e9,t){if(_e9&&t){var a=Buffer.alloc(1);a.writeUInt8(_e9),this._data=Buffer.concat([a,t]);}};e.prototype.getData=function(){throw new Error("not implemented by this child class");},e.prototype.getSenderID=function(){throw new Error("not implemented by this child class");},e.prototype.getStatus=function(){throw new Error("not implemented by this child class");},e.prototype.toJSON=function(){return{type:null,org:"0x"+this._data.slice(0,1).toString("hex"),data:this.getData().toString("hex"),senderID:this.getSenderID(),status:this.getStatus()};},e.resolve=function(e){if(!e||!e.length)return null;switch(e[0]){case 5:return t.resolve(e.slice(1));case 6:return a.resolve(e.slice(1));case 7:return r.resolve(e.slice(1));default:return null;}};var t=function t(_t5,a,r){var n=Buffer.alloc(9);n.writeUInt8(_t5,0),n.writeUInt8(0,1),n.writeUInt8(0,2),n.writeUInt8(0,3);for(var s=0,o=4;s<8;s+=2,o++){var i=a.substr(s,2);n.writeUInt8(parseInt(i,16),o);}n.writeUInt8(r,8),e.call(this,5,n);};t.prototype=new e(),t.prototype.constructor=t,t.prototype.getData=function(){return this._data.slice(1,2);},t.prototype.getSenderID=function(){return this._data.slice(5,9).toString("hex");},t.prototype.getStatus=function(){return this._data.readUInt8(9);},t.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.type="RPS",t;},t.resolve=function(e){var a=e.readUInt8(0),r=e.slice(4,8).toString("hex"),n=e.readUInt8(8);return new t(a,r,n);};var a=function a(t,_a4,r){var n=Buffer.alloc(9);n.writeUInt8(t,0),n.writeUInt8(0,1),n.writeUInt8(0,2),n.writeUInt8(0,3);for(var s=0,o=4;s<8;s+=2,o++){var i=_a4.substr(s,2);n.writeUInt8(parseInt(i,16),o);}n.writeUInt8(r,8),e.call(this,6,n);};a.prototype=new e(),a.prototype.constructor=a,a.prototype.isTeachIn=function(){return 0==(8&this._data.readUInt8(1));},a.prototype.getData=function(){return this._data.slice(1,2);},a.prototype.getSenderID=function(){return this._data.slice(5,9).toString("hex");},a.prototype.getStatus=function(){return this._data.readUInt8(9);},a.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.type="1BS",t.teachin=this.isTeachIn(),t;},a.resolve=function(e){var t=e.readUInt8(0),r=e.slice(4,8).toString("hex"),n=e.readUInt8(8);return new a(t,r,n);};var r=function r(t,a,_r3){for(var n=Buffer.alloc(9),s=0;s<4;s++)n.writeUInt8(t.readUInt8(s),s);for(var o=0,i=4;o<8;o+=2,i++){var l=a.substr(o,2);n.writeUInt8(parseInt(l,16),i);}n.writeUInt8(_r3,8),e.call(this,7,n);};return r.prototype=new e(),r.prototype.constructor=r,r.prototype.isTeachIn=function(){return 0==(8&this.getData().readUInt8(3));},r.prototype.getProfile=function(){var e=this.getData(),t=e.readUInt8(0)>>2,a=(3&e.readUInt8(0))<<5|e.readUInt8(1)>>3&31;return Buffer.from([7,t,a]);},r.prototype.getProfileText=function(){var e=this.getProfile().toString("hex");return e.substr(0,2)+"-"+e.substr(2,2)+"-"+e.substr(4,2);},r.prototype.getManufacturerId=function(){var e=this.getData().slice(1,3);return e.writeUInt8(7&e.readUInt8(0),0),e.toString("hex");},r.prototype.getLearnType=function(){return this.getData().readUInt8(3)>>7&1;},r.prototype.getEEPResult=function(){return this.getData().readUInt8(3)>>6&1;},r.prototype.getLearnResult=function(){return this.getData().readUInt8(3)>>5&1;},r.prototype.getLearnStaus=function(){return this.getData().readUInt8(3)>>4&1;},r.prototype.getData=function(){return this._data.slice(1,5);},r.prototype.getSenderID=function(){return this._data.slice(5,9).toString("hex");},r.prototype.getStatus=function(){return this._data.readUInt8(9);},r.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.type="4BS",t.teachin=this.isTeachIn(),t.teachin&&(t.teachin_info={profile:this.getProfileText(),learn_type:this.getLearnType(),eep_result:this.getEEPResult(),learn_result:this.getLearnResult(),learn_status:this.getLearnStaus()},t.teachin_info.learn_type&&(t.teachin_info.manufactureID=this.getManufacturerId())),t;},r.resolve=function(e){var t=e.slice(0,4),a=e.slice(4,8).toString("hex"),n=e.readUInt8(8);return new r(t,a,n);},e.RPS=t,e.BS1=a,e.BS4=r,e;}(),l=function l(e,t){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.ESP2"),this._controller=e,this._listeners=[],e&&this._listeners.push(e),this._baudrate=t,this._baudrate||(this._baudrate=9600),this._serial=null,this._baseID=null,this._rdata=new Buffer([]),this._telegramBuffer=[],this._learnHandler=null,this._learning=!1,this._learnTO=null;};return l.RESPONSE_TO=1500,l.prototype.attachSerial=function(e,t){var a=this;this._serial=new x.hub.m.enocean.Serial(e,this._baudrate),this._serial.setListener(this),this._serial.open(function(e){if(e)return a._serial.setListener(null),a._serial=null,void(t&&t(e));a.readBaseID(function(e,r){e?(a._serial.setListener(null),a._serial.close(),a._serial=null,t&&t(e)):(a._baseID=r,t&&t());});});},l.prototype.removeSerial=function(e,t){this._serial.setListener(null),this._serial.close(),this._serial=null,this._baseID=null,t&&t();},l.prototype.getSerial=function(){return this._serial;},l.prototype.readBaseID=function(e){var t=this,a=new o.RD_BASEID();this.sendTelegram(a,2e3,function(a,r){if(a)return t._logger.log("warn","read base id error:"+a.stack),void(e&&e(a));if(!(r instanceof s.INF_BASEID))return a=new Error("read base id failed"),t._logger.log("warn","read base id failed:"+r.retCode),void(e&&e(a));var n=r.getBaseID();e&&e(null,n.toLowerCase());});},l.prototype.sendTelegram=function(e,t,a){this._logger.log("debug","send enocean telegram:"+JSON.stringify(e.toJSON()));var r={telegram:e,callback:a,timeout:null,to:t},n=this._telegramBuffer.length;this._telegramBuffer.push(r),0==n&&this._sendNextTelegram();},l.prototype._sendNextTelegram=function(){if(0!=this._telegramBuffer.length){var e=this._telegramBuffer[0],t=e.telegram,a=e.callback,n=!0;if((t instanceof o.RESET||t instanceof r)&&(n=!1),!this._serial)return a&&a(new Error("port not opened")),this._telegramBuffer.splice(0,1),void this._sendNextTelegram();var s=this,i=t.toBuffer();this._logger.log("trace","send raw telegram:"+i.toString("hex")),this._serial.sendPacket(i,function(t){if(t||!n){try{a&&a(t);}catch(t){}return s._telegramBuffer.splice(0,1),void s._sendNextTelegram();}var r=e.to;r||(r=l.RESPONSE_TO),e.timeout=setTimeout(function(){var e=new Error("enocean response timeout");e.code=100;try{a&&a(e);}catch(e){}s._telegramBuffer.splice(0,1),s._sendNextTelegram();},r);});}},l.prototype.onSerialData=function(t){this._rdata=Buffer.concat([this._rdata,t]);for(var a=this._rdata,r=0;r<a.length;)if(165==a[r]){if(r+r>=a.length)break;if(90==a[r+1]){if(r+2>=a.length)break;var n=a[r+2]>>5&7,s=31&a[r+2];if(s<=2)r+=3;else{if(r+3+s>a.length)break;t=a.slice(r+3,r+3+s-1);for(var o=a[r+3+s-1],i=0,l=r+2;l<r+3+s-1;l++)i+=a[l];if((i&=255)==o){this._logger.log("trace","hseq:"+n+" len:"+s+" data:"+t.toString("hex")+" crc:"+o.toString(16));var u=e.resolve(n,t);try{u&&this._onESP2Telegram(u);}catch(t){this._logger.log("warn","process esp2 telegram exception:"+t.stack);}r=r+3+s;}else this._logger.log("trace","acctual crc:"+i.toString(16)+" expected crc:"+o.toString(16)),r=r+3+s;}}else r+=2;}else r++;0!=r&&a.length>0&&r<=a.length&&(a=a.slice(r)),this._rdata=a;},l.prototype.onSerialError=function(e){this._serial.setListener(null),this._serial=null;},l.prototype._onESP2Telegram=function(e){if(!(e instanceof r||e instanceof o)){if(this._logger.log("debug","receive enocean telegram:"+JSON.stringify(e.toJSON())),e instanceof n){var t=e.toPayload();this._logger.log("debug","receive enocean payload:"+JSON.stringify(t.toJSON())),this._listeners.forEach(function(t){t._onESP2Telegram&&t._onESP2Telegram(e);});}if(0!=this._telegramBuffer.length&&e instanceof s){var a=this._telegramBuffer[0],i=a.callback,l=a.timeout;l&&clearTimeout(l);try{i&&i(null,e);}catch(e){}this._telegramBuffer.splice(0,1),this._sendNextTelegram();}}},l.TRT=r,l.Payload=i,l.Telegram=e,l;}(),x.hub.m.enocean.profiles=function(){var e=function e(_e10){this._address=_e10?_e10.address:null,this._senderID=_e10?_e10.senderID:null,this._data=_e10?_e10.data:null,this._params=_e10?_e10.params:null,this._vendor="general",this._virtual=!1,this._eepAlias=null,this.setDefaultParams(),this._states={},this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.profiles."+(this._data?this._data:"Profile"));};e.prototype.getAddress=function(){return this._address;},e.prototype.getData=function(){return this._data;},e.prototype.finalize=function(e){e&&e();},e.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);if(r){var n=this.checkStateChange(r);a&&a(null,n);}else a&&a(new Error("data format invalid"));},e.prototype.evalTelegram=function(e){return null;},e.prototype.getStatesBuffer=function(){return this._states;},e.prototype.getBufferedState=function(e){var t=this.getStatesBuffer();return t&&t[e]?t[e].value:null;},e.prototype.getCurrentStates=function(){var e={},t=this.getStatesBuffer();for(var a in t)t.hasOwnProperty(a)&&t[a]&&(e[a]=t[a].value);return e;},e.prototype.getStatesLegacy=function(){var e=this.getCurrentStates();return{type:"ENOCEAN",adr:this._address,data:this._data,vendor:this._vendor,state:e};},e.prototype.checkStateChange=function(e){var t=this._states,a=[],r=new Date().getTime();for(var n in e){var s={};s.key=n,s.value=e[n],s.changed=!1;var o=t[n]?t[n].value:null;o!=e[n]&&(s.oldvalue=o,s.changed=!0),this._states[n]={value:e[n],time:r},a.push(s);}return a;},e.prototype.setDefaultParams=function(){},e.prototype.activeStateChange=function(e){var t=this.checkStateChange(e);t.length>0&&require("x.hub.m.enocean.js")._onEOEvents(this,t);},e.prototype.toJSON=function(){return{type:"ENOCEAN",address:this._address,data:this._data,senderID:this._senderID,vendor:this._vendor,virtual:this._virtual,params:this._params};},e.prototype.fromJSON=function(e){return e&&e.address&&e.data?e.data!=this._data?null:(this._address=e.address,this._senderID=e.senderID,this._vendor=e.vendor?e.vendor:this._vendor,this._virtual=!!e.virtual,this._params=e.params,this.setDefaultParams(),this):null;},e.prototype.toDBJSON=function(){return{id:this._address,senderID:this._senderID,eep:this._data,vendor:this._vendor,params:this._params,virtual:this._virtual};},e.prototype.fromDBJSON=function(e){return e&&e.id&&e.eep?e.eep!=this._data?null:(this._address=e.id,this._senderID=e.senderID,this._vendor=e.vendor?e.vendor:this._vendor,this._virtual=!!e.virtual,this._params=e.params,this.setDefaultParams(),this):null;};var t=function t(_t6){e.call(this,_t6),this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.profiles.SiegeniaWindow"),this._data="d2-06-50",this._vendor="siegenia",this._desc="Window",this._states={counter00:{value:"?",time:-1},counter01:{value:"?",time:-1},counter02:{value:"?",time:-1},counter03:{value:"?",time:-1},counter04:{value:"?",time:-1},counter05:{value:"?",time:-1},counter06:{value:"?",time:-1},counter07:{value:"?",time:-1},counter08:{value:"?",time:-1},counter09:{value:"?",time:-1},counter0A:{value:"?",time:-1},aliveTimeout:{value:!1,time:-1}};var a=this;this._params=_t6?_t6.params:null,this._params||(this._params={alive:900,sync:0,eep:1,type:0,alarm:0,alarm_sens:0}),this._aliveTO=setTimeout(function(){a._aliveTimeout();},2*this._params.alive*1e3),this._lastAlarm=null;};t.TEMPALTE={id:null,eep:null,desc:"Window",manufacturer:"SIEGENIA-AUBI KG",vendor:"siegenia",params:{alive:900,sync:0,eep:1,type:0,alarm:0,alarm_sens:0}},(t.prototype=new e()).constructor=t,t.prototype.evalTelegram=function(e){var t={};if(210==e.rorg){var a={data:e.userData,rssi:e.optData?e.optData.dBm:0,status:e.status};if(1==a.data[0]&&8==a.data.length){var r={AM:(128&a.data[1])>>7,WDS:239&a.data[1],CT:(a.data[2]<<24)+(a.data[3]<<16)+(a.data[4]<<8)+a.data[5],CB:a.data[6]>>7,BS:127&a.data[6],MOE:a.data[7]>>6,ACE:(48&a.data[7])>>4,MAE:(12&a.data[7])>>2,AE:3&a.data[7]};switch(t={type:1,TBT:!1,batteryOK:!0,battery:r.BS,motionSensor:r.MOE,accelerationSensor:r.ACE,magneticSensor:r.MAE,error:r.AE,count:r.CT},r.CB&&(t.batteryOK=!1),t.battery>100&&(t.battery=100),t.code=r.WDS,r.WDS){case 0:t.state="?",t.handle="?",t.counter00=r.CT;break;case 1:t.state="closed",t.handle="closed",t.counter01=r.CT;break;case 2:t.state="closed",t.handle="open",t.counter02=r.CT;break;case 3:t.state="closed",t.handle="tilted",t.counter03=r.CT;break;case 4:t.state="open",t.handle="closed",t.counter04=r.CT;break;case 5:t.state="open",t.handle="open",t.TBT=!0,t.counter05=r.CT;break;case 6:t.state="open",t.handle="tilted",t.TBT=!0,t.counter06=r.CT;break;case 7:t.state="tilted",t.handle="closed",t.TBT=!0,t.counter07=r.CT;break;case 8:t.state="tilted",t.handle="open",t.TBT=!0,t.counter08=r.CT;break;case 9:t.state="tilted",t.handle="tilted",t.counter09=r.CT;break;case 10:t.state="?",t.handle="?",t.counter0A=r.CT;}}else if(2==a.data[0]&&2==a.data.length)t.type=2,1==(15&a.data[1])?t.burglary=!0:t.burglary=!1;else if(17==a.data[0]&&2==a.data.length){switch(t.type=17,(192&a.data[1])>>6){case 0:t.calibrationState="ok";break;case 1:t.calibrationState="error";break;case 2:t.calibrationState="invalid";break;case 3:t.calibrationState="not_supported";}var n=63&a.data[1];switch(t.calibrationStep=n,n){case 0:t.calibrationCasement="none",t.calibrationHandle="none";break;case 1:t.calibrationCasement="closed",t.calibrationHandle="closed";break;case 2:t.calibrationCasement="closed",t.calibrationHandle="open";break;case 3:t.calibrationCasement="closed",t.calibrationHandle="tilted";break;case 4:t.calibrationCasement="open",t.calibrationHandle="closed";break;case 5:t.calibrationCasement="open",t.calibrationHandle="open";break;case 6:t.calibrationCasement="open",t.calibrationHandle="tilted";break;case 7:t.calibrationCasement="tilted",t.calibrationHandle="closed";break;case 8:t.calibrationCasement="tilted",t.calibrationHandle="open";break;case 9:t.calibrationCasement="tilted",t.calibrationHandle="tilted";}}}return t;},t.prototype.evalData=function(e,t,a){var r=this;r._states.aliveTimeout.value=!1,clearTimeout(this._aliveTO),this._aliveTO=setTimeout(function(){r._aliveTimeout();},2*this._params.alive*1e3);var n=this.evalTelegram(t);if(n){if(2==n.type){var s=new Date().getTime();if(this._lastAlarm&&s-this._lastAlarm<4e3)return void(a&&a(new Error("duplicated alarm")));this._lastAlarm=s;}var o=[];n.aliveMsg||(o=this.checkStateChange(n)),a&&a(null,o);}else a&&a(new Error("data format invalid"));},t.prototype.checkStateChange=function(e){var t=this._states,a=[];for(var r in e)if("aliveMsg"!=r&&"type"!=r){var n={};n.key=r,n.value=e[r],n.changed=!1;var s=t[r]?t[r].value:null;s!=e[r]&&(n.oldvalue=s,n.changed=!0),"burglary"!=r&&"calibrationState"!=r&&"calibrationCasement"!=r&&"calibrationHandle"!=r&&(this._states[r]={value:e[r],time:new Date().getTime()}),a.push(n);}return a;},t.prototype._resolveStates=function(e,t){var a={};if(210==e[0]){var r={data:e.slice(1,e.length-5),rssi:t[5],status:e[e.length-1]};if(1==r.data[0]&&8==r.data.length){var n={AM:(128&r.data[1])>>7,WDS:239&r.data[1],CT:(r.data[2]<<24)+(r.data[3]<<16)+(r.data[4]<<8)+r.data[5],CB:r.data[6]>>7,BS:127&r.data[6],MOE:r.data[7]>>6,ACE:(48&r.data[7])>>4,MAE:(12&r.data[7])>>2,AE:3&r.data[7]};switch(a={aliveMsg:1==n.AM,TBT:!1,batteryOK:!0,battery:n.BS,motionSensor:n.MOE,accelerationSensor:n.ACE,magneticSensor:n.MAE,error:n.AE,count:n.CT},n.CB&&(a.batteryOK=!1),a.battery>100&&(a.battery=100),n.WDS){case 0:a.state="closed",a.handle="closed",a.counter00=n.CT;break;case 1:a.state="closed",a.handle="open",a.counter01=n.CT;break;case 2:a.state="open",a.handle="open",a.counter02=n.CT;break;case 3:a.state="closed",a.handle="tilted",a.counter03=n.CT;break;case 4:a.state="tilted",a.handle="tilted",a.counter04=n.CT;break;case 5:a.state="closed",a.handle="tilted",a.TBT=!0,a.counter05=n.CT;break;case 6:a.state="tilted",a.handle="tilted",a.TBT=!0,a.counter06=n.CT;break;case 7:a.state="closed",a.handle="open",a.TBT=!0,a.counter07=n.CT;break;case 8:a.state="open",a.handle="open",a.TBT=!0,a.counter08=n.CT;break;case 9:a.state="open",a.handle="closed",a.counter09=n.CT;break;case 10:a.state="open",a.handle="tilted",a.counter0A=n.CT;}}else if(2==r.data[0]&&2==r.data.length)1==(15&r.data[1])?a.burglary=!0:a.burglary=!1;else if(17==r.data[0]&&2==r.data.length){switch((192&r.data[1])>>6){case 0:a.calibrationState="ok";break;case 1:a.calibrationState="error";break;case 2:a.calibrationState="invalid";break;case 3:a.calibrationState="not_supported";}switch(63&r.data[1]){case 0:a.calibrationCasement="none",a.calibrationHandle="none";break;case 1:a.calibrationCasement="closed",a.calibrationHandle="closed";break;case 2:a.calibrationCasement="closed",a.calibrationHandle="open";break;case 3:a.calibrationCasement="closed",a.calibrationHandle="tilted";break;case 4:a.calibrationCasement="open",a.calibrationHandle="closed";break;case 5:a.calibrationCasement="open",a.calibrationHandle="open";break;case 6:a.calibrationCasement="open",a.calibrationHandle="tilted";break;case 7:a.calibrationCasement="tilted",a.calibrationHandle="closed";break;case 8:a.calibrationCasement="tilted",a.calibrationHandle="open";break;case 9:a.calibrationCasement="tilted",a.calibrationHandle="tilted";}}}return a;},t.prototype._aliveTimeout=function(){this.activeStateChange({aliveTimeout:!0});},t.prototype.fromJSON=function(t){return e.prototype.fromJSON.call(this,t)?(this._params||(this._params={alive:900,sync:0,eep:1,type:0,alarm:0,alarm_sens:0}),this):null;},t.prototype.fromDBJSON=function(t){return e.prototype.fromDBJSON.call(this,t)?(this._params||(this._params={alive:900,sync:0,eep:1,type:0,alarm:0,alarm_sens:0}),this):null;};var a=function a(t){e.call(this,t),this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.profiles.MacoWindow"),this._data="d5-xx-xx",this._desc="Window",this._vendor="maco";};a.TEMPALTE={id:null,eep:null,desc:"Window",manufacturer:"Mayer & Co Beschlge GmbH"},(a.prototype=new e()).constructor=a,a.prototype.evalData=function(e,t,a){var r=this._resolveStates(e,t);if(r){var n=this.checkStateChange(r);a&&a(null,n);}else a&&a(new Error("data format invalid"));},a.prototype._resolveStates=function(e,t){var a={};if(213==e[0]){var r={data:e.slice(1,e.length-5),rssi:t[5],status:e[e.length-1]},n={WIN:(48&r.data[0])>>4,LRN:(8&r.data[0])>>3,BS:(6&r.data[0])>>1,BAL:1&r.data[0]};switch(n.WIN){case 0:a.state="unused";break;case 1:a.state="tilted";break;case 2:a.state="open";break;case 3:a.state="closed";}a.learn=n.LRN,a.battery=n.BS,a.alarm=n.BAL;}return a;},a.prototype.toDBJSON=function(){return{id:this._address,eep:this._data,desc:this._desc,manufacturer:"Mayer & Co Beschlge GmbH",vendor:this._vendor};};var r=function r(t){e.call(this,t),this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.profiles.SodaHandle"),this._data="f6-so-da";};r.TEMPALTE={id:null,eep:null},(r.prototype=new e()).constructor=r,r.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 240:t.state="tilted";break;case 192:t.state="open";break;case 208:t.state="closed";}return t;},r.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);if(r){var n=this.checkStateChange(r);a&&a(null,n);}else a&&a(new Error("data format invalid"));},r.prototype.toJSON=function(e,t){return{address:this._address,data:this._data,vendor:"soda"};},r.prototype.toDBJSON=function(){return{id:this._address,eep:this._data,desc:"Window_Handle",manufacturer:"SODA",vendor:"soda"};};var n=function n(t){e.call(this,t),this._data="f6-??-??";};(n.prototype=new e()).constructor=n;var s=function s(e){n.call(this,e),this._data="f6-01-01",this._longPressThreshold=1e3;};s.STATES=["button"],s.COMMANDS=["shortPress","longPress","press","release"],(s.prototype=new n()).constructor=o,s.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a=e.userData>>4&1?"pressed":"released";t.button=a;}return t;},s.prototype.buildData=function(e){return e<<4;},s.prototype.checkStateChange=function(e){var t=this._states,a=[],r=new Date().getTime();for(var n in e){var s={};s.key=n,s.value=e[n],s.changed=!1;var o=t[n]?t[n].value:null,i=t[n]?t[n].time:null,l=e[n];o!=l&&(s.oldvalue=o,s.changed=!0),this._states[n]={value:e[n],time:r},s.changed&&a.push(s),"pressed"==o&&"released"==l&&(!i||r-i<this._longPressThreshold?((s={}).key=n,s.value="shortPress",s.changed=!0):((s={}).key=n,s.value="longPress",s.changed=!0),a.push(s));}return a;},s.prototype.executeCommand=function(e,t,a){var r,n;if(this._senderID){if(t&&t.value){var s=this,o=100;switch(t.value){case"longPress":o=this._longPressThreshold;case"shortPress":r=this.buildData(1),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(t){t?a&&a(t):(s.activeStateChange({button:"pressed"}),setTimeout(function(){r=s.buildData(0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,s._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){s.activeStateChange({button:"released"}),a&&a(e);});},o));});break;case"press":r=this.buildData(1),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){s.activeStateChange({button:"pressed"}),a&&a(e);});break;case"release":r=this.buildData(0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){s.activeStateChange({button:"released"}),a&&a(e);});}}else a&&a(new Error("command invalid"));}else a&&a(new Error("sender id is null"));};var o=function o(e){n.call(this,e),this._data="f6-02-01",this._longPressThreshold=1e3;};o.STATES=["buttonAI","buttonAO","buttonBI","buttonBO"],o.COMMANDS=["shortPressAI","longPressAI","pressAI","releaseAI","shortPressAO","longPressAO","pressAO","releaseAO","shortPressBI","longPressBI","pressBI","releaseBI","shortPressBO","longPressBO","pressBO","releaseBO"],o.prototype=new n(),o.prototype.constructor=o,o.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a,r,n,s,o=e.userData>>5&7,i=e.userData>>4&1,l=e.userData>>1&7,u=1&e.userData,c=e.t21,h=e.nu,_=i?"pressed":"released";if(1==c&&1==h){switch(o){case 0:a=_;break;case 1:r=_;break;case 2:n=_;break;case 3:s=_;}if(u)switch(l){case 0:a=_;break;case 1:r=_;break;case 2:n=_;break;case 3:s=_;}}else 1==c&&0==h&&0===o&&(a=_,r=_,n=_,s=_);a&&(t.buttonAI=a),r&&(t.buttonAO=r),n&&(t.buttonBI=n),s&&(t.buttonBO=s);}return t;},o.prototype.buildData=function(e,t,a,r){return e<<5|t<<4|a<<1|r;},o.prototype.checkStateChange=function(e){var t=this._states,a=[],r=new Date().getTime();for(var n in e){var s={};s.key=n,s.value=e[n],s.changed=!1;var o=t[n]?t[n].value:null,i=t[n]?t[n].time:null,l=e[n];o!=l&&(s.oldvalue=o,s.changed=!0),this._states[n]={value:e[n],time:r},s.changed&&("pressed"==l||"released"==l&&"pressed"==o)&&a.push(s),"pressed"==o&&"released"==l&&(!i||r-i<this._longPressThreshold?((s={}).key=n,s.value="shortPress",s.changed=!0):((s={}).key=n,s.value="longPress",s.changed=!0),a.push(s));}return a;},o.prototype.executeCommand=function(e,t,a){var r,n;if(this._senderID){if(t&&t.value){var s=this,o=100,i=t.value.substr(t.value.length-2),l={},u=0;switch(i){case"AI":u=0;break;case"AO":u=1;break;case"BI":u=2;break;case"BO":u=3;}switch(t.value){case"longPressAI":case"longPressAO":case"longPressBI":case"longPressBO":o=this._longPressThreshold;case"shortPressAI":case"shortPressAO":case"shortPressBI":case"shortPressBO":r=this.buildData(u,1,0,0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(t){t?a&&a(t):(l["button"+i]="pressed",s.activeStateChange(l),setTimeout(function(){r=s.buildData(0,0,0,0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,s._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){l["button"+i]="released",s.activeStateChange(l),a&&a(e);});},o));});break;case"pressAI":case"pressAO":case"pressBI":case"pressBO":r=this.buildData(u,1,0,0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){l["button"+i]="pressed",s.activeStateChange(l),a&&a(e);});break;case"releaseAI":case"releaseAO":case"releaseBI":case"releaseBO":r=s.buildData(0,0,0,0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){l["button"+i]="released",s.activeStateChange(l),a&&a(e);});break;default:a&&a(new Error("unknow command"));}}else a&&a(new Error("command invalid"));}else a&&a(new Error("sender id is null"));};var i=function i(e){o.call(this,e),this._data="f6-02-02";};o.STATES=["buttonAI","buttonAO","buttonBI","buttonBO"],i.COMMANDS=["shortPressAI","longPressAI","pressAI","releaseAI","shortPressAO","longPressAO","pressAO","releaseAO","shortPressBI","longPressBI","pressBI","releaseBI","shortPressBO","longPressBO","pressBO","releaseBO"],(i.prototype=new o()).constructor=i;var l=function l(e){n.call(this,e),this._data="f6-02-03";};l.STATES=["state"],l.COMMANDS=["auto","manu","dimUp","dimDown"],(l.prototype=new n()).constructor=l,l.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 48:t.state="auto";break;case 16:t.state="manu";break;case 112:t.state="dimUp";break;case 80:t.state="dimDown";}return t;},l.prototype.executeCommand=function(e,t,a){var r,n;if(this._senderID){if(t&&t.value){switch(t.value){case"auto":r=48;break;case"manu":r=16;break;case"dimUp":r=112;break;case"dimDown":r=80;break;default:a&&a(new Error("unknow command"));}this.activeStateChange({state:t.value}),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){a&&a(e);});}else a&&a(new Error("command invalid"));}else a&&a(new Error("sender id is null"));};var u=function u(e){o.call(this,e),this._data="f6-02-04",this._longPressThreshold=1e3;};u.STATES=["buttonAI","buttonAO","buttonBI","buttonBO","energyBow"],(u.prototype=new o()).constructor=u,u.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a=e.userData>>7&1,r=e.userData>>3&1,n=e.userData>>2&1,s=e.userData>>1&1,o=1&e.userData;t.energyBow=a?"pressed":"released",t.buttonBI=r?"pressed":"released",t.buttonBO=n?"pressed":"released",t.buttonAI=s?"pressed":"released",t.buttonAO=o?"pressed":"released";}return t;};var c=function c(e){o.call(this,e),this._data="f6-03-01",this._longPressThreshold=1e3;};c.STATES=["buttonAI","buttonAO","buttonBI","buttonBO","buttonCI","buttonCO","buttonDI","buttonDO"],c.COMMANDS=["shortPressAI","longPressAI","pressAI","releaseAI","shortPressAO","longPressAO","pressAO","releaseAO","shortPressBI","longPressBI","pressBI","releaseBI","shortPressBO","longPressBO","pressBO","releaseBO","shortPressCI","longPressCI","pressCI","releaseCI","shortPressCO","longPressCO","pressCO","releaseCO","shortPressDI","longPressDI","pressDI","releaseDI","shortPressDO","longPressDO","pressDO","releaseDO"],(c.prototype=new o()).constructor=c,c.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a,r,n,s,o,i,l,u,c=e.userData>>5&7,h=e.userData>>4&1,_=e.userData>>1&7,p=1&e.userData,d=e.t21,v=e.nu,f=h?"pressed":"released";if(0==d&&1==v){switch(c){case 0:a=f;break;case 1:r=f;break;case 2:n=f;break;case 3:s=f;break;case 4:o=f;break;case 5:i=f;break;case 6:l=f;break;case 7:u=f;}if(p)switch(_){case 0:a=f;break;case 1:r=f;break;case 2:n=f;break;case 3:s=f;break;case 4:o=f;break;case 5:i=f;break;case 6:l=f;break;case 7:u=f;}}else if(0==d&&0==v)switch(c){case 0:case 7:a=f,r=f,n=f,s=f,o=f,i=f,l=f,u=f;}a&&(t.buttonAI=a),r&&(t.buttonAO=r),n&&(t.buttonBI=n),s&&(t.buttonBO=s),o&&(t.buttonCI=o),i&&(t.buttonCO=i),l&&(t.buttonDI=l),u&&(t.buttonDO=u);}return t;},c.prototype.executeCommand=function(e,t,a){var r,n;if(this._senderID){if(t&&t.value){var s=this,o=100,i=t.value.substr(t.value.length-2),l={},u=0;switch(i){case"AI":u=0;break;case"AO":u=1;break;case"BI":u=2;break;case"BO":u=3;break;case"CI":u=4;break;case"CO":u=5;break;case"DI":u=6;break;case"DO":u=7;}switch(t.value){case"longPressAI":case"longPressAO":case"longPressBI":case"longPressBO":case"longPressCI":case"longPressCO":case"longPressDI":case"longPressDO":o=this._longPressThreshold;case"shortPressAI":case"shortPressAO":case"shortPressBI":case"shortPressBO":case"shortPressCI":case"shortPressCO":case"shortPressDI":case"shortPressDO":r=this.buildData(u,1,0,0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(t){t?a&&a(t):(l["button"+i]="pressed",s.activeStateChange(l),setTimeout(function(){r=s.buildData(0,0,0,0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,s._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){l["button"+i]="released",s.activeStateChange(l),a&&a(e);});},o));});break;case"pressAI":case"pressAO":case"pressBI":case"pressBO":case"pressCI":case"pressCO":case"pressDI":case"pressDO":r=this.buildData(u,1,0,0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){l["button"+i]="pressed",s.activeStateChange(l),a&&a(e);});break;case"releaseAI":case"releaseAO":case"releaseBI":case"releaseBO":case"releaseCI":case"releaseCO":case"releaseDI":case"releaseDO":r=s.buildData(0,0,0,0),n=new x.hub.m.enocean.ESP3.Telegram.RPS(r,this._senderID,1,1,0,null),e.sendTelegram(n,!0,function(e){l["button"+i]="released",s.activeStateChange(l),a&&a(e);});break;default:a&&a(new Error("unknow command"));}}else a&&a(new Error("command invalid"));}else a&&a(new Error("sender id is null"));};var h=function h(e){c.call(this,e),this._data="f6-03-02";};h.STATES=["buttonAI","buttonAO","buttonBI","buttonBO","buttonCI","buttonCO","buttonDI","buttonDO"],h.COMMANDS=["shortPressAI","longPressAI","pressAI","releaseAI","shortPressAO","longPressAO","pressAO","releaseAO","shortPressBI","longPressBI","pressBI","releaseBI","shortPressBO","longPressBO","pressBO","releaseBO","shortPressCI","longPressCI","pressCI","releaseCI","shortPressCO","longPressCO","pressCO","releaseCO","shortPressDI","longPressDI","pressDI","releaseDI","shortPressDO","longPressDO","pressDO","releaseDO"],(h.prototype=new c()).constructor=h;var _=function _(e){n.call(this,e),this._data="f6-04-01";};_.STATES=["keycard"],(_.prototype=new n()).constructor=_,_.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a=e.t21,r=e.nu,n=e.userData;1==a&&1==r&&112==n?t.keycard="inserted":1==a&&0==r&&0==n&&(t.keycard="takeout");}return t;};var p=function p(e){n.call(this,e),this._data="f6-04-02";};p.STATES=["keycard"],(p.prototype=new n()).constructor=p,p.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a=e.userData>>7&1,r=e.userData>>2&1;1==a&&1==r?t.keycard="inserted":0==a&&0==r&&(t.keycard="takeout");}return t;};var d=function d(e){n.call(this,e),this._data="f6-05-00";};d.STATES=["wind","lowbat"],(d.prototype=new n()).constructor=d,d.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 0:t.wind="ok",this._states.lowbat||(t.lowbat=!1);break;case 16:t.wind="alarm",this._states.lowbat||(t.lowbat=!1);break;case 48:t.lowbat=!0;}return t;};var v=function v(e){n.call(this,e),this._data="f6-05-01";};v.COMMANDS=["reset"],v.STATES=["water"],(v.prototype=new n()).constructor=v,v.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a=e.t21,r=e.nu,n=e.userData;1==a&&1==r&&17==n&&(t.water="alarm");}return t;},v.prototype.executeCommand=function(e,t,a){t&&t.value?"reset"===t.value?(this.activeStateChange({water:"ok"}),a&&a()):a&&a(new Error("no such command")):a&&a(new Error("command invalid"));};var f=function f(e){n.call(this,e),this._data="f6-05-02";};f.STATES=["smoke","lowbat"],(f.prototype=new n()).constructor=f,f.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 0:t.smoke="ok",this._states.lowbat||(t.lowbat=!1);break;case 16:t.smoke="alarm",this._states.lowbat||(t.lowbat=!1);break;case 48:t.lowbat=!0;}return t;};var m=function m(e){n.call(this,e),this._data="f6-10-00";};m.STATES=["window","handle_pos","handle_raw"],(m.prototype=new n()).constructor=m,m.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a=e.userData,r=parseInt("11010000",2),n=parseInt("11000000",2),s=parseInt("11110000",2),o=parseInt("11110000",2),i=parseInt("11110000",2),l=parseInt("11010000",2);0==(a&r^n)?(t.window="open",t.handle_pos="middle"):0==(a&s^o)?(t.window="closed",t.handle_pos="down"):0==(a&i^l)&&(t.window="tilted",t.handle_pos="up"),t.handle_raw=a;}return t;};var g=function g(e){n.call(this,e),this._data="f6-10-01";};g.STATES=["window","handle_pos","handle_raw"],(g.prototype=new n()).constructor=g,g.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){e.userData;var a=15&e.userData,r=parseInt("1101",2),n=parseInt("1100",2),s=parseInt("1111",2),o=parseInt("1111",2),i=parseInt("1111",2),l=parseInt("1101",2);0==(a&r^n)?(t.window="open",t.handle_pos="middle"):0==(a&s^o)?(t.window="closed",t.handle_pos="down"):0==(a&i^l)&&(t.window="tilted",t.handle_pos="up"),t.handle_raw=a;}return t;};var w=function w(t){e.call(this,t),this._data="d5-??-??";};(w.prototype=new e()).constructor=w;var y=function y(e){w.call(this,e),this._data="d5-00-01";};y.STATES=["contact","contact_raw"],(y.prototype=new w()).constructor=y,y.prototype.evalTelegram=function(e){var t={};if(213==e.rorg){var a=e.userData;if(1==(a>>3&1)){var r=1&a;t.contact=r?"closed":"open",t.contact_raw=r;}}return t;};var S=function S(t){e.call(this,t),this._data="a5-??-??",this.TEACH_IN_VARIATION=2,this.UNIQUE_GATEWAY_SENDERID=!0;};(S.prototype=new e()).constructor=S,S.prototype.getTeachinType=function(){return"4BS";},S.prototype.isTeachinBidirectional=function(){return!1;};var b=function b(e){S.call(this,e),this._data="a5-02-??",this._tmpMin=-40,this._tmpMax=0;};b.STATES=["temperature","temperature_raw"],(b.prototype=new S()).constructor=b,b.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2);if(1==(a>>3&1)){var n=r;t.temperature=parseFloat(((255-n)/255*(this._tmpMax-this._tmpMin)+this._tmpMin).toFixed(1)),t.temperature_raw=n;}}return t;};var T=function T(e){b.call(this,e),this._data="a5-02-01",this._tmpMin=-40,this._tmpMax=0;};T.STATES=["temperature","temperature_raw"],(T.prototype=new b()).constructor=T;var I=function I(e){b.call(this,e),this._data="a5-02-02",this._tmpMin=-30,this._tmpMax=10;};I.STATES=["temperature","temperature_raw"],(I.prototype=new b()).constructor=I;var D=function D(e){b.call(this,e),this._data="a5-02-03",this._tmpMin=-20,this._tmpMax=20;};D.STATES=["temperature","temperature_raw"],(D.prototype=new b()).constructor=D;var E=function E(e){b.call(this,e),this._data="a5-02-04",this._tmpMin=-10,this._tmpMax=30;};E.STATES=["temperature","temperature_raw"],(E.prototype=new b()).constructor=E;var k=function k(e){b.call(this,e),this._data="a5-02-05",this._tmpMin=0,this._tmpMax=40;};k.STATES=["temperature","temperature_raw"],(k.prototype=new b()).constructor=k;var A=function A(e){b.call(this,e),this._data="a5-02-06",this._tmpMin=10,this._tmpMax=50;};A.STATES=["temperature","temperature_raw"],(A.prototype=new b()).constructor=A;var O=function O(e){b.call(this,e),this._data="a5-02-07",this._tmpMin=20,this._tmpMax=60;};O.STATES=["temperature","temperature_raw"],(O.prototype=new b()).constructor=O;var C=function C(e){b.call(this,e),this._data="a5-02-08",this._tmpMin=30,this._tmpMax=70;};C.STATES=["temperature","temperature_raw"],(C.prototype=new b()).constructor=C;var P=function P(e){b.call(this,e),this._data="a5-02-09",this._tmpMin=40,this._tmpMax=80;};P.STATES=["temperature","temperature_raw"],(P.prototype=new b()).constructor=P;var R=function R(e){b.call(this,e),this._data="a5-02-0a",this._tmpMin=50,this._tmpMax=90;};R.STATES=["temperature","temperature_raw"],(R.prototype=new b()).constructor=R;var B=function B(e){b.call(this,e),this._data="a5-02-0b",this._tmpMin=60,this._tmpMax=100;};B.STATES=["temperature","temperature_raw"],(B.prototype=new b()).constructor=B;var N=function N(e){b.call(this,e),this._data="a5-02-10",this._tmpMin=-60,this._tmpMax=20;};N.STATES=["temperature","temperature_raw"],(N.prototype=new b()).constructor=N;var U=function U(e){b.call(this,e),this._data="a5-02-11",this._tmpMin=-50,this._tmpMax=30;};U.STATES=["temperature","temperature_raw"],(U.prototype=new b()).constructor=U;var M=function M(e){b.call(this,e),this._data="a5-02-12",this._tmpMin=-40,this._tmpMax=40;};M.STATES=["temperature","temperature_raw"],(M.prototype=new b()).constructor=M;var F=function F(e){b.call(this,e),this._data="a5-02-13",this._tmpMin=-30,this._tmpMax=50;};F.STATES=["temperature","temperature_raw"],(F.prototype=new b()).constructor=F;var L=function L(e){b.call(this,e),this._data="a5-02-14",this._tmpMin=-20,this._tmpMax=60;};L.STATES=["temperature","temperature_raw"],(L.prototype=new b()).constructor=L;var H=function H(e){b.call(this,e),this._data="a5-02-15",this._tmpMin=-10,this._tmpMax=70;};H.STATES=["temperature","temperature_raw"],(H.prototype=new b()).constructor=H;var J=function J(e){b.call(this,e),this._data="a5-02-16",this._tmpMin=0,this._tmpMax=80;};J.STATES=["temperature","temperature_raw"],(J.prototype=new b()).constructor=J;var V=function V(e){b.call(this,e),this._data="a5-02-17",this._tmpMin=10,this._tmpMax=90;};V.STATES=["temperature","temperature_raw"],(V.prototype=new b()).constructor=V;var q=function q(e){b.call(this,e),this._data="a5-02-18",this._tmpMin=20,this._tmpMax=100;};q.STATES=["temperature","temperature_raw"],(q.prototype=new b()).constructor=q;var W=function W(e){b.call(this,e),this._data="a5-02-19",this._tmpMin=30,this._tmpMax=110;};W.STATES=["temperature","temperature_raw"],(W.prototype=new b()).constructor=W;var j=function j(e){b.call(this,e),this._data="a5-02-1a",this._tmpMin=40,this._tmpMax=120;};j.STATES=["temperature","temperature_raw"],(j.prototype=new b()).constructor=j;var K=function K(e){b.call(this,e),this._data="a5-02-1b",this._tmpMin=50,this._tmpMax=130;};K.STATES=["temperature","temperature_raw"],(K.prototype=new b()).constructor=K;var G=function G(e){S.call(this,e),this._data="a5-02-20",this._tmpMin=-10,this._tmpMax=41.2;};G.STATES=["temperature","temperature_raw"],(G.prototype=new S()).constructor=G,G.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt16BE(1);if(1==(a>>3&1)){var n=1023&r;t.temperature=parseFloat(((1023-n)/1023*(this._tmpMax-this._tmpMin)+this._tmpMin).toFixed(1)),t.temperature_raw=n;}}return t;};var Q=function Q(e){G.call(this,e),this._data="a5-02-30",this._tmpMin=-40,this._tmpMax=62.3;};Q.STATES=["temperature","temperature_raw"],(Q.prototype=new G()).constructor=Q;var Y=function Y(e){S.call(this,e),this._data="a5-04-??",this._humMin=0,this._humMax=100,this._tempMin=0,this._tempMax=40;};Y.STATES=["humidity","humidity_raw","temperature","temperature_raw","available"],(Y.prototype=new S()).constructor=Y,Y.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(1==(a>>3&1)){var s=n;t.humidity=parseFloat((s/250*(this._humMax-this._humMin)+this._humMin).toFixed(1)),t.humidity_raw=s;var o=r;t.temperature=parseFloat((o/250*(this._tempMax-this._tempMin)+this._tempMin).toFixed(1)),t.temperature_raw=o;var i=a>>1&1;t.available=!!i;}}return t;};var z=function z(e){Y.call(this,e),this._data="a5-04-01";};z.STATES=Y.STATES,(z.prototype=new Y()).constructor=z;var X=function X(e){Y.call(this,e),this._data="a5-04-02",this._tempMin=-20,this._tempMax=60;};X.STATES=Y.STATES,(X.prototype=new Y()).constructor=X;var Z=function Z(e){Y.call(this,e),this._data="a5-04-03",this._tempMin=-20,this._tempMax=60;};Z.STATES=["humidity","humidity_raw","temperature","temperature_raw","type"],(Z.prototype=new Y()).constructor=Z,Z.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt16BE(1),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.humidity=parseFloat((s/255*(this._humMax-this._humMin)+this._humMin).toFixed(1)),t.humidity_raw=s;var o=1023&r;t.temperature=parseFloat((o/1023*(this._tempMax-this._tempMin)+this._tempMin).toFixed(1)),t.temperature_raw=o;var i=1&a;t.type=i?"event":"heartbeat";}}return t;};var $=function $(e){S.call(this,e),this._data="a5-06-??",this._svcMin=0,this._svcMax=5.1,this._ill2Min=300,this._ill2Max=3e4,this._ill1Min=600,this._ill1Max=6e4;};$.STATES=["voltage","voltage_raw","illumination2","illumination2_raw","illumination1","illumination1_raw","illumination","illumination_raw","range","range_raw"],($.prototype=new S()).constructor=$,$.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.voltage=parseFloat((o/255*(this._svcMax-this._svcMin)+this._svcMin).toFixed(1)),t.voltage_raw=o;var i=n;t.illumination2=parseFloat((i/255*(this._ill2Max-this._ill2Min)+this._ill2Min).toFixed(1)),t.illumination2_raw=i;var l=r;t.illumination1=parseFloat((l/255*(this._ill1Max-this._ill1Min)+this._ill1Min).toFixed(1)),t.illumination1_raw=l;var u=1&a;switch(u){case 0:t.range="db1",t.illumination=t.illumination1,t.illumination_raw=l;break;case 1:t.range="db2",t.illumination=t.illumination2,t.illumination_raw=l;}t.range_raw=u;}}return t;};var ee=function ee(e){$.call(this,e),this._data="a5-06-01";};ee.STATES=$.STATES,(ee.prototype=new $()).constructor=ee;var te=function te(e){$.call(this,e),this._data="a5-06-02",this._ill2Min=0,this._ill2Max=510,this._ill1Min=0,this._ill1Max=1020;};te.STATES=$.STATES,(te.prototype=new $()).constructor=te;var ae=function ae(e){$.call(this,e),this._data="a5-06-03",this._svcMin=0,this._svcMax=5.1;};ae.STATES=["voltage","voltage_raw","illumination","illumination_raw"],(ae.prototype=new $()).constructor=ae,ae.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt16BE(1),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.voltage=parseFloat((s/255*(this._svcMax-this._svcMin)+this._svcMin).toFixed(1)),t.voltage_raw=s;var o=r>>6&1023;t.illumination=o,t.illumination_raw=o;}}return t;};var re=function re(e){$.call(this,e),this._data="a5-06-04",this._tmpMin=-20,this._tmpMax=60;};re.STATES=["temperature","temperature_raw","illumination","illumination_raw","energy","energy_raw","temperature_avail","energy_avail"],(re.prototype=new $()).constructor=re,re.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt16BE(1),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.temperature=parseFloat((s/255*(this._tmpMax-this._tmpMin)+this._tmpMin).toFixed(1)),t.temperature_raw=s;var o=r;t.illumination=o,t.illumination_raw=o;var i=a>>4&15;t.energy=parseFloat((i/15*100).toFixed(1)),t.energy_raw=i;var l=a>>1&1;t.temperature_avail=!!l,t.temperature_avail||delete t.temperature;var u=1&a;t.energy_avail=!!u,t.energy_avail||delete t.energy;}}return t;};var ne=function ne(e){$.call(this,e),this._data="a5-06-05",this._ill2Min=0,this._ill2Max=5100,this._ill1Min=0,this._ill1Max=10200;};ne.STATES=$.STATES,(ne.prototype=new $()).constructor=ne;var se=function se(e){S.call(this,e),this._data="a5-07-??",this._params||(this._params={reset_timeout:30}),this._resetTO=null;};se.COMMANDS=["reset"],(se.prototype=new S()).constructor=se,se.prototype._startPIROffTO=function(){if(this._resetTO&&(clearTimeout(this._resetTO),this._resetTO=null),this._params.reset_timeout&&!(this._params.reset_timeout<0)){var e=this;this._resetTO=setTimeout(function(){e._resetTO=null,e._reset();},1e3*this._params.reset_timeout);}},se.prototype._stopPIROffTO=function(){this._resetTO&&(clearTimeout(this._resetTO),this._resetTO=null);},se.prototype._reset=function(){this._resetTO&&(clearTimeout(this._resetTO),this._resetTO=null);var e={key:"state",value:"off",changed:!1},t=this._states.state?this._states.state.value:null;"off"!=t&&(e.oldvalue=t,e.changed=!0),this._states.state={value:"off",time:new Date().getTime()},require("x.hub.m.enocean.js")._onEOEvents(this,[e]);},se.prototype.executeCommand=function(e,t,a){t&&t.value?"reset"===t.value?(this._reset(),a&&a()):a&&a(new Error("no such command")):a&&a(new Error("command invalid"));},se.prototype.fromJSON=function(t){return e.prototype.fromJSON.call(this,t)?(this._params||(this._params={reset_timeout:30}),this):null;},se.prototype.fromDBJSON=function(t){return e.prototype.fromDBJSON.call(this,t)?(this._params||(this._params={reset_timeout:30}),this):null;};var oe=function oe(e){se.call(this,e),this._data="a5-07-01";};oe.COMMANDS=["reset"],oe.STATES=["voltage","voltage_raw","state","state_raw","voltage_avail"],(oe.prototype=new se()).constructor=oe,oe.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.voltage=parseFloat((s/250*5).toFixed(1)),t.voltage_raw=s;var o=r;t.state=o>=128?"on":"off",t.state_raw=o;var i=1&a;t.voltage_avail=!!i,t.voltage_avail||delete t.voltage;}}return"on"==t.state?this._startPIROffTO():"off"==t.state&&this._stopPIROffTO(),t;};var ie=function ie(e){se.call(this,e),this._data="a5-07-02";};ie.COMMANDS=["reset"],ie.STATES=["voltage","voltage_raw","state","state_raw"],(ie.prototype=new se()).constructor=ie,ie.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(0);if(1==(a>>3&1)){var n=r;t.voltage=parseFloat((n/250*5).toFixed(1)),t.voltage_raw=n;var s=a>>7&1;t.state=s?"on":"off",t.state_raw=s;}}return"on"==t.state?this._startPIROffTO():"off"==t.state&&this._stopPIROffTO(),t;};var le=function le(e){se.call(this,e),this._data="a5-07-03";};le.COMMANDS=["reset"],le.STATES=["voltage","voltage_raw","illumination","illumination_raw","state","state_raw"],(le.prototype=new se()).constructor=le,le.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt16BE(1),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.voltage=parseFloat((s/250*5).toFixed(1)),t.voltage_raw=s;var o=r>>6&1023;t.illumination=o,t.illumination_raw=o;var i=a>>7&1;t.state=i?"on":"off",t.state_raw=i;}}return"on"==t.state?this._startPIROffTO():"off"==t.state&&this._stopPIROffTO(),t;};var ue=function ue(e){S.call(this,e),this._data="a5-08-??",this._svcMin=0,this._svcMax=5.1,this._illMin=0,this._illMax=510,this._tmpMin=0,this._tmpMax=51;};(ue.prototype=new S()).constructor=ue,ue.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.voltage=parseFloat((o/255*(this._svcMax-this._svcMin)+this._svcMin).toFixed(1)),t.voltage_raw=o;var i=n;t.illumination=parseFloat((i/255*(this._illMax-this._illMin)+this._illMin).toFixed(1)),t.illumination_raw=i;var l=r;t.temperature=parseFloat((l/255*(this._tmpMax-this._tmpMin)+this._tmpMin).toFixed(1)),t.temperature_raw=l;var u=a>>1&1;switch(u){case 0:t.state="on";break;case 1:t.state="off";}t.state_raw=u;var c=1&a;switch(c){case 0:t.button="pressed";break;case 1:t.button="released";}t.button_raw=c;}}return t;};var ce=function ce(e){ue.call(this,e),this._data="a5-08-01";};ce.STATES=["voltage","voltage_raw","illumination","illumination_raw","temperature","temperature_raw","state","state_raw","button","button_raw"],(ce.prototype=new ue()).constructor=ce;var he=function he(e){ue.call(this,e),this._data="a5-08-02",this._illMax=1020;};he.STATES=["voltage","voltage_raw","illumination","illumination_raw","temperature","temperature_raw","state","state_raw","button","button_raw"],(he.prototype=new ue()).constructor=he;var _e=function _e(e){ue.call(this,e),this._data="a5-08-03",this._illMax=1530,this._tmpMin=-30,this._tmpMax=50;};_e.STATES=["voltage","voltage_raw","illumination","illumination_raw","temperature","temperature_raw","state","state_raw","button","button_raw"],(_e.prototype=new ue()).constructor=_e;var pe=function pe(e){S.call(this,e),this._data="a5-09-??";};(pe.prototype=new S()).constructor=pe;var de=function de(e){pe.call(this,e),this._data="a5-09-02",this._svcMin=0,this._svcMax=5.1,this._gasMin=0,this._gasMax=1020,this._tmpMin=0,this._tmpMax=51;};de.STATES=["voltage","voltage_raw","gas","gas_raw","temperature","temperature_raw","temperature_available"],(de.prototype=new pe()).constructor=de,de.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.voltage=parseFloat((o/255*(this._svcMax-this._svcMin)+this._svcMin).toFixed(1)),t.voltage_raw=o;var i=n;t.gas=parseFloat((i/255*(this._gasMax-this._gasMin)+this._gasMin).toFixed(1)),t.gas_raw=i;var l=r;t.temperature=parseFloat((l/255*(this._tmpMax-this._tmpMin)+this._tmpMin).toFixed(1)),t.temperature_raw=l;var u=a>>1&1;t.temperature_available=!!u,u||delete t.temperature;}}return t;};var ve=function ve(e){pe.call(this,e),this._data="a5-09-04",this._humMin=0,this._humMax=100,this._gasMin=0,this._gasMax=2550,this._tmpMin=0,this._tmpMax=51;};ve.STATES=["humidity","humidity_raw","gas","gas_raw","temperature","temperature_raw","temperature_available","humidity_available"],(ve.prototype=new pe()).constructor=ve,ve.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.humidity=parseFloat((o/255*(this._humMax-this._humMin)+this._humMin).toFixed(1)),t.humidity_raw=o;var i=n;t.gas=parseFloat((i/255*(this._gasMax-this._gasMin)+this._gasMin).toFixed(1)),t.gas_raw=i;var l=r;t.temperature=parseFloat((l/255*(this._tmpMax-this._tmpMin)+this._tmpMin).toFixed(1)),t.temperature_raw=l;var u=a>>2&1;t.humidity_available=!!u,u||delete t.humidity;var c=a>>1&1;t.temperature_available=!!c,c||delete t.temperature;}}return t;};var fe=function fe(e){pe.call(this,e),this._data="a5-09-05";};fe.STATES=["voc","voc_raw","voc_id","voc_id_raw","scale"],(fe.prototype=new pe()).constructor=fe,fe.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt16BE(0);if(1==(a>>3&1)){var s=3&a,o=1;switch(s){case 0:o=.01;break;case 1:o=.1;break;case 2:o=1;break;case 3:o=10;}t.scale=o;var i=n;t.voc=n*o,t.voc_raw=i;var l=r;switch(s){case 0:t.voc_id="VOCT";break;case 1:t.voc_id="Formaldehyde";break;case 2:t.voc_id="Benzene";break;case 3:t.voc_id="Styrene";break;case 4:t.voc_id="Toluene";break;case 5:t.voc_id="Tetrachloroethylene";break;case 6:t.voc_id="Xylene";break;case 7:t.voc_id="n-Hexane";break;case 8:t.voc_id="n-Octane";break;case 9:t.voc_id="Cyclopentane";break;case 10:t.voc_id="Methanol";break;case 11:t.voc_id="Ethanol";break;case 12:t.voc_id="1-Pentanol";break;case 13:t.voc_id="Acetone";break;case 14:t.voc_id="ethylene Oxide";break;case 15:t.voc_id="Acetaldehyde ue";break;case 16:t.voc_id="Acetic Acid";break;case 17:t.voc_id="Propionice Acid";break;case 18:t.voc_id="Valeric Acid";break;case 19:t.voc_id="Butyric Acid";break;case 20:t.voc_id="Ammoniac";break;case 22:t.voc_id="Hydrogen Sulfide";break;case 23:t.voc_id="Dimethylsulfide";break;case 24:t.voc_id="2-Butanol";break;case 25:t.voc_id="2-Methylpropanol";break;case 26:t.voc_id="Diethyl ether";break;case 255:t.voc_id="ozone";}t.voc_id_raw=l;}}return t;};var me=function me(e){pe.call(this,e),this._data="a5-09-06";};me.STATES=["radon"],(me.prototype=new pe()).constructor=me,me.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt16BE(0);if(1==(a>>3&1)){var n=r>>6&1023;t.radon=n;}}return t;};var ge=function ge(e){pe.call(this,e),this._data="a5-09-07";};ge.STATES=["pm10","pm25","pm1","pm10_active","pm25_active","pm25_active"],(ge.prototype=new pe()).constructor=ge,ge.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt16BE(2),n=e.userData.readUInt16BE(1),s=e.userData.readUInt16BE(0);if(1==(a>>3&1)){var o=s>>7&511;t.pm10=o;var i=n>>6&511;t.pm25=i;var l=r>>5&511;t.pm1=l;var u=a>>2&1;t.pm10_active=!!u,u||delete t.pm10;var c=a>>1&1;t.pm25_active=!!c,c||delete t.pm25;var h=1&a;t.pm1_active=!!h,h||delete t.pm1;}}return t;};var we=function we(e){pe.call(this,e),this._data="a5-09-08";};we.STATES=["co2","co2_raw"],(we.prototype=new pe()).constructor=we,we.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2);if(1==(a>>3&1)){var n=r;t.co2=parseFloat((n/255*2e3).toFixed(1)),t.co2_raw=n;}}return t;};var ye=function ye(e){pe.call(this,e),this._data="a5-09-09";};ye.STATES=["co2","co2_raw","power_failure_detected"],(ye.prototype=new pe()).constructor=ye,ye.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2);if(1==(a>>3&1)){var n=r;t.co2=parseFloat((n/255*2e3).toFixed(1)),t.co2_raw=n;var s=a>>2&1;t.power_failure_detected=!!s;}}return t;};var Se=function Se(e){pe.call(this,e),this._data="a5-09-0a",this._svcMin=2,this._svcMax=5,this._tmpMin=-20,this._tmpMax=60;};Se.STATES=["voltage","voltage_raw","gas","gas_raw","temperature","temperature_raw","temperature_available","voltage_available"],(Se.prototype=new pe()).constructor=Se,Se.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt16BE(0);if(1==(a>>3&1)){var s=n;t.gas=s,t.gas_raw=s;var o=r;t.temperature=parseFloat((o/255*(this._tmpMax-this._tmpMin)+this._tmpMin).toFixed(1)),t.temperature_raw=o;var i=a>>4&15;t.voltage=parseFloat((i/15*(this._svcMax-this._svcMin)+this._svcMin).toFixed(1)),t.voltage_raw=i;var l=a>>1&1;t.temperature_available=!!l,l||delete t.temperature;var u=1&a;t.voltage_available=!!u,u||delete t.voltage;}}return t;};var be=function be(e){pe.call(this,e),this._data="a5-09-0b",this._svcMin=2,this._svcMax=5;};be.STATES=["voltage","voltage_raw","radio","radio_raw","scale","unit","unit_raw","voltage_available"],(be.prototype=new pe()).constructor=be,be.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt16BE(2),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n>>4&15;t.voltage=parseFloat((s/15*(this._svcMax-this._svcMin)+this._svcMin).toFixed(1)),t.voltage_raw=s;var o=1;switch(a>>4&15){case 0:o=.001;break;case 1:o=.01;break;case 2:o=.1;break;case 3:o=1;break;case 4:o=10;break;case 5:o=100;break;case 6:o=1e3;break;case 7:o=1e4;break;case 8:o=1e5;}t.scale=o;var i=r;t.radio=i/10*o,t.radio_raw=i;var l=a>>1&3;switch(l){case 0:t.unit="Sv/h";break;case 1:t.unit="cpm";break;case 2:t.unit="Bq/L";break;case 3:t.unit="Bq/kg";}t.unit_raw=l;var u=1&a;t.voltage_available=!!u,u||delete t.voltage;}}return t;};var Te=function Te(e){pe.call(this,e),this._data="a5-09-0c";};Te.STATES=["voc","voc_raw","voc_id","voc_id_raw","unit","unit_raw","scale"],(Te.prototype=new pe()).constructor=Te,Te.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt16BE(0);if(1==(a>>3&1)){var s=3&a,o=1;switch(s){case 0:o=.01;break;case 1:o=.1;break;case 2:o=1;break;case 3:o=10;}t.scale=o;var i=a>>1&1;switch(i){case 0:t.unit="ppb";break;case 1:t.unit="Sv/m3";}t.unit_raw=i;var l=n;t.voc=n*o,t.voc_raw=l;var u=r;switch(s){case 0:t.voc_id="VOCT";break;case 1:t.voc_id="Formaldehyde";break;case 2:t.voc_id="Benzene";break;case 3:t.voc_id="Styrene";break;case 4:t.voc_id="Toluene";break;case 5:t.voc_id="Tetrachloroethylene";break;case 6:t.voc_id="Xylene";break;case 7:t.voc_id="n-Hexane";break;case 8:t.voc_id="n-Octane";break;case 9:t.voc_id="Cyclopentane";break;case 10:t.voc_id="Methanol";break;case 11:t.voc_id="Ethanol";break;case 12:t.voc_id="1-Pentanol";break;case 13:t.voc_id="Acetone";break;case 14:t.voc_id="ethylene Oxide";break;case 15:t.voc_id="Acetaldehyde ue";break;case 16:t.voc_id="Acetic Acid";break;case 17:t.voc_id="Propionice Acid";break;case 18:t.voc_id="Valeric Acid";break;case 19:t.voc_id="Butyric Acid";break;case 20:t.voc_id="Ammoniac";break;case 22:t.voc_id="Hydrogen Sulfide";break;case 23:t.voc_id="Dimethylsulfide";break;case 24:t.voc_id="2-Butanol";break;case 25:t.voc_id="2-Methylpropanol";break;case 26:t.voc_id="Diethyl ether";break;case 27:t.voc_id="Naphthalene";break;case 28:t.voc_id="4-Phenylcyclohexene";break;case 29:t.voc_id="Limonene";break;case 30:t.voc_id="Trichloroethylene";break;case 31:t.voc_id="Isovaleric acid";break;case 32:t.voc_id="Indole";break;case 33:t.voc_id="Cadaverine";break;case 34:t.voc_id="Putrescine";break;case 35:t.voc_id="Caproic acid";break;case 255:t.voc_id="ozone";}t.voc_id_raw=u;}}return t;};var Ie=function Ie(e){S.call(this,e),this._data="a5-10-??";};(Ie.prototype=new S()).constructor=Ie;var De=function De(e){Ie.call(this,e),this._data="a5-10-01",this._params||(this._params={minSP:18,maxSP:26});};De.STATES=["fan_speed","fan_speed_raw","setpoint","setpoint_raw","temperature","temperature_raw","button","button_raw"],(De.prototype=new Ie()).constructor=De,De.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.fan_speed=o<=144?"3":o<=164?"2":o<=189?"1":o<=209?"0":"auto",t.fan_speed_raw=o;var i=n;t.setpoint=parseFloat((i/255*(this._params.maxSP-this._params.minSP)+this._params.minSP).toFixed(1)),t.setpoint_raw=i;var l=r;t.temperature=parseFloat(((255-l)/255*40).toFixed(1)),t.temperature_raw=l;var u=1&a;switch(u){case 0:t.button="pressed";break;case 1:t.button="released";}t.button_raw=u;}}return t;},De.prototype.fromJSON=function(t){return e.prototype.fromJSON.call(this,t)?(this._params||(this._params={minSP:18,maxSP:26}),this):null;},De.prototype.fromDBJSON=function(t){return e.prototype.fromDBJSON.call(this,t)?(this._params||(this._params={minSP:18,maxSP:26}),this):null;};var Ee=function Ee(e){De.call(this,e),this._data="a5-10-02";};Ee.STATES=["fan_speed","fan_speed_raw","setpoint","setpoint_raw","temperature","temperature_raw","slider","slider_raw"],(Ee.prototype=new De()).constructor=Ee,Ee.prototype.evalTelegram=function(e){var t=De.prototype.evalTelegram.call(this,e);if(0==Object.keys(t).length)return t;delete t.button,delete t.button_raw;var a=1&e.userData.readUInt8(3);return t.slider=a?"day":"night",t.slider_raw=a,t;};var ke=function ke(e){De.call(this,e),this._data="a5-10-03",this.TEACH_IN_VARIATION=1;};ke.STATES=["setpoint","setpoint_raw","temperature","temperature_raw"],(ke.prototype=new De()).constructor=ke,ke.prototype.evalTelegram=function(e){var t=De.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.fan_speed,delete t.fan_speed_raw,delete t.button,delete t.button_raw),t;};var xe=function xe(e){De.call(this,e),this._data="a5-10-04";};xe.STATES=["fan_speed","fan_speed_raw","setpoint","setpoint_raw","temperature","temperature_raw"],(xe.prototype=new De()).constructor=xe,xe.prototype.evalTelegram=function(e){var t=De.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.button,delete t.button_raw),t;};var Ae=function Ae(e){De.call(this,e),this._data="a5-10-05";};Ae.STATES=["setpoint","setpoint_raw","temperature","temperature_raw","button","button_raw"],(Ae.prototype=new De()).constructor=Ae,Ae.prototype.evalTelegram=function(e){var t=De.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.fan_speed,delete t.fan_speed_raw),t;};var Oe=function Oe(e){Ee.call(this,e),this._data="a5-10-06";};Oe.STATES=["setpoint","setpoint_raw","temperature","temperature_raw","slider","slider_raw"],(Oe.prototype=new Ee()).constructor=Oe,Oe.prototype.evalTelegram=function(e){var t=Ee.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.fan_speed,delete t.fan_speed_raw),t;};var Ce=function Ce(e){De.call(this,e),this._data="a5-10-07";};Ce.STATES=["fan_speed","fan_speed_raw","temperature","temperature_raw"],(Ce.prototype=new De()).constructor=Ce,Ce.prototype.evalTelegram=function(e){var t=De.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.setpoint,delete t.setpoint_raw,delete t.button,delete t.button_raw),t;};var Pe=function Pe(e){De.call(this,e),this._data="a5-10-08",this._params=null;};Pe.STATES=["fan_speed","fan_speed_raw","temperature","temperature_raw","button","button_raw"],(Pe.prototype=new De()).constructor=Pe,Pe.prototype.evalTelegram=function(e){var t=De.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.setpoint,delete t.setpoint_raw),t;},Pe.prototype.fromJSON=function(t){return e.prototype.fromJSON.call(this,t);},Pe.prototype.fromDBJSON=function(t){return e.prototype.fromDBJSON.call(this,t);};var Re=function Re(e){Ee.call(this,e),this._data="a5-10-09",this._params=null;};Re.STATES=["fan_speed","fan_speed_raw","temperature","temperature_raw","slider","slider_raw"],(Re.prototype=new Ee()).constructor=Re,Re.prototype.evalTelegram=function(e){var t=Ee.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.setpoint,delete t.setpoint_raw),t;},Re.prototype.fromJSON=function(t){return e.prototype.fromJSON.call(this,t);},Re.prototype.fromDBJSON=function(t){return e.prototype.fromDBJSON.call(this,t);};var Be=function Be(e){De.call(this,e),this._data="a5-10-0a";};Be.STATES=["setpoint","setpoint_raw","temperature","temperature_raw","contact","contact_raw"],(Be.prototype=new De()).constructor=Be,Be.prototype.evalTelegram=function(e){var t=De.prototype.evalTelegram.call(this,e);if(0==Object.keys(t).length)return t;delete t.fan_speed,delete t.fan_speed_raw,delete t.button,delete t.button_raw;var a=1&e.userData.readUInt8(3);return t.contact=a?"open":"closed",t.contact_raw=a,t;};var Ne=function Ne(e){Be.call(this,e),this._data="a5-10-0b",this._params=null;};Ne.STATES=["temperature","temperature_raw","contact","contact_raw"],(Ne.prototype=new Be()).constructor=Ne,Ne.prototype.evalTelegram=function(e){var t=Be.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.setpoint,delete t.setpoint_raw),t;},Ne.prototype.fromJSON=function(t){return e.prototype.fromJSON.call(this,t);},Ne.prototype.fromDBJSON=function(t){return e.prototype.fromDBJSON.call(this,t);};var Ue=function Ue(e){Pe.call(this,e),this._data="a5-10-0c";};Ue.STATES=["temperature","temperature_raw","button","button_raw"],(Ue.prototype=new Pe()).constructor=Ue,Ue.prototype.evalTelegram=function(e){var t=Pe.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.fan_speed,delete t.fan_speed_raw),t;};var Me=function Me(e){Re.call(this,e),this._data="a5-10-0d";};Me.STATES=["temperature","temperature_raw","slider","slider_raw"],(Me.prototype=new Re()).constructor=Me,Me.prototype.evalTelegram=function(e){var t=Re.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.fan_speed,delete t.fan_speed_raw),t;};var Fe=function Fe(e){Ie.call(this,e),this._data="a5-10-10",this._params||(this._params={minSP:18,maxSP:26});};Fe.STATES=["setpoint","setpoint_raw","humidity","humidity_raw","temperature","temperature_raw","button","button_raw"],(Fe.prototype=new Ie()).constructor=Fe,Fe.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.setpoint=parseFloat((o/255*(this._params.maxSP-this._params.minSP)+this._params.minSP).toFixed(1)),t.setpoint_raw=o;var i=n;t.humidity=parseFloat((i/250*100).toFixed(1)),t.humidity_raw=i;var l=r;t.temperature=parseFloat((l/250*40).toFixed(1)),t.temperature_raw=l;var u=1&a;switch(u){case 0:t.button="pressed";break;case 1:t.button="released";}t.button_raw=u;}}return t;},Fe.prototype.fromJSON=function(t){return e.prototype.fromJSON.call(this,t)?(this._params||(this._params={minSP:18,maxSP:26}),this):null;},Fe.prototype.fromDBJSON=function(t){return e.prototype.fromDBJSON.call(this,t)?(this._params||(this._params={minSP:18,maxSP:26}),this):null;};var Le=function Le(e){Fe.call(this,e),this._data="a5-10-11";};Le.STATES=["setpoint","setpoint_raw","humidity","humidity_raw","temperature","temperature_raw","slider","slider_raw"],(Le.prototype=new Fe()).constructor=Le,Le.prototype.evalTelegram=function(e){var t=Fe.prototype.evalTelegram.call(this,e);if(0==Object.keys(t).length)return t;delete t.button,delete t.button_raw;var a=1&e.userData.readUInt8(3);return t.slider=a?"day":"night",t.slider_raw=a,t;};var He=function He(e){Fe.call(this,e),this._data="a5-10-12";};He.STATES=["setpoint","setpoint_raw","humidity","humidity_raw","temperature","temperature_raw"],(He.prototype=new Fe()).constructor=He,He.prototype.evalTelegram=function(e){var t=Fe.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.button,delete t.button_raw),t;};var Je=function Je(e){Fe.call(this,e),this._data="a5-10-13";};Je.STATES=["humidity","humidity_raw","temperature","temperature_raw","button","button_raw"],(Je.prototype=new Fe()).constructor=Je,Je.prototype.evalTelegram=function(e){var t=Fe.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.setpoint,delete t.setpoint_raw),t;};var Ve=function Ve(e){Le.call(this,e),this._data="a5-10-14";};Ve.STATES=["humidity","humidity_raw","temperature","temperature_raw","slider","slider_raw"],(Ve.prototype=new Le()).constructor=Ve,Ve.prototype.evalTelegram=function(e){var t=Le.prototype.evalTelegram.call(this,e);return 0==Object.keys(t).length||(delete t.setpoint,delete t.setpoint_raw),t;};var qe=function qe(e){S.call(this,e),this._data="a5-11-??";};(qe.prototype=new S()).constructor=qe;var We=function We(e){qe.call(this,e),this._data="a5-11-03";};We.STATES=["position","angle","position_flag","position_flag_raw","angle_flag","angle_flag_raw","error","error_raw","end_position","end_position_raw","state","state_raw","service_mode","position_mode","power","energy","current","voltage","power_raw","power_unit","energy_unit","current_unit","voltage_unit","power_unit_raw"],(We.prototype=new qe()).constructor=We,We.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.position=o;var i=n>>7&1,l=127&n;t.angle=2*(i?0-l:l);var u=r>>7&1;t.position_flag=!!u,t.position_flag_raw=u;var c=r>>6&1;t.angle_flag=!!c,t.angle_flag_raw=c;var h=r>>4&3;switch(t.error_raw=h,h){case 0:t.error="no_error";break;case 1:t.error="no_end_position";break;case 2:t.error="intern_failure";}var _=r>>2&3;switch(t.end_position_raw=_,_){case 0:t.end_position="no_end_position";break;case 1:t.end_position="end_position_not_reach";break;case 2:t.end_position="fully_open";break;case 3:t.end_position="fully_closed";}var p=3&r;switch(t.state_raw=p,p){case 0:t.state="no_status";break;case 1:t.state="stopped";break;case 2:t.state="opens";break;case 3:t.state="closes";}var d=a>>7&1;t.service_mode=d;var v=a>>6&1;t.position_mode=v;}}return t;};var je=function je(e){qe.call(this,e),this._data="a5-11-04";};je.STATES=["state","state_raw","level","rgb","power","energy","current","voltage","power_raw","power_unit","energy_unit","current_unit","voltage_unit","power_unit_raw","op_hour","error","error_raw","service_mode","op_hour_flag","op_hour_flag_raw","mode_raw"],(je.prototype=new qe()).constructor=je,je.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=a>>7&1;t.service_mode=o;var i=a>>6&1;t.op_hour_flag=!!i,t.op_hour_flag_raw=i;var l=a>>4&3;switch(t.error_raw=l,l){case 0:t.error="no_error";break;case 1:t.error="lamp_failure";break;case 2:t.error="intern_failure";break;case 3:t.error="extern_failure";}var u=1&a;t.state=u?"on":"off",t.state_raw=u;var c=a>>1&3;switch(t.mode_raw=c,c){case 0:t.level=s,t.op_hour=n<<8|r;break;case 1:var h=s.toString(16);h.length<2&&(h="0"+h);var _=n.toString(16);_.length<2&&(_="0"+_);var p=r.toString(16);p.length<2&&(p="0"+p),t.rgb=h.toUpperCase()+_.toUpperCase()+p.toUpperCase();break;case 2:t.power_raw=s<<8|n,t.power_unit_raw=r;var d=["mW","W","kW","MW","Wh","kWh","MWh","GWh","mA","1/10A","mV","1/10V"];r<=3?(t.power=t.power_raw,t.power_unit=d[r]):r<=7?(t.energy=t.power_raw,t.energy_unit=d[r]):r<=9?(t.current=t.power_raw,t.current_unit=d[r]):r<=11&&(t.voltage=t.power_raw,t.voltage_unit=d[r]);}}}return t;};var Ke=function Ke(e){S.call(this,e),this._data="a5-12-??";};Ke.STATES=["meter_raw","channel_raw","type_raw","scale_raw","scale","meter","current","cumulative"],(Ke.prototype=new S()).constructor=Ke,Ke.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt32BE(0);if(1==(a>>3&1)){var n=r>>8&16777215;t.meter_raw=n;var s=a>>4&15;t.channel_raw=s;var o=a>>2&1;t.type_raw=o;var i=3&a;switch(t.scale_raw=i,i){case 0:t.scale=1,t.meter=n;break;case 1:t.scale=.1,t.meter=.1*n;break;case 2:t.scale=.01,t.meter=.01*n;break;case 3:t.scale=.001,t.meter=.001*n;}o?t.current=t.meter:t.cumulative=t.meter;}}return t;};var Ge=function Ge(e){Ke.call(this,e),this._data="a5-12-00";};Ge.STATES=["current","counter","channel"],(Ge.prototype=new Ke()).constructor=Ge,Ge.prototype.evalTelegram=function(e){var t=Ke.prototype.evalTelegram.call(this,e);return t.counter=t.cumulative,t.channel=t.channel_raw,t;};var Qe=function Qe(e){Ke.call(this,e),this._data="a5-12-01";};Qe.STATES=["power","energy","tariff"],(Qe.prototype=new Ke()).constructor=Qe,Qe.prototype.evalTelegram=function(e){var t=Ke.prototype.evalTelegram.call(this,e);return t.energy=t.cumulative,t.power=t.current,t.tariff=t.channel_raw,t;};var Ye=function Ye(e){Ke.call(this,e),this._data="a5-12-02";};Ye.STATES=["volume","flow","tariff"],(Ye.prototype=new Ke()).constructor=Ye,Ye.prototype.evalTelegram=function(e){var t=Ke.prototype.evalTelegram.call(this,e);return t.volume=t.cumulative,t.flow=t.current,t.tariff=t.channel_raw,t;};var ze=function ze(e){Ye.call(this,e),this._data="a5-12-03";};ze.STATES=["volume","flow","tariff"],(ze.prototype=new Ye()).constructor=ze;var Xe=function Xe(e){S.call(this,e),this._data="a5-13-??";};Xe.STATES=["lux","lux_raw","temperature","temperature_raw","wind","wind_raw","day_night","rain","sun_west","sun_west_raw","sun_south","sun_south_raw","sun_east","sun_east_raw","hemisphere","day","month","year","date_src","weekday","hour","min","sec","time_format","am_pm","time_src","elv","azm","latitude","longitude","latitude_raw","longitude_raw"],(Xe.prototype=new S()).constructor=Xe,Xe.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1))switch(a>>4&15){case 1:var o=s;t.lux=parseFloat((o/255*1e3).toFixed(1)),t.lux_raw=o;var i=n;t.temperature=parseFloat((i/255*120-40).toFixed(1)),t.temperature_raw=i;var l=r;t.wind=parseFloat((l/255*70).toFixed(1)),t.wind_raw=l;var u=a>>2&1;t.day_night=u?"night":"day";var c=a>>1&1;t.rain=c?"true":"false";break;case 2:var h=s;t.sun_west=parseFloat((h/255*150).toFixed(1)),t.sun_west_raw=h;var _=n;t.sun_south=parseFloat((_/255*150).toFixed(1)),t.sun_south_raw=i;var p=r;t.sun_east=parseFloat((p/255*150).toFixed(1)),t.sun_east_raw=p;var d=a>>2&1;t.hemisphere=d?"south":"north";break;case 3:var v=15&s;t.day=v;var f=7&n;t.month=f;var m=127&r;t.year=m+2e3;var g=1&a;t.date_src=g?"gps":"rtc";break;case 4:var w=s>>5&7;t.weekday=w;var y=31&s;t.hour=y;var S=63&n;t.min=S;var b=63&r;t.sec=b;var T=a>>2&1;t.time_format=T?"12":"24";var I=a>>1&1;t.am_pm=I?"pm":"am";var D=1&a;t.time_src=D?"gps":"rtc";break;case 5:var E=s;t.elv=E-90,t.elv_raw=E;var k=511&e.userData.readUInt16BE(1);t.azm=k,t.azm_raw=k;break;case 6:var x=(s>>4&15)<<8|n,A=(15&s)<<8|r;t.latitude=parseFloat((x/4095*180-90).toFixed(1)),t.latitude_raw=x,t.longitude=parseFloat((A/4095*360-180).toFixed(1)),t.longitude_raw=A;}}return t;};var Ze=function Ze(e){Xe.call(this,e),this._data="a5-13-01";};Ze.STATES=["lux","lux_raw","temperature","temperature_raw","wind","wind_raw","day_night","rain","sun_west","sun_west_raw","sun_south","sun_south_raw","sun_east","sun_east_raw","hemisphere","day","month","year","date_src","weekday","hour","min","sec","time_format","am_pm","time_src","elv","azm","latitude","longitude","latitude_raw","longitude_raw"],(Ze.prototype=new Xe()).constructor=Ze;var $e=function $e(e){Xe.call(this,e),this._data="a5-13-02";};$e.STATES=["sun_west","sun_west_raw","sun_south","sun_south_raw","sun_east","sun_east_raw","hemisphere"],($e.prototype=new Xe()).constructor=$e;var et=function et(e){Xe.call(this,e),this._data="a5-13-03";};et.STATES=["day","month","year","date_src"],(et.prototype=new Xe()).constructor=et;var tt=function tt(e){Xe.call(this,e),this._data="a5-13-04";};tt.STATES=["weekday","hour","min","sec","time_format","am_pm","time_src"],(tt.prototype=new Xe()).constructor=tt;var at=function at(e){Xe.call(this,e),this._data="a5-13-05";};at.STATES=["elv","azm"],(at.prototype=new Xe()).constructor=at;var rt=function rt(e){Xe.call(this,e),this._data="a5-13-06";};rt.STATES=["latitude","longitude"],(rt.prototype=new Xe()).constructor=rt;var nt=function nt(t){e.call(this,t),this._data="a5-14-01";};nt.STATES=["voltage","voltage_raw","state"],(nt.prototype=new e()).constructor=nt,nt.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(0);if(1==(a>>3&1)){var n=r;t.voltage=n/250*5,t.voltage_raw=n;var s=1&a;switch(s){case 0:t.state="closed";break;case 1:t.state="open";}t.state_raw=s;}}return t;};var st=function st(t){e.call(this,t),this._data="a5-14-02";};st.STATES=["voltage","voltage_raw","illumination","illumination_raw","state"],(st.prototype=new e()).constructor=st,st.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(1),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.voltage=s/250*5,t.voltage_raw=s;var o=r;t.illumination=o/250*1e3,t.illumination_raw=o;var i=1&a;switch(t.state_raw=i,i){case 0:t.state="closed";break;case 1:t.state="open";}}}return t;};var ot=function ot(t){e.call(this,t),this._data="a5-14-03";};ot.STATES=["voltage","voltage_raw","state","viberation"],(ot.prototype=new e()).constructor=ot,ot.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(0);if(1==(a>>3&1)){var n=r;t.voltage=n/250*5,t.voltage_raw=n;var s=a>>1&1;switch(1&a){case 0:t.state="closed";break;case 1:t.state="open";}switch(s){case 0:t.viberation=!1;break;case 1:t.viberation=!0;}}}return t;};var it=function it(t){e.call(this,t),this._data="a5-14-04";};it.STATES=["voltage","voltage_raw","illumination","illumination_raw","state","viberation"],(it.prototype=new e()).constructor=it,it.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(1),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.voltage=s/250*5,t.voltage_raw=s;var o=r;t.illumination=o/250*1e3,t.illumination_raw=o;var i=a>>1&1;switch(1&a){case 0:t.state="closed";break;case 1:t.state="open";}switch(i){case 0:t.viberation=!1;break;case 1:t.viberation=!0;}}}return t;};var lt=function lt(t){e.call(this,t),this._data="a5-14-05";};lt.STATES=["voltage","voltage_raw","viberation"],(lt.prototype=new e()).constructor=lt,lt.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(0);if(1==(a>>3&1)){var n=r;switch(t.voltage=n/250*5,t.voltage_raw=n,a>>1&1){case 0:t.viberation=!1;break;case 1:t.viberation=!0;}}}return t;};var ut=function ut(t){e.call(this,t),this._data="a5-14-06";};ut.STATES=["voltage","voltage_raw","illumination","illumination_raw","viberation"],(ut.prototype=new e()).constructor=ut,ut.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(1),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.voltage=s/250*5,t.voltage_raw=s;var o=r;switch(t.illumination=o/250*1e3,t.illumination_raw=o,a>>1&1){case 0:t.viberation=!1;break;case 1:t.viberation=!0;}}}return t;};var ct=function ct(t){e.call(this,t),this._data="a5-14-07";};ct.STATES=["voltage","voltage_raw","state","lock"],(ct.prototype=new e()).constructor=ct,ct.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(0);if(1==(a>>3&1)){var n=r;t.voltage=n/250*5,t.voltage_raw=n;var s=a>>1&1;switch(a>>2&1){case 0:t.state="closed";break;case 1:t.state="open";}switch(s){case 0:t.lock="locked";break;case 1:t.lock="unlocked";}}}return t;};var ht=function ht(t){e.call(this,t),this._data="a5-14-08";};ht.STATES=["voltage","voltage_raw","state","lock","viberation"],(ht.prototype=new e()).constructor=ht,ht.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(0);if(1==(a>>3&1)){var n=r;t.voltage=n/250*5,t.voltage_raw=n;var s=a>>1&1,o=1&a;switch(a>>2&1){case 0:t.state="closed";break;case 1:t.state="open";}switch(s){case 0:t.lock="locked";break;case 1:t.lock="unlocked";}switch(o){case 0:t.viberation=!1;break;case 1:t.viberation=!0;}}}return t;};var _t=function _t(t){e.call(this,t),this._data="a5-14-09";};_t.STATES=["voltage","voltage_raw","state"],(_t.prototype=new e()).constructor=_t,_t.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(0);if(1==(a>>3&1)){var n=r;switch(t.voltage=n/250*5,t.voltage_raw=n,a>>1&3){case 0:t.state="closed";break;case 1:t.state="tilted";break;case 2:t.state="reserved";break;case 3:t.state="open";}}}return t;};var pt=function pt(t){e.call(this,t),this._data="a5-14-0a";};pt.STATES=["voltage","voltage_raw","state","viberation"],(pt.prototype=new e()).constructor=pt,pt.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(0);if(1==(a>>3&1)){var n=r;t.voltage=n/250*5,t.voltage_raw=n;var s=1&a;switch(a>>1&3){case 0:t.state="closed";break;case 1:t.state="tilted";break;case 2:t.state="reserved";break;case 3:t.state="open";}switch(s){case 0:t.viberation=!1;break;case 1:t.viberation=!0;}}}return t;};var dt=function dt(e){S.call(this,e),this._data="a5-20-04",this.TEACH_IN_VARIATION=3,this._defaultSetpoint=15,this._defaultWakeupCycle=3,this._defaultDisplay=0,this._states={pending:{value:!1,time:new Date().getTime()}},this._valve_new=null,this._setpoint_new=null,this._measurement_new=null,this._wakeup_cycle_new=null,this._display_new=null,this._button_lock_new=null,this._service_command_new=null;};dt.COMMANDS=["setValve","setTo","up","down","measureOn","measureOff","setWakeup","setDisplay","buttonLock","buttonUnlock","openValve","closeValve","init"],dt.STATES=["valve","measurement","button_lock","temperature_selection","feed_temperature","setpoint","error","temperature","wakeup_cycle","display","pending"],(dt.prototype=new S()).constructor=dt,dt.prototype.setDefaultParams=function(){this._params||(this._params={}),void 0!==this._params.wakeup_cycle&&null!=this._params.wakeup_cycle||(this._params.wakeup_cycle=this._defaultWakeupCycle),void 0!==this._params.display&&null!=this._params.display||(this._params.display=this._defaultDisplay);},dt.prototype.getStatesBuffer=function(){var e=JSON.parse(JSON.stringify(this._states));return e.wakeup_cycle={value:this._params.wakeup_cycle,time:-1},e.display={value:this._params.display,time:-1},void 0!==this._wakeup_cycle_new&&null!=this._wakeup_cycle_new&&(e.wakeup_cycle={value:this._wakeup_cycle_new,time:-1}),void 0!==this._display_new&&null!=this._display_new&&(e.display={value:this._display_new,time:-1}),void 0!==this._valve_new&&null!=this._valve_new&&(e.valve={value:this._valve_new,time:-1}),void 0!==this._setpoint_new&&null!=this._setpoint_new&&(e.setpoint={value:this._setpoint_new,time:-1}),void 0!==this._measurement_new&&null!=this._measurement_new&&(e.measurement={value:this._measurement_new,time:-1}),void 0!==this._button_lock_new&&null!=this._button_lock_new&&(e.button_lock={value:this._button_lock_new,time:-1}),e;},dt.prototype.getCurrentStates=function(){var e={},t=this.getStatesBuffer();for(var a in t)t.hasOwnProperty(a)&&t[a]&&(e[a]=t[a].value);return e;},dt.prototype.executeCommand=function(e,t,a){var r,n,s,o=new Date().getTime();if(t&&t.value){"setValve"==t.value.substr(0,8)&&t.value.length>8?(r=t.value.substr(8),t={value:"setValve",ext:r}):"setTo"==t.value.substr(0,5)&&t.value.length>5?(r=t.value.substr(5),t={value:"setTo",ext:r}):"tempTo"==t.value.substr(0,6)&&t.value.length>6?(r=t.value.substr(6),t={value:"setTo",ext:r}):"up"==t.value.substr(0,2)&&t.value.length>2?(r=t.value.substr(2),t={value:"up",ext:r}):"down"==t.value.substr(0,4)&&t.value.length>4?(r=t.value.substr(4),t={value:"down",ext:r}):"setWakeup"==t.value.substr(0,9)&&t.value.length>9?(r=t.value.substr(9),t={value:"setWakeup",ext:r}):"setDisplay"==t.value.substr(0,10)&&t.value.length>10&&(r=t.value.substr(10),t={value:"setDisplay",ext:r}),this._states;var i=[];switch(t.value){case"setValve":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("set valve value invalid")));(r=parseInt(t.ext))<0&&(r=0),r>100&&(r=100),this._valve_new=r,this._states.pending={value:!0,time:o},n={key:"valve",value:r,changed:!1},(s=this._states.valve?this._states.valve.value:null)!=r&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"setTo":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("set valve value invalid")));(r=parseFloat(t.ext))<10&&(r=10),r>30&&(r=30),this._setpoint_new=r,this._states.pending={value:!0,time:o},n={key:"setpoint",value:this._setpoint_new,changed:!1},(s=this._states.setpoint?this._states.setpoint.value:null)!=this._setpoint_new&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"up":if(r=t.ext,t.ext||(r=.5),r=parseFloat(r),void 0!==this._setpoint_new&&null!=this._setpoint_new)this._setpoint_new+=r;else{if(!this._states||!this._states.setpoint||void 0===this._states.setpoint.value||null==this._states.setpoint.value)return void(a&&a(new Error("not current setpoint value")));this._setpoint_new=this._states.setpoint.value+r;}this._setpoint_new<10&&(this._setpoint_new=10),this._setpoint_new>30&&(this._setpoint_new=30),this._states.pending={value:!0,time:o},n={key:"setpoint",value:this._setpoint_new,changed:!1},(s=this._states.setpoint?this._states.setpoint.value:null)!=this._setpoint_new&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"down":if(r=t.ext,t.ext||(r=.5),r=parseFloat(r),void 0!==this._setpoint_new&&null!=this._setpoint_new)this._setpoint_new-=r;else{if(!this._states||!this._states.setpoint||void 0===this._states.setpoint.value||null==this._states.setpoint.value)return void(a&&a(new Error("not current setpoint value")));this._setpoint_new=this._states.setpoint.value-r;}this._setpoint_new<10&&(this._setpoint_ne=10),this._setpoint_new>30&&(this._setpoint_new=30),this._states.pending={value:!0,time:o},n={key:"setpoint",value:this._setpoint_new,changed:!1},(s=this._states.setpoint?this._states.setpoint.value:null)!=this._setpoint_new&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"measureOn":this._measurement_new="active",this._states.pending={value:!0,time:o},n={key:"measurement",value:this._measurement_new,changed:!1},(s=this._states.measurement?this._states.measurement.value:null)!=this._measurement_new&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"measureOff":this._measurement_new="inactive",this._states.pending={value:!0,time:o},n={key:"measurement",value:this._measurement_new,changed:!1},(s=this._states.measurement?this._states.measurement.value:null)!=this._measurement_new&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"setWakeup":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("set wakup cycle value invalid")));r=parseInt(t.ext),this._wakeup_cycle_new=r,this._states.pending={value:!0,time:o},n={key:"wakeup_cycle",value:this._wakeup_cycle_new,changed:!1},(s=this._params.wakeup_cycle)!=this._wakeup_cycle_new&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"setDisplay":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("set display orientation value invalid")));r=parseInt(t.ext),this._display_new=r,this._states.pending={value:!0,time:o},n={key:"display",value:this._display_new,changed:!1},(s=this._params.display)!=this._display_new&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"buttonLock":this._button_lock_new="locked",this._states.pending={value:!0,time:o},n={key:"button_lock",value:this._button_lock_new,changed:!1},(s=this._states.button_lock?this._states.button_lock.value:null)!=this._button_lock_new&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"buttonUnlock":this._button_lock_new="unlocked",this._states.pending={value:!0,time:o},n={key:"button_lock",value:this._button_lock_new,changed:!1},(s=this._states.button_lock?this._states.button_lock.value:null)!=this._button_lock_new&&(n.oldvalue=s,n.changed=!0),i.push(n);break;case"openValve":this._service_command_new=1,this._states.pending={value:!0,time:o};break;case"closeValve":this._service_command_new=3,this._states.pending={value:!0,time:o};break;case"init":this._service_command_new=2,this._states.pending={value:!0,time:o};}i.length>0&&require("x.hub.m.enocean.js")._onEOEvents(this,i),a&&a();}else a&&a(new Error("command invalid"));},dt.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);if(r){var n=this;this._sendResponse(e,r,function(e,t){var r=n.checkStateChange(t);a&&a(null,r);});}else a&&a(new Error("data format invalid"));},dt.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.valve=o;var i=n,l=r,u=a>>7&1;t.measurement=u?"inactive":"active";var c=a>>2&1;t.button_lock=c?"locked":"unlocked";var h=a>>1&1,_=1&a;switch(t.temperature_selection=h?"setpoint":"feed_temperature",h){case 0:t.feed_temperature=parseFloat((i/255*60+20).toFixed(1));break;case 1:t.setpoint=parseFloat((i/255*20+10).toFixed(1));}if(0==_)t.error="no_error",t.temperature=parseFloat((l/255*20+10).toFixed(1));else switch(l){case 17:t.error="measurement_error";break;case 18:t.error="battery_empty";break;case 20:t.error="frost_protection";break;case 33:t.error="blocked_valve";break;case 36:t.error="end_point_detection_error";break;case 40:t.error="no_valve";break;case 49:t.error="not_taught_in";break;case 53:t.error="no_response_from_controller";break;case 54:t.error="teach_in_error";break;default:t.error="unknow_error";}}}return t;},dt.prototype._sendResponse=function(e,t,a){var r=new Date().getTime(),n=JSON.parse(JSON.stringify(t));this._states.pending={value:!1,time:r};var s,o,i,l=!1;void 0!==this._valve_new&&null!=this._valve_new?(s=this._valve_new,this._states.valve={value:this._valve_new,time:r},this._valve_new=null,delete n.valve):s=void 0!==t.valve&&null!=t.valve?t.valve:this._states.valve?this._states.valve.value:null,void 0!==s&&null!=s||(s=0,n.valve=0),void 0!==this._setpoint_new&&null!=this._setpoint_new?(o=Math.round((this._setpoint_new-10)/20*255),this._states.setpoint={value:this._setpoint_new,time:r},this._setpoint_new=null,delete n.setpoint):void 0!==t.setpoint&&null!=t.setpoint?o=Math.round((t.setpoint-10)/20*255):this._states.setpoint&&"undefined"!=this._states.setpoint.value&&null!=this._states.setpoint.value&&(o=Math.round((this._states.setpoint.value-10)/20*255)),void 0!==o&&null!=o||(o=this._defaultSetpoint,o=Math.round((o-10)/20*255),n.setpoint=this._defaultSetpoint),void 0!==this._measurement_new&&null!=this._measurement_new?(i="active"==this._measurement_new?0:1,this._states.measurement={value:this._measurement_new,time:r},this._measurement_new=null,delete n.measurement):void 0!==t.measurement&&null!=t.measurement?i="active"==t.measurement?0:1:this._states.measurement&&"undefined"!=this._states.measurement.value&&null!=this._states.measurement.value&&(i="active"==this._states.measurement.value?0:1),void 0!==i&&null!=i||(i=0,n.measurement="active");var u=this._params.wakeup_cycle;void 0!==this._wakeup_cycle_new&&null!=this._wakeup_cycle_new&&(u=this._wakeup_cycle_new,this._params.wakeup_cycle=this._wakeup_cycle_new,l=!0,this._wakeup_cycle_new=null),void 0!==u&&null!=u||(u=this._defaultWakeupCycle,this._params.wakeup_cycle=u);var c,h=this._params.display;void 0!==this._display_new&&null!=this._display_new&&(h=this._display_new,this._params.display=this._display_new,l=!0,this._display_new=null),void 0!==h&&null!=h||(h=this._defaultDisplay,this._params.display=h),void 0!==this._button_lock_new&&null!=this._button_lock_new?(c="locked"==this._button_lock_new?1:0,this._states.button_lock={value:this._button_lock_new,time:r},this._button_lock_new=null,delete n.button_lock):void 0!==t.button_lock&&null!=t.button_lock?c="locked"==t.button_lock?1:0:this._states.button_lock&&this._states.button_lock.value&&(c="locked"==this._states.button_lock.value?1:0),void 0!==c&&null!=c||(c=0,n.button_lock="unlocked");var _=0;void 0!==this._service_command_new&&null!=this._service_command_new&&(_=this._service_command_new,this._service_command_new=null);var p=new Buffer([s,o,(1&i)<<6|63&u,(3&h)<<4|8|(1&c)<<2|3&_]);l&&require("x.hub.m.enocean.js")._deviceHandler.deviceParamsUpdated();var d=this._senderID;d||(d=x.hub.m.enocean.SENDER_ID);var v=new x.hub.m.enocean.ESP3.Telegram.ADT(165,p,this._address,d,0);e.sendTelegram(v,!0,function(e){a&&a(e,n);});};var vt=function vt(e){S.call(this,e),this._data="a5-30-??";};(vt.prototype=new S()).constructor=vt;var ft=function ft(t){e.call(this,t),this._data="a5-30-01";};ft.STATES=["battery_low","battery_raw","state","state_raw"],(ft.prototype=new vt()).constructor=ft,ft.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(1==(a>>3&1)){var s=n;t.battery_low=s<=120,t.battery_raw=s;var o=r;t.state=o<=195?"closed":"open",t.state_raw=o;}}return t;};var mt=function mt(t){e.call(this,t),this._data="a5-30-01";};mt.STATES=["state"],(mt.prototype=new vt()).constructor=mt,mt.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3);if(1==(a>>3&1)){var r=1&a;t.state=r?"open":"closed";}}return t;};var gt=function gt(t){e.call(this,t),this._data="a5-30-03";};gt.STATES=["temperature","temperature_raw","wake","input3","input2","input1","input0"],(gt.prototype=new vt()).constructor=gt,gt.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(1==(a>>3&1)){var s=n;t.temperature=(255-s)/255*40,t.temperature_raw=s;var o=r>>4&1;t.wake=o;var i=r>>3&1;t.input3=i;var l=r>>2&1;t.input2=l;var u=r>>1&1;t.input1=u;var c=1&r;t.input0=c;}}return t;};var wt=function wt(t){e.call(this,t),this._data="a5-30-04";};wt.STATES=["analog_input","input2","input1","input0"],(wt.prototype=new vt()).constructor=wt,wt.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2);if(1==(a>>3&1)){var n=r;t.analog_input=n;var s=a>>2&1;t.input2=s;var o=a>>1&1;t.input1=o;var i=1&a;t.input0=i;}}return t;};var yt=function yt(e){S.call(this,e),this._data="a5-38-??";};(yt.prototype=new S()).constructor=yt;var St=function St(e){yt.call(this,e),this._data="a5-38-08";};(St.prototype=new yt()).constructor=St,St.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)&&2===s){var o=n;t.level=Math.round(o/255*100);var i=r;t.ramp=i;var l=a>>2&1;t.dim_range=l?"relative":"absolute";var u=a>>1&1;t.store_final_value=u;var c=1&a;t.state=c?"on":"off";}}return t;},St.prototype.switching=function(e,t,a){var r=this._senderID;this._senderID||(r=x.hub.m.enocean.SENDER_ID);var n=t.TIM>>8&255,s=255&t.TIM,o=8|(1&t.LCK)<<2|(1&t.DEL)<<1|1&t.SW,i=new Buffer([1,n,s,o]),l=new x.hub.m.enocean.ESP3.Telegram.BS4(i,r,0);l.setDstId(this._address),e.sendTelegram(l,!0,function(e){a&&a(e);});},St.prototype.dimming=function(e,t,a){var r=this._senderID;this._senderID||(r=x.hub.m.enocean.SENDER_ID);var n=t.EDIM,s=t.RMP,o=8|(1&t.EDIMR)<<2|(1&t.STR)<<1|1&t.SW,i=new Buffer([2,n,s,o]),l=new x.hub.m.enocean.ESP3.Telegram.BS4(i,r,0);l.setDstId(this._address),e.sendTelegram(l,!0,function(e){a&&a(e);});},St.prototype.blind=function(e,t,a){var r=this._senderID;if(this._senderID||(r=x.hub.m.enocean.SENDER_ID),r){var n=t.P1,s=t.P2,o=(15&t.FUNC)<<4|8|(1&t.SSF)<<2|(1&t.PAF)<<1|1&t.SMF,i=new Buffer([7,n,s,o]),l=new x.hub.m.enocean.ESP3.Telegram.BS4(i,r,0);l.setDstId(this._address),e.sendTelegram(l,!0,function(e){a&&a(e);});}else a&&a(new Error("no senderID"));};var bt=function bt(e){S.call(this,e),this._data="a5-3F-7F";};(bt.prototype=new S()).constructor=bt;var Tt=function Tt(t){e.call(this,t),this._data="d2-??-??",this.UNIQUE_GATEWAY_SENDERID=!0;};(Tt.prototype=new e()).constructor=Tt;var It=function It(e){Tt.call(this,e),this._data="d2-01-??",this._lastQuery={},this._initCount=0;};It.STATES=["power_failure_detection","power_failure","over_current_switch_off","error_level","io_channel","local_control","output_value","output_state"],(It.prototype=new Tt()).constructor=It,It.prototype.init=function(e){var t=this.getIOs();if(t.length>0){var a=require("x.hub.m.enocean.js")._esp3,r=0,n=this,s=function s(){++r<t.length?n.statusQuery(a,{IO:t[r]},s):e&&e();};this.statusQuery(a,{IO:t[r]},s);}else e&&e();},It.prototype.getStatesBuffer=function(){return 0==Object.keys(this._states).length?(this._initCount<=100&&this._initCount%10==0||this._initCount>=100&&this._initCount<=600&&this._initCount%60==0?this.init():this._initCount=0,this._initCount++):this._initCount=0,this._states;},It.prototype.getIOs=function(){return[];},It.prototype.setOutput=function(e,t,a){var r=this._senderID;this._senderID||(r=x.hub.m.enocean.SENDER_ID);var n=(7&t.DV)<<5|31&t.IO,s=127&t.OV,o=new Buffer([1,n,s]),i=new x.hub.m.enocean.ESP3.Telegram.VLD(o,r,0);this._senderID!=this._address&&i.setDstId(this._address),e.sendTelegram(i,!0,function(e){a&&a(e);});},It.prototype.setLocal=function(e,t,a){var r=(1&t.DE)<<7|2,n=(1&t.OC)<<7|(1&t.RO)<<6|(1&t.LC)<<5|31&t.IO,s=(15&t.DT2)<<4|15&t.DT3,o=(1&t.DN)<<7|(1&t.PF)<<6|(3&t.DS)<<4|15&t.DT1,i=new Buffer([r,n,s,o]),l=new x.hub.m.enocean.ESP3.Telegram.VLD(i,x.hub.m.enocean.SENDER_ID,0);l.setDstId(this._address),e.sendTelegram(l,!0,function(e){a&&a(e);});},It.prototype.statusQuery=function(e,t,a){if(this._senderID){this._lastQuery[t.IO]=new Date().getTime();var r=31&t.IO,n=new Buffer([3,r]),s=new x.hub.m.enocean.ESP3.Telegram.VLD(n,this._senderID,0);s.setDstId(this._address),e.sendTelegram(s,!0,function(e){a&&a(e);});}else a&&a(new Error("no senderID"));},It.prototype.measurementQuery=function(e,t,a){var r=(1&t.QU)<<5|31&t.IO,n=new Buffer([6,r]),s=new x.hub.m.enocean.ESP3.Telegram.VLD(n,this._senderID,0);s.setDstId(this._address),e.sendTelegram(s,!0,function(e){a&&a(e);});},It.prototype.evalTelegram=function(e){var t={};if(210==e.rorg){var a,r=e.userData.readUInt8(0);switch(15&r){case 4:if(3==e.userData.length){var n=(a=r)>>7&1,s=a>>6&1,o=(a=e.userData.readUInt8(1))>>7&1,i=a>>5&3,l=31&a,u=(a=e.userData.readUInt8(2))>>7&1,c=127&a;t.power_failure_detection=!!n,t.power_failure=!!s,t.over_current_switch_off=o,t.error_level=i,t.io_channel=l,t.local_control=!!u,t.output_value=c,t.output_state=c?"on":"off";}break;case 7:if(6==e.userData.length){var h=(a=e.userData.readUInt8(1))>>5&7,_=(l=31&a,a=e.userData.readUInt32BE(2));switch(h){case 0:t.unit="Ws";break;case 1:t.unit="Wh";break;case 2:t.unit="KWh";break;case 3:t.unit="W";break;case 4:t.unit="KW";}t.io_channel=l,t.value=_;}}}return t;};var Dt=function Dt(e){It.call(this,e),this._data="d2-01-00";};Dt.COMMANDS=["on","off","toggle"],Dt.STATES=["power_failure_detection","power_failure","over_current_switch_off","error_level","io_channel","local_control","output_value","output_state"],(Dt.prototype=new It()).constructor=Dt,Dt.prototype.getIOs=function(){return[0];},Dt.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r=this;switch(t.value){case"on":this.activeStateChange({output_value:100,output_state:"on"}),this.setOutput(e,{DV:0,IO:0,OV:100},a);break;case"off":this.activeStateChange({output_value:0,output_state:"off"}),this.setOutput(e,{DV:0,IO:0,OV:0},a);break;case"toggle":if(!this._states.output_state)return void this.init(function(){setTimeout(function(){r._states.output_state?r.executeCommand(e,t,a):a&&a(new Error("unkown current status"));},200);});var n="on"==this._states.output_state.value?"off":"on";this.executeCommand(e,{value:n},a);}}else a&&a(new Error("command invalid"));};var Et=function Et(e){Dt.call(this,e),this._data="d2-01-01";};Et.COMMANDS=["on","off","toggle"],Et.STATES=["power_failure_detection","power_failure","over_current_switch_off","error_level","io_channel","local_control","output_value","output_state"],(Et.prototype=new Dt()).constructor=Et;var kt=function kt(e){Dt.call(this,e),this._data="d2-01-03",this._lastOnLevel=-1;};(kt.prototype=new Dt()).constructor=kt,kt.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);if(r){0!=r.output_value&&"off"!=r.output_state||this._states.output_value&&this._states.output_value.value&&(this._lastOnLevel=this._states.output_value.value);var n=this.checkStateChange(r);a&&a(null,n);}else a&&a(new Error("data format invalid"));},kt.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r;"dimTo"==t.value.substr(0,5)&&t.value.length>5?(r=t.value.substr(5),t={value:"dimTo",ext:r}):"toggleTo"==t.value.substr(0,8)&&t.value.length>8&&(r=t.value.substr(8),t={value:"toggleTo",ext:r}),new Date().getTime();var n=this;switch(t.value){case"on":-1!=(r=this._lastOnLevel)&&0!=r||(r=100),this.setOutput(e,{DV:0,IO:0,OV:r},function(e){e||n.activeStateChange({output_value:r,output_state:"on"}),a&&a(e);});break;case"off":this._states.output_value&&this._states.output_value.value&&(this._lastOnLevel=this._states.output_value.value),this.setOutput(e,{DV:0,IO:0,OV:0},function(e){e||n.activeStateChange({output_value:0,output_state:"off"}),a&&a(e);});break;case"toggle":if(!this._states.output_state)return void this.init(function(){setTimeout(function(){n._states.output_state?n.executeCommand(e,t,a):a&&a(new Error("unkown current status"));},200);});var s="on"==this._states.output_state.value?"off":"on";this.executeCommand(e,{value:s},a);break;case"toggleTo":if(!this._states.output_state)return void this.init(function(){setTimeout(function(){n._states.output_state?n.executeCommand(e,t,a):a&&a(new Error("unkown current status"));},200);});"on"==this._states.output_state.value?this.executeCommand(e,{value:"off"},a):this.executeCommand(e,{value:"dimTo",ext:t.ext},a);break;case"dimTo":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("dim to value invalid")));(r=parseFloat(t.ext))<0&&(r=0),r>100&&(r=100),this.setOutput(e,{DV:0,IO:0,OV:r},function(e){e||n.activeStateChange({output_value:r,output_state:0==r?"off":"on"}),a&&a(e);});break;case"dimUp":if(!this._states.output_state)return void this.init(function(){setTimeout(function(){n._states.output_state?n.executeCommand(e,t,a):a&&a(new Error("unkown current status"));},200);});r=parseInt(this._states.output_value.value),(r+=5)>100&&(r=100),this.executeCommand(e,{value:"dimTo",ext:r},a);break;case"dimDown":if(!this._states.output_state)return void this.init(function(){setTimeout(function(){n._states.output_state?n.executeCommand(e,t,a):a&&a(new Error("unkown current status"));},200);});r=parseInt(this._states.output_value.value),(r-=5)<0&&(r=0),this.executeCommand(e,{value:"dimTo",ext:r},a);break;default:a&&a(new Error("unknow command"));}}else a&&a(new Error("command invalid"));};var xt=function xt(e){It.call(this,e),this._data="d2-01-11";};xt.COMMANDS=["ch1On","ch1Off","ch1Toggle","ch2On","ch2Off","ch2Toggle"],xt.STATES=["power_failure_detection","power_failure","over_current_switch_off","error_level","io_channel","local_control","output_value","output_state","ch1_output_value","ch1_output_state","ch2_output_value","ch2_output_state"],(xt.prototype=new It()).constructor=xt,xt.prototype.getIOs=function(){return[0,1];},xt.prototype.evalTelegram=function(e){var t=It.prototype.evalTelegram.call(this,e);if(t)switch(t.io_channel){case 0:t.ch1_output_value=t.output_value,t.ch1_output_state=t.output_state;break;case 1:t.ch2_output_value=t.output_value,t.ch2_output_state=t.output_state;}return t;},xt.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r,n=this;switch(t.value){case"ch1On":this.activeStateChange({ch1_output_value:100,ch1_output_state:"on"}),this.setOutput(e,{DV:0,IO:0,OV:100},a);break;case"ch1Off":this.activeStateChange({ch1_output_value:0,ch1_output_state:"off"}),this.setOutput(e,{DV:0,IO:0,OV:0},a);break;case"ch1Toggle":if(!this._states.output_state)return void this.init(function(){setTimeout(function(){n._states.output_state?n.executeCommand(e,t,a):a&&a(new Error("unkown current status"));},200);});r="on"==this._states.ch1_output_state.value?"off":"on",this.activeStateChange({ch1_output_value:"on"==r?100:0,ch1_output_state:r}),this.executeCommand(e,{value:"on"==r?"ch1On":"ch1Off"},a);break;case"ch2On":this.activeStateChange({ch2_output_value:100,ch2_output_state:"on"}),this.setOutput(e,{DV:0,IO:1,OV:100},a);break;case"ch2Off":this.activeStateChange({ch2_output_value:0,ch2_output_state:"off"}),this.setOutput(e,{DV:0,IO:1,OV:0},a);break;case"ch2Toggle":if(!this._states.output_state)return void this.init(function(){setTimeout(function(){n._states.output_state?n.executeCommand(e,t,a):a&&a(new Error("unkown current status"));},200);});r="on"==this._states.ch2_output_state.value?"off":"on",this.activeStateChange({ch2_output_value:"on"==r?100:0,ch2_output_state:r}),this.executeCommand(e,{value:"on"==r?"ch2On":"ch2Off"},a);break;default:a&&a(new Error("unknown command"));}}else a&&a(new Error("command invalid"));};var At=function At(e){It.call(this,e),this._data="d2-01-13",this._queryInterval=3e4;};At.COMMANDS=["ch1On","ch1Off","ch1Toggle","ch2On","ch2Off","ch2Toggle","ch3On","ch3Off","ch3Toggle","ch4On","ch4Off","ch4Toggle"],At.STATES=["power_failure_detection","power_failure","over_current_switch_off","error_level","io_channel","local_control","output_value","output_state","ch1_output_value","ch1_output_state","ch2_output_value","ch2_output_state","ch3_output_value","ch3_output_state","ch4_output_value","ch4_output_state"],(At.prototype=new It()).constructor=At,At.prototype.getStatesBuffer=function(){var e=[];return this._states.ch1_output_state||(!this._lastQuery[0]||now-this._lastQuery[0]>this._queryInterval)&&e.push(0),this._states.ch2_output_state||(!this._lastQuery[1]||now-this._lastQuery[1]>this._queryInterval)&&e.push(1),this._states.ch3_output_state||(!this._lastQuery[2]||now-this._lastQuery[2]>this._queryInterval)&&e.push(2),this._states.ch4_output_state||(!this._lastQuery[3]||now-this._lastQuery[3]>this._queryInterval)&&e.push(3),e.length>0&&this._queryStates(e),this._states;},At.prototype._queryStates=function(e,t){var a=require("x.hub.m.enocean.js")._esp3,r=0,n=this,s=function s(){++r<e.length?n.statusQuery(a,{IO:e[r]},s):t&&t();};this.statusQuery(a,{IO:e[r]},s);},At.prototype.getIOs=function(){return[0,1,2,3];},At.prototype.evalTelegram=function(e){var t=It.prototype.evalTelegram.call(this,e);if(t)switch(t.io_channel){case 0:t.ch1_output_value=t.output_value,t.ch1_output_state=t.output_state;break;case 1:t.ch2_output_value=t.output_value,t.ch2_output_state=t.output_state;break;case 2:t.ch3_output_value=t.output_value,t.ch3_output_state=t.output_state;break;case 3:t.ch4_output_value=t.output_value,t.ch4_output_state=t.output_state;}return t;},At.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r,n,s,o,i,l,u=this;switch(t.value?t.value.substr(0,3):null){case"ch1":n=0,s="ch1_output_value",o="ch1_output_state";break;case"ch2":n=1,s="ch2_output_value",o="ch2_output_state";break;case"ch3":n=2,s="ch3_output_value",o="ch3_output_state";break;case"ch4":n=3,s="ch4_output_value",o="ch4_output_state";}switch(t.value){case"ch1On":case"ch2On":case"ch3On":case"ch4On":(l={})[s]=100,l[o]="on",i={DV:0,IO:n,OV:100},this.activeStateChange(l),this.setOutput(e,i,a);break;case"ch1Off":case"ch2Off":case"ch3Off":case"ch4Off":(l={})[s]=0,l[o]="off",i={DV:0,IO:n,OV:0},this.activeStateChange(l),this.setOutput(e,i,a);break;case"ch1Toggle":case"ch2Toggle":case"ch3Toggle":case"ch4Toggle":if(!this._states.output_state)return void this.init(function(){setTimeout(function(){u._states.output_state?u.executeCommand(e,t,a):a&&a(new Error("unkown current status"));},200);});if(!this._states[o])return void(a&&a(new Error("state unknown")));r="on"==this._states[o].value?"off":"on",(l={})[s]="on"==r?100:0,l[o]=r,i={DV:0,IO:n,OV:"on"==r?100:0},this.activeStateChange(l),this.setOutput(e,i,a);break;default:a&&a(new Error("unknown command"));}}else a&&a(new Error("command invalid"));};var Ot=function Ot(e){It.call(this,e),this._data="d2-01-14",this._queryInterval=3e4;};Ot.COMMANDS=["ch1On","ch1Off","ch1Toggle","ch2On","ch2Off","ch2Toggle","ch3On","ch3Off","ch3Toggle","ch4On","ch4Off","ch4Toggle","ch5On","ch5Off","ch5Toggle","ch6On","ch6Off","ch6Toggle","ch7On","ch7Off","ch7Toggle","ch8On","ch8Off","ch8Toggle"],Ot.STATES=["power_failure_detection","power_failure","over_current_switch_off","error_level","io_channel","local_control","output_value","output_state","ch1_output_value","ch1_output_state","ch2_output_value","ch2_output_state","ch3_output_value","ch3_output_state","ch4_output_value","ch4_output_state","ch5_output_value","ch5_output_state","ch6_output_value","ch6_output_state","ch7_output_value","ch7_output_state","ch8_output_value","ch8_output_state"],(Ot.prototype=new It()).constructor=Ot,Ot.prototype._queryStates=function(e,t){var a=require("x.hub.m.enocean.js")._esp3,r=0,n=this,s=function s(){++r<e.length?n.statusQuery(a,{IO:e[r]},s):t&&t();};this.statusQuery(a,{IO:e[r]},s);},Ot.prototype.getStatesBuffer=function(){var e=new Date().getTime(),t=[];return this._states.ch1_output_state||(!this._lastQuery[0]||e-this._lastQuery[0]>this._queryInterval)&&t.push(0),this._states.ch2_output_state||(!this._lastQuery[1]||e-this._lastQuery[1]>this._queryInterval)&&t.push(1),this._states.ch3_output_state||(!this._lastQuery[2]||e-this._lastQuery[2]>this._queryInterval)&&t.push(2),this._states.ch4_output_state||(!this._lastQuery[3]||e-this._lastQuery[3]>this._queryInterval)&&t.push(3),this._states.ch5_output_state||(!this._lastQuery[4]||e-this._lastQuery[4]>this._queryInterval)&&t.push(4),this._states.ch6_output_state||(!this._lastQuery[5]||e-this._lastQuery[5]>this._queryInterval)&&t.push(5),this._states.ch7_output_state||(!this._lastQuery[6]||e-this._lastQuery[6]>this._queryInterval)&&t.push(6),this._states.ch8_output_state||(!this._lastQuery[7]||e-this._lastQuery[7]>this._queryInterval)&&t.push(7),t.length>0&&this._queryStates(t),this._states;},Ot.prototype.getIOs=function(){return[0,1,2,3,4,5,6,7];},Ot.prototype.evalTelegram=function(e){var t=It.prototype.evalTelegram.call(this,e);if(t)switch(t.io_channel){case 0:t.ch1_output_value=t.output_value,t.ch1_output_state=t.output_state;break;case 1:t.ch2_output_value=t.output_value,t.ch2_output_state=t.output_state;break;case 2:t.ch3_output_value=t.output_value,t.ch3_output_state=t.output_state;break;case 3:t.ch4_output_value=t.output_value,t.ch4_output_state=t.output_state;break;case 4:t.ch5_output_value=t.output_value,t.ch5_output_state=t.output_state;break;case 5:t.ch6_output_value=t.output_value,t.ch6_output_state=t.output_state;break;case 6:t.ch7_output_value=t.output_value,t.ch7_output_state=t.output_state;break;case 7:t.ch8_output_value=t.output_value,t.ch8_output_state=t.output_state;}return t;},Ot.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r,n,s,o,i,l,u=this;switch(t.value?t.value.substr(0,3):null){case"ch1":n=0,s="ch1_output_value",o="ch1_output_state";break;case"ch2":n=1,s="ch2_output_value",o="ch2_output_state";break;case"ch3":n=2,s="ch3_output_value",o="ch3_output_state";break;case"ch4":n=3,s="ch4_output_value",o="ch4_output_state";break;case"ch5":n=4,s="ch5_output_value",o="ch5_output_state";break;case"ch6":n=5,s="ch6_output_value",o="ch6_output_state";break;case"ch7":n=6,s="ch7_output_value",o="ch7_output_state";break;case"ch8":n=7,s="ch8_output_value",o="ch8_output_state";}switch(t.value){case"ch1On":case"ch2On":case"ch3On":case"ch4On":case"ch5On":case"ch6On":case"ch7On":case"ch8On":(l={})[s]=100,l[o]="on",i={DV:0,IO:n,OV:100},this.activeStateChange(l),this.setOutput(e,i,a);break;case"ch1Off":case"ch2Off":case"ch3Off":case"ch4Off":case"ch5Off":case"ch6Off":case"ch7Off":case"ch8Off":(l={})[s]=0,l[o]="off",i={DV:0,IO:n,OV:0},this.activeStateChange(l),this.setOutput(e,i,a);break;case"ch1Toggle":case"ch2Toggle":case"ch3Toggle":case"ch4Toggle":case"ch5Toggle":case"ch6Toggle":case"ch7Toggle":case"ch8Toggle":if(!this._states.output_state)return void this.init(function(){setTimeout(function(){u._states.output_state?u.executeCommand(e,t,a):a&&a(new Error("unkown current status"));},200);});if(!this._states[o])return void(a&&a(new Error("state unknown")));r="on"==this._states[o].value?"off":"on",(l={})[s]="on"==r?100:0,l[o]=r,i={DV:0,IO:n,OV:"on"==r?100:0},this.activeStateChange(l),this.setOutput(e,i,a);break;default:a&&a(new Error("unknown command"));}}else a&&a(new Error("command invalid"));};var Ct=function Ct(e){Tt.call(this,e),this._data="d2-05-??";};(Ct.prototype=new Tt()).constructor=Ct;var Pt=function Pt(e){Ct.call(this,e),this._data="d2-05-00";};Pt.COMMANDS=["moveUp","moveDown","moveTo","stepUp","stepDown","lamellaUp","lamellaDown","lamellaTo","stop","setRunTime","setRotationTime","setParams[15.2s]:[10,20,30ms]:[0-3]"],Pt.STATES=["state","angle","lock","channel"],(Pt.prototype=new Ct()).constructor=Pt,Pt.prototype.init=function(e){var t=require("x.hub.m.enocean.js")._esp3;this.query(t,{CHN:0},e);},Pt.prototype.getStatesBuffer=function(){return 0==Object.keys(this._states).length&&this.init(),this._states;},Pt.prototype.goToPositionAngle=function(e,t,a){var r=this._senderID;this._senderID||(r=x.hub.m.enocean.SENDER_ID);var n=127&t.POS,s=127&t.ANG,o=(7&t.REPO)<<4|7&t.LOCK,i=(15&t.CHN)<<4|1,l=new Buffer([n,s,o,i]),u=new x.hub.m.enocean.ESP3.Telegram.VLD(l,r,0);u.setDstId(this._address),e.sendTelegram(u,!0,function(e){a&&a(e);});},Pt.prototype.stop=function(e,t,a){var r=this._senderID;this._senderID||(r=x.hub.m.enocean.SENDER_ID);var n=(15&t.CHN)<<4|2,s=new Buffer([n]),o=new x.hub.m.enocean.ESP3.Telegram.VLD(s,r,0);o.setDstId(this._address),e.sendTelegram(o,!0,function(e){a&&a(e);});},Pt.prototype.query=function(e,t,a){var r=this._senderID;this._senderID||(r=x.hub.m.enocean.SENDER_ID);var n=(15&t.CHN)<<4|3,s=new Buffer([n]),o=new x.hub.m.enocean.ESP3.Telegram.VLD(s,r,0);o.setDstId(this._address),e.sendTelegram(o,!0,function(e){a&&a(e);});},Pt.prototype.setParameters=function(e,t,a){var r=this._senderID;this._senderID||(r=x.hub.m.enocean.SENDER_ID);var n=t.VERT>>8&127,s=255&t.VERT,o=255&t.ROT,i=7&t.AA,l=(15&t.CHN)<<4|5,u=new Buffer([n,s,o,i,l]),c=new x.hub.m.enocean.ESP3.Telegram.VLD(u,r,0);c.setDstId(this._address),e.sendTelegram(c,!0,function(e){a&&a(e);});},Pt.prototype.evalTelegram=function(e){var t={};if(210==e.rorg){var a=e.userData.length;if(4==(15&e.userData.readUInt8(a-1))&&4==e.userData.length){var r=127&e.userData.readUInt8(0);t.state=r;var n=127&e.userData.readUInt8(1);switch(t.angle=n,7&e.userData.readUInt8(2)){case 0:t.lock="normal";break;case 1:t.lock="blockage_mode";break;case 2:t.lock="alarm_mode";}var s=e.userData.readUInt8(3)>>4&15;t.channel=s;}}return t;},Pt.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r;"moveTo"==t.value.substr(0,6)&&t.value.length>6?(r=t.value.substr(6),t={value:"moveTo",ext:r}):"lamellaTo"==t.value.substr(0,9)&&t.value.length>9?(r=t.value.substr(9),t={value:"lamellaTo",ext:r}):"setRunTime"==t.value.substr(0,10)&&t.value.length>10?(r=t.value.substr(10),t={value:"setRunTime",ext:r}):"setRotationTime"==t.value.substr(0,15)&&t.value.length>15?(r=t.value.substr(15),t={value:"setRotationTime",ext:r}):"setParams"==t.value.substr(0,9)&&t.value.length>9&&(r=t.value.substr(9),t={value:"setParams",ext:r});var n=new Date().getTime(),s=this;switch(t.value){case"moveUp":this.goToPositionAngle(e,{POS:0,ANG:0,REPO:0,LOCK:0,CHN:0},a);break;case"moveDown":this.goToPositionAngle(e,{POS:100,ANG:100,REPO:0,LOCK:0,CHN:0},a);break;case"moveTo":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("move to value invalid")));(r=parseFloat(t.ext))<0&&(r=0),r>100&&(r=100),this._states.state={value:r,time:n},this.goToPositionAngle(e,{POS:r,ANG:255,REPO:0,LOCK:0,CHN:0},a);break;case"stepUp":if(!this._states.state)return void this.init(function(){setTimeout(function(){s._states.state?s.executeCommand(e,t,a):a&&a(new Error("get device status failed"));},200);});if(255==this._states.state.value||255==this._states.angle.value)return void(a&&a(new Error("device status unknonw")));0!=this._states.angle.value?((r=this._states.angle.value-10)<0&&(r=0),this._states.angle={value:r,time:n},this.goToPositionAngle(e,{POS:255,ANG:r,REPO:0,LOCK:0,CHN:0},a)):((r=this._states.state.value-5)<0&&(r=0),this._states.state={value:r,time:n},this.goToPositionAngle(e,{POS:r,ANG:0,REPO:0,LOCK:0,CHN:0},a));break;case"stepDown":if(!this._states.state)return void this.init(function(){setTimeout(function(){s._states.state?s.executeCommand(e,t,a):a&&a(new Error("get device status failed"));},200);});if(255==this._states.state.value||255==this._states.angle.value)return void(a&&a(new Error("device status unknonw")));100!=this._states.angle.value?((r=this._states.angle.value+10)>100&&(r=100),this._states.angle={value:r,time:n},this.goToPositionAngle(e,{POS:255,ANG:r,REPO:0,LOCK:0,CHN:0},a)):((r=this._states.state.value+5)>100&&(r=100),this._states.state={value:r,time:n},this.goToPositionAngle(e,{POS:r,ANG:100,REPO:0,LOCK:0,CHN:0},a));break;case"lamellaUp":this.goToPositionAngle(e,{POS:255,ANG:0,REPO:0,LOCK:0,CHN:0},a);break;case"lamellaDown":this.goToPositionAngle(e,{POS:255,ANG:100,REPO:0,LOCK:0,CHN:0},a);break;case"lamellaTo":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("lamella to value invalid")));(r=parseFloat(t.ext))<0&&(r=0),r>100&&(r=100),this._states.angle={value:r,time:n},this.goToPositionAngle(e,{POS:255,ANG:r,REPO:0,LOCK:0,CHN:0},a);break;case"stop":this.stop(e,{CHN:0},a);break;case"setRunTime":if(!t.ext)return void(a&&a(new Error("parameters is null")));(i=100*parseFloat(t.ext))<=499&&(i=500),l=255,u=7,this.setParameters(e,{VERT:i,ROT:l,AA:u,CHN:0},a);break;case"setRotationTime":if(!t.ext)return void(a&&a(new Error("parameters is null")));i=32767,l=parseInt(t.ext)/10,u=7,this.setParameters(e,{VERT:i,ROT:l,AA:u,CHN:0},a);break;case"setParams":if(!t.ext)return void(a&&a(new Error("parameters is null")));var o=t.ext.split(":");if(3!=o.length)return void(a&&a(new Error("parameters format invalid")));var i=o[0]?100*parseFloat(o[0]):32767;i<=499&&(i=32767);var l=o[1]?parseInt(o[1])/10:255,u=o[2]?parseInt(o[2]):7;this.setParameters(e,{VERT:i,ROT:l,AA:u,CHN:0},a);break;default:a&&a(new Error("unknow command"));}}else a&&a(new Error("command invalid"));};var Rt=function Rt(e){Pt.call(this,e),this._data="d2-05-01",this._ch1QueryCount=0,this._ch1QueryTO=null,this._ch1QueryTimestamp=0;};Rt.COMMANDS=["ch1moveUp","ch1moveDown","ch1moveTo","ch1stepUp","ch1stepDown","ch1lamellaUp","ch1lamellaDown","ch1lamellaTo","ch1stop","ch2moveUp","ch2moveDown","ch2moveTo","ch2stepUp","ch2stepDown","ch2lamellaUp","ch2lamellaDown","ch2lamellaTo","ch2stop","ch3moveUp","ch3moveDown","ch3moveTo","ch3stepUp","ch3stepDown","ch3lamellaUp","ch3lamellaDown","ch3lamellaTo","ch3stop","ch4moveUp","ch4moveDown","ch4moveTo","ch4stepUp","ch4stepDown","ch4lamellaUp","ch4lamellaDown","ch4lamellaTo","ch4stop","ch1setRunTime","ch2setRunTime","ch3setRunTime","ch4setRunTime","ch1setRotationTime","ch2setRotationTime","ch3setRotationTime","ch4setRotationTime","ch1setParams[15.2s]:[10,20,30ms]:[0-3]","ch2setParams","ch3setParams","ch4setParams"],Rt.STATES=["ch1state","ch1angle","ch1lock","ch2state","ch2angle","ch2lock","ch3state","ch3angle","ch3lock","ch4state","ch4angle","ch4lock","channel"],(Rt.prototype=new Pt()).constructor=Rt,Rt.prototype.init=function(e){this._queryStates([0,1,2,3],e);},Rt.prototype.getStatesBuffer=function(){var e=[];return this._states.ch1state||e.push(0),this._states.ch2state||e.push(1),this._states.ch3state||e.push(2),this._states.ch4state||e.push(3),e.length>0&&this._queryStates(e),this._states;},Rt.prototype._queryStates=function(e,t){var a=require("x.hub.m.enocean.js")._esp3,r=0,n=this,s=function s(){++r<e.length?n.query(a,{CHN:e[r]},s):t&&t();};this.query(a,{CHN:e[r]},s);},Rt.prototype.evalTelegram=function(e){var t=Pt.prototype.evalTelegram.call(this,e);if(t)switch(t.channel){case 0:t.ch1state=t.state,t.ch1angle=t.angle,t.ch1lock=t.lock;break;case 1:t.ch2state=t.state,t.ch2angle=t.angle,t.ch2lock=t.lock;break;case 2:t.ch3state=t.state,t.ch3angle=t.angle,t.ch3lock=t.lock;break;case 3:t.ch4state=t.state,t.ch4angle=t.angle,t.ch4lock=t.lock;}return t;},Rt.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r,n,s,o,i=null;switch((t=JSON.parse(JSON.stringify(t))).value.substr(0,3)){case"ch1":i=0,r="ch1state",n="ch1angle";break;case"ch2":i=1,r="ch2state",n="ch2angle";break;case"ch3":i=2,r="ch3state",n="ch3angle";break;case"ch4":i=3,r="ch4state",n="ch4angle";break;default:a&&a(new Error("unknown command"));}t.value=t.value.substr(3),"moveTo"==t.value.substr(0,6)&&t.value.length>6?(o=t.value.substr(6),t={value:"moveTo",ext:o}):"lamellaTo"==t.value.substr(0,9)&&t.value.length>9?(o=t.value.substr(9),t={value:"lamellaTo",ext:o}):"setRunTime"==t.value.substr(0,10)&&t.value.length>10?(o=t.value.substr(10),t={value:"setRunTime",ext:o}):"setRotationTime"==t.value.substr(0,15)&&t.value.length>15?(o=t.value.substr(15),t={value:"setRotationTime",ext:o}):"setParams"==t.value.substr(0,9)&&t.value.length>9&&(o=t.value.substr(9),t={value:"setParams",ext:o}),new Date().getTime();var l=this;switch(t.value){case"moveUp":this.goToPositionAngle(e,{POS:0,ANG:0,REPO:0,LOCK:0,CHN:i},a);break;case"moveDown":this.goToPositionAngle(e,{POS:100,ANG:100,REPO:0,LOCK:0,CHN:i},a);break;case"moveTo":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("move to value invalid")));(o=parseFloat(t.ext))<0&&(o=0),o>100&&(o=100),(s={})[r]=o,this.activeStateChange(s),this.goToPositionAngle(e,{POS:o,ANG:255,REPO:0,LOCK:0,CHN:i},a);break;case"stepUp":if(!this._states[r])return void this.init(function(){setTimeout(function(){l._states[r]?l.executeCommand(e,t,a):a&&a(new Error("get device status failed"));},200);});if(255==this._states[r].value||255==this._states[n].value)return void(a&&a(new Error("device status unknonw")));0!=this._states[n].value?((o=this._states[n].value-10)<0&&(o=0),(s={})[n]=o,this.activeStateChange(s),this.goToPositionAngle(e,{POS:255,ANG:o,REPO:0,LOCK:0,CHN:i},a)):((o=this._states[r].value-5)<0&&(o=0),(s={})[r]=o,this.activeStateChange(s),this.goToPositionAngle(e,{POS:o,ANG:0,REPO:0,LOCK:0,CHN:i},a));break;case"stepDown":if(!this._states[r])return void this.init(function(){setTimeout(function(){l._states[r]?l.executeCommand(e,t,a):a&&a(new Error("get device status failed"));},200);});if(255==this._states[r].value||255==this._states[n].value)return void(a&&a(new Error("device status unknonw")));100!=this._states[n].value?((o=this._states[n].value+10)>100&&(o=100),(s={})[n]=o,this.activeStateChange(s),this.goToPositionAngle(e,{POS:255,ANG:o,REPO:0,LOCK:0,CHN:i},a)):((o=this._states[r].value+5)>100&&(o=100),(s={})[r]=o,this.activeStateChange(s),this.goToPositionAngle(e,{POS:o,ANG:100,REPO:0,LOCK:0,CHN:i},a));break;case"lamellaUp":this.goToPositionAngle(e,{POS:255,ANG:0,REPO:0,LOCK:0,CHN:i},a);break;case"lamellaDown":this.goToPositionAngle(e,{POS:255,ANG:100,REPO:0,LOCK:0,CHN:i},a);break;case"lamellaTo":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("lamella to value invalid")));(o=parseFloat(t.ext))<0&&(o=0),o>100&&(o=100),(s={})[n]=o,this.goToPositionAngle(e,{POS:255,ANG:o,REPO:0,LOCK:0,CHN:i},a);break;case"stop":this.stop(e,{CHN:i},a);break;case"setRunTime":if(!t.ext)return void(a&&a(new Error("parameters is null")));(u=100*parseFloat(t.ext))<=499&&(u=500),h=255,_=7,this.setParameters(e,{VERT:u,ROT:h,AA:_,CHN:i},a);break;case"setRotationTime":if(!t.ext)return void(a&&a(new Error("parameters is null")));u=32767,h=parseInt(t.ext)/10,_=7,this.setParameters(e,{VERT:u,ROT:h,AA:_,CHN:i},a);break;case"setParams":if(!t.ext)return void(a&&a(new Error("parameters is null")));var u,c=t.ext.split(":");if(3!=c.length)return void(a&&a(new Error("parameters format invalid")));(u=c[0]?100*parseFloat(c[0]):32767)<=499&&(u=32767);var h=c[1]?parseInt(c[1])/10:255,_=c[2]?parseInt(c[2]):7;this.setParameters(e,{VERT:u,ROT:h,AA:_,CHN:i},a);break;default:a&&a(new Error("unknow command"));}}else a&&a(new Error("command invalid"));};var Bt=function Bt(e){Tt.call(this,e),this._data="d2-06-??";};(Bt.prototype=new Tt()).constructor=Bt;var Nt=function Nt(e){Tt.call(this,e),this._data="d2-06-01",this._states={pending:{value:!1,time:new Date().getTime()}},this._vacation_new=null,this._hccr_new=null,this._blcr_new=null,this._suir_new=null,this._vbir_new=null;};Nt.COMMANDS=["vacationOn","vacationOff","handleClosedClickOn","handleClosedClickOff","batteryLowClickOn","batteryLowClickOff","setSensorUpdateInterval","setVacationBlinkInterval"],Nt.STATES=["bal","ppal","state","handle","window","br","bl","motion","vacation","temperature","humidity","illumination","battery","hccr","blcr","suir","vbir"],(Nt.prototype=new Bt()).constructor=Nt,Nt.prototype.executeCommand=function(e,t,a){var r,n=new Date().getTime();if(t&&t.value){switch("setSensorUpdateInterval"==t.value.substr(0,23)&&t.value.length>23?(r=t.value.substr(23),t={value:"setSensorUpdateInterval",ext:r}):"setVacationBlinkInterval"==t.value.substr(0,24)&&t.value.length>24&&(r=t.value.substr(24),t={value:"setVacationBlinkInterval",ext:r}),t.value){case"vacationOn":this._vacation_new="on",this._states.pending={value:!0,time:n},this.activeStateChange({vacation:"on"});break;case"vacationOff":this._vacation_new="off",this._states.pending={value:!0,time:n},this.activeStateChange({vacation:"off"});break;case"handleClosedClickOn":this._hccr_new="on",this._states.pending={value:!0,time:n},this.activeStateChange({hccr:"on"});break;case"handleClosedClickOff":this._hccr_new="off",this._states.pending={value:!0,time:n},this.activeStateChange({hccr:"off"});break;case"batteryLowClickOn":this._blcr_new="on",this._states.pending={value:!0,time:n},this.activeStateChange({blcr:"on"});break;case"batteryLowClickOff":this._blcr_new="off",this._states.pending={value:!0,time:n},this.activeStateChange({blcr:"off"});break;case"setSensorUpdateInterval":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("set sensor update interval value invalid")));(r=parseInt(t.ext))<5&&(r=5),r>65535&&(r=65535),this._suir_new=r,this._states.pending={value:!0,time:n},this.activeStateChange({suir:r});break;case"setVacationBlinkInterval":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("set vacation blink interval value invalid")));(r=parseInt(t.ext))<3&&(r=3),r>255&&(r=255),this._vbir_new=r,this._states.pending={value:!0,time:n},this.activeStateChange({vbir:r});}a&&a();}else a&&a(new Error("command invalid"));},Nt.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);if(this._vacation_new&&delete r.vacation,this._hccr_new&&delete r.hccr,this._blcr_new&&delete r.blcr,this._suir_new&&delete r.suir,this._vbir_new&&delete r.vbir,210==t.rorg&&0==t.userData.readUInt8(0)&&this._sendResponse(e),r){var n=this.checkStateChange(r);a&&a(null,n);}else a&&a(new Error("data format invalid"));},Nt.prototype.evalTelegram=function(e){var t,a,r,n,s,o={};if(210==e.rorg)switch(e.userData.readUInt8(0)){case 0:var i=15&(t=e.userData.readUInt8(1)),l=(a=e.userData.readUInt8(2))>>4&15,u=15&a,c=(r=e.userData.readUInt8(3))>>4&15,h=15&r,_=(n=e.userData.readUInt8(4))>>4&15,p=15&n,d=e.userData.readUInt8(5),v=s=e.userData.readUInt8(6),f=e.userData.readUInt16BE(7),m=e.userData.readUInt8(9)>>3&31;switch(t>>4&15){case 0:o.bal="ok";break;case 1:o.bal="alarm";break;case 14:o.bal="invalid";break;case 15:o.bal="unsupported";}switch(i){case 0:o.ppal="ok";break;case 1:o.ppal="alarm";break;case 14:o.ppal="invalid";break;case 15:o.ppal="unsupported";}switch(l){case 0:o.handle="undefined";break;case 1:o.handle="up";break;case 2:o.handle="down";break;case 3:o.handle="left";break;case 4:o.handle="right";break;case 14:o.handle="invalid";break;case 15:o.handle="unsupported";}switch(u){case 0:o.window="undefined";break;case 1:o.window="not_tilted";break;case 2:o.window="tilted";break;case 14:o.window="invalid";break;case 15:o.window="unsupported";}switch(c){case 0:o.br="unchanged";break;case 1:o.br="pressed";break;case 2:o.br="releaseed";break;case 14:o.br="invalid";break;case 15:o.br="unsupported";}switch(h){case 0:o.bl="unchanged";break;case 1:o.bl="pressed";break;case 2:o.bl="releaseed";break;case 14:o.bl="invalid";break;case 15:o.bl="unsupported";}switch(_){case 0:o.motion="ok";break;case 1:o.motion="alarm";break;case 14:o.motion="invalid";break;case 15:o.motion="unsupported";}switch(p){case 0:o.vacation="unchanged";break;case 1:o.vacation="on";break;case 2:o.vacation="off";break;case 14:o.vacation="invalid";break;case 15:o.vacation="unsupported";}if(254==d?o.temperature="invalid":255==d?o.temperature="unsupported":d<=250&&(o.temperature=parseFloat((d/250*80-20).toFixed(2))),254==v?o.humidity="invalid":255==v?o.humidity="unsupported":v<=200&&(o.humidity=parseFloat((v/2).toFixed(1))),65534==f?o.illumination="invalid":65535==f?o.illumination="unsupported":60001==f?o.illumination="over_range":f<=6e4&&(o.illumination=f),m<=20&&(o.battery=5*m),"undefined"==o.window||"invalid"==o.window||"unsupported"==o.window||"not_tilted"==o.window)switch(o.handle){case"undefined":case"unsupported":o.state="undefined";break;case"up":o.state="tilted";break;case"down":o.state="closed";break;case"left":case"right":o.state="open";break;case"invalid":o.state="invalid";}else"tilted"==o.window&&(o.state="tilted");break;case 16:var g=(s=e.userData.readUInt8(1))>>7&1,w=s>>6&1,y=s>>5&1,S=e.userData.readUInt16BE(2),b=e.userData.readUInt8(4);o.vacation=g?"on":"off",o.hccr=w?"on":"off",o.blcr=y?"on":"off",S>=5&&(o.suir=S),b>=3&&(o.vbir=b);}return o;},Nt.prototype._sendResponse=function(e,t){var a=0;this._vacation_new&&"on"==this._vacation_new&&(a=1);var r=0;this._hccr_new&&"off"==this._hccr_new?r=1:this._hccr_new&&"on"==this._hccr_new&&(r=2);var n=0;this._blcr_new&&"off"==this._blcr_new?n=1:this._blcr_new&&"on"==this._blcr_new&&(n=2);var s=0;this._suir_new&&(s=this._suir_new);var o=0;this._vbir_new&&(o=this._vbir_new);var i=new Buffer([128,128|(1&a)<<5|(3&r)<<3|(3&n)<<1,s>>8&255,255&s,o]),l=this._senderID;l||(l=x.hub.m.enocean.SENDER_ID);var u=new x.hub.m.enocean.ESP3.Telegram.VLD(i,l,0),c=this;e.sendTelegram(u,!0,function(e){c._vacation_new=null,c._hccr_new=null,c._blcr_new=null,c._suir_new=null,c._vbir_new=null;var i={pending:!1};i.vacation=a?"on":"off",r&&(i.hccr=1==r?"off":"on"),n&&(i.blcr=1==n?"off":"on"),s&&(i.suir=s),o&&(i.vbir=o),c.activeStateChange(i),t&&t(e);});};var Ut=function Ut(e){Tt.call(this,e),this._data="d2-06-02",this._states={pending:{value:!1,time:new Date().getTime()}},this._vacation_new=null,this._lacs_new=null,this._blcs_new=null,this._suis_new=null,this._vbis_new=null;};Ut.COMMANDS=["vacationOn","vacationOff","lockActiveClickOn","lockActiveClickOff","batteryLowClickOn","batteryLowClickOff","setSensorUpdateInterval","setVacationBlinkInterval"],Ut.STATES=["operation_mode","handle","window","state","temperature","humidity","battery","vacation","hccr","blcr","suir","vbir"],(Ut.prototype=new Bt()).constructor=Ut,Ut.prototype.executeCommand=function(e,t,a){var r,n=new Date().getTime();if(t&&t.value){switch("setSensorUpdateInterval"==t.value.substr(0,23)&&t.value.length>23?(r=t.value.substr(23),t={value:"setSensorUpdateInterval",ext:r}):"setVacationBlinkInterval"==t.value.substr(0,24)&&t.value.length>24&&(r=t.value.substr(24),t={value:"setVacationBlinkInterval",ext:r}),t.value){case"vacationOn":this._vacation_new="on",this._states.pending={value:!0,time:n},this.activeStateChange({vacation:"on"});break;case"vacationOff":this._vacation_new="off",this._states.pending={value:!0,time:n},this.activeStateChange({vacation:"off"});break;case"lockActiveClickOn":this._lacs_new="on",this._states.pending={value:!0,time:n},this.activeStateChange({hccr:"on"});break;case"lockActiveClickOff":this._lacs_new="off",this._states.pending={value:!0,time:n},this.activeStateChange({hccr:"off"});break;case"batteryLowClickOn":this._blcs_new="on",this._states.pending={value:!0,time:n},this.activeStateChange({blcr:"on"});break;case"batteryLowClickOff":this._blcs_new="off",this._states.pending={value:!0,time:n},this.activeStateChange({blcr:"off"});break;case"setSensorUpdateInterval":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("set sensor update interval value invalid")));(r=parseInt(t.ext))<5&&(r=5),r>65535&&(r=65535),this._suis_new=r,this._states.pending={value:!0,time:n},this.activeStateChange({suir:r});break;case"setVacationBlinkInterval":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("set vacation blink interval value invalid")));(r=parseInt(t.ext))<3&&(r=3),r>255&&(r=255),this._vbis_new=r,this._states.pending={value:!0,time:n},this.activeStateChange({vbir:r});}a&&a();}else a&&a(new Error("command invalid"));},Ut.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);if(this._vacation_new&&delete r.vacation,this._lacs_new&&delete r.hccr,this._blcs_new&&delete r.blcr,this._suis_new&&delete r.suir,this._vbis_new&&delete r.vbir,210==t.rorg&&0==t.userData.readUInt8(0)&&this._sendResponse(e),r){var n=this.checkStateChange(r);a&&a(null,n);}else a&&a(new Error("data format invalid"));},Ut.prototype.evalTelegram=function(e){var t,a={};if(210==e.rorg)switch(e.userData.readUInt8(0)){case 0:var r=(t=e.userData.readUInt8(1))>>4&3,n=t>>2&3,s=3&t,o=e.userData.readUInt8(2),i=e.userData.readUInt8(3),l=e.userData.readUInt8(4)>>3&31;switch(t>>6&3){case 0:a.operation_mode="standard";break;case 1:a.operation_mode="hst";}switch(r){case 0:a.lock="unlocked";break;case 1:a.lock="locked";}switch(n){case 0:a.window="not_tilted";break;case 1:a.window="tilted";}switch(s){case 0:a.alarm="ok";break;case 1:a.alarm="burglary_alarm";break;case 2:a.alarm="unlock_alarm";}if(254==o?a.temperature="invalid":255==o?a.temperature="unsupported":o<=250&&(a.temperature=parseFloat((o/250*80-20).toFixed(2))),254==i?a.humidity="invalid":255==i?a.humidity="unsupported":i<=200&&(a.humidity=parseFloat((i/2).toFixed(1))),l<=20&&(a.battery=5*l),"tilted"==a.window)a.state="tilted";else switch(a.lock){case"unlocked":a.state="open";break;case"locked":a.state="closed";}break;case 16:var u=(t=e.userData.readUInt8(1))>>7&1,c=t>>6&1,h=t>>5&1,_=e.userData.readUInt16BE(2),p=e.userData.readUInt8(4);a.vacation=u?"on":"off",a.hccr=c?"on":"off",a.blcr=h?"on":"off",_>=5&&(a.suir=_),p>=3&&(a.vbir=p);}return a;},Ut.prototype._sendResponse=function(e,t){var a=0;this._vacation_new&&"on"==this._vacation_new?a=1:this._vacation_new&&"off"==this._vacation_new&&(a=2);var r=0;this._lacs_new&&"off"==this._lacs_new?r=1:this._lacs_new&&"on"==this._lacs_new&&(r=2);var n=0;this._blcs_new&&"off"==this._blcs_new?n=1:this._blcs_new&&"on"==this._blcs_new&&(n=2);var s=0;this._suis_new&&(s=this._suis_new);var o=0;this._vbis_new&&(o=this._vbis_new);var i=new Buffer([128,128|(3&a)<<4|(3&r)<<2|3&n,s>>8&255,255&s,o]),l=this._senderID;l||(l=x.hub.m.enocean.SENDER_ID);var u=new x.hub.m.enocean.ESP3.Telegram.VLD(i,l,0),c=this;e.sendTelegram(u,!0,function(e){c._vacation_new=null,c._lacs_new=null,c._blcs_new=null,c._suis_new=null,c._vbis_new=null;var i={pending:!1};i.vacation=a?"on":"off",r&&(i.hccr=1==r?"off":"on"),n&&(i.blcr=1==n?"off":"on"),s&&(i.suir=s),o&&(i.vbir=o),c.activeStateChange(i),t&&t(e);});};var Mt=function Mt(e){Tt.call(this,e),this._data="d2-20-??";};(Mt.prototype=new Tt()).constructor=Mt;var Ft=function Ft(e){Mt.call(this,e),this._data="d2-20-00",this._poller=null,this._pollInterval=6e4;};Ft.COMMANDS=["setFanLevel","fanLevelUp","fanLevelDown","requestStatus","setHumLevel","setCo2Level"],Ft.STATES=["filter_remaining_time","operating_time","temperature","message_code","anti_freeze","current_fan_level","set_fan_level"],(Ft.prototype=new Mt()).constructor=Ft,Ft.prototype.init=function(e){var t=this,a=Math.floor(6e3*Math.random())+1e3;setTimeout(function(){var a=require("x.hub.m.enocean.js")._esp3;t.executeCommand(a,{value:"requestStatus"},e),t._restartPoller(a);},a);},Ft.prototype.finalize=function(e){this._poller&&clearInterval(this._poller),e&&e();},Ft.prototype._restartPoller=function(e){this._poller&&clearInterval(this._poller);var t=this;this._poller=setInterval(function(){t.executeCommand(e,{value:"requestStatus"});},this._pollInterval);},Ft.prototype.executeCommand=function(e,t,a){var r,n;if(new Date().getTime(),t&&t.value){if("setFanLevel"==t.value.substr(0,11)&&t.value.length>11)r=t.value.substr(11),t={value:"setFanLevel",ext:r};else if("fanLevelUp"==t.value){if(void 0===(n=this.getBufferedState("set_fan_level"))||null==n)return void(a&&a(new Error("fanLevelUp unknown current fan level")));if(6==n)return void(a&&a());t={value:"setFanLevel",ext:n+1};}else if("fanLevelDown"==t.value){if(void 0===(n=this.getBufferedState("set_fan_level"))||null==n)return void(a&&a(new Error("fanLevelUp unknown current fan level")));if(0==n)return void(a&&a());t={value:"setFanLevel",ext:n-1};}else if("setHumLevel"==t.value.substr(0,11)&&t.value.length>11){if(5!=(n=this.getBufferedState("set_fan_level")))return void(a&&a(new Error("humidity regulation not active")));r=t.value.substr(11),t={value:"setHumLevel",ext:r};}else if("setCo2Level"==t.value.substr(0,11)&&t.value.length>11){if(6!=(n=this.getBufferedState("set_fan_level")))return void(a&&a(new Error("co2 regulation not active")));r=t.value.substr(11),t={value:"setCo2Level",ext:r};}var s,o=this;switch(t.value){case"setFanLevel":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("setFanLevel value invalid")));if((s=parseInt(t.ext))<0||s>6)return void(a&&a(new Error("setFanLevel value invalid")));if(5==s||6==s)return this.activeStateChange({set_fan_level:s}),this._activateSensorRegulation(s),void(a&&a());this._deactivateSensorRegulation(),this._sendResponse(e,{LS:s,RS:1},function(t){t||o.activeStateChange({set_fan_level:s}),o._restartPoller(e),a&&a(t);});break;case"setHumLevel":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("setHumLevel value invalid")));if((s=parseInt(t.ext))<0||s>4)return void(a&&a(new Error("setHumLevel value invalid")));this._sendResponse(e,{LS:s,RS:1},function(t){o._restartPoller(e),a&&a(t);});break;case"setCo2Level":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("setCo2Level value invalid")));if((s=parseInt(t.ext))<0||s>4)return void(a&&a(new Error("setCo2Level value invalid")));this._sendResponse(e,{LS:s,RS:1},function(t){o._restartPoller(e),a&&a(t);});break;case"requestStatus":this._sendResponse(e,{LS:5,RS:1},function(e){a&&a(e);});break;default:a&&a(new Error("unknown command"));}}else a&&a(new Error("command invalid"));},Ft.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);this._states&&this._states.set_fan_level||(r.set_fan_level=r.current_fan_level),this._states&&this._states.set_fan_level&&5!=this._states.set_fan_level.value&&6!=this._states.set_fan_level.value&&(r.set_fan_level=r.current_fan_level);var n=this.checkStateChange(r);a&&a(null,n);},Ft.prototype.evalTelegram=function(e){var t,a={};if(210==e.rorg)if(1==e.userData.length)t=7&e.userData.readUInt8(0),a.current_fan_level=t;else{var r=e.userData.readUInt8(0),n=e.userData.readUInt8(1),s=e.userData.readUInt16LE(2),o=e.userData.readUInt8(4),i=e.userData.readUInt8(5),l=e.userData.readUInt8(6),u=e.userData.readUInt16LE(7),c=e.userData.readUInt8(9),h=e.userData.readUInt8(10),_=e.userData.readInt16BE(11),p=e.userData.readUInt8(13),d=p>>4&1;t=7&p,a.filter_remaining_time=o+":"+s+":"+n+":"+r,a.operating_time=c+":"+u+":"+l+":"+i,a.temperature=_/10,a.message_code=h,a.anti_freeze=d?"on":"off",a.current_fan_level=t;}return a;},Ft.prototype._sendResponse=function(e,t,a){var r=this._senderID;this._senderID||(r=x.hub.m.enocean.SENDER_ID);var n=t.LS,s=t.RS,o=new Buffer([n,s]),i=new x.hub.m.enocean.ESP3.Telegram.VLD(o,r,0);this._senderID!=this._address&&i.setDstId(this._address),e.sendTelegram(i,!0,function(e){a&&a(e);});},Ft.prototype._activateSensorRegulation=function(e){var t=require("x.hub.m.enocean.js").getRehauHandler();t&&t.activateSensorRegulation(this.getAddress(),e);},Ft.prototype._deactivateSensorRegulation=function(){var e=require("x.hub.m.enocean.js").getRehauHandler();e&&e.deactivateSensorRegulation(this.getAddress());};var Lt=function Lt(e){m.call(this,e),this._data="eltako_contact",this._vendor="eltako",this._eepAlias="f6-10-00";};Lt.STATES=["contact","contact_raw"],(Lt.prototype=new m()).constructor=Lt,Lt.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a=e.userData;240==a?t.contact="closed":224==a&&(t.contact="open"),t.contact_raw=a;}return t;};var Ht=function Ht(e){ce.call(this,e),this._data="eltako_motion",this._vendor="eltako",this._eepAlias="a5-08-01";};Ht.STATES=["voltage","voltage_raw","illumination","illumination_raw","state","state_raw"],(Ht.prototype=new ce()).constructor=Ht,Ht.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=(e.userData.readUInt8(2),e.userData.readUInt8(1)),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.voltage=parseFloat((s/255*5.1).toFixed(1)),t.voltage_raw=s;var o=r;t.illumination=parseFloat((o/255*2048).toFixed(1)),t.illumination_raw=o;var i=a>>1&1;switch(i){case 0:t.state="on";break;case 1:t.state="off";}t.state_raw=i;}}return t;};var Jt=function Jt(e){St.call(this,e),this._data="eltako_switch",this._vendor="eltako",this._eepAlias="f6-02-01";};Jt.COMMANDS=["on","off","toggle"],Jt.STATES=["state"],(Jt.prototype=new St()).constructor=Jt,Jt.prototype.getTeachinType=function(){return"4BS";},Jt.prototype.handleLearnTelegram=function(e,t){t&&246==t.rorg&&require("x.hub.m.enocean.js")._deviceHandler.onLearnDevice({address:e._learnAddress,senderID:e._learnSenderID,data:e._learnProfile,vendor:e._learnVendor},{address:t.senderID,senderID:e._learnSenderID,data:this._data,vendor:this._vendor},function(t,a){e._learnFinish(t,0,a);});},Jt.prototype.getTeachinTelegram=function(e,t,a){var r=new Buffer([224,64,13,128]);return new x.hub.m.enocean.ESP3.Telegram.BS4(r,t,0);},Jt.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 112:t.state="on";break;case 80:t.state="off";}return t;},Jt.prototype.executeCommand=function(e,t,a){if(t&&t.value)switch(new Date().getTime(),t.value){case"on":this.switching(e,{TIM:0,LCK:0,DEL:0,SW:1},function(e){a&&a(e);});break;case"off":this.switching(e,{TIM:0,LCK:0,DEL:0,SW:0},function(e){a&&a(e);});break;case"toggle":if(!this._states.state)return void(a&&a(new Error("unknow previous switch state")));"on"==this._states.state.value?this.executeCommand(e,{value:"off"},a):this.executeCommand(e,{value:"on"},a);break;default:a&&a(new Error("unknow command"));}else a&&a(new Error("command invalid"));};var Vt,qt=(((Vt=function Vt(e){Jt.call(this,e),this.TEACH_IN_VARIATION=3,this._data="eltako_tf_switch";}).prototype=new Jt()).constructor=Vt,Vt.prototype.handleTeachinTelegram=function(e,t){if(t&&165==t.rorg&&t.userData){var a=t.userData.toString("hex"),r=e._teachSenderID;a&&r&&r.substr(2)==a.substr(0,6)&&require("x.hub.m.enocean.js")._deviceHandler.onLearnDevice({address:e._teachID,senderID:e._teachSenderID,data:e._teachProfile,vendor:e._teachVendor},{address:t.senderID,senderID:e._teachSenderID,data:e._teachProfile,vendor:e._teachVendor},function(t,a){e._teachFinish(t,a);});}},Vt),Wt=function Wt(e){St.call(this,e),this._data="eltako_dimmer",this._vendor="eltako",this._eepAlias="a5-38-08",this._lastOnLevel=-1;};Wt.COMMANDS=["on","off","toggle","dimTo","dimUp","dimDown","toggleTo","setRampTime"],Wt.STATES=["state","level","ramp_time"],(Wt.prototype=new St()).constructor=Wt,Wt.prototype.setDefaultParams=function(){this._params||(this._params={}),void 0!==this._params.ramp_time&&null!=this._params.ramp_time||(this._params.ramp_time=0);},Wt.prototype.handleLearnTelegram=function(e,t){t&&165==t.rorg&&require("x.hub.m.enocean.js")._deviceHandler.onLearnDevice({address:e._learnAddress,senderID:e._learnSenderID,data:e._learnProfile,vendor:e._learnVendor},{address:t.senderID,senderID:e._learnSenderID,data:this._data,vendor:this._vendor},function(t,a){e._learnFinish(t,0,a);});},Wt.prototype.getTeachinTelegram=function(e,t,a){var r=new Buffer([224,64,13,128]);return new x.hub.m.enocean.ESP3.Telegram.BS4(r,t,0);},Wt.prototype.getStatesBuffer=function(){var e=JSON.parse(JSON.stringify(this._states));return e.ramp_time={value:this._params.ramp_time,time:-1},e;},Wt.prototype.getCurrentStates=function(){var e={},t=this.getStatesBuffer();for(var a in t.level&&0==t.level.value&&t.state&&(t.state.value="off"),t.state&&"off"==t.state.value&&t.level&&(t.level.value=0),t)t.hasOwnProperty(a)&&t[a]&&(e[a]=t[a].value);return e;},Wt.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);if(r){0==r.level&&(r.state="off"),"off"==r.state&&(r.level=0),0!=r.level&&"off"!=r.state||this._states.level&&this._states.level.value&&(this._lastOnLevel=this._states.level.value);var n=this.checkStateChange(r);a&&a(null,n);}else a&&a(new Error("data format invalid"));},Wt.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)&&2===s){var o=n;t.level=o;var i=r;t.ramp=i;var l=a>>2&1;t.dim_range=l?"relative":"absolute";var u=a>>1&1;t.store_final_value=u;var c=1&a;t.state=c?"on":"off";}}return t;},Wt.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r;"dimTo"==t.value.substr(0,5)&&t.value.length>5?(r=t.value.substr(5),t={value:"dimTo",ext:r}):"toggleTo"==t.value.substr(0,8)&&t.value.length>8?(r=t.value.substr(8),t={value:"toggleTo",ext:r}):"setRampTime"==t.value.substr(0,11)&&t.value.length>11&&(r=t.value.substr(11),t={value:"setRampTime",ext:r}),new Date().getTime();var n=this;switch(t.value){case"on":-1!=(r=this._lastOnLevel)&&0!=r||(r=100),this.dimming(e,{EDIM:r,RMP:this._params.ramp_time,EDIMR:0,STR:0,SW:1},function(e){e||n.activeStateChange({level:r,state:"on"}),a&&a(e);});break;case"off":this._states.level&&this._states.level.value&&(this._lastOnLevel=this._states.level.value),this.dimming(e,{EDIM:0,RMP:this._params.ramp_time,EDIMR:0,STR:0,SW:0},function(e){e||n.activeStateChange({level:0,state:"off"}),a&&a(e);});break;case"toggle":if(!this._states.state)return void(a&&a(new Error("unknow previous dimmer state")));"on"==this._states.state.value?this.executeCommand(e,{value:"off"},a):this.executeCommand(e,{value:"on"},a);break;case"toggleTo":if(!this._states.state)return void(a&&a(new Error("unknow previous dimmer state")));"on"==this._states.state.value?this.executeCommand(e,{value:"off"},a):this.executeCommand(e,{value:"dimTo",ext:t.ext},a);break;case"dimTo":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("dim to value invalid")));if((r=parseFloat(t.ext))<0&&(r=0),r>100&&(r=100),0==r)return void this.executeCommand(e,{value:"off"},a);this.dimming(e,{EDIM:r,RMP:this._params.ramp_time,EDIMR:0,STR:0,SW:1},function(e){e||n.activeStateChange({level:r,state:"on"}),a&&a(e);});break;case"dimUp":if(!this._states.level)return void(a&&a(new Error("unknow previous dimmer level")));r=parseInt(this._states.level.value),(r+=5)>100&&(r=100),this.dimming(e,{EDIM:r,RMP:this._params.ramp_time,EDIMR:0,STR:0,SW:1},function(e){e||n.activeStateChange({level:r,state:"on"}),a&&a(e);});break;case"dimDown":if(!this._states.level)return void(a&&a(new Error("unknow previous dimmer level")));if(r=parseInt(this._states.level.value),(r-=5)<0&&(r=0),0==r)return void this.executeCommand(e,{value:"off"},a);this.dimming(e,{EDIM:r,RMP:this._params.ramp_time,EDIMR:0,STR:0,SW:1},function(e){e||n.activeStateChange({level:r,state:"on"}),a&&a(e);});break;case"setRampTime":if(!t.ext)return void(a&&a(new Error("parameters is null")));(r=parseInt(r))>255&&(r=255),r<0&&(r=0),this._params.ramp_time=r,require("x.hub.m.enocean.js")._deviceHandler.deviceParamsUpdated(this,function(e){a&&a(e);});break;default:a&&a(new Error("unknow command"));}}else a&&a(new Error("command invalid"));};var jt,Kt=(((jt=function jt(e){Wt.call(this,e),this.TEACH_IN_VARIATION=3,this._data="eltako_tf_dimmer";}).prototype=new Wt()).constructor=jt,jt.prototype.handleTeachinTelegram=function(e,t){if(t&&165==t.rorg&&t.userData){var a=t.userData.toString("hex"),r=e._teachSenderID;a&&r&&r.substr(2)==a.substr(0,6)&&require("x.hub.m.enocean.js")._deviceHandler.onLearnDevice({address:e._teachID,senderID:e._teachSenderID,data:e._teachProfile,vendor:e._teachVendor},{address:t.senderID,senderID:e._teachSenderID,data:e._teachProfile,vendor:e._teachVendor},function(t,a){e._teachFinish(t,a);});}},jt),Gt=function Gt(e){Wt.call(this,e),this._data="eltako_dimmer2",this._vendor="eltako",this._eepAlias="f6-02-01";};Gt.COMMANDS=["on","off","toggle","dimTo","dimUp","dimDown","toggleTo","setRampTime"],Gt.STATES=["state","ramp_time"],(Gt.prototype=new Wt()).constructor=Wt,Gt.prototype.handleLearnTelegram=function(e,t){t&&246==t.rorg&&require("x.hub.m.enocean.js")._deviceHandler.onLearnDevice({address:e._learnAddress,senderID:e._learnSenderID,data:e._learnProfile,vendor:e._learnVendor},{address:t.senderID,senderID:e._learnSenderID,data:this._data,vendor:this._vendor},function(t,a){e._learnFinish(t,0,a);});},Gt.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 112:t.state="on";break;case 80:t.state="off";}return t;};var Qt=function Qt(e){Wt.call(this,e),this._data="eltako_fsud";};Qt.COMMANDS=["on","off","toggle","dimTo","dimUp","dimDown","toggleTo","setRampTime"],Qt.STATES=["state","ramp_time"],(Qt.prototype=new Wt()).constructor=Wt,Qt.prototype.getTeachinTelegram=function(e,t,a){var r=new Buffer([2,0,0,0]);return new x.hub.m.enocean.ESP3.Telegram.BS4(r,t,0);};var Yt=function Yt(e){bt.call(this,e),this._data="eltako_blind",this._vendor="eltako",this._eepAlias="f6-02-01",this._syncRunning=!1,this._syncTO=null,this._syncCB=null;};Yt.COMMANDS=["up","down","stop","stepUp","stepDown","setRV","setRunTime","moveTo","sync"],Yt.STATES=["pos","sync"],(Yt.prototype=new bt()).constructor=Yt,Yt.prototype.setDefaultParams=function(){this._params||(this._params={}),void 0!==this._params.rv&&null!=this._params.rv||(this._params.rv=200),void 0!==this._params.rt&&null!=this._params.rt||(this._params.rt=200);},Yt.prototype.handleLearnTelegram=function(e,t){t&&246==t.rorg&&require("x.hub.m.enocean.js")._deviceHandler.onLearnDevice({address:e._learnAddress,senderID:e._learnSenderID,data:e._learnProfile,vendor:e._learnVendor},{address:t.senderID,senderID:e._learnSenderID,data:this._data,vendor:this._vendor},function(t,a){e._learnFinish(t,0,a);});},Yt.prototype.getTeachinTelegram=function(e,t,a){var r=new Buffer([255,248,13,128]);return new x.hub.m.enocean.ESP3.Telegram.BS4(r,t,0);},Yt.prototype.getStatesBuffer=function(){var e=JSON.parse(JSON.stringify(this._states));return e.sync||(e.sync={value:!1,time:-1}),e.rv={value:this._params.rv,time:-1},e.rt={value:this._params.rt,time:-1},e;},Yt.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);if(r){var n=this.checkStateChange(r);r.sync&&this._syncRunning&&(this._syncRunning=!1,this._syncTO&&(clearTimeout(this._syncTO),this._syncTO=null),this._syncCB&&(this._syncCB(),this._syncCB=null)),a&&a(null,n);}else a&&a(new Error("data format invalid"));},Yt.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 112:t.sync=!0,t.pos=0;break;case 80:t.sync=!0,t.pos=100;}else if(165==e.rorg){var a=e.userData.readUInt16BE(0),r=e.userData.readUInt8(2),n=this._params.rt;n||(n=200);var s=this._states.pos?this._states.pos.value:null;if(s||(s=0),void 0!==s&&null!=s){var o=10*a/n;switch(r){case 1:t.pos=Math.max(0,Math.round(s-o));break;case 2:t.pos=Math.min(100,Math.round(s+o));}}}return t;},Yt.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r;"stepUp"==t.value.substr(0,6)&&t.value.length>6?(r=t.value.substr(6),t={value:"stepUp",ext:r}):"stepDown"==t.value.substr(0,8)&&t.value.length>8?(r=t.value.substr(8),t={value:"stepDown",ext:r}):"setRV"==t.value.substr(0,5)&&t.value.length>5?(r=t.value.substr(5),t={value:"setRV",ext:r}):"setRunTime"==t.value.substr(0,10)&&t.value.length>10?(r=t.value.substr(10),t={value:"setRunTime",ext:r}):"moveTo"==t.value.substr(0,6)&&t.value.length>6&&(r=t.value.substr(6),t={value:"moveTo",ext:r}),new Date().getTime();var n=this._params.rv;n||(n=200);var s,o,i=this._params.rt;switch(i||(i=200),t.value){case"up":s=n,this.doReq(e,{TIME:s,CMD:1,LCK:0,TYPE:0},function(e){a&&a(e);});break;case"down":s=n,this.doReq(e,{TIME:s,CMD:2,LCK:0,TYPE:0},function(e){a&&a(e);});break;case"stop":s=0,this.doReq(e,{TIME:s,CMD:0,LCK:0,TYPE:0},function(e){a&&a(e);});break;case"stepUp":(s=void 0===t.ext||null==t.ext?i/100:parseFloat(t.ext)/100*i)<1&&(s=1),this.doReq(e,{TIME:s,CMD:1,LCK:0,TYPE:0},function(e){a&&a(e);});break;case"stepDown":(s=void 0===t.ext||null==t.ext?i/100:parseFloat(t.ext)/100*i)<1&&(s=1),this.doReq(e,{TIME:s,CMD:2,LCK:0,TYPE:0},function(e){a&&a(e);});break;case"moveTo":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("value invalid")));o=parseInt(t.ext);var l,u=0;if(this._states&&this._states.pos&&void 0!==this._states.pos.value&&null!=this._states.pos.value&&(u=this._states.pos.value),(s=(o-u)/100*i)>0)l=2;else if(s<0)s=0-s,l=1;else if(0==s)return void(a&&a());this.doReq(e,{TIME:s,CMD:l,LCK:0,TYPE:1},function(e){a&&a(e);});break;case"sync":this.snyc(e,function(e){a&&a(e);});break;case"setRV":if(!t.ext)return void(a&&a(new Error("parameters is null")));(r=parseInt(r))>200&&(r=200),r<0&&(r=0),this._params.rv=r,require("x.hub.m.enocean.js")._deviceHandler.deviceParamsUpdated(this,function(e){a&&a(e);});break;case"setRunTime":if(!t.ext)return void(a&&a(new Error("parameters is null")));(r=parseInt(r))>200&&(r=200),r<0&&(r=0),this._params.rt=r,require("x.hub.m.enocean.js")._deviceHandler.deviceParamsUpdated(this,function(e){a&&a(e);});break;default:a&&a(new Error("unknow command"));}}else a&&a(new Error("command invalid"));},Yt.prototype.snyc=function(e,t){if(this._syncRunning)t&&t(new Error("sync running"));else{var a=this,r=this._params.rv;r||(r=200),this._syncRunning=!0,this._syncTO=setTimeout(function(){a._syncRunning=!1,a._syncTO=null,a._states.pos={value:0,time:new Date().getTime()};},1e3*(r+2)),this.doReq(e,{TIME:r,CMD:1,LCK:0,TYPE:0},function(e){t&&t(e);});}},Yt.prototype.doReq=function(e,t,a){var r,n,s=this._senderID;this._senderID||(s=x.hub.m.enocean.SENDER_ID),t.TYPE?(r=Math.round(10*t.TIME)>>8&255,n=255&Math.round(10*t.TIME)):(r=0,n=255&Math.round(t.TIME));var o=t.CMD,i=8|(1&t.LCK)<<2|(1&t.TYPE)<<1,l=new Buffer([r,n,o,i]),u=new x.hub.m.enocean.ESP3.Telegram.BS4(l,s,0);u.setDstId(this._address),e.sendTelegram(u,!0,function(e){a&&a(e);});};var zt,Xt=(((zt=function zt(e){Yt.call(this,e),this.TEACH_IN_VARIATION=3,this._data="eltako_tf_blind";}).prototype=new Yt()).constructor=zt,zt.prototype.handleTeachinTelegram=function(e,t){if(t&&165==t.rorg&&t.userData){var a=t.userData.toString("hex"),r=e._teachSenderID;a&&r&&r.substr(2)==a.substr(0,6)&&require("x.hub.m.enocean.js")._deviceHandler.onLearnDevice({address:e._teachID,senderID:e._teachSenderID,data:e._teachProfile,vendor:e._teachVendor},{address:t.senderID,senderID:e._teachSenderID,data:e._teachProfile,vendor:e._teachVendor},function(t,a){e._teachFinish(t,a);});}},zt),Zt=function Zt(e){X.call(this,e),this._data="eltako_weather",this._vendor="eltako",this._eepAlias="a5-04-02",this._engMax=7.2,this._engMin=0;};Zt.STATES=["energy","energy_raw","humidity","humidity_raw","temperature","temperature_raw","available"],(Zt.prototype=new X()).constructor=Zt,Zt.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.energy=parseFloat((o/250*(this._engMax-this._engMin)+this._engMin).toFixed(1)),t.energy_raw=o;var i=n;t.humidity=parseFloat((i/250*(this._humMax-this._humMin)+this._humMin).toFixed(1)),t.humidity_raw=i;var l=r;t.temperature=parseFloat((l/250*(this._tempMax-this._tempMin)+this._tempMin).toFixed(1)),t.temperature_raw=l;var u=a>>1&1;t.available=!!u;}}return t;};var $t=function $t(e){ee.call(this,e),this._data="eltako_lux",this._vendor="eltako",this._eepAlias="a5-06-01",this._ill1Max=3e4,this._ill1Min=300;};$t.STATES=["illumination2","illumination2_raw","illumination1","illumination1_raw","illumination","illumination_raw"],($t.prototype=new ee()).constructor=$t,$t.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=(e.userData.readUInt8(2),e.userData.readUInt8(1)),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.illumination2=s,t.illumination2_raw=s;var o=r;t.illumination1=parseFloat((o/255*(this._ill1Max-this._ill1Min)+this._ill1Min).toFixed(1)),t.illumination1_raw=o,t.illumination=o?t.illumination1:t.illumination2,t.illumination_raw=o?t.illumination1_raw:t.illumination2_raw;}}return t;};var ea=function ea(e){te.call(this,e),this._data="eltako_lux2",this._vendor="eltako",this._eepAlias="a5-06-02",this._ill2Min=0,this._ill2Max=1024;};ea.STATES=te.STATES,(ea.prototype=new te()).constructor=ea;var ta=function ta(e){n.call(this,e),this._data="eltako_buttons",this._vendor="eltako",this._eepAlias="f6-02-01",this._longPressThreshold=1e3,this.BUTTONS=["button1","button2","button3","button4"];};ta.STATES=["button1","button2","button3","button4"],ta.EVENTS=["shortPress","longPress","press","release"],(ta.prototype=new n()).constructor=ta,ta.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 112:this.BUTTONS[0]&&(t[this.BUTTONS[0]]="pressed");break;case 80:this.BUTTONS[1]&&(t[this.BUTTONS[1]]="pressed");break;case 48:this.BUTTONS[2]&&(t[this.BUTTONS[2]]="pressed");break;case 16:this.BUTTONS[3]&&(t[this.BUTTONS[3]]="pressed");break;case 0:for(var a=0;a<this.BUTTONS.length;a++)this.BUTTONS[a]&&(t[this.BUTTONS[a]]="released");}return t;},ta.prototype.checkStateChange=function(e){var t=this._states,a=[],r=new Date().getTime();for(var n in e){var s={};s.key=n,s.value=e[n],s.changed=!1;var o=t[n]?t[n].value:null,i=t[n]?t[n].time:null,l=e[n];o==l&&"pressed"!=l||(s.oldvalue=o,s.changed=!0),this._states[n]={value:e[n],time:r},s.changed&&("pressed"==l||"released"==l&&"pressed"==o)&&a.push(s),"pressed"==o&&"released"==l&&(!i||r-i<this._longPressThreshold?((s={}).key=n,s.value="shortPress",s.changed=!0):((s={}).key=n,s.value="longPress",s.changed=!0),a.push(s));}return a;};var aa=function aa(e){ta.call(this,e),this._data="eltako_button1",this.BUTTONS=[null,null,null,"button"];};aa.STATES=["button"],(aa.prototype=new ta()).constructor=aa;var ra=function ra(e){ta.call(this,e),this._data="eltako_sender2",this.BUTTONS=["A1","A3"];};ra.STATES=["A1","A3"],(ra.prototype=new ta()).constructor=ra;var na=function na(e){ta.call(this,e),this._data="eltako_sender4",this.BUTTONS=["E1","E2","E3","E4"];};na.STATES=["E1","E2","E3","E4"],(na.prototype=new ta()).constructor=na;var sa=function sa(e){ta.call(this,e),this._data="eltako_button2",this.BUTTONS=["buttonO","buttonI"];};sa.STATES=["buttonO","buttonI"],(sa.prototype=new ta()).constructor=sa;var oa=function oa(e){ta.call(this,e),this._data="eltako_button4",this.BUTTONS=["BO","BI","AO","AI"];};oa.STATES=["BO","BI","AO","AI"],(oa.prototype=new ta()).constructor=oa;var ia=function ia(e){ta.call(this,e),this._data="eltako_fsm60b";};ia.STATES=["button"],(ia.prototype=new ta()).constructor=ia,ia.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 112:case 80:case 16:t.button="pressed";break;case 0:t.button="released";}return t;};var la=function la(e){n.call(this,e),this._data="eltako_fkf",this._vendor="eltako",this._eepAlias="f6-04-01";};la.STATES=["keycard"],(la.prototype=new n()).constructor=la,la.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 16:t.keycard="inserted";case 0:t.keycard="takeout";}return t;};var ua=function ua(e){n.call(this,e),this._data="eltako_fkc",this._vendor="eltako",this._eepAlias="f6-04-01";};ua.STATES=["keycard"],(ua.prototype=new n()).constructor=ua,ua.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 48:t.keycard="guest_card";case 32:t.keycard="service_card";case 16:t.keycard="inserted";case 0:t.keycard="takeout";}return t;};var ca=function ca(e){Oe.call(this,e),this._data="eltako_thermo",this._vendor="eltako",this._eepAlias="a5-10-06";};ca.STATES=["setpoint","setpoint_raw","temperature","temperature_raw","night_reduce","night_reduce_raw"],(ca.prototype=new Oe()).constructor=ca,ca.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)){var o=s;t.night_reduce=o<=6?0:o<=12?1:o<=19?2:o<=25?3:o<=31?4:5,t.night_reduce_raw=o;var i=n;t.setpoint=parseFloat((i/255*40).toFixed(1)),t.setpoint_raw=i;var l=r;t.temperature=parseFloat(((255-l)/255*40).toFixed(1)),t.temperature_raw=l;}}return t;};var ha=function ha(e){ca.call(this,e),this._data="eltako_ftr65hb",this._vendor="eltako",this._eepAlias="a5-10-06";};ha.STATES=["setpoint","setpoint_raw","temperature","temperature_raw"],(ha.prototype=new ca()).constructor=ha,ha.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(1==(a>>3&1)){var s=n;t.setpoint=parseFloat((s/255*40).toFixed(1)),t.setpoint_raw=s;var o=r;t.temperature=parseFloat(((255-o)/255*40).toFixed(1)),t.temperature_raw=o;}}return t;};var _a=function _a(e){ca.call(this,e),this._data="eltako_futh55d",this._vendor="eltako",this._eepAlias="a5-10-12";};_a.STATES=["setpoint","setpoint_raw","temperature","temperature_raw","night_reduce","night_reduce_raw"],(_a.prototype=new ca()).constructor=_a;var pa=function pa(e){ca.call(this,e),this._data="eltako_futh65d",this._vendor="eltako",this._eepAlias="a5-10-12";};pa.STATES=["setpoint","setpoint_raw","temperature","temperature_raw","night_reduce","night_reduce_raw"],(pa.prototype=new ca()).constructor=pa;var da=function da(e){ke.call(this,e),this._data="eltako_ftr78s",this._vendor="eltako",this._eepAlias="a5-10-03";};da.STATES=["setpoint","setpoint_raw","temperature","temperature_raw"],(da.prototype=new ke()).constructor=da,da.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(1==(a>>3&1)){var s=n;t.setpoint=parseFloat((s/255*22+8).toFixed(1)),t.setpoint_raw=s;var o=r;t.temperature=parseFloat(((255-o)/255*40).toFixed(1)),t.temperature_raw=o;}}return t;};var va=function va(e){Qe.call(this,e),this._data="eltako_powermeter",this._vendor="eltako",this._eepAlias="a5-12-01";};va.STATES=["power","energy","tariff"],(va.prototype=new Qe()).constructor=va,va.prototype.evalTelegram=function(e){var t=Qe.prototype.evalTelegram.call(this,e);return 165==e.rorg&&143==e.userData.readUInt8(3)&&(t={}),t;};var fa=function fa(e){Qe.call(this,e),this._data="eltako_powermeter2",this._vendor="eltako",this._eepAlias="a5-12-01";};fa.STATES=["power","tariff"],(fa.prototype=new Qe()).constructor=va,fa.prototype.evalTelegram=function(e){var t=Qe.prototype.evalTelegram.call(this,e);return delete t.energy,delete t.tariff,t;};var ma=function ma(e){ta.call(this,e),this._data="eltako_fzs";};ma.STATES=["button"],(ma.prototype=new ta()).constructor=ma,ma.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 48:t.button="pressed";break;case 0:t.button="released";}return t;},ma.prototype.checkStateChange=function(e){var t=this._states,a=[],r=new Date().getTime();for(var n in e){var s={};s.key=n,s.value=e[n],s.changed=!1;var o=t[n]?t[n].value:null,i=t[n]?t[n].time:null,l=e[n];o!=l&&(s.oldvalue=o,s.changed=!0),this._states[n]={value:e[n],time:r},s.changed&&a.push(s),"pressed"==o&&"released"==l&&(!i||r-i<this._longPressThreshold?((s={}).key=n,s.value="shortPress",s.changed=!0):((s={}).key=n,s.value="longPress",s.changed=!0),a.push(s));}return a;};var ga=function ga(e){o.call(this,e),this._data="eltako_relay2",this._vendor="eltako",this._eepAlias="f6-02-01";};ga.STATES=["ch1","ch2"],(ga.prototype=new o()).constructor=ga,ga.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 112:t.ch1="on";break;case 80:t.ch1="off";break;case 48:t.ch2="on";break;case 16:t.ch2="off";}return t;};var wa=function wa(e){o.call(this,e),this._data="eltako_relay",this._vendor="eltako",this._eepAlias="f6-02-01";};wa.STATES=["state"],(wa.prototype=new o()).constructor=wa,wa.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 112:t.state="on";break;case 80:t.state="off";}return t;};var ya=function ya(e){gt.call(this,e),this._data="eltako_heat",this._vendor="eltako",this._eepAlias="a5-30-03";};ya.STATES=["temperature","temperature_raw","alarm","alarm_raw"],(ya.prototype=new gt()).constructor=ya,ya.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(e.userData.readUInt8(0),1==(a>>3&1)){var s=n;t.temperature=parseFloat(((255-s)/255*40).toFixed(1)),t.temperature_raw=s;var o=r;t.alarm=15==o?"alarm":"ok",t.alarm_raw=o;}}return t;};var Sa=function Sa(e){gt.call(this,e),this._data="eltako_water_m3",this._vendor="eltako",this._eepAlias="a5-30-03";};Sa.STATES=["water","water_raw"],(Sa.prototype=new gt()).constructor=Sa,Sa.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2);if(1==(a>>3&1)){var n=r;t.water=15==n,t.water_raw=n;}}return t;};var ba=function ba(e){ft.call(this,e),this._data="eltako_water_m4",this._vendor="eltako",this._eepAlias="a5-30-01";};ba.STATES=["water","water_raw"],(ba.prototype=new ft()).constructor=ba,ba.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2);if(1==(a>>3&1)){var n=r;t.water=0==n,t.water_raw=n;}}return t;};var Ta=function Ta(e){St.call(this,e),this.TEACH_IN_VARIATION=3,this._data="peha_powerswitch",this._vendor="peha",this._eepAlias="a5-38-08";};Ta.COMMANDS=["on","off","toggle"],Ta.STATES=["state","state_raw","level","rgb","power","energy","current","voltage","power_raw","power_unit","energy_unit","current_unit","voltage_unit","power_unit_raw","op_hour","error","error_raw","service_mode","op_hour_flag","op_hour_flag_raw","mode_raw"],(Ta.prototype=new St()).constructor=Ta,Ta.prototype.getTeachinType=function(){return"4BS";},Ta.prototype.evalTelegram=function(e){return je.prototype.evalTelegram.call(this,e);},Ta.prototype.executeCommand=function(e,t,a){if(t&&t.value){new Date().getTime();var r=this;switch(t.value){case"on":this.switching(e,{TIM:0,LCK:0,DEL:0,SW:1},function(e){e||r.activeStateChange({state:"on"}),a&&a(e);});break;case"off":this.switching(e,{TIM:0,LCK:0,DEL:0,SW:0},function(e){e||r.activeStateChange({state:"off"}),a&&a(e);});break;case"toggle":if(!this._states.state)return void(a&&a(new Error("unknow previous switch state")));"on"==this._states.state.value?this.executeCommand(e,{value:"off"},a):this.executeCommand(e,{value:"on"},a);break;default:a&&a(new Error("unknow command"));}}else a&&a(new Error("command invalid"));};var Ia=function Ia(e){Ta.call(this,e),this.TEACH_IN_VARIATION=3,this._data="peha_switch",this._vendor="peha",this._eepAlias="a5-38-08";};Ia.COMMANDS=["on","off","toggle"],Ia.STATES=["state","state_raw","level","rgb","power","energy","current","voltage","power_raw","power_unit","energy_unit","current_unit","voltage_unit","power_unit_raw","op_hour","error","error_raw","service_mode","op_hour_flag","op_hour_flag_raw","mode_raw"],(Ia.prototype=new Ta()).constructor=Ia,Ia.prototype.evalTelegram=function(e){var t=je.prototype.evalTelegram.call(this,e);return delete t.power,delete t.energy,delete t.current,delete t.voltage,delete t.power_unit,delete t.energy_unit,delete t.current_unit,delete t.voltage_unit,t;};var Da=function Da(e){St.call(this,e),this.TEACH_IN_VARIATION=3,this._data="peha_blind",this._vendor="peha",this._eepAlias="a5-38-08",this._initCount=0;};Da.COMMANDS=["up","down","stop","stepUp","stepDown","moveTo","lamellaUp","lamellaDown","lamellaStepUp","lamellaStepDown","lamellaTo","setRunTime","setLamellaRuntime"],Da.STATES=["position","angle","position_flag","position_flag_raw","angle_flag","angle_flag_raw","error","error_raw","end_position","end_position_raw","state","state_raw","service_mode","position_mode"],(Da.prototype=new St()).constructor=Da,Da.prototype.init=function(e){var t=require("x.hub.m.enocean.js")._esp3;this.blind(t,{P1:0,P2:0,FUNC:0,SSF:0,PAF:0,SMF:0},function(t){e&&e();});},Da.prototype.getTeachinType=function(){return"4BS";},Da.prototype.getStatesBuffer=function(){return 0==Object.keys(this._states).length?(this._initCount<=100&&this._initCount%10==0||this._initCount>=100&&this._initCount<=600&&this._initCount%60==0?this.init():this._initCount=0,this._initCount++):this._initCount=0,this._states;},Da.prototype.evalTelegram=function(e){return We.prototype.evalTelegram.call(this,e);},Da.prototype.executeCommand=function(e,t,a){if(t&&t.value){new Date().getTime();var r,n,s=this;switch("stepUp"==t.value.substr(0,6)&&t.value.length>6?(r=t.value.substr(6),t={value:"stepUp",ext:r}):"stepDown"==t.value.substr(0,8)&&t.value.length>8?(r=t.value.substr(8),t={value:"stepDown",ext:r}):"setRunTime"==t.value.substr(0,10)&&t.value.length>10?(r=t.value.substr(10),t={value:"setRunTime",ext:r}):"moveTo"==t.value.substr(0,6)&&t.value.length>6&&(r=t.value.substr(6),t={value:"moveTo",ext:r}),t.value){case"up":this.blind(e,{P1:0,P2:0,FUNC:2,SSF:0,PAF:0,SMF:0},function(e){a&&a(e);});break;case"down":this.blind(e,{P1:0,P2:0,FUNC:3,SSF:0,PAF:0,SMF:0},function(e){a&&a(e);});break;case"stop":this.blind(e,{P1:0,P2:0,FUNC:1,SSF:0,PAF:0,SMF:0},function(e){a&&a(e);});break;case"stepUp":if(r=void 0===t.ext||null==t.ext?5:parseInt(t.ext),void 0===(n=this._states.position?this._states.position.value:null)||null==n)return this.blind(e,{P1:0,P2:0,FUNC:0,SSF:0,PAF:0,SMF:0}),void(a&&a(new Error("unknown position")));this._states.position_mode&&this._states.position_mode.value?(r=n+r)>100&&(r=100):(r=n-r)<0&&(r=0),this.blind(e,{P1:r,P2:0,FUNC:4,SSF:0,PAF:0,SMF:0},function(e){e||s.activeStateChange({position:r}),a&&a(e);});break;case"stepDown":if(r=void 0===t.ext||null==t.ext?5:parseInt(t.ext),void 0===(n=this._states.position?this._states.position.value:null)||null==n)return this.blind(e,{P1:0,P2:0,FUNC:0,SSF:0,PAF:0,SMF:0}),void(a&&a(new Error("unknown position")));this._states.position_mode&&this._states.position_mode.value?(r=n-r)<0&&(r=0):(r=n+r)>100&&(r=100),this.blind(e,{P1:r,P2:0,FUNC:4,SSF:0,PAF:0,SMF:0},function(e){e||s.activeStateChange({position:r}),a&&a(e);});break;case"moveTo":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("value invalid")));n=parseInt(t.ext),this.blind(e,{P1:n,P2:0,FUNC:4,SSF:0,PAF:0,SMF:0},function(e){e||s.activeStateChange({position:n}),a&&a(e);});break;case"setRunTime":if(!t.ext||-1==t.ext.indexOf(":"))return void(a&&a(new Error("value invalid")));var o=t.ext.split(":"),i=o[0],l=o[1];if(!i&&l)i=l;else if(i&&!l)l=i;else if(!i&&!l)return void(a&&a(new Error("value invalid")));i=parseInt(i),l=parseInt(l),this.blind(e,{P1:i,P2:l,FUNC:7,SSF:0,PAF:0,SMF:0},function(e){e||s.activeStateChange({position:r}),a&&a(e);});break;default:a&&a(new Error("unknow command"));}}else a&&a(new Error("command invalid"));};var Ea=function Ea(t){e.call(this,t),this._data="bb-aa-cc",this._vendor="rehau",this._eepAlias="d2-06-10",this._hopCount=0,this._saLearnMode=1,this._originalEEP="bb-aa-cc",this._reset_alarm_new=null,this._reset_pre_alarm_new=null,this._deviceTO=this._startTimeoutTimer(),this._alarmTO=null,this._prealarmTO=null;};Ea.COMMANDS=["alertOn","alertOff","alertToggle","resetAlarm","resetPreAlarm","preAlarmOn","preAlarmOff","preAlarmToggle"],Ea.STATES=["battery","pre_alarm","alarm","window","pre_alarm_enabled","error","pending","alarm_enabled","pre_alarm_enabled_device","timeout"],(Ea.prototype=new e()).constructor=Ea,Ea.prototype.setDefaultParams=function(){var e=require("x.hub.m.enocean.js")._rehauHandler;if(e){var t=e.getSmartguardSetting(this._address),a=!0,r=!0;t&&(a=t.isAlarmActive(),r=t.isPreAlarmActive()),this.activeStateChange({pending:!1,alarm_enabled:a,pre_alarm_enabled:r,timeout:!1,alarm_task_active:e.getAlarm(),pre_alarm_task_active:e.getAlarm()});}},Ea.prototype.getStatesBuffer=function(){return this._states;},Ea.prototype.evalData=function(e,t,a){var r=this.evalTelegram(t);if(r){if(r.timeout=!1,this._deviceTO&&(clearTimeout(this._deviceTO),this._deviceTO=this._startTimeoutTimer()),208!=t.rorg){var n=!1;210==t.rorg&&2==t.userData.length&&(n=!0);var s=this.getBufferedState("alarm_task_active"),o=this.getBufferedState("pre_alarm_task_active"),i=this.getBufferedState("alarm_enabled"),l=this.getBufferedState("pre_alarm_enabled");r.pre_alarm?o&&l?this._startPreAlarmTimer():r.pre_alarm=!1:this._clearPreAlarmTimer(),r.alarm?s&&i?this._startAlarmTimer():r.alarm=!1:this._clearAlarmTimer(),c=this.checkStateChange(r);var u=this;this._executePendingCommand(e,function(){u._reportStates(r);},n),a&&a(null,c);}else{var c=this.checkStateChange(r);a&&a(null,c);}}else a&&a(new Error("data format invalid"));},Ea.prototype.evalTelegram=function(e){var t={},a=!1;if(210==e.rorg){var r;if(1==e.userData.length?c=e.userData.readUInt8(0):(r=e.userData.readUInt8(0),c=e.userData.readUInt8(1)),2==e.userData.length){var n=r;t.battery=n;}var s=c>>7&1,o=c>>6&1,i=c>>5&1,l=c>>4&1,u=15&c;t.pre_alarm=!!s,t.alarm=!!o,t.window=i?"closed":"open",t.pre_alarm_enabled_device=!!l,t.error=u,a=!0;}else if(208==e.rorg){var c=e.userData.readUInt8(0);t.battery=Math.round(c/100*255),t.battery_raw=c,a=!0;}return a?t:null;},Ea.prototype.executeCommand=function(e,t,a){if(t&&t.value){switch(t.value){case"alertOn":this._setAlarm(!0);break;case"alertOff":this._setAlarm(!1);break;case"alertToggle":this._states&&this._states.alarm_enabled?this._setAlarm(!this._states.alarm_enabled.value):this._setAlarm(!0);break;case"resetAlarm":this._reset_alarm_new="on",this.activeStateChange({pending:!0});break;case"resetPreAlarm":this._reset_pre_alarm_new="on",this.activeStateChange({pending:!0});break;case"preAlarmOn":this._setPreAlarm(!0);break;case"preAlarmOff":this._setPreAlarm(!1);break;case"preAlarmToggle":this._states&&this._states.pre_alarm_enabled?this._setPreAlarm(!this._states.pre_alarm_enabled.value):this.pre_alarm_enabled(!0);break;case"alarmTaskOn":this._setAlarmTask(!0);break;case"alarmTaskOff":this._setAlarmTask(!1);break;case"preAlarmTaskOn":this._setPreAlarmTask(!0);break;case"preAlarmTaskOff":this._setPreAlarmTask(!1);break;default:return void(a&&a(new Error("unknow command")));}a&&a();}else a&&a(new Error("command invalid"));},Ea.prototype._executePendingCommand=function(e,t,a){var r={AL:1,RSA:0,RSP:0,PAE:1},n=this._isAlarmActive();r.AL=n?1:0;var s=this._isPreAlarmActive();r.PAE=s?1:0,this._reset_alarm_new&&(r.RSA="on"==this._reset_alarm_new?1:0),this._reset_pre_alarm_new&&(r.RSP="on"==this._reset_pre_alarm_new?1:0);var o={pending:!1};1==r.RSP&&(o.pre_alarm=!1),1==r.RSA&&(o.alarm=!1),this._reset_alarm_new=null,this._reset_pre_alarm_new=null;var i=this;this._sendVLD(e,r,function(e){i.activeStateChange(o),t&&t(e);},a);},Ea.prototype._sendVLD=function(e,t,a,r){var n=this._senderID;this._senderID||(n=x.hub.m.enocean.SENDER_ID);var s,o=(1&t.AL)<<7|(1&t.RSA)<<6|(1&t.RSP)<<5|(1&t.PAE)<<4;s=r?new Buffer([0,o]):new Buffer([o]);var i=new x.hub.m.enocean.ESP3.Telegram.VLD(s,n,0);i.setDstId(this._address),e.sendTelegram(i,!0,function(e){a&&a(e);});},Ea.prototype._reportStates=function(e){if(e&&Object.keys(e).length>0){var t=require("x.hub.m.enocean.js").getRehauHandler();t&&(e.alarm_enabled=this.getBufferedState("alarm_enabled"),e.pre_alarm_enabled=this.getBufferedState("pre_alarm_enabled"),t.onReceiveWindowSensorStates(this,e));}},Ea.prototype._setAlarm=function(e){this.activeStateChange({alarm_enabled:e}),require("x.hub.m.enocean.js")._rehauHandler.setSmartGuardAlarm(this._address,e);},Ea.prototype._setPreAlarm=function(e){this.activeStateChange({pre_alarm_enabled:e}),require("x.hub.m.enocean.js")._rehauHandler.setSmartGuardPreAlarm(this._address,e);},Ea.prototype._setAlarmTask=function(e){this.activeStateChange({alarm_task_active:e});},Ea.prototype._setPreAlarmTask=function(e){this.activeStateChange({pre_alarm_task_active:e});},Ea.prototype._isAlarmActive=function(){var e=!0,t=!0;if(this._states&&this._states.alarm_enabled&&(void 0!==(t=this._states.alarm_enabled.value)&&null!=t||(t=!0)),!t)return!1;var a=!1;return this._states&&this._states.alarm_task_active&&(void 0!==(a=this._states.alarm_task_active.value)&&null!=a||(a=!1),e=a),e;},Ea.prototype._isPreAlarmActive=function(){var e=!0,t=!0;if(this._states&&this._states.pre_alarm_enabled&&(void 0!==(t=this._states.pre_alarm_enabled.value)&&null!=t||(t=!0)),!t)return!1;var a=!1;return this._states&&this._states.pre_alarm_task_active&&(void 0!==(a=this._states.pre_alarm_task_active.value)&&null!=a||(a=!1),e=a),e;},Ea.prototype._startTimeoutTimer=function(){var e=this;return setTimeout(function(){e.activeStateChange({timeout:!0});},36e5);},Ea.prototype._startPreAlarmTimer=function(){this._prealarmTO&&clearTimeout(this._prealarmTO);var e=this;this._prealarmTO=setTimeout(function(){e.activeStateChange({pre_alarm:!1});var t=e.getCurrentStates();e._reportStates(t);},1e4);},Ea.prototype._clearPreAlarmTimer=function(){this._prealarmTO&&(clearTimeout(this._prealarmTO),this._prealarmTO=null);},Ea.prototype._startAlarmTimer=function(){this._alarmTO&&clearTimeout(this._alarmTO);var e=this;this._alarmTO=setTimeout(function(){e.activeStateChange({alarm:!1});var t=e.getCurrentStates();e._reportStates(t);},12e4);},Ea.prototype._clearAlarmTimer=function(){this._alarmTO&&(clearTimeout(this._alarmTO),this._alarmTO=null);},Ea.prototype.toJSON=function(){return{type:"ENOCEAN",address:this._address,data:this._data,senderID:this._senderID,vendor:this._vendor,virtual:this._virtual,params:this._params,hopCount:this._hopCount,saLearnMode:this._saLearnMode,originalEEP:this._originalEEP};},Ea.prototype.fromJSON=function(e){return e&&e.address&&e.data?e.data!=this._data?null:(this._address=e.address,this._senderID=e.senderID,this._vendor=e.vendor?e.vendor:this._vendor,this._virtual=!!e.virtual,this._params=e.params,this._hopCount=e.hopCount,this._saLearnMode=e.saLearnMode,e.originalEEP&&(this._originalEEP=e.originalEEP),this.setDefaultParams(),this):null;},Ea.prototype.toDBJSON=function(){return{id:this._address,senderID:this._senderID,eep:this._data,vendor:this._vendor,params:this._params,virtual:this._virtual,hopCount:this._hopCount,saLearnMode:this._saLearnMode,originalEEP:this._originalEEP};},Ea.prototype.fromDBJSON=function(e){return e&&e.id&&e.eep?e.eep!=this._data?null:(this._address=e.id,this._senderID=e.senderID,this._vendor=e.vendor?e.vendor:this._vendor,this._virtual=!!e.virtual,this._params=e.params,this._hopCount=e.hopCount,this._saLearnMode=e.saLearnMode,e.originalEEP&&(this._originalEEP=e.originalEEP),this.setDefaultParams(),this):null;};var ka=function ka(e){Ea.call(this,e),this._data="d2-06-10";};(ka.prototype=new Ea()).constructor=ka;var xa=function xa(e){Ea.call(this,e),this._data="d2-06-ff";};(xa.prototype=new Ea()).constructor=xa,xa.prototype.evalTelegram=function(e){var t={},a=!1;if(210==e.rorg){var r;if(1==e.userData.length?u=e.userData.readUInt8(0):(r=e.userData.readUInt8(0),u=e.userData.readUInt8(1)),2==e.userData.length){var n=r;t.battery=n;}var s=u>>7&1,o=u>>6&1,i=u>>4&1,l=u>>2&3;t.pre_alarm=!!s,t.alarm=!!o,t.window=l?"closed":"open",t.pre_alarm_enabled_device=!!i,0==l?t.window="closed":1==l?t.window="tilted":3==l&&(t.window="open"),a=!0;}else if(208==e.rorg){var u=e.userData.readUInt8(0);t.battery=u,a=!0;}return a?t:null;};var Aa=function Aa(e){xa.call(this,e),this._data="smartguard2",this._eepAlias="d2-06-11";};(Aa.prototype=new xa()).constructor=Aa,Aa.prototype.evalTelegram=function(e){var t={},a=!1;if(210==e.rorg){var r;if(1==e.userData.length?c=e.userData.readUInt8(0):(r=e.userData.readUInt8(0),c=e.userData.readUInt8(1)),2==e.userData.length){var n=r;t.battery=n;}var s=c>>7&1,o=c>>6&1,i=c>>5&1,l=c>>4&1,u=c>>3&3;t.pre_alarm=!!s,t.alarm=!!o,t.window=i?"closed":"open",t.pre_alarm_enabled_device=!!l,1==i?t.window="closed":0==i&&(t.window="open"),1==u&&(t.window="tilted"),a=!0;}else if(208==e.rorg){var c=e.userData.readUInt8(0);t.battery=c,a=!0;}return a?t:null;};var Oa=function Oa(e){gt.call(this,e),this._data="afriso_water_con",this._vendor="afriso",this._eepAlias="a5-30-03";};(Oa.prototype=new gt()).constructor=Oa,Oa.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(1==(a>>3&1)){var s=n;t.temperature=(255-s)/255*40,t.temperature_raw=s;var o=r>>4&1;t.water=0==o;}}return t;};var Ca=function Ca(e){v.call(this,e),this._data="afriso_water_eco",this._vendor="afriso",this._eepAlias="f6-05-01";};(Ca.prototype=new v()).constructor=Ca,Ca.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){e.t21;var a=e.nu;e.userData,1==a?t.water="true":0==a&&(t.water="false");}return t;},Ca.prototype.onLearn=function(){this._states.water={value:!1,time:new Date().getTime()};};var Pa=function Pa(e){gt.call(this,e),this._data="afriso_asd_10",this._vendor="afriso",this._eepAlias="a5-30-03";};(Pa.prototype=new gt()).constructor=Pa,Pa.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(1==(a>>3&1)){var s=n;t.temperature=(255-s)/255*40,t.temperature_raw=s;var o=r>>4&1;t.smoke=0==o;}}return t;};var Ra=function Ra(e){m.call(this,e),this._data="hoppe_door",this._vendor="hoppe",this._eepAlias="f6-10-00";};Ra.STATES=["door"],(Ra.prototype=new m()).constructor=Ra,Ra.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a=e.userData,r=parseInt("11010000",2),n=parseInt("11000000",2),s=parseInt("11110000",2),o=parseInt("11110000",2);parseInt("11110000",2),parseInt("11010000",2),0==(a&r^n)?t.door="open":0==(a&s^o)&&(t.door="closed"),t.handle_raw=a;}return t;};var Ba,Na,Ua=(Na=function Na(t){e.call(this,t),this._data="gp",this._gpInfo=null;},(Na.prototype=new e()).constructor=Na,Na.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.gpInfo=this._gpInfo,t;},Na.prototype.fromJSON=function(t){return e.prototype.fromJSON.call(this,t)?(t&&t.gpInfo&&(this._gpInfo=t.gpInfo),this):null;},Na.prototype.toDBJSON=function(){var t=e.prototype.toDBJSON.call(this);return t.gpInfo=this._gpInfo,t;},Na.prototype.fromDBJSON=function(t){return e.prototype.fromDBJSON.call(this,t)?(t&&t.gpInfo&&(this._gpInfo=t.gpInfo),this):null;},Na),Ma=(Ba=function Ba(e){Ua.call(this,e),this._data="afriso_ais_10",this._vendor="afriso",this._eepAlias="gp";},(Ba.prototype=new Ua()).constructor=Ba,Ba.prototype.isGPMatch=function(e,t){return 45==e&&8==t;},Ba.prototype.evalTelegram=function(e){var t={};if(178==e.rorg){var a=e.data.readUInt8(0)>>7&1,r=e.data.readUInt8(0)>>6&1,n=e.data.readUInt8(0)>>5&1;t.alarm=1==a?"on":"off",t.active=1==r?"on":"off",t.powerAlarm=1==n?"alarm":"no_change";}return t;},Ba.prototype.executeCommand=function(e,t,a){if(t&&t.value){switch(t.value){case"arming":this._setActive(e,!0,a);break;case"disarming":this._setActive(e,!1,a);break;case"toggleArming":this._states&&this._states.active?this._setActive(e,"off"==this._states.active.value,a):this._setActive(e,!0,a);break;case"alarmOn":this._setAlarm(e,!0,a);break;case"alarmOff":this._setAlarm(e,!1,a);break;case"toggleAlarm":this._states&&this._states.alarm?this._setAlarm(e,"off"==this._states.alarm.value,a):this._setAlarm(e,!1,a);break;default:return void(a&&a(new Error("unknow command")));}a&&a();}else a&&a(new Error("command invalid"));},Ba.prototype._setActive=function(e,t,a){var r=!1;this._states&&this._states.alarm&&"on"==this._states.alarm.value&&(r=!0),this._sendGPCD(e,r,t,a);},Ba.prototype._setAlarm=function(e,t,a){var r=!0;this._states&&this._states.active&&"off"==this._states.active.value&&(r=!1),this._sendGPCD(e,t,r,a);},Ba.prototype._sendGPCD=function(e,t,a,r){var n=this._senderID;this._senderID||(n=x.hub.m.enocean.SENDER_ID);var s=0;t&&(s|=128),a&&(s|=64);var o=new Buffer(1);o.writeUInt8(s,0);var i=new x.hub.m.enocean.ESP3.Telegram.GP_CD(o,n,0);i.setDstId(this._address),e.sendTelegram(i,!0,function(e){r&&r(e);});},Ba),Fa=function(){var e=function e(_e11){oe.call(this,_e11),this._data="eltako_tf_ttb",this._vendor="eltako",this._eepAlias="a5-07-01",this._params={reset_timeout:300};};(e.prototype=new oe()).constructor=e,e.prototype.evalTelegram=function(e){return 246==e.rorg?s.prototype.evalTelegram.call(this,e):165==e.rorg?oe.prototype.evalTelegram.call(this,e):{};},e.prototype.checkStateChange=function(e){return e.button?s.prototype.checkStateChange.call(this,e):oe.prototype.checkStateChange.call(this,e);},e.prototype.fromJSON=function(e){return oe.prototype.fromJSON.call(this,e),this._params={reset_timeout:300},this;};var t=function t(e){gt.call(this,e),this._data="eltako_tf_smoke",this._vendor="eltako",this._eepAlias="a5-30-03";};t.STATES=["temperature","temperature_raw","smoke","smoke_raw"],(t.prototype=new gt()).constructor=t,t.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(e.userData.readUInt8(0),1==(a>>3&1)){var s=n;t.temperature=parseFloat(((255-s)/255*40).toFixed(1)),t.temperature_raw=s;var o=r;t.smoke=15==o,t.smoke_raw=o;}}return t;};var a=function a(e){m.call(this,e),this._data="eltako_tf_contact",this._vendor="eltako",this._eepAlias="d5-00-01";};a.STATES=["contact","contact_raw","voltage","voltage_raw"],(a.prototype=new y()).constructor=a,a.prototype.evalTelegram=function(e){var t={};if(213==e.rorg){if(1==((r=e.userData)>>3&1)){var a=1&r;t.contact=a?"closed":"open",t.contact_raw=a;}}else if(165==e.rorg){var r=e.userData.readUInt8(3),n=(e.userData.readUInt8(2),e.userData.readUInt8(1)),s=e.userData.readUInt8(0);if(1==(r>>3&1)){var o=n;t.voltage=parseFloat(o/255*5).toFixed(1),t.voltage_raw=o;var i=s;t.energy=parseFloat(i/255*5).toFixed(1),t.energy_raw=i;}}return t;};var r=function r(e){Ht.call(this,e),this._data="eltako_motion2",this._vendor="eltako",this._eepAlias="a5-08-01";};r.STATES=["voltage","voltage_raw","illumination","illumination_raw","state","state_raw"],(r.prototype=new Ht()).constructor=r,r.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=(e.userData.readUInt8(2),e.userData.readUInt8(1)),n=e.userData.readUInt8(0);if(1==(a>>3&1)){var s=n;t.voltage=parseFloat((s/255*5.1).toFixed(1)),t.voltage_raw=s;var o=r;t.illumination=parseFloat((o/255*510).toFixed(1)),t.illumination_raw=o;var i=a;switch(i){case 13:t.state="on";break;case 15:t.state="off";}t.motion_raw=i;}}return t;};var n=function n(e){oe.call(this,e),this._data="eltako_tf_motion",this._vendor="eltako",this._eepAlias="a5-07-01";};n.STATES=["motion","motion_raw"],(n.prototype=new oe()).constructor=n,n.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2);if(1==(a>>3&1)){var n=r;t.motion=200==n||255==n,t.motion_raw=n;}}return t;};var o=function o(e){St.call(this,e),this._data="eltako_tf_input",this._vendor="eltako",this._eepAlias="a5-38-08";};o.STATES=["state","state_raw"],(o.prototype=new St()).constructor=o,o.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3);1==(a>>3&1)&&(t.input=8!=a,t.input_raw=a);}return t;};var i=function i(e){Oe.call(this,e),this._data="eltako_tf_thermo",this._vendor="eltako",this._eepAlias="a5-10-06";};i.STATES=["setpoint","setpoint_raw","temperature","temperature_raw","night_reduce","night_reduce_raw"],(i.prototype=new ca()).constructor=i,i.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1);if(e.userData.readUInt8(0),1==(a>>3&1)){var s=n;t.setpoint=parseFloat((s/255*40).toFixed(1)),t.setpoint_raw=s;var o=r;t.temperature=parseFloat(((255-o)/255*40).toFixed(1)),t.temperature_raw=o;}}return t;};var l=function l(e){$t.call(this,e),this._data="eltako_tf_lux";};(l.prototype=new $t()).constructor=l;var u=function u(e){St.call(this,e),this._data="eltako_dimmer_knob",this._vendor="eltako",this._eepAlias="a5-38-08";};u.STATES=["state","dimmerLevel"],(u.prototype=new St()).constructor=u,u.prototype.evalTelegram=function(e){var t={};if(165==e.rorg){var a=e.userData.readUInt8(3),r=e.userData.readUInt8(2),n=e.userData.readUInt8(1),s=e.userData.readUInt8(0);if(1==(a>>3&1)&&2===s){var o=n;t.dimmerLevel=o;var i=r;t.ramp=i;var l=a>>2&1;t.dim_range=l?"relative":"absolute";var u=a>>1&1;t.store_final_value=u;var c=1&a;t.state=c?"on":"off";}}return t;};var c=function c(e){qt.call(this,e),this.TEACH_IN_VARIATION=3,this._data="eltako_tf_alarm";};(c.prototype=new qt()).constructor=c,c.prototype.evalTelegram=function(e){var t={};if(246==e.rorg)switch(e.userData){case 48:t.active=!0;break;case 16:t.active=!1;}else if(165==e.rorg){var a=e.userData.readUInt8(3);8==a?t.alarm="ok":9==a&&(t.alarm="alarm");}return t;},c.prototype.executeCommand=function(e,t,a){if(t&&t.value){var r=null;switch(t.value){case"triggerAlarm":r=new Buffer([1,0,0,9]);break;case"deactivate":r=new Buffer([1,0,0,12]);break;case"activate":r=new Buffer([1,0,0,8]);break;default:a&&a(new Error("unknow command"));}var n=this._senderID;this._senderID||(n=x.hub.m.enocean.SENDER_ID);var s=new x.hub.m.enocean.ESP3.Telegram.BS4(r,n,0);s.setDstId(this._address),e.sendTelegram(s,!0,function(e){a&&a(e);});}else a&&a(new Error("command invalid"));};var h=function h(e){ta.call(this,e),this._data="eltako_f6t",this._vendor="eltako",this.BUTTONS=["buttonCO","buttonCI","buttonBO","buttonBI","buttonAO","buttonAI"];};return h.STATES=["buttonCO","buttonCI","buttonBO","buttonBI","buttonAO","buttonAI"],(h.prototype=new ta()).constructor=h,h.prototype.evalTelegram=function(e){var t={};if(246==e.rorg){var a=parseInt(this._address,16),r=e.senderID?parseInt(e.senderID,16):null;if(r&&r==a+1)switch(e.userData){case 112:t.buttonCI="pressed";break;case 80:t.buttonCO="pressed";break;case 0:for(var n=0;n<this.BUTTONS.length;n++)this.BUTTONS[n]&&(t[this.BUTTONS[n]]="released");}else switch(e.userData){case 112:t.buttonAI="pressed";break;case 80:t.buttonAO="pressed";break;case 48:t.buttonBI="pressed";break;case 16:t.buttonBO="pressed";break;case 0:for(n=0;n<this.BUTTONS.length;n++)this.BUTTONS[n]&&(t[this.BUTTONS[n]]="released");}}return t;},{TF_TTB:e,TF_RWB:t,TF_FKB:a,TF_BHSB:n,TF_BHSB_FBH:r,TF_Input:o,TF_Thermo:i,TF_Lux:l,Dimmer_Knob:u,TF_Alarm:c,Eltako_F6T:h};}(),La={"f6-??-??":n,"f6-01-01":s,"f6-02-01":o,"f6-02-02":i,"f6-02-03":l,"f6-02-04":u,"f6-03-01":c,"f6-03-02":h,"f6-04-01":_,"f6-04-02":p,"f6-05-00":d,"f6-05-01":v,"f6-05-02":f,"f6-10-00":m,"f6-10-01":g,"d5-xx-xx":a,"d5-??-??":w,"d5-00-01":y,"f6-so-da":r,"a5-??-??":S,"a5-02-01":T,"a5-02-02":I,"a5-02-03":D,"a5-02-04":E,"a5-02-05":k,"a5-02-06":A,"a5-02-07":O,"a5-02-08":C,"a5-02-09":P,"a5-02-0a":R,"a5-02-0b":B,"a5-02-10":N,"a5-02-11":U,"a5-02-12":M,"a5-02-13":F,"a5-02-14":L,"a5-02-15":H,"a5-02-16":J,"a5-02-17":V,"a5-02-18":q,"a5-02-19":W,"a5-02-1a":j,"a5-02-1b":K,"a5-02-20":G,"a5-02-30":Q,"a5-04-01":z,"a5-04-02":X,"a5-04-03":Z,"a5-06-01":ee,"a5-06-02":te,"a5-06-03":ae,"a5-06-04":re,"a5-06-05":ne,"a5-07-01":oe,"a5-07-02":ie,"a5-07-03":le,"a5-08-01":ce,"a5-08-02":he,"a5-08-03":_e,"a5-09-02":de,"a5-09-04":ve,"a5-09-05":fe,"a5-09-06":me,"a5-09-07":ge,"a5-09-08":we,"a5-09-09":ye,"a5-09-0a":Se,"a5-09-0b":be,"a5-09-0c":Te,"a5-10-01":De,"a5-10-02":Ee,"a5-10-03":ke,"a5-10-04":xe,"a5-10-05":Ae,"a5-10-06":Oe,"a5-10-07":Ce,"a5-10-08":Pe,"a5-10-09":Re,"a5-10-0a":Be,"a5-10-0b":Ne,"a5-10-0c":Ue,"a5-10-0d":Me,"a5-10-10":Fe,"a5-10-11":Le,"a5-10-12":He,"a5-10-13":Je,"a5-10-14":Ve,"a5-12-00":Ge,"a5-12-01":Qe,"a5-12-02":Ye,"a5-12-03":ze,"a5-13-01":Ze,"a5-13-02":$e,"a5-13-03":et,"a5-13-04":tt,"a5-13-05":at,"a5-13-06":rt,"a5-14-01":nt,"a5-14-02":st,"a5-14-03":ot,"a5-14-04":it,"a5-14-05":lt,"a5-14-06":ut,"a5-14-07":ct,"a5-14-08":ht,"a5-14-09":_t,"a5-14-0a":pt,"a5-20-04":dt,"a5-30-01":ft,"a5-30-02":mt,"a5-30-03":gt,"a5-30-04":wt,"a5-38-08":St,"d2-??-??":Tt,"d2-01-00":Dt,"d2-01-01":Et,"d2-01-03":kt,"d2-01-11":xt,"d2-01-13":At,"d2-01-14":Ot,"d2-05-00":Pt,"d2-05-01":Rt,"d2-06-01":Nt,"d2-06-02":Ut,"d2-06-10":ka,"d2-06-ff":xa,smartguard2:Aa,"d2-06-50":t,"d2-20-00":Ft,eltako_dimmer:Wt,eltako_dimmer2:Gt,eltako_fsud:Qt,eltako_motion:Ht,eltako_contact:Lt,eltako_weather:Zt,eltako_lux:$t,eltako_lux2:ea,eltako_sender2:ra,eltako_sender4:na,eltako_button1:aa,eltako_button2:sa,eltako_button4:oa,eltako_blind:Yt,eltako_fsm60b:ia,eltako_fkf:la,eltako_fkc:ua,eltako_thermo:ca,eltako_ftr65hb:ha,eltako_futh55d:_a,eltako_futh65d:pa,eltako_ftr78s:da,eltako_powermeter:va,eltako_powermeter2:fa,eltako_fzs:ma,eltako_switch:Jt,eltako_relay:wa,eltako_relay2:ga,eltako_heat:ya,eltako_water_m3:Sa,eltako_water_m4:ba,eltako_tf_switch:qt,eltako_tf_dimmer:Kt,eltako_tf_blind:Xt,peha_switch:Ia,peha_powerswitch:Ta,peha_blind:Da,"bb-aa-cc":Ea,afriso_water_con:Oa,afriso_water_eco:Ca,afriso_asd_10:Pa,hoppe_door:Ra,gp:Ua,afriso_ais_10:Ma,eltako_tf_ttb:Fa.TF_TTB,eltako_tf_smoke:Fa.TF_RWB,eltako_tf_contact:Fa.TF_FKB,eltako_tf_motion:Fa.TF_BHSB,eltako_motion2:Fa.TF_BHSB_FBH,eltako_tf_thermo:Fa.TF_Thermo,eltako_tf_input:Fa.TF_Input,eltako_tf_lux:Fa.TF_Lux,eltako_dimmer_knob:Fa.Dimmer_Knob,eltako_tf_alarm:Fa.TF_Alarm,eltako_f6t:Fa.Eltako_F6T,parseDBJson:function parseDBJson(e){if(!e||!e.eep)return null;var t=this[e.eep];if(!t)return null;var a=new t();return a.fromDBJSON(e);},parseJson:function parseJson(e){if(!e||!e.data)return null;var t=this[e.data];if(!t)return null;var a=new t();return a.fromJSON(e);}};return La;}(),x.hub.m.enocean.SiegeniaHandler=function(){var e=function e(_e12){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.SiegeniaHandler"),this._esp3=_e12,this._esp3Listener=null,this._windowID=null,this._window=null,this._calibateListener=null;};return e.prototype.startCalibateWindow=function(e,t){if(this._calibateListener)t&&t(new Error("configuraion of window running"));else{this._calibateListener=t,this._windowID=e,this._window=new x.hub.m.enocean.profiles["d2-06-50"]();var a=this;this._esp3Listener={_onEOTelegram:function _onEOTelegram(e){var t=!1;if(a._windowID&&a._windowID==e.senderID?t=!0:a._windowID||210!=e.rorg||(t=!0),t&&a._calibateListener){var r=a._window.evalTelegram(e);r&&17==r.type&&a._calibateListener(null,e.senderID,r);}}},this._esp3.addListener(this._esp3Listener);}},e.prototype.stopCalibateWindow=function(){this._esp3Listener&&this._esp3.removeListener(this._esp3Listener),this._esp3Listener=null,this._calibateListener=null,this._windowID=null,this._window=null;},e.prototype.configWindow=function(e,t,a,r){t="FFFFFFFF",r||(r=x.hub.m.enocean.SENDER_ID),this._logger.log("info","config siegenia window:"+JSON.stringify(e)),this._logger.log("info","window id:"+t+" sender id:"+r);var n=parseInt(e.alive),s=parseInt(e.sync),o=parseInt(e.eep),i=parseInt(e.type),l=parseInt(e.alarm),u=parseInt(e.alarm_sens),c=[128,2,127,240,1,140,57,45,245],h=[192,13,127,242,49,0,0,2,n>>8&255],_=[193,255&n,0,1,2,s>>8&255,255&s,0,2],p=[194,1,o,0,3,1,i,0,4],d=[195,1,l,0,5,1,u,0,0],v=[128,2,127,240,2,140,57,45,245],f=this;this._logger.log("info","send config siegenia window (data1):"+new Buffer(c).toString("hex")),this._esp3._recomm.sendRawSysEx(new Buffer(c),t,r,function(e){e&&(f._logger.log("warn","config siegenia window error (data1):"+e.message+" ["+e.code+"]"),100!=e.code)?a&&a(e):(f._logger.log("info","send config siegenia window (data2):"+new Buffer(h).toString("hex")),f._esp3._recomm.sendRawSysEx(new Buffer(h),t,r,function(e){e&&(f._logger.log("warn","config siegenia window error (data2):"+e.message+" ["+e.code+"]"),100!=e.code)?a&&a(e):(f._logger.log("info","send config siegenia window (data3):"+new Buffer(_).toString("hex")),f._esp3._recomm.sendRawSysEx(new Buffer(_),t,r,function(e){e&&(f._logger.log("warn","config siegenia window error (data3):"+e.message+" ["+e.code+"]"),100!=e.code)?a&&a(e):(f._logger.log("info","send config siegenia window (data4):"+new Buffer(p).toString("hex")),f._esp3._recomm.sendRawSysEx(new Buffer(p),t,r,function(e){e&&(f._logger.log("warn","config siegenia window error (data4):"+e.message+" ["+e.code+"]"),100!=e.code)?a&&a(e):(f._logger.log("info","send config siegenia window (data5):"+new Buffer(d).toString("hex")),f._esp3._recomm.sendRawSysEx(new Buffer(d),t,r,function(e){e&&(f._logger.log("warn","config siegenia window error (data5):"+e.message+" ["+e.code+"]"),100!=e.code)?a&&a(e):(f._logger.log("info","send config siegenia window (data6):"+new Buffer(v).toString("hex")),f._esp3._recomm.sendRawSysEx(new Buffer(v),t,r,function(e){e&&f._logger.log("warn","config siegenia window error (data5):"+e.message+" ["+e.code+"]"),e&&100!=e.code?a&&a(e):a&&a();}));}));}));}));}));});},e;}(),x.hub.m.enocean.RehauHandler=function(){var e=function e(_e13){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.RehauHandler.InoventAccessory"),this._inoventID=_e13,this._humiditySensorID=null,this._co2SensorID=null,this._humRegulationActive=!1,this._co2RegulationActive=!1,this._humidityState=null,this._humidityLevel=0,this._co2State=null,this._co2Level=0;};e.prototype.getHumiditySensorID=function(){return this._humiditySensorID;},e.prototype.setHumiditySensorID=function(e){this._humiditySensorID=e;},e.prototype.getCo2SensorID=function(){return this._co2SensorID;},e.prototype.setCo2SensorID=function(e){this._co2SensorID=e;},e.prototype.activateSensorRegulation=function(e){if(5==e)this._humRegulationActive=!0,this._co2RegulationActive=!1;else{if(6!=e)return this._humRegulationActive=!1,void(this._co2RegulationActive=!1);this._humRegulationActive=!1,this._co2RegulationActive=!0;}this._humidityLevel=0,this._co2Level=0,this._humRegulationActive&&this._humiditySensorID&&null!=this._humidityState&&this.executeHumidityRegulation(this._humidityState),this._co2RegulationActive&&this._co2SensorID&&null!=this._co2State&&this.executeCo2Regulation(this._co2State);},e.prototype.deactivateSensorRegulation=function(){this._humRegulationActive=!1,this._co2RegulationActive=!1,this._humidityLevel=0,this._co2Level=0;},e.prototype.executeHumidityRegulation=function(e){if(this._humidityState=e,this._logger.log("trace","["+this._inoventID+"] receive hum:"+e),this._humRegulationActive){var t=this._calculateHumidityLevel(e);this._logger.log("trace","["+this._inoventID+"] target level:"+t),(!this._humidityLevel||t!=this._humidityLevel&&this._exceedHumidityHysteresis(this._humidityLevel,e))&&this._changeHumLevel(t);}},e.prototype._calculateHumidityLevel=function(e){return e<=50?1:e<=60?2:e<=70?3:4;},e.prototype._exceedHumidityHysteresis=function(e,t){switch(e){case 1:return t>=55;case 2:return t<=45||t>=65;case 3:return t<=55||t>=75;case 4:return t<=65;}},e.prototype._changeHumLevel=function(e){var t=this;require("x.hub.m.enocean.js").executeCommand({address:this._inoventID},{value:"setHumLevel"+e},function(a){a&&a.error||(t._humidityLevel=e);});},e.prototype.executeCo2Regulation=function(e){if(this._co2State=e,this._logger.log("trace","["+this._inoventID+"] receive co2:"+e),this._co2RegulationActive){var t=this._calculateCo2Level(e);this._logger.log("trace","["+this._inoventID+"] target level:"+t),(!this._co2Level||t!=this._co2Level&&this._exceedCo2Hysteresis(this._co2Level,e))&&this._changeCo2Level(t);}},e.prototype._calculateCo2Level=function(e){return e<=600?1:e<=1e3?2:e<=1500?3:4;},e.prototype._exceedCo2Hysteresis=function(e,t){switch(e){case 1:return t>=700;case 2:return t<=500||t>=1100;case 3:return t<=900||t>=1600;case 4:return t<=1400;}},e.prototype._changeCo2Level=function(e){var t=this;require("x.hub.m.enocean.js").executeCommand({address:this._inoventID},{value:"setCo2Level"+e},function(a){a&&a.error||(t._co2Level=e);});},e.prototype.toJSON=function(){return{humidity:this._humiditySensorID,co2:this._co2SensorID};},e.prototype.fromJSON=function(e){e&&(this._humiditySensorID=e.humidity,this._co2SensorID=e.co2);};var t=function t(e){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.RehauHandler.WindowAlarm"),this._handler=e,this._active=!1,this._sensors={};};t.prototype.setAlarm=function(e){this._logger.log("trace","set alarm active:"+e),this._active=e;},t.prototype.getAlarm=function(){return this._active;},t.prototype.onReceiveWindowSensorStates=function(e,t){if(this._logger.log("trace","receive window:"+e.getAddress()+" states:"+JSON.stringify(t)),this._active){var a=e.getAddress(),r=this._sensors[a];if(r||(this._sensors[a]={lastEvent:"IDLE"},r=this._sensors[a]),this._logger.log("trace","last event for window:"+e.getAddress()+" is:"+r.lastEvent),t){if(t.pre_alarm&&"PRE_ALARM"!=r.lastEvent)return r.lastEvent="PRE_ALARM",this._logger.log("trace","window:"+e.getAddress()+" pre_alarm triggered"),void this.triggerAlarm(!0);if(t.alarm&&"ALARM"!=r.lastEvent)return r.lastEvent="ALARM",this._logger.log("trace","window:"+e.getAddress()+" alarm triggered"),void this.triggerAlarm();t.alarm||t.pre_alarm||(this._logger.log("trace","new event for window:"+e.getAddress()+" is:IDLE and stop timer"),r.lastEvent="IDLE");}}},t.prototype.triggerAlarm=function(e){require("x.hub.taskman.js").getRehauAlarmTaskManager().onWindowSensorAlarmTriggered(e);};var a=function a(e){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.RehauHandler.SmartguardSetting"),this._smartguardID=e,this._alarmActive=!0,this._prealarmActive=!0;};a.prototype.isAlarmActive=function(){return!!this._alarmActive;},a.prototype.isPreAlarmActive=function(){return!!this._prealarmActive;},a.prototype.setAlarm=function(e){this._alarmActive=!!e;},a.prototype.setPreAlarm=function(e){this._prealarmActive=!!e;},a.prototype.toJSON=function(){return{alarm:this._alarmActive,pre_alarm:this._prealarmActive};},a.prototype.fromJSON=function(e){e&&(this._alarmActive=e.alarm,this._prealarmActive=e.pre_alarm);};var r=function r(){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.RehauHandler"),this._mainHandler=null,this._windowAlarm=new t(this),this._inoventAccessories={},this._smartguardSettings={};};return r.prototype.REHAU_FILE="enocean_rehau.json",r.prototype.init=function(e,t){this._logger.log("trace","init");var a=this;if(this._mainHandler=e,e){var r=e.getDeviceHandler();r&&r.on("deleteDevice",function(e){a.onDeleteDevice(e);});}this._loadInoventAccessories(function(e,r,n){e&&a._logger.log("warn","init error:"+e.message),r&&(a._inoventAccessories=r),n&&(a._smartguardSettings=n),t&&t();});},r.prototype.getInoventAccessory=function(e){return e?this._inoventAccessories[e]:null;},r.prototype.deleteInoventAccessory=function(e,t){e&&this._inoventAccessories[e]?(delete this._inoventAccessories[e],this._saveData(t)):t&&t();},r.prototype.getSmartguardSetting=function(e){return e?this._smartguardSettings[e]:null;},r.prototype.deleteSmartguardSetting=function(e,t){e&&this._smartguardSettings[e]?(delete this._smartguardSettings[e],this._saveData(t)):t&&t();},r.prototype.setHumidityAccessory=function(t,a,r){if(t){var n=this.getInoventAccessory(t);if(n||(n=new e(t),this._inoventAccessories[t]=n),a&&"string"==typeof a&&"{"==a.charAt(0))try{a=JSON.parse(a);}catch(t){return void(r&&r(new Error("invalid humiditySensorID json: "+t.message)));}n.setHumiditySensorID(a),this._saveData(r);}else r&&r(new Error("inoventID is null"));},r.prototype.setCo2Accessory=function(t,a,r){if(t){var n=this.getInoventAccessory(t);n||(n=new e(t),this._inoventAccessories[t]=n),n.setCo2SensorID(a),this._saveData(r);}else r&&r(new Error("inoventID is null"));},r.prototype.activateSensorRegulation=function(e,t){var a=this.getInoventAccessory(e);a&&a.activateSensorRegulation(t);},r.prototype.deactivateSensorRegulation=function(e){var t=this.getInoventAccessory(e);t&&t.deactivateSensorRegulation();},r.prototype.isWindowOpen=function(){var e=this._mainHandler.getDeviceHandler(),t=e.findDeviceWithData("bb-aa-cc"),a=e.findDeviceWithData("d2-06-10"),r=e.findDeviceWithData("d2-06-ff"),n=e.findDeviceWithData("smartguard2");a&&(t=t.concat(a)),r&&(t=t.concat(r)),n&&(t=t.concat(n));for(var s=!1,o=0;o<t.length;o++){var i=t[o];if(i&&"open"==i.getBufferedState("window")){s=!0;break;}}return s;},r.prototype.setAlarm=function(e,t){this._windowAlarm.setAlarm(e);var a=this._mainHandler.getDeviceHandler(),r=a.findDeviceWithData("bb-aa-cc"),n=a.findDeviceWithData("d2-06-10"),s=a.findDeviceWithData("d2-06-ff"),o=a.findDeviceWithData("smartguard2");n&&(r=r.concat(n)),s&&(r=r.concat(s)),o&&(r=r.concat(o));for(var i=this._mainHandler.getESP3(),l=0;l<r.length;l++){var u=r[l];u&&(u.executeCommand(i,{value:e?"alarmTaskOn":"alarmTaskOff"}),u.executeCommand(i,{value:e?"preAlarmTaskOn":"preAlarmTaskOff"}));}t&&t();},r.prototype.getAlarm=function(){return this._windowAlarm.getAlarm();},r.prototype.setSmartGuardAlarm=function(e,t,r){if(e){var n=this._smartguardSettings[e];n||(n=new a(e),this._smartguardSettings[e]=n),n.setAlarm(t),this._saveData(r);}else r&&r(new Error("smartguardID invalid"));},r.prototype.setSmartGuardPreAlarm=function(e,t,r){if(e){var n=this._smartguardSettings[e];n||(n=new a(e),this._smartguardSettings[e]=n),n.setPreAlarm(t),this._saveData(r);}else r&&r(new Error("smartguardID invalid"));},r.prototype.onReceiveWindowSensorStates=function(e,t){this._windowAlarm.onReceiveWindowSensorStates(e,t);},r.prototype.onDeleteDevice=function(e){if(e){var t=e.getAddress();if(t)if(this.getInoventAccessory(t))this.deleteInoventAccessory(t);else if(this.getSmartguardSetting(t))this.deleteSmartguardSetting(t);else{var a=!1;for(var r in this._inoventAccessories){var n=this._inoventAccessories[r];n&&(n.getHumiditySensorID()==t&&(n.setHumiditySensorID(null),a=!0),n.getCo2SensorID()==t&&(n.setCo2SensorID(null),a=!0));}a&&this._saveData();}}},r.prototype.onDeviceEvent=function(e,t){if(e){var a="ENOCEAN";e.getType&&(a=e.getType()),a||(a="ENOCEAN");var r=e.getAddress();if(r)if("HM"==a){if(!t)return;for(var n in this._logger.log("trace","process homematic device ("+r+") events:"+JSON.stringify(t)),this._inoventAccessories)if(l=this._inoventAccessories[n]){var s=l.getHumiditySensorID();s&&s.key&&s.address==r&&null!=(i=t[s.key])&&null!=i&&l.executeHumidityRegulation(i);var o=l.getHumiditySensorID();o&&o.key&&o.address==r&&null!=(i=t[o.key])&&null!=i&&l.executeCo2Regulation(i);}}else if("ENOCEAN"==a&&e.getData){this._logger.log("trace","process enocean device ("+r+") events:"+JSON.stringify(t));var i=null;switch(e.getData()){case"a5-04-01":case"a5-04-03":case"a5-10-12":i=function(e){for(var t=null,a=0;a<e.length;a++){var r=e[a];if(r&&"humidity"==r.key){t=r.value;break;}}return t;}(t);break;case"a5-09-08":case"a5-09-09":i=function(e){for(var t=null,a=0;a<e.length;a++){var r=e[a];if(r&&"co2"==r.key){t=r.value;break;}}return t;}(t);break;default:return;}if(null==i||null==i)return;for(var n in this._inoventAccessories){var l;(l=this._inoventAccessories[n])&&(l.getHumiditySensorID()==r&&l.executeHumidityRegulation(i),l.getCo2SensorID()==r&&l.executeCo2Regulation(i));}}}},r.prototype._loadInoventAccessories=function(e){var t=this;this._loadFile(function(a,r){if(a)e&&e(a);else{var n=t._jsonToAccessoriesMap(r),s=t._jsonToSmartGuardSettingsMap(r);e&&e(null,n,s);}});},r.prototype._jsonToAccessoriesMap=function(t){if(!t||!t.inovent)return{};var a={};for(var r in t.inovent){var n=t.inovent[r];if(n){var s=new e(r);s.fromJSON(n),a[r]=s;}}return a;},r.prototype._jsonToSmartGuardSettingsMap=function(e){if(!e||!e.smartguard)return{};var t={};for(var r in e.smartguard){var n=e.smartguard[r];if(n){var s=new a(r);s.fromJSON(n),t[r]=s;}}return t;},r.prototype._loadFile=function(e){var t=this._getFilePath();fs_extra.ensureFile(t,function(a){a?e&&e(a):fs_extra.readFile(t,"utf8",function(t,a){if(t)e&&e(t);else if(a)try{var r=JSON.parse(a);e&&e(null,r);}catch(t){e&&e(t);}else e&&e(null,{});});});},r.prototype._getFilePath=function(){var e=require("x.hub.fileman.js").fileManager,t=require("path"),a=(require("fs"),e.getUserRootDataPath());return t.resolve(a,this.REHAU_FILE);},r.prototype._saveData=function(e){var t={inovent:this._accessoriesMapToJson(this._inoventAccessories)||{},smartguard:this._settingsMapToJson(this._smartguardSettings)||{}};this._saveFile(t,function(t){e&&e(t);});},r.prototype._accessoriesMapToJson=function(e){if(!e)return{};var t={};for(var a in e){var r=e[a];if(r){var n=r.toJSON();t[a]=n;}}return t;},r.prototype._settingsMapToJson=function(e){if(!e)return{};var t={};for(var a in e){var r=e[a];if(r){var n=r.toJSON();t[a]=n;}}return t;},r.prototype._saveFile=function(e,t){var a=this._getFilePath();fs_extra.writeFile(a,JSON.stringify(e,null,2),function(e){t&&t(e);});},r;}(),x.hub.m.enocean.SDK=function(){var e=function e(_e14){this._handler=_e14;};return e.prototype.send_SA_RD_LEARNEDCLIENTS=function(e,t){var a=new x.hub.m.enocean.ESP3.SA_COMMAND.SA_RD_LEARNEDCLIENTS();this._handler._esp3.sendSACommand(a,!0,function(e,a){t&&t(e,a);});},e.prototype.send_SA_WR_RESET=function(e,t){if(e&&e.saClientId){var a=new x.hub.m.enocean.ESP3.SA_COMMAND.SA_WR_RESET(e.saClientId);this._handler._esp3.sendSACommand(a,!0,function(e,a){t&&t(e,a);});}else t&&t(new Error("params invalid"));},e.prototype.send_SA_WR_POSTMASTER=function(e,t){if(e){e.mailboxCount||(e.mailboxCount=0);var a=new x.hub.m.enocean.ESP3.SA_COMMAND.SA_WR_POSTMASTER(e.mailboxCount);this._handler._esp3.sendSACommand(a,!0,t);}else t&&t(new Error("params invalid"));},e.prototype.send_CO_WR_REPEATER=function(e,t){if(e){e.enable||(e.enable=0),e.level||(e.level=0);var a=new x.hub.m.enocean.ESP3.COMMAND_COMMAND.CO_WR_REPEATER(e.enable,e.level);this._handler._esp3.sendCommandCommand(a,!0,t);}else t&&t(new Error("params invalid"));},e;}(),x.hub.m.enocean.Util={esp2toesp3:function esp2toesp3(e){if(!e)return null;if(!(e instanceof x.hub.m.enocean.ESP2.Telegram))return null;var t=e.toPayload();if(!t)return null;var a=t.getData(),r=t.getSenderID(),n=t.getStatus(),s=15&n;if(t instanceof x.hub.m.enocean.ESP2.Payload.RPS){a=a.readUInt8(0);var o=n>>5&1,i=n>>4&1;return new x.hub.m.enocean.ESP3.Telegram.RPS(a,r,o,i,s);}return t instanceof x.hub.m.enocean.ESP2.Payload.BS1?(a=a.readUInt8(0),new x.hub.m.enocean.ESP3.Telegram.BS1(a,r,s)):t instanceof x.hub.m.enocean.ESP2.Payload.BS4?new x.hub.m.enocean.ESP3.Telegram.BS4(a,r,s):null;},esp3toesp2:function esp3toesp2(e){if(!e)return null;if(!(e instanceof x.hub.m.enocean.ESP3.Telegram))return null;var t=null,a=e.userData,r=e.senderID;if(e instanceof x.hub.m.enocean.ESP3.Telegram.RPS){var n=e.t21<<5|e.nu<<4||e.rc;t=new x.hub.m.enocean.ESP2.Payload.RPS(a,r,n);}else e instanceof x.hub.m.enocean.ESP3.Telegram.BS1?(n=15&e.rc,t=new x.hub.m.enocean.ESP2.Payload.BS1(a,r,n)):e instanceof x.hub.m.enocean.ESP3.Telegram.BS4&&(n=15&e.rc,t=new x.hub.m.enocean.ESP2.Payload.BS4(a,r,n));if(t){var s=new x.hub.m.enocean.ESP2.TRT();return s.fromPayload(t),s;}return null;},buffer2esp3:function buffer2esp3(e){if(85!=e[0])return null;if(6>=e.length)return null;var t=(e[1]<<8)+e[2],a=e[3],r=e[5];if(e.length<t+a+7)return null;if(x.hub.m.enocean.CRC8(e.slice(1,5))!=r)return null;var n=e[t+a+6];if(x.hub.m.enocean.CRC8(e.slice(6,6+t+a))!=n)return null;var s={type:e[4],dataLen:t,optLen:a,radioType:e[6],data:e.slice(6,6+t),optData:e.slice(6+t,6+t+a),rawByte:e.slice(0,6+t+a+1).toString("hex")},o=new x.hub.m.enocean.ESP3.ESP3_Frame(s.type,s.data,s.optData);166!=s.radioType&&210!=s.radioType&&165!=s.radioType&&246!=s.radioType&&213!=s.radioType||(s.senderId=s.data.slice(t-5,t-1).toString("hex"));var i=o.toPacket();return i&&i instanceof x.hub.m.enocean.ESP3.RADIO_ERP1_Packet?i.toRadioTelegram():null;}},x.hub.m.enocean.USBHandler=function(){var e=function e(_e15){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.USBHandler"),this._handler=_e15,this._usbDevices=[],this._connectedESP3=null,this._connectedESP2=null;};return e.prototype.attachSerial=function(e){this._logger.log("debug","attach usb port:"+e);var t=this._usbDevices.length;this._usbDevices.push({port:e}),0==t&&this._attachNextDevice();},e.prototype.removeSerial=function(e){var t;this._logger.log("debug","remove usb port:"+e),this._connectedESP3&&this._connectedESP3.port==e&&(this._connectedESP3=null,(t=this._handler._esp3.getSerial())&&t.getPort()==e&&this._handler._esp3.removeSerial(e)),this._connectedESP2&&this._connectedESP2.port==e&&(this._connectedESP2=null,(t=this._handler._esp2.getSerial())&&t.getPort()==e&&this._handler._esp2.removeSerial(e));},e.prototype._attachNextDevice=function(){if(0!=this._usbDevices.length){var e=this._usbDevices[0],t=this;this._logger.log("debug","connect usb port:"+e.port),this._testESP3(e.port,function(a){if(!a)return t._connectedESP3=e,t._usbDevices.splice(0,1),void t._attachNextDevice();t._testESP2(e.port,function(a){if(!a)return t._connectedESP2=e,t._usbDevices.splice(0,1),void t._attachNextDevice();t._usbDevices.splice(0,1),t._attachNextDevice();});});}},e.prototype._testESP3=function(e,t){this._logger.log("debug","try esp3 on usb port:"+e);var a=this._handler._esp3;if(a.getSerial())return this._logger.log("debug","enocean usb device already exist"),void t(new Error("enocean usb device already exist"));var r=this;a.attachSerial(e,function(a){a?r._logger.log("debug",e+" is not a enocean usb device, error:"+a.message):r._logger.log("debug","success to connect to enocean usb device on port:"+e),t(a);});},e.prototype._testESP2=function(e,t){this._logger.log("debug","try esp2 on usb port:"+e);var a=this._handler._esp2;if(a.getSerial())return this._logger.log("debug","FGW14 device already exist"),void t(new Error("FGW14 device already exist"));var r=this;a.attachSerial(e,function(a){a?r._logger.log("debug",e+" is not a FGW14 gateway, error:"+a.message):r._logger.log("debug","connect to FGW14 on port "+e+" success"),t(a);});},e;}(),x.hub.m.enocean.Handler=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("x.hub.m.enocean.Handler"),this._secHandler=new this.SecurityHandler(this),this._deviceHandler=new this.DeviceHandler(this),this._esp3=new x.hub.m.enocean.ESP3(this),this._esp2=new x.hub.m.enocean.ESP2(this),this._learnHandler=new this.LearnHandler(this),this._siegeniaHandler=new x.hub.m.enocean.SiegeniaHandler(this._esp3),this._rehauHandler=new x.hub.m.enocean.RehauHandler(),this._trackers=[],this._sdk=new x.hub.m.enocean.SDK(this),this._usb=new x.hub.m.enocean.USBHandler(this);};return util.inherits(e,EventEmitter),e.prototype.Serial=x.hub.m.enocean.Serial,e.prototype.SENSOR_FILE="enocean.json",e.prototype.SECURITY_FILE="enocean_sec.json",e.prototype.profiles=x.hub.m.enocean.profiles,e.prototype.ESP2=x.hub.m.enocean.ESP2,e.prototype.ESP3=x.hub.m.enocean.ESP3,e.prototype.SecurityHandler=x.hub.m.enocean.SecurityHandler,e.prototype.LearnHandler=x.hub.m.enocean.LearnHandler,e.prototype.DeviceHandler=x.hub.m.enocean.DeviceHandler,e.prototype.getDeviceHandler=function(){return this._deviceHandler;},e.prototype.getRehauHandler=function(){return this._rehauHandler;},e.prototype.getESP3=function(){return this._esp3;},e.prototype.init=function(e){localStorage&&localStorage.getItem("x.hub.m.enocean.SENDER_ID")&&(x.hub.m.enocean.SENDER_ID=localStorage.getItem("x.hub.m.enocean.SENDER_ID")),localStorage&&localStorage.getItem("x.hub.m.enocean.ESP2_BAUDRATE")&&(this._esp2._baudrate=parseInt(localStorage.getItem("x.hub.m.enocean.ESP2_BAUDRATE")));var t=this,a=require("x.hub.eventbus.js");a.on("x.hub.peripheralman.ADD_ENOCEAN",function(e){console.log("ADD_ENOCEAN",e),t._usb.attachSerial(e.port);}),a.on("x.hub.peripheralman.REMOVE_ENOCEAN",function(e){console.log("REMOVE_ENOCEAN",e),t._usb.removeSerial(e.port);}),a.on("x.hub.peripheralman.ADD_SEIRAL",function(e){console.log("ADD_SEIRAL",e),e.type||t._usb.attachSerial(e.port);}),a.on("x.hub.peripheralman.REMOVE_SEIRAL",function(e){console.log("REMOVE_SEIRAL",e),e.type||t._usb.removeSerial(e.port);}),global.ENOCEAN_PORT&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&t._usb.attachSerial(global.ENOCEAN_PORT),global.ENOCEAN_FGW14_PORT&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&t._usb.attachSerial(global.ENOCEAN_FGW14_PORT),a.on("gatewayevent",function(e,a,r){if(e&&a&&"ENOCEAN"!=a.address&&"STA"==r){var n={_type:e.type,_adr:e.adr,getType:function getType(){return this._type;},getAddress:function getAddress(){return this._adr;}};t._rehauHandler.onDeviceEvent(n,e.state);}}),this._secHandler.init(function(){t._rehauHandler.init(t,function(){t._deviceHandler.init(function(){e&&e({});});});});},e.prototype.getSystems=function(){return["enocean"];},e.prototype.addStateDevice=function(e,t){t&&t({});},e.prototype.getAllStates=function(){var e=[],t=this._deviceHandler.getAllDevices();for(var a in t)if(t.hasOwnProperty(a)){var r=t[a];r&&e.push({device:r.toJSON(),states:r.getStatesBuffer()});}return e;},e.prototype.getStates=function(e){if(!e||!e.address)return null;var t=null,a=this._deviceHandler.getDevice(e.address.toLowerCase());return a&&(t=a.getStatesBuffer()),t;},e.prototype.getState=function(e,t,a){var r=this.getStates(e),n=null;return r&&void 0!==r[t]&&null!=r[t]?(n=r[t],a&&a({data:n})):a&&this.updateStates(e,function(e){e.error?a&&a(e):(e.data&&(n=r[t]),a({data:n}));}),n;},e.prototype.executeCommand=function(e,t,a){if(this._esp3._baseID){if(this._esp3._baseID.toLowerCase()==x.hub.m.enocean.SENDER_ID.toLowerCase()){if(e&&e.address){var r=e.address;r&&(r=r.toLowerCase());var n=this._deviceHandler.getDevice(r);n?n.executeCommand?n.executeCommand(this._esp3,t,function(e){a&&a({error:e});}):a&&a({error:new Error("device dese not support command")}):a&&a({error:new Error("no such device")});}else a&&a({error:new Error("device invalid")});}else a&&a({error:new Error("enocean stick has a different baseID")});}else a&&a({error:new Error("enocean stick not found")});},e.prototype.checkDeviceMatch=function(e,t){if(!(t&&t.device&&e&&e.device))return!1;var a=e.device.address;a&&(a=a.toLowerCase());var r=t.device.address;return r&&(r=r.toLowerCase()),a==r;},e.prototype.updateStates=function(e,t){t&&t({error:new Error("not supported yet")});},e.prototype.executeCommandLegacy=function(e,t,a,r){e?r&&r({error:new Error("not supported yet")}):this._esp3?t?this.executeCommand({address:t},{value:a},function(e){r&&r({error:e?e.error:null});}):r&&r({error:new Error("address invalid")}):r&&r({error:new Error("not inited")});},e.prototype.getAllStatesLegacy=function(e,t){var a=[],r=this.getAllStates(),n=this._secHandler.getUnsyncDevice(),s=this;r.forEach(function(e){if(e&&e.device&&e.states){var r=e.device.address,o={type:"ENOCEAN",adr:r,data:e.device.data,vendor:e.device.vendor,state:{}};for(var i in e.states)o.state[i]=e.states[i].value;s._secHandler.isSecureDevice(r)?(o.deviceProtocol="secure",n[r]?o.state.security_state="nok":o.state.security_state="ok"):o.deviceProtocol="normal",t&&"1"==t.config&&(o.senderID=e.device.senderID,o.virtual=e.device.virtual,o.params=e.device.params,r&&n[r]&&(o.rlc_unsync=!0)),a.push(o);}}),e&&e({data:a});},e.prototype.getEnoceanInfo=function(){var e={baseID:x.hub.m.enocean.SENDER_ID,usb_connected:null!=this._esp3._serial,usb_baseID:this._esp3._baseID,num_free_senderID:this._deviceHandler.getFreeSenderIdCount(),fgw14_connected:null!=this._esp2.getSerial(),fgw14_baudrate:this._esp2._baudrate};return e.fgw14_connected&&(e.fgw14_port=this._esp2.getSerial().getPort(),e.fgw14_baseID=this._esp2._baseID),e;},e.prototype.learnDevice=function(e,t){var a=e?e.senderID:null,r=e?e.data:null,n=e?e.vendor:null,s=e?e.address:null;if(s){var o=this._deviceHandler.findDevice(e);if(!o)return void(t&&t({error:new Error("device not found")}));var i=o.toJSON();r=i.data,n=i.vendor,a||(sednerID=i.senderID);}var l={};l.saLearnMode=e?e.saLearnMode:null,this._learnHandler.learn(r,s,a,n,null,function(e,a,r){if(e)t&&t({error:e});else{var n={};1==a?n.op=1:(n=r.toJSON()).op=0,t&&t({data:n});}},l);},e.prototype.learnSoda=function(e){if(this._esp3._serial){var t=this,a=setTimeout(function(){t._esp3.removeListener(r),e&&e({error:new Error("learn timeout")});},2e4),r={_onEOTelegram:function _onEOTelegram(n){if(246==n.rorg&&(192==n.userData||208==n.userData||240==n.userData)){clearTimeout(a),t._esp3.removeListener(r);var s={address:n.senderID,data:"f6-so-da",vendor:"soda"};t.addSensor(n.senderID,"f6-so-da","soda",null,function(t){t.error?e&&e(t):e&&e({data:s});});}}};this._esp3.addListener(r);}else e&&e({error:new Error("port not opened")});},e.prototype.teachinDevice=function(e,t){if(e){if(e.data){e.adr&&!e.address&&(e.address=e.adr);var a,r=this._deviceHandler.findDevice(e);a=r?r.toJSON():e,e.data==a.data?e.vendor&&e.vendor!=a.vendor?t&&t({error:new Error("device of another vendor with the same address exists")}):this._learnHandler.teachin(a.data,a.address,a.senderID,a.vendor,function(e,a,r){if(e)t&&t({error:e});else{var n={};a&&(n=a.toJSON()),r&&(n.op=r),t&&t({data:n});}}):t&&t({error:new Error("device of another type with the same address exists")});}else t&&t({error:new Error("data is null")});}else t&&t({error:new Error("query is null")});},e.prototype.generateVirtualDevice=function(e,t){this._deviceHandler.generateVirtual(e,function(e,a){t&&t({error:e,data:a?a.toJSON():null});});},e.prototype.setFGW14Baudrate=function(e,t){this._esp2?(localStorage.setItem("x.hub.m.enocean.ESP2_BAUDRATE",e),this._esp2._baudrate=e,t&&t({})):t&&t({error:{code:"01000",message:"no esp2 object"}});},e.prototype.sendToFGW14=function(e,t){var a,r;if(this._logger.log("trace","stm -> fgw14, forward esp3 telegram:"+e.toString("hex")),!this._esp2&&!this._esp2.getSerial())return this._logger.log("trace","stm -> fgw14, fgw14 not connected"),a=new x.hub.m.enocean.ESP3.Response(1),r=a.toPacket().toFrame().toBuffer(),void(t&&t(r));var n=x.hub.m.enocean.Util.buffer2esp3(e);if(!n)return this._logger.log("trace","stm -> fgw14, invalid esp3 telegram"),a=new x.hub.m.enocean.ESP3.Response(3),r=a.toPacket().toFrame().toBuffer(),void(t&&t(r));var s=x.hub.m.enocean.Util.esp3toesp2(n);if(!s)return this._logger.log("trace","stm -> fgw14, failed to convert esp3 telegram to esp2 telegram"),a=new x.hub.m.enocean.ESP3.Response(3),r=a.toPacket().toFrame().toBuffer(),void(t&&t(r));this._logger.log("trace","stm -> fgw14, convert to esp2 telegram:"+s.toBuffer().toString("hex"));var o=this;this._esp2.sendTelegram(s,null,function(e){o._logger.log("trace","stm -> fgw14, forward finish "+(e?"failed:"+e.messsage:"success")),a=new x.hub.m.enocean.ESP3.Response(0),r=a.toPacket().toFrame().toBuffer(),t&&t(r);});},e.prototype._onESP2Telegram=function(e){if("CA"==global.HARDWARE_VERSION){var t=x.hub.m.enocean.Util.esp2toesp3(e);if(t){var a=this,r=t.toPacket().toFrame().toBuffer();this._logger.log("trace","convert to esp3 telegram:"+JSON.stringify(t.toJSON())),this._logger.log("trace","convert to esp3:"+r.toString("hex")+" and forward to stm");var n=require("x.hub.v6.js").getSTM();n&&n.sendCommand(144,r,function(e){a._logger.log("trace","forward to stm result:"+JSON.stringify(e));});}}},e.prototype._onEOFrame=function(e,t){this._trackers.forEach(function(a){a.onFrame(e,t);});},e.prototype._onEOTelegram=function(e){this._trackers.forEach(function(t){t.onTelegram(e);});var t=e.senderID,a=this._deviceHandler.getDevice(t);if(a){var r=this;a.evalData(this._esp3,e,function(e,t){e||0==t.length||r._onEOEvents(a,t);});}},e.prototype._onEOEvents=function(e,t){var a=require("x.hub.eventbus.js");this._trackers.forEach(function(a){a.onResolveEvents(e._address,t);}),this._rehauHandler.onDeviceEvent(e,t);var r=e.toJSON();r.sys="aio",r.type="ENOCEAN";for(var n,s=0,o=0;o<t.length;o++){var i=t[o];if(i)if("shortPress"==i.value||"longPress"==i.value||"pressed"==i.value||"released"==i.value)s++,(l={type:"ENOCEAN",adr:r.address,data:r.data,vendor:r.vendor,state:{}}).state[i.key]=i.value,a.emit("gatewayevent",l,{address:"ENOCEAN"},"BTN");else if("d2-06-50"==r.data&&"burglary"==i.key){var l;return(l={type:"ENOCEAN",adr:r.address,data:r.data,vendor:r.vendor,state:{}}).state[i.key]=i.value,void a.emit("gatewayevent",l,{address:"ENOCEAN"},"STA");}}s!=t.length?(n=e.getStatesLegacy())&&(a.emit("gatewayevent",n,{address:"ENOCEAN"},"STA"),a.emit("udpevent",n,"STA")):(n=e.getStatesLegacy())&&a.emit("udpevent",n,"STA");},e.prototype._saveEnoceanEvents=function(e,t){var a=require("x.hub.datastore.js").dataStore;a&&a.openDB(function(a,r){if(!a){for(var n=e._address,s=[],o=new Date().toISOString(),i=0;i<t.length;i++){var l=t[i];if(l&&l.changed){var u,c=l.key+":"+l.value;u=0==s.length?"SELECT '"+n+"' AS 'window', '"+c+"' AS 'state', '"+o+"' AS 'time'":"UNION ALL SELECT '"+n+"', '"+c+"', '"+o+"'",s.push(u);}}if(s.length>0){var h=s.join(" ");h="INSERT INTO windowstate(window, state, time) "+h,h+=";",r.run(h,function(e){r.close();});}}});},e.prototype.addSensor=function(e,t){e?e.data?"siegenia"!=e.vendor||e.params?this._deviceHandler.addDevice(e,function(e,a){t&&t({error:e,data:a?a.toJSON():null});}):t&&t({error:new Error("siegenia windows params is null")}):t&&t({error:new Error("enocean profile is null")}):t&&t({error:new Error("enocean device is null")});},e.prototype.updateSensor=function(e,t,a){e?t?this._deviceHandler.updateDevice(e,t,function(e,t){a&&a({error:e,data:t?t.toJSON():null});}):a&&a({error:new Error("device info is null")}):a&&a({error:new Error("device address is null")});},e.prototype.delSensor=function(e,t){if(e){var a={address:e};this._deviceHandler.deleteDevice(a,function(e){t&&t({error:e});});}else t&&t({error:new Error("enocean id is null")});},e.prototype.resetDefaultSenderID=function(e){x.hub.m.enocean.SENDER_ID=null,localStorage&&localStorage.setItem("x.hub.m.enocean.SENDER_ID",""),e&&e({});},e.prototype.setRehauAlarm=function(e,t){this._rehauHandler.setAlarm(e,t);},e.prototype.isRehauWindowOpen=function(){return this._rehauHandler.isWindowOpen();},e.prototype.setInoventHumidityAccessory=function(e,t,a){this._rehauHandler.setHumidityAccessory(e,t,function(e){a&&a({error:e});});},e.prototype.setInoventCo2Accessory=function(e,t,a){this._rehauHandler.setCo2Accessory(e,t,function(e){a&&a({error:e});});},e.prototype.getInoventAccessories=function(e,t){var a=this._rehauHandler.getInoventAccessory(e);t&&t({data:a?a.toJSON():{}});},e.prototype.__addTelegramTracker=function(e){e&&e.onTelegram&&e.onResolveEvents&&-1==this._trackers.indexOf(e)&&this._trackers.push(e);},e.prototype.__removeTelegramTracker=function(e){if(e){var t=this._trackers.indexOf(e);-1!=t&&this._trackers.splice(t,1);}},e.prototype.__sendEspFrame=function(e,t,a,r,n){var s=t?new Buffer(t,"hex"):null,o=a?new Buffer(a,"hex"):null;r=!!r;var i=new x.hub.m.enocean.ESP3.ESP3_Frame(e,s,o);this._esp3.sendFrame(i,r,function(e,t){n&&n({error:e,data:t?t.toJSON():null});});},e.prototype.__simulateRawEnoceanPacket=function(e,t){this._esp3.onSerialData(new Buffer(e,"hex")),t&&t();},e.prototype._doSDK=function(e,t){if(e&&e.method){var a="send_"+e.method;this._sdk[a]?this._sdk[a](e.params,function(e){t&&t({error:e});}):t&&t({error:new Error("no such method")});}else t&&t({error:new Error("data invalid")});},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.enocean.Handler());