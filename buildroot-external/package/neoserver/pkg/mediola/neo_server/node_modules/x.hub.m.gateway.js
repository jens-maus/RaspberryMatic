var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var a=0;return function(){return a<b.length?{done:!1,value:b[a++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,a,c){b!=Array.prototype&&b!=Object.prototype&&(b[a]=c.value)};$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var a=0;a<b.length;++a){var c=b[a];if(c&&c.Math==Math)return c}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(b,a){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function b(c){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+a++,c)}var a=0;return b}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.asyncIterator;b||(b=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};
$jscomp.iteratorFromArray=function(b,a){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var c=0,e={next:function(){if(c<b.length){var d=c++;return{value:a(d,b[d]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill=function(b,a,c,e){if(a){c=$jscomp.global;b=b.split(".");for(e=0;e<b.length-1;e++){var d=b[e];d in c||(c[d]={});c=c[d]}b=b[b.length-1];e=c[b];a=a(e);a!=e&&null!=a&&$jscomp.defineProperty(c,b,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.gateway=x.hub.m.gateway||{};
x.hub.m.gateway.AIOMODULE=require("xnm.aio.gateway.js");
x.hub.m.gateway.Monitor=function(){var b=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Monitor");var a=this;this._eventCallback=function(c,e){a._onGatewayEvent(c,e)};this._eventCallback.onError=function(c){a._restartEventListener()};this._restartTO=null};b.prototype.init=function(a){var c=this;x.hub.m.gateway.AIOMODULE.startGatewayEventListener(this._eventCallback,function(e){e?c._restartEventListener():c._restartTO&&(clearTimeout(c._restartTO),c._restartTO=null);a&&a()})};
b.prototype._onGatewayEvent=function(a,c){require("x.hub.eventbus.js").emit("gatewayevent",a,c,"EVT")};b.prototype._onEventListenerError=function(a){};b.prototype._restartEventListener=function(){this._restartTO&&clearTimeout(this._restartTO);var a=this;this._restartTO=setTimeout(function(){a.init()},5E3)};return b}();
x.hub.m.gateway.GatewayInternalHandler=function(){var b=function(){this._devices={};this._meta={};this._states={}};b.prototype.addStateDevice=function(a,c,e){if(a&&a.type&&a.address){a=JSON.parse(JSON.stringify(a));delete a.gateway;var d=this._getDeviceID(a);this._devices[d]||(this._devices[d]=a);this._meta[d]||(this._meta[d]=[]);this._states[d]||(this._states[d]={});if(e){a=!1;for(var b=0;b<this._meta[d].length;b++){var g=this._meta[d][b];if(g&&g.statusKey==e.statusKey&&g.src==e.src&&g.taskID==e.taskID){a=
!0;break}}a||this._meta[d].push(e)}c&&c()}else c&&c(Error("device json invalid"))};b.prototype.removeStateDevice=function(a,c,e){if(!a||!a.type||!a.address)c&&c(Error("device json invalid"));else if(e){a=JSON.parse(JSON.stringify(a));delete a.gateway;a=this._getDeviceID(a);var d=this._meta[a];if(d){for(var b=-1,g=0;g<d.length;g++){var f=d[g];if(f&&f.src==e.src&&f.taskID==e.taskID&&f.statusKey==e.statusKey){b=g;break}}0<=b&&d.splice(b,1);0==d.length&&(delete this._devices[a],delete this._meta[a],delete this._states[a])}c&&
c()}};b.prototype.onEvent=function(a,c,e){if(a){var d,b=null,g=!1;if(a.sid)for(d in this._devices){var f=this._devices[d];if(f.sid==a.sid){var h=JSON.parse(JSON.stringify(a));f.type&&!h.type&&(h.type=f.type);f.address&&!h.address&&(h.address=f.address);f.address&&!h.adr&&(h.adr=f.address);f.data&&!h.data&&(h.data=f.data);if(c=this._getSystem(h)){if(a.changed&&a.changed.length){h.state={};a.changed.forEach(function(c){h.state[c]=a.state[c]});var k=c._handleState(f,h)}if(k&&0<Object.keys(k).length){var l=
f;this._getDeviceID(l);b=k;g=!0;break}}}}if(!g){if(!a.type)return;c=this._getSystem(a);if(!c)return;for(d in this._devices)if(this._devices.hasOwnProperty(d))if(f=this._devices[d],"EVT"==e&&c._handleUdpState){if((k=c._handleUdpState(f,a))&&0<Object.keys(k).length){l=f;this._getDeviceID(l);b=k;break}}else if("STA"==e&&c._handleState){if((k=c._handleState(f,a))&&0<Object.keys(k).length){l=f;this._getDeviceID(l);b=k;break}}else if("BTN"==e&&d==a.type+"@"+a.adr){l=f;b=a.state;break}}b&&this._updateState(l,
b,a)}};b.prototype._getDeviceID=function(a){if(a&&a.sid){var c="sid@"+a.sid;a.type&&a.address&&(c+="@"+a.type+"@"+a.address);return c}return a&&"ZWAVE2"==a.type?a.type+"@"+a.address+"."+a.instance:a.type+"@"+a.address};b.prototype._getSystem=function(a){return x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(a)};b.prototype._updateState=function(a,c,e){var d=this._getDeviceID(a),b=this._meta[d],g=this._states[d]?this._states[d]:{};this._states[d]=c;if(b&&0<b.length)for(var f in c)if(c.hasOwnProperty(f)){d=
c[f];var h=g[f];d={key:f,value:d,changed:h!=d,oldValue:h};e&&e.sid&&e.changed&&e.changed.length&&(d.changed=!0,delete d.oldValue);if("aio"==a.sys&&"MBUS"==a.type)if("undefined"==typeof h||null==h)continue;else if(!d.changed)continue;h=require("x.hub.eventbus.js");require("x.hub.taskman.js");for(var k=0;k<b.length;k++){var l=b[k];!l||l.statusKey!=f&&"*"!=l.statusKey||h.emit("status",{module:"aio",device:a,gateway:null,data:d},l)}}};return b}();
x.hub.m.gateway.Handler=function(){var b=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Handler");this._intHandler=new x.hub.m.gateway.GatewayInternalHandler;this._monitor=new x.hub.m.gateway.Monitor;this._on={};this._localIpBuffer=[];this._localIpUpdateInterval=null;this._db2GatewayNeoIndex=this._db1GatewayNeoIndex=0};b.prototype.on=function(a,c){this._on[a]=c};b.prototype._checkStateChange=function(a,c){};b.prototype.updateGatewayStates=function(a,c){c({})};b.prototype.updateStates=
function(a,c){c({})};b.prototype.getStates=function(a){return{}};b.prototype.getAllStates=function(){return[]};b.prototype.init=function(a){var c=this;require("x.hub.eventbus.js").on("gatewayevent",function(a,d,b){c._onEvent(a,d,b)});localStorage&&(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"));this._updateLocalIPBuffer();this._localIpUpdateInterval=setInterval(function(){c._updateLocalIPBuffer()},
18E5);this._monitor.init()};b.prototype.getSystems=function(){return["aio"]};b.prototype.addStateDevice=function(a,c,b){a&&a.type&&a.address?this._intHandler.addStateDevice(a,function(a){c&&c({error:a})},b):c&&c({error:Error("device json invalid")})};b.prototype.removeStateDevice=function(a,c,b){a&&a.type&&a.address?this._intHandler.removeStateDevice(a,function(a){c&&c({error:a})},b):c&&c({error:Error("device json invalid")})};b.prototype.getState=function(a,c,b){if(a.gateway)if(a.gateway.ip){a=JSON.parse(JSON.stringify(a));
var d=a.gateway;d=this._processPassword(d);d.__isself?this._getStateLocal(d,a,c,b):x.hub.m.gateway.AIOMODULE.doStatus("hub",d,a,{value:c},function(a,c){var d=null;c&&(d={value:c.status,time:(new Date).getTime()});b&&b({error:a,data:d})})}else b&&b({error:Error("gateway json invalid")});else this._getStateIQ(a,c,b)};b.prototype.executeCommand=function(a,c,b){if(a)if(a.gateway){a=JSON.parse(JSON.stringify(a));var d=a.gateway;d.ip?((d=this._processPassword(d))&&!a.type&&(a=d),d.__isself?this._executeCommandLocal(d,
a,c,b):x.hub.m.gateway.AIOMODULE.doCommand(d,a,c,function(a){b&&b({error:a})})):b&&b({errror:Error("gateway json invalid")})}else this._executeCommandIQ(a,c,b);else b&&b({error:Error("device is null")})};b.prototype.checkDeviceMatch=function(a,c){if(!(c&&c.device&&a&&a.device))return!1;var b=a.device.address;b&&"string"==typeof b&&(b=b.toUpperCase());var d=c.device.address;d&&"string"==typeof d&&(d=d.toUpperCase());a=a.device.type;return b==d&&a==c.device.type};b.prototype.updateGatewayNeoIndex=function(){localStorage&&
(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"))};b.prototype._onEvent=function(a,c,b){if(!(a.module||a.sys||(this._logger.log("trace","from "+(c?c.address:null)+" receive "+b+" event:"+JSON.stringify(a)),this._localIpBuffer&&c&&c.address&&"STA"==b&&-1!=this._localIpBuffer.indexOf(c.address)||c&&"Sysvar"!=c.address&&a.type&&-1!=["ONOFF","FLOAT","STRING","INT"].indexOf(a.type)))){var d=require("x.hub.eventbus.js");
if(a.type&&"IR"==a.type&&a.data)d.emit("irevt",{code:a.data});else this._intHandler.onEvent(a,c,b)}};b.prototype._executeCommandIQ=function(a,c,b){if(a.type){var d;if("HM"==a.type.toUpperCase()&&"EA"==global.HARDWARE_VERSION)"ip_siren"==a.data&&(c.value=x.hub.m.gateway.AIOMODULE.Systems.HM_X._buildData(null,a,c)),(d=require("x.hub.moduleman.js").modulemanager.getModule("hm"))?d.executeCommand(a,c,b):b&&b({error:Error("no module for type HM")});else if("ENOCEAN"==a.type.toUpperCase()&&"EA"==global.HARDWARE_VERSION)(d=
require("x.hub.moduleman.js").modulemanager.getModule("enocean"))?d.executeCommand(a,c,b):b&&b({error:Error("no module for type ENOCEAN")});else{var e=x.hub.m.gateway.AIOMODULE.getGatewayFunctionForType(a.type);if(e){if("CODE"==a.type){var g=x.hub.m.gateway.AIOMODULE.Systems.Code._rebuildDevice(JSON.parse(JSON.stringify(a)));a=x.hub.m.gateway.AIOMODULE.Systems.Code._findIRCode(c,a);a=x.hub.m.gateway.AIOMODULE.Systems.Code._buildParam(a,g)}else a="BG"==a.type?x.hub.m.gateway.AIOMODULE.Systems.BG._buildParam(null,
a,c):x.hub.m.gateway.AIOMODULE.getGatewayParams(a,c.value);e="http://localhost/command?XC_FNC="+e;if(a)for(d in a)e+="&"+d+"="+encodeURIComponent(a[d]);try{var f=require("x.hub.js").server;f?f._doSTMCommandRequest(e,!1,function(a){b&&b({error:a})}):b&&b({error:Error("server not initialized")})}catch(h){b&&b({error:h})}}else b&&b({error:Error("unknow device type")})}}else b&&b({error:Error("device type is null")})};b.prototype._executeCommandLocal=function(a,b,e,d){var c=x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(b,
a);if(c&&c.buildQuery){var g=x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(c=c.buildQuery(g?g:a,b,e)){try{var f=require("x.hub.js").server;if(!f){d&&d({error:Error("server not initialized")});return}var h=require("querystring"),k,l;if(c.fnc&&0==c.fnc.indexOf("/api")){(l=k=c.fnc)&&delete c.fnc;if(c.data)c=c.data;else{var m=h.stringify(c);c=h.parse(m);l=k+"?"+m}var p={url:l,query:c}}else"SendGenericCmd"==c.XC_FNC?(k="/cmd",p={method:"POST",url:l,query:c,json:c}):(k="/cmd",m=h.stringify(c),c=h.parse(m),
l=k+"?"+m,p={url:l,query:c});this._logger.log("trace","execute command local directly "+l);var q=this;f.doRequest(k,p,function(a){q._logger.log("trace","execute command local directly return:"+JSON.stringify(a));var b=null;if(a)try{(b=JSON.parse(a))&&b.XC_SUC?d&&d({data:b}):b&&b.XC_ERR?d&&d({error:Error(a)}):d&&d({error:Error("/cmd request return invalid format")})}catch(t){d&&d({error:t})}else d&&d({error:Error("/cmd request return null")})})}catch(r){d&&d({error:r})}return}}this._logger.log("trace",
"execute command via localhost:"+JSON.stringify(b)+" command:"+JSON.stringify(e));x.hub.m.gateway.AIOMODULE.doCommand(a,b,e,function(a){d&&d({error:a})})};b.prototype._getStateIQ=function(a,b,e){var c={ip:"127.0.0.1",port:require("x.hub.js").server._port,version:"EA"};c=this._processPassword(c);this._getStateLocal(c,a,b,e)};b.prototype._getStateLocal=function(a,b,e,d){var c=function(a,b,c){if(a.error)return{error:a.error};a=c._handleGeneralStatesRsp(a.data,b);b=null;a&&a[0]&&(b={value:a[0].status,
time:(new Date).getTime()});return{error:null,data:b}},g=x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(g){var f=[{id:"hub",device:b,status:{value:e}}],h=this;b&&"dev"==b.common_type?b.id?require("x.hub.commandman.js").commandHandlerV6.getDeviceStatesWithId(b.id,function(a,b){a?d&&d({error:a}):(a={value:b?b[e]:null,time:(new Date).getTime()},d&&d({error:null,data:a}))}):d&&d({error:Error("device json invalid")}):b&&b.type?"HM"==b.type&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.hm.js").getAllStatesLegacy(function(a){a=
c(a,f,g);d&&d(a)}):"ENOCEAN"==b.type&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.enocean.js").getAllStatesLegacy(function(a){a=c(a,f,g);d&&d(a)}):"ZWAVE2"==b.type?require("x.hub.m.zway.js").getAllStatesLegacy(function(a){a=c(a,f,g);d&&d(a)}):"KNX"==b.type?require("x.hub.m.knx.js").getAllStatesLegacy(function(a){a=c(a,f,g);d&&d(a)}):"ZIGBEE"==b.type?require("x.hub.m.zigbee.js").getAllStatesLegacy(function(a){a=c(a,f,g);d&&d(a)}):"ONOFF"==b.type||"FLOAT"==b.type||"INT"==b.type||"STRING"==b.type?
require("x.hub.sysvarman.js").getSysvarStates(function(a){a=c(a,f,g);d&&d(a)}):"TASK"==b.type?require("x.hub.taskman.js").readAllTasks(function(a){if(a.error)a=c(a,f,g);else{var b=[];a.data.forEach(function(a){a&&b.push({type:"TASK",id:a.id,active:a.active})});a=c({data:b},f,g)}d&&d(a)}):(a=require("x.hub.js").server)?(this._logger.log("trace","get states from ST directly"),a.doSTMCommand("XC_FNC=getStates",function(a){h._logger.log("trace","get states from ST return:"+JSON.stringify(a));if(a)if(a.XC_SUC){var b=
{data:null};Array.isArray(a.XC_SUC)?b.data=a.XC_SUC:0<Object.keys(a.XC_SUC).length&&(b.data=[a.XC_SUC]);a=c(b,f,g);d&&d(a)}else d&&d({error:Error("ST get states return error:"+JSON.stringify(a))});else d&&d({error:Error("ST get states return null")})})):d&&d({error:Error("server not initialized")}):x.hub.m.gateway.AIOMODULE.doStatus("hub",a,b,{value:e},function(a,b){var c=null;b&&(c={value:b.status,time:(new Date).getTime()});d&&d({error:a,data:c})})}else d&&d({error:Error("gateway json format invalid")})};
b.prototype._processPassword=function(a){var b=this._localIpBuffer,e="";localStorage&&(e=localStorage.getItem("x.hub.Server.pwd"));"localhost"==a.ip||"127.0.0.1"==a.ip||-1!=b.indexOf(a.ip)?(a.ip="127.0.0.1",a.port=require("x.hub.js").getServer()._port,a.__isself=!0,e&&(a.at=e)):a.__neoInfo&&(1==a.__neoInfo.db&&a.__neoInfo.index==this._db1GatewayNeoIndex?(a.ip="127.0.0.1",a.port=require("x.hub.js").getServer()._port,a.__isself=!0,e&&(a.at=e)):2==a.__neoInfo.db&&a.__neoInfo.index==this._db2GatewayNeoIndex&&
(a.ip="127.0.0.1",a.port=require("x.hub.js").getServer()._port,a.__isself=!0,e&&(a.at=e)));return a};b.prototype._updateLocalIPBuffer=function(){(new Date).getTime();var a=[],b=require("os").networkInterfaces(),e;for(e in b)for(var d=b[e],n=0;n<d.length;n++)a.push(d[n].address);this._localIpBuffer=a};return b}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.gateway.Handler);
