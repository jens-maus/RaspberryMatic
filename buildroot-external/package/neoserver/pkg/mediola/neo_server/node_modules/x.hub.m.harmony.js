var util=require("util"),EventEmitter=require("events");require("x.logger.js").setLevel("trace","x.hub.m.harmony");require("x.logger.js").setLevel("info","xnm.aio.harmony");var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.harmony=x.hub.m.harmony||{};x.hub.m.harmony.HARMONY_MODULE=require("xnm.aio.harmony.js");
x.hub.m.harmony.Monitor=function(){var d=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.m.harmony.Monitor");var c=this;this._state=d.STATE.IDLE;this._hub=a;this._monitorListener={onData:function(a,b){c.onData(a,b)},onClose:function(){c.onClose()}};this._autoreconn=b;this._reconnectTO=null;this._getActivityStateCallbacks=[];this._activities={}};d.STATE={IDLE:0,CONNECTING:1,CONNECTED:2,WAITING_RECONN:3};d.prototype.addStateDevice=function(a,b){a&&a.id&&a.type?"Activity"!=a.type?
b&&b(Error("device type:"+a.type+" has no status")):this._activities[a.id]?b&&b():this.getStates(a,b):b&&b(Error("device json invalid"))};d.prototype.getStates=function(a,b){if(a&&a.id&&a.type)if("Activity"!=a.type)b&&b(Error("device type:"+a.type+" has no status"));else{var c=a.id;this._activities[c]||(this._activities[c]={device:a,states:{state:{value:"?",time:-1}}});var d=this;this._getActivityState(function(c){c?b&&b(c):b&&b(null,d.getBufferedStates(a))})}else b&&b(Error("device json invalid"))};
d.prototype.getBufferedStates=function(a){if(!a||!a.id||!a.type||"Activity"!=a.type)return null;a=a.id;return this._activities[a]&&this._activities[a].states?this._activities[a].states:{state:null}};d.prototype.getAllBufferedStates=function(){var a=[],b;for(b in this._activities)if(this._activities.hasOwnProperty(b)){var c=this._activities[b];c&&c.device&&c.states&&a.push({device:c.device,states:c.states})}return a};d.prototype.executeCommand=function(a,b,c){switch(this._state){case d.STATE.WAITING_RECONN:case d.STATE.IDLE:case d.STATE.CONNECTING:c&&
c(Error("monitor not connected"));return}this._hub.executeCommandCreator(a,b,function(a){c&&c(a)})};d.prototype.start=function(a){this._logger.log("debug","start monitor for:"+this._hub.ip);var b=this;this._state=d.STATE.CONNECTING;this._hub.setMonitorListener(this._monitorListener);this._hub.startMonitor(function(c){c?(b._logger.log("debug","monitor connected err:"+c.message),b._autoreconn?(b._state=d.STATE.WAITING_RECONN,b._reconnect(1E4)):b._state=d.STATE.IDLE):(b._logger.log("debug","monitor connected:"+
b._hub.ip),b._state=d.STATE.CONNECTED,b._initStates());a&&a(c)})};d.prototype._reconnect=function(a){this._logger.log("trace","reconnect monitor:"+this._hub.ip);this._reconnectTO&&(clearTimeout(this._reconnectTO),this._reconnectTO=null);var b=this;a?this._reconnectTO=setTimeout(function(){b.start()},a):b.start()};d.prototype._initStates=function(a){this._getActivityState(a)};d.prototype._getActivityState=function(a){switch(this._state){case d.STATE.WAITING_RECONN:case d.STATE.IDLE:case d.STATE.CONNECTING:a&&
a(Error("monitor not connected"));return}var b=this._getActivityStateCallbacks.length;a||(a=function(){});-1==this._getActivityStateCallbacks.indexOf(a)&&this._getActivityStateCallbacks.push(a);if(!b){var c=this;this._hub.getCurrentActivity(function(a,b){a||-1==b||c._updateActivityBuffer(b,"RUNNING");var d=c._getActivityStateCallbacks;c._getActivityStateCallbacks=[];d.forEach(function(c){c&&c(a,b)})})}};d.prototype._updateActivityBuffer=function(a,b){var c=!1,d=null,e=null;if(-1==a)this._produceEvent(-1,
{value:"?",time:-1},{value:"allOff",time:(new Date).getTime()}),this._produceEvent(-1,{value:"?",time:-1},{value:"off",time:(new Date).getTime()});else{for(var f in this._activities)if(this._activities.hasOwnProperty(f)){var g=this._activities[f];g.states||(g.states={state:{}});d=g.states.state;-1!=f&&(a!=f?"on"==d.value&&(g.lastStatus="NO_ACTIVITY",e={value:this._resolveState("NO_ACTIVITY"),time:(new Date).getTime()},g.states.state=e,this._produceEvent(f,d,e)):(g.lastStatus=b,c=!0,e={value:this._resolveState(b),
time:(new Date).getTime()},g.states.state=e,this._produceEvent(f,d,e)))}c||-1==a||(e={value:this._resolveState(b),time:(new Date).getTime()},this._activities[a]={activity:null,states:{state:e},lastStatus:b},this._produceEvent(a,d,e))}};d.prototype._produceEvent=function(a,b,c){if((a=this._activities[a]?this._activities[a].device:null)&&b){var d;d=c.value!=b.value;var e=require("x.hub.eventbus.js");d&&e.emit("status",{module:"harmony",device:a,gateway:a.gateway,data:{key:"event",value:c.value,oldvalue:b.value,
changed:!0}})}};d.prototype._resolveState=function(a){var b="?";switch(a){case "RUNNING":case "STARTING":b="on";break;default:b="off"}return b};d.prototype.onData=function(a,b){b&&(this._logger.log("trace","receive notify:"+JSON.stringify(b)),this._updateActivityBuffer(b.activityId,b.activityStatus))};d.prototype.onClose=function(){this._logger.log("debug","monitor closed:"+this._hub.ip);this._reconnect()};return d}();
x.hub.m.harmony.Handler=function(){var d=function(){this._monitors={}};util.inherits(d,EventEmitter);d.prototype.init=function(a){a&&a()};d.prototype.getSystems=function(){return["harmony"]};d.prototype.addStateDevice=function(a,b){a?a.gateway?this._startMonitor(a.gateway,function(c,d){c?b&&b({error:c}):d.addStateDevice(a,function(a){b&&b({error:a})})}):b&&b(Error("device gateway format invalid")):b&&b({error:Error("device json format invalid")})};d.prototype.getAllStates=function(){var a=[],b;for(b in this._monitors)if(this._monitors.hasOwnProperty(b)){var c=
this._monitors[b].getAllBufferedStates();c&&(a=a.concat(c))}return a};d.prototype.getStates=function(a){if(!a||!a.gateway||!a.gateway.ip)return null;var b=this._monitors[a.gateway.ip];return b?b.getBufferedStates(a):(this._startMonitor(a.gateway,function(b,d){b||d.addStateDevice(a,function(a){})}),null)};d.prototype.getState=function(a,b,c){a?a.gateway?this._startMonitor(a.gateway,function(d,e){if(d)c&&c({error:d});else{var f=e.getBufferedStates(a);f?null!=f[b]?c&&c({data:f[b]}):e.getStates(a,function(a,
d){a?c&&c({error:a}):d&&d[b]?c&&c({data:d[b]}):c&&c({error:Error("get states result invalid")})}):c&&c({error:d})}}):c&&c(Error("device gateway format invalid")):c&&c({error:Error("device json format invalid")})};d.prototype.executeCommand=function(a,b,c){a?b?a.gateway?this._startMonitor(a.gateway,function(d,e){d?c&&c({error:d}):e.executeCommand(a,b,function(a){c&&c({error:a})})}):c&&c({error:Error("gateway is null")}):c&&c({error:Error("command invalid")}):c&&c({error:Error("device is null")})};
d.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&b.gateway&&a.gateway&&b.gateway.ip==a.gateway.ip?b.device.id==a.device.id:!1};d.prototype._startMonitor=function(a,b){if(a&&a.ip){var c=a.ip;if(this._monitors[c])b&&b(null,this._monitors[c]);else{var d=x.hub.m.harmony.HARMONY_MODULE.resolveGateway(a);d?(d=new x.hub.m.harmony.Monitor(d,!0),this._monitors[c]=d,d.start(),b&&b(null,d)):b&&b(Error("harmony hub format invalid"))}}else b&&b(Error("harmony hub format invalid"))};
return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.harmony.Handler);
