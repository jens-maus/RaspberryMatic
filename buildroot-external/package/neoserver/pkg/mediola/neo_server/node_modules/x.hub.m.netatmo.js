var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.netatmo=x.hub.m.netatmo||{};require("x.logger.js").setLevel("info","xnm.aio.netatmo");x.hub.m.netatmo.AIOMODULE=require("xnm.aio.netatmo.js");
x.hub.m.netatmo.Handler=function(){var e=function(){this._clouds={};this._devices={}};e.prototype.init=function(a){x.hub.m.netatmo.AIOMODULE.addUpdateListener(this)};e.prototype.getSystems=function(){return["netatmo"]};e.prototype.addStateDevice=function(a,c){if(a&&a.gateway)if(a.address&&a.type){var d=x.hub.m.netatmo.AIOMODULE.resolveGateway(a.gateway);if(d){var f=a.gateway.refreshToken;f||(f=a.gateway.username);a=JSON.parse(JSON.stringify(a));delete a.gateway;var b=this._getDeviceID(a);this._devices[b]||
(this._devices[b]=a);this._clouds[f]?c&&c({}):(this._clouds[f]=d,d.getAllStatus(function(){c&&c({})}))}else c&&c({error:Error("gateway invalid")})}else c&&c({error:Error("device invalid")});else c&&c({error:Error("gateway is null")})};e.prototype.getState=function(a,c,d){if(a&&a.gateway)if(a.address&&a.type){var f=x.hub.m.netatmo.AIOMODULE.resolveGateway(a.gateway);if(f){var b=a.gateway.refreshToken;b||(b=a.gateway.username);a=JSON.parse(JSON.stringify(a));delete a.gateway;var g=this._getDeviceID(a);
this._devices[g]||this.addStateDevice(a);this._clouds[b]||(this._clouds[b]=f);f=this._clouds[b];f.getStatesCreator(null,[{id:"xhub",device:a,status:{value:c}}],function(a,b){var c=null;b&&b[0]&&(c=b[0].status);d&&d({error:a,data:{value:c}})})}else d&&d({error:Error("gateway invalid")})}else d&&d({error:Error("device invalid")});else d&&d({error:Error("gateway is null")})};e.prototype.executeCommand=function(a,c,d){if(a&&a.gateway)if(a.address&&a.type){var f=x.hub.m.netatmo.AIOMODULE.resolveGateway(a.gateway);
if(f){var b=a.gateway.refreshToken;b||(b=a.gateway.username);a=JSON.parse(JSON.stringify(a));delete a.gateway;var g=this._getDeviceID(a);this._devices[g]||this.addStateDevice(a);this._clouds[b]||(this._clouds[b]=f);f=this._clouds[b];f.executeCommandCreator(a,c,function(a){d&&d({error:a})})}else d&&d({error:Error("gateway invalid")})}else d&&d({error:Error("device invalid")});else d&&d({error:Error("gateway is null")})};e.prototype.checkDeviceMatch=function(a,c){return c&&c.device&&a&&a.device&&c.device.type==
a.device.type?"NAMain"==c.device.type?c.device.address==a.device.address:c.device.module==a.device.module:!1};e.prototype.updateWeather=function(a,c,d){var f,b;c&&(f=this._resovleStationsStatus(a,c));d&&(b=this._resovleStationsStatus(a,d));if(b)for(var g in b)if(b.hasOwnProperty(g)&&this._devices[g]){c=b[g];d=f?f[g]:void 0;for(var h in c)if(c.hasOwnProperty(h)){var e=c[h],k=d?d[h]:void 0,e={key:h,value:e,changed:k!=e,oldValue:k};require("x.hub.eventbus.js").emit("status",{module:"netatmo",device:this._devices[g],
gateway:a.toJSON(),data:e})}}};e.prototype.updateThermo=function(a,c,d){var f,b;c&&(f=this._resovleThermostatsStatus(a,c));d&&(b=this._resovleThermostatsStatus(a,d));if(b)for(var g in b)if(b.hasOwnProperty(g)&&this._devices[g]){c=b[g];d=f?f[g]:void 0;for(var e in c)if(c.hasOwnProperty(e)){var l=c[e],k=d?d[e]:void 0,l={key:e,value:l,changed:k!=l,oldValue:k};require("x.hub.eventbus.js").emit("status",{module:"netatmo",device:this._devices[g],gateway:a.toJSON(),data:l})}}};e.prototype._getDeviceID=function(a){return"NAMain"==
a.type?a.address:a.address+"|"+a.module};e.prototype._resovleStationsStatus=function(a,c){var d={};if(c)for(var f=0;f<c.length;f++){var b=c[f];if(b&&b._id){var g=a._resolveStationStatus(b);g&&(d[b._id]=g);if(b.modules)for(var e=0;e<b.modules.length;e++)(g=a._resolveModuleStatus(b.modules[e]))&&(d[b._id+"|"+b.modules[e]._id]=g)}}return d};e.prototype._resovleThermostatsStatus=function(a,c){for(var d={},f=0;f<c.length;f++){var b=c[f];if(b&&b._id&&b.modules)for(var e=0;e<b.modules.length;e++){var h=
a._resolveModuleStatus(b.modules[e]);h&&(d[b._id+"|"+b.modules[e]._id]=h)}}return d};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.netatmo.Handler);
