var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.siegenia=x.hub.m.siegenia||{};x.hub.m.siegenia.SIEGENIA_MODULE=require("xnm.aio.siegenia.js");require("x.logger.js").setLevel("trace","x.hub.m.siegenia");require("x.logger.js").setLevel("trace","xnm.aio.siegenia");x.hub.m.siegenia.Handler=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.siegenia.Handler");this._devices={};this._on={}};x.hub.m.siegenia.Handler.prototype.init=function(a){a&&a()};
x.hub.m.siegenia.Handler.prototype.getSystems=function(){return["siegenia"]};
x.hub.m.siegenia.Handler.prototype.addStateDevice=function(a,b,c){if(a){if(a.address||!a.ip)a.ip=a.address;if(a.ip){var g=x.hub.m.siegenia.SIEGENIA_MODULE.resolveDevice(a);if(g){var d=this._devices[a.ip];if(d){if(c&&d.metas.push(c),a.password!=d.dev.password||a.password!=d.obj.password)d.dev.password=a.password,d.obj.password=a.password}else{d={dev:a,obj:g,metas:[c]};this._devices[a.ip]=d;var e=this;d.obj.startMonitoring(function(b){e._checkStateChange(a,b)},function(){})}b&&b({})}else b&&b({error:Error("device json unknow device")})}else b&&
b({error:Error("device json invalid")})}else b&&b({error:Error("device json invalid")})};
x.hub.m.siegenia.Handler.prototype.removeStateDevice=function(a,b,c){if(!a)b&&b({error:Error("device json invalid")});else if(c){var g=this._devices[a.ip];if(g){var d=g.metas;if(d){for(var e=-1,f=0;f<d.length;f++){var h=d[f];if(h&&"taskman"==h.src&&"taskman"==c.src&&h.taskID==c.taskID&&h.statusKey==c.statusKey){e=f;break}}0<=e&&d.splice(e,1);if(0==d.length){delete this._devices[a.ip];x.hub.m.siegenia.SIEGENIA_MODULE.SessionManager.stopMonitorSession(g.obj,function(){b&&b()});return}}b&&b()}else b&&
b({})}};x.hub.m.siegenia.Handler.prototype.updateStates=function(a,b){var c=x.hub.m.siegenia.SIEGENIA_MODULE.resolveDevice(a);c?c.getSingleDeviceStatesCreator(null,a,null,function(a,c){b&&b({error:a,data:c})}):b&&b({error:Error("device json invalid")})};x.hub.m.siegenia.Handler.prototype.getStates=function(a){return{}};x.hub.m.siegenia.Handler.prototype.getAllStates=function(){return[]};
x.hub.m.siegenia.Handler.prototype.executeCommand=function(a,b,c){a&&a.address&&(a.ip=a.address);x.hub.m.siegenia.SIEGENIA_MODULE.doCommand(a,b,function(a){a?c&&c({error:a}):c&&c({})})};x.hub.m.siegenia.Handler.prototype.getState=function(a,b,c){a&&a.address&&(a.ip=a.address);x.hub.m.siegenia.SIEGENIA_MODULE.doStatus("xhub",a,{value:b},function(a,b){a?c&&c({error:a}):b?c&&c({data:{value:b.status}}):c&&c({error:Error("do status failed")})})};
x.hub.m.siegenia.Handler.prototype.checkDeviceMatch=function(a,b){if(!(b&&b.device&&a&&a.device))return!1;var c=a.device.data;return a.device.address==b.device.address&&c==b.device.data};
x.hub.m.siegenia.Handler.prototype._checkStateChange=function(a,b){this._logger.log("trace","receive status:"+JSON.stringify(b));this._logger.log("trace","for device:"+JSON.stringify(a));if(this._devices[a.ip]){var c=this._devices[a.ip],g=c.states;g||(c.states={},g={});var d=[],e;for(e in b){var f={};f.key=e;f.value=b[e];f.changed=!0;g[e]&&b[e]==g[e].value&&(f.oldvalue=g[e].value,f.changed=!1);c.states[e]={value:b[e],time:(new Date).getTime()};f.changed&&d.push({device:a,data:f});if("warnings"==e){var h=
g[e]?g[e].value:null;b[e].forEach(function(b){var c={key:"warning"};c.value=b;c.changed=!1;h&&-1==h.indexOf(b)&&(c.changed=!0);d.push({device:a,data:c})})}}d&&0<d.length&&this._generateEvent(a,d)}};
x.hub.m.siegenia.Handler.prototype._generateEvent=function(a,b){if(this._devices[a.ip]){var c=require("x.hub.eventbus.js");if((a=this._devices[a.ip].metas)&&0<a.length)for(var g=0;g<a.length;g++){var d=a[g];if(d)for(var e=0;e<b.length;e++){var f=b[e];f&&f.data&&(f.data.key==d.statusKey||"*"==f.data.key)&&c.emit("status",{module:"siegenia",device:f.device,data:f.data},d)}}}};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.siegenia.Handler);
