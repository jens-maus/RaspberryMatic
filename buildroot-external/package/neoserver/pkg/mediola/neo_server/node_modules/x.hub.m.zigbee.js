var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.zigbee=x.hub.m.zigbee||{};require("x.logger.js").setLevel("trace","x.hub.m.zigbee.Zigbee");
x.hub.m.zigbee.Util=function(){var f=function(){};f.prototype.rgbToHsv=function(b,a,c){b/=255;a/=255;c/=255;var d=Math.max(b,a,c),e=Math.min(b,a,c),g=d-e;if(d==e)var h=0;else{switch(d){case b:h=(a-c)/g+(a<c?6:0);break;case a:h=(c-b)/g+2;break;case c:h=(b-a)/g+4}h/=6}return[h,0==d?0:g/d,d]};f.prototype.hsvToRgb=function(b,a,c){var d=Math.floor(6*b),e=6*b-d;b=c*(1-a);var g=c*(1-e*a);a=c*(1-(1-e)*a);switch(d%6){case 0:var h=c;var f=a;var k=b;break;case 1:h=g;f=c;k=b;break;case 2:h=b;f=c;k=a;break;case 3:h=
b;f=g;k=c;break;case 4:h=a;f=b;k=c;break;case 5:h=c,f=b,k=g}return[255*h,255*f,255*k]};f.prototype.rgbTocie=function(b,a,c){b=.04045<b?Math.pow((b+.055)/1.055,2.4):b/12.92;a=.04045<a?Math.pow((a+.055)/1.055,2.4):a/12.92;c=.04045<c?Math.pow((c+.055)/1.055,2.4):c/12.92;var d=.664511*b+.154324*a+.162028*c,e=.283881*b+.668433*a+.047685*c;a=8.8E-5*b+.07231*a+.986039*c;b=(d/(d+e+a)).toFixed(4);d=(e/(d+e+a)).toFixed(4);isNaN(b)&&(b=0);isNaN(d)&&(d=0);return[b,d]};f.prototype.cieTorgb=function(b,a,c){void 0===
c&&(c=254);var d=1-b-a;c=(c/254).toFixed(2);b*=c/a;var e=c/a*d;a=1.656492*b-.354851*c-.255038*e;d=.707196*-b+1.655397*c+.036152*e;c=.051713*b-.121364*c+1.01153*e;a>c&&a>d&&1<a?(d/=a,c/=a,a=1):d>c&&d>a&&1<d?(a/=d,c/=d,d=1):c>a&&c>d&&1<c&&(a/=c,d/=c,c=1);a=.0031308>=a?12.92*a:1.055*Math.pow(a,1/2.4)-.055;d=.0031308>=d?12.92*d:1.055*Math.pow(d,1/2.4)-.055;c=.0031308>=c?12.92*c:1.055*Math.pow(c,1/2.4)-.055;a=Math.round(255*a);d=Math.round(255*d);c=Math.round(255*c);isNaN(a)&&(a=0);isNaN(d)&&(d=0);isNaN(c)&&
(c=0);return[a,d,c]};f.prototype.RGBToHSV=function(b,a,c){b/=255;a/=255;c/=255;var d=Math.min(b,Math.min(a,c)),e=Math.max(b,Math.max(a,c));return d==e?[0,0,d]:[60*((b==d?3:c==d?1:5)-(b==d?a-c:c==d?b-a:c-b)/(e-d)),(e-d)/e,e]};return new f}();
x.hub.m.zigbee.Device=function(){var f=function(b,a){this._ieeeAdr=b;this._endpointID=a;this._deviceID=this._profileID=null;this._states={}};f.prototype.getIeeeAdr=function(){return this._ieeeAdr};f.prototype.getEndpointID=function(){return this._endpointID};f.prototype.setBufferedState=function(b,a){this._states[b]=a};f.prototype.getBufferedState=function(b){return this._states[b]};f.prototype.getBufferedStates=function(){return this._states};f.prototype.getConvertedStates=function(){var b={};"undefined"!=
typeof this._states.onoff&&null!=this._states.onoff&&(b.onoff=this._states.onoff);"undefined"!=typeof this._states.level&&null!=this._states.level&&(b.level=Math.round(this._states.level/255*100));if("undefined"!=typeof this._states.color&&null!=this._states.color&&(b.color=this._states.color,"undefined"!=typeof this._states.color.hue&&null!=this._states.color.hue&&"undefined"!=typeof this._states.color.sat&&null!=this._states.color.sat)){var a=x.hub.m.zigbee.Util.hsvToRgb(this._states.color.hue/
254,this._states.color.sat/254,1),c=Math.round(a[0]).toString(16);2>c.length&&(c="0"+c);c=c.toUpperCase();var d=Math.round(a[1]).toString(16);2>d.length&&(d="0"+d);d=d.toUpperCase();a=Math.round(a[2]).toString(16);2>a.length&&(a="0"+a);a=a.toUpperCase();b.rgb=c+d+a}"off"==b.onoff&&(b.level=0);"on"==b.onoff&&0==b.level&&(b.level=1);0==b.level&&(b.onoff="off");return b};f.prototype.executeCommand=function(b,a,c){var d=this;if("on"==a||"off"==a){var e=a;b._doCommand(this._ieeeAdr,this._endpointID,e,
null,function(a){a||d.setBufferedState("onoff",e);c&&c(a)})}else if("toggle"==a){var g=this.getBufferedState("onoff");e="on"==g?"off":"on";b._doCommand(this._ieeeAdr,this._endpointID,e,null,function(a){a||d.setBufferedState("onoff",e);c&&c(a)})}else if("white"==a)if("0200"==this._deviceID&&this._profileID.indexOf("000B57")){a=x.hub.m.zigbee.Util.rgbTocie(255,255,255);var h=Math.round(65536*a[0]);65279<h&&(h=65279);a=Math.round(65536*a[1]);65279<a&&(a=65279);b._doCommand(this._ieeeAdr,this._endpointID,
"color_xy",[h,a],function(a){c&&c(a)})}else b._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[0,0],function(a){a||d.setBufferedState("color",{hue:0,sat:0});c&&c(a)});else if(0==a.indexOf("dimTo"))e="level",g=parseInt(a.substr(5)),isNaN(g)?c&&c(Error("command "+a+" invalid")):(g=Math.round(g/100*255),b._doCommand(this._ieeeAdr,this._endpointID,e,g,function(a){a||d.setBufferedState("level",g);c&&c(a)}),0==g?b._doCommand(this._ieeeAdr,this._endpointID,"off",null,function(a){a||d.setBufferedState("onoff",
"off")}):b._doCommand(this._ieeeAdr,this._endpointID,"on",null,function(a){a||d.setBufferedState("onoff","on")}));else if(0==a.indexOf("setColorMap"))if((g=a.substr(11))&&-1!=g.indexOf(","))if(h=g.split(","),2>h.length)c&&c(Error("command "+a+" invalid"));else{var f=parseInt(h[0]);0>f&&(f=0);255<f&&(f=255);var k=parseInt(h[1]);0>k&&(k=0);255<k&&(k=255);b._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[f,k],function(a){a||d.setBufferedState("color",{hue:f,sat:k});c&&c(a)})}else c&&c(Error("command "+
a+" invalid"));else if(0==a.indexOf("setColorXY"))(g=a.substr(10))&&-1!=g.indexOf(",")?(h=g.split(","),2>h.length?c&&c(Error("command "+a+" invalid")):(a=parseInt(h[0]),0>a&&(a=0),65279<a&&(a=65279),h=parseInt(h[1]),0>h&&(h=0),65279<h&&(h=65279),b._doCommand(this._ieeeAdr,this._endpointID,"color_xy",[a,h],function(a){c&&c(a)}))):c&&c(Error("command "+a+" invalid"));else if(0==a.indexOf("setColorTemp"))if(g=a.substr(12)){h=parseFloat(g);15.32>h&&(h=15.32);var m=Math.round(1E6/h);b._doCommand(this._ieeeAdr,
this._endpointID,"color_temp",m,function(a){a||d.setBufferedState("color_temp",m);c&&c(a)})}else c&&c(Error("command "+a+" invalid"));else if(0==a.indexOf("setRGB")){g=a.substr(6);h=parseInt(g.substr(0,2),16);a=parseInt(g.substr(2,2),16);var n=parseInt(g.substr(4,2),16);if("0200"==this._deviceID&&0==this._ieeeAdr.indexOf("000B57"))a=x.hub.m.zigbee.Util.rgbTocie(h,a,n),h=Math.round(65536*a[0]),65279<h&&(h=65279),a=Math.round(65536*a[1]),65279<a&&(a=65279),b._doCommand(this._ieeeAdr,this._endpointID,
"color_xy",[h,a],function(a){c&&c(a)});else{h=x.hub.m.zigbee.Util.rgbToHsv(h,a,n);var l=Math.floor(254*h[0]),p=Math.floor(254*h[1]);b._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[l,p],function(a){a||d.setBufferedState("color",{hue:l,sat:p});c&&c(a)})}}else c&&c(Error("unknown command"))};f.prototype.toJSON=function(){return{ieeeAdr:this._ieeeAdr,endpointID:this._endpointID,profileID:this._profileID,deviceID:this._deviceID}};f.parseJSON=function(b){if(!b||!b.ieeeAdr||!b.endpointID)return null;
var a=new f(b.ieeeAdr,b.endpointID);a._profileID=b.profileID;a._deviceID=b.deviceID;return a};return f}();
x.hub.m.zigbee.Zigbee=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Zigbee");this._devices=[];this._learnCBs=[];this._learnTO=null};f.prototype.init=function(b){this._logger.log("info","zigbee init");var a=this;this.listDevices(function(c){c&&a._logger.log("info","init list devices error:"+c.message);b&&b(c)})};f.prototype.getDevices=function(){return this._devices};f.prototype.executeCommand=function(b,a,c){if(b)if(a){var d=b.indexOf(":");if(-1==d)c&&c(Error("address format invalid"));
else{var e=b.substr(0,d);b=b.substr(d+1);(d=this._findDevice(e,b))||(d=new x.hub.m.zigbee.Device(e,b));d.executeCommand(this,a,c)}}else c&&c(Error("command invalid"));else c&&c(Error("address is empty"))};f.prototype.learnDevice=function(b,a){a||(a=function(){});b=parseInt(b);if(!b||isNaN(b)||0>=b)b=60;var c=this._learnCBs.length;-1==this._learnCBs.indexOf(a)&&this._learnCBs.push(a);if(!(0<c)){var d=this;this._learnTO=setTimeout(function(){d._listDevices(function(a,c){var b;d._learnTO=null;var e=
d._learnCBs;d._learnCBs=[];if(a)for(b=e.length;b--;)e[b]&&e[b](a);else{a=[];for(b=c.length;b--;){var g=c[b],f=d._findDevice(g.ieeeAdr,g.endpointID);!f&&(f=x.hub.m.zigbee.Device.parseJSON(g))&&(d._devices.push(f),a.push(g))}for(b=e.length;b--;)e[b]&&e[b](null,a)}})},1E3*b);this._openNetwork(b,function(a){if(a){clearTimeout(d._learnTO);d._learnTO=null;var b=d._learnCBs;d._learnCBs=[];for(var c=b.length;c--;)b[c]&&b[c](a)}})}};f.prototype.listDevices=function(b){var a=this;this._listDevices(function(c,
d){if(c)b&&b(c);else{for(c=d.length;c--;){var e=d[c],g=a._findDevice(e.ieeeAdr,e.endpointID);g||(g=x.hub.m.zigbee.Device.parseJSON(e))&&a._devices.push(g)}b&&b()}})};f.prototype.removeDevice=function(b,a){if(b){var c=b.indexOf(":");var d=-1==c?b:b.substr(0,c);var e=this;this._removeDevice(d,function(b){b?a&&a(b):(e._deleteDevice(d,null),a&&a())})}else a&&a(Error("address is empty"))};f.prototype._findDevice=function(b,a){for(var c=this._devices.length;c--;){var d=this._devices[c];if(d.getIeeeAdr()==
b&&d.getEndpointID()==a)return d}return null};f.prototype._deleteDevice=function(b,a){var c=this._devices;this._devices=[];for(var d=c.length;d--;){var e=c[d],g=!1;e.getIeeeAdr()==b&&(a&&e.getEndpointID()!=a||(g=!0));g||this._devices.push(e)}};f.prototype._listDevices=function(b){this._logger.log("debug","list devices");var a=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];a.push("listdevices");a=a.join(" ");var c=this;this._exec(a,function(a,e,g){if(a)c._logger.log("debug","list devices error:"+
a.message),b&&b(a);else if(g)c._logger.log("debug","list devices error:"+g),b&&b(Error(g));else if(c._logger.log("debug","list devices:\r\n"+e),e=e.trim()){a=[];e=e.split("\n");for(g=0;g<e.length;g++){var d=e[g].trim();d&&(d=d.split(" "),d={ieeeAdr:d[0]?d[0].replace(/:/g,""):null,endpointID:d[1],profileID:d[2]?d[2].substr(2):null,deviceID:d[3]?d[3].substr(2):null},a.push(d))}b&&b(null,a)}else b&&b(null,[])})};f.prototype._openNetwork=function(b,a){this._logger.log("debug","open network for "+b+" seconds");
var c=this;b=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin opennetwork",b].join(" ");this._exec(b,function(b,e,g){b?(c._logger.log("debug","open network error:"+b.message),a&&a(b)):g?(c._logger.log("debug","open network error:"+g),a&&a(Error(g))):a&&a()})};f.prototype._removeDevice=function(b,a){this._logger.log("debug","remove device:"+b);var c=this,d=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin remove",b].join(" ");this._exec(d,function(d,g,f){d?(c._logger.log("debug","remove device "+
b+" error:"+d.message),a&&a(d)):f?(c._logger.log("debug","remove device "+b+" error:"+f),a&&a(Error(f))):a&&a()})};f.prototype._doCommand=function(b,a,c,d,e){var g=[b,a,c,d];this._logger.log("debug","do command ["+g.join(",")+"]");g=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];g.push(c);g.push(b);g.push(a);"undefined"!=typeof d&&null!=d&&(Array.isArray(d)?g=g.concat(d):g.push(d));var f=this;b=g.join(" ");this._exec(b,function(a,b,c){if(a)f._logger.log("debug","do command error:"+a.message),
e&&e(a);else if(c)f._logger.log("debug","do command error:"+c),e&&e(Error(c));else try{if(b){var d=JSON.parse(b);e&&e(null,d)}else e&&e()}catch(l){f._logger.log("debug","do command error (not json):"+b),e&&e(Error(b))}})};f.prototype._exec=function(b,a){this._logger.log("trace","execute native:"+b);var c=this,d=require("child_process").exec;b=d(b);var e,g="",f="";b.stderr.on("data",function(a){e=String(a);f+=e});b.stdout.on("data",function(a){e=String(a);g+=e});b.on("error",function(b){c._logger.log("warn",
"execute native error:"+b.message);a&&a(b);a=null});b.on("close",function(b,d){c._logger.log("trace","execute native close:"+b+","+d);c._logger.log("trace","outTxt:"+g);c._logger.log("trace","errTxt:"+f);a&&a(null,g,f);a=null})};return f}();
x.hub.m.zigbee.Handler=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Handler");this._zigbee=null;this._zigbeeStickAvaliable=!1};util.inherits(f,EventEmitter);f.prototype.Zigbee=x.hub.m.zigbee.Zigbee;f.prototype.getSystems=function(){return["zigbee"]};f.prototype.init=function(b){var a=this,c=require("x.hub.eventbus.js");c.on("x.hub.peripheralman.ADD_ZIGBEE",function(b){a._logger.log("debug","insert zigbee usb stick");a._zigbeeStickAvaliable=!0});c.on("x.hub.peripheralman.REMOVE_ZWAVE",
function(b){a._logger.log("debug","eject zigbee usb stick");a._zigbeeStickAvaliable=!1});this._zigbee=new this.Zigbee;this._zigbee.init();b&&b({})};f.prototype.executeCommand=function(b,a,c){c&&c()};f.prototype.learnDevice=function(b,a){this._zigbeeStickAvaliable?this._zigbee.learnDevice(b.timeout,function(b,d){a&&a({error:b,data:d})}):a&&a({error:Error("zigbee usb stick not avaliable")})};f.prototype.removeDevice=function(b,a){this._zigbeeStickAvaliable?this._zigbee.removeDevice(b,function(b){a&&
a({error:b})}):a&&a({error:Error("zigbee usb stick not avaliable")})};f.prototype.listDevices=function(b,a){if(b=this._zigbee.getDevices()){for(var c=[],d=b.length;d--;){var e=b[d].toJSON();c.push(e)}a&&a({data:c})}else a&&a({data:[]})};f.prototype.getAllStatesLegacy=function(b){for(var a=[],c=this._zigbee.getDevices(),d=c.length;d--;){var e=c[d],f=e.getConvertedStates();f&&(e={type:"ZIGBEE",adr:e.getIeeeAdr()+":"+e.getEndpointID(),state:f},a.push(e))}b&&b({data:a})};f.prototype.executeCommandLegacy=
function(b,a,c){this._zigbeeStickAvaliable?b?a?this._zigbee.executeCommand(b,a,function(a){c&&c({error:a})}):c&&c({error:Error("command invalid")}):c&&c({error:Error("address invalid")}):c&&c({error:Error("zigbee usb stick not avaliable")})};f.prototype.executeCommandNativeRaw=function(b,a){if(this._zigbeeStickAvaliable){var c=b.command;(b=b.value)&&(b=JSON.parse(b));var d=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];d.push(c);"undefined"!=typeof b&&null!=b&&(Array.isArray(b)?d=d.concat(b):
d.push(b));this._zigbee._exec(d.join(" "),function(b,c,d){if(b)a&&a({error:b});else if(d)a&&a({error:Error(d)});else try{if(c){var e=JSON.parse(c);a&&a({data:e})}else a&&a({})}catch(k){a&&a({error:Error(c)})}})}else a&&a({error:Error("zigbee usb stick not avaliable")})};return f}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zigbee.Handler);
