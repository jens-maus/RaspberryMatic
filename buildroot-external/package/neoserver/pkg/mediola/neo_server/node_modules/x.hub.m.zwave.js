var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.zwave=x.hub.m.zwave||{};var ozws=require("openzwave-shared"),os=require("os");x.hub.m.zwave.OZW=function(){var e=function e(_e,t){this._logger=require("x.logger.js").getLogger("x.hub.m.zwave.OZW"),this._port=_e,this._key=t,this._controller=null,this._initSuccess=!1,this._nodes={},this.CommandHandler=null;};return e.prototype._setPersistantData=function(e){if(localStorage)for(var t in e)localStorage.setItem("xnm.aio.zwave.OZW."+t,e[t]);},e.prototype._evalValue=function(e,t,o){var s=1;o.instance&&(s=o.instance),this._nodes[e].states[s]||(this._nodes[e].states[s]={}),50==t?"decimal"==o.type&&(this._nodes[e].states[s].power=o.value,this._nodes[e].states[s].state||("0.0"==o.value?this._nodes[e].states[s].state="off":this._nodes[e].states[s].state="on")):37==t?1==o.value?this._nodes[e].states[s].state="on":this._nodes[e].states[s].state="off":38==t?this._nodes[e].states[s].state=o.value:67==t?this._nodes[e].states[s].setpoint=o.value:66==t?this._nodes[e].states[s].state=o.value:68==t?this._nodes[e].states[s].fanmode=o.value:69==t?this._nodes[e].states[s].fanstate=o.value:49==t&&""!=o.units&&(1==this._initSuccess&&this._controller&&this._nodes[e].states[s].temperature!=o.value&&this._controller.writeConfig(),this._nodes[e].states[s].temperature=o.value);},e.prototype.init=function(e){this._logger.log("trace","init ozw");var t=this;if(this._initSuccess=!1,!this._controller){var o=new ozws({ConsoleOutput:!1});o.on("driver ready",function(e){t._logger.log("debug","driver ready");}),o.on("driver failed",function(){t._logger.log("warn","failed to start driver"),o.disconnect(),t._initSuccess=!1,e&&e(!1);}),o.on("value added",function(e,o,s){t._nodes[e]||(t._nodes[e]={info:{},states:{},ready:!1}),t._nodes[e].info.classes||(t._nodes[e].info.classes=[]),-1==t._nodes[e].info.classes.indexOf(o)&&t._nodes[e].info.classes.push(o),t._evalValue(e,o,s);}),o.on("node ready",function(e,s){for(var n in t._nodes[e]||(t._nodes[e]={info:{},states:{},ready:!1}),t._nodes[e].info.classes||(t._nodes[e].info.classes={}),t._nodes[e].ready=!0,t._nodes[e].info.type=s.type,t._nodes[e].info.producttype=s.producttype,t._nodes[e].info.manufacturer=s.manufacturer,t._nodes[e].info.manufacturerid=s.manufacturerid,t._nodes[e].info.product=s.product,t._nodes[e].info.productid=s.productid,t._nodes[e].info.classes){var r=t._nodes[e].info.classes[n];switch(r){case 37:case 38:case 66:case 67:case 68:case 69:o.enablePoll(e,r);}}}),o.on("node added",function(e){t._logger.log("trace","added node: "+e),t._nodes[e]||(t._nodes[e]={info:{},states:{},ready:!1});}),o.on("node event",function(e,o){t._logger.log("trace","event from node "+e);}),o.on("value changed",function(e,o,s){t._logger.log("trace","value changed for node "+e),t._evalValue(e,o,s),t._logger.log("trace","new state:"+JSON.stringify(t._nodes[e].states));}),o.on("notification",function(e,t){}),o.on("scan complete",function(){t._logger.log("trace","scan complete"),t._initSuccess=!0,e&&e(!0);}),this._controller=o;}this._controller.connect(this._port);},e.prototype.close=function(){this._logger.log("trace","close ozw"),this._controller&&(this._initSuccess=!1,this._controller.disconnect());},e.prototype.getDevices=function(e){return e&&e(this._nodes),this._nodes;},e.prototype.addNode=function(e,t,o){var s=30;if(o&&(s=o),this._controller){var n=this;setTimeout(function(){XC.debugf("addNode timeout?"),n._controller.cancelControllerCommand();},1e3*s),this._controller.addNode(e);}else t(null);},e.prototype.removeNode=function(e){this._controller&&(0==this._nodes[e].ready?this._controller.removeFailedNode(e):this._controller.removeNode(e));},e.prototype.executeCommand=function(e,t,o){try{if(this._controller){var s="1";if(e.instance&&(s=e.instance),"switch"==e.type||"powerswitch"==e.type)"toggle"==t&&(t="off",this._nodes[e.address].states&&this._nodes[e.address].states[s]&&"off"==this._nodes[e.address].states[s].state&&(t="on")),"on"==t?this._controller.setValue(e.address,37,s,0,!0):"off"==t&&this._controller.setValue(e.address,37,s,0,!1);else if("dimmer"==e.type){if(0==t.indexOf("dimTo"))t=(t=t.replace(/dimTo/g,"")).replace(/%/g,"");else if(0==t.indexOf("toggleTo")&&(t=(t=t.replace(/toggleTo/g,"")).replace(/%/g,""),this._nodes[e.address]&&this._nodes[e.address].states&&this._nodes[e.address].states[s])){var n=this._nodes[e.address].states[s].state;parseInt(n)>0&&(t="0");}parseInt(t)>100&&(t="100"),this._controller.setValue({node_id:e.address,class_id:38,instance:s,index:0},t),this._nodes[e.address].states[s].state=parseInt(t);}else"HM6-HP"==e.type&&(0==t.indexOf("setTo")&&(t=t.replace(/setTo/g,"")),parseFloat(t)<5&&(t="5.0"),parseFloat(t)>37&&(t="37.0"),this._controller.setValue({node_id:e.address,class_id:67,instance:s,index:2},t),this._nodes[e.address].states[s].setpoint=t);}}catch(e){console.error(e.stack),this._logger.log("trace","failed to execute command:"+e.message);}o&&o();},e.prototype.getAllBufferedStates=function(){var e=[];for(var t in this._nodes)if(this._nodes.hasOwnProperty(t)){var o=this._nodes[t];if(o&&o.states)for(var s in o.states)if(o.states.hasOwnProperty(s)){var n=o.states[s];e.push({address:t,instance:s,state:n});}}return e;},e.prototype.getStates=function(e,t,o){for(var s={},n=0;n<t.length;n++){var r=t[n];if(this._nodes[r.address]){var a="1";r.instance&&(a=r.instance),this._nodes[r.address].states[a]&&(s[r.id]=this._nodes[r.address].states[a]);}}return o&&o(s),s;},e.prototype.getStateValues=function(e,t){return t;},e;}(),x.hub.m.zwave.Handler=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("xnm.hub.m.zwave.Handler"),this._ozw=null;};return util.inherits(e,EventEmitter),e.prototype.OZW=x.hub.m.zwave.OZW,e.prototype.getSystems=function(){return["zwave"];},e.prototype.init=function(e){var t=this;process.on("SIGINT",function(){t._logger.log("debug","system exiting, disconnect zwave serial connection..."),t._ozw&&t._ozw.close(),setTimeout(function(){process.exit();},200);});var o=require("x.hub.eventbus.js");o.on("x.hub.peripheralman.ADD_ZWAVE",function(e){t._attachSerial(e.port);}),o.on("x.hub.peripheralman.REMOVE_ZWAVE",function(e){t._removeSerial(e.port);}),global.ZWAVE_PORT&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&this._attachSerial(global.ZWAVE_PORT),e&&e({});},e.prototype.getAllStates=function(){return this._ozw?this._ozw.getAllBufferedStates():[];},e.prototype.executeCommand=function(e,t,o){e&&e.address&&e.type?t&&t.value?this._ozw?this._ozw.executeCommand(e,t.value,function(e){o&&o({error:e});}):o&&o({error:new Error("zwave serial not initialized")}):o&&o({error:new Error("command invalid")}):o&&o({error:new Error("device invalid")});},e.prototype.getAllStatesLegacy=function(e){var t=[];this.getAllStates().forEach(function(e){if(e&&e.address&&e.state){var o=e.address,s=e.instance;s||(s="1");var n={module:"zwave",type:"ZWAVE",adr:o+"."+s,state:e.state};t.push(n);}}),e&&e({data:t});},e.prototype.executeCommandLegacy=function(e,t,o,s,n){if(e)n&&n({error:new Error("not supported yet")});else if(t){if(o){if(s){var r=t,a="1",i=t.indexOf(".");-1!=i&&(r=t.substr(0,i),a=t.substr(i+1)),this.executeCommand({address:r,instance:a,type:o},{value:s},function(e){n&&n({error:e?e.error:null});});}else n&&n({error:new Error("command invalid")});}else n&&n({error:new Error("type invalid")});}else n&&n({error:new Error("address invalid")});},e.prototype._attachSerial=function(e){this._logger.log("trace","zwave usb stick attached at port:"+e),this._ozw||(this._ozw=new x.hub.m.zwave.OZW(e)),this._ozw._port=e,this._logger.log("trace","init ozw at port:"+e),this._ozw.init();},e.prototype._removeSerial=function(e){this._logger.log("trace","zwave usb stick removed from port:"+e),this._ozw&&(this._logger.log("trace","close ozw at port:"+e),this._ozw.close());},e;}(),x.hub.m.zwave.Handler.prototype.getStateValues=function(e,t){return new xnm.aio.zwave.OZW().getStateValues(e.type,t);},x.hub.m.zwave.Handler.prototype.getDeviceCommandList=function(e,t,o){var s=[];return"switch"==e.type?(s.push({id:"on",cmd:"on"}),s.push({id:"off",cmd:"off"}),s.push({id:"toggle",cmd:"toggle"})):"dimmer"==e.type?s.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"}):"HM6-HP"==e.type&&s.push({id:"setTo",cmd:"setTo",step:"0.5",min:"5.0",max:"37.0"}),s;},x.hub.m.zwave.Handler.prototype.__getStates=function(e,t){this._ozw?this._ozw.getStates(null,e,function(e){t&&t({data:e});}):t&&t({error:new Error("zwave serial not initialized")});},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zwave.Handler());