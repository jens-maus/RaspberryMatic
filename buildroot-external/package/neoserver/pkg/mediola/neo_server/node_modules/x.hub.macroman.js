var x=x||{};x.hub=x.hub||{},x.hub.macroman=x.hub.macroman||{},x.hub.macroman.MacroManager=function(e,n){var r=function r(e,n){this._logger=require("x.logger.js").getLogger("x.hub.macroman.MacroManager"),this._tenant=null,this._handler=null,this._folder=e,this._folder||(this._folder="db"),this._tenantIdx=n,this._tenantIdx||(this._tenantIdx=1);};return r.prototype.init=function(e,n){this._logger.log("info","init macro managaer:"+this._folder);var r=require("m.aio.configmanager.js"),a=require("m.aio.macromanager.js"),t=this._generateTenantParent(e);this._tenant=new r.Tenant(t),this._tenant.index=this._tenantIdx,this._tenant.license="dummy",this._tenant.folder=this._folder,this._handler=new a.Handler(this._tenant);var o=require("fs-extra"),i=this;o.ensureDir(this._tenant.getFolderPath(),function(){i._load(n);});},r.prototype.execute=function(e,n,r,a,t){this._handler.execute(e,n,r,a,t);},r.prototype.reload=function(e){this._load(e);},r.prototype._load=function(e){var n=this;this._handler._loadMacros(function(r){r&&n._logger.log("warn","init macro error:"+r.message),e&&e(r);});},r.prototype._generateTenantParent=function(e){return{fileManager:e,getFolderPath:function getFolderPath(){return this.fileManager.getUserRootDataPath();},getFolder:function getFolder(){return"";}};},r.prototype.findMacro=function(e,n,r){this._handler.findMacro(e,n,r);},r.prototype.findMacroIdx=function(e,n,r){this._handler.findMacroIdx(e,n,r);},r;}(),x.hub.macroman.Handler=function(){this.macroManager=new x.hub.macroman.MacroManager("db",1),this.macroManager2=new x.hub.macroman.MacroManager("db2",2);},x.hub.macroman.Handler.prototype.MacroManager=x.hub.macroman.MacroManager,x.hub.macroman.Handler.prototype.init=function(e,n,r){"CA"==global.HARDWARE_VERSION?this._configNew(e):this._config(e);var a=this;this.macroManager.init(n,function(){a.macroManager2.init(n,r);});},x.hub.macroman.Handler.prototype._configNew=function(e){var n=this;require("x.hub.js").getServer().addRoute("/xhub/macromanager/",function(e,r){var a=e.method.toLowerCase(),t=(e.path.substr(19),e.url),o=t.indexOf("?");-1!=o&&(t=t.substr(0,o));var i=e.query,c=e.body,u=null;switch(a){case"get":u="read";break;case"post":u="create";break;case"put":u="update";break;case"delete":u="delete";}if(u)n.macroManager.execute(u,t,i,c,function(e,n){e?r.send(this.error2json(e)):n.toJSON&&"function"==typeof n.toJSON?r.send(n.toJSON()):r.send(n);}.bind(this));else{var d=new Error("invalid http method");d.code=500,r.send(this.error2json(d));}}.bind(this));},x.hub.macroman.Handler.prototype._config=function(e){var n=this;e.use("/xhub/macromanager/:tenantIdx",function(e,r){var a=e.method.toLowerCase(),t=(e.params.tenantIdx,e.url),o=t.indexOf("?");-1!=o&&(t=t.substr(0,o));var i=e.query,c=e.body,u=null;switch(a){case"get":u="read";break;case"post":u="create";break;case"put":u="update";break;case"delete":u="delete";}if(u)n.macroManager.execute(u,t,i,c,function(e,n){e?r.send(this.error2json(e)):n.toJSON&&"function"==typeof n.toJSON?r.send(n.toJSON()):r.send(n);}.bind(this));else{var d=new Error("invalid http method");d.code=500,r.send(this.error2json(d));}}.bind(this));},x.hub.macroman.Handler.prototype.execute=function(e,n,r,a){this.macroManager.findMacro(e,n,function(e,n){e?r&&r({error:e}):require("x.hub.commandman.js").commandHandler.executeMacro(n,function(e){r&&r(e);},a);});},x.hub.macroman.Handler.prototype.cancel=function(e,n){require("x.hub.commandman.js").commandHandler.cancelMacro(e,function(e){n&&n(e);});},x.hub.macroman.Handler.prototype.executeWithIdx=function(e,n,r){this.macroManager.findMacroIdx(e,n,function(e,n){e?r&&r({error:e}):require("x.hub.commandman.js").commandHandler.executeMacro(n,function(e){r&&r(e);});});},x.hub.macroman.Handler.prototype.execute2=function(e,n,r){this.macroManager2.findMacro(e,n,function(e,n){e?r&&r({error:e}):require("x.hub.commandman.js").commandHandler2.executeMacro(n,function(e){r&&r(e);});});},x.hub.macroman.Handler.prototype.executeWithIdx2=function(e,n,r){this.macroManager2.findMacroIdx(e,n,function(e,n){e?r&&r({error:e}):require("x.hub.commandman.js").commandHandler2.executeMacro(n,function(e){r&&r(e);});});},module.exports=new x.hub.macroman.Handler();