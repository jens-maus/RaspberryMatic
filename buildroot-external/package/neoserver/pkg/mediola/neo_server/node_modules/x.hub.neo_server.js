var x=x||{};x.hub=x.hub||{},x.hub.neo_server=x.hub.neo_server||{},x.hub.neo_server.Time=function(){var e=function e(_e){this._logger=require("x.logger.js").getLogger("x.hub.neo_server.Time"),this._handler=_e;};return e.TimeZone_MAP=[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"Europe/Dublin"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},{utc:-11,dst:!0,zone:"Etc/GMT+11"}],e.prototype.init=function(e){e&&e();},e.prototype.getTimezoneSync=function(){var t=new Date(),r=new Date(t.getFullYear(),0,1),n=new Date(t.getFullYear(),6,1),o=r.getTimezoneOffset(),i=n.getTimezoneOffset(),u=o!=i,c=Math.max(o,i),a=Math.round((0-c)/60),s=null;return e.TimeZone_MAP.forEach(function(e){e.utc==a&&e.dst==u&&(s=e.zone);}),s;},e.prototype.getTimezoneEncoded=function(e){var t=new Date(),r=new Date(t.getFullYear(),0,1),n=new Date(t.getFullYear(),6,1),o=r.getTimezoneOffset(),i=n.getTimezoneOffset(),u=o!=i,c=Math.max(o,i),a=Math.round((0-c)/60)+11;a<0&&(a=0),a>12&&(a=12);var s=(u?1:0)<<7|31&a;(s=(255&s).toString(16).toUpperCase()).length<2&&(s="0"+s),e&&e(null,s);},e;}(),x.hub.neo_server.Network=function(){var e=function e(_e2){this._logger=require("x.logger.js").getLogger("x.hub.neo_server.Network"),this._handler=_e2;};return e.prototype.init=function(e){e&&e();},e.prototype.getNetwork=function(e){var t=this;this._getDNS(function(r,n){t._getRouter(function(t,r){var o=require("os").networkInterfaces(),i={};for(var u in o)if("lo"!=u.substr(0,2))for(var c=o[u],a=0;a<c.length;a++){var s=c[a];if(!s.internal&&"IPv4"==s.family){var d={ip:s.address,subnet:s.netmask,mac:s.mac,dns:n};d.router=r?r[u]:null,i[u]=d;}}e&&e(null,i);});});},e.prototype._getDNS=function(e){var t=require("dns"),r=[];t&&t.getServers&&(r=t.getServers()),e(null,r);},e.prototype._getRouter=function(e){try{var t=require("netroute").getInfo(),r={};if(t&&t.IPv4)for(var n=0;n<t.IPv4.length;n++)"0.0.0.0"==t.IPv4[n].destination&&t.IPv4[n]["interface"]&&t.IPv4[n].gateway&&(r[t.IPv4[n]["interface"]]=t.IPv4[n].gateway);e(null,r);}catch(t){e(t);}},e;}(),x.hub.neo_server.Handler=function(){var e=function e(){this._network=new x.hub.neo_server.Network(this),this._time=new x.hub.neo_server.Time(this),this._hub=null;};return e.prototype.init=function(e,t){this._hub=e,this._network.init(),this._time.init(),t&&t();},e.prototype.setTZData=function(e,t){t&&t();},e.prototype.getTZData=function(e){this._time.getTimezoneEncoded(e);},e.prototype.getTimezoneSync=function(){return this._time.getTimezoneSync();},e.prototype.reset=function(e,t){var r=this;"factory"===e?this._stm.reset(function(e){e?t&&t(e,!e):r._zwayServer.reset(function(){r._sysConf.reset(function(e){t&&t(e,!e);});});}):t&&t(new Error("unknonw reset type: "+e));},e.prototype.backup=function(e,t,r){var n=this,o=null,i=require("x.crypt.js");e.query.enc&&"0"!=e.query.enc&&"false"!=e.query.enc&&(e.query.at?o=e.query.at:e.query.auth&&(o=i.MD5(unescape(encodeURI(e.query.auth+"_SALT!")))));var u=require("fs"),c=require("os").tmpdir(),a=require("path"),s=a.join(c,"backup");if(u.existsSync(s))try{u.rmdirRecursiveSync(s);}catch(e){}try{u.mkdirSync(s);}catch(e){return t.status(500).end(),void(r&&r(new Error('create backup folder "'+a+'" failed:'+e.message)));}this._backup(s,function(e){if(e)return t.status(500).end(),void(r&&r(e));!function(e,t,r){var o=require("fs-extra"),i=require("path"),u=require("os").tmpdir(),c=require("archiver"),a=new Date(),s=a.getFullYear()+"",d=a.getMonth()+1+"";1==d.length&&(d="0"+d);var f=a.getDate()+"";1==f.length&&(f="0"+f);var l=a.getHours()+"";1==l.length&&(l="0"+l);var p=a.getMinutes()+"";1==p.length&&(p="0"+p);var h=a.getSeconds()+"";1==h.length&&(h="0"+h);var v="backup_"+(s+d+f+l+p+h)+".xbp",y=i.join(u,v),g=o.createWriteStream(y),z=c("zip");g.on("close",function(){if(t){var e=require("crypto").createCipher("aes-256-cbc",t),n=o.createReadStream(y),i=o.createWriteStream(y+".enc");i.on("finish",function(){o.removeSync(y),r(null,y+".enc",v);}),n.pipe(e).pipe(i);}else r(null,y,v);}),g.on("error",function(e){n._logger.log("warn","write backup zip file failed:"+e.message),r(e);}),z.on("error",function(e){n._logger.log("warn","zip backup data failed:"+e.message),r(e);}),z.pipe(g),z.directory(e+"/","backup"),z.finalize();}(s,o,function(e,n,o){if(e)return t.status(500).end(),void(r&&r(e));t.setHeader("Content-disposition","attachment; filename="+o),t.sendFile(n,null,function(e){require("fs-extra").removeSync(n),e&&t.status(500).end(),r&&r(e);});});});},e.prototype._backup=function(e,t){require("async").series([function(t){var r=require("fs-extra"),n=require("path"),o=require("x.hub.fileman.js").fileManager.getUserRootDataPath();r.copy(o,n.join(e,"data"),function(o){o?t(o):r.exists(n.join(e,"data","localstorage","x.hub.Server.pwd"),function(o){o?r.remove(n.join(e,"data","localstorage","x.hub.Server.pwd"),function(e){t(e);}):t();});});}],function(e){t&&t(e);});},e.prototype.restore=function(e,t,r){var n=require("x.crypt.js"),o=null;e.query.key?o=e.query.key:e.query.at?o=e.query.at:e.query.auth&&(o=n.MD5(unescape(encodeURI(e.query.auth+"_SALT!"))));var i=this;!function(e,t){var r=require("fs"),n=require("os").tmpdir(),o=require("path").join(n,"restore.zip");if(r.existsSync(o))try{r.unlinkSync(o);}catch(e){return void t(e);}var i=r.createWriteStream(o);e.pipe(i),i.on("finish",function(){i.close(function(){t(null,o);});}),i.on("error",function(e){r.unlink(o),t(e);});}(e,function(e,n){if(e)return t.json({XC_ERR:{code:"000000",msg:"donwload backup file failed:"+e.message}}),void(r&&r(e));!function(e,t,r){var n=require("fs"),o=require("fs-extra"),i=require("os").tmpdir(),u=require("path"),c=u.join(i,"restore"),a=u.join(c,"backup");if(o.existsSync(c))try{o.removeSync(c);}catch(e){return void r(e);}o=require("fs-extra");var s=require("adm-zip"),d=null;try{new s(e).extractAllTo(c,!0);}catch(e){d="invalid backup file/password";}if(d){if(t){var f=require("crypto").createDecipher("aes-256-cbc",t),l=n.createReadStream(e),p=n.createWriteStream(e+".dec.zip");f.on("error",function(){o.removeSync(e),o.removeSync(e+".dec.zip"),r(new Error(d));}),p.on("finish",function(){d=null;try{new s(e+".dec.zip").extractAllTo(c,!0);}catch(e){d="invalid backup file/password";}o.removeSync(e),o.removeSync(e+".dec.zip"),r(d?new Error(d):null,a);}),l.pipe(f).pipe(p);}else o.removeSync(e),r(new Error(d)),r=null;}else o.removeSync(e),r(null,a),r=null;}(n,o,function(e,o){if(e)return t.json({XC_ERR:{code:"000000",msg:"extract backup data failed:"+e.message}}),void(r&&r(e));i._restore(o,function(e){try{var i=require("fs-extra");i.removeSync(n),i.removeSync(o);}catch(e){}e?t.json({XC_ERR:{code:"000000",msg:"restore backup data failed:"+e.message}}):t.json({XC_SUC:{}}),r&&r(e);});});});},e.prototype._restore=function(e,t){require("async").series([function(t){var r=require("fs-extra"),n=require("path"),o=require("x.hub.fileman.js").fileManager.getUserRootDataPath();r.copy(n.join(e,"data"),o,function(e){t(e?new Error("restore standard data failed:"+e.message):null);});}],function(e){t&&t(e);});},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.neo_server.Handler());