var x=x||{};x.hub=x.hub||{};x.hub.recordman=x.hub.recordman||{};
x.hub.recordman.Record=function(){var c=function(){this._lastHitTime=this.status=this.gateway=this.device=this.stateName=this.deviceName=this.roomName=this.id=null};c.prototype.isMatch=function(b){if(!b||!b.device||!b.device.sys)return!1;var a=require("x.hub.moduleman.js").modulemanager.getModule(b.device.sys);if(!a||!a.checkDeviceMatch||!a.checkDeviceMatch({device:this.device,gateway:this.gateway},b))return!1;a=this.status;a.ref&&a.ref.value?a=a.ref.value:a.value&&(a=a.value);return a==b.data.key};
c.prototype._saveRecord=function(b){if(b&&b.data&&"undefined"!=typeof b.data.value&&null!=b.data.value&&this.deviceName&&this.stateName){var a=require("x.hub.datastore.js").dataStore;if(a){var e=(new Date).getTime(),d=[this.roomName,this.deviceName,this.stateName,b.data.value,e];a.openDB(function(a,b){a||b.serialize(function(){var a=d.join(" "),a="INSERT INTO windowstate(room, name, state, value, time) "+a+";";b.run(a,function(a){b.close()})})})}}};c.prototype.onStatusEvt=function(b){var a=!1;this._logger.log("trace",
"check record for status event");this.isMatch(b)&&(this._logger.log("debug","record hit:"+JSON.stringify(this.toJSON())),a=!0);a&&(a=(new Date).getTime(),this._lastHitTime&&2E3>a-this._lastHitTime||(this._lastHitTime=a,this._saveRecord(b)))};c.prototype.toJSON=function(){return{id:this.id,roomName:this.roomName,deviceName:this.deviceName,stateName:this.stateName,device:this.device,gateway:this.gateway,status:this.status}};c.parse=function(b){if(!(b&&b.id&&b.deviceName&&b.stateName))return null;var a=
new c;a.id=b.id;a.roomName=b.roomName;a.deviceName=b.deviceName;a.stateName=b.stateName;a.device=b.device;a.gateway=b.gateway;a.status=b.status;return a};return c}();
x.hub.recordman.RecordManager=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.recordman.RecordManager");this._rmFile=null;this._records=[]};c.FILE_NAME="rm.json";c.prototype.init=function(b,a){var e=require("fs_extra"),d=require("path");this._rmFile||(this._rmFile=d.resolve(b.getUserRootDataPath(),c.FILE_NAME));var g=this;e.ensureFile(this._rmFile,function(b){b?a&&a(b):g._loadRecords(function(){g._initDB(a)})})};c.prototype.reload=function(b){this._loadRecords(b)};
c.prototype.createRecord=function(b,a){if(b){for(var e=1,d=-1,c=0;c<this._records.length;c++)if(this._records[c].id>e){b.id=e;d=c;break}else e++;-1==d&&(b.id=e,d=this._records.length);this._records.splice(d,0,b);this._writeData(a)}else a&&a(Error("record is null"))};c.prototype.readRecord=function(b,a){if(b){for(var e=null,d=0;d<this._records.length;d++){var c=this._records[d];if(c.id==b){e=c;break}}e?a&&a(null,e):a&&a(Error("no such record with id:"+b))}else a&&a(Error("record id is null"))};c.prototype.readAllRecords=
function(b){b&&b(null,this._records)};c.prototype.updateRecord=function(b,a){for(var e=null,d=-1,c=0;c<this._records.length;c++){var f=this._records[c];if(f.id==b.id){e=f;d=c;break}}e?(this._records.splice(d,1,b),this._writeData(a)):a&&a(Error("no such record with id:"+b.id))};c.prototype.deleteRecord=function(b,a){if(b){for(var e=-1,d=0;d<this._records.length;d++)if(this._records[d].id==b){e=d;break}-1!=e&&this._records.splice(e,1);this._writeData(a)}else a&&a(Error("record id is null"))};c.prototype.onStatusEvt=
function(b){this._logger.log("info","receive status event:"+JSON.stringify(b));for(var a=0;a<this._records.length;a++)this._records[a].onStatusEvt(b)};c.prototype._initDB=function(b){var a=require("x.hub.datastore.js").dataStore;a?a.openDB(function(a,d){a?b&&b(a):d.serialize(function(){d.run("CREATE TABLE IF NOT EXISTS devicestate (id integer primary key autoincrement, room text, name text, state text, value text,time datetime default current_timestamp)",function(a){d.close();b&&b(a)})})}):b&&b(Error("data store not initialized"))};
c.prototype._loadRecords=function(b){var a=this;this._readData(function(e,d){e?b&&b(e):(a._records=d,a._sort(),b&&b())})};c.prototype._readData=function(b){require("fs").readFile(this._rmFile,"utf8",function(a,e){if(a)b&&b(a);else if(e)try{var d=JSON.parse(e),c=[];Array.isArray(d)&&d.forEach(function(a){(a=x.hub.recordman.Record.parse(a))&&c.push(a)});b&&b(null,c?c:[])}catch(f){b&&b(f)}else b&&b(null,[])})};c.prototype._writeData=function(b){var a=[];this._records.forEach(function(b){b&&a.push(b.toJSON())});
require("fs").writeFile(this._rmFile,JSON.stringify(a,null,2),function(a){b&&b(a)})};c.prototype._sort=function(){var b=this._records.length-1,a=!1;do for(var a=!1,c=0;c<b;++c)this._records[c].id>this._records[c+1].id&&(a=this._records[c],this._records[c]=this._records[c+1],this._records[c+1]=a,a=!0);while(a)};return c}();
x.hub.recordman.Handler=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.recordman.Handler");this.recordManager=new x.hub.recordman.RecordManager};c.prototype.RecordManager=x.hub.recordman.RecordManager;c.prototype.init=function(b,a,c){require("x.hub.eventbus.js").on("status",this.onStatusEvt.bind(this));this._config(b);this.recordManager.init(a,function(a){c&&c({error:a})})};c.prototype.doWebRequest=function(b,a,c){var d=function(a){if(a.error){var b=x.hub.taskman.ERROR_CODE.General_Error;
a.error.code&&(b=a.error.code);c(JSON.stringify({XC_ERR:{code:b,msg:a.error.message}}))}else c(JSON.stringify({XC_SUC:a.data?a.data:""}))};switch(b){case "Read":b=a.query.id;"undefined"==typeof b?this.readAllTasks(d):this.readTask(b,d);break;case "Create":this.createTask(a.query.data,d);break;case "Update":this.updateTask(a.query.data,a.query.pin,d);break;case "Delete":this.deleteTask(a.query.id,a.query.pin,d);break;case "SetTaskActive":this.setTaskActive(a.query.id,a.query.active,a.query.pin,d);
break;case "SetAlarmActive":this.setAlarmActive(a.query.active,a.query.pin,d);break;case "SetAlarmDelay":this.setAlarmDelay(a.query.delay,a.query.pin,d);break;case "GetAlarmInfo":this.getAlarmInfo(d);break;case "SelectAlarmTask":this.selectAlarmTask(a.query.id,a.query.isAlarmTask,a.query.pin,d);break;case "SetAlarmPin":this.setAlarmPin(a.query.newPin,a.query.pin,d)}};c.prototype.readAllRecords=function(b){this.recordManager.readAllRecords(function(a,c){if(a)b&&b({error:a});else{var d=[];c.forEach(function(a){d.push(a.toJSON())});
b&&b({data:d})}})};c.prototype.createRecord=function(b,a){if(b){b.id||(b.id=-1);var c=x.hub.recordman.Record.parse(b);c?this.recordManager.createRecord(c,function(b){a&&a({error:b})}):a&&a({error:Error("record json invalid")})}else a&&a({error:Error("record json is null")})};c.prototype.readRecord=function(b,a){this.recordManager.readRecord(b,function(b,c){a&&a({error:b,data:c?c.toJSON():null})})};c.prototype.updateRecord=function(b,a){if(b){var c=x.hub.recordman.Record.parse(b);c?this.recordManager.updateRecord(c,
function(b){a&&a({error:b})}):a&&a({error:Error("record json invalid")})}else a&&a({error:Error("record json is null")})};c.prototype.deleteRecord=function(b,a){this.recordManager.deleteRecord(b,function(b){a&&a({error:b})})};c.prototype.onStatusEvt=function(b){this._logger.log("trace","receive status event:"+JSON.stringify(b));this.recordManager.onStatusEvt(b)};return c}();module.exports=new x.hub.recordman.Handler;
