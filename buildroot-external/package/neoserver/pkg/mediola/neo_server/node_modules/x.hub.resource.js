var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var d=0;return function(){return d<a.length?{done:!1,value:a[d++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,e){a!=Array.prototype&&a!=Object.prototype&&(a[d]=e.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var d=0;d<a.length;++d){var e=a[d];if(e&&e.Math==Math)return e}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,d){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:d})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function a(e){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(e||"")+"_"+d++,e)}var d=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,d){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var e=0,b={next:function(){if(e<a.length){var c=e++;return{value:d(c,a[c]),done:!1}}b.next=function(){return{done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};
$jscomp.polyfill=function(a,d,e,b){if(d){e=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var c=a[b];c in e||(e[c]={});e=e[c]}a=a[a.length-1];b=e[a];d=d(b);d!=b&&null!=d&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.resource=x.hub.resource||{};
x.hub.resource.ResourceManager=function(){var a=function(b){this._name=b?b.name:null;this._path=b?b.path:null};a.prototype.getName=function(){return this._name};a.prototype.getPath=function(){return this._path};a.prototype.getURL=function(){};a.prototype.toJSON=function(){return{name:this._name,path:this._path}};a.parseJSON=function(b){return b&&b.name&&b.path?new a(b):null};var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceContainer");this._rootDataFolder=null;
this._resourceFolderName="resources";this._metaFile="resource.json";this._resources=[]};d.prototype.getResourceFolder=function(){return require("path").join(this._rootDataFolder,this._resourceFolderName)};d.prototype.getMetaFilePath=function(){return require("path").join(this.getResourceFolder(),this._metaFile)};d.prototype.init=function(b,c){this._logger.log("info","init resource folder:"+b);this._rootDataFolder=b;var f=this;this._init(function(g){g&&f._logger.log("warn","init resource folder:"+
b+" faild:"+g.message);c&&c(g)})};d.prototype.listFiles=function(b){if(!b)return this._resources;for(var c=[],f=0,g=this._resources.length;f<g;f++){var a=this._resources[f];if(a){var d=a.getName();d&&d.substr(0,b.length)==b&&c.push(a)}}return c};d.prototype.getFilePath=function(b){for(var c=0,f=this._resources.length;c<f;c++){var g=this._resources[c];if(g){var a=g.getName();if(a&&a==b&&(g=g.getPath()))return require("path").join(this.getResourceFolder(),g)}}};d.prototype.getFileURL=function(b,c){for(var f=
null,g=0,a=this._resources.length;g<a;g++){var d=this._resources[g];if(d&&(d=d.getName())&&d==b){f="http://";c=this._getLocalIP(c);g=this._getLocalPort();f+=c;g&&(f+=":"+g);f+="/file/"+b;break}}return f};d.prototype.createFile=function(b,c,f){var g=b.split("/");g=this._genFilePath(g[g.length-1]);var d=require("path").relative(this.getResourceFolder(),g),h=this;this._createFile(g,c,function(c,g){c?f&&f(c):(c=a.parseJSON({name:b,path:d}),h._resources.push(c),c=h._resources2meta(h._resources),h._saveMetaFile(c,
function(b){f&&f(b,g)}))})};d.prototype.deleteFile=function(b,c){var f=this.getFilePath(b);if(f){for(var g=-1,a=0,d=this._resources.length;a<d;a++){var e=this._resources[a];if(e&&e.getName()==b){g=a;break}}var l=this;this._deleteFile(f,function(b){b?c&&c(b):(l._resources.splice(g,1),b=l._resources2meta(l._resources),l._saveMetaFile(b,function(b){c&&c(b)}))})}else c&&c()};d.prototype._init=function(b){var c=this;this._loadMetaFile(function(f,g){f?b&&b(f):(c._resources=c._meta2resources(g),b&&b(null))})};
d.prototype._loadMetaFile=function(b){var c=require("fs-extra"),f=this.getMetaFilePath();c.ensureFile(f,function(g){g?b&&b(g):c.readFile(f,{encoding:"utf8"},function(c,f){if(c)b&&b(c);else try{var g=[];f&&(g=JSON.parse(f));b&&b(null,g)}catch(l){b&&b(c)}})})};d.prototype._meta2resources=function(b){var c=[];if(b)for(var f=0,g=b.length;f<g;f++)if(b[f]){var d=a.parseJSON(b[f]);d&&c.push(d)}return c};d.prototype._resources2meta=function(b){for(var c=[],f=0,g=b.length;f<g;f++){var a=b[f];a&&c.push(a.toJSON())}return c};
d.prototype._saveMetaFile=function(b,c){var f=require("fs-extra"),g=this.getMetaFilePath();f.ensureFile(g,function(a){a?c&&c(a):f.writeFile(g,JSON.stringify(b),function(b){c&&c(b)})})};d.prototype._genFilePath=function(b){var c=require("path");b=c.extname(b);for(var f={},a=0,d=this._resources.length;a<d;a++){var e=this._resources[a];e&&(e=e.getPath(),f[e]=!0)}for(a=1;;)if(f[a+b])a++;else break;return c.join(this.getResourceFolder(),a+b)};d.prototype._createFile=function(b,c,f){var a=require("fs-extra");
a.exists(b,function(d){if(d)try{a.removeSync(b)}catch(l){f&&f(l);return}var g=f,e=0;d=a.createWriteStream(b);d.on("error",function(b){g&&(g(b),g=null)});c.on("data",function(b){e+=b.length});c.on("end",function(){g&&(g(null,e),g=null)});c.on("error",function(b){g&&(g(b),g=null)});c.pipe(d)})};d.prototype._deleteFile=function(b,c){var a=require("fs-extra");a.exists(b,function(f){f?a.remove(b,function(b){c&&c(b)}):c&&c()})};d.prototype._getLocalIP=function(b){var c=null,a=require("os").networkInterfaces(),
d;for(d in a)for(var e=a[d],h=0;h<e.length;h++){var k=e[h];if(k&&"IPv4"==k.family&&0==k.internal)if(b){if(this._matchSubnetMask(k.address,b,k.netmask))return k.address;c=k.address}else return k.address}return c};d.prototype._getLocalPort=function(){var b=require("x.hub.js");return b.server?b.server._port:null};d.prototype._matchSubnetMask=function(b,c,a){b=this._ip2int(b);c=this._ip2int(c);a=this._ip2int(a);return(b&a)==(c&a)};d.prototype._ip2int=function(b){return b.split(".").reduce(function(b,
a){return(b<<8)+parseInt(a,10)},0)>>>0};var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceManager");this._userResourceContainer=this._sysResourceContainer=this._userDataFolder=this._systemDataFolder=null};e.prototype.init=function(b,c){this._logger.log("info","init resource manager");this._systemDataFolder=b.getAppRootDataPath();this._userDataFolder=b.getUserRootDataPath();this._init(c)};e.prototype.listFiles=function(b){var c={},a=this._sysResourceContainer.listFiles(b);
if(a)for(var d=0,e=a.length;d<e;d++){var h=a[d];h=h.getName();c[h]=!0}if(a=this._userResourceContainer.listFiles(b))for(d=0,e=a.length;d<e;d++)h=a[d],h=h.getName(),c[h]=!0;return Object.keys(c)};e.prototype.getFilePath=function(b){var c=this._userResourceContainer.getFilePath(b);c||(c=this._sysResourceContainer.getFilePath(b));return c};e.prototype.createFile=function(b,c,a){"public/system/"==b.substr(0,14)?a&&a(Error("not allow to upload file to public/system/")):this.getFilePath(b)?a&&a(Error("file:"+
b+" exists")):this._userResourceContainer.createFile(b,c,a)};e.prototype.deleteFile=function(b,c){this._sysResourceContainer.getFilePath(b)?c&&c(Error("not allow to delete file from system folder")):this._userResourceContainer.deleteFile(b,c)};e.prototype.getFileURL=function(b,c){var a=this._userResourceContainer.getFileURL(b,c);a||(a=this._sysResourceContainer.getFileURL(b,c));return a};e.prototype._init=function(b){var a=this;this._initSystemResourceContainer(function(c){c?b&&b(c):a._initUserResourceContainer(function(a){b&&
b(a)})})};e.prototype._initSystemResourceContainer=function(b){this._sysResourceContainer=new d;this._sysResourceContainer.init(this._systemDataFolder,b)};e.prototype._initUserResourceContainer=function(b){this._userResourceContainer=new d;this._userResourceContainer.init(this._userDataFolder,b)};return e}();
x.hub.resource.Handler=function(){var a=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.Handler");this.resourceManager=new x.hub.resource.ResourceManager};a.prototype.init=function(a,e,b){"CA"==global.HARDWARE_VERSION?this._initHttpApi(a):this._initHttpApiOld(a);this.resourceManager.init(e,function(a){a&&b(a)})};a.prototype._initHttpApi=function(a){var d=this;a=require("x.hub.js").getServer();a.addRoute("/file/",{method:"GET",source:1,auth:0},function(b,a,f){var c=b.path.substr(6),
e=!1;e=c&&"public/"==c.substr(0,7)?!0:b.hasValidAuth;if("/"==b.path.charAt(b.path.length-1)){b=null;if(!c&&!e)c="public/";else if(c&&"public/"!=c.substr(0,7)&&!e){a.json({XC_ERR:{code:"000007",msg:"access denied"}});return}b=d.listFiles(c);a.json({XC_SUC:b?b:[]})}else if(c&&"public/"!=c.substr(0,7)&&!e)a.status(403).json({XC_ERR:{code:"000007",msg:"access denied"}});else{var h=d.getFilePath(c);h?require("fs").exists(h,function(b){b?a.sendFile(h,null,function(b){b&&f(b)}):a.status(404).json({XC_ERR:{code:"000404",
msg:"not found"}})}):a.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}});a.addRoute("/file/",{method:"POST",source:1,body:"stream"},function(b,a){if("/"==b.path.charAt(b.path.length-1))a.json({XC_ERR:{code:"000101",msg:"no file name"}});else{var c=b.path.substr(6),e=b.headers["content-length"];e&&parseInt(e)?d.createFile(c,b,function(b,c){b?a.json({XC_ERR:{code:"000101",msg:b.message}}):a.json({XC_SUC:{bytes:c}})}):d.deleteFile(c,function(b){b?a.json({XC_ERR:{code:"000101",msg:b.message}}):
a.json({XC_SUC:{}})})}})};a.prototype._initHttpApiOld=function(a){var d=this,b=require("x.hub.js").getServer();a.get("/file/*",function(a,f,e){var c=a.path.substr(6),g=!1;g=c&&"public/"==c.substr(0,7)?!0:b.auth(a);if("/"==a.path.charAt(a.path.length-1)){a=null;if(!c&&!g)c="public/";else if(c&&"public/"!=c.substr(0,7)&&!g){f.json({XC_ERR:{code:"000007",msg:"access denied"}});return}a=d.listFiles(c);f.json({XC_SUC:a?a:[]})}else if(c&&"public/"!=c.substr(0,7)&&!g)f.status(403).json({XC_ERR:{code:"000007",
msg:"access denied"}});else{var k=d.getFilePath(c);k?require("fs").exists(k,function(b){b?f.sendFile(k,null,function(b){b&&e(b)}):f.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}):f.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}});a.post("/file/*",function(a,f){if(b.auth(a))if("/"==a.path.charAt(a.path.length-1))f.json({XC_ERR:{code:"000101",msg:"no file name"}});else{var c=a.path.substr(6),e=a.headers["content-length"];e&&parseInt(e)?d.createFile(c,a,function(a,b){a?f.json({XC_ERR:{code:"000101",
msg:a.message}}):f.json({XC_SUC:{bytes:b}})}):d.deleteFile(c,function(a){a?f.json({XC_ERR:{code:"000101",msg:a.message}}):f.json({XC_SUC:{}})})}else f.json({XC_ERR:{code:"000007",msg:"access denied"}})})};a.prototype.listFiles=function(a){return this.resourceManager.listFiles(a)};a.prototype.getFilePath=function(a){return this.resourceManager.getFilePath(a)};a.prototype.createFile=function(a,e,b){this.resourceManager.createFile(a,e,b)};a.prototype.deleteFile=function(a,e){this.resourceManager.deleteFile(a,
e)};a.prototype.getFileURL=function(a,e){return this.resourceManager.getFileURL(a,e)};return a}();module.exports=new x.hub.resource.Handler;
