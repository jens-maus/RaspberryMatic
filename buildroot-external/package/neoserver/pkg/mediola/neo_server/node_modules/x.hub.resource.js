var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(f){var e=0;return function(){return e<f.length?{done:!1,value:f[e++]}:{done:!0}}};$jscomp.arrayIterator=function(f){return{next:$jscomp.arrayIteratorImpl(f)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(f,e,h){if(f==Array.prototype||f==Object.prototype)return f;f[e]=h.value;return f};$jscomp.getGlobal=function(f){f=["object"==typeof globalThis&&globalThis,f,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var e=0;e<f.length;++e){var h=f[e];if(h&&h.Math==Math)return h}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(f,e){var h=$jscomp.propertyToPolyfillSymbol[e];if(null==h)return f[e];h=f[h];return void 0!==h?h:f[e]};
$jscomp.polyfill=function(f,e,h,a){e&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(f,e,h,a):$jscomp.polyfillUnisolated(f,e,h,a))};$jscomp.polyfillUnisolated=function(f,e,h,a){h=$jscomp.global;f=f.split(".");for(a=0;a<f.length-1;a++){var b=f[a];if(!(b in h))return;h=h[b]}f=f[f.length-1];a=h[f];e=e(a);e!=a&&null!=e&&$jscomp.defineProperty(h,f,{configurable:!0,writable:!0,value:e})};
$jscomp.polyfillIsolated=function(f,e,h,a){var b=f.split(".");f=1===b.length;a=b[0];a=!f&&a in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var c=0;c<b.length-1;c++){var d=b[c];if(!(d in a))return;a=a[d]}b=b[b.length-1];h=$jscomp.IS_SYMBOL_NATIVE&&"es6"===h?a[b]:null;e=e(h);null!=e&&(f?$jscomp.defineProperty($jscomp.polyfills,b,{configurable:!0,writable:!0,value:e}):e!==h&&(void 0===$jscomp.propertyToPolyfillSymbol[b]&&($jscomp.propertyToPolyfillSymbol[b]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(b):
$jscomp.POLYFILL_PREFIX+b),$jscomp.defineProperty(a,$jscomp.propertyToPolyfillSymbol[b],{configurable:!0,writable:!0,value:e})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(f){if(f)return f;var e=function(b,c){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};e.prototype.toString=function(){return this.$jscomp$symbol$id_};var h=0,a=function(b){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new e("jscomp_symbol_"+(b||"")+"_"+h++,b)};return a},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(f){if(f)return f;f=Symbol("Symbol.iterator");for(var e="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),h=0;h<e.length;h++){var a=$jscomp.global[e[h]];"function"===typeof a&&"function"!=typeof a.prototype[f]&&$jscomp.defineProperty(a.prototype,f,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return f},"es6",
"es3");$jscomp.iteratorPrototype=function(f){f={next:f};f[Symbol.iterator]=function(){return this};return f};$jscomp.iteratorFromArray=function(f,e){f instanceof String&&(f+="");var h=0,a=!1,b={next:function(){if(!a&&h<f.length){var c=h++;return{value:e(c,f[c]),done:!1}}a=!0;return{done:!0,value:void 0}}};b[Symbol.iterator]=function(){return b};return b};$jscomp.polyfill("Array.prototype.keys",function(f){return f?f:function(){return $jscomp.iteratorFromArray(this,function(e){return e})}},"es6","es3");
var x=x||{};x.hub=x.hub||{};x.hub.resource=x.hub.resource||{};
x.hub.resource.ResourceManager=function(){var f=function(a){this._name=a?a.name:null;this._path=a?a.path:null};f.prototype.getName=function(){return this._name};f.prototype.getPath=function(){return this._path};f.prototype.getURL=function(){};f.prototype.toJSON=function(){return{name:this._name,path:this._path}};f.parseJSON=function(a){return a&&a.name&&a.path?new f(a):null};var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceContainer");this._rootDataFolder=null;
this._resourceFolderName="resources";this._metaFile="resource.json";this._resources=[]};e.prototype.getResourceFolder=function(){return require("path").join(this._rootDataFolder,this._resourceFolderName)};e.prototype.getMetaFilePath=function(){return require("path").join(this.getResourceFolder(),this._metaFile)};e.prototype.init=function(a,b){this._logger.log("info","init resource folder:"+a);this._rootDataFolder=a;var c=this;this._init(function(d){d&&c._logger.log("warn","init resource folder:"+
a+" faild:"+d.message);b&&b(d)})};e.prototype.listFiles=function(a){if(!a)return this._resources;for(var b=[],c=0,d=this._resources.length;c<d;c++){var g=this._resources[c];if(g){var k=g.getName();k&&k.substr(0,a.length)==a&&b.push(g)}}return b};e.prototype.getFilePath=function(a){for(var b=0,c=this._resources.length;b<c;b++){var d=this._resources[b];if(d){var g=d.getName();if(g&&g==a&&(d=d.getPath()))return require("path").join(this.getResourceFolder(),d)}}};e.prototype.getFileURL=function(a,b){for(var c=
null,d=0,g=this._resources.length;d<g;d++){var k=this._resources[d];if(k&&(k=k.getName())&&k==a){c="http://";b=this._getLocalIP(b);d=this._getLocalPort();c+=b;d&&(c+=":"+d);c+="/file/"+a;break}}return c};e.prototype.createFile=function(a,b,c){var d=a.split("/");d=this._genFilePath(d[d.length-1]);var g=require("path").relative(this.getResourceFolder(),d),k=this;this._createFile(d,b,function(l,m){l?c&&c(l):(l=f.parseJSON({name:a,path:g}),k._resources.push(l),l=k._resources2meta(k._resources),k._saveMetaFile(l,
function(n){c&&c(n,m)}))})};e.prototype.deleteFile=function(a,b){var c=this.getFilePath(a);if(c){for(var d=-1,g=0,k=this._resources.length;g<k;g++){var l=this._resources[g];if(l&&l.getName()==a){d=g;break}}var m=this;this._deleteFile(c,function(n){n?b&&b(n):(m._resources.splice(d,1),n=m._resources2meta(m._resources),m._saveMetaFile(n,function(p){b&&b(p)}))})}else b&&b()};e.prototype._init=function(a){var b=this;this._loadMetaFile(function(c,d){c?a&&a(c):(b._resources=b._meta2resources(d),a&&a(null))})};
e.prototype._loadMetaFile=function(a){var b=require("fs-extra"),c=this.getMetaFilePath();b.ensureFile(c,function(d){d?a&&a(d):b.readFile(c,{encoding:"utf8"},function(g,k){if(g)a&&a(g);else try{var l=[];k&&(l=JSON.parse(k));a&&a(null,l)}catch(m){a&&a(g)}})})};e.prototype._meta2resources=function(a){var b=[];if(a)for(var c=0,d=a.length;c<d;c++)if(a[c]){var g=f.parseJSON(a[c]);g&&b.push(g)}return b};e.prototype._resources2meta=function(a){for(var b=[],c=0,d=a.length;c<d;c++){var g=a[c];g&&b.push(g.toJSON())}return b};
e.prototype._saveMetaFile=function(a,b){var c=require("fs-extra"),d=this.getMetaFilePath();c.ensureFile(d,function(g){g?b&&b(g):c.writeFile(d,JSON.stringify(a),function(k){b&&b(k)})})};e.prototype._genFilePath=function(a){var b=require("path");a=b.extname(a);for(var c={},d=0,g=this._resources.length;d<g;d++){var k=this._resources[d];k&&(k=k.getPath(),c[k]=!0)}for(d=1;;)if(c[d+a])d++;else break;return b.join(this.getResourceFolder(),d+a)};e.prototype._createFile=function(a,b,c){var d=require("fs-extra");
d.exists(a,function(g){if(g)try{d.removeSync(a)}catch(m){c&&c(m);return}var k=c,l=0;g=d.createWriteStream(a);g.on("error",function(m){k&&(k(m),k=null)});b.on("data",function(m){l+=m.length});b.on("end",function(){k&&(k(null,l),k=null)});b.on("error",function(m){k&&(k(m),k=null)});b.pipe(g)})};e.prototype._deleteFile=function(a,b){var c=require("fs-extra");c.exists(a,function(d){d?c.remove(a,function(g){b&&b(g)}):b&&b()})};e.prototype._getLocalIP=function(a){var b=null,c=require("os").networkInterfaces(),
d;for(d in c)for(var g=c[d],k=0;k<g.length;k++){var l=g[k];if(l&&"IPv4"==l.family&&0==l.internal)if(a){if(this._matchSubnetMask(l.address,a,l.netmask))return l.address;b=l.address}else return l.address}return b};e.prototype._getLocalPort=function(){var a=require("x.hub.js");return a.server?a.server._port:null};e.prototype._matchSubnetMask=function(a,b,c){a=this._ip2int(a);b=this._ip2int(b);c=this._ip2int(c);return(a&c)==(b&c)};e.prototype._ip2int=function(a){return a.split(".").reduce(function(b,
c){return(b<<8)+parseInt(c,10)},0)>>>0};var h=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceManager");this._userResourceContainer=this._sysResourceContainer=this._userDataFolder=this._systemDataFolder=null};h.prototype.init=function(a,b){this._logger.log("info","init resource manager");this._systemDataFolder=a.getAppFolder();this._userDataFolder=a.getUserRootDataPath();this._init(b)};h.prototype.listFiles=function(a){var b={},c=this._sysResourceContainer.listFiles(a);
if(c)for(var d=0,g=c.length;d<g;d++){var k=c[d];k=k.getName();b[k]=!0}if(c=this._userResourceContainer.listFiles(a))for(d=0,g=c.length;d<g;d++)k=c[d],k=k.getName(),b[k]=!0;return Object.keys(b)};h.prototype.getFilePath=function(a){var b=this._userResourceContainer.getFilePath(a);b||(b=this._sysResourceContainer.getFilePath(a));return b};h.prototype.createFile=function(a,b,c){"public/system/"==a.substr(0,14)?c&&c(Error("not allow to upload file to public/system/")):this.getFilePath(a)?c&&c(Error("file:"+
a+" exists")):this._userResourceContainer.createFile(a,b,c)};h.prototype.deleteFile=function(a,b){this._sysResourceContainer.getFilePath(a)?b&&b(Error("not allow to delete file from system folder")):this._userResourceContainer.deleteFile(a,b)};h.prototype.getFileURL=function(a,b){var c=this._userResourceContainer.getFileURL(a,b);c||(c=this._sysResourceContainer.getFileURL(a,b));return c};h.prototype._init=function(a){var b=this;this._initSystemResourceContainer(function(c){c?a&&a(c):b._initUserResourceContainer(function(d){a&&
a(d)})})};h.prototype._initSystemResourceContainer=function(a){this._sysResourceContainer=new e;this._sysResourceContainer.init(this._systemDataFolder,a)};h.prototype._initUserResourceContainer=function(a){this._userResourceContainer=new e;this._userResourceContainer.init(this._userDataFolder,a)};return h}();
x.hub.resource.Handler=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.Handler");this.resourceManager=new x.hub.resource.ResourceManager};f.prototype.init=function(e,h,a){"CA"==global.HARDWARE_VERSION?this._initHttpApi(e):this._initHttpApiOld(e);this.resourceManager.init(h,function(b){b&&a(b)})};f.prototype._initHttpApi=function(e){var h=this;e=require("x.hub.js").getServer();e.addRoute("/file/",{method:"GET",source:1,auth:0},function(a,b,c){var d=a.path.substr(6),
g=!1;g=d&&"public/"==d.substr(0,7)?!0:a.hasValidAuth;if("/"==a.path.charAt(a.path.length-1)){a=null;if(!d&&!g)d="public/";else if(d&&"public/"!=d.substr(0,7)&&!g){b.json({XC_ERR:{code:"000007",msg:"access denied"}});return}a=h.listFiles(d);b.json({XC_SUC:a?a:[]})}else if(d&&"public/"!=d.substr(0,7)&&!g)b.status(403).json({XC_ERR:{code:"000007",msg:"access denied"}});else{var k=h.getFilePath(d);k?require("fs").exists(k,function(l){l?b.sendFile(k,null,function(m){m&&c(m)}):b.status(404).json({XC_ERR:{code:"000404",
msg:"not found"}})}):b.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}});e.addRoute("/file/",{method:"POST",source:1,body:"stream",lock:1},function(a,b){if("/"==a.path.charAt(a.path.length-1))b.json({XC_ERR:{code:"000101",msg:"no file name"}});else{var c=a.path.substr(6),d=a.headers["content-length"];d&&parseInt(d)?h.createFile(c,a,function(g,k){g?b.json({XC_ERR:{code:"000101",msg:g.message}}):b.json({XC_SUC:{bytes:k}})}):h.deleteFile(c,function(g){g?b.json({XC_ERR:{code:"000101",msg:g.message}}):
b.json({XC_SUC:{}})})}})};f.prototype._initHttpApiOld=function(e){var h=this,a=require("x.hub.js").getServer();e.get("/file/*",function(b,c,d){var g=b.path.substr(6),k=!1;k=g&&"public/"==g.substr(0,7)?!0:a.auth(b);if("/"==b.path.charAt(b.path.length-1)){b=null;if(!g&&!k)g="public/";else if(g&&"public/"!=g.substr(0,7)&&!k){c.json({XC_ERR:{code:"000007",msg:"access denied"}});return}b=h.listFiles(g);c.json({XC_SUC:b?b:[]})}else if(g&&"public/"!=g.substr(0,7)&&!k)c.status(403).json({XC_ERR:{code:"000007",
msg:"access denied"}});else{var l=h.getFilePath(g);l?require("fs").exists(l,function(m){m?c.sendFile(l,null,function(n){n&&d(n)}):c.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}):c.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}});e.post("/file/*",function(b,c){if(a.auth(b))if("/"==b.path.charAt(b.path.length-1))c.json({XC_ERR:{code:"000101",msg:"no file name"}});else{var d=b.path.substr(6),g=b.headers["content-length"];g&&parseInt(g)?h.createFile(d,b,function(k,l){k?c.json({XC_ERR:{code:"000101",
msg:k.message}}):c.json({XC_SUC:{bytes:l}})}):h.deleteFile(d,function(k){k?c.json({XC_ERR:{code:"000101",msg:k.message}}):c.json({XC_SUC:{}})})}else c.json({XC_ERR:{code:"000007",msg:"access denied"}})})};f.prototype.listFiles=function(e){return this.resourceManager.listFiles(e)};f.prototype.getFilePath=function(e){return this.resourceManager.getFilePath(e)};f.prototype.createFile=function(e,h,a){this.resourceManager.createFile(e,h,a)};f.prototype.deleteFile=function(e,h){this.resourceManager.deleteFile(e,
h)};f.prototype.getFileURL=function(e,h){return this.resourceManager.getFileURL(e,h)};return f}();module.exports=new x.hub.resource.Handler;
