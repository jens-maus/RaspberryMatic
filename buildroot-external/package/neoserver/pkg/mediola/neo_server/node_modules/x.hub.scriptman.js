var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.scriptman=x.hub.scriptman||{};x.hub.scriptman.Error=function(e,a){Error.call(this,e);this.code=a};util.inherits(x.hub.scriptman.Error,Error);
x.hub.scriptman.Hashids=function(){function e(a,b,c){this.version="1.0.1";this.minAlphabetLength=16;this.sepDiv=3.5;this.guardDiv=12;this.errorAlphabetLength="error: alphabet must contain at least X unique characters";this.errorAlphabetSpace="error: alphabet cannot contain spaces";this.alphabet="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";this.seps="cfhistuCFHISTU";this.minHashLength=0<parseInt(b,10)?b:0;this.salt="string"===typeof a?a:"";"string"===typeof c&&(this.alphabet=c);
c="";a=0;for(b=this.alphabet.length;a!==b;a++)-1===c.indexOf(this.alphabet[a])&&(c+=this.alphabet[a]);this.alphabet=c;if(this.alphabet.length<this.minAlphabetLength)throw this.errorAlphabetLength.replace("X",this.minAlphabetLength);if(-1!==this.alphabet.search(" "))throw this.errorAlphabetSpace;a=0;for(b=this.seps.length;a!==b;a++)c=this.alphabet.indexOf(this.seps[a]),-1===c?this.seps=this.seps.substr(0,a)+" "+this.seps.substr(a+1):this.alphabet=this.alphabet.substr(0,c)+" "+this.alphabet.substr(c+
1);this.alphabet=this.alphabet.replace(/ /g,"");this.seps=this.seps.replace(/ /g,"");this.seps=this.consistentShuffle(this.seps,this.salt);if(!this.seps.length||this.alphabet.length/this.seps.length>this.sepDiv)a=Math.ceil(this.alphabet.length/this.sepDiv),1===a&&a++,a>this.seps.length?(a-=this.seps.length,this.seps+=this.alphabet.substr(0,a),this.alphabet=this.alphabet.substr(a)):this.seps=this.seps.substr(0,a);this.alphabet=this.consistentShuffle(this.alphabet,this.salt);a=Math.ceil(this.alphabet.length/
this.guardDiv);3>this.alphabet.length?(this.guards=this.seps.substr(0,a),this.seps=this.seps.substr(a)):(this.guards=this.alphabet.substr(0,a),this.alphabet=this.alphabet.substr(a))}e.prototype.encode=function(){var a,b=Array.prototype.slice.call(arguments);if(!b.length)return"";b[0]instanceof Array&&(b=b[0]);var c=0;for(a=b.length;c!==a;c++)if("number"!==typeof b[c]||0!==b[c]%1||0>b[c])return"";return this._encode(b)};e.prototype.decode=function(a){var b=[];return a.length&&"string"===typeof a?this._decode(a,
this.alphabet):b};e.prototype.encodeHex=function(a){var b;a=a.toString();if(!/^[0-9a-fA-F]+$/.test(a))return"";var c=a.match(/[\w\W]{1,12}/g);a=0;for(b=c.length;a!==b;a++)c[a]=parseInt("1"+c[a],16);return this.encode.apply(this,c)};e.prototype.decodeHex=function(a){var b=[],c,d=this.decode(a);a=0;for(c=d.length;a!==c;a++)b+=d[a].toString(16).substr(1);return b};e.prototype._encode=function(a){var b,c,d,f=this.alphabet,g=a.length;var h=d=0;for(c=a.length;h!==c;h++)d+=a[h]%(h+100);var e=b=f[d%f.length];
h=0;for(c=a.length;h!==c;h++){var k=a[h];var m=e+this.salt+f;f=this.consistentShuffle(f,m.substr(0,f.length));m=this.hash(k,f);b+=m;h+1<g&&(k%=m.charCodeAt(0)+h,k%=this.seps.length,b+=this.seps[k])}b.length<this.minHashLength&&(a=(d+b[0].charCodeAt(0))%this.guards.length,a=this.guards[a],b=a+b,b.length<this.minHashLength&&(a=(d+b[2].charCodeAt(0))%this.guards.length,a=this.guards[a],b+=a));for(d=parseInt(f.length/2,10);b.length<this.minHashLength;)f=this.consistentShuffle(f,f),b=f.substr(d)+b+f.substr(0,
d),a=b.length-this.minHashLength,0<a&&(b=b.substr(a/2,this.minHashLength));return b};e.prototype._decode=function(a,b){var c=[],d=0;var f=new RegExp("["+this.guards+"]","g");var g=a.replace(f," ");var h=g.split(" ");if(3===h.length||2===h.length)d=1;g=h[d];if("undefined"!==typeof g[0]){var e=g[0];g=g.substr(1);f=new RegExp("["+this.seps+"]","g");g=g.replace(f," ");h=g.split(" ");d=0;for(f=h.length;d!==f;d++){g=h[d];var k=e+this.salt+b;b=this.consistentShuffle(b,k.substr(0,b.length));c.push(this.unhash(g,
b))}this._encode(c)!==a&&(c=[])}return c};e.prototype.consistentShuffle=function(a,b){var c,d,f;if(!b.length)return a;var g=a.length-1;for(f=d=0;0<g;g--,d++){d%=b.length;f+=c=b[d].charCodeAt(0);c=(c+d+f)%g;var h=a[c];a=a.substr(0,c)+a[g]+a.substr(c+1);a=a.substr(0,g)+h+a.substr(g+1)}return a};e.prototype.hash=function(a,b){var c="",d=b.length;do c=b[a%d]+c,a=parseInt(a/d,10);while(a);return c};e.prototype.unhash=function(a,b){var c=0,d;for(d=0;d<a.length;d++){var f=b.indexOf(a[d]);c+=f*Math.pow(b.length,
a.length-d-1)}return c};"function"===typeof define&&"object"===typeof define.amd&&define.amd&&define(function(){return e});return e}();
x.hub.scriptman.Debugger=function(){var e=function(a){this._ws=a;this._executor=null;var b=this;a.on("message",function(a,b){});a.on("error",function(a){});a.on("close",function(a,d){b._ws=null;b._executor&&x.hub.scriptman.ScriptExecutorService.stop(b._executor._id)})};e.prototype.onStart=function(a){this._executor=a;this._ws&&this._ws.send(JSON.stringify({type:"start"}))};e.prototype.onError=function(a){this._ws&&(this._ws.send(JSON.stringify({type:"error",message:a.message})),this._ws&&this._ws.close(),
this._ws=null)};e.prototype.onSTDOutMessage=function(a){this._ws&&this._ws.send(JSON.stringify({type:"stdout",message:a}))};e.prototype.onSTDErrMessage=function(a){this._ws&&this._ws.send(JSON.stringify({type:"stderr",message:a}))};e.prototype.onFinish=function(){this._ws&&(this._ws.send(JSON.stringify({type:"finish"})),this._ws.close(),this._ws=null)};return e}();
x.hub.scriptman.Executor=function(){var e=function(a,b,c,d){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.Executor");this._id=(new x.hub.scriptman.Hashids).encode((new Date).getTime());this._executorService=a;this.scriptInfo=b;this.callback=c;this.finishCallback=d;this._debugListener=this._childProcess=null;this._jsonrpcRequests=[]};e.prototype.isForScript=function(a){return a&&this.scriptInfo&&a.id==this.scriptInfo.id};e.prototype.setDebugListener=function(a){this._debugListener=
a};e.prototype.start=function(a){this._logger.log("debug","start script:"+this.scriptInfo.id);var b=this;this._processJsFile(a,function(a,d){a&&b._logger.log("warn","process script file:"+b.scriptInfo.id+" error:"+a.message);if(a||!d)b._executorService._removeExecutor(b),b.callback&&(b.callback(a?a:Error("js file path is empty")),b.callback=null),b._debugListener&&(b._debugListener.onError(a?a:Error("js file path is empty")),b._debugListener=null);else{var c=[];process.execArgv.forEach(function(a){-1==
a.indexOf("--debug")&&c.push(a)});process.execArgv=c;a=require("x.hub.scriptman.js").httpServer.address().port;b._logger.log("trace","start child process for script:"+b.scriptInfo.id);b._logger.log("trace","callback port:"+a);d=require("child_process").fork(d,[a],{silent:!0});d.stdout.setEncoding("utf8");d.stderr.setEncoding("utf8");d.stdout.on("data",function(a){b._logger.log("trace","stdout data:"+a);b._logger.log("debug",a);process.stdout.write(a);b._debugListener&&b._debugListener.onSTDOutMessage(a)});
d.stdout.on("error",function(a){b._logger.log("trace","stdout error:"+a.stack);console.error("child process stdout error",a);b._debugListener&&b._debugListener.onError(a)});d.stderr.on("data",function(a){b._logger.log("trace","stderr data:"+a);b._logger.log("debug",a);process.stderr.write(a);b._debugListener&&b._debugListener.onSTDErrMessage(a)});d.stderr.on("error",function(a){b._logger.log("trace","stderr error:"+a.stack);console.error("child process stderr error",a);b._debugListener&&b._debugListener.onError(a)});
d.on("message",function(a){b._onChildprocessMessage(a)});d.on("error",function(a){b._logger.log("error","child process error:"+a.stack);console.error("child process error",a);b._onProcessExit(a);b._debugListener&&b._debugListener.onError(a)});d.on("exit",function(a,c){b._logger.log("trace","child process exit for script:"+b.scriptInfo.id);console.log("child process exit",a,c);b._onProcessExit();b._debugListener&&b._debugListener.onFinish()});b._childProcess=d;b._debugListener&&b._debugListener.onStart(b);
b.callback&&b.callback();b.callback=null}})};e.prototype.stop=function(){this._childProcess&&this._childProcess.kill();this.callback&&this.callback(Error("interrupted"));this.callback=null;this.finishCallback&&this.finishCallback(Error("canceled"));this.finishCallback=null};e.prototype.toJSON=function(){return{id:this._id,scriptInfo:this.scriptInfo,debug:this._debugListener?!0:!1}};e.prototype._onProcessExit=function(a){this._logger.log("debug","finish execute script:"+this.scriptInfo.id+(a?"with error:"+
a.message:""));this._executorService._removeExecutor(this);this.finishCallback&&this.finishCallback()};e.prototype._processJsFile=function(a,b){var c=require("fs"),d=require("path"),f=d.resolve(__dirname,"runner.js"),g=require("loop-protect");g.method="protect";c.readFile(f,{encoding:"utf8"},function(f,e){if(f)b(f);else{f=e.replace("//%CODE",a);f=g.rewriteLoops(f);var h=require("os").tmpdir()+d.sep+"_runner_"+(new Date).getTime()+".js";c.writeFile(h,f,function(a){b(a,h)})}})};e.prototype._onChildprocessMessage=
function(a){this._logger.log("trace","child process message:"+JSON.stringify(a));a&&"2.0"==a.jsonrpc?this._onChildProcessJsonRPC(a):"win32"==process.platform&&(a&&a.log?(process.stdout.write(JSON.stringify(a.log)),this._debugListener&&this._debugListener.onSTDOutMessage(a.log)):a&&a.error&&(process.stderr.write(JSON.stringify(a.error)),this._debugListener&&this._debugListener.onSTDErrMessage(a.error)))};e.prototype._onChildProcessJsonRPC=function(a){};return e}();
x.hub.scriptman.ScriptExecutorService={_executors:[],execute:function(e,a,b,c){e&&a?(e=new x.hub.scriptman.Executor(this,e,b,c),this._executors.push(e),e.start(a)):b&&b(Error("argument invalid"))},debug:function(e,a,b,c){if(e&&a)e=new x.hub.scriptman.Executor(this,e,c),e.setDebugListener(b),this._executors.push(e),e.start(a);else b.onError(Error("argument invalid"))},stop:function(e,a){if(e){for(var b=[],c=null,d=0;d<this._executors.length;d++)this._executors[d]&&this._executors[d]._id==e?c=this._executors[d]:
this._executors[d]&&b.push(this._executors[d]);this._executors=b;c&&c.stop();a&&a()}else a&&a(Error("argument invalid"))},stopScript:function(e,a){if(e){for(var b=[],c=0;c<this._executors.length;c++)this._executors[c]&&this._executors[c].isForScript(e)?this._executors[c].stop():this._executors[c]&&b.push(this._executors[c]);this._executors=b;a&&a()}else a&&a(Error("argument invalid"))},getAllRunning:function(){var e=[];this._executors.forEach(function(a){e.push(a.toJSON())});return e},_removeExecutor:function(e){for(var a=
-1,b=0;b<this._executors.length;b++)if(this._executors[b]===e){a=b;break}-1!=a&&this._executors.splice(a,1)}};
x.hub.scriptman.ScriptExecutorService2=function(){var e=function(a,c){this._executor=a;this._request=c};e.prototype.execute=function(){if(this._request&&this._request.method){var a=this,c=require("x.hub.scriptman.js");switch(this._request.method){case "executeCommand":case "getStatus":case "executeMacro":c._doCallback(this._request.params,function(b,c){var f=null;b&&(f={},f.message=b instanceof Error?b.message:b,f.code=b.code?b.code:0);a._finishWithResponse(f,c)});break;default:this._finishWithResponse({code:-32601,
message:"Method not found"})}}else this._finishWithResponse({code:-32600,message:"Invalid Request"})};e.prototype._finishWithResponse=function(a,c){a={jsonrpc:"2.0",id:this._request.id,error:a,result:c};this._executor&&this._executor._childProcess&&this._executor._childProcess.send(a);this._executor&&this._executor._jsonrpcRequests&&(a=this._executor._jsonrpcRequests.indexOf(this),-1!=a&&this._executor._jsonrpcRequests.splice(a,1))};var a=function(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.ScriptExecutorService2");
this._childProcess=null;this._jsonrpcRequests=[];this._start()};a.prototype.execute=function(a,c,d,f){if(a&&c)if(this._childProcess){this._logger.log("debug","start script:"+a.id);var b=this;this._processJsFile(c,function(c,g){c&&b._logger.log("warn","process script file:"+a.id+" error:"+c.message);c||!g?d&&d(c?c:Error("js file path is empty")):(b._childProcess.send({runScript:g}),d&&d(),f&&f())})}else d&&d(Error("child process is null"));else d&&d(Error("argument invalid"))};a.prototype.execute2=
function(a,c,d){a?this._childProcess?(this._logger.log("debug","start script:"+a),this._childProcess.send({runScript:a}),c&&c(),d&&d()):c&&c(Error("child process is null")):c&&c(Error("argument invalid"))};a.prototype.stopScript=function(a,c){a?c&&c():c&&c(Error("argument invalid"))};a.prototype._processJsFile=function(a,c){var b=require("fs"),f=require("path"),g=f.resolve(__dirname,"runner2.js"),h=require("loop-protect");h.method="protect";b.readFile(g,{encoding:"utf8"},function(d,g){if(d)c(d);else{d=
g.replace("//%CODE",a);d=h.rewriteLoops(d);var e=require("os").tmpdir()+f.sep+"_runner_"+(new Date).getTime()+".js";b.writeFile(e,d,function(a){c(a,e)})}})};a.prototype._start=function(a){require("fs");var b=require("path").resolve(__dirname,"script_executor.js"),d=[];process.execArgv.forEach(function(a){-1==a.indexOf("--debug")&&-1==a.indexOf("--inspect")&&d.push(a)});process.execArgv=d;this._logger.log("trace","start js executor child process");var f=this,g=require("child_process").fork(b,[],{silent:!0});
g.stdout.setEncoding("utf8");g.stderr.setEncoding("utf8");g.stdout.on("data",function(a){f._logger.log("trace","stdout data:"+a);f._logger.log("debug",a);process.stdout.write(a)});g.stdout.on("error",function(a){f._logger.log("trace","stdout error:"+a.stack);console.error("child process stdout error",a)});g.stderr.on("data",function(a){f._logger.log("trace","stderr data:"+a);f._logger.log("debug",a);process.env.DEBUG?process.stdout.write(a):process.stderr.write(a)});g.stderr.on("error",function(a){f._logger.log("trace",
"stderr error:"+a.stack);console.error("child process stderr error",a)});g.on("message",function(a){f._onChildprocessMessage(a)});g.on("error",function(a){f._logger.log("error","child process error:"+a.stack);console.error("child process error",a);g.__closed||(g.__closed=!0,f._onProcessExit(a))});g.on("exit",function(a,b){f._logger.log("trace","child process exit for script executor");console.log("child process exit",a,b);g.__closed||(g.__closed=!0,f._onProcessExit())});this._childProcess=g;a&&a()};
a.prototype._onChildprocessMessage=function(a){this._logger.log("trace","child process message:"+JSON.stringify(a));a&&"2.0"==a.jsonrpc?this._onChildProcessJsonRPC(a):"win32"==process.platform&&(a&&a.log?process.stdout.write(JSON.stringify(a.log)):a&&a.error&&process.stderr.write(JSON.stringify(a.error)))};a.prototype._onChildProcessJsonRPC=function(a){a=new e(this,a);this._jsonrpcRequests.push(a);a.execute()};a.prototype._onProcessExit=function(a){this._logger.log("debug","script executor finished"+
(a?" with error:"+a.message:""));this._start()};return a}();
x.hub.scriptman.ScriptManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.ScriptManager");this._scripts=[];this._service=x.hub.scriptman.ScriptExecutorService;this._service2=new x.hub.scriptman.ScriptExecutorService2};e.FOLDER_NAME="scripts";e.FILE_NAME="sm.json";e.prototype.init=function(a){var b=this._getScriptIndexFile(),c=this;require("fs-extra").ensureFile(b,function(b){b?a&&a(b):c._loadData(function(b,d){b?a&&a(b):(c._scripts=d,c._sort(),a&&a())})})};
e.prototype.reload=function(a){this.init(a)};e.prototype.createScript=function(a,b,c){if(a){for(var d=1,f=-1,g=1,e=0;e<this._scripts.length;e++)if(this._scripts[e].id>d){g=d;f=e;break}else d++;-1==f&&(g=d,f=this._scripts.length);var l=this,k={id:g,name:a,file:g};this._writeScript(g,b,function(a){a?c&&c(a):(l._scripts.splice(f,0,k),l._writeData(function(a){a&&l._scripts.splice(f,1);c&&c(a,k)}))})}else c&&c(Error("name is null"))};e.prototype.readScriptContent=function(a,b){if(a){for(var c=null,d=0;d<
this._scripts.length;d++){var f=this._scripts[d];if(f.id==a){c=f;break}}c?this._readScript(a,function(a,c){b&&b(a,c)}):b&&b(Error("no such script with id:"+a))}else b&&b(Error("script id is null"))};e.prototype.readAllScripts=function(a){a&&a(null,this._scripts)};e.prototype.updateScript=function(a,b,c,d){if(a){for(var f=null,g=0;g<this._scripts.length;g++){var e=this._scripts[g];if(e.id==a){f=e;break}}if(f){var l=this;this._writeScript(a,c,function(a){a?d&&d(a):b&&f.name!=b?(f.name=b,l._writeData(d)):
d&&d()})}else d&&d(Error("no such script with id:"+a))}else d&&d(Error("script id is null"))};e.prototype.deleteScript=function(a,b){if(a){for(var c=-1,d=null,f=0;f<this._scripts.length;f++){var g=this._scripts[f];if(g.id==a){c=f;d=g;break}}var e=this;this.stopScript(a);this._deleteScript(a,function(a){a?b&&b(a):(e._scripts.splice(c,1),e._writeData(function(a){a&&e._scripts.splice(c,0,d);b&&b(a)}))})}else b&&b(Error("script id is null"))};e.prototype.runScript=function(a,b,c){if(a){for(var d=null,
f=0;f<this._scripts.length;f++){var g=this._scripts[f];if(g.id==a){d=g;break}}d?(d=require("path"),a+="",f=this._getScriptDir(),a=d.resolve(f,a),this._service2.execute2(a,b,c)):b&&b(Error("no such script with id:"+a))}else b&&b(Error("script id is null"))};e.prototype.debugScript=function(a,b,c){if(a){for(var d=null,f=0;f<this._scripts.length;f++){var g=this._scripts[f];if(g.id==a){d=g;break}}if(d){var e=this;this.readScriptContent(a,function(a,f){if(a)b.onError(a);else e._service.debug(d,f,b,c)})}else b.onError(Error("no such script with id:"+
a))}else b.onError(Error("script id is null"))};e.prototype.stopScript=function(a,b){if(a){for(var c=[],d=0;d<this._scripts.length;d++){var f=this._scripts[d];if(f.id==a){c.push(f);break}}if(0==c.length)b&&b(Error("no such script with id:"+a));else{var g=this,e=0,l=function(){e++;e>=c.length?b&&b():g._service.stopScript(c[e],l)};this._service2.stopScript(c[e],l)}}else b&&b(Error("script id is null"))};e.prototype.deleteAllScripts=function(a){for(var b=0;b<this._scripts.length;b++)this.stopScript(this._scripts[b].id);
var c=this;this._scripts=[];this._writeData(function(b){b?a&&a(b):c._emptyScriptFolder(function(b){a&&a(b)})})};e.prototype._getScriptDir=function(){var a=require("path"),b=require("x.hub.fileman.js").fileManager.getUserRootDataPath();return a.resolve(b,e.FOLDER_NAME)};e.prototype._getScriptIndexFile=function(){var a=require("path"),b=this._getScriptDir();return a.resolve(b,e.FILE_NAME)};e.prototype._writeData=function(a){var b=this._scripts,c=require("fs"),d=this._getScriptIndexFile();c.writeFile(d,
JSON.stringify(b,null,2),function(b){a&&a(b)})};e.prototype._loadData=function(a){var b=require("path"),c=require("fs"),d=this._getScriptDir();b=b.resolve(d,e.FILE_NAME);c.readFile(b,"utf8",function(b,c){if(b)a&&a(b);else if(c)try{a&&a(null,JSON.parse(c))}catch(h){a&&a(h)}else a&&a(null,[])})};e.prototype._writeScript=function(a,b,c){var d=require("fs-extra"),f=require("path");a+="";var g=this._getScriptDir();a=f.resolve(g,a);d.writeFile(a,b,function(a){c&&c(a)})};e.prototype._readScript=function(a,
b){var c=require("fs-extra"),d=require("path");a+="";var f=this._getScriptDir();a=d.resolve(f,a);c.readFile(a,"utf8",function(a,c){b&&b(a,c)})};e.prototype._deleteScript=function(a,b){var c=require("fs-extra"),d=require("path");a+="";var f=this._getScriptDir();a=d.resolve(f,a);c.remove(a,function(a){b&&b(a)})};e.prototype._emptyScriptFolder=function(a){var b=require("fs-extra");require("path");var c=this._getScriptDir();b.emptyDir(c,function(b){a&&a(b)})};e.prototype._sort=function(){var a=this._scripts.length-
1;do{var b=!1;for(var c=0;c<a;++c)this._scripts[c].id>this._scripts[c+1].id&&(b=this._scripts[c],this._scripts[c]=this._scripts[c+1],this._scripts[c+1]=b,b=!0)}while(b)};return e}();
x.hub.scriptman.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.Handler");this.scriptManager=new x.hub.scriptman.ScriptManager;this.httpServer=null};e.prototype.ScriptManager=x.hub.scriptman.ScriptManager;e.prototype.init=function(a,b,c){"CA"==global.HARDWARE_VERSION?this._configNew(a,b):this._config(a,b);this.scriptManager.init(c)};e.prototype._configNew=function(a,b){var c=this;this.httpServer=b;var d=require("url");a=new (require("ws").Server)({server:b,
path:"/xhub/script/debug"});a.on("connection",function(a){var b=d.parse(a.upgradeReq.url,!0);b.query&&b.query.id?(a=new x.hub.scriptman.Debugger(a),c.scriptManager.debugScript(b.query.id,a)):(a.send(JSON.stringify({type:"error",message:"no script id"})),a.close())});a.on("error",function(a){c._logger.log("warn","script web socket server error:"+a.stack)});a=require("x.hub.js").getServer();a.addRoute("/xhub/script/do",{method:"GET"},function(a,b){(a=a.query.id)?c.scriptManager.runScript(a,function(a){b.send(c._toRestfulResponse(a,
"ok"))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))});a.addRoute("/xhub/script/stop",{method:"GET"},function(a,b){(a=a.query.id)?x.hub.scriptman.ScriptExecutorService.stop(a,function(a){b.send(c._toRestfulResponse(a,"ok"))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no executor id")))});a.addRoute("/xhub/script/running",{method:"GET"},function(a,b){a=x.hub.scriptman.ScriptExecutorService.getAllRunning();b.send(c._toRestfulResponse(null,a))});a.addRoute("/xhub/script/callback",
{method:"POST"},function(a,b){(a=a.body)?c._doCallback(a,function(a,f){b.send(c._toRestfulResponse(a,f))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no callback body")))});a.addRoute("/xhub/scripts",{method:"GET"},function(a,b){c.scriptManager.readAllScripts(function(a,f){a?b.send(c._toRestfulResponse(a)):b.json(f)})});a.addRoute("/xhub/script",{method:"POST",body:"text"},function(a,b){var f=a.query.name;f?c.scriptManager.createScript(f,a.body,function(a,f){b.send(c._toRestfulResponse(a,
f))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script name")))});a.addRoute("/xhub/script",{method:"GET"},function(a,b){(a=a.query.id)?c.scriptManager.readScriptContent(a,function(a,f){a?b.send(c._toRestfulResponse(a)):b.send(f)}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))});a.addRoute("/xhub/script",{method:"PUT",body:"text"},function(a,b){var f=a.query.id;f?c.scriptManager.updateScript(f,a.query.name,a.body,function(a){b.send(c._toRestfulResponse(a,
"ok"))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))});a.addRoute("/xhub/script",{method:"DELETE"},function(a,b){(a=a.query.id)?c.scriptManager.deleteScript(a,function(a){b.send(c._toRestfulResponse(a,"ok"))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))})};e.prototype._config=function(a,b){var c=this;this.httpServer=b;var d=require("url");b=new (require("ws").Server)({server:b,path:"/xhub/script/debug"});b.on("connection",function(a){var b=d.parse(a.upgradeReq.url,
!0);b.query&&b.query.id?(a=new x.hub.scriptman.Debugger(a),c.scriptManager.debugScript(b.query.id,a)):(a.send(JSON.stringify({type:"error",message:"no script id"})),a.close())});b.on("error",function(a){c._logger.log("warn","script web socket server error:"+a.stack)});b=require("body-parser");a.use("/xhub/script/callback",b.json({limit:"50mb"}));a.use("/xhub/script",b.text({limit:"50mb"}));a.post("/xhub/script",function(a,b){var d=a.query.name;d?c.scriptManager.createScript(d,a.body,function(a,d){b.send(c._toRestfulResponse(a,
d))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script name")))}.bind(this));a.get("/xhub/script",function(a,b){(a=a.query.id)?c.scriptManager.readScriptContent(a,function(a,d){a?b.send(c._toRestfulResponse(a)):b.send(d)}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.get("/xhub/scripts",function(a,b){c.scriptManager.readAllScripts(function(a,d){a?b.send(c._toRestfulResponse(a)):b.send(JSON.stringify(d))})}.bind(this));a.put("/xhub/script",
function(a,b){var d=a.query.id;d?c.scriptManager.updateScript(d,a.query.name,a.body,function(a){b.send(c._toRestfulResponse(a,"ok"))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.delete("/xhub/script",function(a,b){(a=a.query.id)?c.scriptManager.deleteScript(a,function(a){b.send(c._toRestfulResponse(a,"ok"))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.get("/xhub/script/do",function(a,b){(a=a.query.id)?c.scriptManager.runScript(a,
function(a){b.send(c._toRestfulResponse(a,"ok"))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.get("/xhub/script/stop",function(a,b){(a=a.query.id)?x.hub.scriptman.ScriptExecutorService.stop(a,function(a){b.send(c._toRestfulResponse(a,"ok"))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no executor id")))}.bind(this));a.get("/xhub/script/running",function(a,b){a=x.hub.scriptman.ScriptExecutorService.getAllRunning();b.send(c._toRestfulResponse(null,
a))}.bind(this));a.post("/xhub/script/callback",function(a,b){(a=a.body)?c._doCallback(a,function(a,d){b.send(c._toRestfulResponse(a,d))}):b.send(c._toRestfulResponse(new x.hub.scriptman.Error("no callback body")))}.bind(this))};e.prototype._toRestfulResponse=function(a,b){return a?{status:"fail",message:a.message,code:a.code?a.code:0}:{status:"success",data:b}};e.prototype._doCallback=function(a,b){this._logger.log("trace","do callback:"+JSON.stringify(a));var c=require("x.hub.commandman.js").commandHandler;
"executeCommand"==a.func?a.device&&a.command&&a.device.device&&a.device.room?c.executeCommandWithRef(a.device.room,a.device.device,null,a.command,function(a){b&&b(a.error,a.data)}):b&&b(Error("execute command argument invalid")):"getStatus"==a.func?a.device&&a.status&&a.device.device&&a.device.room?c.getStateWithRef(a.device.room,a.device.device,null,a.status,function(a){b&&b(a.error,a.data)}):b&&b(Error("get status argument invalid")):"executeMacro"==a.func?a.groupName&&a.macroName?require("x.hub.macroman.js").execute(a.groupName,
a.macroName,function(a){b&&b(a.error,a.data)}):b&&b(Error("execute macro argument invalid")):b&&b()};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.scriptman.Handler);
