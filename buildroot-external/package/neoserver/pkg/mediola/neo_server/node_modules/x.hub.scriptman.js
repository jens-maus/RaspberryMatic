function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o;}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o;},_typeof(o);}var util=require("util"),EventEmitter=require("events");var x=x||{};x.hub=x.hub||{},x.hub.scriptman=x.hub.scriptman||{},x.hub.scriptman.Error=function(e,t){var r=new Error(e);return r.code=t,r;},util.inherits(x.hub.scriptman.Error,Error),x.hub.scriptman.Hashids=function(){"use strict";function e(e,t,r){var s,i,o,n,c,u,a;for(this.version="1.0.1",this.minAlphabetLength=16,this.sepDiv=3.5,this.guardDiv=12,this.errorAlphabetLength="error: alphabet must contain at least X unique characters",this.errorAlphabetSpace="error: alphabet cannot contain spaces",this.alphabet="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",this.seps="cfhistuCFHISTU",this.minHashLength=parseInt(t,10)>0?t:0,this.salt="string"==typeof e?e:"","string"==typeof r&&(this.alphabet=r),s="",i=0,n=this.alphabet.length;i!==n;i++)-1===s.indexOf(this.alphabet[i])&&(s+=this.alphabet[i]);if(this.alphabet=s,this.alphabet.length<this.minAlphabetLength)throw this.errorAlphabetLength.replace("X",this.minAlphabetLength);if(-1!==this.alphabet.search(" "))throw this.errorAlphabetSpace;for(i=0,n=this.seps.length;i!==n;i++)-1===(o=this.alphabet.indexOf(this.seps[i]))?this.seps=this.seps.substr(0,i)+" "+this.seps.substr(i+1):this.alphabet=this.alphabet.substr(0,o)+" "+this.alphabet.substr(o+1);this.alphabet=this.alphabet.replace(/ /g,""),this.seps=this.seps.replace(/ /g,""),this.seps=this.consistentShuffle(this.seps,this.salt),(!this.seps.length||this.alphabet.length/this.seps.length>this.sepDiv)&&(1===(c=Math.ceil(this.alphabet.length/this.sepDiv))&&c++,c>this.seps.length?(u=c-this.seps.length,this.seps+=this.alphabet.substr(0,u),this.alphabet=this.alphabet.substr(u)):this.seps=this.seps.substr(0,c)),this.alphabet=this.consistentShuffle(this.alphabet,this.salt),a=Math.ceil(this.alphabet.length/this.guardDiv),this.alphabet.length<3?(this.guards=this.seps.substr(0,a),this.seps=this.seps.substr(a)):(this.guards=this.alphabet.substr(0,a),this.alphabet=this.alphabet.substr(a));}return e.prototype.encode=function(){var e,t,r=Array.prototype.slice.call(arguments);if(!r.length)return"";for(r[0]instanceof Array&&(r=r[0]),e=0,t=r.length;e!==t;e++)if("number"!=typeof r[e]||r[e]%1!=0||r[e]<0)return"";return this._encode(r);},e.prototype.decode=function(e){return e.length&&"string"==typeof e?this._decode(e,this.alphabet):[];},e.prototype.encodeHex=function(e){var t,r,s;if(e=e.toString(),!/^[0-9a-fA-F]+$/.test(e))return"";for(t=0,r=(s=e.match(/[\w\W]{1,12}/g)).length;t!==r;t++)s[t]=parseInt("1"+s[t],16);return this.encode.apply(this,s);},e.prototype.decodeHex=function(e){var t,r,s=[],i=this.decode(e);for(t=0,r=i.length;t!==r;t++)s+=i[t].toString(16).substr(1);return s;},e.prototype._encode=function(e){var t,r,s,i,o,n,c,u,a,p,h,l=this.alphabet,d=e.length,g=0;for(s=0,i=e.length;s!==i;s++)g+=e[s]%(s+100);for(r=t=l[g%l.length],s=0,i=e.length;s!==i;s++)o=e[s],n=r+this.salt+l,l=this.consistentShuffle(l,n.substr(0,l.length)),t+=c=this.hash(o,l),s+1<d&&(u=(o%=c.charCodeAt(0)+s)%this.seps.length,t+=this.seps[u]);for(t.length<this.minHashLength&&(a=(g+t[0].charCodeAt(0))%this.guards.length,(t=this.guards[a]+t).length<this.minHashLength&&(a=(g+t[2].charCodeAt(0))%this.guards.length,t+=this.guards[a])),p=parseInt(l.length/2,10);t.length<this.minHashLength;)(h=(t=(l=this.consistentShuffle(l,l)).substr(p)+t+l.substr(0,p)).length-this.minHashLength)>0&&(t=t.substr(h/2,this.minHashLength));return t;},e.prototype._decode=function(e,t){var r,s,i,o,n=[],c=0,u=new RegExp("["+this.guards+"]","g"),a=e.replace(u," "),p=a.split(" ");if(3!==p.length&&2!==p.length||(c=1),void 0!==(a=p[c])[0]){for(r=a[0],a=a.substr(1),u=new RegExp("["+this.seps+"]","g"),c=0,s=(p=(a=a.replace(u," ")).split(" ")).length;c!==s;c++)i=p[c],o=r+this.salt+t,t=this.consistentShuffle(t,o.substr(0,t.length)),n.push(this.unhash(i,t));this._encode(n)!==e&&(n=[]);}return n;},e.prototype.consistentShuffle=function(e,t){var r,s,i,o,n,c;if(!t.length)return e;for(o=e.length-1,n=0,c=0;o>0;o--,n++)c+=r=t[n%=t.length].charCodeAt(0),i=e[s=(r+n+c)%o],e=(e=e.substr(0,s)+e[o]+e.substr(s+1)).substr(0,o)+i+e.substr(o+1);return e;},e.prototype.hash=function(e,t){var r="",s=t.length;do{r=t[e%s]+r,e=parseInt(e/s,10);}while(e);return r;},e.prototype.unhash=function(e,t){var r,s=0;for(r=0;r<e.length;r++)s+=t.indexOf(e[r])*Math.pow(t.length,e.length-r-1);return s;},"function"==typeof define&&"object"==_typeof(define.amd)&&define.amd&&define(function(){return e;}),e;}(),x.hub.scriptman.Debugger=function(){var e=function e(_e){this._ws=_e,this._executor=null;var t=this;_e.on("message",function(e,t){}),_e.on("error",function(e){}),_e.on("close",function(e,r){t._ws=null,t._executor&&x.hub.scriptman.ScriptExecutorService.stop(t._executor._id);});};return e.prototype.onStart=function(e){this._executor=e,this._ws&&this._ws.send(JSON.stringify({type:"start"}));},e.prototype.onError=function(e){this._ws&&(this._ws.send(JSON.stringify({type:"error",message:e.message})),this._ws&&this._ws.close(),this._ws=null);},e.prototype.onSTDOutMessage=function(e){this._ws&&this._ws.send(JSON.stringify({type:"stdout",message:e}));},e.prototype.onSTDErrMessage=function(e){this._ws&&this._ws.send(JSON.stringify({type:"stderr",message:e}));},e.prototype.onFinish=function(){this._ws&&(this._ws.send(JSON.stringify({type:"finish"})),this._ws.close(),this._ws=null);},e;}(),x.hub.scriptman.Executor=function(){var e=function e(_e2,t,r,s){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.Executor");var i=new x.hub.scriptman.Hashids();this._id=i.encode(new Date().getTime()),this._executorService=_e2,this.scriptInfo=t,this.callback=r,this.finishCallback=s,this._childProcess=null,this._debugListener=null,this._jsonrpcRequests=[];};return e.prototype.isForScript=function(e){return e&&this.scriptInfo&&e.id==this.scriptInfo.id;},e.prototype.setDebugListener=function(e){this._debugListener=e;},e.prototype.start=function(e){this._logger.log("debug","start script:"+this.scriptInfo.id);var t=this;this._processJsFile(e,function(e,r){if(e&&t._logger.log("warn","process script file:"+t.scriptInfo.id+" error:"+e.message),e||!r)return t._executorService._removeExecutor(t),t.callback&&(t.callback(e||new Error("js file path is empty")),t.callback=null),void(t._debugListener&&(t._debugListener.onError(e||new Error("js file path is empty")),t._debugListener=null));var s=process.execArgv,i=[];s.forEach(function(e){-1==e.indexOf("--debug")&&i.push(e);}),process.execArgv=i;var o=require("x.hub.scriptman.js").httpServer.address().port;t._logger.log("trace","start child process for script:"+t.scriptInfo.id),t._logger.log("trace","callback port:"+o);var n=require("child_process").fork(r,[o],{silent:!0});n.stdout.setEncoding("utf8"),n.stderr.setEncoding("utf8"),n.stdout.on("data",function(e){t._logger.log("trace","stdout data:"+e),t._logger.log("debug",e),process.stdout.write(e),t._debugListener&&t._debugListener.onSTDOutMessage(e);}),n.stdout.on("error",function(e){t._logger.log("trace","stdout error:"+e.stack),console.error("child process stdout error",e),t._debugListener&&t._debugListener.onError(e);}),n.stderr.on("data",function(e){String(e).includes("] Cannot open ZIP archive '")||(t._logger.log("trace","stderr data:"+e),t._logger.log("debug",e),process.stderr.write(e),t._debugListener&&t._debugListener.onSTDErrMessage(e));}),n.stderr.on("error",function(e){t._logger.log("trace","stderr error:"+e.stack),console.error("child process stderr error",e),t._debugListener&&t._debugListener.onError(e);}),n.on("message",function(e){t._onChildprocessMessage(e);}),n.on("error",function(e){t._logger.log("error","child process error:"+e.stack),console.error("child process error",e),t._onProcessExit(e),t._debugListener&&t._debugListener.onError(e);}),n.on("exit",function(e,r){t._logger.log("trace","child process exit for script:"+t.scriptInfo.id),console.log("child process exit",e,r),t._onProcessExit(),t._debugListener&&t._debugListener.onFinish();}),t._childProcess=n,t._debugListener&&t._debugListener.onStart(t),t.callback&&t.callback(),t.callback=null;});},e.prototype.stop=function(){this._childProcess&&this._childProcess.kill(),this.callback&&this.callback(new Error("interrupted")),this.callback=null,this.finishCallback&&this.finishCallback(new Error("canceled")),this.finishCallback=null;},e.prototype.toJSON=function(){return{id:this._id,scriptInfo:this.scriptInfo,debug:!!this._debugListener};},e.prototype._onProcessExit=function(e){this._logger.log("debug","finish execute script:"+this.scriptInfo.id+(e?"with error:"+e.message:"")),this._executorService._removeExecutor(this),this.finishCallback&&this.finishCallback();},e.prototype._processJsFile=function(e,t){var r=require("fs"),s=require("path"),i=s.resolve(__dirname,"runner.js"),o=require("loop-protect");o.method="protect",r.readFile(i,{encoding:"utf8"},function(i,n){if(i)t(i);else{var c=n.replace("//%CODE",e),u=o.rewriteLoops(c),a=require("os").tmpdir()+s.sep+"_runner_"+new Date().getTime()+".js";r.writeFile(a,u,function(e){t(e,a);});}});},e.prototype._onChildprocessMessage=function(e){this._logger.log("trace","child process message:"+JSON.stringify(e)),e&&"2.0"==e.jsonrpc?this._onChildProcessJsonRPC(e):"win32"==process.platform&&(e&&e.log?(process.stdout.write(JSON.stringify(e.log)),this._debugListener&&this._debugListener.onSTDOutMessage(e.log)):e&&e.error&&(process.stderr.write(JSON.stringify(e.error)),this._debugListener&&this._debugListener.onSTDErrMessage(e.error)));},e.prototype._onChildProcessJsonRPC=function(e){},e;}(),x.hub.scriptman.ScriptExecutorService={_executors:[],execute:function execute(e,t,r,s){if(e&&t){var i=new x.hub.scriptman.Executor(this,e,r,s);this._executors.push(i),i.start(t);}else r&&r(new Error("argument invalid"));},debug:function debug(e,t,r,s){if(e&&t){var i=new x.hub.scriptman.Executor(this,e,s);i.setDebugListener(r),this._executors.push(i),i.start(t);}else r.onError(new Error("argument invalid"));},stop:function stop(e,t){if(e){for(var r=[],s=null,i=0;i<this._executors.length;i++)this._executors[i]&&this._executors[i]._id==e?s=this._executors[i]:this._executors[i]&&r.push(this._executors[i]);this._executors=r,s&&s.stop(),t&&t();}else t&&t(new Error("argument invalid"));},stopScript:function stopScript(e,t){if(e){for(var r=[],s=0;s<this._executors.length;s++)this._executors[s]&&this._executors[s].isForScript(e)?this._executors[s].stop():this._executors[s]&&r.push(this._executors[s]);this._executors=r,t&&t();}else t&&t(new Error("argument invalid"));},getAllRunning:function getAllRunning(){var e=[];return this._executors.forEach(function(t){e.push(t.toJSON());}),e;},_removeExecutor:function _removeExecutor(e){for(var t=-1,r=0;r<this._executors.length;r++)if(this._executors[r]===e){t=r;break;}-1!=t&&this._executors.splice(t,1);}},x.hub.scriptman.ScriptExecutorService2=function(){var e=function e(_e3,t){this._executor=_e3,this._request=t;};e.prototype.execute=function(){if(this._request&&this._request.method){var e=this,t=require("x.hub.scriptman.js");switch(this._request.method){case"executeCommand":case"getStatus":case"executeMacro":t._doCallback(this._request.params,function(t,r){var s=null;t&&(s={},t instanceof Error?s.message=t.message:s.message=t,s.code=t.code?t.code:0),e._finishWithResponse(s,r);});break;default:this._finishWithResponse({code:-32601,message:"Method not found"});}}else this._finishWithResponse({code:-32600,message:"Invalid Request"});},e.prototype._finishWithResponse=function(e,t){var r={jsonrpc:"2.0",id:this._request.id,error:e,result:t};if(this._executor&&this._executor._childProcess&&this._executor._childProcess.send(r),this._executor&&this._executor._jsonrpcRequests){var s=this._executor._jsonrpcRequests.indexOf(this);-1!=s&&this._executor._jsonrpcRequests.splice(s,1);}};var t=function t(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.ScriptExecutorService2"),this._childProcess=null,this._jsonrpcRequests=[],this._start();};return t.prototype.execute=function(e,t,r,s){if(e&&t){if(this._childProcess){this._logger.log("debug","start script:"+e.id);var i=this;this._processJsFile(t,function(t,o){t&&i._logger.log("warn","process script file:"+e.id+" error:"+t.message),!t&&o?(i._childProcess.send({runScript:o}),r&&r(),s&&s()):r&&r(t||new Error("js file path is empty"));});}else r&&r(new Error("child process is null"));}else r&&r(new Error("argument invalid"));},t.prototype.execute2=function(e,t,r){e?this._childProcess?(this._logger.log("debug","start script:"+e),this._childProcess.send({runScript:e}),t&&t(),r&&r()):t&&t(new Error("child process is null")):t&&t(new Error("argument invalid"));},t.prototype.stopScript=function(e,t){e?t&&t():t&&t(new Error("argument invalid"));},t.prototype._processJsFile=function(e,t){var r=require("fs"),s=require("path"),i=s.resolve(__dirname,"runner2.js"),o=require("loop-protect");o.method="protect",r.readFile(i,{encoding:"utf8"},function(i,n){if(i)t(i);else{var c=n.replace("//%CODE",e),u=o.rewriteLoops(c),a=require("os").tmpdir()+s.sep+"_runner_"+new Date().getTime()+".js";r.writeFile(a,u,function(e){t(e,a);});}});},t.prototype._start=function(e){require("fs");var t=require("path").resolve(__dirname,"script_executor.js"),r=process.execArgv,s=[];r.forEach(function(e){-1==e.indexOf("--debug")&&-1==e.indexOf("--inspect")&&s.push(e);}),process.execArgv=s,this._logger.log("trace","start js executor child process");var i=this,o=require("child_process").fork(t,[],{silent:!0});o.stdout.setEncoding("utf8"),o.stderr.setEncoding("utf8"),o.stdout.on("data",function(e){i._logger.log("trace","stdout data:"+e),i._logger.log("debug",e),process.stdout.write(e);}),o.stdout.on("error",function(e){i._logger.log("error","stdout error:"+e.stack),console.error("child process stdout error",e);}),o.stderr.on("data",function(e){i._logger.log("error","stderr data:"+e),i._logger.log("error",e),process.env.DEBUG?process.stdout.write(e):process.stderr.write(e);}),o.stderr.on("error",function(e){i._logger.log("error","stderr error:"+e.stack),console.error("child process stderr error",e);}),o.on("message",function(e){i._onChildprocessMessage(e);}),o.on("error",function(e){i._logger.log("error","child process error:"+e.stack),console.error("child process error",e),o.__closed||(o.__closed=!0,i._onProcessExit(e));}),o.on("exit",function(e,t){i._logger.log("trace","child process exit for script executor "+e+" "+t),console.log("child process exit",e,t),o.__closed||(o.__closed=!0,i._onProcessExit());}),this._childProcess=o,e&&e();},t.prototype._onChildprocessMessage=function(e){this._logger.log("trace","child process message:"+JSON.stringify(e)),e&&"2.0"==e.jsonrpc?this._onChildProcessJsonRPC(e):"win32"==process.platform&&(e&&e.log?process.stdout.write(JSON.stringify(e.log)):e&&e.error&&process.stderr.write(JSON.stringify(e.error)));},t.prototype._onChildProcessJsonRPC=function(t){var r=new e(this,t);this._jsonrpcRequests.push(r),r.execute();},t.prototype._onProcessExit=function(e){this._logger.log("debug","script executor finished"+(e?" with error:"+e.message:"")),this._start();},t;}(),x.hub.scriptman.ScriptManager=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.ScriptManager"),this._scripts=[],this._service=x.hub.scriptman.ScriptExecutorService,this._service2=new x.hub.scriptman.ScriptExecutorService2();};return e.FOLDER_NAME="scripts",e.FILE_NAME="sm.json",e.prototype.init=function(e){var t=this._getScriptIndexFile(),r=this;require("fs-extra").ensureFile(t,function(t){t?e&&e(t):r._loadData(function(t,s){t?e&&e(t):(r._scripts=s,r._sort(),e&&e());});});},e.prototype.reload=function(e){this.init(e);},e.prototype.createScript=function(e,t,r){if(e){for(var s=1,i=-1,o=1,n=0;n<this._scripts.length;n++){if(this._scripts[n].id>s){o=s,i=n;break;}s++;}-1==i&&(o=s,i=this._scripts.length);var c=this,u={id:o,name:e,file:o};this._writeScript(o,t,function(e){e?r&&r(e):(c._scripts.splice(i,0,u),c._writeData(function(e){e&&c._scripts.splice(i,1),r&&r(e,u);}));});}else r&&r(new Error("name is null"));},e.prototype.readScriptContent=function(e,t){if(e){for(var r=null,s=0;s<this._scripts.length;s++){var i=this._scripts[s];if(i.id==e){r=i;break;}}r?this._readScript(e,function(e,r){t&&t(e,r);}):t&&t(new Error("no such script with id:"+e));}else t&&t(new Error("script id is null"));},e.prototype.readAllScripts=function(e){e&&e(null,this._scripts);},e.prototype.updateScript=function(e,t,r,s){if(e){for(var i=null,o=0;o<this._scripts.length;o++){var n=this._scripts[o];if(n.id==e){i=n;break;}}if(i){var c=this;this._writeScript(e,r,function(e){e?s&&s(e):t&&i.name!=t?(i.name=t,c._writeData(s)):s&&s();});}else s&&s(new Error("no such script with id:"+e));}else s&&s(new Error("script id is null"));},e.prototype.deleteScript=function(e,t){if(e){for(var r=-1,s=null,i=0;i<this._scripts.length;i++){var o=this._scripts[i];if(o.id==e){r=i,s=o;break;}}var n=this;this.stopScript(e),this._deleteScript(e,function(e){e?t&&t(e):(n._scripts.splice(r,1),n._writeData(function(e){e&&n._scripts.splice(r,0,s),t&&t(e);}));});}else t&&t(new Error("script id is null"));},e.prototype.runScript=function(e,t,r){if(e){for(var s=null,i=0;i<this._scripts.length;i++){var o=this._scripts[i];if(o.id==e){s=o;break;}}if(s){var n=require("path"),c=e+"",u=this._getScriptDir(),a=n.resolve(u,c);this._service2.execute2(a,t,r);}else t&&t(new Error("no such script with id:"+e));}else t&&t(new Error("script id is null"));},e.prototype.debugScript=function(e,t,r){if(e){for(var s=null,i=0;i<this._scripts.length;i++){var o=this._scripts[i];if(o.id==e){s=o;break;}}if(s){var n=this;this.readScriptContent(e,function(e,i){e?t.onError(e):n._service.debug(s,i,t,r);});}else t.onError(new Error("no such script with id:"+e));}else t.onError(new Error("script id is null"));},e.prototype.stopScript=function(e,t){if(e){for(var r=[],s=0;s<this._scripts.length;s++){var i=this._scripts[s];if(i.id==e){r.push(i);break;}}if(0!=r.length){var o=this,n=0,c=function c(){++n>=r.length?t&&t():o._service.stopScript(r[n],c);};this._service2.stopScript(r[n],c);}else t&&t(new Error("no such script with id:"+e));}else t&&t(new Error("script id is null"));},e.prototype.deleteAllScripts=function(e){for(var t=0;t<this._scripts.length;t++){var r=this._scripts[t];this.stopScript(r.id);}var s=this;this._scripts=[],this._writeData(function(t){t?e&&e(t):s._emptyScriptFolder(function(t){e&&e(t);});});},e.prototype._getScriptDir=function(){var t=require("path"),r=require("x.hub.fileman.js").fileManager.getUserRootDataPath();return t.resolve(r,e.FOLDER_NAME);},e.prototype._getScriptIndexFile=function(){var t=require("path"),r=this._getScriptDir();return t.resolve(r,e.FILE_NAME);},e.prototype._writeData=function(e){var t=this._scripts,r=require("fs"),s=this._getScriptIndexFile();r.writeFile(s,JSON.stringify(t,null,2),function(t){e&&e(t);});},e.prototype._loadData=function(t){var r=require("path"),s=require("fs"),i=this._getScriptDir(),o=r.resolve(i,e.FILE_NAME);s.readFile(o,"utf8",function(e,r){if(e)t&&t(e);else if(r)try{t&&t(null,JSON.parse(r));}catch(e){t&&t(e);}else t&&t(null,[]);});},e.prototype._writeScript=function(e,t,r){var s=require("fs-extra"),i=require("path");e+="";var o=this._getScriptDir(),n=i.resolve(o,e);s.writeFile(n,t,function(e){r&&r(e);});},e.prototype._readScript=function(e,t){var r=require("fs-extra"),s=require("path");e+="";var i=this._getScriptDir(),o=s.resolve(i,e);r.readFile(o,"utf8",function(e,r){t&&t(e,r);});},e.prototype._deleteScript=function(e,t){var r=require("fs-extra"),s=require("path");e+="";var i=this._getScriptDir(),o=s.resolve(i,e);r.remove(o,function(e){t&&t(e);});},e.prototype._emptyScriptFolder=function(e){var t=require("fs-extra"),r=(require("path"),this._getScriptDir());t.emptyDir(r,function(t){e&&e(t);});},e.prototype._sort=function(){var e=this._scripts.length-1,t=!1;do{t=!1;for(var r=0;r<e;++r)if(this._scripts[r].id>this._scripts[r+1].id){var s=this._scripts[r];this._scripts[r]=this._scripts[r+1],this._scripts[r+1]=s,t=!0;}}while(t);},e;}(),x.hub.scriptman.Handler=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.Handler"),this.scriptManager=new x.hub.scriptman.ScriptManager(),this.httpServer=null;};return e.prototype.ScriptManager=x.hub.scriptman.ScriptManager,e.prototype.init=function(e,t,r){"CA"==global.HARDWARE_VERSION?this._configNew(e,t):this._config(e,t),this.scriptManager.init(r);},e.prototype._configNew=function(e,t){var r=this;this.httpServer=t;var s=require("url"),i=new(0,require("ws").Server)({server:t,path:"/xhub/script/debug"});i.on("connection",function(e){var t=s.parse(e.upgradeReq.url,!0);if(t.query&&t.query.id){var i=new x.hub.scriptman.Debugger(e);r.scriptManager.debugScript(t.query.id,i);}else e.send(JSON.stringify({type:"error",message:"no script id"})),e.close();}),i.on("error",function(e){r._logger.log("warn","script web socket server error:"+e.stack);});var o=require("x.hub.js").getServer();o._app.use(["/xhub/script","/xhub/script/*"],function(e,t,s){try{if(!o._pwd)return void t.send('{"XC_ERR":{"code":"000007", "msg":"unauthorized access not allowed"}}');s();}catch(e){r._logger.log("error",e),t.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}');}}),o.addRoute("/xhub/script/do",{method:"GET"},function(e,t){var s=e.query.id;s?r.scriptManager.runScript(s,function(e){t.send(r._toRestfulResponse(e,"ok"));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script id")));}),o.addRoute("/xhub/script/stop",{method:"GET"},function(e,t){var s=e.query.id;s?x.hub.scriptman.ScriptExecutorService.stop(s,function(e){t.send(r._toRestfulResponse(e,"ok"));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no executor id")));}),o.addRoute("/xhub/script/running",{method:"GET"},function(e,t){var s=x.hub.scriptman.ScriptExecutorService.getAllRunning();t.send(r._toRestfulResponse(null,s));}),o.addRoute("/xhub/script/callback",{method:"POST"},function(e,t){var s=e.body;s?r._doCallback(s,function(e,s){t.send(r._toRestfulResponse(e,s));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no callback body")));}),o.addRoute("/xhub/scripts",{method:"GET"},function(e,t){r.scriptManager.readAllScripts(function(e,s){e?t.send(r._toRestfulResponse(e)):t.json(s);});}),o.addRoute("/xhub/script",{method:"POST",body:"text"},function(e,t){var s=e.query.name;s?r.scriptManager.createScript(s,e.body,function(e,s){t.send(r._toRestfulResponse(e,s));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script name")));}),o.addRoute("/xhub/script",{method:"GET",auth:1},function(e,t){var s=e.query.id;s?r.scriptManager.readScriptContent(s,function(e,s){e?t.send(r._toRestfulResponse(e)):t.send(s);}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script id")));}),o.addRoute("/xhub/script",{method:"PUT",body:"text"},function(e,t){var s=e.query.id;if(s){var i=e.query.name;r.scriptManager.updateScript(s,i,e.body,function(e){t.send(r._toRestfulResponse(e,"ok"));});}else t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script id")));}),o.addRoute("/xhub/script",{method:"DELETE"},function(e,t){var s=e.query.id;s?r.scriptManager.deleteScript(s,function(e){t.send(r._toRestfulResponse(e,"ok"));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script id")));});},e.prototype._config=function(e,t){var r=this;this.httpServer=t;var s=require("url"),i=new(0,require("ws").Server)({server:t,path:"/xhub/script/debug"});i.on("connection",function(e){var t=s.parse(e.upgradeReq.url,!0);if(t.query&&t.query.id){var i=new x.hub.scriptman.Debugger(e);r.scriptManager.debugScript(t.query.id,i);}else e.send(JSON.stringify({type:"error",message:"no script id"})),e.close();}),i.on("error",function(e){r._logger.log("warn","script web socket server error:"+e.stack);});var o=require("body-parser"),n=require("x.hub.js").getServer();e.use(["/xhub/script","/xhub/script/*"],function(e,t,s){if("automation"!==e.neo_origin)try{if(!n._pwd)return void t.send('{"XC_ERR":{"code":"000007", "msg":"unauthorized access not allowed"}}');s();}catch(e){r._logger.log("error",e),t.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}');}else s();}),e.use(["/xhub/script","/xhub/script/*"],function(e,t,r){"automation"!==e.neo_origin?n._preHandleRequest(e,t,r):r();}),e.use("/xhub/script/callback",o.json({limit:"50mb"})),e.use("/xhub/script",o.text({limit:"50mb"})),e.post("/xhub/script",function(e,t){var s=e.query.name;s?r.scriptManager.createScript(s,e.body,function(e,s){t.send(r._toRestfulResponse(e,s));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script name")));}.bind(this)),e.get("/xhub/script",function(e,t){var s=e.query.id;s?r.scriptManager.readScriptContent(s,function(e,s){e?t.send(r._toRestfulResponse(e)):t.send(s);}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script id")));}.bind(this)),e.get("/xhub/scripts",function(e,t){r.scriptManager.readAllScripts(function(e,s){e?t.send(r._toRestfulResponse(e)):t.send(JSON.stringify(s));});}.bind(this)),e.put("/xhub/script",function(e,t){var s=e.query.id;if(s){var i=e.query.name;r.scriptManager.updateScript(s,i,e.body,function(e){t.send(r._toRestfulResponse(e,"ok"));});}else t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script id")));}.bind(this)),e["delete"]("/xhub/script",function(e,t){var s=e.query.id;s?r.scriptManager.deleteScript(s,function(e){t.send(r._toRestfulResponse(e,"ok"));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script id")));}.bind(this)),e.get("/xhub/script/do",function(e,t){var s=e.query.id;s?r.scriptManager.runScript(s,function(e){t.send(r._toRestfulResponse(e,"ok"));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no script id")));}.bind(this)),e.get("/xhub/script/stop",function(e,t){var s=e.query.id;s?x.hub.scriptman.ScriptExecutorService.stop(s,function(e){t.send(r._toRestfulResponse(e,"ok"));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no executor id")));}.bind(this)),e.get("/xhub/script/running",function(e,t){var s=x.hub.scriptman.ScriptExecutorService.getAllRunning();t.send(r._toRestfulResponse(null,s));}.bind(this)),e.post("/xhub/script/callback",function(e,t){var s=e.body;s?r._doCallback(s,function(e,s){t.headersSent||t.send(r._toRestfulResponse(e,s));}):t.send(r._toRestfulResponse(new x.hub.scriptman.Error("no callback body")));}.bind(this));},e.prototype._toRestfulResponse=function(e,t){return e?{status:"fail",message:e.message,code:e.code?e.code:0}:{status:"success",data:t};},e.prototype._doCallback=function(e,t){this._logger.log("trace","do callback:"+JSON.stringify(e));var r=require("x.hub.commandman.js").commandHandler;if("executeCommand"==e.func){if(!(e.device&&e.command&&e.device.device&&e.device.room))return void(t&&t(new Error("execute command argument invalid")));r.executeCommandWithRef(e.device.room,e.device.device,null,e.command,function(e){t&&t(e.error,e.data);});}else if("getStatus"==e.func){if(!(e.device&&e.status&&e.device.device&&e.device.room))return void(t&&t(new Error("get status argument invalid")));r.getStateWithRef(e.device.room,e.device.device,null,e.status,function(e){t&&t(e.error,e.data);});}else if("executeMacro"==e.func){if(!e.groupName||!e.macroName)return void(t&&t(new Error("execute macro argument invalid")));require("x.hub.macroman.js").execute(e.groupName,e.macroName,function(e){t&&t(e.error,e.data);});}else t&&t();},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.scriptman.Handler());