var x=x||{};x.mjpeg=x.mjpeg||{};
x.mjpeg.Client=function(){var e=function(f,a){this._mjpegUrl=f;this._options=a;this._mjpegClientID=null};e.prototype.getFile=function(f,a,c){this._getFile(f,a,c)};e.prototype._getFile=function(f,a,c){a.url=f;var b=this;this._mjpegClientID?(a.clientID=this._mjpegClientID,XC.callHost("mjpeg","getMjpegFile",a,function(a){a&&!a.error&&a.file?(a.clientID&&(b._mjpegClientID=a.clientID),c&&c(a.file)):c&&c()})):XC.callHost("mjpeg","buildSocket",a,function(h){!h||h.error?c&&c():h.clientID&&(b._mjpegClientID=
h.clientID,b._getFile(f,a,c))})};var d=function(f,a){this._mjpegUrl=f;this._options=a;this._timeout=this._currentImage=this._stream=null};d.prototype.getFile=function(f,a,c){var b=this;null!=this._timeout&&(clearTimeout(this._timeout),this._timeout=setTimeout(function(){b._timeout=null;b._close()},1E4));this._stream?b._writeImage2File(b._currentImage,c):this._connect(f,a,function(a,f){a?(b._stream=a,b._currentImage=f,null!=b._timeout&&clearTimeout(b._timeout),b._timeout=setTimeout(function(){b._timeout=
null;b._close()},1E4),b._writeImage2File(b._currentImage,c)):c&&c(null)})};d.prototype._writeImage2File=function(f,a){if(null==f)a&&a(null);else{var c=require("fs"),b=require("os").tmpdir();b.charAt(b.length-1)!=require("path").sep&&(b+=require("path").sep);b=b+"xcdl"+require("path").sep;var h=b+Math.random().toString(36).substring(2);try{c.existsSync(b)||c.mkdirSync(b)}catch(q){a&&a(null);return}c.writeFile(h,f,function(b){a&&a(b?null:h)})}};d.prototype._connect=function(f,a,c,b){var h=this,d=require("url").parse(f),
e=80;if(d.port&&(e=parseInt(d.port),0==e&&(e=80),!(0<e&&65536>e))){c&&c(null);return}var n={host:d.hostname,port:e,path:d.path,method:"GET"};a&&a.user&&(n.auth=a.user+":"+a.password);b&&(n.headers.Authorization=b);d=require("http");"https"==f.substring(0,5).toLowerCase()&&(d=require("https"));var g=c,p=d.request(n,function(d){if(200==d.statusCode){g&&(g(p),g=null);var e,l=-1,m=-1,k=new Buffer([]);d.on("end",function(){g&&(g(null),g=null);h._stream=null;h._close()});d.on("data",function(a){a&&(k=Buffer.concat([k,
a]));if(-1==l)for(e=0;e<k.length;e++)if(255==k[e]&&216==k[e+1]){l=e;break}if(0<=l&&-1==m)for(e=k.length-2;e>l;e--)if(255==k[e]&&217==k[e+1]){m=e+1;break}0<=l&&0<m?(h._currentImage=k.slice(l,m),k=m==k.length-1?new Buffer([]):k.slice(m+1),m=l=-1):204800<k.length&&h._close()})}else 302==d.statusCode?d.headers.location?(h._connect(d.headers.location,a,c),d.destroy()):g&&(g(null),g=null):401!=d.statusCode||b?g&&(g(null),g=null):(b=null,d.headers&&d.headers["www-authenticate"]&&"Digest "==d.headers["www-authenticate"].substr(0,
7)?(b=require("x.crypt.js").DigestAuth(d.headers["www-authenticate"],n.path,a.user,a.password))?h._connect(f,a,c,b):g&&(g(null),g=null):g&&(g(null),g=null))});p.setTimeout(3E4,function(){p.abort()});p.on("error",function(a){g?(g(null),g=null):(h._stream=null,h._close())});p.end()};d.prototype._close=function(){this._stream&&this._stream.abort();this._timeout&&clearTimeout(this._timeout);this._timeout=this._currentImage=this._stream=null};var n=function(){};n.getClient=function(f,a){var c=null;window&&
!window.XCHost&&(c="node-webkit");window&&window.XCHost&&window.XCHost.getType&&(c=window.XCHost.getType());if("Android"==c)return new e(f,a);if("node-webkit"==c||process&&"node"==process.title)return new d(f,a);throw Error("iOS should not use mjpeg client");};return n}();x.mjpeg.Handler=function(){var e=function(){};e.prototype.getClient=function(d,e){if(!d)throw Error("mjpeg url invalid");return x.mjpeg.Client.getClient(d,e)};return e}();
"undefined"!=typeof module&&null!=module&&(module.exports=new x.mjpeg.Handler);
