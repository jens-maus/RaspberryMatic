var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.artnet=xnm.aio.artnet||{},xnm.aio.artnet.Controller=function(t,e,o){this.ip=t,this.port=e,this.port||(this.port=6454),this.name=o,this._DMXdata=[];},xnm.aio.artnet.Controller.prototype._doRequest=function(t,e,o){var n=[65,114,116,45,78,101,116,0];(n=n.concat(t.concat([0,14]))).push(0),n.push(0),n.push(0),n.push(0);var r=e.length;r>512&&(r=512),n.push((65280&r)>>8),n.push(255&r),n=n.concat(e);var a=require("dgram").createSocket("udp4");a.on("message",function(t,e){XC.debugf(t);});var s=new Buffer(n);XC.debugf(s),a.send(s,0,18+r,this.port,this.ip,function(t,e){o&&o();});},xnm.aio.artnet.Controller.prototype.sendDMX512Data=function(t){this._doRequest([0,80],this._DMXdata,t);},xnm.aio.artnet.Controller.prototype.setDMX512Data=function(t){this._DMXdata=t;},xnm.aio.artnet.Controller.prototype.setDMX512Channel=function(t,e){if(t>512&&(t=512),!((t-=1)<0)){for(;this._DMXdata.length<=t;)this._DMXdata.push(0);this._DMXdata[t]=e;}},xnm.aio.artnet.Discovery=function(){this.detectedControllers={},this._sockets=[];var t=require("os"),e=require("dgram");if(t&&t.networkInterfaces){var o=this,n=e.createSocket("udp4");n.bind(6454,"0.0.0.0"),n.on("message",function(t,e){o._receivedData(e.address,t);});var r=t.networkInterfaces();for(var a in r)for(var s=r[a],i=0;i<s.length;i++)this._addDiscoverSocket(6454,s[i]);}else this._addDiscoverSocket(6454,null);},xnm.aio.artnet.Discovery.prototype._receivedData=function(t,e){if(e.length>110&&(e instanceof Array||e instanceof Buffer)&&0==e[8]&&33==e[9]){for(var o=e[10]+"."+e[11]+"."+e[12]+"."+e[13],n="",r=44;r<108&&0!=e[r];r++)n+=String.fromCharCode(e[r]);this.detectedControllers[o]||(this.detectedControllers[o]=new xnm.aio.artnet.Controller(o,null,n),this._callback&&this._callback(this.detectedControllers[o]));}},xnm.aio.artnet.Discovery.prototype._addDiscoverSocket=function(t,e){var o,n=require("dgram"),r=this;e?"IPv4"==e.family&&0==e.internal&&((o=n.createSocket("udp4")).on("listening",function(){o.setBroadcast(!0);}),o.bind(t,e.address),this._sockets.push(o)):((o=n.createSocket("udp4")).on("message",function(t,e){r._receivedData(e.address,t);}),this._sockets.push(o));},xnm.aio.artnet.Discovery.prototype._sendDiscoveryMessages=function(t,e,o,n){for(var r=new Buffer([65,114,116,45,78,101,116,0,0,32,0,14,0,0]),a=0;a<this._sockets.length;a++)this._sockets[a].send(r,0,r.length,6454,"255.255.255.255");},xnm.aio.artnet.Discovery.prototype.discoverControllers=function(t){this._callback=t;var e=this,o=0,n=setInterval(function(){e._sendDiscoveryMessages(),o++>=1&&clearInterval(n);},250);},xnm.aio.artnet.Handler=function(){this._discovery=null;},xnm.aio.artnet.Handler.prototype.discoverControllers=function(t){this._discovery||(this._discovery=new xnm.aio.artnet.Discovery()),this._discovery.discoverControllers(t);},xnm.aio.artnet.Handler.prototype.Controller=xnm.aio.artnet.Controller,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.artnet.Handler());