var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(g,c,a){g instanceof String&&(g=String(g));for(var b=g.length,d=0;d<b;d++){var e=g[d];if(c.call(a,e,d,g))return{i:d,v:e}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(g,c,a){if(g==Array.prototype||g==Object.prototype)return g;g[c]=a.value;return g};$jscomp.getGlobal=function(g){g=["object"==typeof globalThis&&globalThis,g,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<g.length;++c){var a=g[c];if(a&&a.Math==Math)return a}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(g,c){var a=$jscomp.propertyToPolyfillSymbol[c];if(null==a)return g[c];a=g[a];return void 0!==a?a:g[c]};
$jscomp.polyfill=function(g,c,a,b){c&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(g,c,a,b):$jscomp.polyfillUnisolated(g,c,a,b))};$jscomp.polyfillUnisolated=function(g,c,a,b){a=$jscomp.global;g=g.split(".");for(b=0;b<g.length-1;b++){var d=g[b];if(!(d in a))return;a=a[d]}g=g[g.length-1];b=a[g];c=c(b);c!=b&&null!=c&&$jscomp.defineProperty(a,g,{configurable:!0,writable:!0,value:c})};
$jscomp.polyfillIsolated=function(g,c,a,b){var d=g.split(".");g=1===d.length;b=d[0];b=!g&&b in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var e=0;e<d.length-1;e++){var f=d[e];if(!(f in b))return;b=b[f]}d=d[d.length-1];a=$jscomp.IS_SYMBOL_NATIVE&&"es6"===a?b[d]:null;c=c(a);null!=c&&(g?$jscomp.defineProperty($jscomp.polyfills,d,{configurable:!0,writable:!0,value:c}):c!==a&&(void 0===$jscomp.propertyToPolyfillSymbol[d]&&($jscomp.propertyToPolyfillSymbol[d]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(d):
$jscomp.POLYFILL_PREFIX+d),$jscomp.defineProperty(b,$jscomp.propertyToPolyfillSymbol[d],{configurable:!0,writable:!0,value:c})))};$jscomp.polyfill("Array.prototype.find",function(g){return g?g:function(c,a){return $jscomp.findInternal(this,c,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.bose=xnm.aio.bose||{};
xnm.aio.bose.SoundTouch=function(){var g=function(c){this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("xnm.aio.bose.SoundTouch"):{log:{}};this._renderer=null;this.mac=c?c.mac:null;this.name=c?c.name:null;this.bass=c?c.base:null;this.sources=c?c.sources:null;this.isMaster=!1;this.members=null;c&&c.ip&&c.port&&c.uuid&&(this._renderer=this._getRenderer(c.ip,c.port,c.uuid))};g.PLAY_STATUS=["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"];
g.prototype.getIP=function(){return this._renderer?this._renderer.ip:null};g.prototype.setIP=function(c){this._renderer&&(this._renderer.ip=c)};g.prototype.getPort=function(){return this._renderer?this._renderer.port:null};g.prototype.setPort=function(c){this._renderer&&(this._renderer.port=c)};g.prototype.getUUID=function(){return this._renderer?this._renderer.uuid:null};g.prototype.getName=function(){return this.name?this.name:this._renderer?this._renderer.name:null};g.prototype.getMac=function(){return this.mac?
this.mac:this._renderer?this._renderer.serialNumber:null};g.prototype.getInfos=function(c){var a=4,b={},d=function(e){a--;e?c&&c(e):0==a&&c&&c(null,b)};this._getInfo(function(e,f){f&&(b.name=f.name,b.mac=f.mac);d&&d(e);e&&(d=null)});this._getBassCap(function(e,f){f&&(b.bass=f.bass);d&&d(e);e&&(d=null)});this._getSources(function(e,f){f&&(b.sources=f);d&&d(e);e&&(d=null)});this._getZone(function(e,f){f&&(b.zoneInfo=f);d&&d(e);e&&(d=null)})};g.prototype.getRooms=function(c){var a=this;require("xnm.aio.bose.js").master.getZones(function(b,
d){if(b)c&&c(b);else{b={};for(var e=0;e<d.length;e++){var f=d[e];if(f&&f.masterMac==a.mac){for(d=0;d<f.players.length;d++)(e=f.players[d])&&e.mac&&e.name&&(b[e.mac]=e.name);break}}c&&c(null,b)}})};g.prototype.getPlayInfo=function(c){this._getNowPlaying(function(a,b){a?c&&c(a):(a={trackMetaData:b},a.trackMetaData.albumArtURI=b.art,a.trackMetaData.title=b.track,c&&c(null,a))})};g.prototype.play=function(c,a,b){if(c&&a&&a["class"]&&a.id)if(this._renderer){var d=this;c.browseMetaData(a.id,function(e,
f){e?b&&b(e):0!=a["class"].indexOf("object.container")||a.res&&a.res.url?a.res&&a.res.url?d._renderer.playResource({url:a.res.url},f.result,b):b&&b(Error("resource url invalid")):c.uuid?d._renderer.playContainer({containerID:a.id,server_uuid:c.uuid},f.result,b):b&&b(Error("media server uuid invalid"))})}else b&&b(Error("renderer not inited"));else b&&b(Error("play obj invalid"))};g.prototype.playUrl=function(c,a){if(c){var b=this;this._renderer._setAVTransportURI(0,c,null,function(d){d?a&&a(d):b._renderer.play(a)})}else a&&
a(Error("url is null"))};g.prototype.browser=function(c,a,b,d,e){c?(a||(a=0),b||(b=0),d||(d=0),c.browseChildren(a,b,d,null,function(f,l,h){e&&e(f,l,h)})):e&&e(Error("play obj invalid"))};g.prototype.executeCommandCreator=function(c,a,b){a&&a.value?this._executeCommand(a.value,a.ext,function(d){b&&b(d)}):b&&b(Error("command value is empty"))};g.prototype.getStatesCreator=function(c,a,b){this._getStates(function(d,e){if(d)b&&b(d);else{d=[];for(var f=0;f<a.length;f++){var l=a[f];if(l&&l.id&&l.status){var h=
"?";switch(l.status.value){case "power":case "muted":case "volume":case "repeatMode":case "shuffleMode":case "playState":case "durationS":case "positionS":case "bass":h=e[l.status.value];break;case "artist":case "title":case "album":case "radio":(h=e[l.status.value])||(h="")}if("undefined"==typeof h||null==h)h="?";d.push({id:l.id,status:h})}}b&&b(null,d)}})};g.prototype._executeCommand=function(c,a,b){if(this._renderer){var d=this;switch(c){case "play":this._clickKey("PLAY",b);break;case "pause":this._clickKey("PAUSE",
b);break;case "tooglePlay":this._clickKey("PLAY_PAUSE",b);break;case "stop":this._clickKey("STOP",b);break;case "previous":this._clickKey("PREV_TRACK",b);break;case "next":this._clickKey("NEXT_TRACK",b);break;case "togglePower":this._clickKey("POWER",b);break;case "toggleMute":this._clickKey("MUTE",b);break;case "volumeUp":this._clickKey("VOLUME_UP",b);break;case "volumeDown":this._clickKey("VOLUME_DOWN",b);break;case "setVolume":if("undefined"==typeof a||null==a){b&&b(Error("volume value invalid"));
break}a=parseInt(a);100<a&&(a=100);0>a&&(a=0);this._setVolume(a,b);break;case "thumbUp":this._clickKey("THUMBS_UP",b);break;case "thumbDown":this._clickKey("THUMBS_DOWN",b);break;case "bookmark":this._clickKey("BOOKMARK",b);break;case "preset":if(!a){b&&b(Error("preset value invalid"));break}this._clickKey("PRESET_"+a,b);break;case "shuffleOn":this._clickKey("SHUFFLE_ON",b);break;case "shuffleOff":this._clickKey("SHUFFLE_OFF",b);break;case "toggleShuffle":this._getNowPlaying(function(h,k){h?b&&b(h):
k&&k.shuffleSetting?(h="SHUFFLE_ON","SHUFFLE_ON"==k.shuffleSetting&&(h="SHUFFLE_OFF"),d._clickKey(h,b)):b&&b(Error("no shuffle setting"))});break;case "setRepeatMode":if(!a){b&&b(Error("play mode value invalid"));break}this._clickKey(a,b);break;case "addFav":this._clickKey("ADD_FAVORITE",b);break;case "removeFav":this._clickKey("REMOVE_FAVORITE",b);break;case "bassUp":case "bassDown":if("undefined"==typeof a||null==a){b&&b(Error("seek value invalid"));break}this._getBass(function(h,k){if(h)b&&b(h);
else if(k&&"undefined"!=typeof k.actualbass&&null!=k.actualbass){h=k.actualbass;h="bassUp"==c?h+1:h-1;if(this.bass&&(e=this.bass.indexOf("-",1),-1!=e)){k=this.bass.substring(0,e);var m=this.bass.substr(e+1);k=parseInt(k);m=parseInt(m);h<k&&(h=k);h>m&&(h=m)}d._setBass(h,b)}else b&&b(Error("no bass info"))});break;case "setBass":if("undefined"==typeof a||null==a){b&&b(Error("volume value invalid"));break}a=parseInt(a);if(this.bass){var e=this.bass.indexOf("-",1);if(-1!=e){var f=this.bass.substring(0,
e),l=this.bass.substr(e+1);f=parseInt(f);l=parseInt(l);a<f&&(a=f);a>l&&(a=l)}}this._setBass(a,b);break;case "playUrl":if(!a){b&&b(Error("url value invalid"));break}this.playUrl(a,b);break;default:c&&"select:"==c.substr(0,7)?(f=c.substr(7),e=f.indexOf("@"),a=f.substring(0,e),f=f.substr(e+1),d._setSource(a,f,b)):b&&b(Error("unknown command"))}}else b&&b(Error("renderer not initialized"))};g.prototype._getStates=function(c){var a=function(){d--;0==d&&c&&c(null,b)},b={},d=3;this._getBass(function(e,f){!e&&
f&&(b.bass=f.actualbass);a()});this._getVolume(function(e,f){!e&&f&&(b.volume=f.actualvolume,b.muted=f.muteenabled);a()});this._getNowPlaying(function(e,f){!e&&f&&(b.power="STANDBY"==f.source?"off":"on",f.repeatSetting&&(b.repeatMode=f.repeatSetting),f.shuffleSetting&&(b.shuffleMode=f.shuffleSetting),f.playStatus&&(b.playState=f.playStatus),f.duration&&(b.durationS=f.duration),f.position&&(b.positionS=f.position),f.position&&(b.positionS=f.position),f.track&&(b.title=f.track),f.stationName&&(b.radio=
f.stationName),f.artist&&(b.artist=f.artist),f.album&&(b.album=f.album));a()})};g.prototype._getRenderer=function(c,a,b){var d=new (require("x.upnp.js").MediaRenderer);d.init(c,a,b,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/UD/"+b+"?2"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/UD/"+b+"?1"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/UD/"+b+"?0"}});return d};g.prototype._clickKey=function(c,a){var b=
this;this._pressKey(c,function(d){d?a&&a(d):b._releaseKey(c,function(e){a&&a(e)})})};g.prototype._getInfo=function(c){var a=this;this._sendRequest("GET","/info",null,function(b,d){b?c&&c(b):(b=d.find("info"))&&b[0]?(b=$(b[0]),a.mac=b.attr("deviceID"),(b=b.find("name"))&&b[0]&&(a.name=$(b[0]).text()),c&&c(null,{name:a.name,mac:a.mac})):c&&c(Error("get info xml invalid"))})};g.prototype._pressKey=function(c,a){this._sendRequest("POST","/key",'<key state="press" sender="Gabbo">'+c+"</key>",a)};g.prototype._releaseKey=
function(c,a){this._sendRequest("POST","/key",'<key state="release" sender="Gabbo">'+c+"</key>",a)};g.prototype._getSources=function(c){var a=this;this._sendRequest("GET","/sources",null,function(b,d){if(b)c&&c(b);else{var e=[];d.find("sourceItem").each(function(){var f=$(this);e.push({source:f.attr("source"),sourceAccount:f.attr("sourceAccount")?f.attr("sourceAccount"):null,isLocal:f.attr("isLocal"),name:f.text()?f.text():null})});a.sources=e;c&&c(null,e)}})};g.prototype._setSource=function(c,a,
b){c='<ContentItem source="'+c+'"';a&&(c+=' sourceAccount="'+a+'"');this._sendRequest("POST","/select",c+"></ContentItem>",b)};g.prototype._setBass=function(c,a){this._sendRequest("POST","/bass","<bass>"+c+"</bass>",a)};g.prototype._getBass=function(c){this._sendRequest("GET","/bass",null,function(a,b){if(a)c&&c(a);else{var d={},e=b.find("targetbass");e&&e[0]&&(d.targetbass=parseInt($(e[0]).text()));(e=b.find("actualbass"))&&e[0]&&(d.actualbass=parseInt($(e[0]).text()));c&&c(a,d)}})};g.prototype._getBassCap=
function(c){var a=this;this._sendRequest("GET","/bassCapabilities",null,function(b,d){if(b)c&&c(b);else if((b=d.find("bassAvailable"))&&b[0])if((b=$(b[0]).text())&&"false"!=b.toLowerCase()){b=0;var e=d.find("bassMin");e&&e[0]&&(b=$(e[0]).text());e=100;(d=d.find("bassMax"))&&d[0]&&(e=$(d[0]).text());a.bass=b+"-"+e;c&&c(null,{bass:a.bass})}else c&&c(null,null);else c&&c(Error("get bass cap xml invalid"))})};g.prototype._getZone=function(c){var a=this;this._sendRequest("GET","/getZone",null,function(b,
d){if(b)c&&c(b);else{var e={isMaster:!1};if((b=d.find("zone"))&&b[0]){d=$(b[0]).attr("master");if(!d){e.isMaster=!0;e.master=a.getMac();e.members={};e.members[a.getMac()]=a.getIP();a.isMaster=!0;a.members=e.members;c&&c(null,e);return}e.master=d;d==a.getMac()&&(e.isMaster=!0)}$(b[0]).find("member").each(function(){var f=$(this),l=f.attr("ipaddress");f=f.text();l&&f&&(e.members||(e.members={}),e.members[f]=l)});a.isMaster=e.isMaster;a.members=e.members;c&&c(null,e)}})};g.prototype._setZone=function(c,
a,b){c='<zone master="'+c+'" senderIPAddress="0.0.0.0">';for(var d in a)a.hasOwnProperty(d)&&a[d]&&(c+='<member ipaddress="'+a[d]+'">'+d+"</member>");this._sendRequest("POST","/setZone",c+"</zone>",b)};g.prototype._getVolume=function(c){this._sendRequest("GET","/volume",null,function(a,b){if(a)c&&c(a);else{var d={},e=b.find("targetvolume");e&&e[0]&&(d.targetvolume=parseInt($(e[0]).text()));(e=b.find("actualvolume"))&&e[0]&&(d.actualvolume=parseInt($(e[0]).text()));(e=b.find("muteenabled"))&&e[0]&&
(d.muteenabled=$(e[0]).text());c&&c(a,d)}})};g.prototype._setVolume=function(c,a){this._sendRequest("POST","/volume","<volume>"+c+"</volume>",a)};g.prototype._getNowPlaying=function(c){this._sendRequest("GET","/now_playing",null,function(a,b){if(a)c&&c(a);else{a={};var d=b.find("nowPlaying");if(d&&d[0]){var e=$(d[0]).getAttributes();a=JSON.parse(JSON.stringify(e))}(d=b.find("ContentItem"))&&d[0]&&(e=$(d[0]).getAttributes(),a.content=JSON.parse(JSON.stringify(e)),(e=$(d[0]).find("itemName"))&&e[0]&&
(a.content.itemName=$(e[0]).text()));(d=b.find("track"))&&d[0]&&(a.track=$(d[0]).text());(d=b.find("artist"))&&d[0]&&(a.artist=$(d[0]).text());(d=b.find("album"))&&d[0]&&(a.album=$(d[0]).text());(d=b.find("stationName"))&&d[0]&&(a.stationName=$(d[0]).text());(d=b.find("art"))&&d[0]&&(a.artImageStatus=$(d[0]).attr("artImageStatus"),a.art=$(d[0]).text());(d=b.find("playStatus"))&&d[0]&&(a.playStatus=$(d[0]).text());(d=b.find("description"))&&d[0]&&(a.description=$(d[0]).text());(d=b.find("stationLocation"))&&
d[0]&&(a.description=$(d[0]).text());(d=b.find("time"))&&d[0]&&(a.duration=$(d[0]).attr("total"),a.position=$(d[0]).text());(d=b.find("shuffleSetting"))&&d[0]&&(a.shuffleSetting=$(d[0]).text());(d=b.find("repeatSetting"))&&d[0]&&(a.repeatSetting=$(d[0]).text());c&&c(null,a)}})};g.prototype._sendRequest=function(c,a,b,d){this._doRequest(this.getIP(),8090,c,a,b,function(e,f){if(e)d&&d(e);else try{var l=$($.parseXML(f)),h=l.find("error");if(h&&h[0]){var k=$(h[0]),m=k.text(),q=k.attr("name");d&&d(Error(m+
":"+q))}else d&&d(null,l)}catch(n){d&&d(n)}})};g.prototype._doRequest=function(c,a,b,d,e,f){var l=this;c="http://"+c+":"+a+d;this._logger.log("trace","send "+b+" to url:"+c);e&&this._logger.log("trace","with data "+e);var h=f;f={url:c,type:b,timeout:2E3,contentType:"text/xml",dataType:"text",cache:!0,success:function(k){l._logger.log("trace","http request success:"+k);h&&(h(null,k),h=null)},error:function(k,m){k="http request error:"+(k?k.status:"0")+"-"+m;l._logger.log("trace",k);h&&(h(Error(k)),
h=null)}};"post"==b.toLowerCase()&&e&&(f.data=e);$.ajax(f)};g.prototype.toJSON=function(){return{sys:"bose",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"SoundTouch",model:this._renderer?this._renderer.modelName:null,mac:this.getMac(),bass:this.bass,sources:this.sources,name:this.getName()}};g.prototype.equalsTo=function(c){return c&&c instanceof g?this.getIP()==c.getIP()&&this.getPort()==c.getPort():!1};return g}();
xnm.aio.bose.Master=function(){var g=function(){this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("xnm.aio.bose.Master"):{log:{}};this._mediaServer={};this._soundTouchs={};this._currentZone=null;var c=this;this._discovery=new xnm.aio.bose.Discovery;this._discoveryListener=function(a,b){a&&b&&("mediaServer"==a?c._mediaServer[b.uuid]=b:"soundTouch"==a&&c._onFindSoundTouch(b))};this._discovery.addListener(this._discoveryListener);this._discoveryCB=[];this._autoSearchTO=
null;this.searchSoundTouch()};g.prototype._onFindSoundTouch=function(c){var a=c.getUUID();this._soundTouchs[a]?(a=this._soundTouchs[a],a.dummy=!1,a.player.setIP(c.getIP()),a.player.setPort(c.getPort()),a.player.isMaster=c.isMaster,a.player.members=c.members):this._soundTouchs[a]={missCount:0,dummy:!1,player:c};this._currentZone?c.getMac()!=this._currentZone||c.isMaster||this.setCurrentZone():c.isMaster&&(this._currentZone=c.getMac())};g.prototype.searchSoundTouch=function(c){var a=this._discoveryCB.length;
c||(c=function(){});c&&-1==this._discoveryCB.indexOf(c)&&this._discoveryCB.push(c);if(0==a){this._autoSearchTO&&(clearTimeout(this._autoSearchTO),this._autoSearchTO=null);this._search();var b=this;setTimeout(function(){b._autoSearchTO=setTimeout(function(){b.searchSoundTouch(null)},3E4);var d=b._discoveryCB;b._discoveryCB=[];d.forEach(function(e){e(null,b._getFoundSoundTouchs())})},5E3)}};g.prototype._search=function(){for(var c in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(c)){var a=this._soundTouchs[c];
5<=a.missCount?delete this._soundTouchs[c]:a.missCount++}this._discovery.searchSoundTouch()};g.prototype.getCurrentZone=function(c){var a=this,b=this._getFoundSoundTouchs();if(b&&0!=b.length)if(this._currentZone){var d=this._findPlayerWithMac(this._currentZone);if(d){b=d.members;d={masterPlayer:d,masterMac:this._currentZone,players:[]};for(var e in b)if(b.hasOwnProperty(e)){var f=this._findPlayerWithMac(e);f&&d.players.push(f)}c&&c(null,d)}else c&&c(Error("no player with mac:"+this._currentZone))}else this.setCurrentZone(null,
function(l){l?c&&c(l):a.getCurrentZone(c)});else this.searchSoundTouch(function(l,h){l?c&&c(l):h&&0!=h.length?a.getCurrentZone(c):c&&c(Error("find no sound touch player"))})};g.prototype._findPlayerWithMac=function(c){for(var a in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(a)){var b=this._soundTouchs[a];if(b&&b.player&&b.player.getMac()==c)return b.player}return null};g.prototype.setCurrentZone=function(c,a){var b=null;if(c)(b=this._findPlayerWithMac(c))&&!b.isMaster&&(b=null);else for(var d in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(d)&&
(c=this._soundTouchs[d])&&c.player&&c.player.isMaster){b=c.player;break}b?(this._currentZone=b.getMac(),a&&a()):a&&a(Error("no such master"))};g.prototype.getZones=function(c){var a=this,b=this._getFoundSoundTouchs();if(b&&0!=b.length)for(var d=0,e={},f=function(h,k){d++;!h&&k&&k.isMaster&&k.master&&k.members&&(e[k.master]=k.members);if(d==b.length){h=[];for(var m in e)if(e.hasOwnProperty(m)){k={masterMac:m,players:[]};var q=e[m],n;for(n in q)if(q.hasOwnProperty(n)){var p=a._findPlayerWithMac(n);
p&&-1==k.players.indexOf(p)&&k.players.push(p)}h.push(k)}c&&c(null,h)}},l=0;l<b.length;l++)b[l]._getZone(f);else this.searchSoundTouch(function(h,k){h?c&&c(h):k&&0!=k.length?a.getZones(c):c&&c(Error("find no sound touch player"))})};g.prototype.createZone=function(c,a){if(c&&0!=c.length){var b={},d=c[0],e=d.getMac();if(1<c.length)for(var f=0;f<c.length;f++){var l=c[f];b[l.getMac()]=l.getIP()}var h=this;d._setZone(e,b,function(k){k?a&&a(k):h.getZones(function(m){a&&a(m)})})}else a&&a()};g.prototype._getFoundSoundTouchs=
function(){var c=[],a;for(a in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(a)){var b=this._soundTouchs[a];b&&!b.dummy&&b.player&&c.push(b.player)}return c};g.prototype.getSoundTouch=function(c){if(!c.uuid)return null;if("master"==c.uuid)return this;var a=this._soundTouchs[c.uuid];if(a&&a.player)return a.player;a=new xnm.aio.bose.SoundTouch(c);this._soundTouchs[c.uuid]={missCount:0,dummy:!0,player:a};return a};g.prototype.executeCommandCreator=function(c,a,b){if(this._currentZone){var d=
this._findPlayerWithMac(this._currentZone);d?d.executeCommandCreator(c,a,b):b&&b(Error("current zone not found"))}else b&&b(Error("current zone not set"))};g.prototype.getStatesCreator=function(c,a,b){if(this._currentZone){var d=this._findPlayerWithMac(this._currentZone);d?d.getStatesCreator(c,a,b):b&&b(Error("current zone not found"))}else b&&b(Error("current zone not set"))};g.prototype.toJSON=function(){return{sys:"bose",ip:"xxxxxxx",port:0,uuid:"master",type:"master"}};return g}();
xnm.aio.bose.Discovery=function(){var g=function(a){a._setAVTransportURI=function(b,d,e,f){b="<InstanceID>"+b+"</InstanceID><CurrentURI>"+this._maskMetaData('<TrackInfo index="0" byteOffsetIntoTrack="0" timeOffsetIntoTrack="0" url="'+this._maskMetaData(d)+'" trackData="" sourceId="0" />')+"</CurrentURI><CurrentURIMetaData>"+(e?this._maskMetaData(e):"")+"</CurrentURIMetaData>";this._doSOAPBodyRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetAVTransportURI",b,f)};a._doSOAPBodyRequest=
function(b,d,e,f,l){f="<u:"+e+' xmlns:u="'+d+'">'+f+("</u:"+e+">");var h=this;this._doRequest(b,'"'+d+"#"+e+'"',f,function(k,m){k?l&&l(k):(k=h._parseSOAPResponse(m,e+"Response"))?l&&l(null,k):l&&l(Error(e+" reponse format invalid"))})};return a},c=function(){this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("xnm.aio.bose.Discovery"):{log:{}};this._upnpCB=null;this._searchCB=[];this._searching=!1};c.prototype.addListener=function(a){a&&-1==this._searchCB.indexOf(a)&&
this._searchCB.push(a)};c.prototype.removeListener=function(a){a&&(a=this._searchCB.indexOf(a),-1!=a&&this._searchCB.splice(a,1))};c.prototype.searchSoundTouch=function(){if(!this._searching){this._searching=!0;this._search();var a=this;setTimeout(function(){a._searching=!1},5E3)}};c.prototype._search=function(){if(!this._upnpCB){var a=this;this._upnpCB=function(d){a._findUpnpDevice(d)}}var b=require("x.upnp.js").getDiscoveryService();b.addCallback("upnp:rootdevice",this._upnpCB);b.discoverTarget("upnp:rootdevice")};
c.prototype._findUpnpDevice=function(a){if(a){var b=this;switch(a.deviceType){case "urn:schemas-upnp-org:device:MediaServer:1":this._logger.log("trace","find media server:"+a.name+" @"+a.ip);this._searchCB.forEach(function(e){e&&e("mediaServer",a)});break;case "urn:schemas-upnp-org:device:MediaRenderer:1":if(a.modelName&&-1!=a.modelName.indexOf("SoundTouch")){this._logger.log("trace","find SoundTouch:"+a.name+" @"+a.ip);a=g(a);var d=new xnm.aio.bose.SoundTouch;d._renderer=a;d.getInfos(function(e){e||
b._searchCB.forEach(function(f){f&&f("soundTouch",d)})})}}}};return c}();
xnm.aio.bose.DM=function(){var g={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"play/pause",ref:{value:"tooglePlay",value_t:"playPause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"toggle power",ref:{value:"togglePower"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",
ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"thumb up",ref:{value:"thumbUp"}},{type:"enum",name:"thumb down",ref:{value:"thumbDown"}},{type:"enum",name:"bookmark",ref:{value:"bookmark"}},{type:"enum",name:"preset",ref:{value:"preset",ext:"%e",extMeta:"123456".split("")}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},
{type:"enum",name:"toggle shuffle",ref:{value:"toggleShuffle"}},{type:"enum",name:"set repeat mode",ref:{value:"setRepeatMode",ext:"%e",extMeta:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"add to favorite",ref:{value:"addFav"}},{type:"enum",name:"remove from favorite",ref:{value:"removeFav"}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",
value_t:"volumeAudio",extMeta:"0-100"}},{type:"enum",name:"repeat mode",ref:{value:"repeatMode",options:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"shuffle mode",ref:{value:"shuffleMode",options:["SHUFFLE_ON","SHUFFLE_OFF"]}},{type:"string",name:"play state",ref:{value:"playState",options:["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"]}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"int",name:"track position (seconds)",
ref:{value:"positionS"}},{type:"string",name:"radio station",ref:{value:"radio"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]},c=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};c.prototype=Error();c.prototype.name="RaumfeldDMError";c.prototype.code=0;c.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"bose",getIPDeviceType:function(){return[{sys:this.SYS,
name:"Bose SoundTouch"}]},createDevice:function(a,b,d){b=c.ERROR_CODE;a?a.type?a.ip?a.port?a.uuid?d(null,a):d(new c(b.INVALID,"uuid is invalid")):d(new c(b.INVALID,"port is invalid")):d(new c(b.INVALID,"ip is invalid")):d(new c(b.INVALID,"type is invalid")):d(new c(b.INVALID,"info is invalid"))},updateDevice:function(a,b,d){b=c.ERROR_CODE;a?a.type?a.ip?a.port?a.uuid?d(null,a):d(new c(b.INVALID,"uuid is invalid")):d(new c(b.INVALID,"port is invalid")):d(new c(b.INVALID,"ip is invalid")):d(new c(b.INVALID,
"type is invalid")):d(new c(b.INVALID,"info is invalid"))},deleteDevice:function(a,b,d){d()},applyUIFilter:function(a,b,d){var e=function(m,q){if("*"==m)return!0;for(var n=!1,p=0;p<m.length;p++)if(m[p]==q){n=!0;break}return n},f=function(m,q,n){var p=[];switch(n.catagory){case "command":m.command&&m.command.forEach(function(r){e(n.elems,r.type)&&(r=JSON.parse(JSON.stringify(r)),p.push(r))});break;case "status":m.status&&m.status.forEach(function(r){e(n.elems,r.type)&&(r=JSON.parse(JSON.stringify(r)),
p.push(r))})}return p},l=function(m,q){var n=[],p=xnm.aio.bose.DM.getCommandStatusMap(m,d);p&&(m=f(p,m,q),n=n.concat(m));return n};if(!a.sys)return null;var h=JSON.parse(JSON.stringify(a)),k=null;switch(b.catagory){case "command":k=l(a,b);h.command=k;break;case "status":k=l(a,b);h.status=k;break;default:return null}return k&&0!=k.length?h:null},getCommandStatusMap:function(a,b){var d=JSON.parse(JSON.stringify(g));a&&a.bass&&(d.command.push({type:"enum",name:"bass up",ref:{value:"bassUp"}}),d.command.push({type:"enum",
name:"bass down",ref:{value:"bassDown"}}),d.command.push({type:"int",name:"set bass",ref:{value:"setBass",value_t:"bass",ext:"%d",extMeta:a.bass}}),d.status.push({type:"int",name:"bass",ref:{value:"bass",extMeta:a.bass}}));a&&a.sources&&a.sources.forEach(function(e){if(e&&"true"==e.isLocal){var f=e.source;e.name&&(f=e.name);var l=e.sourceAccount?e.sourceAccount:"";e.source&&d.command.push({type:"enum",name:"select "+f,ref:{value:"select:"+e.source+"@"+l}})}});return d},applySmartWidgetFilter:function(a,
b,d,e,f){d={"%next%":{value:"next"},"%pause%":{value:"pause"},"%play%":{value:"play"},"%previous%":{value:"previous"},"%shuffleToggle%":{value:"toggleShuffle"},"%stop%":{value:"stop"},"%toggleMute%":{value:"toggleMute"},"%volume%":{value:"setVolume",ext:"%d",extMeta:"0-100"}};var l={"%durationState%":{value:"durationS"},"%mutedState%":{value:"muted",options:["true","false"]},"%playState%":{value:"playState",options:["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"]},
"%positionState%":{value:"positionS"},"%shuffleState%":{value:"shuffleMode",options:["SHUFFLE_ON","SHUFFLE_OFF"]},"%volumeState%":{value:"volume",extMeta:"0-100"}};b.bass&&(d["%bass%"]={value:"setBass",value_t:"bass",ext:"%d",extMeta:device.bass},l["%bassState%"]={value:"bass",extMeta:device.bass});return a._injectToSmartWidgetTemplate(e,["media"],f,d,l,null)}}}();
xnm.aio.bose.Handler=function(){var g=function(){this.master=new xnm.aio.bose.Master};g.prototype.devicemanager=xnm.aio.bose.DM;g.prototype.SoundTouch=xnm.aio.bose.SoundTouch;g.prototype.registModule=function(c){c.register(xnm.aio.bose.DM.SYS,"bose")};g.prototype.resolveDevice=function(c){return c?this.master.getSoundTouch(c):null};g.prototype.getDeviceCommands=function(c,a){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];a&&a(null,c)};g.prototype.getDeviceStatus=
function(c,a){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];a&&a(null,c)};g.prototype.doCommand=function(c,a,b){var d=this.resolveDevice(c);d?d.executeCommandCreator(c,a,function(e){b&&b(e)}):b&&b(Error("device json format invalid"))};g.prototype.doStatus=function(c,a,b,d){var e=this.resolveDevice(a);e?e.getStatesCreator(null,[{id:c,device:a,status:b}],function(f,l){f?d&&d(f):d&&d(null,l[0])}):d&&d(Error("device json format invalid"))};g.prototype.discover=function(c){var a=
this;this.master.searchSoundTouch(function(b,d){!b&&d&&d.push(a.master);c&&c(b,d)})};g.prototype.getPlayer=function(c,a){if(c&&c.uuid)if("master"==c.uuid)a&&a(null,this.master);else{var b=this.master.getSoundTouch(c);if(b)a&&a(null,b);else{var d=this;this.master.searchSoundTouch(function(){b=d.master.getSoundTouch(c);a&&a(null,b)})}}else a&&a(Error("device json invalid"))};return g}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.bose.Handler);
