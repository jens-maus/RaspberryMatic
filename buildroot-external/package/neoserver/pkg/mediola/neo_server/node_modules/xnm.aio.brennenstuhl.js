var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.brennenstuhl=xnm.aio.brennenstuhl||{},xnm.aio.brennenstuhl.WebLine=function(e,n,t,s){this.ip=e,this.port=80,n&&(this.port=n),this.user="admin",t&&(this.user=t),this.password="admin",s&&(this.password=s),this.CommandHandler=null;},xnm.aio.brennenstuhl.WebLine.prototype._doRequest=function(e,n,t){var s={host:this.ip,port:this.port,path:e,method:"GET",headers:{Connection:"close"}};t&&(s.headers.Authorization=t);var i=this,o=require("http").request(s,function(s){if(200==s.statusCode){s.setEncoding("utf-8");var o="";s.on("data",function(e){o+=e;}),s.on("end",function(){n&&n(o);});}else if(401!=s.statusCode||t)n&&n(null);else if(t=null,s.headers["www-authenticate"]&&"Digest "==s.headers["www-authenticate"].substr(0,7)){for(var r={},a=s.headers["www-authenticate"].substr(7).replace(/\'/g,"").replace(/\"/g,"").split(","),d=0;d<a.length;d++){var u=a[d].split("=");2==u.length&&(r[u[0]]=u[1]);}if(r.nonce){t="Digest ",t+='username="'+i.user+'", ',t+='realm="'+r.realm+'", ',t+='nonce="'+r.nonce+'", ',t+='uri="'+e+'", ';var l=require("x.crypt.js"),c=l.MD5(i.user+":"+r.realm+":"+i.password),h=l.MD5("GET:"+e);t+='response="'+l.MD5(c+":"+r.nonce+":1::auth:"+h)+'", ',t+='opaque="'+r.opaque+'", ',t+="qop="+r.qop+", ",t+="nc=1, ",t+='cnonce=""';}t?i._doRequest(e,n,t):n&&n(null);}});o.setTimeout(5e3,function(){o.abort();}),o.on("error",function(e){n&&n(null);}),o.end();},xnm.aio.brennenstuhl.WebLine.prototype.executeCommand=function(e,n,t){if("toggle"==n)this._doRequest("/cgi-bin/toggleRel"+e.address+"?id=0",t);else if("on"==n||"off"==n){var s=this;this._doRequest("/power?id=1",function(i){var o=s.getStateValues(null,i);"on"==n&&"M"==e.address&&"off"==o.master||"on"==n&&"S"==e.address&&"off"==o.slave||"off"==n&&"M"==e.address&&"on"==o.master||"off"==n&&"S"==e.address&&"on"==o.slave?s._doRequest("/cgi-bin/toggleRel"+e.address+"?id=0",t):t&&t();});}else t&&t();},xnm.aio.brennenstuhl.WebLine.prototype.getStates=function(e,n,t){var s=this;this.CommandHandler=e,this._doRequest("/power?id=1",function(e){if(e&&s.CommandHandler)if(s.CommandHandler.setState){var n=s.getStateValues(null,e);for(var i in n)"state"==i?s.CommandHandler.setState(d.id,n[i]):s.CommandHandler.setState(d.id+":"+i,n[i]);}else s.CommandHandler.receivedState&&s.CommandHandler.receivedState("webline",s.ip,e);t&&t(s.getStateValues(null,e));});},xnm.aio.brennenstuhl.WebLine.prototype.getStateValues=function(e,n){var t={state:"?",master:"?",slave:"?"};if(n){var s=n.split("|");5==s.length&&(t.state="off","1"==s[3]?(t.master="on",t.state="on"):t.master="off","1"==s[4]?(t.slave="on",t.state="on"):t.slave="off");}return t;},xnm.aio.brennenstuhl.WebLine.Discovery=function(e){this.Devices={},this.callback=e,this._sockets=[];var n=require("os"),t=require("dgram");if(n&&n.networkInterfaces){var s=this,i=t.createSocket("udp4");i.on("listening",function(){i.setBroadcast(!0);var e=n.networkInterfaces();for(var t in e)for(var o=e[t],r=0;r<o.length;r++)"IPv4"==o[r].family&&0==o[r].internal&&s._addDiscoverSocket(i.address().port,o[r].address);s.discoverDevices();}),i.on("message",function(e,n){s._receivedData(n.address,e);}),i.bind(null);}else this._addDiscoverSocket(null),this.discoverDevices();},xnm.aio.brennenstuhl.WebLine.Discovery.prototype._getMAC=function(e){for(var n="",t=0;t<5;t++)n+=XC.getHexVal(e[t],2).toUpperCase()+"-";return n+XC.getHexVal(e[t],2).toUpperCase();},xnm.aio.brennenstuhl.WebLine.Discovery.prototype._receivedData=function(e,n){n=n.toString("hex"),94==(n=new Buffer(n,"hex")).length&&(this.Devices[e]=new xnm.aio.brennenstuhl.WebLine(e),this.Devices[e].uuid=this._getMAC(n.slice(19,25)),this.callback&&this.callback(this.Devices[e]));},xnm.aio.brennenstuhl.WebLine.Discovery.prototype._addDiscoverSocket=function(e,n){var t=require("dgram"),s=this,i=t.createSocket("udp4");i.on("listening",function(){i.setBroadcast(!0);}),i.on("message",function(e,n){s._receivedData(n.address,e);}),i.bind(e,n),this._sockets.push(i);},xnm.aio.brennenstuhl.WebLine.Discovery.prototype._sendDiscoveryMessages=function(e,n,t,s){e=new Buffer([255,4,2,251]);for(var i=0;i<this._sockets.length;i++)this._sockets[i].send(e,0,e.length,23,"255.255.255.255");},xnm.aio.brennenstuhl.WebLine.Discovery.prototype.discoverDevices=function(){this._sendDiscoveryMessages();},xnm.aio.brennenstuhl.Handler=function(){this._WebLineDiscovery=new xnm.aio.brennenstuhl.WebLine.Discovery(),this._WebLineDiscovery.discoverDevices();},xnm.aio.brennenstuhl.Handler.prototype.discoverDevices=function(e){e&&(this._WebLineDiscovery.callback=e),this._WebLineDiscovery.discoverDevices();},xnm.aio.brennenstuhl.Handler.prototype.getStateValues=function(e,n){return new xnm.aio.brennenstuhl.WebLine().getStateValues(n);},xnm.aio.brennenstuhl.Handler.prototype.getDeviceCommandList=function(e,n){var t=[];return t.push({id:window.XC_Text.on,cmd:"on"}),t.push({id:window.XC_Text.off,cmd:"off"}),t;},xnm.aio.brennenstuhl.Handler.prototype.getDevice=function(e){for(var n in this._WebLineDiscovery.Devices)if(e.address&&this._WebLineDiscovery.Devices[n].uuid==e.address)return this._WebLineDiscovery.Devices[n];return null;},xnm.aio.brennenstuhl.Handler.prototype.WebLine=xnm.aio.brennenstuhl.WebLine,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.brennenstuhl.Handler());