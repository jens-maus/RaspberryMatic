var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.cloud=xnm.aio.cloud||{};xnm.aio.cloud.Server=function(){this._url="http://webservice.aio-control.com/config?"};xnm.aio.cloud.Server.prototype._doRequest=function(b,c){$.ajax({url:this._url+b,timeout:4E3,cache:!1,success:function(a){var d=null;a&&8<=a.length&&"{XC_SUC}"==a.substr(0,8)?d=8<a.length?{data:$.parseJSON(a.substr(8))}:{data:{}}:a&&8<a.length&&"{XC_ERR}"==a.substr(0,8)&&(d={error:a.substr(8)});c&&c(d)},error:function(){c&&c(null)}})};
xnm.aio.cloud.Server.prototype.doRequest=function(b,c,a){b="XC_FNC="+b;if(c)for(var d in c)b+="&"+d+"="+c[d];this._doRequest(b,a)};xnm.aio.cloud.Server.prototype.getNewSID=function(b){this._doRequest("XC_FNC=getSID",b)};xnm.aio.cloud.Server.prototype.getEleroKey=function(b,c){this._doRequest("XC_FNC=getEleroKey&SID="+b,c)};
xnm.aio.cloud.Server.prototype.setMessage=function(b,c,a,d,e,f,g){a=JSON.stringify({email:a,message:d,username:g});b=this._url+"XC_FNC=setMessage&SID="+b+"&AID="+c;f&&(b+="&sns="+f);$.ajax({type:"POST",url:b,data:{data:a},timeout:4E3,cache:!1,complete:function(a){a&&(a=a.responseText);a&&8<=a.length&&"{XC_SUC}"==a.substr(0,8)?e(!0):e(!1)}})};xnm.aio.cloud.Server.prototype.getMessage=function(b,c,a){this._doRequest("XC_FNC=getMessage&SID="+b+"&AID="+c,a)};
xnm.aio.cloud.Server.prototype.assignBeckerSeiral=function(b,c){var a=c;$.ajax({url:this._url+"/beckerserial/assign?sid="+b.toUpperCase(),timeout:4E3,dataType:"text",cache:!0,success:function(d){try{var c=JSON.parse(d);if("no more available"==c.serial){var b=Error(c.serial);b.errCode=-1;a&&a(b)}else a&&a(null,c.serial)}catch(g){a&&a(g)}a=null},error:function(d,c){d="http request error:"+(d?d.status:"0")+"-"+c;a&&a(Error(d))}})};
xnm.aio.cloud.RemotesServer=function(){this.ip="https://remotes.mediola.com";this.port=443;this.password=this.user="";this.secure=!0;this.folder="";this._finishedDownloadCallback=this._error=this._remotes=null};
xnm.aio.cloud.RemotesServer.prototype._getUpdateFile=function(b){var c=this.secure?"https://":"http://";c+=this.ip+":"+this.port+"/creatorneo/remote/requestDownload";if(this.secure)this._getUpdateFileHttps(b);else{var a=b;$.ajax({type:"GET",url:c,timeout:8E3,cache:!1,dataType:"json",headers:{Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64")},success:function(d){a&&(a(null,d,200),a=null)},error:function(d,c,b){c="HTTP request error: "+(d?d.status:"0")+"-"+c;a&&(a(Error(c),
d?d.responseText:null,d?d.status:null),a=null)}})}};
xnm.aio.cloud.RemotesServer.prototype._getUpdateFileHttps=function(b){"object"===typeof process&&null!==process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var c=b;$.ajax({type:"GET",url:"https://"+this.ip+":"+this.port+"/creatorneo/remote/requestDownload",timeout:8E3,cache:!1,dataType:"json",headers:{"Content-Type":"application/json; charset=UTF8",Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64")},success:function(a){c&&(c(null,a,200),c=null)},error:function(a,
d,b){console.error(b,d,a.status,a.responseText);d="HTTPS request error: "+(a?a.status:"0")+"-"+d;c&&(c(Error(d),a?a.responseText:null,a?a.status:null),c=null)}})};xnm.aio.cloud.RemotesServer.prototype._moveFromTmp=function(b,c,a){var d=require("fs"),e=d.createReadStream(b);c=d.createWriteStream(c);e.pipe(c);e.on("error",function(c){XC.debugf(c.message);a&&a(c)});e.on("end",function(){d.unlinkSync(b);a&&a()})};
xnm.aio.cloud.RemotesServer.prototype._downloadFile=function(b,c,a,d){var e=require("http"),f=require("fs"),g={fileData:a,url:{username:this.user,password:this.password}},h=this,l=function(b,e){b&&f.existsSync(b)?(e=c.substring(0,c.lastIndexOf("/")),f.mkdirRecursiveSync(e),f.createReadStream&&f.createWriteStream?h._moveFromTmp(b,c,function(b){b?d(b):f.writeFile(c+".md5",a.md5,function(a){d(a)})}):(f.renameSync(b,c),d())):d(e?e:Error("file from mediola server error"))},m=window.XCHost&&window.XCHost.getType&&
("iOS"==window.XCHost.getType()||"Android"==window.XCHost.getType());if(this._aws3Client&&a&&a.file.match(/^resources.*/))b={Bucket:"mediola-creator",Key:"resources/"+a.ref},e=null,m||(e=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep+Math.random().toString(36).substring(2)),this._aws3Client.getObject2File(b,e,function(c,d){c?(XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] failed to download file from S3: "+a.file),XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] "+
c.message),l(null,Error("S3:"+c.message))):l(d)});else{var n=e.getFileAIOCloud;m&&(g={},b+="?username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password),n=e.getFileUriEncoded);n(b,g,l)}};
xnm.aio.cloud.RemotesServer.prototype._encryptFile=function(b,c){if("undefined"==typeof nw)c();else{var a=require("fs");a.readFile(b,"utf8",function(d,e){!d&&e?(d=require("m.aio.devicemanager.js"),e=require("x.crypt.js").AES.encodeString(e,d.ml_v1_info()),a.writeFile(b+".enc",e,function(d){d?(console.error(d),c&&c("crypt write file")):(a.unlinkSync(b),c&&c())})):c&&c("crypt read file")})}};
xnm.aio.cloud.RemotesServer.prototype._checkFile=function(b,c,a,d,e){for(var f=this._remotesPath+"_new/"+b+"/"+d.file,g=this.secure?"https://":"http://",h=d.ref.split("/"),l="",m=0;m<h.length;m++)l+=encodeURIComponent(h[m]),m<h.length-1&&(l+="/");g+=this.ip+":"+this.port+"/creatorneo/remote/downloadFile/"+l;var n=!1,k=require("fs"),q=this._remotesPath+"/"+b+"/"+d.file,p=this;b=d.file.indexOf(".DS_Store");-1<b&&b+9==d.file.length?e():k.readFile(q+".md5","utf8",function(b,h){!b&&h&&h==d.md5&&"device_db"!==
d.file&&(k.copyFileSync(q,f),k.copyFileSync(q+".md5",f+".md5"),n=!0);n?e():p._downloadFile(g,f,d,function(b){var g=!0;"device_db"==d.file&&c?(g=!1,k.readFile(f,"utf8",function(a,d){!a&&d?(a=require("x.crypt.js").AES.decodeString(d,c),k.writeFile(f,a,function(a){p._encryptFile(f,e)})):e("crypt")})):("device_db"==d.file&&a&&(g=!1,k.readFile(f,"utf8",function(a,c){if(!a&&c){var d=!1;require("xnm.aio.hm.js").discoverCCUs(function(a){if(!d){d=!0;var b=JSON.parse(c);if(b&&b.gateways)for(var g=0;g<b.gateways.length;g++){var h=
b.gateways[g];h.info&&"hm"==h.info.sys&&(h.info.uuid=a.uuid,h.info.ip=a.ip)}a=JSON.stringify(b);k.writeFile(f,a,function(a){k.existsSync(f+".md5")&&k.unlinkSync(f+".md5");p._encryptFile(f,e)})}});setTimeout(function(){d||e("noCCU")},1E3)}else e("file")})),"device_db"===d.file&&(g=!1,p._encryptFile(f,e)),g&&(b?e(Error("[File] "+b.message)):e()))})})};
xnm.aio.cloud.RemotesServer.prototype._downloadNextFile=function(b,c){"undefined"===typeof b&&(b=0);"undefined"===typeof c&&(c=0);0===b&&0===c&&(this._remoteNames=[]);0===this._remotes.length&&(this._remoteNames=null);if(b>=this._remotes.length)XC.debugf("[xnm.aio.cloud] downloaded all remotes"),setTimeout(function(){this._renameRemoteDir(this._remoteNames)}.bind(this),100);else{this._$progressDiv&&this._$progressDiv.text(Math.floor(this._filesDownloaded/this._filesToDownload*100)+"%");var a=this._remotes[b];
0===c&&(XC.debugf("[xnm.aio.cloud] download next remote: "+a.name),this._remoteNames.push(a.name));0<a.resources.length?(this._filesDownloaded++,this._checkFile(a.name,a.pwd,a.replaceCCU,a.resources[0],function(a){a?(XC.debugf("ERROR: "+a),this._error=a,this._remotes=[]):this._remotes[b].resources.splice(0,1);this._downloadNextFile(b,c+1)}.bind(this))):this._downloadNextFile(b+1,0)}};
xnm.aio.cloud.RemotesServer.prototype._renameRemoteDir=function(b){XC.debugf("[xnm.aio.cloud] rename remote dir ...");if(b){var c=require("fs"),a=this._remotesPath+"_"+(new Date).getTime();c.existsSync(this._remotesPath)&&c.renameSync(this._remotesPath,a);try{c.renameSync(this._remotesPath+"_new",this._remotesPath)}catch(d){XC.debugf(d.message),c.renameSync(a,this._remotesPath)}c.existsSync(a)&&c.rmdirRecursiveSync(a);b.sort(function(a,c){return a.localeCompare(c)})}XC.debugf("[xnm.aio.cloud] ... renamed remote dir.");
this._finishedDownloadCallback&&(XC.debugf("[xnm.aio.cloud] calling callback for finished download"),this._finishedDownloadCallback(b,this._error))};
xnm.aio.cloud.RemotesServer.prototype._checkPasswords=function(b,c){for(var a=0;a<this._remotes.length;a++)if(this._remotes[a].encrypt&&!this._remotes[a].pwd){var d=this;this._passwordCallback(this._remotes[a].name,function(c){null!=c?require("x.crypt.js").AES.decodeString(d._remotes[a].encrypt,c)==d._remotes[a].name&&(d._remotes[a].pwd=c):d._remotes.splice(a,1);d._checkPasswords()});return}for(a=this._filesToDownload=this._filesDownloaded=0;a<this._remotes.length;a++)this._filesToDownload+=this._remotes[a].resources.length;
this._downloadNextFile(0,0)};
xnm.aio.cloud.RemotesServer.prototype.updateRemotes=function(b,c,a){this._error=null;this._passwordCallback=a;this._$progressDiv=b;b=require("fs");this._remotesPath=b.dataPath()+"/remotes";try{b.mkdirRecursiveSync(this._remotesPath)}catch(d){XC.debugf('[xnm.aio.cloud] Failed to mkdir: "'+this._remotesPath+'". Error: '+d.message)}try{b.mkdirRecursiveSync(this._remotesPath+"_new")}catch(d){XC.debugf('[xnm.aio.cloud] Failed to mkdir: "'+this._remotesPath+'_new". Error: '+d.message)}this._getUpdateFile(function(a,
b,f){this._aws3Client=null;a?c&&c(null,Error("[File List] "+a.message),f):b&&"error"==b.classid?c&&c(null,b.code,f):b&&b.infos?(b.credential&&(a=require("x.aws"))&&(this._aws3Client=a.getS3Client(b.credential)),this._remotes=b.infos,this._finishedDownloadCallback=function(a,b){this._aws3Client&&this._aws3Client.release();c&&c(a,b)}.bind(this),this._checkPasswords()):c&&c(null,null,f)}.bind(this))};xnm.aio.cloud.Handler=function(){XC.debugf("xnm.aio.cloud.Handler created")};
xnm.aio.cloud.Handler.prototype.Server=xnm.aio.cloud.Server;xnm.aio.cloud.Handler.prototype.RemotesServer=xnm.aio.cloud.RemotesServer;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloud.Handler);
