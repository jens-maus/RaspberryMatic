var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.cloudTaskmanager=xnm.aio.cloudTaskmanager||{},xnm.aio.cloudTaskmanager.CloudTaskmanager=function(){},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.setCloudService=function(a){return this._cloudService=a,this;},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.setCloudAccessUrl=function(a){return this._cloudAccessUrl=a,this;},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.addVxCloudData=function(a,o){a.cloudTaskIds=[],a.root["if"]=a.root["if"].filter(function(a){return!a.cloud;}),a.root.then[0].then=a.root.then[0].then.filter(function(a){return!a.cloud;}),this._cloudService.getRules(function(e,t){if(XC.debugf(t),e)return o(e,t);var n=[],r=[];return xnm.aio.cloudTaskmanager.extractRules(t).forEach(function(o){xnm.aio.cloudTaskmanager.belongsToVxTask(o,a)&&(a.cloudTaskIds.push(o.ruleId),n=n.concat(xnm.aio.cloudTaskmanager.mapCloudTriggersToPro(o)),r=r.concat(xnm.aio.cloudTaskmanager.mapCloudActionsToPro(o)));}),a.root["if"]=a.root["if"].concat(n),a.root.then[0].then=a.root.then[0].then.concat(r),o(e,a);});},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.addVxProCloudData=function(a,o){a.cloudTaskIds=[],a.root["if"]=a.root["if"].filter(function(a){return!(a.cloud||a.gateway&&"cloudservice"===a.gateway.sys);}),a.root.then[0].then=a.root.then[0].then.filter(function(a){return!a.cloud;}),this._cloudService.getRules(function(e,t){if(XC.debugf(t),e)return o(e,t);var n=[],r=[];return xnm.aio.cloudTaskmanager.extractRules(t).forEach(function(o){var e=!1;o.action&&(e=o.action.some(function(o){return o.data&&o.data.data&&o.data.data.id==a.id&&o.data.token===a.aio._token;})),e&&(a.cloudTaskIds.push(o.ruleId),n=n.concat(xnm.aio.cloudTaskmanager.mapCloudTriggersToPro(o)),r=r.concat(xnm.aio.cloudTaskmanager.mapCloudActionsToPro(o)));}),a.root["if"]=a.root["if"].concat(n),a.root.then[0].then=a.root.then[0].then.concat(r),o(e,a);});},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.saveVxCloudData=function(a,o,e,t){var _this=this;o=xnm.aio.cloudTaskmanager.mapProTriggersToCloud(o),e=xnm.aio.cloudTaskmanager.mapProActionsToCloud(e),(o[void 0]||e[void 0])&&a.cloudTaskIds.push(void 0),this._runSaving(a,function(t){var n=_this._getRule(a,o[t],e[t]),r=n.action.some(function(a){return"mediola"!==a.sys;}),i=n.trigger.some(function(a){return a.event&&"mediola"===a.event.sys;}),d=n.trigger.some(function(a){return!a.event||"mediola"!==a.event.sys;}),u=n.action.some(function(a){return"mediola"===a.sys;});return r&&!i&&n.trigger.push(_this._getAioTrigger(a)),d&&!u&&n.action.push(_this._getAioAction(a,"doGroup")),n;},t);},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.saveVxProCloudData=function(a,o,e){var _this2=this;(o=xnm.aio.cloudTaskmanager.mapProTriggersToCloud(o))[void 0]&&a.cloudTaskIds.push(void 0),this._runSaving(a,function(e){var t=_this2._getRule(a,o[e]),n=t.trigger.some(function(a){return!a.event||"mediola"!==a.event.sys;}),r=t.action.some(function(a){return"mediola"===a.sys;});return n&&!r&&t.action.push(_this2._getAioAction(a,"DoTask")),t;},e);},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._runSaving=function(a,o,e){var _this3=this;var t=a.cloudTaskIds.map(function(a){var e=o(a);return _this3._getUpdateCall(a,e);});new xnm.aio.cloudTaskmanager.FunctionStack(t).start(e);},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getUpdateCall=function(a,o){var _this4=this;return function(e){return a?o.trigger.length||o.action.length?_this4._cloudService.updateRule(a,o,e):_this4._cloudService.deleteRule(a,e):_this4._cloudService.addRule(o,e);};},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getRule=function(a,o,e){return{name:"cloud "+a.id,app:"iqontrolneo",owner:a.aio._sid,trigger:o||[],action:e||[]};},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getAioTrigger=function(a){return{event:{sys:"mediola",data:{data:a._localCloudId,type:"ACTION",sid:a.aio._sid}}};},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getAioAction=function(a,o){return{sys:"mediola",data:{ccs:this._cloudAccessUrl+":443",cmd:"cmd",data:{id:a.id.toString(),XC_FNC:o},token:a.aio._token}};},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.deleteVxCloudData=function(a,o){this._runDeletion(a,xnm.aio.cloudTaskmanager.belongsToVxTask,o);},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.deleteVxProCloudData=function(a,o){this._runDeletion(a,xnm.aio.cloudTaskmanager.belongsToProTask,o);},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._runDeletion=function(a,o,e){var _this5=this;this._cloudService.getRules(function(t,n){if(t)return e(t,n);var r=xnm.aio.cloudTaskmanager.extractRules(n).filter(function(e){return o(e,a);}).map(function(a){return function(o){return _this5._cloudService.deleteRule(a.ruleId,o);};});new xnm.aio.cloudTaskmanager.FunctionStack(r).start(e);});},xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.clearCloudData=function(a){this._cloudService.deleteRules({},a);},xnm.aio.cloudTaskmanager.belongsToVxTask=function(a,o){var e=a.action&&a.action.find(function(a){return"mediola"===a.sys&&a.data&&a.data.data;});if(e&&e.data.data.id==o.id&&e.data.token===o.aio._token)return!0;var t=o.root.then[0].then.find(function(a){return"CLOUD"===a.type;});if(!t)return!1;var n=a.trigger&&a.trigger.find(function(a){return a.event&&"mediola"===a.event.sys&&a.event.data;});return n&&n.event.data.data==t.id&&n.event.data.sid===o.aio._sid;},xnm.aio.cloudTaskmanager.belongsToProTask=function(a,o){var e=a.action&&a.action.find(function(a){return"mediola"===a.sys&&a.data&&a.data.data;});return e&&e.data.data.id==o.id&&e.data.token===o.aio._token;},xnm.aio.cloudTaskmanager.mapCloudTriggersToPro=function(a){return a.trigger.map(function(o){if(o.event&&"mediola"===o.event.sys)return o.internal=!0,null;var e=o.event;return{cloud:!0,sys:e.sys,ruleId:a.ruleId,op:e.comp.operator,value:e.comp.value,type:"device.status",status:e.data.state,device:{id:e.data.id,connection:e.data.connection}};}).filter(function(a){return null!==a;});},xnm.aio.cloudTaskmanager.mapCloudActionsToPro=function(a){return a.action.map(function(o){return"mediola"===o.sys?(o.internal=!0,null):{cloud:!0,sys:o.sys,ruleId:a.ruleId,type:"action",subtype:"command",command:{ref:{value:o.data.command,ext:o.data.value}},device:{id:o.data.device,connection:o.data.connection}};}).filter(function(a){return null!==a;});},xnm.aio.cloudTaskmanager.mapProTriggersToCloud=function(a){return a.map(function(a){return{ruleId:a.ruleId||void 0,event:{sys:a.device.module,data:{id:a.device.id,state:a.status,connection:a.device.connection},comp:{operator:a.op,value:a.value}}};}).reduce(this.aggregateByRule,{});},xnm.aio.cloudTaskmanager.mapProActionsToCloud=function(a){return a.map(function(a){return{ruleId:a.ruleId||void 0,sys:a.sys,data:{device:a.device.id,command:a.command.ref.value,value:a.command.ref.ext}};}).reduce(this.aggregateByRule,{});},xnm.aio.cloudTaskmanager.aggregateByRule=function(a,o){return a[o.ruleId]||(a[o.ruleId]=[]),a[o.ruleId].push(o),delete o.ruleId,a;},xnm.aio.cloudTaskmanager.extractRules=function(a){return Object.keys(a).map(function(o){var e=a[o];return e.ruleId=o,e;});},xnm.aio.cloudTaskmanager.FunctionStack=function(a){this._stack=a,this._onNext=function(a,o){if(a)this._callback(a);else{var e=this._stack.shift();e?e(this._onNext.bind(this)):this._callback(a,o);}},this.start=function(a){this._callback=a,this._onNext();};},xnm.aio.cloudTaskmanager.Handler=xnm.aio.cloudTaskmanager.CloudTaskmanager,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloudTaskmanager.Handler());