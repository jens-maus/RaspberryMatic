var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.cloudTaskmanager=xnm.aio.cloudTaskmanager||{};xnm.aio.cloudTaskmanager.CloudTaskmanager=function(){};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.setCloudService=function(a){this._cloudService=a;return this};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.setCloudAccessUrl=function(a){this._cloudAccessUrl=a;return this};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.addVxCloudData=function(a,b){a.cloudTaskIds=[];a.root.if=a.root.if.filter(function(a){return!a.cloud});a.root.then[0].then=a.root.then[0].then.filter(function(a){return!a.cloud});this._cloudService.getRules(function(c,d){XC.debugf(d);if(c)return b(c,d);var e=[],f=[];xnm.aio.cloudTaskmanager.extractRules(d).forEach(function(b){xnm.aio.cloudTaskmanager.belongsToVxTask(b,a)&&(a.cloudTaskIds.push(b.ruleId),e=e.concat(xnm.aio.cloudTaskmanager.mapCloudTriggersToPro(b)),
f=f.concat(xnm.aio.cloudTaskmanager.mapCloudActionsToPro(b)))});a.root.if=a.root.if.concat(e);a.root.then[0].then=a.root.then[0].then.concat(f);return b(c,a)})};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.addVxProCloudData=function(a,b){a.cloudTaskIds=[];a.root.if=a.root.if.filter(function(a){return!a.cloud});a.root.then[0].then=a.root.then[0].then.filter(function(a){return!a.cloud});this._cloudService.getRules(function(c,d){XC.debugf(d);if(c)return b(c,d);var e=[],f=[];xnm.aio.cloudTaskmanager.extractRules(d).forEach(function(b){var c=!1;b.action&&(c=b.action.some(function(b){return b.data&&b.data.data&&b.data.data.id==a.id&&b.data.token===a.aio._token}));
c&&(a.cloudTaskIds.push(b.ruleId),e=e.concat(xnm.aio.cloudTaskmanager.mapCloudTriggersToPro(b)),f=f.concat(xnm.aio.cloudTaskmanager.mapCloudActionsToPro(b)))});a.root.if=a.root.if.concat(e);a.root.then[0].then=a.root.then[0].then.concat(f);return b(c,a)})};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.saveVxCloudData=function(a,b,c,d){var e=this;b=xnm.aio.cloudTaskmanager.mapProTriggersToCloud(b);c=xnm.aio.cloudTaskmanager.mapProActionsToCloud(c);(b[void 0]||c[void 0])&&a.cloudTaskIds.push(void 0);this._runSaving(a,function(d){d=e._getRule(a,b[d],c[d]);var f=d.action.some(function(a){return"mediola"!==a.sys}),h=d.trigger.some(function(a){return a.event&&"mediola"===a.event.sys}),k=d.trigger.some(function(a){return!a.event||"mediola"!==a.event.sys}),
l=d.action.some(function(a){return"mediola"===a.sys});f&&!h&&d.trigger.push(e._getAioTrigger(a));k&&!l&&d.action.push(e._getAioAction(a,"doGroup"));return d},d)};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.saveVxProCloudData=function(a,b,c){var d=this;b=xnm.aio.cloudTaskmanager.mapProTriggersToCloud(b);b[void 0]&&a.cloudTaskIds.push(void 0);this._runSaving(a,function(c){c=d._getRule(a,b[c]);var e=c.trigger.some(function(a){return!a.event||"mediola"!==a.event.sys}),g=c.action.some(function(a){return"mediola"===a.sys});e&&!g&&c.action.push(d._getAioAction(a,"DoTask"));return c},c)};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._runSaving=function(a,b,c){var d=this;a=a.cloudTaskIds.map(function(a){var c=b(a);return d._getUpdateCall(a,c)});(new xnm.aio.cloudTaskmanager.FunctionStack(a)).start(c)};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getUpdateCall=function(a,b){var c=this;return function(d){return a?b.trigger.length||b.action.length?c._cloudService.updateRule(a,b,d):c._cloudService.deleteRule(a,d):c._cloudService.addRule(b,d)}};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getRule=function(a,b,c){return{name:"cloud "+a.id,app:"iqontrolneo",owner:a.aio._sid,trigger:b||[],action:c||[]}};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getAioTrigger=function(a){return{event:{sys:"mediola",data:{data:a._localCloudId,type:"ACTION",sid:a.aio._sid}}}};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._getAioAction=function(a,b){return{sys:"mediola",data:{ccs:this._cloudAccessUrl+":443",cmd:"cmd",data:{id:a.id.toString(),XC_FNC:b},token:a.aio._token}}};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.deleteVxCloudData=function(a,b){this._runDeletion(a,xnm.aio.cloudTaskmanager.belongsToVxTask,b)};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.deleteVxProCloudData=function(a,b){this._runDeletion(a,xnm.aio.cloudTaskmanager.belongsToProTask,b)};xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype._runDeletion=function(a,b,c){var d=this;this._cloudService.getRules(function(e,f){if(e)return c(e,f);e=xnm.aio.cloudTaskmanager.extractRules(f).filter(function(c){return b(c,a)}).map(function(a){return function(b){return d._cloudService.deleteRule(a.ruleId,b)}});(new xnm.aio.cloudTaskmanager.FunctionStack(e)).start(c)})};
xnm.aio.cloudTaskmanager.CloudTaskmanager.prototype.clearCloudData=function(a){this._cloudService.deleteRules({},a)};
xnm.aio.cloudTaskmanager.belongsToVxTask=function(a,b){var c=a.action&&a.action.find(function(a){return"mediola"===a.sys&&a.data&&a.data.data});if(c&&c.data.data.id==b.id&&c.data.token===b.aio._token)return!0;c=b.root.then[0].then.find(function(a){return"CLOUD"===a.type});return c?(a=a.trigger&&a.trigger.find(function(a){return a.event&&"mediola"===a.event.sys&&a.event.data}))&&a.event.data.data==c.id&&a.event.data.sid===b.aio._sid:!1};
xnm.aio.cloudTaskmanager.belongsToProTask=function(a,b){return(a=a.action&&a.action.find(function(a){return"mediola"===a.sys&&a.data&&a.data.data}))&&a.data.data.id==b.id&&a.data.token===b.aio._token};
xnm.aio.cloudTaskmanager.mapCloudTriggersToPro=function(a){return a.trigger.map(function(b){if(b.event&&"mediola"===b.event.sys)return b.internal=!0,null;b=b.event;return{cloud:!0,sys:b.sys,ruleId:a.ruleId,op:b.comp.operator,value:b.comp.value,type:"device.status",status:b.data.state,device:{id:b.data.id,connection:b.data.connection}}}).filter(function(a){return null!==a})};
xnm.aio.cloudTaskmanager.mapCloudActionsToPro=function(a){return a.action.map(function(b){return"mediola"===b.sys?(b.internal=!0,null):{cloud:!0,sys:b.sys,ruleId:a.ruleId,type:"action",subtype:"command",command:{ref:{value:b.data.command,ext:b.data.value}},device:{id:b.data.device,connection:b.data.connection}}}).filter(function(a){return null!==a})};
xnm.aio.cloudTaskmanager.mapProTriggersToCloud=function(a){return a.map(function(a){return{ruleId:a.ruleId||void 0,event:{sys:a.device.module,data:{id:a.device.id,state:a.status,connection:a.device.connection},comp:{operator:a.op,value:a.value}}}}).reduce(this.aggregateByRule,{})};
xnm.aio.cloudTaskmanager.mapProActionsToCloud=function(a){return a.map(function(a){return{ruleId:a.ruleId||void 0,sys:a.sys,data:{device:a.device.id,command:a.command.ref.value,value:a.command.ref.ext}}}).reduce(this.aggregateByRule,{})};xnm.aio.cloudTaskmanager.aggregateByRule=function(a,b){a[b.ruleId]||(a[b.ruleId]=[]);a[b.ruleId].push(b);delete b.ruleId;return a};xnm.aio.cloudTaskmanager.extractRules=function(a){return Object.keys(a).map(function(b){var c=a[b];c.ruleId=b;return c})};
xnm.aio.cloudTaskmanager.FunctionStack=function(a){this._stack=a;this._onNext=function(a,c){if(a)this._callback(a);else{var b=this._stack.shift();b?b(this._onNext.bind(this)):this._callback(a,c)}};this.start=function(a){this._callback=a;this._onNext()}};xnm.aio.cloudTaskmanager.Handler=xnm.aio.cloudTaskmanager.CloudTaskmanager;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloudTaskmanager.Handler);
