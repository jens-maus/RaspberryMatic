var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.contronics=xnm.aio.contronics||{};xnm.aio.contronics.ExecEngine=function(a,b,c,d){var e=require("x.logger.js");this._logger=e?e.getLogger("xnm.aio.contronics.ExecEngine"):{log:function(){}};this.ip=a;this.port=b;if(!this.port||0>this.port)this.port=2110;this.user=c;this.password=d;this._sessionID=-1;this._statusBuffer=this._sessionTimeout=null};
xnm.aio.contronics.ExecEngine.prototype._doRequeset=function(a,b){if(a&&"string"==typeof a){this._logger.log("trace","do request:"+a);var c={host:this.ip,port:this.port,path:"/RPC2",method:"POST",headers:{"Content-Type":"text/xml","Content-length":a.length,"User-Agent":"mediola",Connection:"keep-alive"}},d=b,e=this,f=require("http").request(c,function(a){a.setEncoding("utf-8");var b=a.statusCode,c="";a.on("data",function(a){c+=a});a.on("end",function(){e._logger.log("trace","response status code:"+
b);e._logger.log("trace","response data:"+c);200==b?d&&(d(null,c),d=null):d&&(d(Error("http request error:"+b),c),d=null)})});f.setTimeout(3E4,function(){e._logger.log("warn","http request timeout");f.abort()});f.on("error",function(a){e._logger.log("warn","http request error:"+a.message);d&&(d(a),d=null)});a&&f.write(a);f.end()}else b&&b(Error("data invalid"))};
xnm.aio.contronics.ExecEngine.prototype._doXmlRpcReq=function(a,b,c){var d=require("x.xmlrpc.js"),e=this;try{var f=d.serializeReq(a,b);this._doRequeset(f,function(a,b){if(a)xnm.aio.contronics.SessionBuffer.sessionHttpError(e.ip),c&&c(a);else{xnm.aio.contronics.SessionBuffer.sessionHttpOK(e.ip);try{var f=d.deserializeRsp(b);f.error?c&&c(Error("xmlrpc fault "+f.error.faultCode+":"+f.error.faultString)):f.params&&f.params[0]?c&&c(null,f.params[0]):c&&c(Error("xmlrpc response error"))}catch(n){c&&c(n)}}})}catch(g){c&&
c(g)}};
xnm.aio.contronics.ExecEngine.prototype._execReq=function(a,b){this._logger.log("trace","execute requeset param:"+JSON.stringify(a));var c=this;this._doXmlRpcReq("appreq",a,function(d,e){d?b&&b(d):(c._logger.log("trace","get response param:"+JSON.stringify(e)+" for req:"+JSON.stringify(a)),e&&null!=e[0]&&"undefined"!=typeof e[0]?"*ERROR"==e[0]?(d=Error("ExecEngine api error"),d._errorCode=1,b&&b(d)):"*ERROR ID"==e[0]?(d=Error("ExecEngine invalid session id"),d._errorCode=2,b&&b(d)):b&&b(null,e[0]):
b&&b(Error("ExecEngine response format invalid")))})};xnm.aio.contronics.ExecEngine.prototype._doExecReq=function(a,b){var c=this;this._execReq(a,function(d,e){d?2==d._errorCode?(c._logger.log("trace","session invalid"),xnm.aio.contronics.SessionBuffer.removeSession(c.ip),c.signon(function(d,e){d?b&&b(d):(a[0]=e,31==a[1]&&(a[1]=24),c._doExecReq(a,b))})):b&&b(d):b&&b(null,e)})};
xnm.aio.contronics.ExecEngine.prototype._signon=function(a){this._logger.log("debug","signon");var b=[0,1];if(this.user&&null!=this.password&&"undefined"!=typeof this.password){var c=this._encodeCred(this.user,this.password);b.push(c)}var d=this;this._doExecReq(b,function(b,c){if(c){var f=parseInt(c);d._logger.log("debug","signon:"+f);0>=f&&!b&&(b=Error("can not acquire session id"),b._errorCode=3)}else b||(d._logger.log("debug","signon return invalid response"),b=Error("invalid response"));a&&a(b,
b?null:f)})};xnm.aio.contronics.ExecEngine.prototype._signoff=function(a,b){this._logger.log("debug","signoff:"+a);this._doExecReq([a,2],function(a,d){b&&b(a,d)})};
xnm.aio.contronics.ExecEngine.prototype._getDeviceList=function(a,b){var c=this;this._logger.log("debug","getDeviceList:"+a);this._doExecReq([a,8],function(d,e){if(d)b&&b(d);else if(e){var f=[];e.split("%06").forEach(function(a){if(a&&(a=a.split("%07"),5<=a.length)){for(var b={name:a[0],systemLabel:a[1],moduleLabel:a[2],moduleID:a[3],objects:[]},c=4;c<a.length;c++)if(a[c]){var d=a[c].split("%08");10==d.length&&(4!=c||b.name||(b.name=d[0]),b.objects.push({name:d[0],label:d[1],group:d[2],art:d[3],type:d[4],
min:d[5],max:d[6],valueInfo:d[7],ioInfo:d[8],deviceCode:d[9]}))}f.push(b)}});c._logger.log("debug","finish getDeviceList:"+a);b&&b(null,f)}else b&&b(null,[])})};xnm.aio.contronics.ExecEngine.prototype._getDeviceGroup=function(a,b){this._doExecReq([a,9],function(a,d){a?b&&b(a):b&&b(null,d)})};
xnm.aio.contronics.ExecEngine.prototype._getAllDeviceValue=function(a,b){this._logger.log("debug","getAllDeviceValue:"+a);var c=require("x.xmlrpc.js");this._doExecReq([a,24],function(a,e){if(a)b&&b(a);else if(e){a={};e=e.split("%06");for(var d=0;d<e.length;d++)if(e[d]){var g=e[d].indexOf("=");if(!(0>=g)){var h=e[d].substr(0,g);g=e[d].substr(g+1);h&&(a[h]=c._unescapeXml(g))}}b&&b(null,a)}else b&&b(null,{})})};
xnm.aio.contronics.ExecEngine.prototype._getIncDeviceValue=function(a,b){this._logger.log("debug","getIncDeviceValue:"+a);var c=require("x.xmlrpc.js");this._doExecReq([a,31],function(a,e){if(a)b&&b(a);else if(e){a={};e=e.split("%06");for(var d=0;d<e.length;d++)if(e[d]){var g=e[d].indexOf("=");if(!(0>=g)){var h=e[d].substr(0,g);g=e[d].substr(g+1);h&&(a[h]=c._unescapeXml(g))}}b&&b(null,a)}else b&&b(null,{})})};
xnm.aio.contronics.ExecEngine.prototype._changeValue=function(a,b,c,d){this._logger.log("debug","_changeValue:"+a);this._doExecReq([a,64,b+(null==c||"undefiend"==typeof c?"":"="+c)],function(a,b){d&&d(a,b)})};
xnm.aio.contronics.ExecEngine.prototype._encodeCred=function(a,b){var c=function(a){for(var b=[],d=0;d<a.length;d++)b.push(a.charCodeAt(d));return b};a=c(a);a.push(127);b=c(b);a=a.concat(b);return function(a){for(var b=a[a.length-1]<<1,c=[],d=1;5>d;d++)c.push(Math.floor(220*Math.random())+32);a=c.concat(a);if(b){c=[];for(d=a.length-1;0<=d;d--)c.push(a[d]);a=c;c=[];for(var h,l=0;l<a.length;l++)d=a[l],h=d^b,31<d&&31<h?c.push(h):c.push(d);a=c}a[a.length-2]=b;b=a;a=b.length;c="";for(h=0;h<a;h++)d=b[h],
c=64>d?c+"1"+String.fromCharCode(d+64):191<d?c+"2"+String.fromCharCode(d-128):127<d?c+"3"+String.fromCharCode(d-64):c+String.fromCharCode(d);return c}(a)};xnm.aio.contronics.ExecEngine.prototype.signon=function(a){var b=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);if(b)a&&a(null,b);else{var c=this;this._signon(function(b,e){!b&&e&&xnm.aio.contronics.SessionBuffer.addSession(c.ip,e,c);a&&a(b,b?null:e)})}};
xnm.aio.contronics.ExecEngine.prototype.signoff=function(a){var b=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);b?(xnm.aio.contronics.SessionBuffer.removeSession(this.ip),this._signoff(b,function(b){a&&a(b)})):a&&a()};xnm.aio.contronics.ExecEngine.prototype.getDeviceList=function(a){var b=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);if(b)xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._getDeviceList(b,a);else{var c=this;this.signon(function(b){b?a&&a(b):c.getDeviceList(a)})}};
xnm.aio.contronics.ExecEngine.prototype._executeCommand=function(a,b,c){var d=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);if(d)xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._changeValue(d,a,b,function(a){c&&c(a)});else{var e=this;this.signon(function(d){d?c&&c(d):e._executeCommand(a,b,c)})}};
xnm.aio.contronics.ExecEngine.prototype._getStates=function(a){var b=function(a){return a?6500<(new Date).getTime()-a.getTime():!0},c=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip),d=xnm.aio.contronics.SessionBuffer.getStates(this.ip),e=xnm.aio.contronics.SessionBuffer.getStatesTimestamp(this.ip),f=this;c?!d||b(e)?(xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._getAllDeviceValue(c,function(b,c){b?a&&a(b):(xnm.aio.contronics.SessionBuffer.setStates(f.ip,c),a&&a(null,c))})):
(xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._getIncDeviceValue(c,function(b,c){b?a&&a(b):(xnm.aio.contronics.SessionBuffer.addStates(f.ip,c),a&&a(null,xnm.aio.contronics.SessionBuffer.getStates(f.ip)))})):this.signon(function(b){b?a&&a(b):f._getStates(a)})};
xnm.aio.contronics.ExecEngine.prototype.executeCommandCreator=function(a,b,c){if(a&&a.name&&a.art&&"string"==typeof a.art&&b)if(null==b.value||"undefiend"==typeof b.value)c&&c(Error("comamnd value invalid"));else{var d=a.name;switch(a.art.toLowerCase()){case "u":var e=-1;if(a.valueInfo){a=a.valueInfo.split(";");for(var f=0;f<a.length;f++)if(a[f]==b.value){e=f;break}}b=-1==e?b.value:e;break;case "n":if(null==b.ext||"undefiend"==typeof b.ext){c&&c(Error("comamnd ext invalid"));return}b=b.ext;break;
case "s":if(null==b.ext||"undefiend"==typeof b.ext){c&&c(Error("comamnd ext invalid"));return}b=b.ext;break;case "m":b=null;break;default:c&&c(Error("device art do not supported"));return}this._executeCommand(d,b,c)}else c&&c(Error("execute comamnd argument invalid"))};
xnm.aio.contronics.ExecEngine.prototype.getStatesCreator=function(a,b,c){b?this._getStates(function(a,e){if(a)c&&c(a);else{a=[];for(var d=0;d<b.length;d++)if(b[d].id&&b[d].device&&b[d].status){var g=b[d].device.name,h=b[d].device.art,l=b[d].device.valueInfo;g&&(g=e[g],null!=g&&"undefined"!=typeof g&&("N"==h?"0"==l?a.push({id:b[d].id,status:parseInt(g)}):a.push({id:b[d].id,status:parseFloat(g)}):"U"==h&&l?(h=l.split(";"),l=parseInt(g),h[l]?a.push({id:b[d].id,status:h[l]}):a.push({id:b[d].id,status:g})):
a.push({id:b[d].id,status:g})))}c&&c(null,a)}}):c&&c(Error("deviceList is null"))};xnm.aio.contronics.ExecEngine.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.contronics.ExecEngine?this.ip==a.ip&&this.port==a.port&&this.user==a.user&&this.password==a.password:!1};xnm.aio.contronics.DMError=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};xnm.aio.contronics.DMError.prototype=Error();xnm.aio.contronics.DMError.prototype.name="ContronicsDMError";
xnm.aio.contronics.DMError.prototype.code=0;xnm.aio.contronics.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.contronics.DM={SYS:"execengine",getGatewayType:function(){return[{sys:this.SYS,name:"Contronics ExecEngine",port:2110}]},createGateway:function(a,b,c){b=xnm.aio.contronics.DMError;var d=xnm.aio.contronics.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new b(d.INVALID,"ip is invalid")):c(new b(d.INVALID,"info is invalid"))},updateGateway:function(a,b,c,d){a=xnm.aio.contronics.DMError;c=xnm.aio.contronics.DMError.ERROR_CODE;b?b.ip?d(null,b):d(new a(c.INVALID,"ip is invalid")):d(new a(c.INVALID,"update is invalid"))},
deleteGateway:function(a,b,c){c()},createDevice:function(a,b,c){var d=xnm.aio.contronics.DMError,e=xnm.aio.contronics.DMError.ERROR_CODE;if(a)if(null==a.art||"undefined"==typeof a.art)c(new d(e.INVALID,"art is invalid"));else if(a.name)if(a.gateway)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?c(null,a):c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(e.NOT_FOUND,
"gateway with index "+a.gateway+" not exists"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"name is invalid"));else c(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var d=xnm.aio.contronics.DMError,e=xnm.aio.contronics.DMError.ERROR_CODE;if(a)if(null==a.art||"undefined"==typeof a.art)c(new d(e.INVALID,"address is invalid"));else if(a.name)if(a.gateway){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?c(null,a):
c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"catagory is invalid"));else c(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},d=function(a,b,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),
e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=[];if(!a.art||"string"!=typeof a.art)return null;var e=!0,f=!0;if(a.ioInfo)switch(parseInt(a.ioInfo)){case 1:f=!1;break;case 2:e=!1}var g;switch(a.art.toLowerCase()){case "u":var h={};var k;a.valueInfo&&(k=a.valueInfo.split(";"));if(f&&k)for(h.command=[],g=0;g<k.length;g++)k[g]&&h.command.push({type:"enum",name:k[g],ref:{value:k[g]}});
if(e){h.status=[];f={type:"enum",name:"status",ref:{value:"status"}};if(k)for(f.ref.options=[],g=0;g<k.length;g++)k[g]&&f.ref.options.push(k[g]);h.status.push(f)}break;case "n":k=0;a.valueInfo&&0<parseInt(a.valueInfo)&&(k=a.valueInfo);var l=h=null,m;null!=a.min&&"undefined"!=typeof a.min&&(h=k?parseFloat(a.min):parseInt(a.min));null!=a.max&&"undefined"!=typeof a.max&&(l=k?parseFloat(a.max):parseInt(a.max));null==h||null==l||isNaN(h)||isNaN(l)||(g=""+h+"-"+l);k&&(m=""+1/Math.pow(10,k));h={};f&&(f=
{type:k?"float":"int",name:"set value",ref:{value:"set value",ext:k?"%f":"%d"}},g&&(f.ref.extMeta=g),m&&(f.ref.scale=m),h.command=[f]);e&&(f={type:k?"float":"int",name:"state",ref:{value:"state"}},g&&(f.ref.extMeta=g),m&&(f.ref.scale=m),h.status=[f]);break;case "s":h={};f&&(f={type:"string",name:"set value",ref:{value:"set value",ext:"%s"}},h.command=[f]);e&&(f={type:"string",name:"state",ref:{value:"state"}},h.status=[f]);break;case "m":h={},f&&(f={type:"enum",name:"execute",ref:{value:"execute"}},
h.command=[f])}h&&(f=d(h,a,b),c=c.concat(f));return c};if(!a.art)return null;var f=JSON.parse(JSON.stringify(a)),g=null;switch(b.catagory){case "command":g=e(a,b);f.command=g;break;case "status":g=e(a,b);f.status=g;break;default:return null}return g&&0!=g.length?f:null}};
xnm.aio.contronics.SessionBuffer={MAX_HTTP_ERROR_COUNT:5,_sessionBuffer:{},_statesBuffer:{},addSession:function(a,b,c){this._sessionBuffer[a]&&this.removeSession(a);var d=this._createSessionTimeout(c);this._sessionBuffer[a]={sessionID:b,engine:c,timeout:d,httpError:0}},getSessionID:function(a){return this._sessionBuffer[a]?this._sessionBuffer[a].sessionID:0},removeSession:function(a){this._sessionBuffer[a]&&this._sessionBuffer[a].timeout&&clearInterval(this._sessionBuffer[a].timeout);delete this._sessionBuffer[a];
delete this._statesBuffer[a]},refreshSession:function(a){if(this._sessionBuffer[a]){null!=this._sessionBuffer[a].timeout&&clearInterval(this._sessionBuffer[a].timeout);var b=this._sessionBuffer[a].engine;b&&(this._sessionBuffer[a].timeout=this._createSessionTimeout(b))}},sessionHttpError:function(a){this._sessionBuffer[a]&&(this._sessionBuffer[a].httpError+=1,this._sessionBuffer[a].httpError>=this.MAX_HTTP_ERROR_COUNT&&this.removeSession(a))},sessionHttpOK:function(a){this._sessionBuffer[a]&&(this._sessionBuffer[a].httpError=
0)},removeAllSessions:function(){for(var a in this._sessionBuffer)this._sessionBuffer.hasOwnProperty(a)&&this._sessionBuffer[a]&&this._sessionBuffer[a].timeout&&clearInterval(this._sessionBuffer[a].timeout);this._sessionBuffer={};this._statesBuffer={}},_createSessionTimeout:function(a){return setInterval(function(){a._getStates()},3E3)},getStates:function(a){return this._statesBuffer[a]?this._statesBuffer[a].states:null},getStatesTimestamp:function(a){return this._statesBuffer[a]?this._statesBuffer[a].timestamp:
null},removeStates:function(a){this._statesBuffer[a]&&delete this._statesBuffer[a].states},setStates:function(a,b){this._statesBuffer[a]={states:b,timestamp:new Date}},addStates:function(a,b){this._statesBuffer[a]||(this._statesBuffer[a]={});if(this._statesBuffer[a].states){if(this._statesBuffer[a].timestamp=new Date,b)for(var c in b)b.hasOwnProperty(c)&&(this._statesBuffer[a].states[c]=b[c])}else this._statesBuffer[a]={states:b,timestamp:new Date}},finalize:function(a){var b=[],c;for(c in this._sessionBuffer)if(this._sessionBuffer.hasOwnProperty(c)){var d=
this._sessionBuffer[c];d&&d.engine&&b.push(d.engine)}if(0==b.length)a&&a();else{var e=0;for(c=0;c<b.length;c++)b[c].signoff(function(){e++;e==b.length&&a&&a()})}}};xnm.aio.contronics.Handler=function(){};xnm.aio.contronics.Handler.prototype.ExecEngine=xnm.aio.contronics.ExecEngine;xnm.aio.contronics.Handler.prototype.devicemanager=xnm.aio.contronics.DM;xnm.aio.contronics.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"contronics")};
xnm.aio.contronics.Handler.prototype.resolveGateway=function(a){return a.ip?new xnm.aio.contronics.ExecEngine(a.ip,a.port,a.username,a.password):null};xnm.aio.contronics.Handler.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.contronics.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};xnm.aio.contronics.Handler.prototype.getDeviceStatus=function(a,b){a=(a=xnm.aio.contronics.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};
xnm.aio.contronics.Handler.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};xnm.aio.contronics.Handler.prototype.doStatus=function(a,b,c,d,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};
xnm.aio.contronics.Handler.prototype.getDeviceList=function(a,b){var c=this.resolveGateway(a);c?c.getDeviceList(function(a,e){c.signoff(function(){b&&b(a,e)})}):b&&b(Error("gateway json format invalid"))};xnm.aio.contronics.Handler.prototype.finalize=function(a){var b=a;setTimeout(function(){b&&(b(),b=null)},3E3);xnm.aio.contronics.SessionBuffer.finalize(function(){b&&(b(),b=null)})};xnm.aio.contronics.Handler.prototype.pause=function(a){this.finalize(a)};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.contronics.Handler);
