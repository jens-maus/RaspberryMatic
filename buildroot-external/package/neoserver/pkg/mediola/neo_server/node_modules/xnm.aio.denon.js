var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(l,c,e){l instanceof String&&(l=String(l));for(var k=l.length,h=0;h<k;h++){var b=l[h];if(c.call(e,b,h,l))return{i:h,v:b}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(l,c,e){if(l==Array.prototype||l==Object.prototype)return l;l[c]=e.value;return l};$jscomp.getGlobal=function(l){l=["object"==typeof globalThis&&globalThis,l,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<l.length;++c){var e=l[c];if(e&&e.Math==Math)return e}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(l,c){var e=$jscomp.propertyToPolyfillSymbol[c];if(null==e)return l[c];e=l[e];return void 0!==e?e:l[c]};
$jscomp.polyfill=function(l,c,e,k){c&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(l,c,e,k):$jscomp.polyfillUnisolated(l,c,e,k))};$jscomp.polyfillUnisolated=function(l,c,e,k){e=$jscomp.global;l=l.split(".");for(k=0;k<l.length-1;k++){var h=l[k];if(!(h in e))return;e=e[h]}l=l[l.length-1];k=e[l];c=c(k);c!=k&&null!=c&&$jscomp.defineProperty(e,l,{configurable:!0,writable:!0,value:c})};
$jscomp.polyfillIsolated=function(l,c,e,k){var h=l.split(".");l=1===h.length;k=h[0];k=!l&&k in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var b=0;b<h.length-1;b++){var a=h[b];if(!(a in k))return;k=k[a]}h=h[h.length-1];e=$jscomp.IS_SYMBOL_NATIVE&&"es6"===e?k[h]:null;c=c(e);null!=c&&(l?$jscomp.defineProperty($jscomp.polyfills,h,{configurable:!0,writable:!0,value:c}):c!==e&&(void 0===$jscomp.propertyToPolyfillSymbol[h]&&($jscomp.propertyToPolyfillSymbol[h]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(h):
$jscomp.POLYFILL_PREFIX+h),$jscomp.defineProperty(k,$jscomp.propertyToPolyfillSymbol[h],{configurable:!0,writable:!0,value:c})))};$jscomp.polyfill("Array.prototype.find",function(l){return l?l:function(c,e){return $jscomp.findInternal(this,c,e).v}},"es6","es3");$jscomp.arrayIteratorImpl=function(l){var c=0;return function(){return c<l.length?{done:!1,value:l[c++]}:{done:!0}}};$jscomp.arrayIterator=function(l){return{next:$jscomp.arrayIteratorImpl(l)}};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(l){if(l)return l;var c=function(h,b){this.$jscomp$symbol$id_=h;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};c.prototype.toString=function(){return this.$jscomp$symbol$id_};var e=0,k=function(h){if(this instanceof k)throw new TypeError("Symbol is not a constructor");return new c("jscomp_symbol_"+(h||"")+"_"+e++,h)};return k},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(l){if(l)return l;l=Symbol("Symbol.iterator");for(var c="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),e=0;e<c.length;e++){var k=$jscomp.global[c[e]];"function"===typeof k&&"function"!=typeof k.prototype[l]&&$jscomp.defineProperty(k.prototype,l,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return l},"es6",
"es3");$jscomp.iteratorPrototype=function(l){l={next:l};l[Symbol.iterator]=function(){return this};return l};$jscomp.iteratorFromArray=function(l,c){l instanceof String&&(l+="");var e=0,k=!1,h={next:function(){if(!k&&e<l.length){var b=e++;return{value:c(b,l[b]),done:!1}}k=!0;return{done:!0,value:void 0}}};h[Symbol.iterator]=function(){return h};return h};$jscomp.polyfill("Array.prototype.keys",function(l){return l?l:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");
var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.denon=xnm.aio.denon||{};xnm.aio.marantz=xnm.aio.marantz||{};
xnm.aio.denon.AVR=function(){var l=function(c,e){this.ip=c;this.port=e;this.port||(this.port="23");this.timeout=2E3;this.CommandHandler=this._socket=null};l.prototype._doRequest=function(c,e,k){var h=require("net");if(!this._socket){var b=null,a=[];this._socket=h.connect({port:this.port,host:this.ip});this._socket.setTimeout(this.timeout);var d=this,g=null;this._socket.on("connect",function(){var f=new Buffer(c.shift()+"\r");d._socket.write(f);k&&d._socket.setTimeout(250)});this._socket.on("data",
function(f){b=b?b+f.toString():f.toString();for(f=b.indexOf("\r");0<f;)a.push(b.substr(0,f)),b=b.substr(f+1),f=b.indexOf("\r");0<c.length?(f=new Buffer(c.shift()+"\r"),d._socket.write(f)):d._socket.setTimeout(100)});this._socket.on("error",function(f){e&&(e({error:"socket error",data:null}),e=null);d._socket&&d._socket.destroy();d._socket=null});this._socket.on("timeout",function(){d._socket.destroy();d._socket=null;e&&(g=0<a.length?{error:null,data:a}:{error:"socket timeout",data:null})});this._socket.on("close",
function(){d._socket=null;e&&g&&setTimeout(function(){e(g)},250)})}};l.prototype._executeCommand=function(c,e){this._doRequest([c],function(){e&&e()},!0)};l.prototype.executeCommand=function(c,e){var k=c,h=this;"on"==c?k="PWON":"off"==c||"standby"==c?k="PWSTANDBY":"toggle"==c&&(k=null,this.getStates(function(b){b&&"on"==b.power?h._executeCommand("PWSTANDBY",e):h._executeCommand("PWON",e)}));k&&this._executeCommand(k,e)};l.prototype.getStates=function(c){var e={mainzone:{},zone2:{}};this._doRequest("PW? MU? SI? MV? ZM? Z2MU? Z2?".split(" "),
function(k){if(k.data){for(var h=0;h<k.data.length;h++){var b=k.data[h].trim();"PW"==b.substr(0,2)?e.power=b.substr(2).toLowerCase():"MV"==b.substr(0,2)?(b=b.substr(2),3==b.length?e.mainzone.volume=(parseFloat(b)/10).toFixed(1):2==b.length&&(e.mainzone.volume=parseFloat(b).toFixed(1))):"MU"==b.substr(0,2)?e.mainzone.mute=b.substr(2).toLowerCase():"SI"==b.substr(0,2)?e.mainzone.input=b.substr(2).toLowerCase():"ZM"==b.substr(0,2)?e.mainzone.power=b.substr(2).toLowerCase():"Z2MU"==b.substr(0,4)?e.zone2.mute=
b.substr(4).toLowerCase():"Z2"==b.substr(0,2)&&("Z2ON"==b?e.zone2.power="on":"Z2OFF"==b?e.zone2.power="off":(b=b.substr(2),/^\d+$/.test(b)?3==b.length?e.zone2.volume=(parseFloat(b)/10).toFixed(1):2==b.length&&(e.zone2.volume=parseFloat(b).toFixed(1)):e.zone2.input=b.toLowerCase()))}c&&c(e)}else c&&c()})};l.prototype.getStateValues=function(c,e){return e};return l}();
xnm.aio.denon.Cache={_cache:{},_getCache:function(l){return l?this._cache[l]:null},_ensureCache:function(l){if(!l)return null;this._cache[l]||(this._cache[l]={});return this._cache[l]},getConfig:function(l){return l?(l=this._getCache(l))?l.config:null:null},setConfig:function(l,c){if(!l)return null;this._ensureCache(l).config=c}};
xnm.aio.denon.WebAVR=function(){var l=function(c,e,k,h,b){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.denon.WebAVR");this.ip=c;this.port=e;this.port||(this.port=80);this.uuid=k;this.name=h;this.model=b;this.timeout=3E3;this.CommandHandler=null};l.prototype.audioModes="DIRECT;STEREO;DOLBY DIGITAL;DTS SURROUND;AUTO;MCH STEREO;SUPER STADIUM;ROCK ARENA;JAZZ CLUB;CLASSIC CONCERT;MONO MOVIE;MATRIX;VIDEO GAME;VIRTUAL".split(";");l.prototype.audioModesDesc=
"Direct;Stereo;Dolby Surrounds;DTS Surrounds;Auto;Multi Ch Stereo;Super Stadium;Rock Arena;Jazz Club;Classic Concert;Mono Movie;Matrix;Video Game;Virtual".split(";");l.prototype.videoInputs="CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;Online Music;Bluetooth;Internetradio;Media Server;CD;PHONO;HDRADIO".split(";");l.prototype._getConfig=function(){return xnm.aio.denon.Cache.getConfig(this.ip)};l.prototype._setConfig=function(c){xnm.aio.denon.Cache.setConfig(this.ip,
c)};l.prototype.executeCommandCreator=function(c,e,k){if(e&&e.value)if("openNative"==e.value)window&&window.XC&&window.XC.callHost&&window.XCHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?c&&"marantz"==c.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"marantzremoteapp://"}):window.XC.callHost("SYSTEM","startApp",{scheme:"denonremoteapp://"}):"Android"==window.XCHost.getType()&&(c&&"marantz"==c.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.marantzremoteapp"}):
window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.denonremoteapp"}))),k&&k();else{c="";e.path&&e.path[0]&&"global"!=e.path[0]&&(c=e.path[0]+":");var h=c+e.value;if("setInput"==e.value){if(!e.ext){k&&k(Error("command setInput ext format invalid"));return}h=c+e.ext}else if("audioMode"==e.value){if(!e.ext){k&&k(Error("command audioMode ext format invalid"));return}h=c+e.ext}else if("setTo"==e.value||"setToDB"==e.value){if(null==e.ext||"undefined"==typeof e.ext){k&&k(Error("command setTo ext format invalid"));
return}h+=e.ext}else if("customCMD"==e.value){if(!e.ext){k&&k(Error("command customCMD ext format invalid"));return}h="customCMD:"+e.ext}if("tuner"==e.value){if(null==e.ext||"undefined"==typeof e.ext){k&&k(Error("command tunerPreset ext format invalid"));return}h+=e.ext}this.executeCommand(h,function(b){if(b)k&&k(b);else{if(e.path&&e.path[0]&&"mainzone"==e.path[0]){if("on"==e.value||"off"==e.value||"toggle"==e.value){setTimeout(function(){k&&k()},1E3);return}if("setTo"==e.value||"setToDB"==e.value||
"volumeUp"==e.value||"volumeDown"==e.value){setTimeout(function(){k&&k()},10);return}}"setInput"==e.value||"audioMode"==e.value?setTimeout(function(){k&&k()},1E3):k&&k()}})}else k&&k(Error("command json format invalid"))};l.prototype.getStatesCreator=function(c,e,k){this.getStates(function(h,b){h=[];for(var a=0;a<e.length;a++)if(e[a]&&e[a].id){var d="?";if(b&&e[a].status&&e[a].status.value){var g="";e[a].status.path&&e[a].status.path[0]&&"global"!=e[a].status.path[0]&&(g=e[a].status.path[0]);var f=
e[a].status.value;g&&null!=b[g]&&"undefined"!=typeof b[g]?b[g][f]&&(d=b[g][f]):null!=b[f]&&"undefined"!=typeof b[f]&&(d=b[f])}h.push({id:e[a].id,status:d})}k&&k(null,h)})};l.prototype._doRequest=function(c,e,k,h){var b=this;e="http://"+this.ip+":"+this.port+e;this._logger.log("trace","send "+c+" to url:"+e+" data:"+k);var a=h;$.ajax({url:e,type:c,timeout:this.timeout,data:k,dataType:"text",cache:!0,success:function(d){b._logger.log("trace","http request success:"+d);setTimeout(function(){a&&(a(null,
d),a=null)},200)},error:function(d,g){d="http request error:"+(d?d.status:"0")+"-"+g;b._logger.log("trace",d);a&&(a(Error(d)),a=null)}})};l.prototype._getInputList=function(c){this._doRequest("GET","/goform/formMainZone_MainZoneXmlStatus.xml",null,function(e,k){if(e)c&&c(e);else try{var h=$($.parseXML(k));if(h){var b={inputs:[],renamed:[]};h.find("InputFuncList").each(function(){$(this).find("value").each(function(){var a=$(this).text();a&&b.inputs.push(a.trim())})});h.find("RenameSource").each(function(){$(this).find("value value").each(function(){var a=
$(this).text();a&&b.renamed.push(a.trim())})});c&&c(null,b)}else c&&c(Error("MainZoneXmlStatus.xml response invalid"))}catch(a){c&&c(a)}})};l.prototype._getStateValue=function(c,e,k,h){var b=null;c.find(e).each(function(){var a=$(this).find("value");0<a.length&&(b=$(a[0]).text())});b&&h&&(b=b.trim());b&&k&&(b=b.toLowerCase());return b};l.prototype._getOriginalInputName=function(c){var e=c,k=this._getConfig();k&&k.renamed&&k.inputs&&(c=k.renamed.indexOf(c),-1!=c&&k.inputs[c]&&(e=k.inputs[c]));return e};
l.prototype._parseStates=function(c){var e={};try{var k=$($.parseXML(c));if(k){e.mainpower=this._getStateValue(k,"Power",!0,!0);"standby"==e.mainpower&&(e.mainpower="off");e.power=this._getStateValue(k,"ZonePower",!0,!0);e.mute=this._getStateValue(k,"Mute",!0,!0);e.input=this._getStateValue(k,"InputFuncSelect",!1,!0);e.audioMode=this._getStateValue(k,"selectSurround",!1,!0);e.input&&(e.originalInput=this._getOriginalInputName(e.input));"NETWORK"==e.originalInput&&(e.netfunc=this._getStateValue(k,
"NetFuncSelect",!1,!0));switch(e.originalInput){case "CBL/SAT":e.originalInput="CBL/SAT";break;case "DVD":e.originalInput="DVD/Blu-ray";break;case "Blu-ray":e.originalInput="Blu-ray";break;case "GAME":e.originalInput="Game";break;case "Media Player":e.originalInput="Media Player";break;case "iPod/USB":e.originalInput="iPod/USB";break;case "TUNER":e.originalInput="Tuner";break;case "TV AUDIO":e.originalInput="TV Audio";break;case "NETWORK":switch(e.netfunc){case "IRADIO":e.originalInput="Internetradio";
break;case "SERVER":e.originalInput="Media Server";break;default:e.originalInput="Online Music"}}var h=this._getStateValue(k,"MasterVolume",!1,!0);e.volumeDB="--"==h?"-80.0":parseFloat(h).toFixed(1);h="--"==h?0:parseFloat(h)+80;e.volume=""+h.toFixed(1)}}catch(b){}return e};l.prototype.getStates=function(c){var e={mainzone:{},zone2:{},zone3:{}},k=this;this._getConfig()?this._doRequest("GET","/goform/formMainZone_MainZoneXml.xml",null,function(h,b){!h&&b?(e.mainzone=k._parseStates(b),e.power=e.mainzone.mainpower,
delete e.mainzone.mainpower,k._doRequest("GET","/goform/formMainZone_MainZoneXml.xml?ZoneName=ZONE2",null,function(a,d){!a&&d&&(e.zone2=k._parseStates(d),delete e.zone2.mainpower);k._doRequest("GET","/goform/formMainZone_MainZoneXml.xml?ZoneName=ZONE3",null,function(g,f){!g&&d&&(e.zone3=k._parseStates(f),delete e.zone3.mainpower);c&&c(g,e)})})):c&&c(h,e)}):this._getInputList(function(h,b){h?c&&c(h):(k._setConfig(b),k.getStates(c))})};l.prototype.executeCommand=function(c,e){var k=null,h=!0,b=null,
a=c.indexOf(":");0<a&&(b=c.substr(0,a),c=c.substr(a+1));a="POST";var d="/MainZone/index.put.asp",g=this;"on"==c?k="mainzone"==b?"cmd0=PutZone_OnOff%2FON":"zone2"==b?"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE3":"cmd0=PutSystem_OnStandby%2FON":"off"==c||"standby"==c?k="mainzone"==b?"cmd0=PutZone_OnOff%2FOFF":"zone2"==b?"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE2":"zone2"==b?"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE3":"cmd0=PutSystem_OnStandby%2FSTANDBY":"toggle"==
c?(h=!1,this.getStates(function(f,m){b?"mainzone"==b?m&&m.mainzone&&"on"==m.mainzone.power?g._doRequest("POST",d,"cmd0=PutZone_OnOff%2FOFF",e):g._doRequest("POST",d,"cmd0=PutZone_OnOff%2FON",e):"zone2"==b?m&&m.zone2&&"on"==m.zone2.power?g._doRequest("POST",d,"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE2",e):g._doRequest("POST",d,"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE2",e):"zone3"==b&&(m&&m.zone3&&"on"==m.zone3.power?g._doRequest("POST",d,"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE3",e):g._doRequest("POST",
d,"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE3",e)):m&&"on"==m.power?g._doRequest("POST",d,"cmd0=PutSystem_OnStandby%2FSTANDBY",e):g._doRequest("POST",d,"cmd0=PutSystem_OnStandby%2FON",e)})):"mute"==c?"zone2"==b?k="cmd0=PutVolumeMute/on&ZoneName=ZONE2":"zone3"==b?k="cmd0=PutVolumeMute/on&ZoneName=ZONE3":"mainzone"==b?k="cmd0=PutVolumeMute/on":(d="/goform/AppCommand.xml",k='<?xml version="1.0" encoding="utf-8"?>\r\n<tx>\r\n<cmd id="1">SetAllZoneMute</cmd>\r\n<value>ON</value>\r\n</tx>'):"unmute"==c?"zone2"==
b?k="cmd0=PutVolumeMute/off&ZoneName=ZONE2":"zone3"==b?k="cmd0=PutVolumeMute/off&ZoneName=ZONE3":"mainzone"==b?k="cmd0=PutVolumeMute/off":(d="/goform/AppCommand.xml",k='<?xml version="1.0" encoding="utf-8"?>\r\n<tx>\r\n<cmd id="1">SetAllZoneMute</cmd>\r\n<value>OFF</value>\r\n</tx>'):"toggleMute"==c?k="zone2"==b?"cmd0=PutVolumeMute/toggle&ZoneName=ZONE2":"zone3"==b?"cmd0=PutVolumeMute/toggle&ZoneName=ZONE3":"cmd0=PutVolumeMute/toggle":"volumeDown"==c?k="zone2"==b?"cmd0=PutMasterVolumeBtn/<&ZoneName=ZONE2":
"zone3"==b?"cmd0=PutMasterVolumeBtn/<&ZoneName=ZONE3":"cmd0=PutMasterVolumeBtn/<":"volumeUp"==c?k="zone2"==b?"cmd0=PutMasterVolumeBtn/>&ZoneName=ZONE2":"zone3"==b?"cmd0=PutMasterVolumeBtn/>&ZoneName=ZONE3":"cmd0=PutMasterVolumeBtn/>":"CBL/SAT"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/SAT/CBL&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/SAT/CBL&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/SAT/CBL":"DVD/Blu-ray"==c||"DVD"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/DVD&ZoneName=ZONE2":"zone3"==
b?"cmd0=PutZone_InputFunction/DVD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/DVD":"Blu-ray"==c||"BD"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/BD&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/BD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/BD":"Game"==c||"GAME"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/GAME&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/GAME&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/GAME":"AUX"==c||"AUX1"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/AUX1&ZoneName=ZONE2":
"zone3"==b?"cmd0=PutZone_InputFunction/AUX1&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/AUX1":"AUX2"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/AUX2&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/AUX2&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/AUX2":"Media Player"==c||"MPLAY"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/MPLAY&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/MPLAY&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/MPLAY":"iPod/USB"==c||"IPOD"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/USB/IPOD&ZoneName=ZONE2":
"zone3"==b?"cmd0=PutZone_InputFunction/USB/IPOD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/USB/IPOD":"TV Audio"==c||"TV"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/TV&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/TV&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/TV":"Tuner"==c||"TUNER"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/TUNER&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/TUNER&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/TUNER":"Online Music"==c||"NETHOME"==c||"NET"==c?k=
"zone2"==b?"cmd0=PutZone_InputFunction/NETHOME&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/NETHOME&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/NETHOME":"Bluetooth"==c||"BT"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/BT&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/BT&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/BT":"Internetradio"==c||"IRP"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/IRP&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/IRP&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/IRP":
"Media Server"==c||"SERVER"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/SERVER&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/SERVER&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/SERVER":"CD"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/CD&ZoneName=ZONE2":"zone2"==b?"cmd0=PutZone_InputFunction/CD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/CD":"PHONO"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/PHONO&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/PHONO&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/PHONO":
"HDRADIO"==c?k="zone2"==b?"cmd0=PutZone_InputFunction/HDRADIO&ZoneName=ZONE2":"zone3"==b?"cmd0=PutZone_InputFunction/HDRADIO&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/HDRADIO":"Source"==c?(a="GET","zone2"==b?d="/goform/formiPhoneAppDirect.xml?Z2SOURCE":"zone2"==b&&(d="/goform/formiPhoneAppDirect.xml?Z3SOURCE")):"Quick1"==c?k="cmd0=PutUserMode/Quick1":"Quick2"==c?k="cmd0=PutUserMode/Quick2":"Quick3"==c?k="cmd0=PutUserMode/Quick3":"Quick4"==c?k="cmd0=PutUserMode/Quick4":"playPause"==c?k="cmd0=PutNetAudioCommand/CurEnter":
"previous"==c?k="cmd0=PutNetAudioCommand/CurUp":"next"==c?k="cmd0=PutNetAudioCommand/CurDown":0==c.indexOf("tuner")?(c=c.replace(/tuner/g,""),a="GET",d="/goform/formiPhoneAppTuner.xml",c="Up"==c?"PRESETUP":"Down"==c?"PRESETDOWN":"PRESETCALL0"+c,d+="?"+("zone2"==b?"2+"+c:"zone3"==b?"3+"+c:"1+"+c),k=null):-1!=this.audioModes.indexOf(c)?(a="GET",d="/goform/formiPhoneAppDirect.xml?MS"+encodeURI(c),k=null):-1!=this.audioModesDesc.indexOf(c)?(c=this.audioModes[this.audioModesDesc.indexOf(c)],a="GET",d=
"/goform/formiPhoneAppDirect.xml?MS"+encodeURI(c),k=null):"customCMD"==b?(a="GET",d=c):0==c.indexOf("setToDB")?(0==c.indexOf("setToDB")&&(c=c.replace(/setToDB/g,"")),"mainzone"==b?(c=parseFloat(c),-80>c?c=-80:18<c&&(c=18),c=c.toFixed(1),k="cmd0=PutMasterVolumeSet/"+c):"zone2"==b?(c=parseInt(c),-80>c?c=-80:18<c&&(c=18),c=c.toFixed(1),k="cmd0=PutMasterVolumeSet/"+c+"&ZoneName=ZONE2"):"zone3"==b&&(c=parseInt(c),-80>c?c=-80:18<c&&(c=18),c=c.toFixed(1),k="cmd0=PutMasterVolumeSet/"+c+"&ZoneName=ZONE3")):
b&&(0==c.indexOf("setTo")&&(c=c.replace(/setTo/g,"")),"mainzone"==b?(c=parseFloat(c),0>c?c=0:98<c&&(c=98),c=(c-80).toFixed(1),k="cmd0=PutMasterVolumeSet/"+c):"zone2"==b?(c=parseInt(c),0>c?c=0:80<c&&(c=80),k="cmd0=PutMasterVolumeSet/"+(c-80)+"&ZoneName=ZONE2"):"zone3"==b&&(c=parseInt(c),0>c?c=0:80<c&&(c=80),k="cmd0=PutMasterVolumeSet/"+(c-80)+"&ZoneName=ZONE3"));h&&this._doRequest(a,d,k,e)};l.prototype.getStateValues=function(c,e){return e};l.prototype.toJSON=function(){var c={sys:xnm.aio.denon.DM.SYS,
type:"avr",ip:this.ip,port:this.port,uuid:this.uuid,model:this.model};this.name&&(c.name=this.name);return c};l.prototype.equalsTo=function(c){return c&&c instanceof l?this.ip==c.ip&&this.port==c.port:!1};l.parseJSON=function(c){return c.ip?new l(c.ip,c.port,c.uuid,c.name,c.model):null};return l}();
xnm.aio.denon.AVR2=function(){var l=function(){var b=function(){this._stateExpiredTime=300;this._errorStateExpiredTime=10;this._buffer={}};b.prototype.reset=function(){this._buffer={}};b.prototype.getState=function(a){var d=Math.round((new Date).getTime()/1E3);if(this._buffer[a])if(a=this._buffer[a],!a.update||null==a.value&&d-a.update>this._errorStateExpiredTime||d-a.update>this._stateExpiredTime)a.update=d,a.value=null;else return a.value;else this._buffer[a]={update:d,value:null}};b.prototype.putState=
function(a,d){var g={};g.update=Math.round((new Date).getTime()/1E3);g.value=d;this._buffer[a]=g};return b}(),c=function(){var b=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Controller");var a=this;this._session=new e;this._session.on("open",function(){a._state="OPEN";a._logger.log("trace","session opened");a._emitEvent("open");a._restartCloseTimeout()});this._session.on("close",function(){a._state="IDLE";a._reset();a._logger.log("trace","session closed");a._emitEvent("close")});
this._session.on("error",function(d){a._state="CONNECT";a._logger.log("trace","session error:"+d.message);a._reset()});this._session.on("event",function(d){a._logger.log("trace","receive session event:"+d);a._processAVREvent(d)});this._state="IDLE";this._stateBuffer=new l;this._listeners={};this._closeTO=null;this._closeTimeout=3E5};b.prototype.isIdle=function(){return"IDLE"==this._state};b.prototype.on=function(a,d){a&&d&&(this._listeners[a]||(this._listeners[a]=[]),-1==this._listeners[a].indexOf(d)&&
this._listeners[a].push(d))};b.prototype.off=function(a,d){a&&d&&this._listeners[a]&&(d=this._listeners[a].indexOf(d),-1!=d&&this._listeners[a].splice(d,1))};b.prototype.open=function(a){"IDLE"==this._state&&(this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Controller.("+a.ip+":"+a.port+")"),this._logger.log("trace","open session"),this._state="CONNECT",this._session.open(a))};b.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("trace","close session"),this._state=
"CLOSED",this._session.close())};b.prototype.sendCommand=function(a,d,g){this._logger.log("trace","send command:"+a+" param:"+d);this._restartCloseTimeout();var f=this;this._session.sendCommand(a,d,function(m,n){m?f._logger.log("trace","send command failed:"+m.message):f._logger.log("trace","send command success:"+n);g&&g(m,n)})};b.prototype.getState=function(a,d){this._logger.log("trace","get state:"+a);this._restartCloseTimeout();var g=this._stateBuffer.getState(a);if("undefined"!=typeof g)this._logger.log("trace",
"get buffered state:"+g),d&&d(null,g);else{var f=this,m=a,n="?";if("CV"==m.substr(0,2))m="CV";else if("MSQUICK"==m)n=" ?";else if("VS"==m.substr(0,2))n=" ?";else if("PS"==m.substr(0,2))"PSFRONT"!=m&&(n=" ?"),"PSSWL2"==m&&(m="PSSWL");else if("PV"==m.substr(0,2))"PV"!=m&&(n=" ?");else if("TR"==m.substr(0,2))m="TR";else if("DIM"==m.substr(0,3))n=" ?";else if("Z2"==m.substr(0,2))if("Z2QUICK"==m||"Z2PSBAS"==m||"Z2PSTRE"==m)n=" ?";else{if("Z2:POWER"==m||"Z2:VOLUME"==m||"Z2:INPUT"==m)m="Z2"}else if("Z3"==
m.substr(0,2))if("Z3QUICK"==m||"Z3PSBAS"==m||"Z3PSTRE"==m)n=" ?";else if("Z3:POWER"==m||"Z3:VOLUME"==m||"Z3:INPUT"==m)m="Z3";this._logger.log("trace","do send state request:"+m);this._session.sendCommand(m,n,function(p){p?(f._logger.log("trace","get state failed:"+p.message),d&&d(p)):"CV"==m||"MS"==m||"PSSWL"==m||"TR"==m||"Z2"==m||"Z3"==m?setTimeout(function(){f._logger.log("trace","get state "+m+" success");g=f._stateBuffer.getState(a);d&&d(null,g)},250):(f._logger.log("trace","get state "+m+" success"),
g=f._stateBuffer.getState(a),d&&d(null,g))})}};b.prototype._reset=function(){this._stateBuffer.reset()};b.prototype._emitEvent=function(a,d){if(a){var g=this._listeners[a];if(g&&0<g.length)for(var f=0;f<g.length;f++){var m=g[f];try{m(d)}catch(n){this._logger.log("trace","call "+a+" listener failed, error:"+n.message)}}}};b.prototype._processAVREvent=function(a){if(a&&!(2>a.length)){var d=a.split(" ");if("CVEND"!=a&&"DC"!=a.substr(0,2)&&"SY"!=a.substr(0,2)&&"NS"!=a.substr(0,2)&&"UG"!=a.substr(0,2)){if("CV"==
a.substr(0,2)){var g=d[0];var f=d[1].trim()}else if("SV"==a.substr(0,2))g=a.substr(0,2),f=a.substr(2).trim();else if("STBY"==a.substr(0,4))g="STBY",f=a.substr(4).trim();else if("ECO"==a.substr(0,3))g="ECO",f=a.substr(3).trim();else if("SLP"==a.substr(0,3))g="SLP",f=a.substr(3).trim();else if("MS"==a.substr(0,2))"MSQUICK"==a.substr(0,7)?(g="MSQUICK",f=a.substr(7).trim()):(g=a.substr(0,2),f=a.substr(2).trim());else if("VS"==a.substr(0,2))"VSASP"==a.substr(0,5)?(g="VSASP",f=a.substr(5).trim()):"VSMONI"==
a.substr(0,6)?(g="VSMONI",f=a.substr(6).trim()):"VSSCH"==a.substr(0,5)?(g="VSSCH",f=a.substr(5).trim()):"VSSC"==a.substr(0,4)?(g="VSSC",f=a.substr(4).trim()):"VSVST"==a.substr(0,5)?(g="VSVST",f=a.substr(5).trim()):"VSAUDIO"==a.substr(0,7)?(g="VSAUDIO",f=a.substr(7).trim()):"VSVPM"==a.substr(0,5)&&(g="VSVPM",f=a.substr(5).trim());else if("PS"==a.substr(0,2))"PSSP:"==a.substr(0,5)?(g="PSSP:",f=a.substr(5).trim()):"PSTONE CTRL"==a.substr(0,11)?(g="PSTONE CTRL",f=a.substr(11).trim()):"PSCINEMA EQ."==
a.substr(0,12)?(g="PSCINEMA EQ.",f=a.substr(12).trim()):"PSMULTEQ:"==a.substr(0,9)?(g="PSMULTEQ:",f=a.substr(9).trim()):(g=d[0],f=d[1].trim());else if("PV"==a.substr(0,2))2==d.length?(g=d[0],f=d[1].trim()):(g=a.substr(0,2),f=a.substr(2).trim());else if("MN"==a.substr(0,2))g=d[0],f=d[1].trim();else if("TR"==a.substr(0,2))g=d[0],f=d[1].trim();else if("DIM"==a.substr(0,3))g=d[0],f=d[1].trim();else if("TF"==a.substr(0,2))"TFANNAME"==a.substr(0,8)?(g="TFANNAME",f=a.substr(8).trim()):"TFAN"==a.substr(0,
4)&&(g="TFAN",f=a.substr(4).trim());else if("TP"==a.substr(0,2))"TPAN"==a.substr(0,4)&&(g="TPAN",f=a.substr(4).trim());else if("TM"==a.substr(0,2)){if("TMAN"==a.substr(0,4)){g=a.substr(0,4);f=a.substr(4).trim();(a=this._stateBuffer.getState(g))||(a={});switch(f){case "AM":case "FM":a.band=f;break;case "AUTO":case "MANUAL":a.mode=f}f=a}}else if("Z2"==a.substr(0,2))if("Z2MU"==a.substr(0,4))g="Z2MU",f=a.substr(4).trim();else if("Z2STBY"==a.substr(0,6))g="Z2STBY",f=a.substr(6).trim();else if("Z2CS"==
a.substr(0,4))g="Z2CS",f=a.substr(4).trim();else if("Z2CV"==a.substr(0,4))g=d[0],f=d[1].trim();else if("Z2HPF"==a.substr(0,5))g="Z2HPF",f=a.substr(5).trim();else if("Z2PS"==a.substr(0,4))g=d[0],f=d[1].trim();else if("Z2SLP"==a.substr(0,5))g="Z2SLP",f=a.substr(5).trim();else if("Z2HDA"==a.substr(0,5))g="Z2HDA",f=a.substr(5).trim();else if(f=a.substr(2).trim(),isNaN(parseInt(f)))switch(f){case "ON":case "OFF":g="Z2:POWER";break;case "QUICK1":case "QUICK2":case "QUICK3":case "QUICK4":case "QUICK5":g=
"Z2QUICK";break;default:g="Z2:INPUT"}else g="Z2:VOLUME";else if("Z3"==a.substr(0,2))if("Z3MU"==a.substr(0,4))g="Z3MU",f=a.substr(4).trim();else if("Z3STBY"==a.substr(0,6))g="Z3STBY",f=a.substr(6).trim();else if("Z3CS"==a.substr(0,4))g="Z3CS",f=a.substr(4).trim();else if("Z3CV"==a.substr(0,4))g=d[0],f=d[1].trim();else if("Z3HPF"==a.substr(0,5))g="Z3HPF",f=a.substr(5).trim();else if("Z3PS"==a.substr(0,4))g=d[0],f=d[1].trim();else if("Z3SLP"==a.substr(0,5))g="Z3SLP",f=a.substr(5).trim();else if(f=a.substr(2).trim(),
isNaN(parseInt(f)))switch(f){case "ON":case "OFF":g="Z3:POWER";break;case "QUICK1":case "QUICK2":case "QUICK3":case "QUICK4":case "QUICK5":g="Z3QUICK";break;default:g="Z3:INPUT"}else g="Z3:VOLUME";else"MVMAX"==a.substr(0,5)?(g="MVMAX",f=a.substr(6).trim()):(g=a.substr(0,2),f=a.substr(2).trim());g&&f&&this._stateBuffer.putState(g,f)}}};b.prototype._restartCloseTimeout=function(){var a=this;null!=this._closeTO&&(clearTimeout(this._closeTO),this._closeTO=null);this._closeTO=setTimeout(function(){a._logger.log("trace",
"no activity for "+a._closeTimeout/1E3+" seconds, stop the session");a.close()},this._closeTimeout)};return b}(),e=function(){var b=function(){};b.prototype.searchAVR=function(f,m){require("x.upnp.js").discoverDevicesWithTimeout(3E3,function(n){if(0==n.name.indexOf("Denon AVR")&&n.uuid==f){var p=n.modelName;p&&"*"==p.charAt(0)&&(p=p.substr(1));m&&m(null,{ip:n.ip,uuid:n.uuid,name:n.name,model:p})}})};var a=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Session._Monitor");
this._monitorCallback=this._socket=null;this._commandTimeoutCount=0;this._heartBeatTo=null;this._heatBeatMissCount=0;var f=this;this._socketErrorCallback=function(m){f._finishRun(m)};this._socketCloseCallback=function(){f._finishRun(Error("socket closed"))}};a.prototype.run=function(f,m){this._socket=f;this._monitorCallback=m;this._setListener();this.scheduleNextHeartBeat()};a.prototype.reset=function(){this._monitorCallback=null;this._heatBeatMissCount=0;this._heartBeatTo&&(clearTimeout(this._heartBeatTo),
this._heartBeatTo=null);if(this._socket){var f=this._socket;this._clearListener();this._socket=null;f.close()}};a.prototype.executeCommandTimeout=function(f){f?(this._commandTimeoutCount++,this._logger.log("warn","execute command timeout#"+this._commandTimeoutCount),3<this._commandTimeoutCount&&this._finishRun(Error("execute command is always timeout"))):this._commandTimeoutCount=0};a.prototype.scheduleNextHeartBeat=function(f){this._scheduleNextHeartBeat(f?f:15E3)};a.prototype._scheduleNextHeartBeat=
function(f){var m=this;this._heartBeatTo&&clearTimeout(this._heartBeatTo);this._heartBeatTo=setTimeout(function(){m._checkHeartBeat()},f)};a.prototype._checkHeartBeat=function(){if(this._socket){this._logger.log("trace","check heart beat");var f=this;this._socket.sendCommand("PW","?",function(m){m?(f._heatBeatMissCount++,f._logger.log("warn","check heart beat failed #"+f._heatBeatMissCount+", error:"+m.message),f._scheduleNextHeartBeat(2E3)):(f._heatBeatMissCount=0,f._scheduleNextHeartBeat(15E3));
3<f._heatBeatMissCount&&f._finishRun(Error("heart beat failed"))})}};a.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};a.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};a.prototype._finishRun=function(f){var m=this._socket;this._socket&&(this._clearListener(),this._socket=null);f&&m&&m.close();
this._heartBeatInterval&&(clearInterval(this._heartBeatInterval),this._heartBeatInterval=null);this._heatBeatMissCount=this._commandTimeoutCount=0;this._monitorCallback&&(m=this._monitorCallback,this._monitorCallback=null,m(f))};var d=function(){this._connectCallback=this._socket=this._connectWaitTo=null;var f=this;this._socketOpenCallback=function(){f._finishConnect()};this._socketErrorCallback=function(m){f._finishConnect(m)};this._socketCloseCallback=function(){f._finishConnect(Error("socket closed"))}};
d.prototype.connect=function(f,m){this._connectCallback=m;m=f.wait;delete f.wait;this._socket=new k(f);this._setListener();if(m){var n=this;this._connectWaitTo=setTimeout(function(){n._socket.open()},m)}else this._socket.open();return this._socket};d.prototype.reset=function(){this._connectWaitTo&&clearTimeout(this._connectWaitTo);this._connectCallback=this._connectWaitTo=null;if(this._socket){var f=this._socket;this._clearListener();this._socket=null;f.close()}};d.prototype._setListener=function(){this._socket&&
(this._socket.on("open",this._socketOpenCallback),this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};d.prototype._clearListener=function(){this._socket&&(this._socket.off("open",this._socketOpenCallback),this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};d.prototype._finishConnect=function(f){var m=this._socket;this._socket&&(this._clearListener(),this._socket=null);f&&m&&m.close(f);if(this._connectCallback){var n=
this._connectCallback;this._connectCallback=null;n(f,m)}};var g=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Session");this._connect=new d;this._monitor=new a;this._discover=new b;var f=this;this._socketEventCallback=function(m){f._logger.log("trace","receive event:"+m);f._monitor.scheduleNextHeartBeat();f._emitEvent("event",m)};this._socket=null;this._state="IDLE";this._uuid=this._port=this._ip=null;this._eventListeners={};this._connectFailCount=0};g.prototype.on=
function(f,m){f&&m&&(this._eventListeners[f]||(this._eventListeners[f]=[]),-1==this._eventListeners[f].indexOf(m)&&this._eventListeners[f].push(m))};g.prototype.off=function(f,m){f&&m&&this._eventListeners[f]&&(m=this._eventListeners[f].indexOf(m),-1!=m&&this._eventListeners[f].splice(m,1))};g.prototype.open=function(f){f&&"IDLE"==this._state&&(this._ip=f.ip,this._port=f.port,this._uuid=f.uuid,this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Session.("+this._ip+":"+this._port+")"),
this._logger.log("debug","start controller for "+this._ip),this._doFSM("init"))};g.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("debug","stop controller"),this._doFSM("stop"))};g.prototype.sendCommand=function(f,m,n){if("IDLE"==this._state)f=Error("session not initialized"),f.sys="denon",f.code=-4,n&&n(f);else{this._logger.log("trace","send command:"+f+m+" to "+this._ip);var p=this;this._socket.sendCommand(f,m,function(r,q){r?-3==r.code?(p._monitor.scheduleNextHeartBeat(),p._monitor.executeCommandTimeout(!0)):
p._monitor.executeCommandTimeout(!1):(p._monitor.scheduleNextHeartBeat(),p._monitor.executeCommandTimeout(!1));r?p._logger.log("trace","send command failed:"+r.message):p._logger.log("trace","send command success:"+q);n&&n(r,q)})}};g.prototype._emitEvent=function(f,m){if(f){var n=this._eventListeners[f];if(n&&0<n.length)for(var p=0;p<n.length;p++){var r=n[p];try{r(m)}catch(q){this._logger.log("trace","call "+f+" listener failed, error:"+q.message)}}}};g.prototype._connectAVR=function(f){this._logger.log("trace",
"connect avr device:"+this._ip+(f?" after "+f+" ms":""));var m=this;this._socket=this._connect.connect({ip:this._ip,port:this._port,uuid:this._uuid,wait:f},function(n,p){n?(m._logger.log("trace","connect to avr device:"+m._ip+" failed, error:"+n.message),m._doFSM("conn_fail")):(m._logger.log("trace","connect to avr device:"+m._ip+" success"),m._socket=p,m._doFSM("conn_ok"))})};g.prototype._stopConnectAVR=function(){this._logger.log("trace","stop connect avr device:"+this._ip);this._connect.reset();
this._reset()};g.prototype._runAVR=function(){this._logger.log("trace","monitor avr device:"+this._ip);var f=this;this._monitor.run(this._socket,function(m){m&&(f._logger.log("trace","monitor avr device:"+f._ip+" failed, error:"+m.message),f._socket=null,f._doFSM("run_error"),f._emitEvent("error",m))});this._setListener();this._emitEvent("open")};g.prototype._stopRunAVR=function(){this._logger.log("trace","stop monitor avr device:"+this._ip);this._monitor.reset();this._clearListener();this._emitEvent("close");
this._reset()};g.prototype._searchAVR=function(){if(this._uuid){var f=this;this._discover.searchAVR(this._uuid,function(m,n){!m&&n&&n.ip!=f._ip&&(f._logger.log("trace","find avr ("+f._uuid+") with new ip:"+n.ip),"CONNECT"==f._state&&(f._ip=n.ip,f._connect.reset(),f._connectAVR()))})}};g.prototype._setListener=function(){if(this._socket)this._socket.on("event",this._socketEventCallback)};g.prototype._clearListener=function(){this._socket&&this._socket.off("event",this._socketEventCallback)};g.prototype._reset=
function(){this._uuid=this._port=this._ip=this._socket=null;this._connectFailCount=0};g.prototype._doFSM=function(f){this._logger.log("trace","FSM current state:"+this._state+" input:"+f);switch(this._state){case "IDLE":switch(f){case "init":this._state="CONNECT",this._logger.log("trace","FSM new state:"+this._state),this._connectAVR()}break;case "CONNECT":switch(f){case "conn_fail":this._connectFailCount++;this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);2<=this._connectFailCount&&
this._searchAVR();this._connectAVR(Math.min(3E4,5E3*this._connectFailCount));break;case "conn_ok":this._connectFailCount=0;this._state="RUN";this._logger.log("trace","FSM new state:"+this._state);this._runAVR();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopConnectAVR()}break;case "RUN":switch(f){case "run_error":this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);this._connectAVR();break;case "stop":this._state="IDLE",
this._logger.log("trace","FSM new state:"+this._state),this._stopRunAVR()}}};return g}(),k=function(){var b=function(a){if(!a)throw Error("options is null");if(!a.ip)throw Error("no ip");this._responseTimeout=300;this._ip=a.ip;this._port=a.port;this._port||(this._port=23);this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Socket.("+this._ip+":"+this._port+")");this._timeout=2E3;this._listeners={};this._socket=null;this._buf="";this._state="IDLE";this._commands=[]};b.prototype.on=function(a,
d){a&&d&&(this._listeners[a]||(this._listeners[a]=[]),-1==this._listeners[a].indexOf(d)&&this._listeners[a].push(d))};b.prototype.off=function(a,d){a&&d&&this._listeners[a]&&(d=this._listeners[a].indexOf(d),-1!=d&&this._listeners[a].splice(d,1))};b.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var a=this;this._state="CONNECT";this._buf="";var d=require("net").connect({port:this._port,host:this._ip});d.setTimeout(this._timeout);d.setEncoding("utf8");this._logger.log("trace","start connect to "+
this._ip+":"+this._port);d.on("connect",function(){a._logger.log("trace","success to connect "+a._ip+":"+a._port);a._state="CONNECTED";a._emitEvent("open");a._executeNextCommand()});d.on("data",function(g){a._logger.log("trace","receive data: "+g.toString());a._buf+=g.toString();a._processBuffer()});d.on("error",function(g){a._logger.log("trace","socket error: "+g.message);a._emitEvent("error",g)});d.on("timeout",function(){"CONNECT"==a._state&&(a._logger.log("trace","connect timeout"),a._emitEvent("error",
Error("connect timeout")),a.close(Error("connect timeout")))});d.on("close",function(){a._logger.log("trace","socket closed");a._onClose()});d._doConnect&&"function"==typeof d._doConnect&&d._doConnect();this._socket=d}};b.prototype.close=function(a){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose(a))};b.prototype.sendCommand=function(a,d,g){if("CLOSED"==this._state)a=Error("socket closed"),a.code=-1,g&&g(a);else if(a){var f=this._commands.length;this._commands.push({command:a,
param:d,callback:g,timeout:null,state:"IDLE",responseTimeout:this._responseTimeout});0==f&&this._executeNextCommand()}else a=Error("invalid command"),a.code=-2,g&&g(a)};b.prototype._executeNextCommand=function(){var a=this._commands[0];if(a&&"IDLE"==a.state&&"CONNECTED"==this._state){var d=a.command;"undefined"!=typeof a.param&&null!=a.param&&(d+=a.param);d+="\r";a.state="SENT";this._setupReponseTimeout(a);this._logger.log("debug","send command:"+d);a=new Buffer(d);this._socket.write(a)}};b.prototype._setupReponseTimeout=
function(a){var d=this;a.timeout=setTimeout(function(){d._commands.splice(0,1);a.state="TIMEOUT";if(a.callback){d._logger.log("debug","response timeout");var g=Error("response timeout");g.code=-3;a.callback(g)}d._executeNextCommand()},a.responseTimeout)};b.prototype._emitEvent=function(a,d){if(a){var g=this._listeners[a];if(g&&0<g.length)for(var f=0;f<g.length;f++){var m=g[f];try{m(d)}catch(n){this._logger.log("trace","call "+a+" listener failed, error:"+n.message)}}}};b.prototype._processBuffer=
function(){for(var a=this._buf.indexOf("\r");-1!=a;){if(0!=a){var d=this._buf.substr(0,a);this._processResponse(d)}this._buf=this._buf.substr(a+1);a=this._buf.indexOf("\r")}};b.prototype._processResponse=function(a){this._logger.log("debug","receive response: "+a);try{this._emitEvent("event",a);var d=this._commands[0];if(d&&"SENT"==d.state&&d.command&&d.command.substr(0,2)==a.substr(0,2)){clearTimeout(d.timeout);try{d.callback&&d.callback(null,a)}catch(g){this._logger.log("debug","do command callback error: "+
g.message)}this._commands.splice(0,1);this._executeNextCommand()}}catch(g){this._logger.log("debug","process response error: "+g.message)}};b.prototype._onClose=function(a){this._state="CLOSED";this._socket=null;this._emitEvent("close");this._listeners={};a=a?a:Error("socket closed");a.code=-1;for(var d=0;d<this._commands.length;d++){var g=this._commands[d];g.timeout&&clearTimeout(g.timeout);g.callback&&g.callback(a)}this._commands=[];this._buf=""};return b}(),h=function(b){this._ip=b.ip;this._port=
b.port;this._uuid=b.uuid;this._model=b.model;this._name=b.name;this._port||(this._port=23);this._controller=new c};h.prototype.executeCommandCreator=function(b,a,d){if(a&&a.value)if("openNative"==a.value)window&&window.XC&&window.XC.callHost&&window.XCHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?b&&"marantz"==b.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"marantzremoteapp://"}):window.XC.callHost("SYSTEM","startApp",{scheme:"denonremoteapp://"}):"Android"==window.XCHost.getType()&&
(b&&"marantz"==b.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.marantzremoteapp"}):window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.denonremoteapp"}))),d&&d();else if("customCMD"==a.value)a.ext?(cmd="customCMD:"+a.ext,this._sendCommand(a.ext,"",function(f){d&&d(f)})):d&&d(Error("command customCMD ext format invalid"));else{var g=b=null;a.path&&a.path[0]&&(b=a.path[0]);switch(b){case "global":g=0;break;case "mainzone":g=1;break;case "zone2":g=2;break;case "zone3":g=
3}if("radio"==b)switch(a.value){case "band":this.setRadioBand(a.ext,d);break;case "previousPreset":this.previousRadioPreset(d);break;case "nextPreset":this.nextRadioPreset(d);break;case "preset":this.setRadioPreset(a.ext,d);break;default:d&&d(Error("unkonwn command"))}else switch(a.value){case "on":this.setPower(g,!0,d);break;case "off":this.setPower(g,!1,d);break;case "toggle":this.togglePower(g,d);break;case "mute":this.setMute(g,!0,d);break;case "unmute":this.setMute(g,!1,d);break;case "toggleMute":this.toggleMute(g,
d);break;case "volumeUp":this.volumeUp(g,d);break;case "volumeDown":this.volumeDown(g,d);break;case "setTo":if("undefined"==typeof a.ext||null==a.ext){d&&d(Error("command json invalid"));break}this.setVolume(g,a.ext,d);break;case "setToDB":if("undefined"==typeof a.ext||null==a.ext){d&&d(Error("command json invalid"));break}this.setVolumeDB(g,a.ext,d);break;case "setInput":if(!a.ext){d&&d(Error("command json invalid"));break}this.setInput(g,a.ext,d);break;case "audioMode":if(!a.ext){d&&d(Error("command json invalid"));
break}this.setSurroundMode(g,a.ext,d);break;case "quickSelect":if(!a.ext){d&&d(Error("command json invalid"));break}this.setQuickSelect(g,a.ext,d);break;default:d&&d(Error("unkonwn command"))}}else d&&d(Error("command json invalid"))};h.prototype.getStatesCreator=function(b,a,d){var g={};for(b=0;b<a.length;b++)if(a[b]&&a[b].id&&a[b].status&&a[b].status.value){var f="";a[b].status.path&&a[b].status.path[0]&&(f=a[b].status.path[0]);var m=a[b].status.value,n=m;f&&(n=f+":"+m);g[n]||(g[n]=[]);g[n].push(a[b].id)}var p=
this,r=[],q=Object.keys(g);if(q.length){var t=0,v=function(u,w){u&&(w="?");g[q[t]].forEach(function(x){r.push({id:x,status:w})});t++;t<q.length?p._getStateWithName(q[t],v):d&&d(null,r)};this._getStateWithName(q[t],v)}else d&&d(null,[])};h.prototype._getStateWithName=function(b,a){switch(b){case "global:power":case "power":this.getPower(0,a);break;case "radio:band":this.getRadioBand(a);break;case "radio:preset":this.getRadioPreset(a);break;case "mainzone:volume":this.getVolume(1,function(d,g){a(d,
g)});break;case "mainzone:volumeDB":this.getVolume(1,function(d,g,f){a(d,f)});break;case "mainzone:power":this.getPower(1,a);break;case "mainzone:mute":this.getMute(1,a);break;case "mainzone:input":this.getInput(1,a);break;case "mainzone:audioMode":this.getSurroundMode(1,a);break;case "zone2:volume":this.getVolume(2,function(d,g){a(d,g)});break;case "zone2:volumeDB":this.getVolume(2,function(d,g,f){a(d,f)});break;case "zone2:power":this.getPower(2,a);break;case "zone2:mute":this.getMute(2,a);break;
case "zone2:input":this.getInput(2,a);break;case "zone3:volume":this.getVolume(3,function(d,g){a(d,g)});break;case "zone3:volumeDB":this.getVolume(3,function(d,g,f){a(d,f)});break;case "zone3:power":this.getPower(3,a);break;case "zone3:mute":this.getMute(3,a);break;case "zone3:input":this.getInput(3,a);break;default:a(Error("unknown state key"))}};h.prototype.setPower=function(b,a,d){var g=null,f=null;switch(b){case 0:g="PW";f=a?"ON":"STANDBY";break;case 1:g="ZM";f=a?"ON":"OFF";break;case 2:g="Z2";
f=a?"ON":"OFF";break;case 3:g="Z3",f=a?"ON":"OFF"}g&&f?this._sendCommand(g,f,function(m){m?d&&d(m):setTimeout(function(){d&&d()},1E3)}):d&&d(Error("invalid command"))};h.prototype.togglePower=function(b,a){var d=this;this.getPower(b,function(g,f){g?a&&a(g):(value="on"==f?!1:!0,d.setPower(b,value,a))})};h.prototype.getPower=function(b,a){var d=null;switch(b){case 0:d="PW";break;case 1:d="ZM";break;case 2:d="Z2:POWER";break;case 3:d="Z3:POWER"}this._getState(d,function(g,f){g?a&&a(g):f?a&&a(null,"ON"==
f?"on":"off"):a&&a(null,null)})};h.prototype.volumeUp=function(b,a){var d=null;switch(b){case 1:d="MV";break;case 2:d="Z2";break;case 3:d="Z3"}d?this._sendCommand(d,"UP",function(g){a&&a(g)}):a&&a(Error("invalid command"))};h.prototype.volumeDown=function(b,a){var d=null;switch(b){case 1:d="MV";break;case 2:d="Z2";break;case 3:d="Z3"}d?this._sendCommand(d,"DOWN",function(g){a&&a(g)}):a&&a(Error("invalid command"))};h.prototype.setVolume=function(b,a,d){var g=null;switch(b){case 1:g="MV";break;case 2:g=
"Z2";break;case 3:g="Z3"}if(g){a=parseFloat(a);0>a&&(a=0);98<a&&(a=98);if(Number(a)===a&&0!==a%1)for(a=10*a+"";3>a.length;)a="0"+a;else for(a+="";2>a.length;)a="0"+a;this._sendCommand(g,a,function(f){d&&d(f)})}else d&&d(Error("invalid command"))};h.prototype.setVolumeDB=function(b,a,d){a=parseFloat(a);this.setVolume(b,a+80,d)};h.prototype.getVolume=function(b,a){var d=null;switch(b){case 1:d="MV";break;case 2:d="Z2:VOLUME";break;case 3:d="Z3:VOLUME"}this._getState(d,function(g,f){g?a&&a(g):f?(g=2>=
f.length?parseInt(f):parseInt(f)/10,a&&a(null,g,g-80)):a&&a(null,null)})};h.prototype.setMute=function(b,a,d){var g=null;a=a?"ON":"OFF";switch(b){case 1:g="MU";break;case 2:g="Z2MU";break;case 3:g="Z3MU"}g&&a?this._sendCommand(g,a,function(f){d&&d(f)}):d&&d(Error("invalid command"))};h.prototype.toggleMute=function(b,a){var d=this;this.getMute(b,function(g,f){g?a&&a(g):(value="on"==f?!1:!0,d.setMute(b,value,a))})};h.prototype.getMute=function(b,a){var d=null;switch(b){case 1:d="MU";break;case 2:d=
"Z2MU";break;case 3:d="Z3MU"}this._getState(d,function(g,f){g?a&&a(g):f?a&&a(null,"ON"==f?"on":"off"):a&&a(null,null)})};h.prototype.setInput=function(b,a,d){var g=null;switch(b){case 1:g="SI";break;case 2:g="Z2";break;case 3:g="Z3"}g&&a?this._sendCommand(g,a,function(f){d&&d(f)}):d&&d(Error("invalid command"))};h.prototype.getInput=function(b,a){var d=null;switch(b){case 1:d="SI";break;case 2:d="Z2:INPUT";break;case 3:d="Z3:INPUT"}this._getState(d,function(g,f){g?a&&a(g):a&&a(null,f)})};h.prototype.setSurroundMode=
function(b,a,d){var g=null;switch(b){case 1:g="MS"}g&&a?this._sendCommand(g,a,function(f){d&&d(f)}):d&&d(Error("invalid command"))};h.prototype.getSurroundMode=function(b,a){var d=null;switch(b){case 1:d="MS";break;case 2:d="Z2:INPUT";break;case 3:d="Z3:INPUT"}this._getState(d,function(g,f){g?a&&a(g):a&&a(null,f)})};h.prototype.setQuickSelect=function(b,a,d){var g=null,f=a;f=parseInt(a);if(!f||isNaN(f)||1>f||5<f)d&&d(Error("invalid command value"));else{f="QUICK"+f;switch(b){case 1:g="MS";break;case 2:g=
"Z2";break;case 3:g="Z3"}g&&f?this._sendCommand(g,f,function(m){d&&d(m)}):d&&d(Error("invalid command"))}};h.prototype.previousRadioPreset=function(b){this._sendCommand("TP","ANUP",function(a){b&&b(a)})};h.prototype.nextRadioPreset=function(b){this._sendCommand("TP","ANDOWN",function(a){b&&b(a)})};h.prototype.setRadioPreset=function(b,a){!b||0>parseInt(b)||56<parseInt(b)?a&&a(Error("invalid command")):(b+="",2>b.length&&(b="0"+b),this._sendCommand("TP","AN"+b,function(d){a&&a(d)}))};h.prototype.getRadioPreset=
function(b){this._getState("TPAN",function(a,d){if(a)b&&b(a);else{a="OFF"==d?null:parseInt(d);if(!a||isNaN(a))a=null;b&&b(null,a)}})};h.prototype.setRadioBand=function(b,a){var d=null;switch(b){case "am":d="ANAM";break;case "fm":d="ANFM"}d?this._sendCommand("TM",d,function(g){a&&a(g)}):a&&a(Error("invalid command"))};h.prototype.getRadioBand=function(b){this._getState("TMAN",function(a,d){if(a)b&&b(a);else{a=null;if(d)switch(d.band){case "AM":a="am";break;case "FM":a="fm"}b&&b(null,a)}})};h.prototype._sendCommand=
function(b,a,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.sendCommand(b,a,d)};h.prototype._getState=function(b,a){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getState(b,a)};h.prototype.toJSON=function(){return{sys:"denon",type:"avr2",ip:this._ip,port:this._port,uuid:this._uuid,model:this._model,name:this._name}};h.prototype.equalsTo=function(b){return b&&b instanceof h?this._ip==b._ip&&this._port==b._port:!1};h.parseJSON=
function(b){return b&&b.ip?new h(b):null};h._Socket=k;h._Session=e;h._Controller=c;return h}();xnm.aio.marantz.WebAVR=function(l,c,e,k,h){xnm.aio.denon.WebAVR.call(this,l,c,e,k,h);this._logger=require("x.logger.js").getLogger("xnm.aio.marantz.WebAVR")};xnm.aio.marantz.WebAVR.prototype=new xnm.aio.denon.WebAVR;xnm.aio.marantz.WebAVR.prototype.constructor=xnm.aio.marantz.WebAVR;
xnm.aio.marantz.WebAVR.prototype.toJSON=function(){var l={sys:xnm.aio.denon.DM.MARANTZ_SYS,type:"avr",ip:this.ip,port:this.port,uuid:this.uuid,model:this.model};this.name&&(l.name=this.name);return l};xnm.aio.marantz.WebAVR.prototype.equalsTo=function(l){return l&&l instanceof xnm.aio.marantz.WebAVR?this.ip==l.ip&&this.port==l.port:!1};xnm.aio.marantz.WebAVR.parseJSON=function(l){return l.ip?new xnm.aio.marantz.WebAVR(l.ip,l.port,l.uuid,l.name,l.model):null};
xnm.aio.denon.DM=function(){var l=function(e,k){this.code=e;this.message=k;this.stack=Error().stack};l.prototype=Error();l.prototype.name="DenonDMError";l.prototype.code=0;l.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var c={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",
name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"Quick Select 1",ref:{value:"Quick1"}},{type:"enum",name:"Quick Select 2",ref:{value:"Quick2"}},{type:"enum",name:"Quick Select 3",ref:{value:"Quick3"}},{type:"enum",name:"Quick Select 4",ref:{value:"Quick4"}},{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open denon Remote App",ref:{value:"openNative",value_t:"open_app_denon"}}]},{type:"root",name:"Internetradio",
value:"netradio",children:[{type:"enum",name:"play/pause",ref:{value:"playPause"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",
ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"float",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%f",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;Online Music;Bluetooth;Internetradio;Media Server;CD;PHONO".split(";")}},
{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner to preset",ref:{value:"tuner",ext:"%d",extMeta:"1-50",scale:"1"}},{type:"enum",name:"set sound modus",ref:{value:"audioMode",ext:"%e",extMeta:"Direct;Stereo;Dolby Surrounds;DTS Surrounds;Auto;Multi Ch Stereo;Super Stadium;Rock Arena;Jazz Club;Classic Concert;Mono Movie;Matrix;Video Game;Virtual".split(";")}}]},{type:"root",name:"zone 2",value:"zone2",
children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",
extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;Media Player;iPod/USB;Tuner;Online Music;Bluetooth;Internetradio;Media Server;Source".split(";")}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner to preset",ref:{value:"tuner",
ext:"%d",extMeta:"1-50",scale:"1"}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},
{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;Media Player;iPod/USB;Tuner;Online Music;Bluetooth;Internetradio;Media Server;Source".split(";")}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},
{type:"int",name:"set tuner to preset",ref:{value:"tuner",ext:"%d",extMeta:"1-50",scale:"1"}}]}],status:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on",
"off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"string",name:"input",ref:{value:"input"}},{type:"enum",name:"original input",ref:{value:"originalInput",options:"CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;NETHOME;Bluetooth;Internetradio;SERVER;CD;PHONO".split(";")}},{type:"enum",name:"sound modus",ref:{value:"audioMode",options:"Direct;Stereo;Dolby Surrounds;DTS Surrounds;Auto;Multi Ch Stereo;Super Stadium;Rock Arena;Jazz Club;Classic Concert;Mono Movie;Matrix;Video Game;Virtual".split(";")}}]},
{type:"root",name:"zone 2",value:"zone2",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"string",name:"input",ref:{value:"input"}},{type:"enum",name:"original input",ref:{value:"originalInput",options:"CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;NETHOME;Bluetooth;Internetradio;SERVER;CD;PHONO".split(";")}}]},
{type:"root",name:"zone 3",value:"zone3",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"string",name:"input",ref:{value:"input"}},{type:"enum",name:"original input",ref:{value:"originalInput",options:"CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;NETHOME;Bluetooth;Internetradio;SERVER;CD;PHONO".split(";")}}]}]},
avr2:{command:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open denon Remote App",ref:{value:"openNative",value_t:"open_app_denon"}}]},{type:"root",name:"tuner",value:"radio",children:[{type:"enum",name:"set band",ref:{value:"band",ext:"%e",extMeta:["am",
"fm"]}},{type:"enum",name:"previous preset",ref:{value:"previousPreset"}},{type:"enum",name:"next preset",ref:{value:"nextPreset"}},{type:"int",name:"preset",ref:{value:"preset",ext:"%d",extMeta:"1-56"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},
{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"float",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%f",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}},
{type:"enum",name:"set sound modus",ref:{value:"audioMode",ext:"%e",extMeta:"MOVIE;MUSIC;GAME;DIRECT;PURE DIRECT;STEREO;AUTO;DOLBY DIGITAL;DTS SURROUND;AURO3D;AURO2DSURR;MCH STEREO;WIDE SCREEN;SUPER STADIUM;ROCK ARENA;JAZZ CLUB;CLASSIC CONCERT;MONO MOVIE;MATRIX;VIDEO GAME;VIRTUAL".split(";")}},{type:"int",name:"quick select",ref:{value:"quickSelect",ext:"%d",extMeta:"1-5"}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",
ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",
ext:"%f",extMeta:"-80.0-18.0",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}},{type:"int",name:"quick select",ref:{value:"quickSelect",ext:"%d",extMeta:"1-5"}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",
ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"1"}},
{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}},{type:"int",name:"quick select",ref:{value:"quickSelect",ext:"%d",extMeta:"1-5"}}]}],status:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},{type:"root",name:"radio",value:"radio",children:[{type:"enum",name:"band",ref:{value:"band",
options:["am","fm"]}},{type:"int",name:"current preset",ref:{value:"preset",extMeta:"1-56"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (db)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",
options:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}},{type:"enum",name:"sound modus",ref:{value:"audioMode",options:"MOVIE;MUSIC;GAME;DIRECT;PURE DIRECT;STEREO;AUTO;DOLBY DIGITAL;DTS SURROUND;AURO3D;AURO2DSURR;MCH STEREO;WIDE SCREEN;SUPER STADIUM;ROCK ARENA;JAZZ CLUB;CLASSIC CONCERT;MONO MOVIE;MATRIX;VIDEO GAME;VIRTUAL".split(";")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"float",name:"volume",
ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}}]},{type:"root",name:"zone 3",value:"zone3",
children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}}]}]}};
return{SYS:"denon",MARANTZ_SYS:"marantz",getIPDeviceType:function(){return[{sys:this.SYS,name:"Denon AV Receiver",type:"avr"},{sys:this.SYS,name:"Denon AV Receiver - 2018",type:"avr2"},{sys:this.MARANTZ_SYS,name:"Marantz AV Receiver",type:"avr"}]},createDevice:function(e,k,h){k=l.ERROR_CODE;e?e.ip?h(null,e):h(new l(k.INVALID,"ip is invalid")):h(new l(k.INVALID,"info is invalid"))},updateDevice:function(e,k,h){k=l.ERROR_CODE;e?e.ip?h(null,e):h(new l(k.INVALID,"ip is invalid")):h(new l(k.INVALID,"info is invalid"))},
deleteDevice:function(e,k,h){h()},applyUIFilter:function(e,k,h){var b=this,a=function(m,n,p){var r=[];m.forEach(function(q){if("root"==q.type){q=JSON.parse(JSON.stringify(q));var t=a(q.children,n,p);t&&0<t.length&&(q.children=t,r.push(q))}else{t=p.elems;if("*"==t)t=!0;else{for(var v=!1,u=0;u<t.length;u++)if(t[u]==q.type){v=!0;break}t=v}t&&(q=JSON.parse(JSON.stringify(q)),r.push(q))}});return r},d=function(m,n){var p=[],r=b.getCommandStatusMap(m,h);if(r){var q=[];switch(n.catagory){case "command":r.command&&
(q=a(r.command,m,n));break;case "status":r.status&&(q=a(r.status,m,n))}p=p.concat(q)}return p};if(!e.sys)return null;var g=JSON.parse(JSON.stringify(e)),f=null;switch(k.catagory){case "command":f=d(e,k);g.command=f;break;case "status":f=d(e,k);g.status=f;break;default:return null}return f&&0!=f.length?g:null},getCommandStatusMap:function(e){if(!e||!e.type)return null;if(e.sys==this.MARANTZ_SYS){if(!c[e.type])return null;e=JSON.parse(JSON.stringify(c[e.type]));if(e.command&&e.command[0]&&e.command[0].children){for(var k=
-1,h=e.command[0].children,b=0;b<h.length;b++)if(h[b]&&h[b].ref&&h[b].ref.value&&"openNative"==h[b].ref.value){k=b;break}-1!=k&&(h[b].name="open marantz Remote App")}return e}return c[e.type]}}}();
xnm.aio.denon.Handler=function(){var l=function(){this.detectedAVRs={};this.detectedMarantzAVRs={}};l.prototype.AVR=xnm.aio.denon.WebAVR;l.prototype.MarantzAVR=xnm.aio.marantz.WebAVR;l.prototype.AVR2=xnm.aio.denon.AVR2;l.prototype.devicemanager=xnm.aio.denon.DM;l.prototype.registModule=function(c){c.register(this.devicemanager.SYS,"denon");c.register(this.devicemanager.MARANTZ_SYS,"denon")};l.prototype.resolveDevice=function(c){if(!c)return null;switch(c.sys){case this.devicemanager.SYS:switch(c.type){case "avr":return this.AVR.parseJSON(c);
case "avr2":return this.AVR2.parseJSON(c);default:return null}case this.devicemanager.MARANTZ_SYS:switch(c.type){case "avr":return this.MarantzAVR.parseJSON(c);default:return null}default:return null}};l.prototype.getDeviceCommands=function(c,e){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];e&&e(null,c)};l.prototype.getDeviceStatus=function(c,e){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];e&&e(null,c)};l.prototype.doCommand=
function(c,e,k){var h=this.resolveDevice(c);h?h.executeCommandCreator(c,e,function(b){k&&k(b)}):k&&k(Error("device json format invalid"))};l.prototype.doStatus=function(c,e,k,h){var b=this.resolveDevice(e);b?b.getStatesCreator(null,[{id:c,device:e,status:k}],function(a,d){a?h&&h(a):h&&h(null,d[0])}):h&&h(Error("device json format invalid"))};l.prototype.discoverDevices=function(c){var e=require("x.upnp.js");if(e){var k=this;e.discoverDevicesWithTimeout(3E3,function(h){if(0==h.name.indexOf("Denon AVR")){var b=
h.modelName;b&&"*"==b.charAt(0)&&(b=b.substr(1));b=new xnm.aio.denon.AVR2({ip:h.ip,port:null,uuid:h.uuid,name:h.name,model:b});k.detectedAVRs["uuid:"+h.uuid]||(k.detectedAVRs["uuid:"+h.uuid]=b);c(b)}})}};l.prototype.discoverWithTimeout=function(c,e){var k={};this.discoverDevices(function(h){h&&h._uuid&&!k[h._uuid]&&(k[h._uuid]=h)});setTimeout(function(){var h=[],b;for(b in k)k.hasOwnProperty(b)&&h.push(k[b]);e&&e(null,h)},c)};l.prototype.discoverMarantz=function(c){var e=require("x.upnp.js");if(e){var k=
this;e.discoverDevicesWithTimeout(3E3,function(h){if(h.name&&0==h.name.toLowerCase().indexOf("marantz")){var b=h.modelName;b&&"*"==b.charAt(0)&&(b=b.substr(1));b=new xnm.aio.marantz.WebAVR(h.ip,null,h.uuid,h.name,b);k.detectedMarantzAVRs["uuid:"+h.uuid]||(k.detectedMarantzAVRs["uuid:"+h.uuid]=b);c(b)}})}};l.prototype.discoverMarantzWithTimeout=function(c,e){var k={};this.discoverMarantz(function(h){h&&h.uuid&&!k[h.uuid]&&(k[h.uuid]=h)});setTimeout(function(){var h=[],b;for(b in k)k.hasOwnProperty(b)&&
h.push(k[b]);e&&e(null,h)},c)};l.prototype.getStateValues=function(c,e){return(new xnm.aio.denon.WebAVR).getStateValues(c.type,e)};l.prototype.getDeviceCommandList=function(c,e,k){var h=[];if(e)h.push({id:window.XC_Text.on,cmd:"on"}),h.push({id:window.XC_Text.off,cmd:"off"});else if(k&&"avr"==c.type){h.push({id:"on",cmd:"on"});h.push({id:"off",cmd:"off"});h.push({id:"toggle",cmd:"toggle"});h.push({id:"volumeDown",cmd:"volumeDown"});h.push({id:"volumeUp",cmd:"volumeUp"});h.push({id:"mute",cmd:"mute"});
h.push({id:"unmute",cmd:"unmute"});h.push({id:"toggleMute",cmd:"toggleMute"});k=h.length;for(c=0;c<k;c++)e=JSON.parse(JSON.stringify(h[c])),e.ch="mainzone",h.push(e),e=JSON.parse(JSON.stringify(h[c])),e.ch="zone2",h.push(e);h.push({id:"set volume",cmd:"setTo",step:"0.5",max:"98",ch:"mainzone"});h.push({id:"set volume",cmd:"setTo",step:"1",max:"80",ch:"zone2"});var b=[];b.push({id:"CBLSAT",cmd:"CBLSAT"});b.push({id:"DVDBlu-ray",cmd:"DVDBlu-ray"});b.push({id:"Blu-ray",cmd:"Blu-ray"});b.push({id:"Game",
cmd:"Game"});b.push({id:"AUX",cmd:"AUX"});b.push({id:"AUX2",cmd:"AUX2"});b.push({id:"MediaPlayer",cmd:"MediaPlayer"});b.push({id:"iPodUSB",cmd:"iPodUSB"});b.push({id:"TVAudio",cmd:"TVAudio"});b.push({id:"Tuner",cmd:"Tuner"});b.push({id:"NETHOME",cmd:"NETHOME"});b.push({id:"Bluetooth",cmd:"Bluetooth"});b.push({id:"IRADIO",cmd:"IRADIO"});b.push({id:"SERVER",cmd:"SERVER"});b.push({id:"CD",cmd:"CD"});b.push({id:"PHONO",cmd:"PHONO"});b.push({id:"HDRADIO",cmd:"HDRADIO"});b.push({id:"tunerUp",cmd:"tunerUp"});
b.push({id:"tunerDown",cmd:"tunerDown"});b.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",max:"50"});k=b.length;for(c=0;c<k;c++)e=JSON.parse(JSON.stringify(b[c])),e.ch="mainzone",h.push(e),e=JSON.parse(JSON.stringify(b[c])),e.ch="zone2",h.push(e);e=(new xnm.aio.denon.WebAVR).audioModes;for(c=0;c<e.length;c++)h.push({id:e[c],cmd:e[c]});h.push({id:"Quick1",cmd:"Quick1"});h.push({id:"Quick2",cmd:"Quick2"});h.push({id:"Quick3",cmd:"Quick3"});h.push({id:"Quick4",cmd:"Quick4"});h.push({id:"playPause",
cmd:"playPause"});h.push({id:"previous",cmd:"previous"});h.push({id:"next",cmd:"next"})}return h};return l}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.denon.Handler);
