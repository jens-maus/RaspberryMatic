var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.edimax=xnm.aio.edimax||{},xnm.aio.edimax.SmartPlug=function(e,t){this.ip=e,this.port=1e4,this.uuid=null,this.user="admin",this.password="1234",t&&(this.password=t),this._state="?",this.data="switch",this.model=null,this.CommandHandler=null;},xnm.aio.edimax.SmartPlug.prototype._doRequest=function(e,t,a){var i={host:this.ip,port:this.port,path:"/smartplug.cgi",method:"POST",headers:{"Content-Length":e.length,Connection:"close"}};a?i.headers.Authorization=a:this.user&&(this.password||(this.password=""),i.user=this.user,i.password=this.password?this.password:"",i.headers.Authorization="Basic "+new Buffer(this.user+":"+(this.password?this.password:"")).toString("base64"));var o=this,n=require("http").request(i,function(n){if(401==n.statusCode&&!a&&n.headers&&n.headers["www-authenticate"]&&"Digest "==n.headers["www-authenticate"].substr(0,7)){a=null;var r=require("x.crypt.js");(a=r.DigestAuth(n.headers["www-authenticate"],i.path,o.user,o.password,i.method))?(a+=', opaque=""',XC.debugf("do digest auth:"+a),o._doRequest(e,t,a)):t&&t(null);}else if(200==n.statusCode){n.setEncoding("utf-8");var s="";n.on("data",function(e){s+=e;}),n.on("end",function(){t&&t(s);});}else XC.debugf("Failed to post request to "+o.ip),t&&t(null);});n.setTimeout(1e3,function(){n.abort();}),n.on("error",function(e){t&&t(null);}),e&&n.write(e),n.end();},xnm.aio.edimax.SmartPlug.prototype.getState=function(e){this._doRequest('<?xml version="1.0" encoding="UTF8"?><SMARTPLUG id="edimax"><CMD id="get"><Device.System.Power.State></Device.System.Power.State><NOW_POWER><Device.System.Power.NowCurrent></Device.System.Power.NowCurrent><Device.System.Power.NowPower></Device.System.Power.NowPower></NOW_POWER></CMD></SMARTPLUG>',function(t){var a={state:"?",current:"?",power:"?"},i=$($.parseXML(t)),o=i.find("Device\\.System\\.Power\\.State");if(o.length>0){var n=$(o[0]).text();"ON"==n?a.state="on":"OFF"==n&&(a.state="off");}(o=i.find("Device\\.System\\.Power\\.NowCurrent")).length>0&&(a.power=parseFloat($(o[0]).text()).toFixed(2)),(o=i.find("Device\\.System\\.Power\\.NowPower")).length>0&&(a.current=parseFloat($(o[0]).text()).toFixed(1)),e&&e(a);});},xnm.aio.edimax.SmartPlug.prototype.executeCommand=function(e,t,a){var i="OFF";if("on"==t)i="ON";else if("toggle"==t){var o=this;return void this.getState(function(e){"off"==e.state&&(i="ON");var t='<?xml version="1.0" encoding="UTF8"?><SMARTPLUG id="edimax"><CMD id="setup"><Device.System.Power.State>'+i+"</Device.System.Power.State></CMD></SMARTPLUG>";o._doRequest(t,function(e){a&&a();});});}var n='<?xml version="1.0" encoding="UTF8"?><SMARTPLUG id="edimax"><CMD id="setup"><Device.System.Power.State>'+i+"</Device.System.Power.State></CMD></SMARTPLUG>";this._doRequest(n,function(e){a&&a();});},xnm.aio.edimax.SmartPlug.prototype.getStates=function(e,t,a){var i=this;this.CommandHandler=e,this.getState(function(e){e&&t&&i.CommandHandler.setState?(i.CommandHandler.setState(t.id,e.state),i.CommandHandler.setState(t.id+":current",e.current),i.CommandHandler.setState(t.id+":power",e.power)):i.CommandHandler.receivedState&&i.CommandHandler.receivedState("edimax",i.ip,e),a&&a(e);});},xnm.aio.edimax.SmartPlug.prototype.getStateValues=function(e){return e;},xnm.aio.edimax.SmartPlug.prototype.executeCommandCreator=function(e,t,a){if(console.error("!!!!!",e,t),t&&t.value){var i=t.value;this.executeCommand(e,i,function(e){a&&a(e);});}else a&&a(new Error("command value is empty"));},xnm.aio.edimax.SmartPlug.prototype.getStatesCreator=function(e,t,a){this.getState(function(e){if(e){for(var i=[],o=0;o<t.length;o++){var n=t[o];if(n&&n.id&&n.status)switch(n.status.value){case"state":e.state&&"?"!=typeof e.state&&i.push({id:n.id,status:e.state});break;case"current":null!=e.current&&void 0!==e.current&&"?"!=e.current&&i.push({id:n.id,status:e.current});break;case"power":null!=e.power&&void 0!==e.power&&"?"!=e.power&&i.push({id:n.id,status:e.power});}}a&&a(null,i);}else a&&a(new Error("get state error"));});},xnm.aio.edimax.SmartPlug.prototype.toJSON=function(){return{sys:xnm.aio.edimax.DM.SYS,ip:this.ip,port:this.port,password:this.password,uuid:this.uuid,type:"smartplug",data:this.data,model:this.model};},xnm.aio.edimax.SmartPlug.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.edimax.SmartPlug&&this.ip==e.ip&&this.port==e.port&&this.password==e.password&&this.data==e.data;},xnm.aio.edimax.Discovery=function(){this.Devices={},this._tmpCallbacks=[],this.callback=null,this._sockets=[];var e=require("os");if(require("dgram"),e&&e.networkInterfaces){var t=e.networkInterfaces();for(var a in t)for(var i=t[a],o=0;o<i.length;o++)this._addDiscoverSocket(null,i[o]);}else this._addDiscoverSocket(null,null);},xnm.aio.edimax.Discovery.prototype._getMAC=function(e){for(var t="",a=0;a<5;a++)t+=xnm.aio.edimax.Util.getHexVal(e[a],2).toUpperCase()+"-";return t+xnm.aio.edimax.Util.getHexVal(e[a],2).toUpperCase();},xnm.aio.edimax.Discovery.prototype._receivedData=function(e,t){if(t=t.toString("hex"),186==(t=new Buffer(t,"hex")).length){this.Devices[e]=new xnm.aio.edimax.SmartPlug(e),this.Devices[e].uuid=this._getMAC(t.slice(0,6));var a=t.toString("hex");if(a.indexOf("53503131303157")>0?(this.Devices[e].data="switch",this.Devices[e].model="SP1101W"):a.indexOf("53503231303157")>0&&(this.Devices[e].data="powerswitch",this.Devices[e].model="SP2101W"),this.callback&&this.Devices[e]&&this.callback(this.Devices[e]),this._tmpCallbacks&&this.Devices[e])for(var i=0;i<this._tmpCallbacks.length;i++)this._tmpCallbacks[i](this.Devices[e]);}},xnm.aio.edimax.Discovery.prototype._addDiscoverSocket=function(e,t){var a,i=require("dgram"),o=this;t?"IPv4"==t.family&&0==t.internal&&((a=i.createSocket("udp4")).on("listening",function(){a.setBroadcast(!0);}),a.on("message",function(e,t){o._receivedData(t.address,e);}),a.bind(e,t.address),this._sockets.push(a)):((a=i.createSocket("udp4")).on("message",function(e,t){o._receivedData(t.address,e);}),a.bind(e),this._sockets.push(a));},xnm.aio.edimax.Discovery.prototype._sendDiscoveryMessages=function(e,t,a,i){e=new Buffer([255,255,255,255,255,255,69,68,73,77,65,88,0,0,0,0,0,0,0,161,255,94]);for(var o=0;o<2;o++)for(var n=0;n<this._sockets.length;n++)this._sockets[n].send(e,0,e.length,20560,"255.255.255.255");},xnm.aio.edimax.Discovery.prototype.discoverDevices=function(){this._sendDiscoveryMessages();},xnm.aio.edimax.Discovery.prototype.addTmpCallback=function(e){for(var t=0;t<this._tmpCallbacks.length;t++)if(this._tmpCallbacks[t]===e)return;this._tmpCallbacks.push(e);},xnm.aio.edimax.Discovery.prototype.delTmpCallback=function(e){for(var t=-1,a=0;a<this._tmpCallbacks.length;a++)this._tmpCallbacks[a]===e&&(t=a);t>=0&&this._tmpCallbacks.slice(t,1);},xnm.aio.edimax.Util={getHexVal:function getHexVal(e,t){for(var a=e.toString(16).toUpperCase();a.length<t;)a="0"+a;return a;}},xnm.aio.edimax.DMError=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.edimax.prototype=new Error(),xnm.aio.edimax.prototype.name="EdimaxDMError",xnm.aio.edimax.prototype.code=0,xnm.aio.edimax.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.edimax.DM={SYS:"edimax",MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"status",ref:{value:"state",options:["off","on"]}}]},powerswitch:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"current",ref:{value:"current",ext:"%f",scale:"0.1"}},{type:"float",name:"power",ref:{value:"power",ext:"%f",scale:"0.01"}}]}},getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Edimax Smart Plug",port:1e4}];},createDevice:function createDevice(e,t,a){var i=xnm.aio.edimax.DMError,o=i,n=i.ERROR_CODE;e?e.ip?e.password?e.type?e.data?a(null,e):a(new o(n.INVALID,"data is invalid")):a(new o(n.INVALID,"type is invalid")):a(new o(n.INVALID,"password is invalid")):a(new o(n.INVALID,"ip is invalid")):a(new o(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var i=xnm.aio.edimax.DMError,o=i,n=i.ERROR_CODE;e?e.ip?e.password?e.type?e.data?a(null,e):a(new o(n.INVALID,"data is invalid")):a(new o(n.INVALID,"type is invalid")):a(new o(n.INVALID,"password is invalid")):a(new o(n.INVALID,"ip is invalid")):a(new o(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},getCommandStatusMap:function getCommandStatusMap(e){return e.data?this.MAP[e.data]:null;},applyUIFilter:function applyUIFilter(e,t){var a=function a(e,t){if("*"==e)return!0;for(var a=!1,i=0;i<e.length;i++)if(e[i]==t){a=!0;break;}return a;},i=function i(e,t){var i=[],o=null,n=xnm.aio.edimax.DM.getCommandStatusMap(e);return n&&(o=function(e,t,i){var o=[];switch(i.catagory){case"command":e.command&&e.command.forEach(function(e){if(a(i.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(a(i.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});}return o;}(n,0,t),i=i.concat(o)),i;};if(!e.sys)return null;var o=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=i(e,t),o.command=n;break;case"status":n=i(e,t),o.status=n;break;default:return null;}return n&&0!=n.length?o:null;}},xnm.aio.edimax.Handler=function(){this._Discovery=new xnm.aio.edimax.Discovery(),this._Discovery.discoverDevices();},xnm.aio.edimax.Handler.prototype.discoverDevices=function(e){e&&(this._Discovery.callback=e),this._Discovery.discoverDevices();},xnm.aio.edimax.Handler.prototype.getStateValues=function(e,t){return new xnm.aio.edimax.SmartPlug().getStateValues(t);},xnm.aio.edimax.Handler.prototype.getDeviceCommandList=function(e,t){var a=[];return a.push({id:window.XC_Text.on,cmd:"on"}),a.push({id:window.XC_Text.off,cmd:"off"}),a;},xnm.aio.edimax.Handler.prototype.getDevice=function(e){return e.address?new xnm.aio.edimax.SmartPlug(e.address,e.pwd):null;},xnm.aio.edimax.Handler.prototype.SmartPlug=xnm.aio.edimax.SmartPlug,xnm.aio.edimax.Handler.prototype.devicemanager=xnm.aio.edimax.DM,xnm.aio.edimax.Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"edimax");},xnm.aio.edimax.Handler.prototype.resolveDevice=function(e){if(!(e&&e.ip&&e.password&&e.type&&e.data))return null;if("smartplug"!=e.type.toLowerCase())return null;var t=new xnm.aio.edimax.SmartPlug(e.ip,e.password);return t.port=e.port?e.port:t.port,t.uuid=e.uuid,t.data=e.data,t;},xnm.aio.edimax.Handler.prototype.discoverDevicesWithTimeout=function(e,t){var a=[],i=function i(e){if(e){for(var t=!1,i=0;i<a.length;i++)if(a[i].uuid==e.uuid){t=!0;break;}t||a.push(e);}};this._Discovery.addTmpCallback(i),this._Discovery.discoverDevices();var o=this;setTimeout(function(){t&&t(null,a),o._Discovery.delTmpCallback(i);},e);},xnm.aio.edimax.Handler.prototype.getDeviceCommands=function(e,t){var a=xnm.aio.edimax.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),i=a?a.command:[];t&&t(null,i);},xnm.aio.edimax.Handler.prototype.getDeviceStatus=function(e,t){var a=xnm.aio.edimax.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),i=a?a.status:[];t&&t(null,i);},xnm.aio.edimax.Handler.prototype.doCommand=function(e,t,a){var i=this.resolveDevice(e);i?i.executeCommandCreator(e,t,function(e){a&&a(e);}):a&&a(new Error("device json invalid"));},xnm.aio.edimax.Handler.prototype.doStatus=function(e,t,a,i){var o=this.resolveDevice(t);if(o){var n=[{id:e,device:t,status:a}];o.getStatesCreator(null,n,function(e,t){e?i&&i(e):i&&i(null,t[0]);});}else i&&i(new Error("device json invalid"));},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.edimax.Handler());