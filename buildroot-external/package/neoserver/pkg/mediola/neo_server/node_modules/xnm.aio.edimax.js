var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var g=a[e];if(b.call(c,g,e,a))return{i:e,v:g}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.edimax=xnm.aio.edimax||{};xnm.aio.edimax.SmartPlug=function(a,b){this.ip=a;this.port=1E4;this.uuid=null;this.user="admin";this.password="1234";b&&(this.password=b);this._state="?";this.data="switch";this.CommandHandler=this.model=null};
xnm.aio.edimax.SmartPlug.prototype._doRequest=function(a,b,c){var d={host:this.ip,port:this.port,path:"/smartplug.cgi",method:"POST",headers:{"Content-Length":a.length,Connection:"close"}};c?d.headers.Authorization=c:this.user&&(this.password||(this.password=""),d.user=this.user,d.password=this.password?this.password:"",d.headers.Authorization="Basic "+(new Buffer(this.user+":"+(this.password?this.password:""))).toString("base64"));var e=this,g=require("http").request(d,function(f){if(401==f.statusCode&&
!c&&f.headers&&f.headers["www-authenticate"]&&"Digest "==f.headers["www-authenticate"].substr(0,7))c=null,(c=require("x.crypt.js").DigestAuth(f.headers["www-authenticate"],d.path,e.user,e.password,d.method))?(c+=', opaque=""',XC.debugf("do digest auth:"+c),e._doRequest(a,b,c)):b&&b(null);else if(200==f.statusCode){f.setEncoding("utf-8");var g="";f.on("data",function(a){g+=a});f.on("end",function(){b&&b(g)})}else XC.debugf("Failed to post request to "+e.ip),b&&b(null)});g.setTimeout(1E3,function(){g.abort()});
g.on("error",function(a){b&&b(null)});a&&g.write(a);g.end()};
xnm.aio.edimax.SmartPlug.prototype.getState=function(a){this._doRequest('<?xml version="1.0" encoding="UTF8"?><SMARTPLUG id="edimax"><CMD id="get"><Device.System.Power.State></Device.System.Power.State><NOW_POWER><Device.System.Power.NowCurrent></Device.System.Power.NowCurrent><Device.System.Power.NowPower></Device.System.Power.NowPower></NOW_POWER></CMD></SMARTPLUG>',function(b){var c={state:"?",current:"?",power:"?"};b=$($.parseXML(b));var d=b.find("Device\\.System\\.Power\\.State");0<d.length&&
(d=$(d[0]).text(),"ON"==d?c.state="on":"OFF"==d&&(c.state="off"));d=b.find("Device\\.System\\.Power\\.NowCurrent");0<d.length&&(c.power=parseFloat($(d[0]).text()).toFixed(2));d=b.find("Device\\.System\\.Power\\.NowPower");0<d.length&&(c.current=parseFloat($(d[0]).text()).toFixed(1));a&&a(c)})};
xnm.aio.edimax.SmartPlug.prototype.executeCommand=function(a,b,c){var d="OFF";if("on"==b)d="ON";else if("toggle"==b){var e=this;this.getState(function(a){"off"==a.state&&(d="ON");e._doRequest('<?xml version="1.0" encoding="UTF8"?><SMARTPLUG id="edimax"><CMD id="setup"><Device.System.Power.State>'+d+"</Device.System.Power.State></CMD></SMARTPLUG>",function(a){c&&c()})});return}this._doRequest('<?xml version="1.0" encoding="UTF8"?><SMARTPLUG id="edimax"><CMD id="setup"><Device.System.Power.State>'+
d+"</Device.System.Power.State></CMD></SMARTPLUG>",function(a){c&&c()})};xnm.aio.edimax.SmartPlug.prototype.getStates=function(a,b,c){var d=this;this.CommandHandler=a;this.getState(function(a){a&&b&&d.CommandHandler.setState?(d.CommandHandler.setState(b.id,a.state),d.CommandHandler.setState(b.id+":current",a.current),d.CommandHandler.setState(b.id+":power",a.power)):d.CommandHandler.receivedState&&d.CommandHandler.receivedState("edimax",d.ip,a);c&&c(a)})};
xnm.aio.edimax.SmartPlug.prototype.getStateValues=function(a){return a};xnm.aio.edimax.SmartPlug.prototype.executeCommandCreator=function(a,b,c){console.error("!!!!!",a,b);b&&b.value?this.executeCommand(a,b.value,function(a){c&&c(a)}):c&&c(Error("command value is empty"))};
xnm.aio.edimax.SmartPlug.prototype.getStatesCreator=function(a,b,c){this.getState(function(a){if(a){for(var d=[],g=0;g<b.length;g++){var f=b[g];if(f&&f.id&&f.status)switch(f.status.value){case "state":a.state&&"?"!=typeof a.state&&d.push({id:f.id,status:a.state});break;case "current":null!=a.current&&"undefined"!=typeof a.current&&"?"!=a.current&&d.push({id:f.id,status:a.current});break;case "power":null!=a.power&&"undefined"!=typeof a.power&&"?"!=a.power&&d.push({id:f.id,status:a.power})}}c&&c(null,
d)}else c&&c(Error("get state error"))})};xnm.aio.edimax.SmartPlug.prototype.toJSON=function(){return{sys:xnm.aio.edimax.DM.SYS,ip:this.ip,port:this.port,password:this.password,uuid:this.uuid,type:"smartplug",data:this.data,model:this.model}};xnm.aio.edimax.SmartPlug.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.edimax.SmartPlug?this.ip==a.ip&&this.port==a.port&&this.password==a.password&&this.data==a.data:!1};
xnm.aio.edimax.Discovery=function(){this.Devices={};this._tmpCallbacks=[];this.callback=null;this._sockets=[];var a=require("os");require("dgram");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var b in a)for(var c=a[b],d=0;d<c.length;d++)this._addDiscoverSocket(null,c[d])}else this._addDiscoverSocket(null,null)};
xnm.aio.edimax.Discovery.prototype._getMAC=function(a){for(var b="",c=0;5>c;c++)b+=xnm.aio.edimax.Util.getHexVal(a[c],2).toUpperCase()+"-";return b+=xnm.aio.edimax.Util.getHexVal(a[c],2).toUpperCase()};
xnm.aio.edimax.Discovery.prototype._receivedData=function(a,b){b=b.toString("hex");b=new Buffer(b,"hex");if(186==b.length&&(this.Devices[a]=new xnm.aio.edimax.SmartPlug(a),this.Devices[a].uuid=this._getMAC(b.slice(0,6)),b=b.toString("hex"),0<b.indexOf("53503131303157")?(this.Devices[a].data="switch",this.Devices[a].model="SP1101W"):0<b.indexOf("53503231303157")&&(this.Devices[a].data="powerswitch",this.Devices[a].model="SP2101W"),this.callback&&this.Devices[a]&&this.callback(this.Devices[a]),this._tmpCallbacks&&
this.Devices[a]))for(b=0;b<this._tmpCallbacks.length;b++)this._tmpCallbacks[b](this.Devices[a])};
xnm.aio.edimax.Discovery.prototype._addDiscoverSocket=function(a,b){var c=require("dgram"),d=this;if(b)"IPv4"==b.family&&0==b.internal&&(e=c.createSocket("udp4"),e.on("listening",function(){e.setBroadcast(!0)}),e.on("message",function(a,b){d._receivedData(b.address,a)}),e.bind(a,b.address),this._sockets.push(e));else{var e=c.createSocket("udp4");e.on("message",function(a,b){d._receivedData(b.address,a)});e.bind(a);this._sockets.push(e)}};
xnm.aio.edimax.Discovery.prototype._sendDiscoveryMessages=function(a,b,c,d){a=new Buffer([255,255,255,255,255,255,69,68,73,77,65,88,0,0,0,0,0,0,0,161,255,94]);for(b=0;2>b;b++)for(c=0;c<this._sockets.length;c++)this._sockets[c].send(a,0,a.length,20560,"255.255.255.255")};xnm.aio.edimax.Discovery.prototype.discoverDevices=function(){this._sendDiscoveryMessages()};
xnm.aio.edimax.Discovery.prototype.addTmpCallback=function(a){for(var b=0;b<this._tmpCallbacks.length;b++)if(this._tmpCallbacks[b]===a)return;this._tmpCallbacks.push(a)};xnm.aio.edimax.Discovery.prototype.delTmpCallback=function(a){for(var b=-1,c=0;c<this._tmpCallbacks.length;c++)this._tmpCallbacks[c]===a&&(b=c);0<=b&&this._tmpCallbacks.slice(b,1)};xnm.aio.edimax.Util={getHexVal:function(a,b){for(a=a.toString(16).toUpperCase();a.length<b;)a="0"+a;return a}};
xnm.aio.edimax.DMError=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};xnm.aio.edimax.prototype=Error();xnm.aio.edimax.prototype.name="EdimaxDMError";xnm.aio.edimax.prototype.code=0;xnm.aio.edimax.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.edimax.DM={SYS:"edimax",MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"status",ref:{value:"state",options:["off","on"]}}]},powerswitch:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},
{type:"float",name:"current",ref:{value:"current",ext:"%f",scale:"0.1"}},{type:"float",name:"power",ref:{value:"power",ext:"%f",scale:"0.01"}}]}},getIPDeviceType:function(){return[{sys:this.SYS,name:"Edimax Smart Plug",port:1E4}]},createDevice:function(a,b,c){b=xnm.aio.edimax.DMError;var d=b.ERROR_CODE;a?a.ip?a.password?a.type?a.data?c(null,a):c(new b(d.INVALID,"data is invalid")):c(new b(d.INVALID,"type is invalid")):c(new b(d.INVALID,"password is invalid")):c(new b(d.INVALID,"ip is invalid")):c(new b(d.INVALID,
"info is invalid"))},updateDevice:function(a,b,c){b=xnm.aio.edimax.DMError;var d=b.ERROR_CODE;a?a.ip?a.password?a.type?a.data?c(null,a):c(new b(d.INVALID,"data is invalid")):c(new b(d.INVALID,"type is invalid")):c(new b(d.INVALID,"password is invalid")):c(new b(d.INVALID,"ip is invalid")):c(new b(d.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},getCommandStatusMap:function(a){return a.data?this.MAP[a.data]:null},applyUIFilter:function(a,b){var c=function(a,b){if("*"==a)return!0;for(var c=
!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},d=function(a,b,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=[],e=xnm.aio.edimax.DM.getCommandStatusMap(a);e&&(a=d(e,a,b),c=c.concat(a));return c};if(!a.sys)return null;var g=JSON.parse(JSON.stringify(a)),
f=null;switch(b.catagory){case "command":f=e(a,b);g.command=f;break;case "status":f=e(a,b);g.status=f;break;default:return null}return f&&0!=f.length?g:null}};xnm.aio.edimax.Handler=function(){this._Discovery=new xnm.aio.edimax.Discovery;this._Discovery.discoverDevices()};xnm.aio.edimax.Handler.prototype.discoverDevices=function(a){a&&(this._Discovery.callback=a);this._Discovery.discoverDevices()};xnm.aio.edimax.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.edimax.SmartPlug).getStateValues(b)};
xnm.aio.edimax.Handler.prototype.getDeviceCommandList=function(a,b){a=[];a.push({id:window.XC_Text.on,cmd:"on"});a.push({id:window.XC_Text.off,cmd:"off"});return a};xnm.aio.edimax.Handler.prototype.getDevice=function(a){return a.address?new xnm.aio.edimax.SmartPlug(a.address,a.pwd):null};xnm.aio.edimax.Handler.prototype.SmartPlug=xnm.aio.edimax.SmartPlug;xnm.aio.edimax.Handler.prototype.devicemanager=xnm.aio.edimax.DM;
xnm.aio.edimax.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"edimax")};xnm.aio.edimax.Handler.prototype.resolveDevice=function(a){if(!(a&&a.ip&&a.password&&a.type&&a.data)||"smartplug"!=a.type.toLowerCase())return null;var b=new xnm.aio.edimax.SmartPlug(a.ip,a.password);b.port=a.port?a.port:b.port;b.uuid=a.uuid;b.data=a.data;return b};
xnm.aio.edimax.Handler.prototype.discoverDevicesWithTimeout=function(a,b){var c=[],d=function(a){if(a){for(var b=!1,d=0;d<c.length;d++)if(c[d].uuid==a.uuid){b=!0;break}b||c.push(a)}};this._Discovery.addTmpCallback(d);this._Discovery.discoverDevices();var e=this;setTimeout(function(){b&&b(null,c);e._Discovery.delTmpCallback(d)},a)};xnm.aio.edimax.Handler.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.edimax.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};
xnm.aio.edimax.Handler.prototype.getDeviceStatus=function(a,b){a=(a=xnm.aio.edimax.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};xnm.aio.edimax.Handler.prototype.doCommand=function(a,b,c){var d=this.resolveDevice(a);d?d.executeCommandCreator(a,b,function(a){c&&c(a)}):c&&c(Error("device json invalid"))};
xnm.aio.edimax.Handler.prototype.doStatus=function(a,b,c,d){var e=this.resolveDevice(b);e?e.getStatesCreator(null,[{id:a,device:b,status:c}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.edimax.Handler);
