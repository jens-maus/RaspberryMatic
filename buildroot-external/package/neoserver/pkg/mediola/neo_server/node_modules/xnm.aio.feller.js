var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(d,b,a){d instanceof String&&(d=String(d));for(var c=d.length,e=0;e<c;e++){var f=d[e];if(b.call(a,f,e,d))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,b,a){if(d==Array.prototype||d==Object.prototype)return d;d[b]=a.value;return d};$jscomp.getGlobal=function(d){d=["object"==typeof globalThis&&globalThis,d,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<d.length;++b){var a=d[b];if(a&&a.Math==Math)return a}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(d,b){var a=$jscomp.propertyToPolyfillSymbol[b];if(null==a)return d[b];a=d[a];return void 0!==a?a:d[b]};
$jscomp.polyfill=function(d,b,a,c){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(d,b,a,c):$jscomp.polyfillUnisolated(d,b,a,c))};$jscomp.polyfillUnisolated=function(d,b,a,c){a=$jscomp.global;d=d.split(".");for(c=0;c<d.length-1;c++){var e=d[c];if(!(e in a))return;a=a[e]}d=d[d.length-1];c=a[d];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(a,d,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(d,b,a,c){var e=d.split(".");d=1===e.length;c=e[0];c=!d&&c in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<e.length-1;f++){var h=e[f];if(!(h in c))return;c=c[h]}e=e[e.length-1];a=$jscomp.IS_SYMBOL_NATIVE&&"es6"===a?c[e]:null;b=b(a);null!=b&&(d?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==a&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&($jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(e):
$jscomp.POLYFILL_PREFIX+e),$jscomp.defineProperty(c,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:b})))};$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(b,a){return $jscomp.findInternal(this,b,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.feller=xnm.aio.feller||{};
xnm.aio.feller.Zeptrion=function(){var d=function(b,a,c,e){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.feller.Zeptrion");this.ip=b;this.port=a;this.port||(this.port=80);this.type=c;this.uuid=e;this.CommandHandler=null};d.prototype.getDevice=function(b,a,c,e){var f=this;$.ajax({url:"http://"+this.ip+"/zrap/net",method:"POST",data:{ssid:b,pw:a,enc:c},statusCode:{302:function(){f._reboot(function(h){e&&e(h)})}}})};d.prototype._doRequest=
function(b,a,c,e){var f=this;a="http://"+this.ip+":"+this.port+a;this._logger.log("trace","send "+b+" to url:"+a+" data:"+c);var h=e;$.ajax({url:a,type:b,timeout:1E4,data:c,dataType:"text",cache:!0,success:function(g){f._logger.log("trace","http request success:"+g);h&&(h(null,g),h=null)},error:function(g,k){k="http request error:"+(g?g.status:"0")+"-"+k;f._logger.log("trace",k);k=Error(k);k.code=g?g.status:0;h&&(h(k),h=null)}})};d.prototype._reboot=function(b){$.ajax({url:"http://"+this.ip+"/zrap/sys",
method:"POST",data:{cmd:"reboot"},statusCode:{302:function(){var a="Device is now in network: "+ssid;b&&b(a)}}})};d.prototype.getState=function(b,a){this._doRequest("/zrap/chscan/ch"+b,function(c,e){c=$.parseXML(e);c=$(c).find("ch"+b);c=c[0]._children[0]._value;a&&a(c)})};d.prototype.chScan=function(b){this._doRequest("GET","/zrap/chscan",null,function(a,c){if(a)b&&b(a);else try{var e=$($.parseXML(c));if(e){a={};var f=e.find("ch1 val");f&&0<f.length&&(a.ch1=$(f[0]).text());var h=e.find("ch2 val");
h&&0<h.length&&(a.ch2=$(h[0]).text());var g=e.find("ch3 val");g&&0<g.length&&(a.ch3=$(g[0]).text());var k=e.find("ch4 val");k&&0<k.length&&(a.ch4=$(k[0]).text());b&&b(null,a)}else b&&b(Error("chscan response invalid"))}catch(l){b&&b(l)}})};d.prototype.notify=function(b,a){this._doRequest("/zrap/chnotify/ch"+b,function(c,e){e=$.parseXML(e);b=$(e).find("ch"+b);e=b[0]._children[0]._value;var f={state:"?",current:"?"};!c&&e&&(100==e?f.state="on":0==e?f.state="off":-1==e&&(f.state="?"),a&&a(f))})};d.prototype.parseState=
function(b,a){a=parseInt(a);switch(b){case "switch":return{state:0==a?"off":"on"};case "dimmer":return{state:a};default:return null}};d.prototype.executeCommand=function(b,a,c){a?b?this._doRequest("POST","/zrap/chctrl/ch"+a,"cmd="+b,function(e){e&&302==e.code&&(e=null);c&&c(e)}):c&&c(Error("command is null")):c&&c(Error("channel is null"))};d.prototype.executeCommandCreator=function(b,a,c){if(a&&a.value)if(b&&b.address){var e=a.value;switch(a.value){case "recall_s":case "store_s":case "delete_s":if(!a.ext){c&&
c(Error("command ext invalid"));return}e+=a.ext}this.executeCommand(e,b.address,function(f){c&&c(f)})}else c&&c(Error("device json invalid"));else c&&c(Error("command json invalid"))};d.prototype.getStatesCreator=function(b,a,c){if(a)if(0==a.length)c&&c(null,[]);else{var e=this;this.chScan(function(f,h){if(f)c&&c(f);else{f=[];for(var g=0;g<a.length;g++)if(a[g].id){var k="?";if(a[g].status&&a[g].status.value&&a[g].device&&a[g].device.address){var l="ch"+a[g].device.address;h&&h[l]&&(l=e.parseState(a[g].device.type,
h[l]))&&(k=l[a[g].status.value]);if("undefined"==typeof k||null==k)k="?"}f.push({id:a[g].id,status:k})}c&&c(null,f)}})}else c&&c(Error("deviceList is null"))};d.prototype.toJSON=function(){return{sys:"feller",ip:this.ip,port:this.port,type:this.type,uuid:this.uuid}};d.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.feller.Zeptrion?this.ip==b.ip:!1};d.parseJSON=function(b){return b.ip&&b.type?new d(b.ip,b.port,b.type,b.uuid):null};return d}();
xnm.aio.feller.DM=function(){var d=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};d.prototype=Error();d.prototype.name="FellerDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var b={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},
{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["off","on"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"dim up",ref:{value:"dim_up"}},{type:"enum",name:"dim down",ref:{value:"dim_down"}},{type:"enum",name:"stop",
ref:{value:"stop"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"int",name:"state",ref:{value:"state",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"move up",ref:{value:"move_open"}},{type:"enum",name:"move close",ref:{value:"move_close"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",
name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}]}};return{SYS:"feller",getGatewayType:function(){return[{sys:this.SYS,name:"Feller Zeptrion",subtypes:[{id:"Switch",type:"switch"},{id:"Dimmer",type:"dimmer"},{id:"Blind",type:"blind"}]}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,
type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"blind",name:"Blind"}]},createGateway:function(a,c,e){c=d.ERROR_CODE;a?a.ip?a.port?a.type?e(null,a):e(new d(c.INVALID,"type is invalid")):e(new d(c.INVALID,"port is invalid")):e(new d(c.INVALID,"ip is invalid")):e(new d(c.INVALID,"info is invalid"))},updateGateway:function(a,c,e,f){a=d.ERROR_CODE;c?c.ip?c.port?c.type?f(null,c):f(new d(a.INVALID,"type is invalid")):f(new d(a.INVALID,"port is invalid")):f(new d(a.INVALID,"ip is invalid")):f(new d(a.INVALID,
"update is invalid"))},deleteGateway:function(a,c,e){e()},createDevice:function(a,c,e){var f=d.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){c=c.data.gateways;var h;for(h=0;h<c.length;h++)if(c[h].index===a.gateway){var g=c[h];break}g?e&&e(null,a):e(new d(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new d(f.INVALID,"gateway is invalid"));else e(new d(f.INVALID,"type is invalid"));else e(new d(f.INVALID,"address is invalid"));else e(new d(f.INVALID,"info is invalid"))},
updateDevice:function(a,c,e){var f=d.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){c=c.data.gateways;var h;for(h=0;h<c.length;h++)if(c[h].index===a.gateway){var g=c[h];break}g?e(null,a):e(new d(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new d(f.INVALID,"gateway is invalid"));else e(new d(f.INVALID,"type is invalid"));else e(new d(f.INVALID,"address is invalid"));else e(new d(f.INVALID,"info is invalid"))},deleteDevice:function(a,c,e){e()},applyUIFilter:function(a,c,
e){var f=function(m,r){if("*"==m)return!0;for(var n=!1,p=0;p<m.length;p++)if(m[p]==r){n=!0;break}return n},h=function(m,r,n){var p=[];"command"==n.catagory?m.command&&m.command.forEach(function(q){f(n.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))}):"status"==n.catagory&&m.status&&m.status.forEach(function(q){f(n.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))});return p},g=function(m,r){var n=[],p=xnm.aio.feller.DM.getCommandStatusMap(m,e);p&&(m=h(p,m,r),n=n.concat(m));return n};
if(!a.sys)return null;var k=JSON.parse(JSON.stringify(a)),l=null;if("command"==c.catagory)l=g(a,c),k.command=l;else if("status"==c.catagory)l=g(a,c),k.status=l;else return null;return l&&0!=l.length?k:null},getCommandStatusMap:function(a,c){return a.type?b[a.type]:null}}}();
xnm.aio.feller.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.feller.DM;d.prototype.Zeptrion=xnm.aio.feller.Zeptrion;d.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"feller")};d.prototype.resolveGateway=function(b){return b?this.Zeptrion.parseJSON(b):null};d.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};d.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,
{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};d.prototype.doCommand=function(b,a,c,e){(b=this.resolveGateway(b))?b.executeCommandCreator(a,c,function(f){e&&e(f)}):e&&e(Error("gateway json format invalid"))};d.prototype.doStatus=function(b,a,c,e,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:e}],function(h,g){h?f&&f(h):f&&f(null,g[0])}):f&&f(Error("gateway json format invalid"))};d.prototype.discover=function(b,a){var c=this,e=require("x.mdns.js");e.clearRecordBuffer();
var f={},h=2;e.discoverServiceWithTimeout("_zapp._tcp.local",b,function(g,k){h--;if(g)a&&a(g);else{for(g=0;g<k.length;g++){var l=k[g];if(l.target&&l.ip&&0<l.ip.length){var m=l.target.toLowerCase(),r=m.indexOf("-"),n=m.indexOf(".");m=m.substring(r+1,n);f[m]=new c.Zeptrion(l.ip[0],null,l.info.type,m)}}if(0==h){k=[];for(var p in f)k.push(f[p]);a&&a(null,k)}}});e.discoverServiceWithTimeout("_http._tcp.local",b,function(g,k){h--;if(g)a&&a(g);else{for(g=0;g<k.length;g++){var l=k[g];if(l.target&&l.ip&&0<
l.ip.length){var m=l.target.toLowerCase();if("zapp"==m.substr(0,4)){var r=m.indexOf("-"),n=m.indexOf(".");m=m.substring(r+1,n);l=new c.Zeptrion(l.ip[0],null,l.info.type,m);f[m]||(f[m]=l)}}}if(0==h){k=[];for(var p in f)k.push(f[p]);a&&a(null,k)}}})};d.prototype.getDeviceList=function(b,a){b&&b.type?0==b.type.indexOf("3340-4")?a&&a(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""},{sys:"feller",address:3,type:""},{sys:"feller",address:4,type:""}]):0==b.type.indexOf("3340-2")?a&&
a(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""}]):a&&a(Error("unknow gateway type")):a&&a(Error("gateway json invalid"))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.feller.Handler);
