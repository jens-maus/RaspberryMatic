var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(f,e,d){if(null==f)throw new TypeError("The 'this' value for String.prototype."+d+" must not be null or undefined");if(e instanceof RegExp)throw new TypeError("First argument to String.prototype."+d+" must not be a regular expression");return f+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(f,e,d){f!=Array.prototype&&f!=Object.prototype&&(f[e]=d.value)};$jscomp.getGlobal=function(f){f=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,f];for(var e=0;e<f.length;++e){var d=f[e];if(d&&d.Math==Math)return d}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(f,e,d,a){if(e){d=$jscomp.global;f=f.split(".");for(a=0;a<f.length-1;a++){var b=f[a];b in d||(d[b]={});d=d[b]}f=f[f.length-1];a=d[f];e=e(a);e!=a&&null!=e&&$jscomp.defineProperty(d,f,{configurable:!0,writable:!0,value:e})}};
$jscomp.polyfill("String.prototype.repeat",function(f){return f?f:function(e){var d=$jscomp.checkStringArgs(this,null,"repeat");if(0>e||1342177279<e)throw new RangeError("Invalid count value");e|=0;for(var a="";e;)if(e&1&&(a+=d),e>>>=1)d+=d;return a}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.heos=xnm.aio.heos||{};
xnm.aio.heos.HEOS=function(){var f=function(e){this._ip=e.ip;this._port=e.port;this._username=e.username;this._password=e.password;this._uuid=e.uuid;this._port||(this._port=1255);this._controller=require("xnm.aio.heos.js").getController()};f.prototype.executeCommandCreator=function(e,d,a){if(e&&e.type)if(d&&d.value){var b=null;if("player"==e.type){if(!e.pid){a&&a(Error("invalid player pid"));return}b=e.pid}else if("group"==e.type){if(!e.gid){a&&a(Error("invalid group gid"));return}b=e.gid}else a&&
a(Error("unknown device type"));var c=function(c){!c||-5!=c.code&&-6!=c.code||(c.source="heos");a&&a(c)};switch(d.value){case "play":this.play(b,c);break;case "pause":this.pause(b,c);break;case "stop":this.stop(b,c);break;case "previous":this.previous(b,c);break;case "next":this.next(b,c);break;case "toggleMute":"player"==e.type?this.togglePlayerMute(b,c):this.toggleGroupMute(b,c);break;case "mute":"player"==e.type?this.playerMute(b,!0,c):this.groupMute(b,!0,c);break;case "unmute":"player"==e.type?
this.playerMute(b,!1,c):this.groupMute(b,!1,c);break;case "volume":if("undefined"==typeof d.ext||null==d.ext){a&&a(Error("invalid volume value"));break}d=parseInt(d.ext);if(isNaN(d)){a&&a(Error("invalid volume value"));break}"player"==e.type?this.setPlayerVolume(b,d,c):this.setGroupVolume(b,d,c);break;case "volumeUp":"player"==e.type?this.playerVolumeUp(b,c):this.groupVolumeUp(b,c);break;case "volumeDown":"player"==e.type?this.playerVolumeDown(b,c):this.groupVolumeDown(b,c);break;case "shuffleOn":this.shuffle(b,
"on",c);break;case "shuffleOff":this.shuffle(b,"off",c);break;case "shuffleToggle":this.toggleShuffle(b,c);break;case "repeatOff":this.repeat(b,"off",c);break;case "repeatAll":this.repeat(b,"on_all",c);break;case "repeatOne":this.repeat(b,"on_one",c);break;case "repeatSwitch":this.switchRepeat(b,c);break;case "playUrl":if("undefined"==typeof d.ext||null==d.ext){a&&a(Error("invalid url value"));break}this.playUrl(b,d.ext,c);break;case "clearQueue":this.clearQueue(b,c);break;default:a&&a(Error("unknonw command"))}}else a&&
a(Error("device json invalid"));else a&&a(Error("device json invalid"))};f.prototype.getStatesCreator=function(e,d,a){var b=this,c=function(c,a,g,d){switch(g){case "mute":"player"==c?b.isPlayerMute(a,function(b,e){d(b,e,c,a,g)}):b.isGroupMute(a,function(b,e){d(b,e,c,a,g)});break;case "level":"player"==c?b.getPlayerVolume(a,function(b,e){d(b,e,c,a,g)}):b.getGroupVolume(a,function(b,e){d(b,e,c,a,g)});break;case "shuffle":b.getShuffle(a,function(b,e){d(b,e,c,a,g)});break;case "repeat":b.getRepeat(a,
function(b,e){d(b,e,c,a,g)});break;case "play_state":b.getPlayState(a,function(b,e){d(b,e,c,a,g)});break;case "playing_media":b.getPlayingMedia(a,function(b,e){d(b,e,c,a,g)});break;case "duration":b.getPlayingProgress(a,function(b,e,m){d(b,m,c,a,g)});break;case "cur_pos":b.getPlayingProgress(a,function(b,e,m){d(b,e,c,a,g)})}},g=[],m=function(c,b){for(var a=[],g=0;g<c.length;g++){var d=c[g];if(d&&d.id)if(d.device&&d.device.type&&d.status&&d.status.value){var e=d.device.type,m="player"==e?d.device.pid:
d.device.gid,l=null;switch(d.status.value){case "muted":l="mute";break;case "volume":l="level";break;case "shuffle":l="shuffle";break;case "repeat":l="repeat";break;case "playState":l="play_state";break;case "artist":case "title":case "album":l="playing_media";break;case "duration":case "durationS":l="duration";break;case "position":case "positionS":l="cur_pos"}d=!1;for(var f=0;f<a.length;f++){var h=a[f];h.type==e&&h.id==m&&h.key==l&&(d=!0)}d||a.push({type:e,id:m,key:l})}else b.push({id:d.id,status:"?"})}return a}(d,
g);if(0!=m.length){var l=0,f=function(b,h,t,u,v){if(!b){b=[];for(var q=0;q<d.length;q++){var k=d[q];if(k&&k.id&&k.device&&k.status&&k.status.value){var p="player"==t?k.device.pid:k.device.gid;if(t==k.device.type&&u==p)switch(v){case "mute":"muted"==k.status.value&&(g.push({id:k.id,status:h}),b.push({id:k.id,status:h}));break;case "level":"volume"==k.status.value&&(g.push({id:k.id,status:h}),b.push({id:k.id,status:h}));break;case "shuffle":"shuffle"==k.status.value&&(g.push({id:k.id,status:h?h:"?"}),
b.push({id:k.id,status:h?h:"?"}));break;case "repeat":"repeat"==k.status.value&&(g.push({id:k.id,status:h?h:"?"}),b.push({id:k.id,status:h?h:"?"}));break;case "play_state":"playState"==k.status.value&&(g.push({id:k.id,status:h?h:"?"}),b.push({id:k.id,status:h?h:"?"}));break;case "playing_media":"artist"==k.status.value?(g.push({id:k.id,status:h?h.artist:"?"}),b.push({id:k.id,status:h?h.artist:"?"})):"title"==k.status.value?(g.push({id:k.id,status:h?h.title:"?"}),b.push({id:k.id,status:h?h.title:"?"})):
"album"==k.status.value&&(g.push({id:k.id,status:h?h.album:"?"}),b.push({id:k.id,status:h?h.album:"?"}));break;case "duration":if("durationS"==k.status.value)g.push({id:k.id,status:isNaN(h)?0:Math.round(h/1E3)}),b.push({id:k.id,status:isNaN(h)?0:Math.round(h/1E3)});else if("duration"==k.status.value)if(null==h)g.push({id:k.id,status:"?"}),b.push({id:k.id,status:"?"});else{p=Math.floor(h/6E4);var r=Math.round(h%6E4/1E3),n=r+"";2!=n.length&&(n="0"+r);g.push({id:k.id,status:p+":"+n});b.push({id:k.id,
status:p+":"+n})}break;case "cur_pos":"positionS"==k.status.value?(g.push({id:k.id,status:isNaN(h)?0:Math.round(h/1E3)}),b.push({id:k.id,status:isNaN(h)?0:Math.round(h/1E3)})):"position"==k.status.value&&(null==h?(g.push({id:k.id,status:"?"}),b.push({id:k.id,status:"?"})):(p=Math.floor(h/6E4),r=Math.round(h%6E4/1E3),n=r+"",2!=n.length&&(n="0"+r),g.push({id:k.id,status:p+":"+n}),b.push({id:k.id,status:p+":"+n})))}}}0<b.length&&"undefined"!=typeof e&&null!=e&&"undefined"!=typeof e.reportStates&&null!=
e.reportStates&&e.reportStates(null,b)}l++;l<m.length?c(m[l].type,m[l].id,m[l].key,f):a&&a(null,g)};c(m[l].type,m[l].id,m[l].key,f)}};f.prototype.play=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerState(e,"play",d)};f.prototype.pause=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerState(e,"pause",d)};f.prototype.stop=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());
this._controller.setPlayerState(e,"stop",d)};f.prototype.previous=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerPlayPrevious(e,d)};f.prototype.next=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerPlayNext(e,d)};f.prototype.playerMute=function(e,d,a){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerMute(e,d?"on":"off",a)};f.prototype.togglePlayerMute=
function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.togglePlayerMute(e,d)};f.prototype.groupMute=function(e,d,a){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setGroupMute(e,d?"on":"off",a)};f.prototype.toggleGroupMute=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.toggleGroupMute(e,d)};f.prototype.setPlayerVolume=function(e,d,a){this._controller.isIdle()&&this._controller.open(this.toJSON());
100<d&&(d=100);0>d&&(d=0);this._controller.setPlayerVolume(e,d,a)};f.prototype.setGroupVolume=function(e,d,a){this._controller.isIdle()&&this._controller.open(this.toJSON());100<d&&(d=100);0>d&&(d=0);this._controller.setGroupVolume(e,d,a)};f.prototype.playerVolumeUp=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerVolumeUp(e,null,d)};f.prototype.playerVolumeDown=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerVolumeDown(e,
null,d)};f.prototype.clearQueue=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerClearQueue(e,d)};f.prototype.groupVolumeUp=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.groupVolumeUp(e,null,d)};f.prototype.groupVolumeDown=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.groupVolumeDown(e,null,d)};f.prototype.shuffle=function(e,d,a){this._controller.isIdle()&&
this._controller.open(this.toJSON());this._controller.setPlayerMode(e,null,d,a)};f.prototype.toggleShuffle=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());var a=this;this._controller.getPlayerMode(e,function(b,c,g){b?d&&d(b):(b="off","off"==g&&(b="on"),a._controller.setPlayerMode(e,null,b,d))})};f.prototype.repeat=function(e,d,a){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerMode(e,d,null,a)};f.prototype.switchRepeat=function(e,
d){this._controller.isIdle()&&this._controller.open(this.toJSON());var a=this;this._controller.getPlayerMode(e,function(b,c,g){b?d&&d(b):(b="off","off"==c?b="on_all":"on_all"==c&&(b="on_one"),a._controller.setPlayerMode(e,b,null,d))})};f.prototype.getShuffle=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerMode(e,function(a,b,c){d&&d(a,c)})};f.prototype.getRepeat=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerMode(e,
function(a,b,c){a?d&&d(a):(c=null,"on_all"==b?c="all":"on_one"==b?c="one":"off"==b&&(c="off"),d&&d(a,c))})};f.prototype.getPlayState=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerState(e,function(a,b){d&&d(a,b)})};f.prototype.getPlayingMedia=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerNowPlayingMedia(e,function(a,b){a?d&&d(a):(a=null,b&&(a=JSON.parse(JSON.stringify(b)),a.title=b.song),
d&&d(null,a))})};f.prototype.getPlayingProgress=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerNowPlayingProgress(e,function(a,b,c){d&&d(a,b,c)})};f.prototype.getPlayers=function(e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayers(e)};f.prototype.isPlayerMute=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerMute(e,function(a,b){a?d&&d(a):(a=null,
"on"==b?a=!0:"off"==b&&(a=!1),d&&d(null,a))})};f.prototype.getPlayerVolume=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerVolume(e,function(a,b){d&&d(a,b)})};f.prototype.getGroups=function(e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getGroups(e)};f.prototype.isGroupMute=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getGroupMute(e,function(a,b){a?d&&d(a):
d&&d(null,"on"==b?!0:!1)})};f.prototype.getGroupVolume=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getGroupVolume(e,function(a,b){d&&d(a,b)})};f.prototype.playUrl=function(e,d,a){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerPlayURL(e,d,a)};f.prototype.toJSON=function(){return{sys:"heos",ip:this._ip,port:this._port,username:this._username,password:this._password,uuid:this._uuid}};f.prototype.equalsTo=function(e){return e&&
e instanceof f?this.ip==e.ip&&this.port==e.port:!1};f.parseJSON=function(e){return e&&e.ip?new f(e):null};return f}();
xnm.aio.heos._Controller=function(){var f=function(){this._stateExpiredTime=300;this._errorStateExpiredTime=10;this._playerBuffer={};this._groupBuffer={}};f.prototype.reset=function(){this._playerBuffer={};this._groupBuffer={}};f.prototype.removePlayerState=function(a,b){var c=this._playerBuffer[a];c||(this._playerBuffer[a]={},c=this._playerBuffer[a]);c[b]=null};f.prototype.putPlayerState=function(a,b,c){var g=this._playerBuffer[a];g||(this._playerBuffer[a]={},g=this._playerBuffer[a]);a=g[b];a||(g[b]=
{},a=g[b]);a.update=Math.round((new Date).getTime()/1E3);a.value=c};f.prototype.getPlayerState=function(a,b){var c=this._playerBuffer[a];c||(this._playerBuffer[a]={},c=this._playerBuffer[a]);a=c[b];a||(c[b]={},a=c[b]);if("cur_pos"==b||"duration"==b)return a.value?a.value:null;b=Math.round((new Date).getTime()/1E3);if(!a.update||null==a.value&&b-a.update>this._errorStateExpiredTime||b-a.update>this._stateExpiredTime)a.update=b,a.value=null;else return a.value};f.prototype.getPlayerStateRaw=function(a,
b){var c=this._playerBuffer[a];c||(this._playerBuffer[a]={},c=this._playerBuffer[a]);a=c[b];a||(c[b]={},a=c[b]);return a.value};f.prototype.removeGroupState=function(a,b){var c=this._groupBuffer[a];c||(this._groupBuffer[a]={},c=this._groupBuffer[a]);c[b]=null};f.prototype.putGroupState=function(a,b,c){var g=this._groupBuffer[a];g||(this._groupBuffer[a]={},g=this._groupBuffer[a]);a=g[b];a||(g[b]={},a=g[b]);a.update=Math.round((new Date).getTime()/1E3);a.value=c};f.prototype.getGroupState=function(a,
b){var c=this._groupBuffer[a];c||(this._groupBuffer[a]={},c=this._groupBuffer[a]);a=c[b];a||(c[b]={},a=c[b]);b=Math.round((new Date).getTime()/1E3);if(!a.update||null==a.value&&b-a.update>this._errorStateExpiredTime||b-a.update>this._stateExpiredTime)a.update=b,a.value=null;else return a.value};f.prototype.getGroupStateRaw=function(a,b){var c=this._groupBuffer[a];c||(this._groupBuffer[a]={},c=this._groupBuffer[a]);a=c[b];a||(c[b]={},a=c[b]);return a.value};var e=function(){var a=function(b){this._controller=
b};a.prototype.getPlayers=function(b){this._doRequest({path:"player/get_players"},null,function(c,a,d){b&&b(c,d)})};a.prototype.getPlayerState=function(b,c){this._doRequest({path:"player/get_play_state",attributes:{pid:b}},null,function(b,a){b?c&&c(b):a&&"undefined"!=typeof a.state&&null!=a.state?c&&c(null,a.state):c&&c(Error("invalid get player state reponse"))})};a.prototype.setPlayerState=function(b,c,a){this._doRequest({path:"player/set_play_state",attributes:{pid:b,state:c}},null,function(c,
b){c?a&&a(c):b&&"undefined"!=typeof b.state&&null!=b.state?a&&a(null,b.state):a&&a(Error("invalid get player state reponse"))})};a.prototype.getPlayerNowPlayingMedia=function(b,c){this._doRequest({path:"player/get_now_playing_media",attributes:{pid:b}},null,function(b,a,d){b?c&&c(b):d?c&&c(null,d):c&&c(Error("invalid now playing media reponse"))})};a.prototype.getPlayerVolume=function(b,c){this._doRequest({path:"player/get_volume",attributes:{pid:b}},null,function(b,a){b?c&&c(b):a&&"undefined"!=typeof a.level&&
null!=a.level?(b=parseInt(a.level),isNaN(b)?c&&c(Error("invalid get player volume reponse")):c&&c(null,b)):c&&c(Error("invalid get player volume reponse"))})};a.prototype.setPlayerVolume=function(b,c,a){this._doRequest({path:"player/set_volume",attributes:{pid:b,level:c}},null,function(c,b){c?a&&a(c):b&&"undefined"!=typeof b.level&&null!=b.level?(c=parseInt(b.level),isNaN(c)?a&&a(Error("invalid set player volume reponse")):a&&a(null,c)):a&&a(Error("invalid set player volume reponse"))})};a.prototype.playerVolumeUp=
function(b,c,a){b={path:"player/volume_up",attributes:{pid:b}};c&&(b.attributes.step=c);this._doRequest(b,null,function(c,b){c?a&&a(c):b&&"undefined"!=typeof b.step&&null!=b.step?(c=parseInt(b.step),isNaN(c)?a&&a(Error("invalid player volume up reponse")):a&&a(null,c)):a&&a(Error("invalid player volume up reponse"))})};a.prototype.playerVolumeDown=function(b,c,a){b={path:"player/volume_down",attributes:{pid:b}};c&&(b.attributes.step=c);this._doRequest(b,null,function(c,b){c?a&&a(c):b&&"undefined"!=
typeof b.step&&null!=b.step?(c=parseInt(b.step),isNaN(c)?a&&a(Error("invalid player volume down reponse")):a&&a(null,c)):a&&a(Error("invalid player volume down reponse"))})};a.prototype.getPlayerMute=function(b,c){this._doRequest({path:"player/get_mute",attributes:{pid:b}},null,function(b,a){b?c&&c(b):a&&a.state?c&&c(null,a.state):c&&c(Error("invalid get player mute reponse"))})};a.prototype.setPlayerMute=function(b,c,a){this._doRequest({path:"player/set_mute",attributes:{pid:b,state:c}},null,function(c,
b){c?a&&a(c):b&&b.state?a&&a(null,b.state):a&&a(Error("invalid set player mute reponse"))})};a.prototype.togglePlayerMute=function(a,c){this._doRequest({path:"player/toggle_mute",attributes:{pid:a}},null,function(a,b){a?c&&c(a):c&&c(null)})};a.prototype.getPlayerMode=function(a,c){this._doRequest({path:"player/get_play_mode",attributes:{pid:a}},null,function(a,b){a?c&&c(a):b&&b.repeat&&b.shuffle?c&&c(null,b.repeat,b.shuffle):c&&c(Error("invalid get player mute reponse"))})};a.prototype.setPlayerMode=
function(a,c,d,e){a={path:"player/set_play_mode",attributes:{pid:a}};c&&(a.attributes.repeat=c);d&&(a.attributes.shuffle=d);this._doRequest(a,null,function(a,c){a?e&&e(a):c&&(c.repeat||c.shuffle)?e&&e(null,c.repeat,c.shuffle):e&&e(Error("invalid set player mode reponse"))})};a.prototype.playerClearQueue=function(a,c){this._doRequest({path:"player/clear_queue",attributes:{pid:a}},null,function(a){c&&c(a)})};a.prototype.playerPlayNext=function(a,c){this._doRequest({path:"player/play_next",attributes:{pid:a}},
null,function(a){c&&c(a)})};a.prototype.playerPlayPrevious=function(a,c){this._doRequest({path:"player/play_previous",attributes:{pid:a}},null,function(a){c&&c(a)})};a.prototype.getGroups=function(a){this._doRequest({path:"player/get_groups"},null,function(c,b,d){a&&a(c,d)})};a.prototype.getGroupVolume=function(a,c){this._doRequest({path:"group/get_volume",attributes:{gid:a}},null,function(a,b){a?c&&c(a):b&&"undefined"!=typeof b.level&&null!=b.level?(a=parseInt(b.level),isNaN(a)?c&&c(Error("invalid get group volume reponse")):
c&&c(null,a)):c&&c(Error("invalid get group volume reponse"))})};a.prototype.setGroupVolume=function(a,c,d){this._doRequest({path:"group/set_volume",attributes:{gid:a,level:c}},null,function(a,c){a?d&&d(a):c&&"undefined"!=typeof c.level&&null!=c.level?(a=parseInt(c.level),isNaN(a)?d&&d(Error("invalid set group volume reponse")):d&&d(null,a)):d&&d(Error("invalid set group volume reponse"))})};a.prototype.groupVolumeUp=function(a,c,d){a={path:"group/volume_up",attributes:{gid:a}};c&&(a.attributes.step=
c);this._doRequest(a,null,function(a,c){a?d&&d(a):c&&"undefined"!=typeof c.step&&null!=c.step?(a=parseInt(c.step),isNaN(a)?d&&d(Error("invalid group volume up reponse")):d&&d(null,a)):d&&d(Error("invalid group volume up reponse"))})};a.prototype.groupVolumeDown=function(a,c,d){a={path:"group/volume_down",attributes:{gid:a}};c&&(a.attributes.step=c);this._doRequest(a,null,function(a,c){a?d&&d(a):c&&"undefined"!=typeof c.step&&null!=c.step?(a=parseInt(c.step),isNaN(a)?d&&d(Error("invalid group volume down reponse")):
d&&d(null,a)):d&&d(Error("invalid group volume down reponse"))})};a.prototype.getGroupMute=function(a,c){this._doRequest({path:"group/get_mute",attributes:{gid:a}},null,function(a,b){a?c&&c(a):b&&b.state?c&&c(null,b.state):c&&c(Error("invalid get group mute reponse"))})};a.prototype.setGroupMute=function(a,c,d){this._doRequest({path:"group/set_mute",attributes:{gid:a,state:c}},null,function(a,c){a?d&&d(a):c&&c.state?d&&d(null,c.state):d&&d(Error("invalid set group mute reponse"))})};a.prototype.toggleGroupMute=
function(a,c){this._doRequest({path:"group/toggle_mute",attributes:{gid:a}},null,function(a,b){a?c&&c(a):c&&c(null)})};a.prototype.getMusicSources=function(a){this._doRequest({path:"browse/get_music_sources"},null,function(c,b,d){c?a&&a(c):a&&a(null,d)})};a.prototype.browserSource=function(a,c,d,e,f){a={path:"browse/browse",attributes:{sid:a}};c&&(a.attributes.id=c);d&&(a.attributes.scid=d);e&&(a.attributes.range=e);this._doRequest(a,null,function(a,c,b,d){a?f&&f(a):f&&f(null,c,b,d)})};a.prototype.playerPlayURL=
function(a,c,d){this._doRequest({path:"browse/play_stream",attributes:{pid:a,url:c}},null,function(a,c){a?d&&d(a):d&&d(null,c)})};a.prototype._doRequest=function(a,c,d){this._controller._sendCommand(a,c,function(a,c){a?d(a):d(null,c.message,c.payload,c.options)})};return a}(),d=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Controller");var a=this;this._api=new e(this);this._session=new xnm.aio.heos._Session;this._session.on("open",function(){a._state="OPEN";a._logger.log("trace",
"session opened");a._emitEvent("open")});this._session.on("close",function(){a._state="IDLE";a._reset();a._logger.log("trace","session closed");a._emitEvent("close")});this._session.on("error",function(b){a._state="CONNECT";a._logger.log("trace","session error:"+b.message);a._reset()});this._session.on("event",function(b){a._logger.log("trace","receive session event:"+JSON.stringify(b));a._processHeosEvent(b)});this._state="IDLE";this._stateBuffer=new f;this._listeners={}};d.prototype.on=function(a,
b){a&&b&&(this._listeners[a]||(this._listeners[a]=[]),-1==this._listeners[a].indexOf(b)&&this._listeners[a].push(b))};d.prototype.off=function(a,b){a&&b&&this._listeners[a]&&(b=this._listeners[a].indexOf(b),-1!=b&&this._listeners[a].splice(b,1))};d.prototype.open=function(a){"IDLE"==this._state&&(this._logger.log("trace","open session"),this._state="CONNECT",this._session.open(a))};d.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("trace","close session"),this._state="CLOSED",this._session.close())};
d.prototype.isOpen=function(){return"OPEN"==this._state};d.prototype.isIdle=function(){return"IDLE"==this._state};d.prototype.getPlayers=function(a){this._api.getPlayers(a)};d.prototype.getPlayerState=function(a,b){var c=this._getBufferedState("player",a,"play_state");if("undefined"!=typeof c)b&&b(null,c);else{var d=this;this._api.getPlayerState(a,function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("player",a,"play_state",c?null:e):d._removeBufferedState("player",a,"play_state");b&&b(c,e)})}};
d.prototype.setPlayerState=function(a,b,c){var d=this;this._api.setPlayerState(a,b,function(b,e){b||d._putBufferedState("player",a,"play_state",e);c&&c(b,e)})};d.prototype.getPlayerNowPlayingMedia=function(a,b){var c=this._getBufferedState("player",a,"playing_media");if("undefined"!=typeof c)b&&b(null,c);else{var d=this;this._api.getPlayerNowPlayingMedia(a,function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("player",a,"playing_media",c?null:e):d._removeBufferedState("player",a,"playing_media");
b&&b(c,e)})}};d.prototype.getPlayerVolume=function(a,b){var c=this._getBufferedState("player",a,"level");if("undefined"!=typeof c)b&&b(null,c);else{var d=this;this._api.getPlayerVolume(a,function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("player",a,"level",c?null:e):d._removeBufferedState("player",a,"level");b&&b(c,e)})}};d.prototype.setPlayerVolume=function(a,b,c){var d=this;this._api.setPlayerVolume(a,b,function(b,e){b||d._putBufferedState("player",a,"level",e);c&&c(b,e)})};d.prototype.playerVolumeUp=
function(a,b,c){var d=this;this._api.playerVolumeUp(a,b,function(b,e){if(!b){var g=d._stateBuffer.getPlayerStateRaw(a,"level");"undefined"!=typeof g&&null!=g&&(g+=e,100<g&&(g=100),d._putBufferedState("player",a,"level",g))}c&&c(b,e)})};d.prototype.playerVolumeDown=function(a,b,c){var d=this;this._api.playerVolumeDown(a,b,function(b,e){if(!b){var g=d._stateBuffer.getPlayerStateRaw(a,"level");"undefined"!=typeof g&&null!=g&&(g-=e,0>g&&(g=0),d._putBufferedState("player",a,"level",g))}c&&c(b,e)})};d.prototype.getPlayerMute=
function(a,b){var c=this._getBufferedState("player",a,"mute");if("undefined"!=typeof c)b&&b(null,c);else{var d=this;this._api.getPlayerMute(a,function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("player",a,"mute",c?null:e):d._removeBufferedState("player",a,"mute");b&&b(c,e)})}};d.prototype.setPlayerMute=function(a,b,c){var d=this;this._api.setPlayerMute(a,b,function(b,e){b||d._putBufferedState("player",a,"mute",e);c&&c(b,e)})};d.prototype.togglePlayerMute=function(a,b){var c=this;this._api.togglePlayerMute(a,
function(d){if(!d){var e=c._stateBuffer.getPlayerStateRaw(a,"mute");"undefined"!=typeof e&&null!=e&&c._putBufferedState("player",a,"mute","on"==e?"off":"on")}b&&b(d)})};d.prototype.getPlayerMode=function(a,b){var c=this._getBufferedState("player",a,"repeat"),d=this._getBufferedState("player",a,"shuffle");if("undefined"!=typeof c&&"undefined"!=typeof d)b&&b(null,c,d);else{var e=this;this._api.getPlayerMode(a,function(c,d,g){!c||-5!=c.code&&-6!=c.code?(e._putBufferedState("player",a,"repeat",c?null:
d),e._putBufferedState("player",a,"shuffle",c?null:g)):(e._removeBufferedState("player",a,"repeat"),e._removeBufferedState("player",a,"shuffle"));b&&b(c,d,g)})}};d.prototype.getPlayerNowPlayingProgress=function(a,b){var c=this._getBufferedState("player",a,"cur_pos");a=this._getBufferedState("player",a,"duration");b&&b(null,c,a)};d.prototype.getGroups=function(a){this._api.getGroups(a)};d.prototype.setPlayerMode=function(a,b,c,d){var e=this;this._api.setPlayerMode(a,b,c,function(c,b,g){c||e._putBufferedState("player",
a,"repeat",b);c||e._putBufferedState("player",a,"shuffle",g);d&&d(c,b,g)})};d.prototype.playerClearQueue=function(a,b){this._api.playerClearQueue(a,function(a){b&&b(a)})};d.prototype.playerPlayNext=function(a,b){this._api.playerPlayNext(a,function(a){b&&b(a)})};d.prototype.playerPlayPrevious=function(a,b){this._api.playerPlayPrevious(a,function(a){b&&b(a)})};d.prototype.getGroupVolume=function(a,b){var c=this._getBufferedState("group",a,"level");if("undefined"!=typeof c)b&&b(null,c);else{var d=this;
this._api.getGroupVolume(a,function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("group",a,"level",c?null:e):d._removeBufferedState("group",a,"level");b&&b(c,e)})}};d.prototype.setGroupVolume=function(a,b,c){var d=this;this._api.setGroupVolume(a,b,function(b,e){b||d._putBufferedState("group",a,"level",e);c&&c(b,e)})};d.prototype.groupVolumeUp=function(a,b,c){var d=this;this._api.groupVolumeUp(a,b,function(b,e){if(!b){var g=d._stateBuffer.getGroupStateRaw(a,"level");"undefined"!=typeof g&&null!=
g&&(g+=e,100<g&&(g=100),d._putBufferedState("group",a,"level",g))}c&&c(b,e)})};d.prototype.groupVolumeDown=function(a,b,c){var d=this;this._api.groupVolumeDown(a,b,function(b,e){if(!b){var g=d._stateBuffer.getGroupStateRaw(a,"level");"undefined"!=typeof g&&null!=g&&(g-=e,0>g&&(g=0),d._putBufferedState("group",a,"level",g))}c&&c(b,e)})};d.prototype.getGroupMute=function(a,b){var c=this._getBufferedState("group",a,"mute");if("undefined"!=typeof c)b&&b(null,c);else{var d=this;this._api.getGroupMute(a,
function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("group",a,"mute",c?null:e):d._removeBufferedState("group",a,"mute");b&&b(c,e)})}};d.prototype.setGroupMute=function(a,b,c){var d=this;this._api.setGroupMute(a,b,function(b,e){b||d._putBufferedState("group",a,"mute",e);c&&c(b,e)})};d.prototype.toggleGroupMute=function(a,b){var c=this;this._api.toggleGroupMute(a,function(d){if(!d){var e=c._stateBuffer.getGroupStateRaw(a,"mute");"undefined"!=typeof e&&null!=e&&c._putBufferedState("group",a,
"mute","on"==e?"off":"on")}b&&b(d)})};d.prototype.getMusicSources=function(a){this._api.getMusicSources(function(b,c){a&&a(b,c)})};d.prototype.browserSource=function(a,b,c,d,e){this._api.browserSource(a,b,c,d,function(a,c,b,d){e&&e(a,c,b,d)})};d.prototype.playerPlayURL=function(a,b,c){this._api.playerPlayURL(a,b,function(a,b){a?c&&c(a):c&&c(null,b)})};d.prototype._putBufferedState=function(a,b,c,d){"player"==a?this._stateBuffer.putPlayerState(b,c,d):"group"==a&&this._stateBuffer.putGroupState(b,c,
d)};d.prototype._getBufferedState=function(a,b,c){if("player"==a)return this._stateBuffer.getPlayerState(b,c);if("group"==a)return this._stateBuffer.getGroupState(b,c)};d.prototype._removeBufferedState=function(a,b,c){"player"==a?this._stateBuffer.removePlayerState(b,c):"group"==a&&this._stateBuffer.removeGroupState(b,c)};d.prototype._sendCommand=function(a,b,c){this._session.sendCommand(a,b,c)};d.prototype._emitEvent=function(a,b){if(a){var c=this._listeners[a];if(c&&0<c.length)for(var d=0;d<c.length;d++){var e=
c[d];try{e(b)}catch(l){this._logger.log("trace","call "+a+" listener failed, error:"+l.message)}}}};d.prototype._processHeosEvent=function(a){if(a&&a.heos&&a.heos.command){var b=a.heos.message;switch(a.heos.command){case "event/player_state_changed":b&&b.pid&&b.state&&this._stateBuffer.putPlayerState(b.pid,"play_state",b.state);break;case "event/player_now_playing_changed":b&&b.pid&&(this._stateBuffer.removePlayerState(b.pid,"playing_media"),this._stateBuffer.removePlayerState(b.pid,"cur_pos"),this._stateBuffer.removePlayerState(b.pid,
"duration"));break;case "event/player_now_playing_progress":b&&b.pid&&b.cur_pos&&b.duration&&(this._stateBuffer.putPlayerState(b.pid,"cur_pos",parseInt(b.cur_pos)),this._stateBuffer.putPlayerState(b.pid,"duration",parseInt(b.duration)));break;case "event/player_volume_changed":b&&b.pid&&b.level&&b.mute&&(this._stateBuffer.putPlayerState(b.pid,"level",parseInt(b.level)),this._stateBuffer.putPlayerState(b.pid,"mute",b.mute));break;case "event/repeat_mode_changed":b&&b.pid&&b.repeat&&this._stateBuffer.putPlayerState(b.pid,
"repeat",b.repeat);break;case "event/shuffle_mode_changed":b&&b.pid&&b.shuffle&&this._stateBuffer.putPlayerState(b.pid,"shuffle",b.shuffle);break;case "event/group_volume_changed":b&&b.gid&&b.level&&b.mute&&(this._stateBuffer.putGroupState(b.gid,"level",parseInt(b.level)),this._stateBuffer.putGroupState(b.gid,"mute",b.mute))}}};d.prototype._reset=function(){this._stateBuffer.reset()};return d}();
xnm.aio.heos._Session=function(){var f=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Session._Monitor");this._monitorCallback=this._socket=null;this._commandTimeoutCount=0;this._heartBeatTo=null;this._heatBeatMissCount=0;var a=this;this._socketErrorCallback=function(c){a._finishRun(c)};this._socketCloseCallback=function(){a._finishRun(Error("socket closed"))}};f.prototype.run=function(a,b){this._socket=a;this._monitorCallback=b;this._setListener();this.scheduleNextHeartBeat()};
f.prototype.reset=function(){this._monitorCallback=null;this._heatBeatMissCount=0;this._heartBeatTo&&(clearTimeout(this._heartBeatTo),this._heartBeatTo=null);if(this._socket){var a=this._socket;this._clearListener();this._socket=null;a.close()}};f.prototype.executeCommandTimeout=function(a){a?(this._commandTimeoutCount++,this._logger.log("warn","execute command timeout#"+this._commandTimeoutCount),3<this._commandTimeoutCount&&this._finishRun(Error("execute command is always timeout"))):this._commandTimeoutCount=
0};f.prototype.scheduleNextHeartBeat=function(a){this._scheduleNextHeartBeat(a?a:15E3)};f.prototype._scheduleNextHeartBeat=function(a){var c=this;this._heartBeatTo&&clearTimeout(this._heartBeatTo);this._heartBeatTo=setTimeout(function(){c._checkHeartBeat()},a)};f.prototype._checkHeartBeat=function(){if(this._socket){this._logger.log("trace","check heart beat");var a=this;this._socket.sendCommand({path:"system/heart_beat"},2E3,function(c){c?(a._heatBeatMissCount++,a._logger.log("warn","check heart beat failed #"+
a._heatBeatMissCount+", error:"+c.message),a._scheduleNextHeartBeat(2E3)):(a._heatBeatMissCount=0,a._scheduleNextHeartBeat(15E3));3<a._heatBeatMissCount&&a._finishRun(Error("heart beat failed"))})}};f.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};f.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};
f.prototype._finishRun=function(a){var c=this._socket;this._socket&&(this._clearListener(),this._socket=null);a&&c&&c.close();this._heartBeatInterval&&(clearInterval(this._heartBeatInterval),this._heartBeatInterval=null);this._heatBeatMissCount=this._commandTimeoutCount=0;this._monitorCallback&&(c=this._monitorCallback,this._monitorCallback=null,c(a))};var e=function(){this._warmupCallback=this._password=this._username=this._socket=null;var a=this;this._socketErrorCallback=function(c){a._finishWarmup(c)};
this._socketCloseCallback=function(){a._finishWarmup(Error("socket closed"))}};e.prototype.warmup=function(a,b,d,e){this._socket=a;this._username=b;this._password=d;this._warmupCallback=e;this._setListener();var c=this;this._registerEvents("off",function(a){a?c._finishWarmup(a):c._signIn(function(a){a?c._finishWarmup(a):c._getPlayers(function(a){a?c._finishWarmup(a):c._registerEvents("on",function(a){c._finishWarmup(a)})})})})};e.prototype.reset=function(){this._warmupCallback=null;if(this._socket){var a=
this._socket;this._clearListener();this._socket=null;a.close()}};e.prototype._registerEvents=function(a,b){this._socket.sendCommand({path:"system/register_for_change_events",attributes:{enable:a}},5E3,function(a,c){b(a,c)})};e.prototype._signIn=function(a){this._username&&this._password?this._socket.sendCommand({path:"system/sign_in",attributes:{un:this._username,pw:this._password}},5E3,function(c,b){a(c,b)}):a()};e.prototype._getPlayers=function(a){this._socket.sendCommand({path:"player/get_players"},
5E3,function(c,b){c?a(c):b&&b.heos&&b.payload&&"success"==b.heos.result?a(null,b.payload):a(Error("get players response error"))})};e.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};e.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};e.prototype._finishWarmup=function(a){var c=this._socket;
this._socket&&(this._clearListener(),this._socket=null);a&&c&&c.close();this._warmupCallback&&(this._warmupCallback(a),this._warmupCallback=null)};var d=function(){this._connectCallback=this._socket=null;var a=this;this._socketOpenCallback=function(){a._finishConnect()};this._socketErrorCallback=function(c){a._finishConnect(c)};this._socketCloseCallback=function(){a._finishConnect(Error("socket closed"))}};d.prototype.connect=function(a,b){this._connectCallback=b;this._socket=new xnm.aio.heos._Socket(a);
this._setListener();this._socket.open()};d.prototype.reset=function(){this._connectCallback=null;if(this._socket){var a=this._socket;this._clearListener();this._socket=null;a.close()}};d.prototype._setListener=function(){this._socket&&(this._socket.on("open",this._socketOpenCallback),this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};d.prototype._clearListener=function(){this._socket&&(this._socket.off("open",this._socketOpenCallback),this._socket.off("error",
this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};d.prototype._finishConnect=function(a){var c=this._socket;this._socket&&(this._clearListener(),this._socket=null);a&&c&&c.close();if(this._connectCallback){var b=this._connectCallback;this._connectCallback=null;b(a,c)}};var a=function(){this._state="idle";this._heos=[];this._searchTo=this._fetchCallback=this._lastFetch=null};a.prototype.reset=function(){this._state="idle";this._heos=[];this._fetchCallback=this._lastFetch=
null;this._searchTo&&clearTimeout(this._searchTo);this._searchTo=null};a.prototype.fetchHEOS=function(a){var c=Math.round((new Date).getTime()/1E3);this._lastFetch&&600<c-this._lastFetch&&(this._heos=[]);var b=this._getUnfetchedHEOSFromBuffer();if(b)this._lastFetch=c,a(null,b);else if(this._fetchCallback=a,"run"!=this._state){var d=this;this._state="run";this._searchTo=setTimeout(function(){d._state="idle";d._heos=[];if(d._fetchCallback){var a=d._fetchCallback;d._fetchCallback=null;a(null,null)}},
12E3);require("x.upnp.js").discoverTargetWithTimeout("urn:schemas-denon-com:device:ACT-Denon:1",1E4,function(a){if(a&&a.ip&&"run"==d._state){a={fetched:!1,data:{ip:a.ip,port:1255,uuid:a.uuid}};var b=d._heos.length;d._heos.push(a);0==b&&(a.fetched=!0,d._lastFetch=c,d._fetchCallback&&(b=d._fetchCallback,d._fetchCallback=null,b(null,a.data)))}})}};a.prototype._getUnfetchedHEOSFromBuffer=function(){for(var a=null,b=0;b<this._heos.length;b++){var d=this._heos[b];if(0==d.fetched){d.fetched=!0;a=d.data;
break}}return a};var b=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Session");this._discover=new a;this._connect=new d;this._runner=new e;this._monitor=new f;var c=this;this._socketEventCallback=function(a){a&&a.heos&&a.heos.message&&(a.heos.message=c._parseMessage(a.heos.message));c._monitor.scheduleNextHeartBeat();c._emitEvent("event",a)};this._socket=null;this._state="IDLE";this._uuid=this._password=this._username=this._port=this._ip=null;this._eventListeners={}};b.prototype.on=
function(a,b){a&&b&&(this._eventListeners[a]||(this._eventListeners[a]=[]),-1==this._eventListeners[a].indexOf(b)&&this._eventListeners[a].push(b))};b.prototype.off=function(a,b){a&&b&&this._eventListeners[a]&&(b=this._eventListeners[a].indexOf(b),-1!=b&&this._eventListeners[a].splice(b,1))};b.prototype.open=function(a){"IDLE"==this._state&&(this._ip=a?a.ip:null,this._port=a?a.port:null,this._username=a?a.username:null,this._password=a?a.password:null,this._uuid=a?a.uuid:null,this._logger.log("debug",
"start controller"+(this._ip?" with ip:"+this._ip:" without ip")),this._doFSM(this._ip?"init_with_ip":"init_without_ip"))};b.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("debug","stop controller"),this._doFSM("stop"))};b.prototype.sendCommand=function(a,b,d){if("IDLE"==this._state)a=Error("session not initialized"),a.sys="heos",a.code=-5,d&&d(a);else if("RUN"!=this._state)a=Error("session is initialling"),a.sys="heos",a.code=-6,d&&d(a);else{var c=this;this._socket.sendCommand(a,
b,function(a,b){a?-3==a.code?(c._monitor.scheduleNextHeartBeat(),c._monitor.executeCommandTimeout(!0)):c._monitor.executeCommandTimeout(!1):(c._monitor.scheduleNextHeartBeat(),c._monitor.executeCommandTimeout(!1));if(a)d&&d(a);else if(b&&b.heos&&b.heos.result){var e={command:b.heos.comamnd,result:b.heos.result};b.heos.message&&(e.message=c._parseMessage(b.heos.message));b.payload&&(e.payload=b.payload);b.options&&(e.options=b.options);"fail"==b.heos.result&&(e.message?(a=Error(e.message.text),a.code=
parseInt(e.message.eid)):(a=Error("response fail"),a.code=0));d&&d(a,e)}else a=Error("invalid response"),a.code=-4,d&&d(a)})}};b.prototype._emitEvent=function(a,b){if(a){var c=this._eventListeners[a];if(c&&0<c.length)for(var d=0;d<c.length;d++){var e=c[d];try{e(b)}catch(q){this._logger.log("trace","call "+a+" listener failed, error:"+q.message)}}}};b.prototype._searchHEOS=function(){this._logger.log("trace","search heos device");var a=this;this._discover.fetchHEOS(function(b,c){c?(a._logger.log("trace",
"found heos device:"+c.ip),a._ip=c.ip,a._uuid=c.uuid,a._doFSM("find_heos")):(a._logger.log("trace","do not found heos device"),a._doFSM("no_heos"))})};b.prototype._stopSearchHEOS=function(){this._logger.log("trace","stop search heos device");this._discover.reset();this._reset()};b.prototype._connectHEOS=function(){this._logger.log("trace","connect heos device:"+this._ip);var a=this;this._connect.connect({ip:this._ip,port:this._port,username:this._username,passsword:this._password,uuid:this._uuid},
function(b,c){b?(a._logger.log("trace","connect to heos device:"+a._ip+" failed, error:"+b.message),a._doFSM("conn_fail")):(a._logger.log("trace","connect to heos device:"+a._ip+" success"),a._socket=c,a._doFSM("conn_ok"))})};b.prototype._stopConnectHEOS=function(){this._logger.log("trace","stop connect heos device:"+this._ip);this._connect.reset();this._reset()};b.prototype._warmupHEOS=function(){this._logger.log("trace","warmup heos device:"+this._ip);var a=this;this._runner.warmup(this._socket,
this._username,this._password,function(b){b?(a._logger.log("trace","warmup heos device:"+a._ip+" failed, error:"+b.message),a._socket=null,a._doFSM("not_ready")):(a._logger.log("trace","warmup heos device:"+a._ip+" success"),a._doFSM("ready"))})};b.prototype._stopWarmupHEOS=function(){this._logger.log("trace","stop warmup heos device:"+this._ip);this._runner.reset();this._reset()};b.prototype._runHEOS=function(){this._logger.log("trace","monitor heos device:"+this._ip);var a=this;this._monitor.run(this._socket,
function(b){b&&(a._logger.log("trace","monitor heos device:"+a._ip+" failed, error:"+b.message),a._socket=null,a._doFSM("run_error"),a._emitEvent("error",b))});this._setListener();this._emitEvent("open")};b.prototype._stopRunHEOS=function(){this._logger.log("trace","stop monitor heos device:"+this._ip);this._monitor.reset();this._clearListener();this._emitEvent("close");this._reset()};b.prototype._parseMessage=function(a){if(!a)return null;var b={};a=a.split("&");for(var c=0;c<a.length;c++){var d=
a[c],e=d.indexOf("=");if(-1!=e){var f=d.substr(0,e);d=d.substr(e+1);b[f]=d}}return b};b.prototype._setListener=function(){if(this._socket)this._socket.on("event",this._socketEventCallback)};b.prototype._clearListener=function(){this._socket&&this._socket.off("event",this._socketEventCallback)};b.prototype._reset=function(){this._uuid=this._password=this._username=this._port=this._ip=this._socket=null};b.prototype._doFSM=function(a){this._logger.log("trace","FSM current state:"+this._state+" input:"+
a);switch(this._state){case "IDLE":switch(a){case "init_with_ip":this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);this._connectHEOS();break;case "init_without_ip":this._state="SEARCH",this._logger.log("trace","FSM new state:"+this._state),this._searchHEOS()}break;case "SEARCH":switch(a){case "no_heos":this._state="SEARCH";this._logger.log("trace","FSM new state:"+this._state);this._searchHEOS();break;case "find_heos":this._state="CONNECT";this._logger.log("trace","FSM new state:"+
this._state);this._connectHEOS();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopSearchHEOS()}break;case "CONNECT":switch(a){case "conn_fail":this._state="SEARCH";this._logger.log("trace","FSM new state:"+this._state);this._searchHEOS();break;case "conn_ok":this._state="WARMUP";this._logger.log("trace","FSM new state:"+this._state);this._warmupHEOS();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopConnectHEOS()}break;
case "WARMUP":switch(a){case "not_ready":this._state="SEARCH";this._logger.log("trace","FSM new state:"+this._state);this._searchHEOS();break;case "ready":this._state="RUN";this._logger.log("trace","FSM new state:"+this._state);this._runHEOS();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopWarmupHEOS()}break;case "RUN":switch(a){case "run_error":this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);this._connectHEOS();break;
case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopRunHEOS()}}};return b}();
xnm.aio.heos._Socket=function(){var f=function(e){if(!e)throw Error("options is null");if(!e.ip)throw Error("no ip");this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Socket");this._responseTimeout=1E3;this._ip=e.ip;this._port=e.port;this._port||(this._port=1255);this._username=e.username;this._password=e.password;this._uuid=e.uuid;this._timeout=2E3;this._listeners={};this._socket=null;this._buf="";this._state="IDLE";this._commands=[]};f.prototype.on=function(e,d){e&&d&&(this._listeners[e]||
(this._listeners[e]=[]),-1==this._listeners[e].indexOf(d)&&this._listeners[e].push(d))};f.prototype.off=function(e,d){e&&d&&this._listeners[e]&&(d=this._listeners[e].indexOf(d),-1!=d&&this._listeners[e].splice(d,1))};f.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var e=this;this._state="CONNECT";this._buf="";var d=require("net").connect({port:this._port,host:this._ip});d.setTimeout(this._timeout);d.setEncoding("utf8");this._logger.log("trace","start connect to "+this._ip+":"+this._port);
d.on("connect",function(){e._logger.log("trace","success to connect "+e._ip+":"+e._port);e._state="CONNECTED";e._emitEvent("open");e._executeNextCommand()});d.on("data",function(a){e._logger.log("trace","receive data: "+a.toString());e._buf+=a.toString();e._processBuffer()});d.on("error",function(a){e._logger.log("trace","socket error: "+a.message);e._emitEvent("error",a)});d.on("timeout",function(){"CONNECT"==e._state&&(e._logger.log("trace","connect timeout"),e._emitEvent("error",Error("connect timeout")),
e.close())});d.on("close",function(){e._logger.log("trace","socket closed");e._onClose()});d._doConnect&&"function"==typeof d._doConnect&&d._doConnect();this._socket=d}};f.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose())};f.prototype.sendCommand=function(e,d,a){if("CLOSED"==this._state)e=Error("socket closed"),e.code=-1,a&&a(e);else if(e&&e.path){d||(d=this._responseTimeout);var b=this._commands.length;this._commands.push({command:e,callback:a,
timeout:null,state:"IDLE",responseTimeout:d});0==b&&this._executeNextCommand()}else e=Error("invalid command"),e.code=-2,a&&a(e)};f.prototype._executeNextCommand=function(){var e=this._commands[0];if(e&&"IDLE"==e.state&&"CONNECTED"==this._state){var d=this._buildPacket(e.command);e.state="SENT";this._setupReponseTimeout(e);this._logger.log("debug","send command:"+d);e=new Buffer(d);this._socket.write(e)}};f.prototype._setupReponseTimeout=function(e){var d=this;e.timeout=setTimeout(function(){d._commands.splice(0,
1);e.state="TIMEOUT";if(e.callback){d._logger.log("debug","response timeout");var a=Error("response timeout");a.code=-3;e.callback(a)}d._executeNextCommand()},e.responseTimeout)};f.prototype._buildPacket=function(e){var d="heos://"+e.path;if(e.attributes){d+="?";var a=[],b;for(b in e.attributes){var c=this._escape(b)+"="+this._escape(e.attributes[b]);a.push(c)}d+=a.join("&")}return d+"\r\n"};f.prototype._escape=function(e){if(!e||"string"!=typeof e)return e;e=e.replace(/%/g,"%25");e=e.replace(/&/g,
"%26");return e=e.replace(/=/g,"%3D")};f.prototype._emitEvent=function(e,d){if(e){var a=this._listeners[e];if(a&&0<a.length)for(var b=0;b<a.length;b++){var c=a[b];try{c(d)}catch(g){this._logger.log("trace","call "+e+" listener failed, error:"+g.message)}}}};f.prototype._processBuffer=function(){for(var e=this._buf.indexOf("\r\n");-1!=e;){if(0!=e){var d=this._buf.substr(0,e);this._processResponse(d)}this._buf=this._buf.substr(e+2);e=this._buf.indexOf("\r\n")}};f.prototype._processResponse=function(e){this._logger.log("debug",
"receive response: "+e);try{var d=JSON.parse(e);if(!d||!d.heos||!d.heos.command)throw Error("invalid response");var a=this._commands[0];a&&"SENT"==a.state&&a.command&&a.command.path==d.heos.command?-1!=d.heos.message.indexOf("command under process")?(clearTimeout(a.timeout),this._setupReponseTimeout(a)):(this._commands.splice(0,1),clearTimeout(a.timeout),a.callback&&a.callback(null,d),this._executeNextCommand()):"event"==d.heos.command.substr(0,5)&&this._emitEvent("event",d)}catch(b){this._logger.log("debug",
"process response error: "+b.message)}};f.prototype._onClose=function(){this._state="CLOSED";this._socket=null;this._emitEvent("close");this._listeners={};var e=Error("socket closed");e.code=-1;for(var d=0;d<this._commands.length;d++){var a=this._commands[d];a.timeout&&clearTimeout(a.timeout);a.callback&&a.callback(e)}this._commands=[];this._buf=""};return f}();
xnm.aio.heos.DM=function(){var f=function(d,a){this.code=d;this.message=a;this.stack=Error().stack};f.prototype=Error();f.prototype.name="HEOSDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},
{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"int",name:"volume",ref:{value:"volume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},
{type:"enum",name:"repeat off",ref:{value:"repeatOff"}},{type:"enum",name:"repeat all",ref:{value:"repeatAll"}},{type:"enum",name:"repeat one",ref:{value:"repeatOne"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}},{type:"string",name:"play url",ref:{value:"playUrl",ext:"%s"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on",
"off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}},{type:"string",name:"play state",ref:{value:"playState",options:["play","pause","stop"]}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",
name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]};return{SYS:"heos",getGatewayType:function(){return[{sys:this.SYS,name:"HEOS Controller",port:1255}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"player",name:"Player"},{sys:this.SYS,type:"group",name:"Group"}]},createGateway:function(d,a,b){a=f.ERROR_CODE;d?d.ip?b(null,d):b(new f(a.INVALID,"ip is invalid")):b(new f(a.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){d=f.ERROR_CODE;a?a.ip?
c(null,a):c(new f(d.INVALID,"ip is invalid")):c(new f(d.INVALID,"update is invalid"))},deleteGateway:function(d,a,b){b()},createDevice:function(d,a,b){var c=f.ERROR_CODE;if(d)if(d.gateway)if(null==d.type||"undefined"==typeof d.type)b(new f(c.INVALID,"type is invalid"));else if("player"!=d.type||null!=d.pid&&"undefined"!=typeof d.pid)if("group"!=d.type||null!=d.gid&&"undefined"!=typeof d.gid){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){var m=a[e];break}m?b(null,d):b(new f(c.NOT_FOUND,
"gateway with index "+d.gateway+" not exists"))}else b(new f(c.INVALID,"gid is invalid"));else b(new f(c.INVALID,"pid is invalid"));else b(new f(c.INVALID,"gateway is invalid"));else b(new f(c.INVALID,"info is invalid"))},updateDevice:function(d,a,b){var c=f.ERROR_CODE;if(d)if(d.gateway)if(null==d.type||"undefined"==typeof d.type)b(new f(c.INVALID,"type is invalid"));else if("player"!=d.type||null!=d.pid&&"undefined"!=typeof d.pid)if("group"!=d.type||null!=d.gid&&"undefined"!=typeof d.gid){a=a.data.gateways;
var e;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){var m=a[e];break}m?b(null,d):b(new f(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new f(c.INVALID,"gid is invalid"));else b(new f(c.INVALID,"pid is invalid"));else b(new f(c.INVALID,"gateway is invalid"));else b(new f(c.INVALID,"info is invalid"))},deleteDevice:function(d,a,b){b()},applyUIFilter:function(d,a){var b=this,c=function(a,b,d){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var f=
c(a.children,b,d);f&&0<f.length&&(a.children=f,e.push(a))}else{f=d.elems;if("*"==f)f=!0;else{for(var g=!1,h=0;h<f.length;h++)if(f[h]==a.type){g=!0;break}f=g}f&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},e=function(a,d){var e=[],f=b.getCommandStatusMap(a);if(f){var g=[];switch(d.catagory){case "command":f.command&&(g=c(f.command,a,d));break;case "status":f.status&&(g=c(f.status,a,d))}e=e.concat(g)}return e};if(!d.sys)return null;var f=JSON.parse(JSON.stringify(d)),l=null;switch(a.catagory){case "command":l=
e(d,a);f.command=l;break;case "status":l=e(d,a);f.status=l;break;default:return null}return l&&0!=l.length?f:null},getCommandStatusMap:function(d){return d&&"undefined"!=typeof d.type&&null!=d.type?e:null}}}();
xnm.aio.heos.Handler=function(){var f=function(){this._getDeviceListTo=this._controller=null};f.prototype.Socket=xnm.aio.heos._Socket;f.prototype.Session=xnm.aio.heos._Session;f.prototype.Controller=xnm.aio.heos._Controller;f.prototype.HEOS=xnm.aio.heos.HEOS;f.prototype.devicemanager=xnm.aio.heos.DM;f.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"heos")};f.prototype.resolveGateway=function(e){return e?this.HEOS.parseJSON(e):null};f.prototype.getDeviceCommands=function(e,d){e=
(e=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}))?e.command:[];d&&d(null,e)};f.prototype.getDeviceStatus=function(e,d){e=(e=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}))?e.status:[];d&&d(null,e)};f.prototype.doCommand=function(e,d,a,b){(e=this.resolveGateway(e))?e.executeCommandCreator(d,a,function(a){b&&b(a)}):b&&b(Error("gateway json format invalid"))};f.prototype.doStatus=function(e,d,a,b,c){(d=this.resolveGateway(d))?d.getStatesCreator(null,[{id:e,device:a,
status:b}],function(a,b){a?c&&c(a):c&&c(null,b[0])}):c&&c(Error("device json format invalid"))};f.prototype.getController=function(){this._controller||(this._controller=new this.Controller);return this._controller};f.prototype.discoverDevices=function(e){var d={};require("x.upnp.js").discoverTargetWithTimeout("urn:schemas-denon-com:device:ACT-Denon:1",5E3,function(a){a&&a.ip&&a.uuid&&(d[a.uuid]={sys:"heos",ip:a.ip,uuid:a.uuid})});setTimeout(function(){var a=null,b;for(b in d){var c=d[b];if(c){a=c;
break}}e&&e(null,a)},5E3)};f.prototype.getDeviceList=function(e,d){_getDeviceList=function(a,b){var c=[];a.getPlayers(function(d,e){d?b&&b(d):(e&&e.map(function(a){a.sys="heos";a.type="player";return a}),a.getGroups(function(a,d){a?b&&b(a):(d&&d.map(function(a){a.sys="heos";a.type="group";delete a.players;return a}),e&&(c=c.concat(e)),d&&(c=c.concat(d)),b&&b(null,c))}))})};var a=this.resolveGateway(e);if(a)if(this._getDeviceListTo)d&&d(Error("another get device list process running"));else{var b=
this.getController();if(b.isOpen())_getDeviceList(a,d);else{var c=this,f=function(){b.off("run",f);c._getDeviceListTo&&(clearTimeout(c._getDeviceListTo),c._getDeviceListTo=null);_getDeviceList(a,d)};b.on("open",f);this._getDeviceListTo=setTimeout(function(){b.off("run",f);c._getDeviceListTo=null;d&&d(Error("start heo controller timeout"))},5E3);b.open(a.toJSON())}}else d&&d(Error("gateway json format invalid"))};f.prototype.finalize=function(e){this._controller&&this._controller.close();setTimeout(function(){e&&
e()},1E3)};f.prototype.pause=function(e){this.finalize(e)};return f}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.heos.Handler);
