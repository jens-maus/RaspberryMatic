var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.homewizard=xnm.aio.homewizard||{};xnm.aio.homewizard.HomeWizard=function(a,c,b){this._logger=require("x.logger.js").getLogger("xnm.aio.homewizard.HomeWizard");this.ip=a;this.port=c;c||(this.port=80);this.password=b;this.CommandHandler=null};
xnm.aio.homewizard.HomeWizard.prototype._doRequest=function(a,c){var b=this;a="http://"+this.ip+":"+this.port+"/"+this.password+"/"+a;this._logger.log("trace","send to url:"+a);var f=c;$.ajax({url:a,type:"GET",timeout:1E4,dataType:"json",success:function(c){b._logger.log("trace","http request success:"+JSON.stringify(c));f&&(f(null,c),f=null)},error:function(c,a){c="http request error:"+(c?c.status:"0")+"-"+a;b._logger.log("trace",c);f&&(f(Error(c)),f=null)}})};
xnm.aio.homewizard.HomeWizard.prototype._sendRequest=function(a,c){this._doRequest(a,function(b,a){!b&&a&&a.response&&"ok"==a.status?a&&a.response&&"ok"==a.status?c&&c(null,a.response):(a&&a.status?(b=Error(a.status),b.errCode=a.error):b=Error("response is empty"),c&&c(b)):c&&c(b)})};xnm.aio.homewizard.HomeWizard.prototype.getDevices=function(a){this._sendRequest("get-sensors",function(c,b){a&&a(c,b)})};
xnm.aio.homewizard.HomeWizard.prototype._resolveState=function(a,c){if(!a||!a.type||!c||"undefined"==typeof a.address||null==a.address)return null;var b=null;switch(a.type){case "switch":case "dimmer":case "radiator":case "asun":case "somfy":var f="switches";break;case "wind":f="windmeters";break;case "rain":f="rainmeters";break;case "thermo":f="thermometers";break;case "doorbell":case "smoke":case "contact":case "motion":f="kakusensors";break;case "energylink":f="energylinks";break;default:return null}if(c[f])for(var e=
0;e<c[f].length;e++)if(c[f][e]&&a.address+""==c[f][e].id+""){var d=c[f][e];break}if(d)switch(b={},a.type){case "switch":case "dimmer":case "radiator":case "asun":case "somfy":"undefined"!=typeof d.status&&null!=d.status&&(b.status=d.status);"undefined"!=typeof d.dimlevel&&null!=d.dimlevel&&(b.dimlevel=d.dimlevel);"undefined"!=typeof d.tte&&null!=d.tte&&(b.status=d.tte,b.tte=d.tte);break;case "wind":b.windLowBat="no"!=d.lowBattery;b.windS=d.ws;d.dir&&-1!=d.dir.indexOf(" ")&&(a=d.dir.split(" "),b.windD=
parseInt(a[1].trim()),b.windDS=a[0].trim());b.windGS=d.gu;b.windT=d.wc;b.windSMax=d["ws+"];b.windSMaxT=d["ws+t"];b.windSMin=d["ws-"];b.windSMinT=d["ws-t"];break;case "rain":b.rainLowBat="no"!=d.lowBattery;b.rainL=d.mm;b.rainL3h=d["3h"];break;case "thermo":b.thermoLowBat="no"!=d.lowBattery;b.thermoT=d.te;b.thermoH=d.hu;b.thermoTMax=d["te+"];b.thermoTMaxT=d["te+t"];b.thermoTMin=d["te-"];b.thermoTMinT=d["te-t"];b.thermoHMax=d["hu+"];b.thermoHMaxT=d["hu+t"];b.thermoHMin=d["hu-"];b.thermoHMinT=d["hu-t"];
break;case "doorbell":b.doorbellE=d.status?"ring":"none";b.doorbellET=d.timestamp;break;case "smoke":b.smokeE=d.status?"alarm":"ok";b.smokeET=d.timestamp;break;case "motion":b.motionE=d.status&&"no"!=d.status?"on":"off";b.motionET=d.timestamp;break;case "contact":b.contactE=d.status?"open":"closed";b.contactET=d.timestamp;break;case "energylink":d.s1&&(b.s1Value=d.s1.po,b.s1TotalD=d.s1.dayTotal,b.s1Max=d.s1["po+"],b.s1MaxT=d.s1["po+t"],b.s1Min=d.s1["po-"],b.s1MinT=d.s1["po-t"]),d.s2&&(b.s2Value=d.s2.po,
b.s2TotalD=d.s2.dayTotal,b.s2Max=d.s2["po+"],b.s2MaxT=d.s2["po+t"],b.s2Min=d.s2["po-"],b.s2MinT=d.s2["po-t"])}return b};
xnm.aio.homewizard.HomeWizard.prototype.executeCommand=function(a,c,b){var f=null,e=!0;if("on"==c)"switch"==a.type||"dimmer"==a.type||"radiator"==a.type?f="sw/"+a.address+"/on":"scene"==a.type&&(f="gp/"+a.address+"/on");else if("off"==c)"switch"==a.type||"dimmer"==a.type||"radiator"==a.type?f="sw/"+a.address+"/off":"scene"==a.type&&(f="gp/"+a.address+"/off");else if("toggle"==c){if("switch"==a.type||"dimmer"==a.type){var d=this;this.getStates(null,[a],function(c,e){f="sw/"+a.address+"/off";1==e.length&&
e[0].state&&"off"==e[0].state.status&&(f="sw/"+a.address+"/on");d._sendRequest(f,function(c){b&&b(c)})});e=!1}}else"up"==c?"somfy"==a.type?f="sf/"+a.address+"/up":"asun"==a.type&&(f="sw/"+a.address+"/up"):"down"==c?"somfy"==a.type?f="sf/"+a.address+"/down":"asun"==a.type&&(f="sw/"+a.address+"/down"):"stop"==c?"somfy"==a.type&&(f="sf/"+a.address+"/stop"):(0==c.indexOf("dimTo")&&(c=c.replace(/dimTo/g,"")),0==c.indexOf("setTo")&&(c=c.replace(/setTo/g,"")),c=c.replace(/%/g,""),"dimmer"==a.type?f="sw/dim/"+
a.address+"/"+c:"radiator"==a.type&&(f="sw/"+a.address+"/settarget/"+c));e&&!f?b&&b(Error("no such command")):e&&f&&this._sendRequest(f,function(c){b&&b(c)})};xnm.aio.homewizard.HomeWizard.prototype.getStates=function(a,c,b){var f=this;this.CommandHandler=a;this._sendRequest("get-sensors",function(a,d){if(a)b&&b(a,c);else{for(a=0;a<c.length;a++){var e=f._resolveState(c[a],d);e&&(c[a].state=e)}b&&b(null,c)}})};xnm.aio.homewizard.HomeWizard.prototype.getStateValues=function(a,c){return c};
xnm.aio.homewizard.HomeWizard.prototype.executeCommandCreator=function(a,c,b){if(c&&c.value){var f=c.value;if("dimTo"==c.value){if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command dimTo ext format invalid"));return}f=c.value+c.ext}else if("setTo"==c.value){if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command setTo ext format invalid"));return}f=c.value+c.ext}this.executeCommand(a,f,function(a){b&&b(a)})}else b&&b(Error("command json format invalid"))};
xnm.aio.homewizard.HomeWizard.prototype.getStatesCreator=function(a,c,b){if(c)if(0==c.length)b&&b(null,[]);else{for(var f=[],e=0;e<c.length;e++)if(c[e]&&c[e].device){var d=JSON.parse(JSON.stringify(c[e].device));f.push(d)}this.getStates(a,f,function(a,d){for(var f=[],e=0;e<c.length;e++)if(c[e].id){var g="?";c[e].status&&c[e].status.value&&d&&d[e]&&d[e].state&&(g=d[e].state[c[e].status.value],"undefined"==typeof g||null==g)&&(g="?");f.push({id:c[e].id,status:g})}b&&b(a,f)})}else b&&b(Error("deviceList is null"))};
xnm.aio.homewizard.HomeWizard.prototype.toJSON=function(){return{sys:xnm.aio.homewizard.DM.SYS,ip:this.ip,port:this.port,password:this.password}};xnm.aio.homewizard.HomeWizard.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.homewizard.HomeWizard?this.ip==a.ip&&this.port==a.port&&this.password==a.password:!1};
xnm.aio.homewizard.DM=function(){var a=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};a.prototype=Error();a.prototype.name="HomewizardDMError";a.prototype.code=0;a.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"homewizard",MAP:{"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"status",ref:{value:"status",
options:["on","off"]}}]},dimmer:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"status",ref:{value:"status",options:["on","off"]}},{type:"int",name:"dim level",ref:{value:"dimlevel",extMeta:"0-100"}}]},radiator:{command:[{type:"enum",name:"night mode",ref:{value:"off"}},{type:"enum",name:"day mode",ref:{value:"on"}},
{type:"float",name:"temperature",ref:{value:"setTo",ext:"%f",extMeta:"5.0-28.0",scale:"0.5"}}],status:[{type:"float",name:"temperature",ref:{value:"status",extMeta:"5.0-28.0",scale:"0.5"}}]},somfy:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}}]},asun:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}}]},scene:{command:[{type:"enum",name:"off",ref:{value:"off"}},
{type:"enum",name:"on",ref:{value:"on"}}]},wind:{status:[{type:"enum",name:"battery low",ref:{value:"windLowBat",options:["true","false"]}},{type:"float",name:"wind speed",ref:{value:"windS"}},{type:"int",name:"wind direction",ref:{value:"windD"}},{type:"string",name:"wind direction (string)",ref:{value:"windDS"}},{type:"float",name:"gust speed",ref:{value:"windGS"}},{type:"float",name:"wind temperature",ref:{value:"windT"}},{type:"float",name:"max wind speed",ref:{value:"windSMax"}},{type:"string",
name:"max wind speed time",ref:{value:"windSMaxT"}},{type:"float",name:"min wind speed",ref:{value:"windSMin"}},{type:"string",name:"min wind speed time",ref:{value:"windSMinT"}}]},rain:{status:[{type:"enum",name:"battery low",ref:{value:"rainLowBat",options:["true","false"]}},{type:"int",name:"rain level",ref:{value:"rainL"}},{type:"int",name:"rain level (3h)",ref:{value:"rainL3h"}}]},thermo:{status:[{type:"enum",name:"battery low",ref:{value:"thermoLowBat",options:["true","false"]}},{type:"float",
name:"temperature",ref:{value:"thermoT"}},{type:"float",name:"humidity",ref:{value:"thermoH"}},{type:"float",name:"max temperature",ref:{value:"thermoTMax"}},{type:"string",name:"max temperature time",ref:{value:"thermoTMaxT"}},{type:"float",name:"min temperature",ref:{value:"thermoTMin"}},{type:"string",name:"min temperature time",ref:{value:"thermoTMinT"}},{type:"float",name:"max humidity",ref:{value:"thermoHMax"}},{type:"string",name:"max humidity time",ref:{value:"thermoHMaxT"}},{type:"float",
name:"min humidity",ref:{value:"thermoHMin"}},{type:"string",name:"min humidity time",ref:{value:"thermoHMinT"}}]},doorbell:{status:[{type:"enum",name:"last event",ref:{value:"doorbellE",options:["none","ring"]}},{type:"string",name:"last event time",ref:{value:"doorbellET"}}]},smoke:{status:[{type:"enum",name:"last event",ref:{value:"smokeE",options:["ok","alarm"]}},{type:"string",name:"last event time",ref:{value:"smokeET"}}]},motion:{status:[{type:"enum",name:"last event",ref:{value:"motionE",
options:["on","off"]}},{type:"string",name:"last event time",ref:{value:"motionET"}}]},contact:{status:[{type:"enum",name:"last event",ref:{value:"contactE",options:["open","closed"]}},{type:"string",name:"last event time",ref:{value:"contactET"}}]},energylink:{status:[{type:"float",name:"s1 value",ref:{value:"s1Value"}},{type:"float",name:"s1 daily total",ref:{value:"s1TotalD"}},{type:"float",name:"max s1 value",ref:{value:"s1Max"}},{type:"string",name:"max s1 value time",ref:{value:"s1MaxT"}},{type:"float",
name:"min s1 value",ref:{value:"s1Min"}},{type:"string",name:"min s1 value time",ref:{value:"s1MinT"}},{type:"float",name:"s2 value",ref:{value:"s2Value"}},{type:"float",name:"s2 daily total",ref:{value:"s2TotalD"}},{type:"float",name:"max s2 value",ref:{value:"s2Max"}},{type:"string",name:"max s2 value time",ref:{value:"s2MaxT"}},{type:"float",name:"min s2 value",ref:{value:"s2Min"}},{type:"string",name:"min s2 value time",ref:{value:"s2MinT"}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"HomeWizard",
port:80}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"radiator",name:"Thermostat"},{sys:this.SYS,type:"somfy",name:"Somfy Blind"},{sys:this.SYS,type:"asun",name:"ASUN Blind"}]},createGateway:function(c,b,f){b=a.ERROR_CODE;c?c.ip?c.password?f(null,c):f(new a(b.INVALID,"password is invalid")):f(new a(b.INVALID,"ip is invalid")):f(new a(b.INVALID,"info is invalid"))},updateGateway:function(c,b,f,e){c=
a.ERROR_CODE;b?b.ip?b.password?e(null,b):e(new a(c.INVALID,"password is invalid")):e(new a(c.INVALID,"ip is invalid")):e(new a(c.INVALID,"update is invalid"))},deleteGateway:function(a,b,f){f()},createDevice:function(c,b,f){var e=a.ERROR_CODE;if(c)if(c.gateway)if(null==c.address||"undefined"==typeof c.address)f(new a(e.INVALID,"address is invalid"));else if(null==c.type||"undefined"==typeof c.type)f(new a(e.INVALID,"type is invalid"));else if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=
b.data.gateways;var d;for(d=0;d<b.length;d++)if(b[d].index===c.gateway){var g=b[d];break}g?f(null,c):f(new a(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else f(new a(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else f(new a(e.INVALID,"gateway is invalid"));else f(new a(e.INVALID,"info is invalid"))},updateDevice:function(c,b,f){var e=a.ERROR_CODE;if(c)if(c.gateway)if(null==c.address||"undefined"==typeof c.address)f(new a(e.INVALID,"address is invalid"));else if(null==
c.type||"undefined"==typeof c.type)f(new a(e.INVALID,"type is invalid"));else if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var d;for(d=0;d<b.length;d++)if(b[d].index===c.gateway){var g=b[d];break}g?f(null,c):f(new a(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else f(new a(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else f(new a(e.INVALID,"gateway is invalid"));else f(new a(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,f){f()},
applyUIFilter:function(a,b){var c=this,e=function(a,c){if("*"==a)return!0;for(var b=!1,d=0;d<a.length;d++)if(a[d]==c){b=!0;break}return b},d=function(a,c,b){var d=[];switch(b.catagory){case "command":a.command&&a.command.forEach(function(a){e(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&a.status.forEach(function(a){e(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},g=function(a,b){var e=[],f=c.getCommandStatusMap(a);f&&(a=d(f,
a,b),e=e.concat(a));return e};if(!a||null==a.type||"undefined"==typeof a.type)return null;var k=JSON.parse(JSON.stringify(a)),h=null;switch(b.catagory){case "command":h=g(a,b);k.command=h;break;case "status":h=g(a,b);k.status=h;break;default:return null}return h&&0!=h.length?k:null},getCommandStatusMap:function(a){return a&&a.type?this.MAP[a.type]:null}}}();xnm.aio.homewizard.Handler=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.homewizard.Handler");this.detectedHomeWizards={}};
xnm.aio.homewizard.Handler.prototype.HomeWizard=xnm.aio.homewizard.HomeWizard;xnm.aio.homewizard.Handler.prototype.devicemanager=xnm.aio.homewizard.DM;xnm.aio.homewizard.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"homewizard")};xnm.aio.homewizard.Handler.prototype.resolveGateway=function(a){return a&&a.ip&&a.password?new xnm.aio.homewizard.HomeWizard(a.ip,a.port,a.password):null};
xnm.aio.homewizard.Handler.prototype.getDeviceCommands=function(a,c){a=(a=xnm.aio.homewizard.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];c&&c(null,a)};xnm.aio.homewizard.Handler.prototype.getDeviceStatus=function(a,c){a=(a=xnm.aio.homewizard.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];c&&c(null,a)};xnm.aio.homewizard.Handler.prototype.doCommand=function(a,c,b,f){(a=this.resolveGateway(a))?a.executeCommandCreator(c,b,function(a){f&&f(a)}):f&&f(Error("gateway json format invalid"))};
xnm.aio.homewizard.Handler.prototype.doStatus=function(a,c,b,f,e){(c=this.resolveGateway(c))?c.getStatesCreator(null,[{id:a,device:b,status:f}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};
xnm.aio.homewizard.Handler.prototype.getDeviceList=function(a,c){if(a=this.resolveGateway(a)){var b=this;a.getDevices(function(a,e){if(a)c&&c(a);else{var d=[];e&&(e.switches&&e.switches.forEach(function(a){if(a)switch(a.type){case "switch":case "dimmer":case "radiator":case "somfy":case "asun":d.push({sys:b.devicemanager.SYS,type:a.type,address:a.id,name:a.name})}}),e.scenes&&e.scenes.forEach(function(a){a&&d.push({sys:b.devicemanager.SYS,type:"scene",address:a.id,name:a.name})}),e.windmeters&&e.windmeters.forEach(function(a){a&&
d.push({sys:b.devicemanager.SYS,type:"wind",address:a.id,name:a.name})}),e.rainmeters&&e.rainmeters.forEach(function(a){a&&d.push({sys:b.devicemanager.SYS,type:"rain",address:a.id,name:a.name})}),e.thermometers&&e.thermometers.forEach(function(a){a&&d.push({sys:b.devicemanager.SYS,type:"thermo",address:a.id,name:a.name})}),e.kakusensors&&e.kakusensors.forEach(function(a){a&&a.type&&("doorbell"==a.type||"smoke"==a.type||"contact"==a.type||"motion"==a.type)&&d.push({sys:b.devicemanager.SYS,type:a.type,
address:a.id,name:a.name})}),e.energylinks&&e.energylinks.forEach(function(a){a&&d.push({sys:b.devicemanager.SYS,type:"energylink",address:a.id,name:a.name})}));c&&c(null,d)}})}else c&&c(Error("gateway json format invalid"))};
xnm.aio.homewizard.Handler.prototype.discoverHomeWizards=function(a){var c=this,b=function(a,b){$.ajax({url:"http://"+a,type:"GET",timeout:2E3,success:function(a){c._logger.log("trace","local search success:"+JSON.stringify(a));b&&(b(null),b=null)},error:function(a,e){a="local search error:"+(a?a.status:"0")+"-"+e;c._logger.log("trace",a);b&&(b(Error(a)),b=null)}})};(function(a){$.ajax({url:"http://gateway.homewizard.nl/discovery.php",type:"GET",timeout:2E3,dataType:"json",success:function(b){c._logger.log("trace",
"remote search success:"+JSON.stringify(b));var d,e;b&&"ok"==b.status&&b.ip?e=b.ip:d=Error("repsonse not ok");a&&(a(d,e),a=null)},error:function(b,d){b="remote search error:"+(b?b.status:"0")+"-"+d;c._logger.log("trace",b);a&&(a(Error(b)),a=null)}})})(function(c,e){c||!e?a&&a(null,[]):b(e,function(b){b?a&&a(null,[]):a&&a(null,[new xnm.aio.homewizard.HomeWizard(e)])})})};
xnm.aio.homewizard.Handler.prototype.getStateValues=function(a,c){return(new xnm.aio.homewizard.HomeWizard).getStateValues(a.type,c)};xnm.aio.homewizard.Handler.prototype.getDeviceCommandList=function(a,c,b){a=[];c&&(a.push({id:window.XC_Text.on,cmd:"on"}),a.push({id:window.XC_Text.off,cmd:"off"}));return a};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.homewizard.Handler);
