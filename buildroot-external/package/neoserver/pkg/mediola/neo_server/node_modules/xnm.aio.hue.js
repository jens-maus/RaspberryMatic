var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};
$jscomp.polyfill=function(a,b,c,d){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,d):$jscomp.polyfillUnisolated(a,b,c,d))};$jscomp.polyfillUnisolated=function(a,b,c,d){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))return;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,d){var e=a.split(".");a=1===e.length;d=e[0];d=!a&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var g=0;g<e.length-1;g++){var h=e[g];if(!(h in d))return;d=d[h]}e=e[e.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?d[e]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&($jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(e):
$jscomp.POLYFILL_PREFIX+e),$jscomp.defineProperty(d,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:b})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(a){if(a)return a;var b=function(e,g){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};b.prototype.toString=function(){return this.$jscomp$symbol$id_};var c=0,d=function(e){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new b("jscomp_symbol_"+(e||"")+"_"+c++,e)};return d},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<b.length;c++){var d=$jscomp.global[b[c]];"function"===typeof d&&"function"!=typeof d.prototype[a]&&$jscomp.defineProperty(d.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){a instanceof String&&(a+="");var c=0,d=!1,e={next:function(){if(!d&&c<a.length){var g=c++;return{value:b(g,a[g]),done:!1}}d=!0;return{done:!0,value:void 0}}};e[Symbol.iterator]=function(){return e};return e};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.hue=xnm.aio.hue||{};
xnm.aio.hue.Util={_HSVToRGB:function(a,b,c){var d=Math.floor(6*a),e=6*a-d;a=c*(1-b);var g=c*(1-e*b);b=c*(1-(1-e)*b);switch(d%6){case 0:var h=c;var f=b;var k=a;break;case 1:h=g;f=c;k=a;break;case 2:h=a;f=c;k=b;break;case 3:h=a;f=g;k=c;break;case 4:h=b;f=a;k=c;break;case 5:h=c,f=a,k=g}return[255*h,255*f,255*k]},_RGBToHex:function(a,b,c){for(a=a.toString(16);2>a.length;)a="0"+a;for(b=b.toString(16);2>b.length;)b="0"+b;for(c=c.toString(16);2>c.length;)c="0"+c;return(a+b+c).toUpperCase()}};
xnm.aio.hue.Bridge=function(a,b,c,d,e){this._logger=(d=require("x.logger.js"))?d.getLogger("xnm.aio.hue.Bridge"):{log:function(){}};this._USER="IQONTROLUser";e&&(this._USER=e);this.ip=a;this.port=b;this.uuid=c;this.CommandHandler=null};xnm.aio.hue.Bridge.prototype._RGBToHSV=function(a,b,c){a/=255;b/=255;c/=255;var d=Math.min(a,Math.min(b,c)),e=Math.max(a,Math.max(b,c));return d==e?[0,0,d]:[60*((a==d?3:c==d?1:5)-(a==d?b-c:c==d?a-b:c-a)/(e-d)),(e-d)/e,e]};
xnm.aio.hue.Bridge.prototype._RGBToXY=function(a,b,c){function d(m,t){return m[0]*t[1]-m[1]*t[0]}function e(m,t,u){return null!=m&&null!=t&&null!=u?(u=[u[0]-m[0],u[1]-m[1]],t=[t[0]-m[0],t[1]-m[1]],u=(u[0]*t[0]+u[1]*t[1])/(t[0]*t[0]+t[1]*t[1]),0>u?u=0:1<u&&(u=1),[m[0]+t[0]*u,m[1]+t[1]*u]):null}function g(m,t){var u=m[0]-t[0];m=m[1]-t[1];return Math.sqrt(u*u+m*m)}var h=[[.703,.296],[.214,.709],[.139,.081]],f=[[.674,.322],[.408,.517],[.168,.041]],k=[[.692,.308],[.17,.7],[.153,.048]],n=[[1,0],[0,1],[0,
0]],l="LLC001 LLC005 LLC006 LLC007 LLC010 LLC011 LLC012 LLC014 LLC013 LST001".split(" "),r="LCT001 LCT002 LCT003 LCT004 LLM001 LCT005 LCT006 LCT007".split(" "),q="LCT010 LCT011 LCT012 LCT014 LCT015 LCT016 LLC020 LST002".split(" "),p="HBL001 HBL002 HBL003 HIL001 HIL002 HEL001 HEL002".split(" ");return function(m,t,u,v){m/=255;t/=255;u/=255;m=.04045<m?Math.pow((m+.055)/1.055,2.4000000953674316):m/12.92;t=.04045<t?Math.pow((t+.055)/1.055,2.4000000953674316):t/12.92;var x=.04045<u?Math.pow((u+.055)/1.055,
2.4000000953674316):u/12.92;u=.664511*m+.154324*t+.162028*x;var w=.283881*m+.668433*t+.047685*x;m=8.8E-5*m+.07231*t+.986039*x;m=[u/(u+w+m),w/(u+w+m)];isNaN(m[0])&&(m[0]=0);isNaN(m[1])&&(m[1]=0);null==v&&(v=" ");v=-1==r.indexOf(v)&&-1==p.indexOf(v)?0<=l.indexOf(v)?h:0<=q.indexOf(v)?k:n:f;null!=m&&null!=v?(u=v[0],t=v[1],w=v[2],t=[t[0]-u[0],t[1]-u[1]],w=[w[0]-u[0],w[1]-u[1]],x=[m[0]-u[0],m[1]-u[1]],u=d(x,w)/d(t,w),t=d(t,x)/d(t,w),t=0<=u&&0<=t&&1>=u+t):t=!1;if(!t){u=e(v[0],v[1],m);t=e(v[2],v[0],m);v=
e(v[1],v[2],m);w=g(m,u);x=g(m,t);var z=g(m,v),y=w;x<w&&(y=x,u=t);z<y&&(u=v);m[0]=u[0];m[1]=u[1]}m[0]=Math.round(1E4*m[0])/1E4;m[1]=Math.round(1E4*m[1])/1E4;return m}(a,b,c)};
xnm.aio.hue.Bridge.prototype._doRequest=function(a,b,c,d){var e="/api/"+this._USER+b;b||(e="/api");e={host:this.ip,port:this.port,path:e,method:a,headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};var g=this,h=d;this._logger.log("trace","send '"+a+"' to "+this.ip+":"+this.port+"/api/xxxxxxxx"+(b?b:""));c&&this._logger.log("trace","with data: "+c);var f=require("http").request(e,function(k){if(200==k.statusCode){k.setEncoding("utf-8");var n="";k.on("data",
function(l){n+=l});k.on("end",function(){g._logger.log("trace","http response 200: "+n);var l={};try{var r=JSON.parse(n);r&&r[0]&&r[0].error?(l.error="unknown",1==r[0].error.type&&(l.error="unauthorized"),101==r[0].error.type&&(l.error="unpressed")):l.data=r}catch(q){}h&&(h(l),h=null)})}else g._logger.log("trace","http response "+k.statusCode),h&&(h(null),h=null)});f.setTimeout(1E3,function(){g._logger.log("trace","http request timeout");f.abort()});f.on("error",function(k){g._logger.log("trace",
"http request error:"+k.message);h&&(h(null),h=null)});c&&f.write(c);f.end()};
xnm.aio.hue.Bridge.prototype._doRequestForAuth=function(a,b,c,d){var e="/api/"+this._USER+b;b||(e="/api");a={host:this.ip,port:this.port,path:e,method:a,headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};this._logger.log("debug","do auth:"+JSON.stringify(a));var g=this,h=d,f=null,k=require("http").request(a,function(n){g._logger.log("trace","do auth return status:"+n.statusCode);f=n.statusCode;if(200==n.statusCode){n.setEncoding("utf-8");var l=
"";n.on("data",function(r){l+=r});n.on("end",function(){g._logger.log("trace","do auth return:"+l);var r={};try{var q=JSON.parse(l);q&&q[0]&&q[0].error?(r.error="unknown",1==q[0].error.type&&(r.error="unauthorized"),101==q[0].error.type&&(r.error="unpressed")):r.data=q}catch(p){}h&&(h(r),h=null)})}else XC.debugf("Failed to post request to "+g.ip),h&&(h(null),h=null)});k.setTimeout(1E3,function(){g._logger.log("trace","do auth timeout");k.abort()});k.on("error",function(n){f&&"ECONNRESET"==n.code?
g._logger.log("trace","do auth connection reset"):(g._logger.log("trace","do auth error:"+n.message),h&&(h(null),h=null))});c&&k.write(c);k.end()};xnm.aio.hue.Bridge.prototype.getLights=function(a){this._doRequest("GET","/lights",null,function(b){a&&a(b)})};
xnm.aio.hue.Bridge.prototype.executeCommand=function(a,b,c,d){"power"==b&&(b="toggle");if("ct"==a.channel||3<b.length&&"CT:"==b.substr(0,3)){var e=Math.floor(500-3.46*parseInt(b));3<b.length&&"CT:"==b.substr(0,3)&&(e=parseInt(b.substr(3)));500<e&&(e=500);153>e&&(e=153);this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"ct": '+e+', "on": true}',c)}else if("on"==b)this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",JSON.stringify({on:!0}),
c);else if("off"==b)e={on:!1},a.manufacturer&&"osram"==a.manufacturer.toLowerCase()&&(e.transitiontime=0),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",JSON.stringify(e),c);else if("alertStop"==b||"alertOne"==b||"alertRepeat"==b)e="none","alertOne"==b?e="select":"alertRepeat"==b&&(e="lselect"),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"alert": "'+e+'"}',c);else if("effectNone"==b||"effectColorloop"==b)e="none","effectColorloop"==
b&&(e="colorloop"),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"effect": "'+e+'"}',c);else if("string"==typeof b&&"setscene"==b.substr(0,8))e=b.split("@"),2>e.length?c&&c():this._doRequest("PUT","/groups/"+a.address+"/action",'{"scene": "'+e[1]+'"}',c);else if("toggle"==b){var g=this;this._doRequest("GET",d?"/groups/"+a.address:"/lights/"+a.address,null,function(p){if(!p||p.error)c&&c(p);else if(p.data){if(a.type&&0==a.type.indexOf("On/Off"))p=p.data.state;
else if(d&&p.data.action&&null!=p.data.action.bri&&"undefined"!=typeof p.data.action.bri){var m=p.data.action.bri;p=p.data.action}else!d&&p.data.state&&null!=p.data.state.bri&&"undefined"!=typeof p.data.state.bri?(m=p.data.state.bri,p=p.data.state):(m=0,p={on:!1});var t={on:!0};a.type&&0==a.type.indexOf("On/Off")?p.on&&(t.on=!1):(p.on&&(t.on=!1,a.manufacturer&&"osram"==a.manufacturer.toLowerCase()&&(t.transitiontime=0)),t.on&&0==m&&(t.bri=10));m=JSON.stringify(t);g._doRequest("PUT",d?"/groups/"+a.address+
"/action":"/lights/"+a.address+"/state",m,c)}else c&&c({error:Error("no data field")})})}else if("up"==b||"down"==b)g=this,this._doRequest("GET",d?"/groups/"+a.address:"/lights/"+a.address,null,function(p){if(p&&p.error)c&&c(p);else{if(p&&p.data){var m=-1;d&&p.data.action&&null!=p.data.action.bri&&"undefined"!=typeof p.data.action.bri?m=p.data.action.bri:!d&&p.data.state&&null!=p.data.state.bri&&"undefined"!=typeof p.data.state.bri&&(m=p.data.state.bri);-1!=m&&(p=m,p="up"==b?Math.floor(p+25.4):Math.floor(p-
25.4),254<p&&(p=254),0>p&&(p=0),m='{"bri": '+p+', "on": true}',0==p&&(m='{"bri": '+p+', "on": false, "transitiontime":0}'),g._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",m,c),c=null)}c&&c()}});else if("string"==typeof b&&7<b.length&&"briRamp"==b.substr(0,7)){e=b.substr(7).split(":");var h=Math.floor(2.54*parseInt(e[0])),f=parseInt(e[1]);e=null;e=0==h?{on:!1,transitiontime:f}:{on:!0,bri:h,transitiontime:f};this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+
a.address+"/state",JSON.stringify(e),c)}else if(6==b.length){var k=parseInt(b.substr(0,2),16),n=parseInt(b.substr(2,2),16),l=parseInt(b.substr(4,2),16);e=this._RGBToHSV(k,n,l);var r=Math.floor(e[0]/360*65535+3E3),q=Math.floor(254*e[1]);"osram"===String(a.manufacturer).toLowerCase()&&(r-=3E3);65535<r?r=65535:0>r&&(r=0);254<q?q=254:0>q&&(q=0);g=this;this._doRequest("GET",d?"/groups/"+a.address:"/lights/"+a.address,null,function(p){if(p&&p.error)c&&c(p);else{if(p&&p.data){var m=-1;d&&p.data.action&&
null!=p.data.action.bri&&"undefined"!=typeof p.data.action.bri?m=p.data.action.bri:!d&&p.data.state&&null!=p.data.state.bri&&"undefined"!=typeof p.data.state.bri&&(m=p.data.state.bri);-1!=m&&(p.data.state&&"xy"==p.data.state.colormode?(p=g._RGBToXY(k,n,l),0==m&&(m=10),p=JSON.stringify({xy:p,on:!0,bri:m})):(p='{"hue": '+r+', "sat": '+q+', "on": true}',0==m&&(p='{"hue": '+r+', "sat": '+q+', "bri": 10, "on": true}')),g._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",p,
c),c=null)}c&&c()}})}else 8==b.length?(r=Math.floor(parseInt(b.substr(0,4),16)),q=Math.floor(parseInt(b.substr(4,2),16)),l=Math.floor(parseInt(b.substr(6,2),16)),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"hue": '+r+', "sat": '+q+', "bri": '+l+', "on": true}',c)):(h=Math.floor(2.54*parseInt(b)),254<h&&(h=254),0>h&&(h=0),e='{"bri": '+h+', "on": true}',0==h&&(e='{"bri": '+h+', "on": false, "transitiontime":0}'),this._doRequest("PUT",d?"/groups/"+a.address+
"/action":"/lights/"+a.address+"/state",e,c))};xnm.aio.hue.Bridge.prototype.authorizeUser=function(a){this._doRequest("POST",null,'{"username": "'+this._USER+'", "devicetype": "IQONTROL"}',a)};
xnm.aio.hue.Bridge.prototype.getStates=function(a,b,c){var d=this;this.CommandHandler=a;this.getLights(function(e){if(e&&e.error&&"unauthorized"==e.error)c&&c("AUT");else if(e&&e.data&&e.data.XC_ERR)XC.debugf("[xnm.aio.hue.Bridge.getStates] "+JSON.stringify(e.data),"error"),c&&c("XC_ERR",e.data.XC_ERR);else{if(e&&e.data)if(b&&d.CommandHandler.setState)for(var g=0;g<b.length;g++){var h=b[g],f;if(e.data[h.address]&&(f=e.data[h.address].state)){var k=d.getStateValues(h.subtype,f),n;for(n in k)"state"==
n?d.CommandHandler.setState(h.id,k[n]):d.CommandHandler.setState(h.id+":"+n,k[n])}}else if(d.CommandHandler.receivedState)for(g in e.data)d.CommandHandler.receivedState("hue",g,e.data[g].state);c&&c("OK")}})};xnm.aio.hue.Bridge.prototype.getStateValues=function(a,b){a={};b.on?(a.state=""+Math.round(b.bri/2.54),1==b.bri&&(a.state="1"),a.power="on"):(a.state="0",a.power="off");b.ct&&(a.ct=""+b.ct);return a};
xnm.aio.hue.Discovery=function(){var a=function(){};a.prototype.discoverBridges=function(b){};return a}();xnm.aio.hue.Handler=function(){var a=require("x.logger.js");xnm.aio.hue.DM._logger=a?a.getLogger("xnm.aio.hue.DM"):{log:function(){}};this._logger=a?a.getLogger("xnm.aio.hue.Handler"):{log:function(){}};this.detectedBridges={}};
xnm.aio.hue.Handler.prototype.discoverBridges=function(a){var b=this;(function(c){var d=require("x.upnp.js");d&&d.discoverDevices(function(e){if("hue"==e.type){b._logger.log("trace","upnp find hue:"+e.ip+" uuid:"+e.uuid);var g=new xnm.aio.hue.Bridge(e.ip,80,e.uuid);b.detectedBridges[e.uuid]=g;c(g)}})})(a);(function(c){var d=function(e,g){var h="http://"+e+"/description.xml";(new (require("x.upnp.js").DescLoader)(e)).load(h,function(f,k){g&&g(f,k)})};(function(e){var g=e;$.ajax({url:"https://discovery.meethue.com",
type:"GET",timeout:3E3,dataType:"text",cache:!0,success:function(h){b._logger.log("trace","nupnp request success:"+h);try{var f=JSON.parse(h);g&&(g(null,f),g=null)}catch(k){g&&(g(k),g=null)}},error:function(h,f){h="nupnp request error:"+(h?h.status:"0")+"-"+f;b._logger.log("trace",h);g&&(g(Error(h)),g=null)}})})(function(e,g){if(!e&&g&&0!=g.length)for(e=0;e<g.length;e++)g[e]&&g[e].internalipaddress&&d(g[e].internalipaddress,function(h,f){!h&&f&&"hue"==f.type&&(b._logger.log("trace","nupnp find hue:"+
f.ip+" uuid:"+f.uuid),h=new xnm.aio.hue.Bridge(f.ip,80,f.uuid),b.detectedBridges[f.uuid]=h,c(h))})})})(a);(function(c){var d=function(e,g){var h="http://"+e+"/description.xml";(new (require("x.upnp.js").DescLoader)(e)).load(h,function(f,k){g&&g(f,k)})};(function(e){var g=e;$.ajax({url:"https://www.meethue.com/api/nupnp",type:"GET",timeout:3E3,dataType:"text",cache:!0,success:function(h){b._logger.log("trace","nupnp request success:"+h);try{var f=JSON.parse(h);g&&(g(null,f),g=null)}catch(k){g&&(g(k),
g=null)}},error:function(h,f){h="nupnp request error:"+(h?h.status:"0")+"-"+f;b._logger.log("trace",h);g&&(g(Error(h)),g=null)}})})(function(e,g){if(!e&&g&&0!=g.length)for(e=0;e<g.length;e++)g[e]&&g[e].internalipaddress&&d(g[e].internalipaddress,function(h,f){!h&&f&&"hue"==f.type&&(b._logger.log("trace","nupnp find hue:"+f.ip+" uuid:"+f.uuid),h=new xnm.aio.hue.Bridge(f.ip,80,f.uuid),b.detectedBridges[f.uuid]=h,c(h))})})})(a)};xnm.aio.hue.Handler.prototype._NUPnP=function(a){};
xnm.aio.hue.Handler.prototype.Bridge=xnm.aio.hue.Bridge;xnm.aio.hue.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.hue.Bridge).getStateValues(a.type,b)};
xnm.aio.hue.Handler.prototype.getDeviceCommandList=function(a,b){var c=[];if("rgb"==a.data||"colortemplight"==a.data)b||("rgb"==a.data?c.push({id:window.XC_Text.colorvalue+" (RGBA)",cmd:"colorvalue"}):"colortemplight"==a.data&&c.push({id:window.XC_Text.colorvalue,cmd:"colorvalue"})),c.push({id:window.XC_Text.on,cmd:"on"}),c.push({id:window.XC_Text.off,cmd:"off"});else if(c.push({id:window.XC_Text.on,cmd:"on"}),c.push({id:window.XC_Text.off,cmd:"off"}),"dimmer"==a.data&&!b)for(a=0;100>=a;a+=5)c.push({id:a+
"%",cmd:""+a});return c};xnm.aio.hue.Bridge.prototype.authorizeUser2=function(a){a.__count||(a.__count=0);var b=this;this._doRequestForAuth("POST",null,'{"devicetype": "mediola#user"}',function(c){c&&c.data&&c.data[0]&&c.data[0].success&&c.data[0].success.username?(c=c.data[0].success.username,a&&a(null,c)):50<=a.__count?(c=Error("push button error"),a&&a(c)):(a.__count++,setTimeout(function(){b.authorizeUser2(a)},500))})};
xnm.aio.hue.Bridge.prototype.getGroupStates=function(a,b,c){var d=this;this.CommandHandler=a;b&&0!=b.length?xnm.aio.hue.Group.getAllGroups(this,function(e,g){if(e&&1==e.error)c&&c("AUT");else{if(g)if(b&&d.CommandHandler.setState)for(e=0;e<b.length;e++)for(var h=b[e],f,k=0;k<g.length;k++){if(g[k]&&g[k]._meta&&g[k]._meta.action&&g[k]._address==h.address){f=g[k]._meta.action;f=d.getStateValues(h.subtype,f);for(var n in f)"state"==n?d.CommandHandler.setState(h.id,f[n]):d.CommandHandler.setState(h.id+
":"+n,f[n])}}else if(d.CommandHandler.receivedState)for(k=0;k<g.length;k++)g[k]&&g[k]._meta&&g[k]._meta.action&&g[k]._address&&d.CommandHandler.receivedState("hue",g[k]._address,g[k]._meta.action,!0);c&&c("OK")}}):c&&c("OK")};
xnm.aio.hue.Bridge.prototype.executeCommandCreator=function(a,b,c){if(a)if(b){var d=b.value;if("rgb"==d||"rgbS"==d||"hue"==d||"bri"==d)d=b.ext;else if("ct"==d){d=parseInt(b.ext);if(!(153<=d||500>=d)){c&&c(Error("ct command invalid"));return}153>d&&(d=153);500<d&&(d=500);d="CT:"+d}else if("alert"==d)switch(d=b.ext,d){case "stop":d="alertStop";break;case "one":d="alertOne";break;case "repeat":d="alertRepeat";break;default:c&&c(Error("alert command ext invalid"));return}else if("effect"==d)switch(d=
b.ext,d){case "none":d="effectNone";break;case "colorloop":d="effectColorloop";break;default:c&&c(Error("effect command ext invalid"));return}else if("setScene"==d){d=b.ext;if(!d){c&&c(Error("setScene command ext invalid"));return}d="setscene@"+d}else if("briRamp"==d){if(!b.ext||0==b.ext.length)return c&&c(Error("briRamp command ext invalid")),null;for(d=0;d<b.ext.length;d++){var e=b.ext[d];if(e)switch(e.value){case "bri":var g=e.ext;break;case "transtime":var h=e.ext}}if("undefined"==typeof g||null==
g||"undefined"==typeof h||null==h){c&&c(Error("briRamp command ext invalid"));return}d="briRamp"+g+":"+h}a.manufacturer=a.manufacturername;switch(a.category){case "light":this.executeCommand(a,d,function(f){if(f&&f.error){var k=Error(f.error);"unauthorized"==f.error&&(k.code=1,k.module=xnm.aio.hue.DM.SYS)}c&&c(k)});break;case "group":this.executeCommandGroup(a,d,function(f){if(f&&f.error){var k=Error(f.error);"unauthorized"==f.error&&(k.code=1,k.module=xnm.aio.hue.DM.SYS)}c&&c(k)});break;default:c&&
c(Error("no such category:"+a.category))}}else c&&c(Error("command is null"));else c&&c(Error("device is null"))};
xnm.aio.hue.Bridge.prototype.getStatesCreator=function(a,b,c){if(b){a=[];for(var d=[],e=0;e<b.length;e++){var g=b[e];"group"==g.device.category?d.push({id:g.id,address:g.device.address}):a.push({id:g.id,address:g.device.address})}var h=[];e={};var f=this;e.receivedState=function(l,r,q,p){q=f.getStateValues(0,q);for(l=0;l<b.length;l++)if(b[l]&&b[l].device&&b[l].device.address==r&&b[l].status&&(!p||"group"==b[l].device.category))if("power"==b[l].status.value&&null!==q.power&&"undefined"!=typeof q.power){var m=
{id:b[l].id,status:q.power};h.push(m)}else"brightness"==b[l].status.value&&null!==q.state&&"undefined"!=typeof q.state?(m={id:b[l].id,status:parseInt(q.state)},h.push(m)):"ct"==b[l].status.value&&null!==q.ct&&"undefined"!=typeof q.ct&&(m=parseInt(q.ct),153<=m||500>=m)&&(m={id:b[l].id,status:m},h.push(m))};var k=3,n=c;this.getStates(e,a,function(l){k--;"AUT"==l?(l=Error(l),l.code=1,l.module=xnm.aio.hue.DM.SYS,n&&n(l)):0==k&&(n&&n(null,h),n=null)});this.getGroupStates(e,d,function(l){k--;"AUT"==l?(l=
Error(l),l.code=1,l.module=xnm.aio.hue.DM.SYS,n&&n(l),n=null):0==k&&(n&&n(null,h),n=null)});xnm.aio.hue.Sensor._getAllSensors(this,function(l,r){k--;if(l)n&&n(l),n=null;else{if(r)for(l=0;l<b.length;l++)if(b[l]){var q=b[l].id,p=b[l].device,m=b[l].status;if(q&&m&&m.value&&p&&p.address&&"sensor"==p.category){var t=r[p.address];if(t&&(p=xnm.aio.hue.Sensor._parseSensor(p.address,t))&&(p=p.getStates())){m=p[m.value];if("undefined"==typeof m||null==m)m="?";h.push({id:q,status:m})}}}0==k&&(n&&n(null,h),n=
null)}})}else c&&c(Error("deviceList is null"))};xnm.aio.hue.Bridge.prototype.executeCommandGroup=function(a,b,c){this.executeCommand(a,b,c,!0)};xnm.aio.hue.Bridge.prototype.getAllGroups=function(a){xnm.aio.hue.Group.getAllGroups(this,a)};xnm.aio.hue.Bridge.prototype.toJSON=function(){return{sys:xnm.aio.hue.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid,username:this._USER}};
xnm.aio.hue.Bridge.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.hue.Bridge?this.ip==a.ip&&this.port==a.port:!1};xnm.aio.hue.Bridge.prototype.getAllStates=function(a){xnm.aio.hue.Light.getAllLights(this,function(b,c){});xnm.aio.hue.Group.getAllGroups(this,function(b,c){});xnm.aio.hue.Sensor.getAllSensors(this,function(b,c){})};
xnm.aio.hue.Light=function(){var a=function(b,c){this._category=a.CATEGORY;this._address=b;this._meta=c};a.CATEGORY="light";a.getAllLights=function(b,c){var d=this;b.getLights(function(e){if(e)if(e.error){var g=Error(e.error);"unauthorized"==e.error&&(g.code=1,g.module=xnm.aio.hue.DM.SYS);c&&c(g)}else e.data?c&&c(null,d.parseLights(e.data)):c&&c(null,[]);else c&&c(Error("hue request error"))})};a.parseLights=function(b){for(var c=[],d=Object.keys(b),e=0;e<d.length;e++){var g=new a(d[e],b[d[e]]);c.push(g)}return c};
a.prototype.getStates=function(){if(!this._meta)return null;var b={};if(this._meta.state){var c=b=this._meta.state;c.on?(b.state=""+Math.round(c.bri/2.54),1==c.bri&&(b.state="1"),b.power="on"):(b.state="0",b.power="off");c.ct&&(b.ct=c.ct);"undefined"!=typeof c.hue&&null!=c.hue&&"undefined"!=typeof c.sat&&null!=c.sat&&"undefined"!=typeof c.bri&&null!=c.bri&&(c=xnm.aio.hue.Util._HSVToRGB(c.hue/65535,c.sat/254,c.bri/254),b.rgb=xnm.aio.hue.Util._RGBToHex(Math.round(c[0]),Math.round(c[1]),Math.round(c[2])))}return b};
a.prototype.toJSON=function(){var b=JSON.parse(JSON.stringify(this._meta));b.sys=xnm.aio.hue.DM.SYS;b.category=this._category;b.address=this._address;return b};return a}();
xnm.aio.hue.Group=function(){var a=function(b,c){this._category=a.CATEGORY;this._address=b;this._meta=c};a.prototype.toJSON=function(){var b=JSON.parse(JSON.stringify(this._meta));b.sys=xnm.aio.hue.DM.SYS;b.category=this._category;b.address=this._address;return b};a.CATEGORY="group";a.getAllGroups=function(b,c){var d=this,e,g;this._getGroupWithID(b,0,function(h,f){h?c&&c(h):(g=f,d._getGroups(b,function(k,n){k?c&&c(k):(e=n?n:{},g&&(e["0"]=g),c&&c(null,d._parseGroupList(e)))}))})};a.createGroup=function(b,
c,d){if(c)if(c.name)if(c.lights)if(c.lights.length){var e=this;this._createGroup(b,c,function(g,h){g?d&&d(g):e._getGroupWithID(b,h,function(f,k){f?d&&d(f):(f=new a(h,k),d&&d(null,f))})})}else d&&d(Error("group lights is empty"));else d&&d(Error("group lights is invalid"));else d&&d(Error("group name is invalid"));else d&&d(Error("group is null"))};a._getGroups=function(b,c){b._doRequest("GET","/groups",null,function(d){if(d)if(d.error){var e=Error(d.error);"unauthorized"==d.error&&(e.code=1,e.module=
xnm.aio.hue.DM.SYS);c&&c(e)}else d.data?c&&c(null,d.data):c&&c(Error("heu response format invalid"));else c&&c(Error("hue request error"))})};a._getGroupWithID=function(b,c,d){b._doRequest("GET","/groups/"+c,null,function(e){if(e)if(e.error){var g=Error(e.error);"unauthorized"==e.error&&(g.code=1,g.module=xnm.aio.hue.DM.SYS);d&&d(g)}else e.data?d&&d(null,e.data):d&&d(Error("heu response format invalid"));else d&&d(Error("hue request error"))})};a._createGroup=function(b,c,d){b._doRequest("POST","/groups",
JSON.stringify({name:c.name,lights:c.lights}),function(e){if(e)if(e.error){var g=Error(e.error);"unauthorized"==e.error&&(g.code=1,g.module=xnm.aio.hue.DM.SYS);d&&d(g)}else e.data&&e.data[0]&&e.data[0].success&&e.data[0].success.id?(e=e.data[0].success.id,0==e.indexOf("/groups/")&&(e=e.substr(8)),d&&d(null,e)):d&&d(Error("heu response format invalid"));else d&&d(Error("hue request error"))})};a._parseGroupList=function(b){for(var c=[],d=Object.keys(b),e=0;e<d.length;e++){"0"==d[e]&&(b[d[e]].name=
"All Lights");var g=new a(d[e],b[d[e]]);c.push(g)}return c};return a}();xnm.aio.hue.Scene=function(){var a=function(){};a.getAllScenes=function(b,c){b._doRequest("GET","/scenes",null,function(d){if(d)if(d.error){var e=Error(d.error);"unauthorized"==d.error&&(e.code=1,e.module=xnm.aio.hue.DM.SYS);c&&c(e)}else d.data?c&&c(null,d.data):c&&c(Error("heu response format invalid"));else c&&c(Error("hue request error"))})};return a}();
xnm.aio.hue.Sensor=function(){var a=function(f,k){this._category=a.CATEGORY;this._address=f;this._meta=k};a.CATEGORY="sensor";a.getAllSensors=function(f,k){var n=this;this._getAllSensors(f,function(l,r){l?k&&k(l):k&&k(null,n._parseSensors(r))})};a._parseSensors=function(f){for(var k=[],n=Object.keys(f),l=0;l<n.length;l++){var r=this._parseSensor(n[l],f[n[l]]);r&&k.push(r)}return k};a._parseSensor=function(f,k){switch(k.type){case "Daylight":return new b(f,k);case "ZGPSwitch":return new c(f,k);case "ZLLSwitch":return new d(f,
k);case "ZLLPresence":return new e(f,k);case "ZLLTemperature":return new g(f,k);case "ZLLLightLevel":return new h(f,k);default:return null}};a._getAllSensors=function(f,k){f._doRequest("GET","/sensors",null,function(n){if(n)if(n.error){var l=Error(n.error);"unauthorized"==n.error&&(l.code=1,l.module=xnm.aio.hue.DM.SYS);k&&k(l)}else n.data?k&&k(null,n.data):k&&k(Error("hue response format invalid"));else k&&k(Error("hue request error"))})};a.prototype.getType=function(){return this._meta?this._meta.type:
null};a.prototype.getAddress=function(){return this._address};a.prototype.getStates=function(){return null};a.prototype.toJSON=function(){var f=JSON.parse(JSON.stringify(this._meta));f.sys=xnm.aio.hue.DM.SYS;f.category=this._category;f.address=this._address;return f};var b=function(f,k){a.call(this,f,k)};b.prototype=new a;b.prototype.constructor=b;b.prototype.getStates=function(){if(!this._meta)return null;var f={};this._meta.state&&(f.daylight=this._meta.state.daylight,f.ltime=this._meta.state.lastupdated);
return f};var c=function(f,k){a.call(this,f,k)};c.prototype=new a;c.prototype.constructor=c;c.prototype.getStates=function(){if(!this._meta)return null;var f={};if("FOHSWITCH"==this._meta.modelid){if(this._meta.state){switch(this._meta.state.buttonevent){case 20:f.levent="Press_Button1";break;case 21:f.levent="Press_Button2";break;case 23:f.levent="Press_Button3";break;case 22:f.levent="Press_Button4"}f.ltime=this._meta.state.lastupdated}}else if(this._meta.state){switch(this._meta.state.buttonevent){case 34:f.levent=
"Press_Button1";break;case 16:f.levent="Press_Button2";break;case 17:f.levent="Press_Button3";break;case 18:f.levent="Press_Button4"}f.ltime=this._meta.state.lastupdated}return f};var d=function(f,k){a.call(this,f,k)};d.prototype=new a;d.prototype.constructor=d;d.prototype.getStates=function(){if(!this._meta)return null;var f={};if(this._meta.state){switch(this._meta.state.buttonevent){case 1E3:f.levent="ROM001"==this._meta.modelid?"INITIAL_PRESS":"ON";break;case 1001:f.levent="ROM001"==this._meta.modelid?
"HOLD":"ON";break;case 1002:f.levent="ROM001"==this._meta.modelid?"SHORT_RELEASED":"ON";f.btn1event="shortPress";break;case 1003:f.levent="ROM001"==this._meta.modelid?"LONG_RELEASED":"ON";f.btn1event="longPress";break;case 2E3:case 2001:case 2002:case 2003:2002==this._meta.state.buttonevent?f.btn2event="shortPress":2003==this._meta.state.buttonevent&&(f.btn2event="longPress");f.levent="DIM_UP";break;case 3E3:case 3001:case 3002:case 3003:3002==this._meta.state.buttonevent?f.btn3event="shortPress":
3003==this._meta.state.buttonevent&&(f.btn3event="longPress");f.levent="DIM_DOWN";break;case 4E3:case 4001:case 4002:case 4003:4002==this._meta.state.buttonevent?f.btn4event="shortPress":4003==this._meta.state.buttonevent&&(f.btn4event="longPress"),f.levent="OFF"}f.ltime=this._meta.state.lastupdated;this._meta.config&&("undefined"!=typeof this._meta.config.battery&&null!=this._meta.config.battery&&(f.battery=this._meta.config.battery),"undefined"!=typeof this._meta.config.reachable&&null!=this._meta.config.reachable&&
(f.reachable=this._meta.config.reachable))}return f};var e=function(f,k){a.call(this,f,k)};e.prototype=new a;e.prototype.constructor=e;e.prototype.getStates=function(){if(!this._meta)return null;var f={};this._meta.state&&(f.motion=this._meta.state.presence,f.motion2=this._meta.state.presence?"on":"off",f.ltime=this._meta.state.lastupdated);this._meta.config&&(f.battery=this._meta.config.battery);return f};var g=function(f,k){a.call(this,f,k)};g.prototype=new a;g.prototype.constructor=g;g.prototype.getStates=
function(){if(!this._meta)return null;var f={};this._meta.state&&(f.temperature=this._meta.state.temperature/100,f.ltime=this._meta.state.lastupdated);this._meta.config&&(f.battery=this._meta.config.battery);return f};var h=function(f,k){a.call(this,f,k)};h.prototype=new a;h.prototype.constructor=h;h.prototype.getStates=function(){if(!this._meta)return null;var f={};this._meta.state&&(f.lightlevel=this._meta.state.lightlevel,f.dark=this._meta.state.dark,f.daylight=this._meta.state.daylight,f.ltime=
this._meta.state.lastupdated);this._meta.config&&(f.battery=this._meta.config.battery);return f};return a}();
xnm.aio.hue.MAP={onoff:{command:[{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"alert",ref:{value:"alert",ext:"%e",extMeta:["stop","one","repeat"]}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},dimmable:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}},
{type:"multi",name:"brightness (transition)",ref:{value:"briRamp",ext:"%multi",extMeta:[{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}},{type:"int",name:"transition time (100ms)",ref:{value:"transtime",ext:"%d",extMeta:"0-16343"}}]}}],status:[{type:"int",name:"brightness",ref:{value:"brightness",extMeta:"0-100"}}]},colortemp:{command:[{type:"int",name:"color temperature (mired)",ref:{value:"ct",value_t:"ctMired",ext:"%d",extMeta:"153-500",scale:"1"}}],status:[{type:"int",
name:"color temperature (mired)",ref:{value:"ct",value_t:"ctMired",extMeta:"153-500",scale:"1"}}]},colorlight:{command:[{type:"string",name:"rgb color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"rgb color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"effect",ref:{value:"effect",ext:"%e",extMeta:["none","colorloop"]}},{type:"string",name:"hsb color",ref:{value:"hue",ext:"%s"}}]},extendcolor:{},group:{command:[{type:"dynamic",name:"set scene",ref:{value:"setScene",ext:"%dynamic"}}]},sensor:{Daylight:{status:[{type:"enum",
name:"day light",ref:{value:"daylight",options:["true","fasle"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"event",options:["sunrise","sunset"]}}]},ZGPSwitch:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["Press_Button1","Press_Button2","Press_Button3","Press_Button4"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"levent",options:["Press_Button1","Press_Button2",
"Press_Button3","Press_Button4"]}}]},ZLLSwitch:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["ON","DIM_UP","DIM_DOWN","OFF"]}},{type:"enum",name:"last button",ref:{value:"lbutton",options:["button1","button2","button3","button4"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"levent",options:["ON","DIM_UP","DIM_DOWN","OFF"]}},{type:"enum",name:"button 1 event",ref:{value:"btn1event",options:["shortPress","longPress"]}},
{type:"enum",name:"button 2 event",ref:{value:"btn2event",options:["shortPress","longPress"]}},{type:"enum",name:"button 3 event",ref:{value:"btn3event",options:["shortPress","longPress"]}},{type:"enum",name:"button 4 event",ref:{value:"btn4event",options:["shortPress","longPress"]}}]},SmartButton:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["INITIAL_PRESS","HOLD","SHORT_RELEASED","LONG_RELEASED"]}},{type:"int",name:"battery",ref:{value:"battery",extMeta:"0-100"}},{type:"enum",
name:"reachable",ref:{value:"reachable",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"int",name:"battery",ref:{value:"battery",extMeta:"0-100"}},{type:"enum",name:"button event",ref:{value:"btn1event",options:["shortPress","longPress"]}}]},ZLLPresence:{status:[{type:"enum",name:"detect motion",ref:{value:"motion",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}},
{type:"enum",name:"detect motion (on/off)",ref:{value:"motion2",options:["on","off"]}}],ipevt:[{type:"enum",name:"detect motion",ref:{value:"motion",options:["true","false"]}}]},ZLLTemperature:{status:[{type:"float",name:"temperature",ref:{value:"temperature"}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}}],ipevt:[{type:"float",name:"temperature",ref:{value:"temperature"}},{type:"int",name:"battery",ref:{value:"battery"}}]},ZLLLightLevel:{status:[{type:"int",
name:"light level",ref:{value:"lightlevel"}},{type:"enum",name:"dark",ref:{value:"dark",options:["true","false"]}},{type:"enum",name:"daylight",ref:{value:"daylight",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}}],ipevt:[{type:"int",name:"light level",ref:{value:"lightlevel"}},{type:"enum",name:"dark",ref:{value:"dark",options:["true","false"]}},{type:"enum",name:"daylight",ref:{value:"daylight",options:["true",
"false"]}},{type:"int",name:"battery",ref:{value:"battery"}}]}}};xnm.aio.hue.DMError=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};xnm.aio.hue.DMError.prototype=Error();xnm.aio.hue.DMError.prototype.name="HUEDeviceManagerError";xnm.aio.hue.DMError.prototype.code=0;xnm.aio.hue.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.hue.DM={SYS:"hue",getGatewayType:function(){return[{sys:this.SYS,name:"Philips Hue"}]},createGateway:function(a,b,c){b=xnm.aio.hue.DMError;var d=xnm.aio.hue.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new b(d.INVALID,"ip is invalid")):c(new b(d.INVALID,"info is invalid"))},updateGateway:function(a,b,c,d){a=xnm.aio.hue.DMError;c=xnm.aio.hue.DMError.ERROR_CODE;b?b.ip?d(null,b):d(new a(c.INVALID,"ip is invalid")):d(new a(c.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,
b,c){var d=xnm.aio.hue.DMError,e=xnm.aio.hue.DMError.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)c(new d(e.INVALID,"address is invalid"));else if(a.category)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var g;for(g=0;g<b.length;g++)if(b[g].index===a.gateway){var h=b[g];break}h?c(null,a):c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else c(new d(e.INVALID,
"catagory is invalid"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var d=xnm.aio.hue.DMError,e=xnm.aio.hue.DMError.ERROR_CODE;if(a)if(null==a.address||"undefined"==typeof a.address)c(new d(e.INVALID,"address is invalid"));else if(a.category)if(a.gateway){b=b.data.gateways;var g;for(g=0;g<b.length;g++)if(b[g].index===a.gateway){var h=b[g];break}h?c(null,a):c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(e.INVALID,
"gateway is invalid"));else c(new d(e.INVALID,"catagory is invalid"));else c(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=function(f,k){if("*"==f)return!0;for(var n=!1,l=0;l<f.length;l++)if(f[l]==k){n=!0;break}return n},d=function(f,k,n){var l=[];switch(n.catagory){case "command":f.command&&f.command.forEach(function(r){c(n.elems,r.type)&&(r=JSON.parse(JSON.stringify(r)),l.push(r))});break;case "status":f.status&&f.status.forEach(function(r){c(n.elems,
r.type)&&(r=JSON.parse(JSON.stringify(r)),l.push(r))})}return l},e=function(f,k){var n=[],l=xnm.aio.hue.DM.getCommandStatusMap(f);l&&(f=d(l,f,k),n=n.concat(f));return n};if(!a.category)return null;var g=JSON.parse(JSON.stringify(a)),h=null;switch(b.catagory){case "command":h=e(a,b);g.command=h;break;case "status":h=e(a,b);g.status=h;break;default:return null}return h&&0!=h.length?g:null},applyIPEventFilter:function(a,b){if(!a.sys||"sensor"!=a.category)return null;b=this.getCommandStatusMap(a);if(!b)return null;
a=JSON.parse(JSON.stringify(a));a.ipevt=b.ipevt;return a},getCommandStatusMap:function(a,b){b=function(g,h){var f=[],k=[];g&&g.command&&0<g.command.length&&(f=f.concat(g.command));h&&h.command&&0<h.command.length&&(f=f.concat(h.command));g&&g.status&&0<g.status.length&&(k=k.concat(g.status));h&&h.status&&0<h.status.length&&(k=k.concat(h.status));return{command:f,status:k}};if(!a.type)return null;if("sensor"==a.category)return"ROM001"==a.modelid?xnm.aio.hue.MAP.sensor.SmartButton:xnm.aio.hue.MAP.sensor[a.type];
var c=a.type.toLowerCase(),d=[];if(a.state||a.action){var e=a.state;if("room"==c||"lightgroup"==c||"luminaire"==c||"lightsource"==c||"zone"==c)e=a.action;e&&(null!=e.on&&"undefined"!=typeof e.on&&(d=b(d,xnm.aio.hue.MAP.onoff)),null!=e.bri&&"undefined"!=typeof e.bri&&(d=b(d,xnm.aio.hue.MAP.dimmable)),null!=e.ct&&"undefined"!=typeof e.ct&&(d=b(d,xnm.aio.hue.MAP.colortemp)),null!=e.hue&&"undefined"!=typeof e.hue&&(d=b(d,xnm.aio.hue.MAP.colorlight)),"room"==c||"lightgroup"==c||"luminaire"==c||"lightsource"==
c||"zone"==c)&&(d=b(d,xnm.aio.hue.MAP.group))}else switch(a.type.toLowerCase()){case "on/off light":case "on/off plug-in unit":d=xnm.aio.hue.MAP.onoff;break;case "dimmable light":case "dimmable plug-in unit":d=b(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable);break;case "color temperature light":d=b(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.colortemp);break;case "color light":d=b(b(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable),xnm.aio.hue.MAP.colorlight);break;case "extended color light":case "lightgroup":case "luminaire":case "lightsource":if(d=
b(b(b(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable),xnm.aio.hue.MAP.colortemp),xnm.aio.hue.MAP.colorlight),"lightgroup"==c||"luminaire"==c||"lightsource"==c)d=b(d,xnm.aio.hue.MAP.group)}return d},supportSmartWidget:function(a){if(!a||!a.type)return!1;if("ZLLPresence"==a.type)return!0;a=this.applyUIFilter(a,{catagory:"command",elems:"*"});if(!a||!a.command||0==a.command.length)return!1;for(var b=0;b<a.command.length;b++){var c=a.command[b];if(c&&c.ref&&("on"==c.ref.value||"up"==c.ref.value||"ct"==
c.ref.value||"rgb"==c.ref.value))return!0}return!1},applySmartWidgetFilter:function(a,b,c){if(!a||!a.type)return!1;var d=this.applyUIFilter(a,{catagory:"command",elems:"*"});if(!d||!d.command||0==d.command.length)return!1;for(var e=!1,g=!1,h=!1,f=!1,k=0;k<d.command.length;k++){var n=d.command[k];n&&n.ref&&("on"==n.ref.value&&(e=!0),"up"==n.ref.value&&(g=!0),"ct"==n.ref.value&&(h=!0),"rgb"==n.ref.value&&(f=!0))}var l;if("ZLLPresence"==a.type){var r={"%motionState%":{value:"motion2",options:["on","off"],
name:"detect motion (on/off)"}};var q=["motion"]}e&&(l||(l={}),l["%on%"]||(l["%on%"]={value:"on",name:"on"}),l["%off%"]||(l["%off%"]={value:"off",name:"off"}),l["%toggle%"]||(l["%toggle%"]={value:"toggle",name:"toggle"}),r||(r={}),r["%switchState%"]||(r["%switchState%"]={value:"power",options:["off","on"],name:"power"}),q||(q=[]),-1==q.indexOf("switch")&&q.push("switch"));g&&(l||(l={}),l["%dimOn%"]||(l["%dimOn%"]={value:"on",name:"on"}),l["%dimOff%"]||(l["%dimOff%"]={value:"off",name:"off"}),l["%dimUp%"]||
(l["%dimUp%"]={value:"up",name:"up"}),l["%dimDown%"]||(l["%dimDown%"]={value:"down",name:"down"}),l["%dimTo%"]||(l["%dimTo%"]={value:"bri",ext:"%d",extMeta:"0-100",name:"brightness"}),r||(r={}),r["%dimmerState%"]||(r["%dimmerState%"]={value:"brightness",name:"brightness"}),q||(q=[]),-1==q.indexOf("dimmer")&&q.push("dimmer"));h&&(l||(l={}),l["%colorTemp%"]||(l["%colorTemp%"]={value:"ct",ext:"%d",extMeta:"153-500",name:"color temperature"}),q||(q=[]),-1==q.indexOf("color_temp")&&q.push("color_temp"));
f&&(l||(l={}),l["%rgb%"]||(l["%rgb%"]={value:"rgb",ext:"%s",name:"rgb color"}),l["%white%"]||(l["%white%"]={value:"rgbS",ext:"FFFFFF",name:"rgb color"}),q||(q=[]),-1==q.indexOf("rgb")&&q.push("rgb"));return q&&0!=q.length?this._injectToSmartWidgetTemplate(b,q,c,l,r):null},_injectToSmartWidgetTemplate:function(a,b,c,d,e){var g=[];a||(d={});d||(d={});e||(e={});for(var h=0;h<a.length;h++){var f=a[h];if(f.meta&&-1!=b.indexOf(f.meta.type)&&f.elements){f=JSON.parse(JSON.stringify(f));var k=!1,n;for(n in f.elements){var l=
f.elements[n];if(l&&Array.isArray(l))for(var r=0;r<l.length;r++){var q=l[r];q&&(q.action&&"command"==q.action.type&&q.action.ref&&q.action.ref.value&&(d[q.action.ref.value]?(q.action.ref=d[q.action.ref.value],q.action.device=c,k=!0):q.action=null),q.status&&q.status.ref&&q.status.ref.value&&(e[q.status.ref.value]?(q.status.ref=e[q.status.ref.value],q.status.device=c,k=!0):q.status=null))}}k&&g.push(f)}}return g}};
xnm.aio.hue.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"hue")};xnm.aio.hue.Handler.prototype.devicemanager=xnm.aio.hue.DM;xnm.aio.hue.Handler.prototype.Light=xnm.aio.hue.Light;xnm.aio.hue.Handler.prototype.Group=xnm.aio.hue.Group;xnm.aio.hue.Handler.prototype.Scene=xnm.aio.hue.Scene;xnm.aio.hue.Handler.prototype.Sensor=xnm.aio.hue.Sensor;
xnm.aio.hue.Handler.prototype.discoverBridgesWithTimeout=function(a,b){this._discoverCallbacks||(this._discoverCallbacks=[]);for(var c=!1,d=0;d<this._discoverCallbacks.length;d++)if(this._discoverCallbacks[d]===b){c=!0;break}c||this._discoverCallbacks.push(b);var e=this,g=[];10>=a&&(a=10);setTimeout(function(){if(null!=e._discoverCallbacks)for(var h=0;h<e._discoverCallbacks.length;h++)e._discoverCallbacks[h](null,g);e._discoverCallbacks=null},1E3*a);this.discoverBridges(function(h){if(h){for(var f=
0;f<g.length;f++)if(g[f].uuid==h.uuid)return;g.push(h)}})};xnm.aio.hue.Handler.prototype.auth=function(a,b){a.ip?(a=this.resolveGateway(a))?a.authorizeUser2(function(c,d){b&&b(c,d)}):b&&b(Error("gateway json format invalid")):b&&b(Error("bridge format invalid"))};
xnm.aio.hue.Handler.prototype.getDeviceList=function(a,b){if(a.ip)if(a=this.resolveGateway(a)){var c=3,d=[];xnm.aio.hue.Light.getAllLights(a,function(e,g){c--;g&&(d=d.concat(g));0==c&&b&&b(e,d)});xnm.aio.hue.Group.getAllGroups(a,function(e,g){c--;g&&(d=d.concat(g));0==c&&b&&b(e,d)});xnm.aio.hue.Sensor.getAllSensors(a,function(e,g){c--;g&&(d=d.concat(g));0==c&&b&&b(e,d)})}else b&&b(Error("gateway json format invalid"));else b&&b(Error("bridge format invalid"))};
xnm.aio.hue.Handler.prototype.createGroup=function(a,b,c){a.ip?(a=this.resolveGateway(a))?xnm.aio.hue.Group.createGroup(a,b,c):c&&c(Error("gateway json format invalid")):c&&c(Error("bridge format invalid"))};xnm.aio.hue.Handler.prototype.resolveGateway=function(a){return new xnm.aio.hue.Bridge(a.ip,a.port,a.uuid,null,a.username)};xnm.aio.hue.Handler.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.hue.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};
xnm.aio.hue.Handler.prototype.getDeviceStatus=function(a,b){a=(a=xnm.aio.hue.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};xnm.aio.hue.Handler.prototype.getSceneCommands=function(a,b){a.ip?(a=this.resolveGateway(a))?xnm.aio.hue.Scene.getAllScenes(a,function(c,d){if(c)b&&b(c);else{c={};if(d)for(var e in d)d.hasOwnProperty(e)&&d[e]&&d[e].name&&(c[e]=d[e].name);b&&b(null,c)}}):b&&b(Error("gateway json format invalid")):b&&b(Error("bridge format invalid"))};
xnm.aio.hue.Handler.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(e){d&&d(e)}):d&&d(Error("gateway json format invalid"))};xnm.aio.hue.Handler.prototype.doStatus=function(a,b,c,d,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(g,h){g?e&&e(g):e&&e(null,h[0])}):e&&e(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.hue.Handler);
