var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.icomfort=xnm.aio.icomfort||{},xnm.aio.icomfort.Gateway=function(t){this.ip=t,this.port=5555,this.uuid=null,this._connection=null,this._learnedDeviceCallback=null,this._devicesToGetStatesFor=[],this._states={},this._gotStatesCallback=null,this._sentCommandCallback=null,this._stateAddress=null,this._gotStateCallback=null,this._rooms={};},xnm.aio.icomfort.Gateway.prototype._closeConnection=function(){this._connection&&this._connection.end(),this._learnedDeviceCallback&&(this._learnedDeviceCallback(null),this._learnedDeviceCallback=null),this._gotStatesCallback&&(this._gotStatesCallback(this._states),this._gotStatesCallback=null),this._sentCommandCallback&&(this._sentCommandCallback(),this._sentCommandCallback=null);},xnm.aio.icomfort.Gateway.prototype._getData=function(t){for(var e={},o=t.split("&"),a=0;a<o.length;a++){var i=o[a].split("=");2==i.length&&(e[i[0]]=i[1]);}return e;},xnm.aio.icomfort.Gateway.prototype._evalState=function(t){return"00"==t?"off":"3F"==t?"on":Math.round(parseInt(t,16)/62*100)+"%";},xnm.aio.icomfort.Gateway.prototype._evalEData=function(t){var e=this._getData(t);e.a&&this._learnedDeviceCallback&&(this._learnedDeviceCallback({address:e.a}),this._learnedDeviceCallback=null,this._closeConnection());},xnm.aio.icomfort.Gateway.prototype._evalGData=function(t){var e=this._getData(t);if(this._devicesToGetStatesFor.length>0)for(var o=0;o<this._devicesToGetStatesFor.length;o++){var a=this._devicesToGetStatesFor[o];if(a.address==e.a){this._devicesToGetStatesFor.splice(o,1),this._states[a.address]=this._evalState(e.d),this._getNextState();break;}}else this._gotStateCallback?this._stateAddress==e.a&&(this._gotStateCallback(this._evalState(e.d)),this._gotStateCallback=null):this._sentCommandCallback&&this._closeConnection();},xnm.aio.icomfort.Gateway.prototype._evalBlock=function(t){t.length>2&&("E?"==t.substr(0,2)?this._evalEData(t.substr(2)):"G?"==t.substr(0,2)||"F?"==t.substr(0,2)?this._evalGData(t.substr(2)):XC.debugf(t));},xnm.aio.icomfort.Gateway.prototype._connect=function(t){var e="",o=require("net"),a=this;this._connection=o.connect({port:this.port,host:this.ip},function(){t&&t();}),this._connection.on("data",function(t){var o;for(e+=t.toString();(o=e.indexOf("\n"))>0;)a._evalBlock(e.substr(0,o)),e=e.substr(o+1);}),this._connection.on("end",function(){XC.debugf("END");}),this._connection.on("error",function(){XC.debugf("ERROR"),a._closeConnection();});},xnm.aio.icomfort.Gateway.prototype._executeCommand=function(t,e){if(this._connection){var o="00";"on"==e?o="3F":"off"==e?o="00":(0==e.indexOf("dimTo")&&(e=e.replace(/dimTo/g,"")),e=e.replace(/%/g,""),o=XC.getHexVal(Math.round(parseInt(e)/100*62),2));var a=new Buffer("S?a="+t+"&d="+o+"\n");this._connection.write(a);}else this._closeConnection();},xnm.aio.icomfort.Gateway.prototype._getNextState=function(){if(this._devicesToGetStatesFor.length>0){var t=this._devicesToGetStatesFor[0],e=new Buffer("G?a="+t.address+"\n");this._connection.write(e);}else this._closeConnection();},xnm.aio.icomfort.Gateway.prototype._getState=function(t,e){this._gotStateCallback=e,this._stateAddress=t;var o=new Buffer("G?a="+t+"\n");this._connection.write(o);},xnm.aio.icomfort.Gateway.prototype.sendCommand=function(t,e,o){this._sentCommandCallback=o;var a=this;this._connect(function(){"toggle"==e?a._getState(t,function(e){"off"==e?a._executeCommand(t,"on"):a._executeCommand(t,"off");}):a._executeCommand(t,e);});},xnm.aio.icomfort.Gateway.prototype.learnDevice=function(t){this._learnedDeviceCallback=t,this._connect();},xnm.aio.icomfort.Gateway.prototype.getStates=function(t,e){this._states={},this._devicesToGetStatesFor=t,this._gotStatesCallback=e;var o=this;this._connect(function(){o._getNextState();});},xnm.aio.icomfort.Discovery=function(){this.Gateways={},this.callback=null,this._sockets=[];var t=require("os");if(require("dgram"),t&&t.networkInterfaces){var e=t.networkInterfaces();for(var o in e)for(var a=e[o],i=0;i<a.length;i++)this._addDiscoverSocket(5556,a[i]);}else this._addDiscoverSocket(5556,null);},xnm.aio.icomfort.Discovery.prototype._receivedData=function(t,e){36==(e=e.toString()).length&&"REV ICOMFORT"==e.substr(0,12)&&(this.Gateways[t]=new xnm.aio.icomfort.Gateway(t),this.Gateways[t].uuid=e.substr(17,17),this.callback&&this.callback(this.Gateways[t]));},xnm.aio.icomfort.Discovery.prototype._addDiscoverSocket=function(t,e){var o,a=require("dgram"),i=this;e?"IPv4"==e.family&&0==e.internal&&((o=a.createSocket("udp4")).on("listening",function(){o.setBroadcast(!0);}),o.on("message",function(t,e){i._receivedData(e.address,t);}),o.bind(t,e.address),this._sockets.push(o)):((o=a.createSocket("udp4")).on("message",function(t,e){i._receivedData(e.address,t);}),o.bind(t),this._sockets.push(o));},xnm.aio.icomfort.Discovery.prototype._sendDiscoveryMessages=function(t,e,o,a){t=new Buffer([68]);for(var i=0;i<this._sockets.length;i++)this._sockets[i].send(t,0,t.length,5556,"255.255.255.255");},xnm.aio.icomfort.Discovery.prototype.discoverGateways=function(){this._sendDiscoveryMessages();},xnm.aio.icomfort.Handler=function(){this._Discovery=null;},xnm.aio.icomfort.Handler.prototype.discoverGateways=function(t){this._Discovery||(this._Discovery=new xnm.aio.icomfort.Discovery()),t&&(this._Discovery.callback=t),this._Discovery.discoverGateways();},xnm.aio.icomfort.Handler.prototype.getDetectedGateways=function(){return this._Discovery||(this._Discovery=new xnm.aio.icomfort.Discovery()),this._Discovery.Gateways;},xnm.aio.icomfort.Handler.prototype.Gateway=xnm.aio.icomfort.Gateway,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.icomfort.Handler());