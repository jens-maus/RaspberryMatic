var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.iobroker=xnm.aio.iobroker||{};
xnm.aio.iobroker.SimpleAPI=function(){var d=function(a,b,c,e,f){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.iobroker.SimpleAPI");this.ip=a;this.port=b;this.port||(this.port=8087);this.username=c;this.password=e;this.https=f;this._getStatesCBs=[]};d.prototype.executeCommand=function(a,b,c){if(a&&a.id)if(b&&b.value)switch(b.value){case "setValue":if(void 0==b.ext||null==b.ext){c&&c(Error("value invalid"));break}this._set(a.id,
{value:b.ext},c);break;case "toggleValue":this._toggle(a.id,c);break;default:c&&c(Error("unknown command"))}else c&&c(Error("command invalid"));else c&&c(Error("device invalid"))};d.prototype.getStates=function(a,b){var c=this._getStatesCBs.length;this._getStatesCBs.push(b);if(!(0<c)){var e=this;b=null;if(1===a.length)b=a[0];else if(1<a.length){a.sort(function(a,b){return a.length-b.length});c=a[0].split(".");for(var f="",g=0,d=Math.min(c.length,8);g<d;){for(var l=f+c[g],n=!1,m=1;m<a.length;m++)if(0!==
a[m].indexOf(l)){n=!0;break}if(n)break;f=l+".";g++}f&&("."===f[f.length-1]&&(f=f.substr(0,f.length-1)),b=f+"*",XC.debugf("ioBroker states pattern: "+b))}this._states(b,function(b,c){var f=e._getStatesCBs,g,d=null;e._getStatesCBs=[];if(b)XC.debugf(b.message,"error");else if(a&&0!=a.length)for(d={},g=0;g<a.length;g++)c[a[g]]&&(d[a[g]]=c[a[g]].val);else d=c;for(g=0;g<f.length;g++)f[g]&&f[g](b,d)})}};d.prototype.executeCommandCreator=function(a,b,c){b&&b.value?a&&a.id?(b=this._resolveCommand(a,b))?this.executeCommand(a,
b,function(a){c&&c(a)}):c&&c(Error("unknown command")):c&&c(Error("device json invalid")):c&&c(Error("command json invalid"))};d.prototype._resolveCommand=function(a,b){if(!b)return null;if("setGenValue"==b.value){var c=b.ext;if("undefined"==typeof c||null==c)c="";return{value:"setValue",ext:c}}if("toggle"==b.value)return{value:"toggleValue"};if(!a.common||!b.value)return null;switch(a.common.type){case "boolean":switch(b.value){case "on":case "press":case "longPress":case "stop":case "start":case "open":case "unlock":case "play":case "next":case "prev":case "pause":case "forward":case "reverse":case "fastforward":case "fastreverse":return{value:"setValue",
ext:!0};case "off":case "lock":return{value:"setValue",ext:!1}}break;case "number":c=a.common.min;a=a.common.max;switch(b.value){case "setValue":if("undefined"==typeof b.ext||null==b.ext)return null;b=parseFloat(b.ext);if(isNaN(b))return null;"undefined"==typeof c||null==c||isNaN(parseFloat(c))||b<parseFloat(c)&&(b=parseFloat(c));"undefined"==typeof a||null==a||isNaN(parseFloat(a))||b>parseFloat(a)&&(b=parseFloat(a));return{value:"setValue",ext:b};case "setRGB":return"undefined"==typeof b.ext||null==
b.ext?null:{value:"setValue",ext:cparseInt(b.ext,16)}}break;case "string":return"undefined"==typeof b.ext||null==b.ext?null:{value:"setValue",ext:b.ext};default:return null}};d.prototype.getStatesCreator=function(a,b,c){if(b)if(0==b.length)c&&c(null,[]);else{a=[];for(var e=0;e<b.length;e++){var f=b[e];f&&f.device&&f.device.id&&-1==a.indexOf(f.device.id)&&a.push(f.device.id)}var g=this;this.getStates(a,function(a,e){if(a)c&&c(a);else{a=[];for(var f=0;f<b.length;f++){var d=b[f];if(d&&d.id){var k=null;
d.device&&d.device.id&&d.status&&(k=e[d.device.id],k=g._resolveState(d.device,d.status,k));if("undefined"==typeof k||null==k)k="?";a.push({id:d.id,status:k})}}c&&c(null,a)}})}else c&&c(Error("deviceList is null"))};d.prototype._resolveState=function(a,b,c){if("undefined"==typeof c||null==c)return null;if(!b||!b.value||"genValue"==b.value)return c;if(!a||!a.common)return null;switch(a.common.type){case "boolean":switch(a.common.role){case "state":case "sensor.light":case "sensor.motion":case "sensor.rain":case "switch":case "switch.boost":case "switch.light":case "switch.comfort":case "media.mode.shuffle":case "media.mode.repeat":case "media.mute":return c?
"on":"off";case "sensor.window":case "sensor.door":return c?"open":"closed";case "sensor.lock":case "switch.lock":case "switch.lock.door":case "switch.lock.window":return c?"unlock":"lock";case "media.state":return c?"play":"stop";default:return c}case "number":switch(a.common.role){case "value.window":return a.common.states?a.common.states[c]:{0:"closed",1:"titled",2:"open"}[c];case "value.time":return parseInt(c);case "media.state":return a.common.states?a.common.states[c]:{0:"play",1:"stop",2:"pause"}[c];
default:return a.common.states?a.common.states[c]:parseFloat(c)}case "string":return c;default:return c}};d.prototype.getStateObjectTree=function(a){var b=[],c=this;this._objects("instance",null,function(e,f){if(e)a&&a(e);else{e=0;for(var d in f)e++,c._insertTree(b,{id:d,name:d,type:f[d].type,children:[]});c._logger.log("debug","Found "+e+" instances.");c._objects("device",null,function(e,d){if(e)a&&a(e);else{e=0;for(var f in d)e++,c._insertTree(b,{id:f,name:f,type:d[f].type,children:[]});c._logger.log("debug",
"Found "+e+" devices.");c._objects("channel",null,function(e,f){if(e)a&&a(e);else{e=0;for(var d in f)e++,c._insertTree(b,{id:d,name:d,type:f[d].type,children:[]});c._logger.log("debug","Found "+e+" channels.");c._objects("state",null,function(e,d){if(e)a&&a(e);else{e=0;for(var f in d){e++;var g=d[f];c._insertTree(b,{sys:"iobroker",id:f,name:f,type:g.type,common:g.common})}c._logger.log("debug","Found "+e+" states.");c._logger.log("debug","Final tree has length of: "+b.length);a&&a(null,b)}})}})}})}})};
d.prototype._insertTree=function(a,b){if(a&&b){var c=b.name;"system.adapter."==c.substr(0,15)&&(c=c.substr(15),b.name=c);for(var e=0;e<a.length;e++){var d=a[e];if(d.name&&c.substr(0,d.name.length+1)==d.name+"."){b.name=c.substr(d.name.length+1);this._insertTree(d.children,b);return}}a.push(b)}};d.prototype.getAllAdapters=function(a){this._objects("adapter",null,function(a,c){console.log(a,c)})};d.prototype._objects=function(a,b,c){var e=null;if(a||b)e={};a&&(e.type=a);b&&(e.pattern=b);this._doRequest("GET",
"/objects",e,null,function(a,b){c&&c(a,b)})};d.prototype._getBulk=function(a,b){this._doRequest("GET","/getBulk/"+encodeURIComponent(a.join(",")),null,null,function(a,e){b&&b(a,e)})};d.prototype._get=function(a,b){var c=null;c=isArray(a)?encodeURIComponent(a.join(",")):encodeURIComponent(a);this._doRequest("GET","/get/"+c,null,null,function(a,c){b&&b(a,c)})};d.prototype._set=function(a,b,c){this._doRequest("GET","/set/"+encodeURIComponent(a),b,null,function(a,b){c&&c(a,b)})};d.prototype._toggle=function(a,
b){this._doRequest("GET","/toggle/"+encodeURIComponent(a),null,null,function(a,e){b&&b(a,e)})};d.prototype._states=function(a,b){var c=null;a&&(c={pattern:a});this._doRequest("GET","/states",c,null,function(a,c){b&&b(a,c)})};d.prototype._doRequest=function(a,b,c,e,d){var f=b;f||(f="/");var h={};c&&(h=JSON.parse(JSON.stringify(c)));this._logger.log("trace","do request: "+a+" "+b+"? "+h);this.username&&(h.user=this.username,h.pass=this.password);b="";for(var l in h)h.hasOwnProperty(l)&&(b&&(b+="&"),
b+=l+"="+encodeURIComponent(h[l]));b&&(f+="?"+b);a={host:this.ip,port:this.port,path:f,method:a,headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};e&&(a.headers["Content-Length"]=e.length);f=require("http");this.https&&(f=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"));var n=this,m=d,k=f.request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){n._logger.log("trace",
"receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);if(200==a.statusCode)try{var c=b?JSON.parse(b):{}}catch(p){var e=p}else e=Error("http reponse:"+a.statusCode);m&&(m(e,c,a.statusCode),m=null)})});if(k.on)k.on("error",function(a){n._logger.log("trace","do request error:"+a.message);m&&(m(a),m=null)});k.setTimeout&&k.setTimeout(1E4,function(){n._logger.log("trace","do request timeout");k.abort();m&&(m(Error("timeout")),m=null)});e&&(this._logger.log("trace","do request send body:"+
e),k.write(e));k.end()};d.prototype.toJSON=function(){return{sys:"iobroker",ip:this.ip,port:this.port,username:this.username,password:this.password,https:this.https}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this.ip==a.ip&&this.username==a.username&&this.password==a.password:!1};d.parseJSON=function(a){return a.ip?new d(a.ip,a.port,a.username,a.password,a.https):null};return d}();
xnm.aio.iobroker.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="ioBrokerDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"ioBroker",getGatewayType:function(){return[{sys:this.SYS,name:"ioBroker"}]},createGateway:function(a,b,c){b=d.ERROR_CODE;a?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"info is invalid"))},updateGateway:function(a,
b,c,e){a=d.ERROR_CODE;b?b.ip?e(null,b):e(new d(a.INVALID,"ip is invalid")):e(new d(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,b,c){var e=d.ERROR_CODE;if(a)if(a.id)if(a.type)if(a.common)if(a.gateway){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?c&&c(null,a):c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"common is invalid"));
else c(new d(e.INVALID,"type is invalid"));else c(new d(e.INVALID,"id is invalid"));else c(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var e=d.ERROR_CODE;if(a)if(a.id)if(a.type)if(a.common)if(a.gateway){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?c(null,a):c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"common is invalid"));else c(new d(e.INVALID,
"type is invalid"));else c(new d(e.INVALID,"id is invalid"));else c(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b,c){var e=function(a,b){if("*"==a)return!0;for(var c=!1,e=0;e<a.length;e++)if(a[e]==b){c=!0;break}return c},d=function(a,b,c){var d=[];"command"==c.catagory?a.command&&a.command.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))}):"status"==c.catagory&&a.status&&a.status.forEach(function(a){e(c.elems,a.type)&&
(a=JSON.parse(JSON.stringify(a)),d.push(a))});return d},g=function(a,b){var e=[],f=xnm.aio.iobroker.DM.getCommandStatusMap(a,c);f&&(a=d(f,a,b),e=e.concat(a));return e};if(!a.sys)return null;var h=JSON.parse(JSON.stringify(a)),l=null;if("command"==b.catagory)l=g(a,b),h.command=l;else if("status"==b.catagory)l=g(a,b),h.status=l;else return null;return l&&0!=l.length?h:null},getCommandStatusMap:function(a,b){if(!a||"state"!=a.type||!a.common)return null;b={command:[],status:[]};var c=a.common.min,e=
a.common.max,d=a.common.unit;if(a.common.write)switch(b.command.push({type:"string",name:"set generic value",ref:{value:"setGenValue",ext:"%s"}}),a.common.type){case "boolean":switch(a.common.role){case "button":b.command.push({type:"enum",name:"press",ref:{value:"press"}});break;case "button.long":b.command.push({type:"enum",name:"long press",ref:{value:"longPress"}});break;case "button.stop":b.command.push({type:"enum",name:"stop",ref:{value:"stop"}});break;case "button.start":b.command.push({type:"enum",
name:"start",ref:{value:"start"}});break;case "button.open.door":case "button.open.window":b.command.push({type:"enum",name:"open",ref:{value:"open"}});break;case "switch.lock":case "switch.lock.door":case "switch.lock.window":b.command.push({type:"enum",name:"unlock",ref:{value:"unlock"}});b.command.push({type:"enum",name:"lock",ref:{value:"lock"}});b.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;case "media.state ":b.command.push({type:"enum",name:"play",ref:{value:"play"}});
b.command.push({type:"enum",name:"stop",ref:{value:"stop"}});b.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;default:b.command.push({type:"enum",name:"on",ref:{value:"on"}}),b.command.push({type:"enum",name:"off",ref:{value:"off"}}),b.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}})}break;case "number":switch(a.common.role){case "level.temperature":var g={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"5.0-40.0"}};if("undefined"==typeof c||
null==c)c=5;if("undefined"==typeof e||null==e)e=40;g.ref.extMeta=c+"-"+e;d&&(g.ref.unit=d);b.command.push(g);break;case "level.color.red":case "level.color.green":case "level.color.blue":case "level.color.white":g={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-255"}};if("undefined"==typeof c||null==c)c=0;if("undefined"==typeof e||null==e)e=255;g.ref.extMeta=c+"-"+e;d&&(g.ref.unit=d);b.command.push(g);break;case "level.color.rgb":g={type:"float",name:"set value",ref:{value:"setValue",
ext:"%f",extMeta:"0-16777215"}};if("undefined"==typeof c||null==c)c=0;if("undefined"==typeof e||null==e)e=16777215;g.ref.extMeta=c+"-"+e;d&&(g.ref.unit=d);b.command.push(g);g={type:"rgb",name:"set RGB",ref:{value:"setRGB",ext:"%s"}};b.command.push(g);break;default:g={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-100"}};if("undefined"==typeof c||null==c)c=0;if("undefined"==typeof e||null==e)e=100;g.ref.extMeta=c+"-"+e;d&&(g.ref.unit=d);b.command.push(g)}break;case "string":b.command.push({type:"string",
name:"set value",ref:{value:"setValue",ext:"%s"}})}if(a.common.read||"undefined"==typeof a.common.read)switch(b.status.push({type:"string",name:"generic value",ref:{value:"genValue"}}),a.common.type){case "boolean":switch(a.common.role){case "state":case "sensor.light":case "sensor.motion":case "sensor.rain":case "switch":case "switch.boost":case "switch.light":case "switch.comfort":case "media.mode.shuffle":case "media.mode.repeat":case "media.mute":b.status.push({type:"enum",name:"state",ref:{value:"state",
options:["on","off"]}});break;case "sensor.window":case "sensor.door":b.status.push({type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}});break;case "sensor.lock":case "switch.lock":case "switch.lock.door":case "switch.lock.window":b.status.push({type:"enum",name:"state",ref:{value:"state",options:["unlock","lock"]}});break;case "media.state":b.status.push({type:"enum",name:"state",ref:{value:"state",options:["play","stop"]}});break;default:b.status.push({type:"enum",name:"state",
ref:{value:"state",options:["true","false"]}})}break;case "number":switch(a.common.role){case "value.window":g={type:"enum",name:"state",ref:{value:"state",options:[]}};for(var h in a.common.states)a.common.states.hasOwnProperty(h)&&(c=a.common.states[h],"undefined"!=typeof c&&null!=c&&g.ref.options.push(c));0==g.ref.options.length&&(g.ref.options=["closed","tilted","open"]);b.status.push(g);break;case "value.time":b.status.push({type:"int",name:"state",ref:{value:"state"}});break;case "media.state":g=
{type:"enum",name:"state",ref:{value:"state",options:[]}};for(h in a.common.states)a.common.states.hasOwnProperty(h)&&(c=a.common.states[h],"undefined"!=typeof c&&null!=c&&g.ref.options.push(c));0==g.ref.options.length&&(g.ref.options=["play","stop","pause"]);b.status.push(g);break;default:if(a.common.states)for(h in g={type:"enum",name:"state",ref:{value:"state",options:[]}},a.common.states)a.common.states.hasOwnProperty(h)&&(c=a.common.states[h],"undefined"!=typeof c&&null!=c&&g.ref.options.push(c));
else{g={type:"float",name:"state",ref:{value:"state"}};if("undefined"!=typeof c&&null!=c&&"undefined"==typeof e||null!=e)g.ref.extMeta=c+"-"+e;d&&(g.ref.unit=d)}b.status.push(g)}break;case "string":b.status.push({type:"string",name:"state",ref:{value:"state"}})}return b}}}();
xnm.aio.iobroker.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.iobroker.DM;d.prototype.SimpleAPI=xnm.aio.iobroker.SimpleAPI;d.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"iobroker")};d.prototype.resolveGateway=function(a){return a?this.SimpleAPI.parseJSON(a):null};d.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};d.prototype.getDeviceStatus=function(a,b){a=
(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};d.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};d.prototype.doStatus=function(a,b,c,d,f){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};d.prototype.getDeviceList=function(a,b){(a=
this.resolveGateway(a))?a.getStateObjectTree(function(a,d){b&&b(a,d)}):b&&b(Error("gateway json format invalid"))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.iobroker.Handler);
