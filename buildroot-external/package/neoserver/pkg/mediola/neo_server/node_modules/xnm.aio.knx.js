var dgram=require("dgram"),os=require("os"),EventEmitter=require("x.events.js").EventEmitter,Logger=require("x.logger.js"),xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.knx=xnm.aio.knx||{};
xnm.aio.knx.KNXGateway=function(){var m=function(a){a=a.split(".");return(parseInt(a[0])<<24)+(parseInt(a[1])<<16)+(parseInt(a[2])<<8)+parseInt(a[3])&4294967295},n=function(a){return(a>>24&255)+"."+(a>>16&255)+"."+(a>>8&255)+"."+(a&255)},q=function(){var a=function(a){this._loggger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway.RawStateBuffer");this._stateBuffer={};this._stateReqTime={};this._knx=a};a.prototype.setState=function(a,b){"undefined"!=typeof a&&null!=a&&(this._stateBuffer[a]||
(this._stateBuffer[a]={}),this._stateBuffer[a].value=b,this._stateBuffer[a].timestamp=new Date)};a.prototype.getState=function(a){return"undefined"!=typeof a&&null!=a?(a=this._stateBuffer[a])?a.value:null:null};a.prototype.setStateReqTime=function(a,b){this._stateReqTime[a]=b};a.prototype.getStateReqTime=function(a){return this._stateReqTime[a]};return a}(),k=function(a,c,b){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway ("+a+")");this.ip=a;this.localIp=c;this.uuid=b;this._stateBuffer=new q;
this._stateMachine={state:k._FSM.IDLE};this._eventEmitter=new EventEmitter;this._dataLink=null;this._dataLinkRetryCount=0;this._dataLinkTimer=null};k.STATES_REQ_EXPIRED=18E4;k.MAX_DL_RETRY_COUNT=3;k._FSM={IDLE:1,MONITORING:2,START_MONITOR:3,STOP_MONITOR:4};k._ipv4ToLong=m;k._longToIpv4=n;k._adr2long=function(a){a=a.split("/");var c=0;switch(a.length){case 3:c+=parseInt(a[0])<<11;c+=parseInt(a[1])<<8;c+=parseInt(a[2]);break;case 2:c+=parseInt(a[0])<<11;c+=parseInt(a[1]);break;case 1:c+=parseInt(a[0])}return c};
k.prototype={getStateBuffer:function(){return this._stateBuffer},on:function(a,c){this._eventEmitter.on(a,c)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},removeListener:function(a,c){this._eventEmitter.removeListener(a,c)},startMonitor:function(a){if(a)this.on("open",a);this._fsmStartMonitor()},stopMonitor:function(a){if(a)this.on("close",a);this._fsmStopMonitor()},_fsmStartMonitor:function(){switch(this._stateMachine.state){case k._FSM.IDLE:this._stateMachine.state=k._FSM.START_MONITOR;
this._startDataLink();break;case k._FSM.MONITORING:this._eventEmitter.emit("open");break;case k._FSM.STOP_MONITOR:this._logger.log("warn","can not start the monitor again while stopping it")}},_fsmStopMonitor:function(){switch(this._stateMachine.state){case k._FSM.IDLE:this._onClose();break;case k._FSM.START_MONITOR:case k._FSM.MONITORING:this._stateMachine.state=k._FSM.STOP_MONITOR,this._stopDataLink()}},_fsmDatalinkOpen:function(){switch(this._stateMachine.state){case k._FSM.START_MONITOR:this._stateMachine.state=
k._FSM.MONITORING,this._onOpen(),this._dataLinkRetryCount=0}},_fsmDatalinkClosed:function(a,c){a?this._logger.log("trace","data link stopped due to error"):this._logger.log("trace","data link stopped");switch(this._stateMachine.state){case k._FSM.START_MONITOR:this._dataLink.removeAllListeners();this._dataLink=null;++this._dataLinkRetryCount<k.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=k._FSM.START_MONITOR,this._startDataLink(c)):(this._stateMachine.state=
k._FSM.IDLE,c&&c.forEach(function(a){a&&a.callback&&a.callback(Error("monitor closed due to error"))}),this._onClose(!0));break;case k._FSM.MONITORING:this._dataLink.removeAllListeners();this._dataLink=null;++this._dataLinkRetryCount<k.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=k._FSM.START_MONITOR,this._startDataLink(c)):(this._onError(Error("can not connect monitor tunnel to knx gateway")),this._stateMachine.state=k._FSM.IDLE,c&&c.forEach(function(a){a&&
a.callback&&a.callback(Error("monitor closed due to error"))}),this._onClose(!0));break;case k._FSM.STOP_MONITOR:this._dataLink.removeAllListeners(),this._dataLink=null,this._stateMachine.state=k._FSM.IDLE,c&&c.forEach(function(a){a&&a.callback&&a.callback(Error("monitor closed due to error"))}),this._onClose(!1)}},_fsmDataLinkMessage:function(a,c){switch(this._stateMachine.state){case k._FSM.MONITORING:c.getAPCI(),this._stateBuffer.setState(a,c.getData()),this._eventEmitter.emit("message",this.uuid,
a,c)}},_fsmDatalinkError:function(a){this._onError(a)},_onOpen:function(){0==this._dataLinkRetryCount&&this._eventEmitter.emit("open")},_onError:function(a){this._eventEmitter.emit("error",a)},_onClose:function(a){this._eventEmitter.emit("close",a)},_sendCommand:function(a,c,b){this._dataLink?this._sendCommandWithDL(this._dataLink,a,c,b):b&&b(Error("knx gateway not connected"))},_getState:function(a,c){this._dataLink?this._getStateWithDL(this._dataLink,a,c):c&&c(Error("knx gateway not connected"))},
_sendCommandWithDL:function(a,c,b,e){var f=k._adr2long(c),d=new k.APDU(null,2,b),g=this;a.send(f,d,function(a){a||g._stateBuffer.setState(f,d.getData());e&&"function"===typeof e&&e(a)})},_getStateWithDL:function(a,c,b){c=k._adr2long(c);var e=new k.APDU(null,0,new Buffer([0]));a.send(c,e,b)},_startDataLink:function(a){var c=this;this._dataLink=new k._DataLink(this.ip,this.localIp);this._dataLink.on("connect",function(){c._fsmDatalinkOpen()});this._dataLink.on("close",function(a,e){c._fsmDatalinkClosed(a,
e)});this._dataLink.on("error",function(a){c._logger.log("warn","monitor tunnel error:"+a.message);c._fsmDatalinkError(a)});this._dataLink.on("message",function(a,e){c._fsmDataLinkMessage(a,e)});this._dataLink.connect(a)},_stopDataLink:function(){this._dataLink&&this._dataLink.close()}};var u=function(){var a=function(a,b){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway._DataLink ("+a+")");var c=this;this._tunnel=new t(a,null,b,null);this._tunnel.on("connect",function(){c._onTunnelConnect()});
this._tunnel.on("end",function(){c._onTunnelEnd()});this._tunnel.on("close",function(a,b){c._onTunnelClose(a,b)});this._tunnel.on("message",function(a){c._onTunnelMessage(a)});this._tunnel.on("error",function(a){c._onTunnelError(a)});this._eventEmitter=new EventEmitter};a.prototype={on:function(a,b){this._eventEmitter.on(a,b)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},removeListener:function(a,b){this._eventEmitter.removeListener(a,b)},connect:function(a){this._tunnel.connect(a)},
close:function(){this._tunnel.close()},send:function(a,b,e){this._logger.log("debug","send l_data.req "+b.toBuffer().toString("hex")+"@"+a);a=new p.L_Data_Req(a,b);this._tunnel.send(a,function(a){e&&e(a)})},_onTunnelConnect:function(){this._eventEmitter.emit("connect")},_onTunnelClose:function(a,b){this._eventEmitter.emit("close",a,b)},_onTunnelEnd:function(){this._eventEmitter.emit("end")},_onTunnelMessage:function(a){var b="unknown";a&&a instanceof p.L_Data_Con?b="l_data.con":a&&a instanceof p.L_Data_Ind&&
(b="l_data.ind");var c=a.getDstAddr();a=a.getAPDU();this._logger.log("debug","recive "+b+" "+a.toBuffer().toString("hex")+"@"+c);this._eventEmitter.emit("message",c,a)},_onTunnelError:function(a){this._eventEmitter.emit("error",a)}};return a}(),t=function(){var a=function(c,b,e,f){this._eventEmitter=new EventEmitter;this._ip=c;this._port=b;if(!this._port||0>=this._port)this._port=a.DEFAULT_REMOTE_PORT;this._logger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway._Tunnel ("+this._ip+":"+this._port+
")");this._localIp=e;this._localPort=f;0>=this._localPort&&(this._localPort=null);this._socket=null;this._requestBuffer=[];this._stateMachine={state:a._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,connection:{id:0,seqNo:0,recvSeqNo:0,hpai:{ip:null,port:0}},close_with_error:null};this._connectStateNackCount=0};a.TUNNEL_ACK_TIMEOUT=1E3;a.CONNECT_REQUEST_TIMEOUT=1E4;a.CONNECTIONSTATE_REQUEST_INTERVAL=6E4;a.CONNECTIONSTATE_REQUEST_TIMEOUT=1E4;a.MAX_CONNECTIONSTATE_NACK_COUNT=
3;a.DEFAULT_REMOTE_PORT=3671;a._STATE={IDLE:0,BINDUDP:1,CONNECT:2,TUNNELLING:3,DISCONNECT:4,CLOSEUDP:5};a.prototype={on:function(a,b){this._eventEmitter.on(a,b)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},connect:function(a){a&&(this._requestBuffer=a);this._fsmConnect()},close:function(){this._fsmClose(!1)},send:function(c,b){if(c){var e=this._requestBuffer.length;this._requestBuffer.push({cEMI:c,callback:b,retry:!1,timer:null,seqNo:-1});0==e&&this._stateMachine.state==
a._STATE.TUNNELLING&&this._sendNextReq()}else b&&b(Error("cEMI is null"))},_sendNextReq:function(){if(0!=this._requestBuffer.length){var c=this._requestBuffer[0],b=this._stateMachine.connection.seqNo;-1!=c.seqNo?b=c.seqNo:c.seqNo=b;var e=this;this._send(b,c.cEMI,function(b){b?(c.callback&&c.callback(b),e._requestBuffer.splice(0,1),e._sendNextReq()):c.timer=setTimeout(function(){c.retry?(e._logger.log("warn","TUNNELLING_ACK ("+c.seqNo+") timeout after "+a.TUNNEL_ACK_TIMEOUT+" seconds"),e._fsmClose(!0)):
(e._logger.log("warn","TUNNELLING_ACK ("+c.seqNo+") timeout after "+a.TUNNEL_ACK_TIMEOUT+" seconds, retry"),c.retry=!0,e._sendNextReq())},a.TUNNEL_ACK_TIMEOUT)})}},_send:function(c,b,e){var f=this;switch(this._stateMachine.state){case a._STATE.TUNNELLING:this._logger.log("debug","send cEMI "+b.toBuffer().toString("hex"));var d=(new r.TunnellingRequest(this._stateMachine.connection.id,c,b)).toBuffer();this._logger.log("debug","send TUNNELLING_REQUEST ("+c+") "+d.toString("hex"));this._socket.send(d,
0,d.length,this._port,this._ip,function(a){a?f._logger.log("debug","send TUNNELLING_REQUEST ("+c+") "+d.toString("hex")+" error:"+a.message):f._logger.log("debug","send TUNNELLING_REQUEST ("+c+") "+d.toString("hex")+" finish");e&&e(null)});break;default:e&&e(Error("Tunnel is not connected"))}},_fsmConnect:function(){this._logger.log("debug","connect to knx");switch(this._stateMachine.state){case a._STATE.IDLE:this._stateMachine.state=a._STATE.BINDUDP,this._startListenerSocket()}},_fsmClose:function(c){this._stateMachine.close_with_error=
c;switch(this._stateMachine.state){case a._STATE.IDLE:this._fsmClosed();break;case a._STATE.BINDUDP:this._stateMachine.state=a._STATE.CLOSEUDP;this._stopListenerSocket();break;case a._STATE.CONNECT:this._clearStateMachineGuard();this._stateMachine.state=a._STATE.CLOSEUDP;this._stopListenerSocket();break;case a._STATE.TUNNELLING:c=(new r.DisconnectRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai)).toBuffer(),this._logger.log("debug","send DISCONNECT_REQUEST "+c.toString("hex")),
this._socket.send(c,0,c.length,this._port,this._ip),this._stateMachine.state=a._STATE.DISCONNECT,this._clearStateMachineGuard(),this._setStateMachineGuard(1E3,a._STATE.CLOSEUDP)}},_fsmError:function(a){this._eventEmitter.emit("error",a);this._fsmClose(!0)},_fsmUdpListening:function(){this._logger.log("debug","udp socket established");switch(this._stateMachine.state){case a._STATE.BINDUDP:this._stateMachine.state=a._STATE.CONNECT;this._clearStateMachineGuard();var c=this._socket.address();c={ip:c.address,
port:c.port};c=(new r.ConnectionRequest(c,c)).toBuffer();this._logger.log("debug","send CONNECTION_REQUEST "+c.toString("hex"));this._socket.send(c,0,c.length,this._port,this._ip);this._setStateMachineGuard(a.CONNECT_REQUEST_TIMEOUT,a._STATE.TUNNELLING)}},_fsmUdpMessage:function(c){var b=this,e=this._socket.address(),f=r.parseFrame(c);if(f)switch(this._stateMachine.state){case a._STATE.CONNECT:518===f.getType()&&(f.isConnectionStatusOK()?(this._clearStateMachineGuard(),c=f.getConnectionID(),this._logger.log("debug",
"receive CONNECTION_RESPONSE with connection id "+c),this._stateMachine.connection={},this._stateMachine.connection.id=c,e={ip:e.address,port:e.port},this._stateMachine.connection.hpai=e,this._stateMachine.connection.seqNo=0,this._stateMachine.connection.recvSeqNo=0,this._stateMachine.state=a._STATE.TUNNELLING,this._sendConnectionStateRequest(),this._sendNextReq(),this._onConnected()):(e=f.getConnectionStatus(),c=Error("tunnel connection fail with error:"+e.toString(16)),c.code=e,this._fsmError(c)));
break;case a._STATE.TUNNELLING:switch(f.getType()){case 1056:c=f.getConnectionID();if(c===this._stateMachine.connection.id){var d=f.getcEMI(),g=f.getSeqNo(),l=!1;g==this._stateMachine.connection.recvSeqNo&&(l=!0);if(g==this._stateMachine.connection.recvSeqNo||g==this._stateMachine.connection.recvSeqNo-1)f=new r.TunnellingACK(c,g),e=f.toBuffer(),this._logger.log("trace","send TUNNELLING_ACK ("+g+") "+e.toString("hex")),this._socket.send(e,0,e.length,this._port,this._ip,function(a){try{l&&(d&&d instanceof
p.L_Data_Con?(b._logger.log("debug","receive TUNNELLING_REQUEST ("+g+") l_data.con "+d.toBuffer().toString("hex")),b._onMessage(d)):d&&d instanceof p.L_Data_Ind&&(b._logger.log("debug","receive TUNNELLING_REQUEST ("+g+") l_data.ind "+d.toBuffer().toString("hex")),b._onMessage(d)))}catch(h){}});g!=this._stateMachine.connection.recvSeqNo&&g!=this._stateMachine.connection.recvSeqNo-1||g!=this._stateMachine.connection.recvSeqNo||(this._stateMachine.connection.recvSeqNo++,255<this._stateMachine.connection.recvSeqNo&&
(this._stateMachine.connection.recvSeqNo=0))}break;case 1057:c=f.getConnectionID();c===this._stateMachine.connection.id&&this._onTunnelAck(f);break;case 521:c=f.getConnectionID();e=f.getCtrlEndpointHPAI();c===this._stateMachine.connection.id&&(this._logger.log("debug","receive DISCONNECT_REQUEST"),f=new r.DisconnectResponse(c),e=f.toBuffer(),this._logger.log("debug","send DISCONNECT_RESPONSE "+e.toString("hex")),this._socket.send(e,0,e.length,this._port,this._ip,function(){b._fsmEnd()}));break;case 520:c=
f.getConnectionID(),this._logger.log("debug","receive CONNECTIONSTATE_RESPONSE with connection id "+c),this._connectStateNackCount=0,this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null,this._stateMachine.connectionStateTimer||(this._stateMachine.connectionStateTimer=setTimeout(function(){b._stateMachine.connectionStateTimer=null;b._sendConnectionStateRequest()},a.CONNECTIONSTATE_REQUEST_INTERVAL)))}break;
case a._STATE.DISCONNECT:522===f.getType()&&(c=f.getConnectionID(),c===this._stateMachine.connection.id&&(e=f.isDisconnectOK(),this._logger.log("debug","receive DISCONNECT_RESPONSE with status "+(e?"OK":"NOK")),this._clearStateMachineGuard(),this._stateMachine.state=a._STATE.CLOSEUDP,b._stopListenerSocket()))}},_fsmEnd:function(){this._stateMachine.state=a._STATE.CLOSEUDP;this._eventEmitter.emit("end");this._stateMachine.close_with_error=!1;this._stopListenerSocket()},_fsmClosed:function(){this._stateMachine.state=
a._STATE.IDLE;var c=this._stateMachine.close_with_error;this._socket&&this._socket.removeAllListeners();var b=this._socket=null;if(c){b=this._requestBuffer;for(var e=0;e<b.length;e++){var f=b[e];f&&(f.timer&&clearTimeout(f.timer),f.seqNo=-1)}this._requestBuffer=[]}else this._clearRequestBuffer();this._resetStateMachine();this._eventEmitter.emit("close",c,b)},_onConnected:function(){this._eventEmitter.emit("connect")},_onMessage:function(a){this._eventEmitter.emit("message",a)},_onTunnelAck:function(a){var b=
a.getSeqNo();a=a.isOK();this._logger.log("debug","receive TUNNELLING_ACK ("+b+") with status "+(a?"OK":"NOK"));b==this._stateMachine.connection.seqNo&&(b=this._requestBuffer[0],b.timer&&clearTimeout(b.timer),b.callback&&b.callback(a?null:Error("NACK")),this._stateMachine.connection.seqNo+=1,255<this._stateMachine.connection.seqNo&&(this._stateMachine.connection.seqNo=0),this._requestBuffer.splice(0,1),this._sendNextReq())},_clearRequestBuffer:function(){for(var a=0;a<this._requestBuffer.length;a++){var b=
this._requestBuffer[a];b&&(b.timer&&clearTimeout(b.timer),b.callback&&b.callback(Error("NACK due to tunnel closed")))}this._requestBuffer=[]},_setStateMachineGuard:function(c,b){var e=this;this._stateMachine.stateTimer=setTimeout(function(){var c=e._stateMachine.state;c===a._STATE.DISCONNECT&&b===a._STATE.CLOSEUDP?(e._stateMachine.state=a._STATE.CLOSEUDP,e._stopListenerSocket()):c!==b&&(c=3==b?"receive CONNECTION_RESPONSE timeout":"knx tunnel receive data timeout in "+c,e._logger.log("warn",c),e._fsmError(Error(c)))},
c)},_clearStateMachineGuard:function(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer)},_sendConnectionStateRequest:function(){var c=this,b=(new r.ConnectionStateRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai)).toBuffer();this._logger.log("debug","send CONNECTIONSTATE_REQUEST "+b.toString("hex")+" with connection id "+this._stateMachine.connection.id);this._socket.send(b,0,b.length,this._port,this._ip);this._stateMachine.connectionStateAckTimer&&
(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null);this._stateMachine.connectionStateAckTimer=setTimeout(function(){c._connectStateNackCount++;c._connectStateNackCount<a.MAX_CONNECTIONSTATE_NACK_COUNT&&c._stateMachine.state===a._STATE.TUNNELLING?(c._logger.log("warn","receive CONNECTIONSTATE_RESPONSE timeout"),c._sendConnectionStateRequest()):(c._logger.log("warn","tunnel break due to CONNECTIONSTATE_RESPONSE timeout"),c._fsmError(Error("tunnel break")))},
a.CONNECTIONSTATE_REQUEST_TIMEOUT)},_resetStateMachine:function(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer);this._stateMachine.connectionStateTimer&&clearTimeout(this._stateMachine.connectionStateTimer);this._stateMachine.connectionStateAckTimer&&clearTimeout(this._stateMachine.connectionStateAckTimer);this._stateMachine={state:a._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,socket:null,connection:{id:0,seqNo:0,hpai:{ip:null,port:0}},
close_with_error:null}},_startListenerSocket:function(){this._logger.log("trace","{UDP Socket} start knx upd listener on "+this._localIp);var a=this;this._socket=dgram.createSocket("udp4");this._socket.on("listening",function(){try{a._socket.addMembership("224.0.23.12");var b=a._socket.address();a._logger.log("trace","{UDP Socket} knx listening "+b.address+":"+b.port);a._fsmUdpListening()}catch(e){a._logger.log("trace","{UDP Socket} knx listening bind multicast failed:"+e.message),a._socket.close(),
a._fsmClosed()}});this._socket.on("close",function(){a._logger.log("trace","{UDP Socket} control socket closed");a._fsmClosed()});this._socket.on("error",function(b){a._logger.log("trace","{UDP Socket} control socket error: "+b.stack);a._fsmError(b)});this._socket.on("message",function(b,c){var e=a._socket.address();a._logger.log("trace","{UDP Socket} receive data "+b.toString("hex")+" from "+c.address+":"+c.port+" @local "+e.address+":"+e.port);a._fsmUdpMessage(b)});this._socket.bind(null,this._localIp)},
_stopListenerSocket:function(){this._logger.log("trace","{UDP Socket} stop knx upd listener");this._socket.close()}};return a}(),r=function(){var a=function(a,b){a&&b&&(this._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame"),this._buffer=new Buffer(6+b.length),this._buffer.writeUInt16BE(1552,0),this._buffer.writeUInt16BE(a,2),this._buffer.writeUInt16BE(6+b.length,4),b.copy(this._buffer,6))};a._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame");a.parseFrame=function(c){var d=null;if(6>c.length)return a._logger.log("debug",
"data is too short"),null;var e=c.readUInt16BE(0);if(1552!==e)return a._logger.log("debug","data header&version is invalid:"+e),null;e=c.readUInt16BE(4);if(e>c.length)return a._logger.log("debug","data length in header is larger than actual size:"+e),null;var m=c.readUInt16BE(2);switch(m){case 514:14<=e&&(d=new b);break;case 518:8<=e&&(d=new f);break;case 520:8<=e&&(d=new g);break;case 1057:10<=e&&(d=new k);break;case 1056:6<=e&&(d=new l);break;case 521:16<=e&&(d=new h);break;case 522:8<=e&&(d=new w);
break;default:a._logger.log("debug","data type is unknow:"+m)}d&&(d._buffer=c);return d};a.prototype.getType=function(){return this._buffer.readUInt16BE(2)};a.prototype.getSize=function(){return this._buffer.readUInt16BE(4)};a.prototype.toBuffer=function(){return this._buffer};var c=function(b){var c=new Buffer(8);c.writeUInt16BE(2049,0);c.writeInt32BE(m(b.ip),2);c.writeUInt16BE(b.port,6);a.call(this,513,c)};c.prototype=new a;c.prototype.constructor=c;var b=function(){a.call(this)};b.prototype=new a;
b.prototype.constructor=b;b.prototype.getCtrlEndpointHPAI=function(){var a=this._buffer.readUInt32BE(8);a=n(a);var b=this._buffer.readUInt16BE(12),c={};c.ip=a;c.port=b;return c};b.prototype.getSerialNumber=function(){var a=(this._buffer.readUInt8(22)<<16)+(this._buffer.readUInt8(23)<<8)+this._buffer.readUInt8(24),b=(this._buffer.readUInt8(25)<<16)+(this._buffer.readUInt8(26)<<8)+this._buffer.readUInt8(27);return a+""+b};b.prototype.getRoutingMulticastAddress=function(){return this._buffer.readUInt8(28)+
"."+this._buffer.readUInt8(29)+"."+this._buffer.readUInt8(30)+"."+this._buffer.readUInt8(31)};b.prototype.getMAC=function(){return this._buffer.toString("hex",32,38)};b.prototype.getName=function(){return this._buffer.toString("utf8",38,68)};b.prototype.toJSON=function(){return{hapi:this.getCtrlEndpointHPAI(),structure_length:this._buffer.readUInt8(14),desciprtion_type_code:this._buffer.readUInt8(15),knx_medium:this._buffer.readUInt8(16),device_status:this._buffer.readUInt8(17),physical_address:this._buffer.readUInt16BE(18),
project_installation_id:this._buffer.readUInt16BE(20),serial_number:this.getSerialNumber(),routing_multicast_address:this.getRoutingMulticastAddress(),mac:this.getMAC(),name:this.getName()}};var e=function(b,c){var d=new Buffer(20);d.writeUInt16BE(2049,0);d.writeInt32BE(m(b.ip),2);d.writeUInt16BE(b.port,6);d.writeUInt16BE(2049,8);d.writeInt32BE(m(c.ip),10);d.writeUInt16BE(c.port,14);d.writeUInt8(4,16);d.writeUInt8(4,17);d.writeUInt8(2,18);d.writeUInt8(0,19);a.call(this,517,d)};e.prototype=new a;e.prototype.constructor=
e;var f=function(){a.call(this)};f.prototype=new a;f.prototype.constructor=f;f.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};f.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7)};f.prototype.getCtrlEndpointHPAI=function(){var a=this._buffer.readUInt32BE(10);a=n(a);var b=this._buffer.readUInt16BE(14),c={};c.ip=a;c.port=b;return c};f.prototype.getCRD=function(){return this._buffer.readUInt32BE(16)};f.prototype.getConnectionStatus=function(){return this._buffer.readUInt8(7)};
var d=function(b,c){var d=new Buffer(10);d.writeUInt8(b,0);d.writeUInt8(0,1);d.writeUInt16BE(2049,2);d.writeInt32BE(m(c.ip),4);d.writeUInt16BE(c.port,8);a.call(this,519,d)};d.prototype=new a;d.prototype.constructor=d;var g=function(){a.call(this)};g.prototype=new a;g.prototype.constructor=g;g.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};g.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7)};var l=function(b,c,d){if(null!==b&&void 0!==b&&null!==
c&&void 0!==c&&d){var e=new Buffer(4+d.getLength());e.writeUInt8(4,0);e.writeUInt8(b,1);e.writeUInt8(c,2);e.writeUInt8(0,3);d.toBuffer().copy(e,4);a.call(this,1056,e)}else a.call(this)};l.prototype=new a;l.prototype.constructor=l;l.prototype.getConnectionID=function(){return this._buffer.readUInt8(7)};l.prototype.getSeqNo=function(){return this._buffer.readUInt8(8)};l.prototype.getcEMI=function(){var a=this._buffer.readUInt16BE(4);a=new Buffer(a-6-4);this._buffer.copy(a,0,10);return p.parseFrame(a)};
var k=function(b,c){if(b){var d=new Buffer(4);d.writeUInt8(4,0);d.writeUInt8(b,1);d.writeUInt8(c,2);d.writeUInt8(0,3);a.call(this,1057,d)}else a.call(this)};k.prototype=new a;k.prototype.constructor=k;k.prototype.getConnectionID=function(){return this._buffer.readUInt8(7)};k.prototype.getSeqNo=function(){return this._buffer.readUInt8(8)};k.prototype.isOK=function(){return 0===this._buffer.readUInt8(9)};var h=function(b,c){if(b&&null!==c){var d=new Buffer(10);d.writeUInt8(b,0);d.writeUInt8(0,1);d.writeUInt8(8,
2);d.writeUInt8(1,3);d.writeInt32BE(m(c.ip),4);d.writeUInt16BE(c.port,8);a.call(this,521,d)}else a.call(this)};h.prototype=new a;h.prototype.constructor=h;h.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};h.prototype.getCtrlEndpointHPAI=function(){var a=this._buffer.readUInt32BE(10);a=n(a);var b=this._buffer.readUInt16BE(14),c={};c.ip=a;c.port=b;return c};var w=function(b){if(b){var c=new Buffer(2);c.writeUInt8(b,0);c.writeUInt8(0,1);a.call(this,1057,c)}else a.call(this)};w.prototype=
new a;w.prototype.constructor=w;w.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};w.prototype.isDisconnectOK=function(){return 0===this._buffer.readUInt8(7)};a.SearchRequest=c;a.SearchResponse=b;a.ConnectionRequest=e;a.ConnectionResponse=f;a.ConnectionStateRequest=d;a.ConnectionStateResponse=g;a.TunnellingRequest=l;a.TunnellingACK=k;a.DisconnectRequest=h;a.DisconnectResponse=w;return a}(),p=function(){var a=function(a){this._buffer=a};a.parseFrame=function(a){var c=null;switch(a.readUInt8(0)){case b.MSG_CODE:c=
new b;break;case e.MSG_CODE:c=new e}c&&(c._buffer=a);return c};a.prototype={getLength:function(){return this._buffer.length},getSrcAddr:function(){return this._buffer.readUInt16BE(4)},getDstAddr:function(){return this._buffer.readUInt16BE(6)},getDataLength:function(){return this._buffer.readUInt8(8)},getAPDU:function(){var a=this.getDataLength()+1;a=new Buffer(a);this._buffer.copy(a,0,9,9+a.length);return v.parse(a)},toBuffer:function(){return this._buffer}};var c=function(a,b){var c=new Buffer(9+
b.getLength());c.writeUInt8(17,0);c.writeUInt8(0,1);c.writeUInt8(188,2);c.writeUInt8(224,3);c.writeUInt8(0,4);c.writeUInt8(0,5);c.writeUInt8(a>>8&255,6);c.writeUInt8(a&255,7);c.writeUInt8(b.getLength()-1,8);b.toBuffer().copy(c,9);this._buffer=c};c.MSG_CODE=17;c.prototype=new a;c.prototype.constructor=c;var b=function(){this._buffer=void 0};b.MSG_CODE=46;b.prototype=new a;b.prototype.constructor=b;var e=function(){this._buffer=void 0};e.MSG_CODE=41;e.prototype=new a;e.prototype.constructor=e;a.L_Data_Req=
c;a.L_Data_Con=b;a.L_Data_Ind=e;return a}(),v=function(){var a=function(a,b,e){b||(b=0);a||(a=0);var c=1;e&&1<e.length&&(c=e.length);this._buffer=new Buffer(1+c);this._buffer.writeUInt8(a|b>>2,0);a=e&&0<e.length?e.readUInt8(0):0;this._buffer.writeUInt8(b<<6|a,1);e&&1<e.length&&e.copy(this._buffer,2,1)};a.parse=function(c){var b=new a;b._buffer=c;return b};a.prototype={getLength:function(){return this._buffer.length},getAPCI:function(){var a=this._buffer.readUInt8(0),b=this._buffer.readUInt8(1);return(a&
3)<<2|(b&192)>>6&3},getData:function(){var a=this._buffer.length-1,b=this._buffer.readUInt8(1),e=new Buffer(a);e.writeUInt8(b&63,0);1<a&&this._buffer.copy(e,1,2);return e},toBuffer:function(){return this._buffer}};return a}();k._DataLink=u;k._Tunnel=t;k.IPFrame=r;k.cEMI=p;k.APDU=v;return k}();
xnm.aio.knx.KNXGateway._DPT=function(){var m=function(a){this.type=a};m.resolve=function(a){if(!a||3>=a.length)return null;var c=a.indexOf("-");if(0>=c)return null;var b=a.substring(0,c);if("DPT"==b){if(5>a.length)return null;b=a}else if("DPST"==b){c=a.indexOf("-",c+1);if(0>c)return null;b=a.substring(0,c)}else return null;switch(b){case "DPT-1":case "DPST-1":return new n(a);case "DPT-2":case "DPST-2":return new q(a);case "DPT-3":case "DPST-3":return new k(a);case "DPT-5":case "DPST-5":return new u(a);
case "DPT-6":case "DPST-6":return new t(a);case "DPT-9":case "DPST-9":return new r(a);case "DPT-14":case "DPST-14":return new p(a);case "DPT-20":case "DPST-20":return new v(a)}return null};m.prototype.doCommand=function(a,c,b,e){e&&e()};m.prototype.setValue=function(a,c,b,e){a&&a instanceof Buffer?c._sendCommand(b,a,function(a){e&&e(a)}.bind(this)):e&&e(Error("invalid value"))};m.prototype.getValue=function(a,c,b){a._getState(c,function(a,c){a?b&&b(a):b&&b(null,this._resolveData(c))}.bind(this))};
m.prototype._resolveDataRaw=function(a){return a.toString("hex")};m.prototype._resolveData=function(a){return a.toString("hex")};var n=function(a){this.type=a};n.prototype=new m;n.prototype.constructor=n;n.prototype.doCommand=function(a,c,b,e){if(a){if(0==a.indexOf("setValue")){if(a=parseInt(a.substr(8)),!a||isNaN(a))a=0}else switch(a){case "on":case "true":case "enable":case "ramp":case "alarm":case "high":case "increase":case "down":case "close":case "start":case "active":case "inverted":a=1;break;
case "off":case "false":case "disable":case "no_ramp":case "no_alarm":case "low":case "decrease":case "up":case "open":case "stop":case "inactive":case "not_inverted":a=0;break;default:e&&e(Error("unknown command:"+a));return}this.setValue(a,c,b,e)}else e&&e(Error("unknown command:"+a))};n.prototype.setValue=function(a,c,b,e){var f=null;f=0==a||1==a?new Buffer([a]):a;m.prototype.setValue.call(this,f,c,b,function(a){e&&e(a)}.bind(this))};n.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};
n.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};n.prototype._resolveValue=function(a){switch(this.type){case "DPT-1":case "DPST-1-1":return a?"on":"off";case "DPST-1-2":return a?"true":"false";case "DPST-1-3":return a?"enable":"disable";case "DPST-1-4":return a?"ramp":"no_ramp";case "DPST-1-5":return a?"alarm":"no alarm";case "DPST-1-6":return a?"high":"low";case "DPST-1-7":return a?"increase":"decrease";case "DPST-1-8":return a?"down":"up";case "DPST-1-9":return a?
"close":"open";case "DPST-1-10":return a?"start":"stop";case "DPST-1-11":return a?"active":"inactive";case "DPST-1-12":return a?"inverted":"not_inverted";case "DPST-1-13":return a?"cyclically":"start/stop";case "DPST-1-14":return a?"calculated":"fixed";case "DPST-1-15":return a?"reset command":"no action";case "DPST-1-16":return a?"acknowledge command":"no action";case "DPST-1-18":return a?"occupied":"not occupied";case "DPST-1-19":return a?"open":"closed";case "DPST-1-21":return a?"logical function AND":
"logical function OR";case "DPST-1-22":return a?"scene B":"scene A";case "DPST-1-23":return a?"move Up/Down +StepStop mode (blind)":"only move Up/Down mode (shutter)";default:return null}};var q=function(a){this.type=a};q.prototype=new m;q.prototype.constructor=q;q.prototype.doCommand=function(a,c,b,e){if(a)if(0==a.indexOf("setValue")){a.substr(0,8);var f=parseInt(a.substr(8));if(!f||isNaN(f))f=0;this.setValue(f,c,b,e)}else{var d=a.split(".");if(2>d.length)e&&e(Error("unknown command:"+a));else{f=
"prio"==d[0]?1:0;switch(d[1]){case "on":case "true":case "enable":case "ramp":case "alarm":case "high":case "increase":case "down":case "close":case "start":case "active":case "inverted":f=f<<1|1;break;case "off":case "false":case "disable":case "no_ramp":case "no_alarm":case "low":case "decrease":case "up":case "open":case "stop":case "inactive":case "not_inverted":f=f<<1|0;break;default:e&&e(Error("unknown command:"+a));return}this.setValue(f,c,b,e)}}else e&&e(Error("unknown command:"+a))};q.prototype.setValue=
function(a,c,b,e){var f=null;f=0==a||1==a||2==a||3==a?new Buffer([a]):a;m.prototype.setValue.call(this,f,c,b,function(a){e&&e(a)}.bind(this))};q.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};q.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};q.prototype._resolveValue=function(a){var c=1==a>>1?"prio.":"no_prio.";switch(this.type){case "DPT-2":c=a;break;case "DPST-2-1":c+=a&1?"on":"off";break;case "DPST-2-2":c+=a&1?"true":"false";break;case "DPST-2-3":c+=
a&1?"enable":"disable";break;case "DPST-2-4":c+=a&1?"ramp":"no_ramp";break;case "DPST-2-5":c+=a&1?"alarm":"no alarm";break;case "DPST-2-6":c+=a&1?"high":"low";break;case "DPST-2-7":c+=a&1?"increase":"decrease";break;case "DPST-2-8":c+=a&1?"down":"up";break;case "DPST-2-9":c+=a&1?"close":"open";break;case "DPST-2-10":c+=a&1?"start":"stop";break;case "DPST-2-11":c+=a&1?"active":"inactive";break;case "DPST-2-12":c+=a&1?"inverted":"not_inverted";break;default:return null}return c};var k=function(a){this.type=
a};k.prototype=new m;k.prototype.constructor=k;k.prototype.doCommand=function(a,c,b,e){if(a){var f=null,d=0;if(0==a.indexOf("setValue")){a.substr(0,8);d=parseInt(a.substr(8));if(!d||isNaN(d))d=0;this.setValue(d,c,b,e)}else{if("stepUpStop"==a||"stepDownStop"==a)f=a,d=0;else if(0==a.indexOf("stepUp")){if(f=a.substr(0,6),d=parseInt(a.substr(6)),!d||isNaN(d))d=1}else 0==a.indexOf("stepDown")&&(f=a.substr(0,8),d=parseInt(a.substr(8)),!d||isNaN(d))&&(d=1);a=this._getStepcode(d);if(-1==a)e&&e(Error("invalid step precent:"+
d));else{switch(f){case "stepUp":f=1;if(0>=a){e&&e(Error("stepUp command value invalid"));return}break;case "stepDown":f=0;if(0>=a){e&&e(Error("stepDown command value invalid"));return}break;case "stepUpStop":f=1;break;case "stepDownStop":f=0;break;default:e&&e(Error("unknown command:"+f));return}this.setValue(f<<3|a,c,b,e)}}}else e&&e(Error("unknown command:"+a))};k.prototype.setValue=function(a,c,b,e){0>a&&(a=0);15<a&&(a=15);a=new Buffer([a]);m.prototype.setValue.call(this,a,c,b,function(a){e&&
e(a)}.bind(this))};k.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};k.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};k.prototype._resolveValue=function(a){var c=a&7,b=0;0==c?b=0:1==c?b=100:2==c?b=50:3==c?b=25:4==c?b=12:5==c?b=6:6==c?b=3:7==c&&(b=1);return{direction:a&8?"up":"down",precent:b,stepcode:c}};k.prototype._getStepcode=function(a){switch(a){case 0:return 0;case 1:return 7;case 3:return 6;case 6:return 5;case 12:return 4;case 25:return 3;case 50:return 2;
case 100:return 1;default:return-1}};var u=function(a){this.type=a};u.prototype=new m;u.prototype.constructor=u;u.prototype.doCommand=function(a,c,b,e){if(a){var f=a,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseInt(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "setValue":break;case "up":case "down":a=null;a="up"==f?this._getBuffer(255):this._getBuffer(0);if(!a){e&&e(Error("invalid value"));return}m.prototype.setValue.call(this,a,c,b,function(a){e&&e(a)}.bind(this));return;default:e&&e(Error("unknown command:"+
f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};u.prototype.setValue=function(a,c,b,e){switch(this.type){case "DPST-5-1":0>a&&(a=0);100<a&&(a=100);a=Math.round(a/100*255);break;case "DPST-5-3":0>a&&(a=0);360<a&&(a=360);a=Math.round(a/360*255);break;case "DPST-5-6":0>a&&(a=0);254<a&&(a=254);a=Math.round(a/360*255);break;default:0>a&&(a=0),255<a&&(a=255)}(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(a){e&&e(a)}.bind(this)):e&&e(Error("invalid value"))};
u.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c+a,b,e,f)};u.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c-a,b,e,f)};u.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};u.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};u.prototype._resolveValue=function(a){switch(this.type){case "DPST-5-1":return Math.round(a/255*100);case "DPST-5-3":return Math.round(a/
255*360);default:return a}};u.prototype._getBuffer=function(a){var c=new Buffer(2);c.writeUInt8(0,0);c.writeUInt8(a,1);return c};var t=function(a){this.type=a};t.prototype=new m;t.prototype.constructor=t;t.prototype.doCommand=function(a,c,b,e){if(a){var f=a,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseInt(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "setValue":break;default:e&&e(Error("unknown command:"+f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};t.prototype.setValue=
function(a,c,b,e){-128>a&&(a=-128);127<a&&(a=127);0>a&&(a+=256);(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(a){e&&e(a)}.bind(this)):e&&e(Error("invalid value"))};t.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c+a,b,e,f)};t.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c-a,b,e,f)};t.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};t.prototype._resolveData=function(a){if(!a||2>a.length)return null;
a=a.readUInt8(1);return this._resolveValue(a)};t.prototype._resolveValue=function(a){127<a&&(a-=256);return a};t.prototype._getBuffer=function(a){var c=new Buffer(2);c.writeUInt8(0,0);c.writeUInt8(a,1);return c};var r=function(a){this.type=a};r.prototype=new m;r.prototype.constructor=r;r.prototype.doCommand=function(a,c,b,e){if(a){var f=null,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseFloat(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "setValue":break;default:e&&e(Error("unknown command:"+
f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};r.prototype.setValue=function(a,c,b,e){switch(this.type){case "DPT-9":-671088.64>a&&(a=-671088.64);670760.96<a&&(a=670760.96);a=this._float2short(a);break;case "DPST-9-1":-273>a&&(a=-273);670760<a&&(a=670760);a=this._float2short(a);break;case "DPST-9-4":0>a?a=0:670433.28<a&&(a=670433.28);a=this._float2short(a);break;default:a=this._float2short(a)}(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(a){e&&e(a)}.bind(this)):
e&&e(Error("invalid value"))};r.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c+a,b,e,f)};r.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c-a,b,e,f)};r.prototype._resolveDataRaw=function(a){return!a||3>a.length?0:a.readUInt16BE(1)};r.prototype._resolveData=function(a){if(!a||3>a.length)return 0;a=a.readUInt16BE(1);return this._resolveValue(a)};r.prototype._resolveValue=function(a){switch(this.type){case "DPT-9":case "DPST-9-1":case "DPST-9-4":return parseFloat(this._short2float(a).toFixed(2));
default:return parseFloat(this._short2float(a).toFixed(2))}};r.prototype._getBuffer=function(a){var c=new Buffer(3);c.writeUInt8(0,0);c.writeUInt16BE(a,1);return c};r.prototype._float2short=function(a){for(var c=100*a,b=0;-2048>c;c/=2)b++;for(;2047<c;c/=2)b++;c=Math.round(c)&2047;b=b<<3|c>>8;0>a&&(b|=128);return b<<8|c};r.prototype._short2float=function(a){var c=a>>15&1,b=a&2047|c<<11;1==c&&(b-=4096);return.01*b*Math.pow(2,a>>11&15)};var p=function(a){this.type=a};p.prototype=new m;p.prototype.constructor=
p;p.prototype.doCommand=function(a,c,b,e){if(a){var f=null,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseFloat(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "setValue":break;default:e&&e(Error("unknown command:"+f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};p.prototype.setValue=function(a,c,b,e){-3.40282347E38>a&&(a=-3.40282347E38);3.40282347E38<a&&(a=3.40282347E38);a=this._float2bytes(a);(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(a){e&&
e(a)}.bind(this)):e&&e(Error("invalid value"))};p.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c+a,b,e,f)};p.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);this.setValue(c-a,b,e,f)};p.prototype._resolveDataRaw=function(a){return!a||5>a.length?0:a.readUInt32BE(1)};p.prototype._resolveData=function(a){if(!a||5>a.length)return 0;a=a.readUInt32BE(1);return this._resolveValue(a)};p.prototype._resolveValue=function(a){return parseFloat(this._long2float(a).toFixed(2))};
p.prototype._getBuffer=function(a){if(!a||4>a.length)return null;var c=new Buffer(5);c.writeUInt8(0,0);for(var b=0;4>b;b++)c.writeUInt8(a[b],b+1);return c};p.prototype._float2bytes=function(a){return this._toIEEE754Single(a)};p.prototype._long2float=function(a){var c=new Buffer(4);c.writeUInt32BE(a);a=Array.prototype.slice.call(c);return this._fromIEEE754Single(a)};p.prototype._toIEEE754=function(a,c,b){var e=(1<<c-1)-1;if(isNaN(a)){var f=(1<<e)-1;e=1;var d=0}else if(Infinity===a||-Infinity===a)f=
(1<<e)-1,e=0,d=0>a?1:0;else if(0===a)e=f=0,d=-Infinity===1/a?1:0;else if(d=0>a,a=Math.abs(a),a>=Math.pow(2,1-e)){var g=Math.min(Math.floor(Math.log(a)/Math.LN2),e);f=g+e;e=a*Math.pow(2,b-g)-Math.pow(2,b)}else f=0,e=a/Math.pow(2,1-e-b);for(a=[];b;--b)a.push(e%2?1:0),e=Math.floor(e/2);for(b=c;b;--b)a.push(f%2?1:0),f=Math.floor(f/2);a.push(d?1:0);a.reverse();c=a.join("");for(d=[];c.length;)d.push(parseInt(c.substring(0,8),2)),c=c.substring(8);return d};p.prototype._fromIEEE754=function(a,c,b){for(var e=
[],f=a.length;f;--f)for(var d=a[f-1],g=8;g;--g)e.push(d%2?1:0),d>>=1;e.reverse();d=e.join("");a=(1<<c-1)-1;e=parseInt(d.substring(0,1),2)?-1:1;f=parseInt(d.substring(1,1+c),2);d=parseInt(d.substring(1+c),2);return f===(1<<c)-1?0!==d?NaN:Infinity*e:0<f?e*Math.pow(2,f-a)*(1+d/Math.pow(2,b)):0!==d?d/Math.pow(2,b)*Math.pow(2,-(a-1))*e:0*e};p.prototype._fromIEEE754Single=function(a){return this._fromIEEE754(a,8,23)};p.prototype._toIEEE754Single=function(a){return this._toIEEE754(a,8,23)};var v=function(a){this.type=
a};v.prototype=new m;v.prototype.constructor=v;v.prototype.doCommand=function(a,c,b,e){if(a){var f=a,d=0;0==a.indexOf("setValue")&&(f=a.substr(0,8),d=parseInt(a.substr(8)),!d||isNaN(d))&&(d=0);switch(f){case "auto":d=0;break;case "comfort":d=1;break;case "standby":d=2;break;case "economy":d=3;break;case "protection":d=4;break;case "setValue":break;default:e&&e(Error("unknown command:"+f));return}this.setValue(d,c,b,e)}else e&&e(Error("unknown command:"+a))};v.prototype.setValue=function(a,c,b,e){(a=
this._getBuffer(a))?m.prototype.setValue.call(this,a,c,b,function(a){e&&e(a)}.bind(this)):e&&e(Error("invalid value"))};v.prototype.incValue=function(a,c,b,e,f){c=this._resolveValue(c);c=c.value+a;this.setValue(c,b,e,f)};v.prototype.decValue=function(a,c,b,e,f){c=this._resolveValue(c);c=c.value-a;this.setValue(c,b,e,f)};v.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};v.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};
v.prototype._resolveValue=function(a){switch(this.type){case "DPT-20":break;case "DPST-20-1":switch(a){case 0:a="autonomous";break;case 1:a="slave";break;case 2:a="master";break;default:a="unknow"}break;case "DPST-20-102":switch(a){case 0:a="auto";break;case 1:a="comfort";break;case 2:a="standby";break;case 3:a="economy";break;case 4:a="protection";break;default:a="unknow"}break;default:return null}return a};v.prototype._getBuffer=function(a){var c=new Buffer(2);c.writeUInt8(0,0);c.writeUInt8(a,1);
return c};m.DPT1=n;m.DPT2=q;m.DPT3=k;m.DPT5=u;m.DPT6=t;m.DPT9=r;m.DPT14=p;m.DPT20=v;return m}();
xnm.aio.knx.KNXGateway._Device=function(){var m=function(a){this._device=a};m.resolve=function(a){if(!a)return null;var c=null;switch(a.data){case "outlet":c=new q(a);break;case "lighting":c=new k(a);break;case "blind":c=new u(a);break;case "shutter":c=new t(a);break;case "heater":c=new r(a);break;case "1bit":c=new p(a);break;case "1byte":c=new v(a);break;case "general":c=new n(a)}return c};m.prototype={getDefaultChannel:function(){return null},executeCommand:function(a,c,b){this._parseCommand(a,
function(a,f,d,g){a?b&&b(a):(a=g.ga,(f=xnm.aio.knx.KNXGateway._DPT.resolve(g.type))?f.doCommand(d,c,a,function(a){b&&b(a)}.bind(this)):b&&b(Error("unknown actuator type:"+g.type)))})},_parseCommand:function(a,c){if(this._device)if(a){var b=a.indexOf("@");if(-1==b)c&&c(Error("command format invalid"));else{var e=a.substr(0,b);a=a.substr(b+1);e||(e=this.getDefaultChannel());this._device.channels&&this._device.channels[e]?(b=this._device.channels[e],b.actuator&&b.actuator.ga&&b.actuator.type?xnm.aio.knx.KNXGateway._DPT.resolve(b.actuator.type)?
c&&c(null,e,a,b.actuator):c&&c(Error("unknown actuator type:"+b.actuator.type)):c&&c(Error("device has no actuator for channel:"+e))):c&&c(Error("device has no channel with id:"+e))}}else c&&c(Error("command is null"));else c&&c(Error("device is null"))},getStates:function(a){if(!this._device||!this._device.channels)return null;var c=null,b;for(b in this._device.channels)if(this._device.channels.hasOwnProperty(b)){var e=this.getState(b,a);e&&!e.error&&(c||(c={}),null==e.resolvedValue?c[b]={state:e.resolvedValue,
raw:e.resolvedRawValue}:"object"==typeof e.resolvedValue?(c[b]=JSON.parse(JSON.stringify(e.resolvedValue)),c[b].raw=e.resolvedRawValue):c[b]={state:e.resolvedValue,raw:e.resolvedRawValue})}return c},getState:function(a,c){return this._getBufferedState(a,c)},_getBufferedState:function(a,c){var b={error:null,bufferedValue:null,resolvedRawValue:null,resovledValue:null};if(!this._device)return b.error=Error("device is null"),b;a||(a=this.getDefaultChannel());if(!this._device.channels||!this._device.channels[a])return b.error=
Error("device has no channel with id:"+a),b;a=this._device.channels[a];var e,f=null,d=null,g=null,l=c.getStateBuffer();a.event&&a.event.ga&&(f=l.getState(xnm.aio.knx.KNXGateway._adr2long(a.event.ga)))&&(e=xnm.aio.knx.KNXGateway._DPT.resolve(a.event.type))&&(g=e._resolveDataRaw(f),d=e._resolveData(f));("undefined"==typeof f||null==f)&&a.status&&a.status.ga&&(f=l.getState(xnm.aio.knx.KNXGateway._adr2long(a.status.ga)))&&(e=xnm.aio.knx.KNXGateway._DPT.resolve(a.status.type))&&(g=e._resolveDataRaw(f),
d=e._resolveData(f));if(("undefined"==typeof f||null==f)&&a.status&&a.status.ga){e=l.getStateReqTime(xnm.aio.knx.KNXGateway._adr2long(a.status.ga));var k=new Date;if(!e||k.getTime()-e.getTime()>xnm.aio.knx.KNXGateway.STATES_REQ_EXPIRED)l.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(a.status.ga),k),(e=xnm.aio.knx.KNXGateway._DPT.resolve(a.status.type))&&e.getValue(c,a.status.ga)}b.bufferedValue=f;b.resolvedRawValue=g;b.resolvedValue=d;return b},refreshStates:function(a){if(!this._device||!this._device.channels)return null;
var c=a.getStateBuffer(),b;for(b in this._device.channels)if(this._device.channels.hasOwnProperty(b)){var e=this._device.channels[b];if(e.status&&e.status.ga&&e.status.type){var f=xnm.aio.knx.KNXGateway._DPT.resolve(e.status.type);if(f){var d=new Date;c.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(e.status.ga),d);f.getValue(a,e.status.ga)}}}return null}};var n=function(a){this._device=a};n.prototype=new m;n.prototype.constructor=n;n.prototype.executeCommand=function(a,c,b){if("refreshStates"==
a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(a,d,g,l){if(a)b&&b(a);else if(a=l.ga,l=xnm.aio.knx.KNXGateway._DPT.resolve(l.type),l instanceof xnm.aio.knx.KNXGateway._DPT.DPT1)switch(g){case "toggle":d=e.getState(d,c);if(d.err||!d.bufferedValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.bufferedValue.readUInt8(0);l.setValue(d?0:1,c,a,function(a){b&&b(a)}.bind(this));break;default:l.doCommand(g,c,a,b)}else if(l instanceof xnm.aio.knx.KNXGateway._DPT.DPT2)l.doCommand(g,
c,a,b);else if(l instanceof xnm.aio.knx.KNXGateway._DPT.DPT3)l.doCommand(g,c,a,b);else if(l instanceof xnm.aio.knx.KNXGateway._DPT.DPT5){var f=g;if(0==g.indexOf("inc")){f=g.substr(0,3);var h=parseInt(g.substr(3));if(!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(f=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))&&(h=1);switch(f){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;
l.incValue(h,d,c,a,function(a){b&&b(a)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;l.decValue(h,d,c,a,function(a){b&&b(a)}.bind(this));break;default:l.doCommand(g,c,a,b)}}else if(l instanceof xnm.aio.knx.KNXGateway._DPT.DPT6){f=g;if(0==g.indexOf("inc")){if(f=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(f=g.substr(0,
3),h=parseInt(g.substr(3)),!h||isNaN(h))&&(h=1);switch(f){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;l.incValue(h,d,c,a,function(a){b&&b(a)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;l.decValue(h,d,c,a,function(a){b&&
b(a)}.bind(this));break;default:l.doCommand(g,c,a,b)}}else if(l instanceof xnm.aio.knx.KNXGateway._DPT.DPT9){f=g;if(0==g.indexOf("inc")){if(f=g.substr(0,3),h=parseFloat(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(f=g.substr(0,3),h=parseFloat(g.substr(3)),!h||isNaN(h))&&(h=1);switch(f){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;l.incValue(h,d,c,a,function(a){b&&
b(a)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;l.decValue(h,d,c,a,function(a){b&&b(a)}.bind(this));break;default:l.doCommand(g,c,a,b)}}else if(l instanceof xnm.aio.knx.KNXGateway._DPT.DPT14){f=g;if(0==g.indexOf("inc")){if(f=g.substr(0,3),h=parseFloat(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(f=g.substr(0,3),h=parseFloat(g.substr(3)),
!h||isNaN(h))&&(h=1);switch(f){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;l.incValue(h,d,c,a,function(a){b&&b(a)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;l.decValue(h,d,c,a,function(a){b&&b(a)}.bind(this));break;
default:l.doCommand(g,c,a,b)}}else if(l instanceof xnm.aio.knx.KNXGateway._DPT.DPT20){f=g;if(0==g.indexOf("inc")){if(f=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("dec")&&(f=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))&&(h=1);switch(f){case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;l.incValue(h,d,c,a,function(a){b&&b(a)}.bind(this));
break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;l.decValue(h,d,c,a,function(a){b&&b(a)}.bind(this));break;default:l.doCommand(g,c,a,b)}}else b&&b(Error("unknown data point type"))})}};var q=function(a){this._device=a};q.prototype=new m;q.prototype.constructor=q;q.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var e=
this;this._parseCommand(a,function(f,d,g,l){if(f)b&&b(f);else switch(f=l.ga,l=xnm.aio.knx.KNXGateway._DPT.resolve(l.type),d){case "switch":switch(g){case "on":case "off":l.doCommand(g,c,f,b);break;case "toggle":d=e.getState(d,c);if(d.err||!d.bufferedValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.bufferedValue.readUInt8(0);l.setValue(d?0:1,c,f,function(a){b&&b(a)}.bind(this));break;default:b&&b(Error("invalid device command"))}break;default:n.prototype.executeCommand.call(e,a,c,b)}})}};
q.prototype.getDefaultChannel=function(){return"switch"};var k=function(a){this._device=a};k.prototype=new m;k.prototype.constructor=k;k.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(f,d,g,l){if(f)b&&b(f);else{f=l.ga;l=xnm.aio.knx.KNXGateway._DPT.resolve(l.type);var k=g,h=null;switch(d){case "switch":switch(g){case "on":case "off":l.doCommand(g,c,f,b);break;case "toggle":d=e.getState(d,c);if(d.err||!d.bufferedValue){b&&
b(Error("device (buffered) Status unknow"));return}d=d.bufferedValue.readUInt8(0);l.setValue(d?0:1,c,f,function(a){b&&b(a)}.bind(this));break;default:b&&b(Error("invalid device command"))}break;case "step":0==g.indexOf("stepUp")||0==g.indexOf("stepDown")?l.doCommand(g,c,f,b):b&&b(Error("invalid device command"));break;case "value":if(0==g.indexOf("inc")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else if(0==g.indexOf("dec")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=
1}else 0==g.indexOf("dimTo")&&(k="dimTo",h=parseInt(g.substr(5)),!h||isNaN(h))&&(h=0);switch(k){case "dimUp":l.doCommand("up",c,f,b);break;case "dimDown":l.doCommand("down",c,f,b);break;case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.incValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||
null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.decValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "dimTo":l.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;default:n.prototype.executeCommand.call(e,a,c,b)}}})}};k.prototype.getDefaultChannel=function(){return"value"};var u=function(a){this._device=a};u.prototype=new m;u.prototype.constructor=u;u.prototype.executeCommand=function(a,c,b){if("refreshStates"==
a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(f,d,g,l){if(f)b&&b(f);else{f=l.ga;l=xnm.aio.knx.KNXGateway._DPT.resolve(l.type);var k=g,h=null;switch(d){case "blind_step":switch(g){case "blindStepUp":l.doCommand("up",c,f,b);break;case "blindStepDown":l.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_move":switch(g){case "blindMoveUp":l.doCommand("up",c,f,b);break;case "blindMoveDown":l.doCommand("down",c,f,b);break;default:b&&
b(Error("invalid device command"))}break;case "blind_stop":switch(g){case "blindStop":l.doCommand("stop",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_position":if(0==g.indexOf("inc")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else if(0==g.indexOf("dec")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("moveTo")&&(k="moveTo",h=parseInt(g.substr(6)),!h||isNaN(h))&&(h=0);switch(k){case "moveUp":l.doCommand("down",c,f,b);
break;case "moveDown":l.doCommand("up",c,f,b);break;case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.incValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.decValue(h,d,c,f,function(a){b&&
b(a)}.bind(this));break;case "moveTo":l.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "lamella_position":if(0==g.indexOf("incL")){if(k=g.substr(0,4),h=parseInt(g.substr(4)),!h||isNaN(h))h=1}else if(0==g.indexOf("decL")){if(k=g.substr(0,4),h=parseInt(g.substr(4)),!h||isNaN(h))h=1}else 0==g.indexOf("lamellaTo")&&(k="lamellaTo",h=parseInt(g.substr(9)),!h||isNaN(h))&&(h=0);switch(k){case "lamellaUp":l.doCommand("down",c,f,b);break;case "lamellaDown":l.doCommand("up",
c,f,b);break;case "incL":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.incValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "decL":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.decValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "lamellaTo":l.doCommand("setValue"+
h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;default:n.prototype.executeCommand.call(e,a,c,b)}}})}};u.prototype.getDefaultChannel=function(){return"blind_position"};var t=function(a){this._device=a};t.prototype=new m;t.prototype.constructor=t;t.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(f,d,g,l){if(f)b&&b(f);else{f=l.ga;l=xnm.aio.knx.KNXGateway._DPT.resolve(l.type);var k=g,h=null;switch(d){case "shutter_step":switch(g){case "shutterStepUp":l.doCommand("up",
c,f,b);break;case "shutterStepDown":l.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_move":switch(g){case "shutterMoveUp":l.doCommand("up",c,f,b);break;case "shutterMoveDown":l.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_stop":switch(g){case "shutterStop":l.doCommand("stop",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_position":if(0==g.indexOf("inc")){if(k=g.substr(0,
3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else if(0==g.indexOf("dec")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("moveTo")&&(k="moveTo",h=parseInt(g.substr(6)),!h||isNaN(h))&&(h=0);switch(k){case "moveUp":l.doCommand("down",c,f,b);break;case "moveDown":l.doCommand("up",c,f,b);break;case "inc":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;
l.incValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "dec":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.decValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "moveTo":l.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;default:n.prototype.executeCommand.call(e,a,c,b)}}})}};t.prototype.getDefaultChannel=function(){return"shutter_position"};
var r=function(a){this._device=a};r.prototype=new m;r.prototype.constructor=r;r.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var e=this;this._parseCommand(a,function(f,d,g,l){if(f)b&&b(f);else{f=l.ga;l=xnm.aio.knx.KNXGateway._DPT.resolve(l.type);var k=g,h=null;switch(d){case "setpoint_basic":if(0==g.indexOf("tempUp")){if(k=g.substr(0,6),h=parseFloat(g.substr(6)),!h||isNaN(h))h=.5}else if(0==g.indexOf("tempDown")){if(k=g.substr(0,8),h=parseFloat(g.substr(8)),
!h||isNaN(h))h=.5}else 0==g.indexOf("tempTo")&&(k="tempTo",h=parseFloat(g.substr(6)),!h||isNaN(h))&&(h=0);switch(k){case "tempUp":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.incValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "tempDown":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));
return}d=d.resolvedRawValue;l.decValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "tempTo":l.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "setpoint_shift":if(0==g.indexOf("tempShiftUp")){if(k=g.substr(0,11),h=parseInt(g.substr(11)),!h||isNaN(h))h=1}else if(0==g.indexOf("tempShiftDown")){if(k=g.substr(0,13),h=parseInt(g.substr(13)),!h||isNaN(h))h=1}else 0==g.indexOf("tempShiftTo")&&(k="tempShiftTo",h=parseInt(g.substr(11)),!h||isNaN(h))&&(h=
0);switch(k){case "tempShiftUp":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.incValue(h,d,c,f,function(a){b&&b(a)}.bind(this));break;case "tempShiftDown":d=e.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}d=d.resolvedRawValue;l.decValue(h,d,c,f,function(a){b&&b(a)}.bind(this));
break;case "tempShiftTo":l.doCommand("setValue"+h,c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "mode":l.doCommand(g,c,f,b);break;default:n.prototype.executeCommand.call(e,a,c,b)}}})}};r.prototype.getDefaultChannel=function(){return"set_temperature"};var p=function(a){this._device=a};p.prototype=new m;p.prototype.constructor=p;p.prototype.doCommand=function(a,c,b){var e={};var f=a.command;var d=a.channel;d||(d=this.getDefaultChannel());if(this._device[d])if(a=this._getWriteableGa(this._device[d]))if(a instanceof
Error)b&&b(a);else switch(f){case "on":var g=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);g.setValue(1,c,a,function(a,c){a||(e.channel=d,e.state=c);b&&b(a,a?null:e)}.bind(this));break;case "off":g=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);g.setValue(0,c,a,function(a,c){a||(e.channel=d,e.state=c);b&&b(a,a?null:e)}.bind(this));break;case "toggle":f=this._getReadableGa(this._device[d]);if(!f){b&&b(Error("invalid device has no readable address"));break}if(f instanceof
Error){b&&b(a);break}g=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);g.invValue(c,a,f,function(a,c){a||(e.channel=d,e.state=c);b&&b(a,a?null:e)}.bind(this));break;default:b&&b(Error("invalid device command"))}else b&&b(Error("invalid device has no writeable address"));else b&&b(Error("invalid device"))};p.prototype.evalGroupCommand=function(a,c,b){var e={};var f=a.command;var d=a.channel;d||(d=this.getDefaultChannel());if(this._device[d])if(a=this._getWriteableGa(this._device[d]))if(a instanceof
Error)b&&b(a);else switch(f){case "on":f=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);f.evalValue(1,c,a,function(a,c){a||(e.channel=d,e.state=c);b&&b(a,a?null:e)}.bind(this));break;case "off":f=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type);f.evalValue(0,c,a,function(a,c){a||(e.channel=d,e.state=c);b&&b(a,a?null:e)}.bind(this));break;default:b&&b(Error("invalid device group command"))}else b&&b(Error("invalid device has no writeable address"));else b&&b(Error("invalid device"))};
p.prototype.getState=function(a,c,b){if(a&&a.channel)var e=a.channel;e||(e=this.getDefaultChannel());this._getState(e,c,b)};p.prototype.getDefaultChannel=function(){return"channel"};var v=function(a){this._device=a};v.prototype=new m;v.prototype.constructor=v;v.prototype.doCommand=function(a,c,b){var e,f={},d=a.command,g=a.channel;g||(g=this.getDefaultChannel());if(this._device[g]){var k=this._getWriteableGa(this._device[g]);if(k)if(k instanceof Error)b&&b(k);else if(3<=d.length&&("inc"===d.substr(0,
3).toLowerCase()||"dec"===d.substr(0,3).toLowerCase())){var m=d.substr(0,3);d=d.substr(3);""==d&&(d="10");d.match(/^\d+$/)?(d=parseInt(d),(e=this._getReadableGa(this._device[g]))?e instanceof Error?b&&b(e):(a=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[g].actuator.type),a["inc"==m?"incValue":"decValue"](d,c,k,e,function(a,c){a||null==c||(f.channel=g,f.state=c);b&&b(a,a?null:f)})):b&&b(Error("invalid device has no readable address"))):b&&b(Error("invalid device command"))}else 6<d.length&&"moveto"===
d.substr(0,6).toLowerCase()&&(d=d.substr(6)),d.match(/^\d+$/)?(d=parseInt(d),a=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[g].actuator.type),a.setValue(d,c,k,function(a,c){a||null==c||(f.channel=g,f.state=c);b&&b(a,a?null:f)})):b&&b(Error("invalid device command"));else b&&b(Error("invalid device has no writeable address"))}else b&&b(Error("invalid device"))};v.prototype.evalGroupCommand=function(a,c,b){var e={},f=a.command,d=a.channel;d||(d=this.getDefaultChannel());this._device[d]?(a=this._getWriteableGa(this._device[d]))?
a instanceof Error?b&&b(a):3<=f.length&&("inc"===f.substr(0,3).toLowerCase()||"dec"===f.substr(0,3).toLowerCase())?b&&b(Error("invalid device group command")):(6<f.length&&"moveto"===f.substr(0,6).toLowerCase()&&(f=f.substr(6)),f.match(/^\d+$/)?(f=parseInt(f),xnm.aio.knx.KNXGateway._DPT.resolve(this._device[d].actuator.type).evalValue(f,c,a,function(a,c){a||null==c||(e.channel=d,e.state=c);b&&b(a,a?null:e)})):b&&b(Error("invalid device command"))):b&&b(Error("invalid device has no writeable address")):
b&&b(Error("invalid device"))};v.prototype.getState=function(a,c,b){if(a&&a.channel)var e=a.channel;e||(e=this.getDefaultChannel());this._getState(e,c,b)};v.prototype.getDefaultChannel=function(){return"channel"};m.General=n;m.Outlet=q;m.Lighting=k;m.Blind=u;m.Shutter=t;m.Heater=r;m.BIT_1=p;m.Byte_1=v;return m}();
xnm.aio.knx.Discovery={_eventEmitter:new EventEmitter,_logger:Logger.getLogger("xnm.aio.knx.Discovery"),_listenerSockets:[],_closedSockets:[],on:function(m,n){this._eventEmitter.on(m,n)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},startSearchKNX:function(){if(os&&os.networkInterfaces){var m=os.networkInterfaces(),n;for(n in m)for(var q=m[n],k=0;k<q.length;k++){var u=q[k];!1===u.internal&&"IPv4"===u.family&&this._createSocket(u.address)}}else this._createSocket(null);this._closedSockets=
[]},stopSearchKNX:function(){for(var m=0;m<this._listenerSockets.length;m++)this._listenerSockets[m].close()},_createSocket:function(m){var n=this,q=dgram.createSocket("udp4");q.on("listening",function(){q.addMembership("224.0.23.12");q.setBroadcast(!0);var k=q.address();n._logger.log("debug","knx discovery socket listening "+k.address+":"+k.port);n._listenerSockets.push(q);var m=(new xnm.aio.knx.KNXGateway.IPFrame.SearchRequest({ip:k.address,port:k.port})).toBuffer();n._logger.log("debug","send knx search request: "+
m.toString("hex")+" from "+k.address+":"+k.port);q.send(m,0,m.length,3671,"224.0.23.12")});q.on("message",function(k,m){var t=q.address();n._logger.log("trace","receive data "+k.toString("hex")+" from "+m.address+":"+m.port+" @local "+t.address+":"+t.port);k=xnm.aio.knx.KNXGateway.IPFrame.parseFrame(k);k instanceof xnm.aio.knx.KNXGateway.IPFrame.SearchResponse&&(m=k.getCtrlEndpointHPAI(),n._logger.log("debug","find knx "+m.ip+":"+m.port),n._eventEmitter.emit("found",k,t),n._eventEmitter.emit("device",
k.toJSON(),t))});q.on("error",function(k){n._logger.log("debug","discovery socket error: "+k.stack);n._eventEmitter.emit("error",k)});q.on("close",function(){n._logger.log("debug","discovery socket closed");n._closedSockets.push(q);n._listenerSockets.length===n._closedSockets.length&&(n._listenerSockets=[],n._closedSockets=[],n._eventEmitter.emit("close"))});q.bind(null,m)}};
xnm.aio.knx.Handler=function(){var m=function(){this._listenerSockets=[]};m.prototype={KNXGateway:xnm.aio.knx.KNXGateway,Finder:xnm.aio.knx.Discovery};return m}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.knx.Handler);
