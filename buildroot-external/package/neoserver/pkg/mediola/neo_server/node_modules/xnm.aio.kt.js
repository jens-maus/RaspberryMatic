var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.kt=xnm.aio.kt||{};xnm.aio.kt.Socket=function(b,a,c){this.ip=b;this.port=28530;this.uuid=a;this._state="?";c&&(this._manuCode=c.manuCode,this._authCode=c.authCode,this._deviceType=c.deviceType);this.CommandHandler=null};
xnm.aio.kt.Socket.prototype._sendMessage=function(b,a){for(var c=[1,0],e=this.uuid.replace(/-/g,""),d=0;6>d;d++)c.push(parseInt(e.substr(2*d,2),16));c.push(b.length+7);c.push(0);c.push(0);c.push(0);c.push(this._manuCode);c.push(this._authCode[0]);c.push(this._authCode[1]);c.push(this._deviceType);for(d=0;d<b.length;d++)c.push(b[d]);c=new Buffer(c);console.log("send packet",c.toString("hex"));var f=require("dgram").createSocket("udp4");f.send(c,0,c.length,this.port,this.ip,function(c,b){f.close();
a&&setTimeout(function(){a.call()},1E3)})};xnm.aio.kt.Socket.prototype.getState=function(b){this._sendMessage([2,0,0,0,0]);var a=this;setTimeout(function(){b(a._state)},3E3)};xnm.aio.kt.Socket.prototype.executeCommand=function(b,a,c){var e=this,d=[1,0,0,0,255];if("on"==a)d[3]=255;else if("toggle"==a){this.getState(function(a){"on"==a||"off"==a?("off"==a&&(d[3]=255),e._sendMessage(d,function(){e._sendMessage(d,c)})):c&&c.call()});return}e._sendMessage(d,function(){e._sendMessage(d,c)})};
xnm.aio.kt.Socket.prototype.getStates=function(b,a,c){var e=this;this.CommandHandler=b;this.getState(function(b){var f={state:b};a&&e.CommandHandler.setState?e.CommandHandler.setState(a.id,b):e.CommandHandler.receivedState&&e.CommandHandler.receivedState("kt",e.uuid,f);c&&c(f)})};xnm.aio.kt.Socket.prototype.getStateValues=function(b){return b};
xnm.aio.kt.Discovery=function(){this.Devices={};this.callback=null;this._sockets=[];var b=require("os");require("dgram");if(b&&b.networkInterfaces){var b=b.networkInterfaces(),a;for(a in b)for(var c=b[a],e=0;e<c.length;e++)this._addDiscoverSocket(28530,c[e])}else this._addDiscoverSocket(28530,null)};xnm.aio.kt.Discovery.prototype._getMAC=function(b){for(var a="",c=0;5>c;c++)a+=XC.getHexVal(b[c],2).toUpperCase()+"-";return a+=XC.getHexVal(b[c],2).toUpperCase()};
xnm.aio.kt.Discovery.prototype._receivedData=function(b,a){a=a.toString("hex");a=new Buffer(a,"hex");XC.debugf("Received data from "+b+" ("+a.length+")");XC.debugf(a.toString("hex"));var c,e,d,f;1<a.length&&(c=a[0]);2<a.length&&(e=a[1]);8<a.length&&(d=a.slice(2,8));9<a.length&&(f=a[8]);a.slice(9);var g=!1;e&64&&(g=!0);console.log(c,e,d,f,g);44==a.length&&35==a[16]?(c={manuCode:a[12],authCode:[a[13],a[14]],deviceType:a[15]},d=this._getMAC(a.slice(21,27)),this.Devices[b]=new xnm.aio.kt.Socket(b,d,c),
this.callback&&this.Devices[b]&&this.callback(this.Devices[b])):21==a.length&&2==a[16]&&this.Devices[b]&&(this.Devices[b]._state=255==a[a.length-2]?"on":"off",this.Devices[b].CommandHandler&&this.Devices[b].CommandHandler.receivedState&&this.Devices[b].CommandHandler.receivedState("kt",this.Devices[b].uuid,{state:this.Devices[b]._state}))};
xnm.aio.kt.Discovery.prototype._addDiscoverSocket=function(b,a){var c=require("dgram"),e=this;if(a)"IPv4"==a.family&&0==a.internal&&(d=c.createSocket("udp4"),d.on("listening",function(){d.setBroadcast(!0)}),d.on("message",function(a,b){e._receivedData(b.address,a)}),d.bind(b,a.address),this._sockets.push(d));else{var d=c.createSocket("udp4");d.on("message",function(a,b){e._receivedData(b.address,a)});d.bind(b);this._sockets.push(d)}};
xnm.aio.kt.Discovery.prototype._sendDiscoveryMessages=function(b,a,c,e){b=new Buffer([1,0,255,255,255,255,255,255,14,0,0,0,202,253,102,33,35,255,255,255,255,255,255]);for(a=0;2>a;a++)for(c=0;c<this._sockets.length;c++)this._sockets[c].send(b,0,b.length,28530,"255.255.255.255")};xnm.aio.kt.Discovery.prototype.discoverDevices=function(){this._sendDiscoveryMessages()};xnm.aio.kt.Handler=function(){this._Discovery=new xnm.aio.kt.Discovery;this._Discovery.discoverDevices()};
xnm.aio.kt.Handler.prototype.discoverDevices=function(b){b&&(this._Discovery.callback=b);this._Discovery.discoverDevices()};xnm.aio.kt.Handler.prototype.getStateValues=function(b,a){return(new xnm.aio.kt.Socket).getStateValues(a)};xnm.aio.kt.Handler.prototype.getDeviceCommandList=function(b,a){var c=[];c.push({id:window.XC_Text.on,cmd:"on"});c.push({id:window.XC_Text.off,cmd:"off"});return c};
xnm.aio.kt.Handler.prototype.getDevice=function(b){for(var a in this._Discovery.Devices)if(b.address&&this._Discovery.Devices[a].uuid==b.address)return this._Discovery.Devices[a];return null};xnm.aio.kt.Handler.prototype.Socket=xnm.aio.kt.Socket;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.kt.Handler);
