var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.max=xnm.aio.max||{};xnm.aio.max.Task=function(a,b,c){this.type=a;this.data=b;this.callback=c;this._taskFinishCallback=null};
xnm.aio.max.Task.prototype.run=function(a,b){if(a){this._taskFinishCallback=b;var c=this,e="",d=!1,g=!1,f={};a._connect({_onSocketData:function(b){for(e+=b;0<(b=e.indexOf("\r\n"));){var h=a._evalBlock(f,e.substr(0,b));h&&h.l&&(g=!0);h&&h.s&&(d=!0);e=e.substr(b+2)}"command"==c.type&&d?(c._finish(null,null,1500),a._disconnect()):g&&("command"==c.type?c._executeCommand(a,c.data,f)||(c._finish(Error("execute command invalid")),a._disconnect()):("status"==c.type?(b=c._resolveStatus(c.data,f),c._finish(null,
b)):c._finish(null,f),a._disconnect()))},_onSocketTimeout:function(){c._finish(Error("socket data timeout"));a._disconnect()},_onSocketError:function(a){c._finish(a)},_onSocketClose:function(){}},function(a){a&&c._finish(a)})}else b&&b(Error("cube is null"))};
xnm.aio.max.Task.prototype._executeCommand=function(a,b,c){var e=b.device;b=b.command;if(e&&b&&(c=a._getDeviceByAddress(c,e.address))){switch(b.value){case "temp":e=b.ext;break;default:e=b.value}if(null!=e&&"undefined"!=typeof e)return c=a._buidCommand(c,e),a._sendMessage(c),!0}};
xnm.aio.max.Task.prototype._resolveStatus=function(a,b){var c={},e;for(e in b)if(b.hasOwnProperty(e)&&b[e]&&b[e].devices&&0<b[e].devices.length)for(var d=b[e].devices,g=0;g<d.length;g++)d[g]&&d[g].address&&d[g].state&&(c[d[g].address]=d[g].state);var f;b=[];for(e=0;e<a.length;e++)if(a[e]&&a[e].id&&a[e].device&&a[e].status&&(g=a[e].device.address)&&c[g]){switch(a[e].status.value){case "tempC":(f=c[g].current)&&(f=parseFloat(f).toFixed(1));break;case "temp":(f=c[g].val)&&(f=parseFloat(f).toFixed(1));
break;case "state":"switch"==a[e].device.data?(f=c[g].val,f=parseFloat(f),f=15>=f?"off":"on"):f=c[g].val;break;case "mode":f=c[g].mode;break;case "battery":f=c[g].battery,f="OK"==f?"ok":"low"==f?"low_bat":null}d=null;a[e].status.extra&&"battery"==a[e].status.extra&&"low"==c[g].battery&&(d="battery");null!=f&&"undefined"!=typeof f&&(g={id:a[e].id,status:f},d&&(g.info=d),b.push(g))}return b};
xnm.aio.max.Task.prototype._finish=function(a,b,c){if(this.callback){var e=this.callback;c?setTimeout(function(){e(a,b)},c):e(a,b);this.callback=null}this._taskFinishCallback&&(this._taskFinishCallback(a),this._taskFinishCallback=null)};xnm.aio.max.Cube=function(a,b,c){var e=require("x.logger.js");this._logger=e?e.getLogger("xnm.aio.max.Cube"):{log:function(){}};this.ip=a;this.port=b;this.port||(this.port=62910);this.uuid=c;this._socket=null;this._tasks=[]};xnm.aio.max.Cube.SO_TIMEOUT=1E3;
xnm.aio.max.Cube.prototype.executeCommandCreator=function(a,b,c){a=new xnm.aio.max.Task("command",{device:a,command:b},c);b=0==this._tasks.length;this._tasks.push(a);b&&this._doNextTask()};xnm.aio.max.Cube.prototype.getStatesCreator=function(a,b,c){b?0==b.length?c&&c(null,[]):(a=new xnm.aio.max.Task("status",b,c),b=0==this._tasks.length,this._tasks.push(a),b&&this._doNextTask()):c&&c(Error("deviceList is null"))};
xnm.aio.max.Cube.prototype.getDevices=function(a){a=new xnm.aio.max.Task("devices",null,a);var b=0==this._tasks.length;this._tasks.push(a);b&&this._doNextTask()};xnm.aio.max.Cube.prototype._doNextTask=function(){if(0!=this._tasks.length){var a=this,b=this._tasks[0];b.run(this,function(){a._removeTask(b);a._doNextTask()})}};xnm.aio.max.Cube.prototype._removeTask=function(a){for(var b=-1,c=0;c<this._tasks.length;c++)if(this._tasks[c]===a){b=c;break}-1!=b&&this._tasks.splice(b,1)};
xnm.aio.max.Cube.prototype._getDeviceByAddress=function(a,b){for(var c in a)if(a.hasOwnProperty(c))for(var e=0;e<a[c].devices.length;e++)if(a[c].devices[e].address==b)return a[c].devices[e];return null};
xnm.aio.max.Cube.prototype._evalState=function(a,b,c){if(a=this._getDeviceByAddress(a,b))if(a.state={val:"?"},2<c.length&&c[1]&16&&!(c[1]&8)&&c[1]&2){if(4==a.type&&3==c.length)a.state=c[2]&2?{val:"open"}:{val:"closed"};else if((1==a.type||2==a.type||3==a.type)&&8<=c.length){b="auto";switch(c[2]&3){case 0:b="auto";break;case 1:b="manu";break;case 2:b="vacation";break;case 3:b="boost"}var e=((c[4]&63)/2).toFixed(1);a.state={val:e,mode:b,valve:c[3]};9==c.length&&(delete a.state.valve,a.state.current=
(((c[4]>>7&1)<<8|c[8])/10).toFixed(1))}a.state.battery=c[2]&128?"low":"OK"}};xnm.aio.max.Cube.prototype._evalLData=function(a,b){b=new Buffer(b,"base64");for(var c=0;c<b.length;){var e=b[c];if(0==e)break;var d=XC.getHexVal(b[c+1],2)+XC.getHexVal(b[c+2],2)+XC.getHexVal(b[c+3],2),g=b.slice(c+4,c+e+1);this._evalState(a,d,g);c+=e+1}return{l:a}};
xnm.aio.max.Cube.prototype._evalMData=function(a,b){b=b.split(",");if(3==b.length){var c=new Buffer(b[2],"base64");if(86==c[0]&&2==c[1]){var e=c[2],d=3;for(b=0;b<e;b++){var g=a[c[d]]={};var f=c[d+1];g.name=c.slice(d+2,d+2+f).toString();g.address=XC.getHexVal(c[d+2+f],2)+XC.getHexVal(c[d+3+f],2)+XC.getHexVal(c[d+4+f],2);g.devices=[];d=d+5+f}e=c[d];for(b=0;b<e;b++)g={},g.type=c[d+1],g.address=XC.getHexVal(c[d+2],2)+XC.getHexVal(c[d+3],2)+XC.getHexVal(c[d+4],2),d+=5,g.serial=c.slice(d,d+10).toString(),
f=c[d+10],g.name=c.slice(d+11,d+11+f).toString(),g.room=c[d+11+f],a[c[d+11+f]]||(a[c[d+11+f]]={},a[c[d+11+f]].devices=[]),a[c[d+11+f]].devices.push(g),d=d+11+f}}};xnm.aio.max.Cube.prototype._evalCData=function(a,b){b=b.split(",");if(2==b.length&&(b=new Buffer(b[1],"base64"),210==b[0])){var c=XC.getHexVal(b[1],2)+XC.getHexVal(b[2],2)+XC.getHexVal(b[3],2);if(a=this._getDeviceByAddress(a,c))a.comfort=(b[18]/2).toFixed(1),a.eco=(b[19]/2).toFixed(1)}};
xnm.aio.max.Cube.prototype._evalBlock=function(a,b){if(2<b.length){if("M:"==b.substr(0,2))return this._evalMData(a,b.substr(2));if("L:"==b.substr(0,2))return this._evalLData(a,b.substr(2));if("C:"==b.substr(0,2))return this._evalCData(a,b.substr(2));if("H:"==b.substr(0,2))a=b.split(","),11==a.length&&(this.uuid=a[0]);else if("S:"==b.substr(0,2))return{s:b}}};
xnm.aio.max.Cube.prototype._connect=function(a,b){if(a){this._socket&&(this._socket.end(),this._socket=null);var c=this,e={port:this.port,host:this.ip},d=require("net").connect(e);d.setTimeout(xnm.aio.max.Cube.SO_TIMEOUT);d.setEncoding("utf8");d.on("connect",function(){c._logger.log("trace","connect to max cube:"+c.ip);c._socket=d;b()});d.on("data",function(b){c._logger.log("trace","receive from max cube:"+c.ip+" data:"+b);a._onSocketData(b)});d.on("error",function(e){c._socket?(c._logger.log("trace",
"max cube:"+c.ip+" error:"+e.message),d.destroy(),a._onSocketError(e)):(c._logger.log("trace","max cube:"+c.ip+" connection error:"+e.message),b(e))});d.on("timeout",function(){c._socket?(c._logger.log("trace","max cube:"+c.ip+" data timeout"),a._onSocketTimeout()):(c._logger.log("trace","max cube:"+c.ip+" connection timeout"),d.destroy&&d.destroy(),b(Error("timeout")))});d.on("close",function(){c._logger.log("trace","max cube:"+c.ip+" close socket");a._onSocketClose()});d._doConnect&&"function"==
typeof d._doConnect&&d._doConnect();return d}b&&b(Error("handler is null"))};xnm.aio.max.Cube.prototype._disconnect=function(){this._socket&&(this._socket.end(),this._socket=null)};
xnm.aio.max.Cube.prototype._buidCommand=function(a,b){if(!b||!a||!a.address||null==a.room||"undefined"==typeof a.room)return null;var c=[0,4,64,0,0,0,0,0,0,0,0];c[6]=parseInt(a.address.substr(0,2),16);c[7]=parseInt(a.address.substr(2,2),16);c[8]=parseInt(a.address.substr(4,2),16);c[9]=a.room;"auto"==b?c[10]=0:"manu"==b?c[10]=64:"boost"==b?c[10]=192:"on"==b?c[10]=114:"off"==b?c[10]=94:(c[10]=Math.round(2*parseFloat(b)),9>c[10]&&(c[10]=9),60<c[10]&&(c[10]=60),a.state&&"manu"==a.state.mode&&(c[10]+=
64));return"s:"+(new Buffer(c)).toString("base64")+"\r\n"};xnm.aio.max.Cube.prototype._sendMessage=function(a){this._socket&&(this._logger.log("trace","send to max cube "+this.ip+": "+a),this._socket.write(a,"utf8"))};xnm.aio.max.Cube.prototype.toJSON=function(){return{sys:xnm.aio.max.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid}};xnm.aio.max.Cube.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.max.Cube?this.ip==a.ip&&this.port==a.port:!1};
xnm.aio.max.Discovery=function(){this.Cubes={};this.callback=null;this._sockets=[];var a=require("os");require("dgram");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var b in a)if(a.hasOwnProperty(b))for(var c=a[b],e=0;e<c.length;e++)this._addDiscoverSocket(23272,c[e])}else this._addDiscoverSocket(23272,null)};
xnm.aio.max.Discovery.prototype._receivedData=function(a,b){b=b.toString("hex");b=new Buffer(b,"hex");26==b.length&&(a=new xnm.aio.max.Cube(a),a.uuid=(new Buffer(b.slice(8,18))).toString(),this.Cubes[a.uuid]=a,this.callback&&this.callback(this.Cubes[a.uuid]))};
xnm.aio.max.Discovery.prototype._addDiscoverSocket=function(a,b){var c=this,e=require("dgram");try{var d=e.createSocket({reuseAddr:!0,type:"udp4"})}catch(g){d=e.createSocket("udp4")}d.on("listening",function(){d.setBroadcast(!0)});d.on("message",function(a,b){c._receivedData(b.address,a)});b?"IPv4"==b.family&&0==b.internal&&(d.bind(a,b.address),this._sockets.push(d)):(d.bind(a),this._sockets.push(d))};
xnm.aio.max.Discovery.prototype._sendDiscoveryMessages=function(){for(var a=new Buffer([101,81,51,77,97,120,42,0,42,42,42,42,42,42,42,42,42,42,73]),b=0;b<this._sockets.length;b++)this._sockets[b].send(a,0,a.length,23272,"255.255.255.255")};xnm.aio.max.Discovery.prototype.discoverCubes=function(a){a&&(this.Cubes={});this._sendDiscoveryMessages()};xnm.aio.max.DMError=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};xnm.aio.max.DMError.prototype=Error();
xnm.aio.max.DMError.prototype.name="MaxDMError";xnm.aio.max.DMError.prototype.code=0;xnm.aio.max.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.max.DM={SYS:"max",MAP:{"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}}]},thermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"manu",ref:{value:"manu"}},{type:"enum",name:"boost",ref:{value:"boost"}},{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",
extMeta:"4.5-30",scale:"0.5"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["auto","manu","boost","vacation"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}},{type:"float",name:"temperature",ref:{value:"temp",extMeta:"4.5-30",scale:"0.5"}}]},wallthermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"manu",ref:{value:"manu"}},{type:"enum",name:"boost",ref:{value:"boost"}},{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",
extMeta:"4.5-30",scale:"0.5"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["auto","manu","boost","vacation"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}},{type:"float",name:"temperature",ref:{value:"temp",extMeta:"4.5-30",scale:"0.5"}},{type:"float",name:"current temperature",ref:{value:"tempC",extMeta:"4.5-30",scale:"0.5"}}]},contact:{status:[{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}},{type:"enum",name:"battery",ref:{value:"battery",
options:["ok","low_bat"]}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"MAX! Cube",port:62910}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:1,name:"Switch"},{sys:this.SYS,type:1,name:"Thermostat"},{sys:this.SYS,type:2,name:"Thermostat Plus"},{sys:this.SYS,type:3,name:"Wall Thermostat"},{sys:this.SYS,type:4,name:"Shutter contact"},{sys:this.SYS,type:5,name:"Push Button"}]},createGateway:function(a,b,c){b=xnm.aio.max.DMError;var e=xnm.aio.max.DMError.ERROR_CODE;a?a.ip?c(null,
a):c(new b(e.INVALID,"ip is invalid")):c(new b(e.INVALID,"info is invalid"))},updateGateway:function(a,b,c,e){a=xnm.aio.max.DMError;c=xnm.aio.max.DMError.ERROR_CODE;b?b.ip?e(null,b):e(new a(c.INVALID,"ip is invalid")):e(new a(c.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,b,c){var e=xnm.aio.max.DMError,d=xnm.aio.max.DMError.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)c(new e(d.INVALID,"address is invalid"));else if(null==
a.type||"undefined"==typeof a.type)c(new e(d.INVALID,"type is invalid"));else if(null==a.room||"undefined"==typeof a.room)c(new e(d.INVALID,"room is invalid"));else if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var g;for(g=0;g<b.length;g++)if(b[g].index===a.gateway){var f=b[g];break}f?c(null,a):c(new e(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new e(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else c(new e(d.INVALID,"gateway is invalid"));
else c(new e(d.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var e=xnm.aio.max.DMError,d=xnm.aio.max.DMError.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)c(new e(d.INVALID,"address is invalid"));else if(null==a.type||"undefined"==typeof a.type)c(new e(d.INVALID,"type is invalid"));else if(null==a.room||"undefined"==typeof a.room)c(new e(d.INVALID,"room is invalid"));else if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var g;for(g=
0;g<b.length;g++)if(b[g].index===a.gateway){var f=b[g];break}f?c(null,a):c(new e(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new e(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else c(new e(d.INVALID,"gateway is invalid"));else c(new e(d.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},e=function(a,b,d){var e=[];switch(d.catagory){case "command":a.command&&
a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},d=function(a,b){var c=[];var d=a.type;"string"==typeof d&&(d=parseInt(d));switch(d){case 1:d=a.data&&"switch"==a.data?xnm.aio.max.DM.MAP["switch"]:xnm.aio.max.DM.MAP.thermo;break;case 2:d=xnm.aio.max.DM.MAP.thermo;break;case 3:d=xnm.aio.max.DM.MAP.wallthermo;break;case 4:d=
xnm.aio.max.DM.MAP.contact;break;default:return null}if(!d)return null;d=JSON.parse(JSON.stringify(d));if(d.status)for(var f=0;f<d.status.length;f++)"battery"!=d.status[f].ref.value&&(d.status[f].ref.extra="battery");d&&(a=e(d,a,b),c=c.concat(a));return c};if(!a||null==a.type||"undefined"==typeof a.type)return null;var g=JSON.parse(JSON.stringify(a)),f=null;switch(b.catagory){case "command":f=d(a,b);g.command=f;break;case "status":f=d(a,b);g.status=f;break;default:return null}return f&&0!=f.length?
g:null}};xnm.aio.max.Handler=function(){this._Discovery=null};xnm.aio.max.Handler.prototype.Cube=xnm.aio.max.Cube;xnm.aio.max.Handler.prototype.discoverCubes=function(a){this._disConCbs||(this._disConCbs=[]);this._Discovery||this._createDiscovery();a&&-1==this._getIndex(a,this._disConCbs)&&this._disConCbs.push(a);this._Discovery.discoverCubes()};xnm.aio.max.Handler.prototype.getDetectedCubes=function(){this._Discovery||this._createDiscovery();return this._Discovery.Cubes};
xnm.aio.max.Handler.prototype.discoverCubeWithTimeout=function(a,b){if(b&&a){this._disTimeCbs||(this._disTimeCbs=[]);this._Discovery||this._createDiscovery();var c=this,e=this._disTimeCbs.length;b&&-1==this._getIndex(b,this._disTimeCbs)&&this._disTimeCbs.push(b);setTimeout(function(){var a=c._getIndex(b,c._disTimeCbs);-1!=a&&-2!=a&&c._disTimeCbs.splice(a,1);a=c.getDetectedCubes();var e=[],f;for(f in a)a.hasOwnProperty(f)&&a[f]&&e.push(a[f]);b(null,e)},1E3*a);this._Discovery.discoverCubes(e?!0:!1)}};
xnm.aio.max.Handler.prototype._discoverCb=function(a){if(this._disConCbs)for(var b=0;b<this._disConCbs.length;b++)if(this._disConCbs[b])this._disConCbs[b](a)};xnm.aio.max.Handler.prototype._createDiscovery=function(){if(!this._Discovery){this._Discovery=new xnm.aio.max.Discovery;var a=this;this._Discovery.callback=function(b){a._discoverCb(b)}}};xnm.aio.max.Handler.prototype._getIndex=function(a,b){if(!a||!b)return-2;for(var c=0;c<b.length;c++)if(a===b[c])return c;return-1};
xnm.aio.max.Handler.prototype.devicemanager=xnm.aio.max.DM;xnm.aio.max.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"max")};xnm.aio.max.Handler.prototype.resolveGateway=function(a){return a&&a.ip?new xnm.aio.max.Cube(a.ip,a.port,a.uuid):null};xnm.aio.max.Handler.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.max.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};
xnm.aio.max.Handler.prototype.getDeviceStatus=function(a,b){a=(a=xnm.aio.max.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};xnm.aio.max.Handler.prototype.doCommand=function(a,b,c,e){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){e&&e(a)}):e&&e(Error("gateway json format invalid"))};
xnm.aio.max.Handler.prototype.doStatus=function(a,b,c,e,d){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:e}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("gateway json format invalid"))};
xnm.aio.max.Handler.prototype.getDeviceList=function(a,b){(a=this.resolveGateway(a))?a.getDevices(function(a,e){if(a)b&&b(a);else{a=[];if(e)for(var c in e)if(e.hasOwnProperty(c)&&e[c]){if(e[c].devices){var g=[];e[c].devices.forEach(function(a){if(a){a.sys=xnm.aio.max.DM.SYS;var b=a.type;null!=b&&"undefined"!=typeof b&&(b=parseInt(b));switch(b){case 1:a.data="thermo";break;case 2:a.data="thermoplus";break;case 3:a.data="wallthermo";break;case 4:a.data="contact";break;case 5:a.data="button";break;default:return}g.push(a)}});
e[c].devices=g}a.push(e[c])}b&&b(null,a)}}):b&&b(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.max.Handler);
