var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mbus=xnm.aio.mbus||{};xnm.aio.mbus.TYPE_REQ=1;xnm.aio.mbus.TYPE_RES=2;xnm.aio.mbus.TYPE_STA=3;xnm.aio.mbus.TYPE_TST=4;xnm.aio.mbus.MediolaBus=function(b){this._port=b;this._serialPort=null;this._checkInterval=1E3;this._timeout=200;this._maxRetries=1;this._timeoutTimer=null;this._sending=!1;this._retries=0;this._messages=[];this._onData=this._onError=null;this._state=0};xnm.aio.mbus.MediolaBus.prototype.open=function(){this._state||(this._state=1,this._checkPort())};
xnm.aio.mbus.MediolaBus.prototype.close=function(){this._state&&(this._state=0,this._serialPort&&(this._serialPort.close(),this._serialPort=null))};xnm.aio.mbus.MediolaBus.prototype.on=function(b,a){"error"==b?this._onError=a:"data"==b&&(this._onData=a)};
xnm.aio.mbus.MediolaBus.prototype._checkPort=function(){if(this._state){var b=this._checkInterval,a=this;if(null!=this._serialPort){var d=!0;try{this._serialPort.drain()}catch(c){d=!1}if(!d){try{a._serialPort.close()}catch(c){}a._serialPort=null;b*=2;a._connect()}}else b*=2,this._connect();setTimeout(function(){a._checkPort()},b)}};xnm.aio.mbus.MediolaBus.prototype._onTimeout=function(){this._sending=!1;this._retries<this._maxRetries?this._retries+=1:(this._messages.shift(),this._retries=0);this._sendNextMessage()};
xnm.aio.mbus.MediolaBus.prototype._resetSendingState=function(){this._timeoutTimer&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null);this._sending=!1;this._retries=0};
xnm.aio.mbus.MediolaBus.prototype._sendNextMessage=function(){if(null!=this._serialPort&&!this._sending&&0<this._messages.length){var b=this._messages[0];b=(new (require("xnm.aio.m10T.js").STMUSBSerial)).generateCommandMessage(b,113);b=new Buffer.from(b);this._sending=!0;this._serialPort.write(b);this._serialPort.drain();var a=this;this._timeoutTimer=setTimeout(function(){a._onTimeout()},this._timeout)}};
xnm.aio.mbus.MediolaBus.prototype._sendMessage=function(b,a,d){var c=[];c[0]=b>>8;c[1]=b&255;c[2]=1;c[3]=1;c[4]=a;c[5]=d.length>>8;c[6]=d.length&255;c[7]=0;for(b=c[8]=0;b<d.length;b++)c[9+b]=d[b];d=this._computeCRC(d);c[7]=d>>8;c[8]=d&255;this._messages.push(c);this._sendNextMessage()};xnm.aio.mbus.MediolaBus.prototype._computeCRC=function(b){for(var a=0,d=0;d<b.length;d++){a^=b[d]<<8;for(var c=0;8>c;c++)a=a&32768?a<<1^4129:a<<1,a&=65535}return a};
xnm.aio.mbus.MediolaBus.prototype._connect=function(b){var a=this;a._resetSendingState();a._messages=[];a._sending=!0;var d=Buffer.from([]),c=null,e=!1,g=!1,h=require("serialport");this._serialPort=h.SerialPort?new h.SerialPort(this._port,{baudrate:115200}):new h(this._port,{baudRate:115200});this._serialPort.on("open",function(){XC.debugf("opened port: "+a._port);b&&(b(!0),b=null);a._sending=!1;a._sendNextMessage()});this._serialPort.on("error",function(c){XC.debugf("port error: "+c.message);if(null!=
a._serialPort){try{a._serialPort.close()}catch(f){}a._serialPort=null}b&&(b(!1),b=null)});this._serialPort.on("close",function(b){a._serialPort=null});this._serialPort.on("data",function(b){d=Buffer.concat([d,b]);g=!1;c=null;e=!1;for(b=0;b<d.length;b++){var f=d[b];27==f||4==f||31==f?g?(c&&c.push(f),g=!1):27==f?g=!0:4==f?(e=!0,d=d.slice(b+1)):31==f&&(c=[],g=!1):(c&&c.push(f),g=!1);if(c&&e&&1!=c[0]&&0!=c[0]&&113==c[0]&&(c.shift(),c.pop(),f=Buffer.from(c),9<f.length&&f.length==(f[5]<<8)+f[6]+9&&(f[4]==
xnm.aio.mbus.TYPE_RES&&0<a._messages.length&&a._messages[0][0]==f[2]&&a._messages[0][1]==f[3]&&(a._resetSendingState(),a._messages.shift(),setTimeout(function(){a._sendNextMessage()},10)),a._onData))){var h=[];for(b=9;b<(f[5]<<8)+f[6]+9;b++)h.push(f[b]);a._onData({source:f[2]+"."+f[3],type:f[4],data:h})}}})};xnm.aio.mbus.MediolaBus.prototype._getAddressFromString=function(b){var a=null;b=b.split(".");2==b.length&&(a=parseInt(b[0]),b=parseInt(b[1]),a=((a&255)<<8)+(b&255));return a};
xnm.aio.mbus.MediolaBus.prototype._getBitmaskFromString=function(b){for(var a=0,d=0;d<b.length;d++)"1"==b[d]&&(a+=128>>d);return a};
xnm.aio.mbus.MediolaBus.prototype._getBitmaskFromID=function(b){var a=0;b=parseInt(b);if(1>b||26<b)return a;switch(b){case 1:a=65536;break;case 2:a=131072;break;case 3:a=262144;break;case 4:a=524288;break;case 5:a=1048576;break;case 6:a=16777216;break;case 7:a=33554432;break;case 8:a=67108864;break;case 9:a=134217728;break;case 10:a=268435456;break;case 11:a=536870912;break;case 12:a=1073741824;break;case 13:a=-2147483648;break;case 14:a=32768;break;case 15:a=16384;break;case 16:a=8192;break;case 17:a=
4096;break;case 18:a=2048;break;case 19:a=1024;break;case 20:a=512;break;case 21:a=256;break;case 22:a=128;break;case 23:a=8;break;case 24:a=16;break;case 25:a=32;break;case 26:a=64}return a};xnm.aio.mbus.MediolaBus.prototype.updateStates=function(b){for(var a in b){var d=this._getAddressFromString(b[a]);null!=d&&this._sendMessage(d,1,[5])}};
xnm.aio.mbus.MediolaBus.prototype.evalState=function(b,a){var d=null;if(null!=b&&null!=a&&(a.type==xnm.aio.mbus.TYPE_RES||a.type==xnm.aio.mbus.TYPE_STA))if("srswitch"==b.type.toLowerCase()){var c=null;a.type==xnm.aio.mbus.TYPE_STA&&1==a.data.length?c=a.data[0]:a.type==xnm.aio.mbus.TYPE_RES&&2==a.data.length&&(c=a.data[1]);null!=c&&(a=this._getBitmaskFromString(b.data),d=c&a?"on":"off")}else if("feedback"==b.type.toLowerCase())c=null,a.type==xnm.aio.mbus.TYPE_STA&&4==a.data.length?c=a.data:a.type==
xnm.aio.mbus.TYPE_RES&&5==a.data.length&&(c=a.data.slice(1)),null!=c&&(c=(c[0]<<24)+(c[1]<<16)+(c[2]<<8)+c[3],a=this._getBitmaskFromID(b.data),0!=a&&(d=c&a?"on":"off"));else if("n26shutter"==b.type.toLowerCase()||"n26shuttergroup"==b.type.toLowerCase())if(c=null,a.type==xnm.aio.mbus.TYPE_STA&&17==a.data.length?c=a.data:a.type==xnm.aio.mbus.TYPE_RES&&18==a.data.length&&(c=a.data.slice(1)),null!=c){a=null;var e=!0;b=b.data.split(";");for(var g=0;g<b.length;g++){var h=b[g].split(".");if(2==h.length){var k=
parseInt(h[0]);h=parseInt(h[1]);if(0<k&&18>k&&0<h&&5>h)if(k=c[k-1],k>>=2*(h-1),k&=3,e)a=k,e=!1;else if(k!=a){a=0;break}}}null!=a&&(1==a?d="up":2==a?d="down":3==a?d="angle":0==a&&(d="undefined"))}return d};
xnm.aio.mbus.MediolaBus.prototype.executeCommand=function(b,a){if(null!=b){var d=this._getAddressFromString(b.address);if(null!=d)if("srswitch"==b.type.toLowerCase()){var c=this._getBitmaskFromString(b.data),e=null;"on"==a?e=[1,c]:"off"==a?e=[2,c]:"toggle"==a&&(e=[3,c]);null!=e&&this._sendMessage(d,1,e)}else if("n26shutter"==b.type.toLowerCase()||"n26shuttergroup"==b.type.toLowerCase())for(c=0,"up"==a?c=1:"down"==a?c=2:"angle"==a?c=3:"stop"==a&&(c=4),a=b.data.split(";"),b=0;b<a.length;b++){e=[c];
var g=a[b].split(".");if(2==g.length){var h=parseInt(g[0]);g=parseInt(g[1]);0<h&&18>h&&0<g&&5>g&&(e.push(3),e.push(h),e.push(1<<g-1))}else h=parseInt(g),"0"==g?e.push(1):(e.push(3),e.push(h),e.push(31));1<e.length&&this._sendMessage(d,1,e)}else"n26shutterfunction"==b.type.toLowerCase()&&(e="up"==a?[1,2]:"down"==a?[2,2]:"angle"==a?[3,2]:"stop"==a?[4,2]:[0,2],"A"==b.data?e.push(1):"D"==b.data&&e.push(2),2<e.length&&this._sendMessage(d,1,e))}};
xnm.aio.mbus.Handler=function(){var b=function(){};b.prototype.MediolaBus=xnm.aio.mbus.MediolaBus;return b}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mbus.Handler);
