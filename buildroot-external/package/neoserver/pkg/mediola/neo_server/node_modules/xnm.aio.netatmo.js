var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.netatmo=xnm.aio.netatmo||{};
xnm.aio.netatmo.Cloud=function(){var y={},p={},a={},f={},c=function(b){return b.refreshToken?b.refreshToken:b.user?p[b.user]:null},l=function(b){var e=c(b);if(!e)return null;y[e]||(y[e]={cloud:b});return y[e].cred?y[e].cred:{refresh_token:e}},h=function(b,e){var g=e.refresh_token;b.refreshToken||(b.refreshToken=g);b.user&&(p[b.user]=g);y[g]||(y[g]={cloud:b});y[g].cred=e;e.expires_in&&(e._expireTime=(new Date).getTime()+1E3*e.expires_in-6E5)},d=function(b){return(b=l(b))&&b._expireTime?(new Date).getTime()>
b._expireTime:!1},k=function(b){var e=c(b);if(!e)return null;y[e]||(y[e]={cloud:b});y[e].weather||(y[e].weather={updateData:{running:!1,error:null}});return y[e].weather},m=function(b){b=k(b);b.timer&&clearTimeout(b.timer);b.updateData={running:!0,error:null}},r=function(b,e,g){var q=c(b),n=k(b);n.updateData={running:!1,error:e};try{if(!e&&g){var t=require("xnm.aio.netatmo.js")._updateListener;if(t&&0<t.length)for(var v=0;v<t.length;v++)t[v]&&t[v].updateWeather&&t[v].updateWeather(b,n.data,g)}}catch(x){}n.timer&&
clearTimeout(n.timer);t=w(b);e?n.data=null:g&&(n.data=g);g=n.tmpCBs;n.tmpCBs=[];if(g)for(v=0;v<g.length;v++)if(e)g[v](e);else b.getWeatherStatus(g[v]);e?n.timer=setTimeout(function(){y[q].cloud.getStationsData(null)},6E4):(b=w(b),t&&b&&t==b&&1>n.retry?(n.retry=n.retry?n.retry+1:1,e=60*n.retry,n.delay=e,n.timer=setTimeout(function(){y[q].cloud.getStationsData(null)},1E3*e)):(n.retry=0,(t=n.delay)||(t=0),e=6E5,b&&(g=Math.round((new Date).getTime()/1E3),g>b&&(e=600-(g-b)%600+30)),require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud").log("debug",
"weather station next poll in t:"+e/60+" min delay:"+t),n.timer=setTimeout(function(){y[q].cloud.getStationsData(null)},1E3*e+1E3*t)))},w=function(b){b=k(b);if(!b.data)return 0;for(var e=0;e<b.data.length;e++)if(b.data[e]&&b.data[e].dashboard_data&&b.data[e].dashboard_data.time_utc)return b.data[e].dashboard_data.time_utc;return 0},C=function(b){var e=c(b);if(!e)return null;y[e]||(y[e]={cloud:b});y[e].homecoach||(y[e].homecoach={updateData:{running:!1,error:null}});return y[e].homecoach},D=function(b){b=
C(b);b.timer&&clearTimeout(b.timer);b.updateData={running:!0,error:null}},B=function(b,e,g){var q=c(b),n=C(b);n.updateData={running:!1,error:e};try{if(!e&&g){var t=require("xnm.aio.netatmo.js")._updateListener;if(t&&0<t.length)for(var v=0;v<t.length;v++)t[v]&&t[v].updateHomeCoach&&t[v].updateHomeCoach(b,n.data,g)}}catch(x){}n.timer&&clearTimeout(n.timer);t=F(b);e?n.data=null:g&&(n.data=g);g=n.tmpCBs;n.tmpCBs=[];if(g)for(v=0;v<g.length;v++)if(e)g[v](e);else b.getWeatherStatus(g[v]);e?n.timer=setTimeout(function(){y[q].cloud.getHomeCoachsData(null)},
6E4):(b=F(b),t&&b&&t==b&&1>n.retry?(n.retry=n.retry?n.retry+1:1,e=60*n.retry,n.delay=e,n.timer=setTimeout(function(){y[q].cloud.getHomeCoachsData(null)},1E3*e)):(n.retry=0,(t=n.delay)||(t=0),e=6E5,b&&(g=Math.round((new Date).getTime()/1E3),g>b&&(e=600-(g-b)%600+30)),n.timer=setTimeout(function(){y[q].cloud.getHomeCoachsData(null)},1E3*e+1E3*t)))},F=function(b){b=C(b);if(!b.data)return 0;for(var e=0;e<b.data.length;e++)if(b.data[e]&&b.data[e].dashboard_data&&b.data[e].dashboard_data.time_utc)return b.data[e].dashboard_data.time_utc;
return 0},G=function(b){var e=c(b);if(!e)return null;y[e]||(y[e]={cloud:b});y[e].thermo||(y[e].thermo={updateData:{running:!1,error:null}});return y[e].thermo},K=function(b){b=G(b);b.timer&&clearTimeout(b.timer);b.updateData={running:!0,error:null}},M=function(b,e,g){var q=c(b),n=G(b);try{if(!e&&g){var t=require("xnm.aio.netatmo.js")._updateListener;if(t&&0<t.length)for(var v=0;v<t.length;v++)t[v]&&t[v].updateThermo&&t[v].updateThermo(b,n.data,g)}}catch(x){}n.timer&&clearTimeout(n.timer);n.updateData=
{running:!1,error:e};e?n.data=null:g&&(n.data=g);g=n.tmpCBs;n.tmpCBs=[];if(g)for(t=0;t<g.length;t++)if(e)g[t](e);else b.getThermoStatus(g[t]);n.timer=e?setTimeout(function(){y[q].cloud.getThermostatsData(null)},6E4):setTimeout(function(){y[q].cloud.getThermostatsData(null)},18E5)},N=function(b,e){var g=c(b);if(!e.module)return 60;b=G(b);b.duration||(y[g].thermo.duration={});g=b.duration[e.module];if(!g){a:{if(e.module&&XC&&XC.localStorage){if(g=XC.localStorage.getItem("netatmo"))try{g=JSON.parse(g)}catch(q){}if(g&&
g.duration){g=g.duration[e.module];break a}}g=null}b.duration[e.module]=g}g||(g=60);return g},O=function(b,e,g){b=G(b);b.duration||(b.duration={});if(e.module&&(b.duration[e.module]=g,e.module&&XC&&XC.localStorage)){if(b=XC.localStorage.getItem("netatmo"))try{b=JSON.parse(b)}catch(q){}b&&"object"==typeof b||(b={});b.duration||(b.duration={});b.duration[e.module]=g;XC.localStorage.setItem("netatmo",JSON.stringify(b))}},P=function(b,e){b=G(b);if(b.data)for(var g=0;g<b.data.length;g++){var q=b.data[g];
if(q&&q._id==e.address&&q.modules)for(var n=0;n<q.modules.length;n++){var t=q.modules[n];if(t&&t._id==e.module)return t.setpoint}}return null},E=function(b,e,g){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud");this.user=b;this.password=e;this.refreshToken=g;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._scopeFallback="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence".split(" ")};
E.prototype.executeCommandCreator=function(b,e,g){if(e&&e.value){var q=this,n={},t=N(this,b);P(this,b);switch(e.value){case "thermoAuto":n.setpoint_mode="program";break;case "thermoAway":n.setpoint_mode="away";break;case "thermoHg":n.setpoint_mode="hg";break;case "thermoOff":n.setpoint_mode="off";break;case "thermoMax":n.setpoint_mode="max";n.setpoint_endtime=Math.round(((new Date).getTime()+6E4*t)/1E3);break;case "thermoManu":if(null==e.ext||"undefined"==typeof e.ext){g&&g(Error("command ext invalid"));
return}var v=e.ext;"string"==typeof e.ext&&(v=parseFloat(e.ext));5.5>v&&(v=5.5);30<v&&(v=30);n.setpoint_mode="manual";n.setpoint_endtime=Math.round(((new Date).getTime()+6E4*t)/1E3);n.setpoint_temp=v;break;case "tempDuration":if(null==e.ext||"undefined"==typeof e.ext){g&&g(Error("command ext invalid"));return}t=e.ext;"string"==typeof e.ext&&(t=parseFloat(e.ext));15>t&&(t=15);720<t&&(t=720);O(this,b,t);g&&g();return;default:g&&g(Error("unknow command"))}this.setThermPoint(b,n,function(x){if(x)g&&g(x);
else{x=G(q);x.data||(x.data=[]);var z;for(z=0;z<x.data.length;z++)if(x.data[z]&&x.data[z]._id==b.address){var u=x.data[z];break}u||(u={_id:b.address,modules:[]},x.data.push(u));for(z=0;z<u.modules.length;z++)if(u.modules[z]&&u.modules[z]._id==b.module){var A=u.modules[z];break}A||(A={_id:b.module},u.modules.push(A));A.setpoint=n;g&&g()}})}else g&&g(Error("command format invalid"))};E.prototype.getStatesCreator=function(b,e,g){e?this.getAllStatus(function(q,n){for(var t=[],v=0;v<e.length;v++){var x=
e[v];if(x.id){var z,u="?";if(!q&&n&&x.device&&x.device.type&&(z="NAMain"==x.device.type||"NHC"==x.device.type?x.device.address:x.device.address+"|"+x.device.module)&&x.status&&x.status.value&&(z=n[z]))if("tempFelt"==x.status.value)u=z.temp,z=z.hum,u="undefined"!=typeof u&&"undefined"!=typeof z?"NHC"==x.device.type?xnm.aio.netatmo.DM.calcFeltTemp(u,z,f):xnm.aio.netatmo.DM.calcFeltTemp(u,z,a):"?";else if("winDName"==x.status.value)u=z.winD,null===u||"undefined"==typeof u?u="?":(u=Number(u),u=isNaN(u)?
"?":23<u&&68>=u?"NO":68<u&&113>=u?"O":113<u&&158>=u?"SO":158<u&&203>=u?"S":203<u&&248>=u?"SW":248<u&&293>=u?"W":293<u&&338>=u?"NW":"N");else if(u=z[x.status.value],null==u||"undefined"==typeof u)u="?";t.push({id:x.id,status:u})}}g&&g(null,t)}):g&&g(Error("deviceList is null"))};E.prototype.getAllStatus=function(b){var e=this,g={};this.getWeatherStatus(function(q,n){q?b&&b(q):e.getThermoStatus(function(t,v){t?b&&b(t):e.getHomeCoachStatus(function(x,z){if(x)b&&b(x);else{for(var u in n)n.hasOwnProperty(u)&&
(g[u]=n[u]);for(u in v)v.hasOwnProperty(u)&&(g[u]=v[u]);for(u in z)z.hasOwnProperty(u)&&(g[u]=z[u]);b&&b(null,g)}})})})};E.prototype.getDeviceList=function(b){var e=this;this.getStationsData(function(g,q){g?b&&b(g):e.getThermostatsData(function(n,t){n?b&&b(n):e.getHomeCoachsData(function(v,x){if(v)b&&b(v);else{v={weather:[],thermostat:[]};if(q){for(var z=[],u=0;u<q.length;u++){var A=q[u];if(A&&A._id&&A.type){var H=A.station_name,I=A.module_name,J={address:A._id,type:A.type,name:H+" ("+I+")"};J.dashboard_data=
A.dashboard_data;J.modules=[];if(A.modules)for(var L=0;L<A.modules.length;L++)A.modules[L]&&A.modules[L]._id&&A.modules[L].type&&(I=A.modules[L].module_name,J.modules.push({address:A._id,module:A.modules[L]._id,type:A.modules[L].type,name:H+" ("+I+")",dashboard_data:A.modules[L].dashboard_data}));z.push(J)}}v.weather=z}if(t){z=[];for(u=0;u<t.length;u++)if((A=t[u])&&A._id&&A.type&&(H=A.station_name,A.modules))for(J=0;J<A.modules.length;J++)A.modules[J]&&A.modules[J]._id&&A.modules[J].type&&(I=A.modules[J].module_name,
z.push({address:A._id,module:A.modules[J]._id,type:A.modules[J].type,name:H+" ("+I+")"}));v.thermostat=z}if(x){z=[];for(u=0;u<x.length;u++)(A=x[u])&&A._id&&A.type&&(H=A.module_name,I={address:A._id,type:A.type,name:A.name},H&&(I.name+=" ("+H+")"),I.dashboard_data=A.dashboard_data,I.modules=[],z.push(I));v.homecoach=z}b&&b(null,v)}})})})};E.prototype.getCamList=function(b){var e=this;this.getCamsData(function(g,q){if(g)b&&b(g);else{g={cam:[]};if(q){for(var n=[],t=0;t<q.length;t++)if(q[t]&&q[t].id){var v=
q[t].name,x=q[t].cameras;if(x)for(var z=0;z<x.length;z++)if(x[z]&&x[z].id){var u="welcome";"NACamera"==x[z].type?u="welcome":"NOC"==x[z].type&&(u="presence");u&&(u={sys:"cam",type:"system",manufacturer:"netatmo",model:u,address:x[z].id},x[z].name&&(u.name=x[z].name+(v?" ("+v+")":"")),n.push(u))}}g.cam=n}q=l(e);if(g.cam&&0<g.cam.length)for(n=0;n<g.cam.length;n++)g.cam[n].refreshToken=q.refresh_token;b&&b(null,g)}})};E.prototype.getWeatherStatus=function(b){var e=function(t,v){var x={};if(v)for(var z=
0;z<v.length;z++){var u=v[z];if(u&&u._id){var A=t._resolveStationStatus(u);A&&(x[u._id]=A);if(u.modules)for(var H=0;H<u.modules.length;H++)(A=t._resolveModuleStatus(u.modules[H]))&&(x[u._id+"|"+u.modules[H]._id]=A)}}return x};this._logger.log("debug","getWeatherStatus");var g=k(this),q=this,n=b;b=null;g&&g.data?(b=e(this,g.data),n&&n(null,b),n=null):this.getStationsData(function(t){t?(n&&n(t),n=null):n&&q.getWeatherStatus(n)})};E.prototype.getHomeCoachStatus=function(b){var e=function(t,v){var x=
{};if(v)for(var z=0;z<v.length;z++){var u=v[z];if(u&&u._id){var A=t._resolveHomeCoachStatus(u);A&&(x[u._id]=A)}}return x};this._logger.log("debug","getHomeCoachStatus");var g=C(this),q=this,n=b;b=null;g&&g.data?(b=e(this,g.data),n&&n(null,b),n=null):this.getHomeCoachsData(function(t){t?(n&&n(t),n=null):n&&q.getHomeCoachStatus(n)})};E.prototype.getThermoStatus=function(b){var e=function(v,x){for(var z={},u=0;u<x.length;u++){var A=x[u];if(A&&A._id&&A.modules)for(var H=0;H<A.modules.length;H++){var I=
v._resolveModuleStatus(A.modules[H]);I&&(z[A._id+"|"+A.modules[H]._id]=I)}}return z},g=G(this),q=this,n=b,t=null;g.updateData.running?(g.tmpCBs||(g.tmpCBs=[]),g.tmpCBs.push(b)):g.data?(t=e(this,g.data),n&&n(null,t),n=null):this.getThermostatsData(function(v){v?(n&&n(v),n=null):n&&q.getThermoStatus(n)})};E.prototype.getCamUrl=function(b,e){var g=this;this._refreshToken(this.refreshToken,function(q,n){if(q)n&&n.error&&(q=Error(n.error),q._code="auth_error"),e&&e(q);else{if(n&&n.access_token)var t=n.access_token;
t?n&&n.scope&&-1==n.scope.indexOf("access_camera")?e&&e(null,"scop_error"):g._getCamsData(t,function(v,x){if(v)x&&x.error&&(v=Error(x.error),v._code="api_error"),e&&e(v);else if(v=null,x.body&&x.body.homes&&(v=x.body.homes),v){for(x=0;x<v.length;x++)if(v[x]&&v[x].cameras){for(var z=v[x].cameras,u=0;u<z.length;u++)if(z[u]&&z[u].id==b&&z[u].vpn_url){var A=z[u];break}if(A)break}A?1==A.is_local?g._getLocalCamUrl(A.vpn_url,function(H,I){e&&e(H,I)}):e&&e(null,A.vpn_url+"/live/index.m3u8"):e&&e("no cam with address:"+
b)}else e&&e("get cams data reponse invalid")}):e&&e(Error("auth response invalid"))}})};E.prototype._resolveStationStatus=function(b){var e={};null!=b.wifi_status&&"undefined"!=typeof b.wifi_status&&(e.wifi=b.wifi_status,e.wifiStatus=86<=e.wifi?"bad":71<=e.wifi?"middle":56<=e.wifi?"good":"very_good");if(b.dashboard_data&&(b=this._resolveDashboard(b.dashboard_data)))for(var g in b)b.hasOwnProperty(g)&&(e[g]=b[g]);return e};E.prototype._resolveModuleStatus=function(b){var e={};null!=b.rf_status&&"undefined"!=
typeof b.rf_status&&(e.rf=b.rf_status,e.rfStatus=90<=e.rf?"very_low":80<=e.rf?"low":70<=e.rf?"medium":60<=e.rf?"high":"full");if(null!=b.battery_vp&&"undefined"!=typeof b.battery_vp)switch(e.bat=b.battery_vp,b.type){case "NAModule4":e.batStatus=5640<=e.bat?"full":5280<=e.bat?"high":4920<=e.bat?"medium":4560<=e.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":e.batStatus=5500<=e.bat?"full":5E3<=e.bat?"high":4500<=e.bat?"medium":4E3<=e.bat?"low":"very_low";break;case "NAModule2":e.batStatus=
5900<=e.bat?"full":5180<=e.bat?"high":4770<=e.bat?"medium":4360<=e.bat?"low":"very_low";break;case "NATherm1":e.batStatus=4100<=e.bat?"full":3600<=e.bat?"high":3300<=e.bat?"medium":3E3<=e.bat?"low":"very_low"}var g,q;if("NATherm1"==b.type&&(g=this._resolveThermoStat(b)))for(q in g)g.hasOwnProperty(q)&&(e[q]=g[q]);if(b.dashboard_data&&(g=this._resolveDashboard(b.dashboard_data)))for(q in g)g.hasOwnProperty(q)&&(e[q]=g[q]);return e};E.prototype._resolveHomeCoachStatus=function(b){var e={};null!=b.wifi_status&&
"undefined"!=typeof b.wifi_status&&(e.wifi=b.wifi_status,e.wifiStatus=86<=e.wifi?"bad":71<=e.wifi?"middle":56<=e.wifi?"good":"very_good");if(b.dashboard_data&&(b=this._resolveDashboard(b.dashboard_data)))for(var g in b)b.hasOwnProperty(g)&&(e[g]=b[g]);return e};E.prototype._resolveThermoStat=function(b){var e={};if(b.setpoint){switch(b.setpoint.setpoint_mode){case "program":var g="auto";break;case "away":g="away";break;case "hg":g="frost-guard";break;case "manual":g="manu";break;case "off":g="off";
break;case "max":g="boost"}g&&(e.mode=g);null!=b.setpoint.setpoint_temp&&"undefined"!=typeof b.setpoint.setpoint_temp&&(e.manuT=b.setpoint.setpoint_temp);if(null!=b.setpoint.setpoint_endtime&&"undefined"!=typeof b.setpoint.setpoint_endtime)if(e.tempEnd=b.setpoint.setpoint_endtime,e.tempEndStr=(new Date(1E3*b.setpoint.setpoint_endtime)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{e.tempEndStr=dateFormat(e.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(q){}else e.tempEndStr=e.tempEndStr.toLocaleString()}b.measured&&
(null!=b.measured.time&&"undefined"!=typeof b.measured.time&&(e.mesureT=b.measured.time),null!=b.measured.temperature&&"undefined"!=typeof b.measured.temperature&&(e.currentTemp=b.measured.temperature));e.tempDuration=N(this,{module:b._id});return e};E.prototype._resolveDashboard=function(b){var e=function(n,t){return null!=n[t]&&"undefined"!=typeof n[t]},g={};e(b,"AbsolutePressure")&&(g.absPres=b.AbsolutePressure);e(b,"CO2")&&(g.co2=b.CO2);e(b,"Humidity")&&(g.hum=b.Humidity);e(b,"Noise")&&(g.noise=
b.Noise);e(b,"Pressure")&&(g.pres=b.Pressure);e(b,"Rain")&&(g.rain=b.Rain);e(b,"sum_rain_1")&&(g.rain1h=b.sum_rain_1);e(b,"sum_rain_24")&&(g.rain24h=b.sum_rain_24);e(b,"Temperature")&&(g.temp=b.Temperature);if(e(b,"date_max_temp")){g.timeMaxTemp=b.date_max_temp;var q=1E3*b.date_max_temp;g.timeMaxTempStr=new Date(q);g.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(g.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):g.timeMaxTempStr.toLocaleString()}e(b,"date_min_temp")&&(g.timeMinTemp=b.date_min_temp,
q=1E3*b.date_min_temp,g.timeMinTempStr=new Date(q),g.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(g.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):g.timeMinTempStr.toLocaleString());e(b,"max_temp")&&(g.maxTemp=b.max_temp);e(b,"min_temp")&&(g.minTemp=b.min_temp);e(b,"WindAngle")&&(g.winD=b.WindAngle);e(b,"WindStrength")&&(g.winS=b.WindStrength);e(b,"GustAngle")&&(g.gwinD=b.GustAngle);e(b,"GustStrength")&&(g.gwinS=b.GustStrength);e(b,"time_utc")&&(g.mesureT=b.time_utc,q=1E3*b.time_utc,
g.mesureTStr=new Date(q),g.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(g.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):g.mesureTStr.toLocaleString());e(b,"date_max_wind_str")&&(g.timeMaxWind=b.date_max_wind_str,q=1E3*b.date_max_wind_str,g.timeMaxWindStr=new Date(q),g.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(g.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):g.timeMaxWindStr.toLocaleString());e(b,"max_wind_angle")&&(g.maxWinD=b.max_wind_angle);e(b,"max_wind_str")&&(g.maxWinS=
b.max_wind_str);e(b,"temp_trend")&&(g.tempTrend=b.temp_trend);e(b,"pressure_trend")&&(g.presTrend=b.pressure_trend);if(e(b,"health_idx"))switch(g.healthIdxLvl=b.health_idx,parseInt(g.healthIdx)){case 0:g.healthIdx="healthy";break;case 1:g.healthIdx="fine";break;case 2:g.healthIdx="fair";break;case 3:g.healthIdx="poor";break;case 4:g.healthIdx="unhealthy"}return g};E.prototype.auth=function(b){this._logger.log("debug","auth");var e=l(this),g=this;e?e.access_token?d(this)?this._refreshToken(e.refresh_token,
function(q,n){q?(n&&n.error&&(q=Error(n.error),q._code="refresh_token_error"),b&&b(q)):(h(g,n),b&&b(null,n))}):b&&b(null,e):this._refreshToken(e.refresh_token,function(q,n){q?(n&&n.error&&(q=Error(n.error),q._code="refresh_token_error"),b&&b(q)):(h(g,n),b&&b(null,n))}):this._auth(this._scope.join(" "),function(q,n){if(q){if(n)try{if(n=JSON.parse(n),n.error&&(q=Error(n.error),q._code="auth_error","invalid_request"==n.error&&-1!=g._scope.indexOf("access_presence"))){g._scope=g._scopeFallback;g.auth(b);
return}}catch(t){}b&&b(q)}else h(g,n),b&&b(null,n)})};E.prototype.setThermPoint=function(b,e,g){if(b&&b.address&&b.module)if(e&&e.setpoint_mode)if("max"!=e.setpoint_mode||e.setpoint_endtime)if("manual"!=e.setpoint_mode||e.setpoint_endtime&&e.setpoint_temp){var q=this;this.auth(function(n){n?g&&g(n):q._setThermPoint(l(q).access_token,b.address,b.module,e.setpoint_mode,e.setpoint_endtime,e.setpoint_temp,function(t,v){t?(v&&v.error&&(t=Error(v.error),t._code="api_error"),g&&g(t)):g&&g(null,v)})})}else g&&
g(Error("param format invalid"));else g&&g(Error("param format invalid"));else g&&g(Error("param format invalid"));else g&&g(Error("device format invalid"))};E.prototype.getStationsData=function(b){this._logger.log("debug","getStationsData");var e=this;this.auth(function(g){g?b&&b(g):(g=k(e))&&g.updateData&&g.updateData.running?(g.tmpCBs||(g.tmpCBs=[]),g.tmpCBs.push(b)):(m(e),e._getStationsData(l(e).access_token,null,function(q,n){q?(n&&n.error&&(q=Error(n.error),q._code="api_error"),r(e,q,null),
b&&b(q)):(q=null,n.body&&n.body.devices&&(q=n.body.devices),n.body&&n.body.user&&n.body.user.administrative&&(a=n.body.user.administrative),r(e,null,q),b&&b(null,q))}))})};E.prototype.getThermostatsData=function(b){var e=this;this.auth(function(g){g?b&&b(g):(g=G(this))&&g.updateData&&g.updateData.running?(g.tmpCBs||(g.tmpCBs=[]),g.tmpCBs.push(b)):(K(e),e._getThermostatsData(l(e).access_token,null,function(q,n){q?(n&&n.error&&(q=Error(n.error),q._code="api_error"),M(e,q,null),b&&b(q)):(q=null,n.body&&
n.body.devices&&(q=n.body.devices),M(e,null,q),b&&b(null,q))}))})};E.prototype.getHomeCoachsData=function(b){this._logger.log("debug","getHomeCoachsData");var e=this;this.auth(function(g){g?b&&b(g):(g=C(this))&&g.updateData&&g.updateData.running?(g.tmpCBs||(g.tmpCBs=[]),g.tmpCBs.push(b)):(D(e),e._getHomeCoachsData(l(e).access_token,null,function(q,n){q?(n&&n.error&&(q=Error(n.error),q._code="api_error"),B(e,q,null),b&&b(q)):(q=null,n.body&&n.body.devices&&(q=n.body.devices),n.body&&n.body.user&&n.body.user.administrative&&
(f=n.body.user.administrative),B(e,null,q),b&&b(null,q))}))})};E.prototype.getCamsData=function(b){this._logger.log("debug","getCamsData");var e=this;this.auth(function(g){g?b&&b(g):e._getCamsData(l(e).access_token,function(q,n){q?(n&&n.error&&(q=Error(n.error),q._code="api_error"),b&&b(q)):(q=null,n.body&&n.body.homes&&(q=n.body.homes),b&&b(null,q))})})};E.prototype._auth=function(b,e){this._logger.log("trace","_auth");this._doRequest("POST","/oauth2/token",{grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",
client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.user,password:this.password,scope:b},e)};E.prototype._refreshToken=function(b,e){this._logger.log("trace","_refreshToken");this._doRequest("POST","/oauth2/token",{grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:b},e)};E.prototype._setThermPoint=function(b,e,g,q,n,t,v){b={access_token:b,device_id:e,module_id:g,setpoint_mode:q};n&&(b.setpoint_endtime=
n);t&&(b.setpoint_temp=t);this._doRequest("GET","/api/setthermpoint",b,v)};E.prototype._getStationsData=function(b,e,g){this._logger.log("debug","_getStationsData");b={access_token:b};e&&(b.device_id=e);this._doRequest("GET","/api/getstationsdata",b,g)};E.prototype._getHomeCoachsData=function(b,e,g){this._logger.log("debug","_getHomeCoachsData");b={access_token:b};e&&(b.device_id=e);this._doRequest("GET","/api/gethomecoachsdata",b,g)};E.prototype._getThermostatsData=function(b,e,g){b={access_token:b};
e&&(b.device_id=e);this._doRequest("GET","/api/getthermostatsdata",b,g)};E.prototype._getCamsData=function(b,e){this._doRequest("GET","/api/gethomedata",{access_token:b},e)};E.prototype._getLocalCamUrl=function(b,e){var g=this;this._logger.log("trace","ping cam "+b);this._doUrlRequest("get",b+"/command/ping",null,function(q,n){!q&&n&&n.local_url?g._doUrlRequest("get",n.local_url+"/command/ping",null,function(t,v){t||!v||v.local_url!=n.local_url?e&&e(null,b+"/live/index.m3u8"):e&&e(null,v.local_url+
"/live/index.m3u8")}):e&&e(null,b+"/live/index.m3u8")})};E.prototype._doRequest=function(b,e,g,q){this._doUrlRequest(b,"https://api.netatmo.net"+e,g,q)};E.prototype._doUrlRequest=function(b,e,g,q){var n=this,t=q,v=null;try{v=JSON.parse(JSON.stringify(g)),v.username&&(v.username="xxxxxx"),v.password&&(v.password="xxxxxx")}catch(x){v=g}this._logger.log("trace","send "+b+" req to:"+e+" data:"+JSON.stringify(v));$.ajax({url:e,type:b,timeout:1E4,dataType:"json",data:g,cache:!1,success:function(x){n._logger.log("trace",
"http request success:"+JSON.stringify(x));q&&q(null,x)},error:function(x,z,u){z="http request error:"+(x?x.status:"0")+"-"+z;n._logger.log("warn","http request error:"+z);z=Error(z);u&&(n._logger.log("warn","http request http error:"+u),z.httpError=!0,z.statusCode=x?x.status:0);t&&(t(z,x?x.responseText:null),t=null)}})};E.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.user,password:this.password}};E.prototype.equalsTo=function(b){return b&&b instanceof E?this.user==b.user&&
this.password==b.password:!1};E.pause=function(b){for(var e in y)if(y.hasOwnProperty(e)){var g=y[e];g&&g.weather&&g.weather.timer&&clearTimeout(g.weather.timer);g&&g.thermo&&g.thermo.timer&&clearInterval(g.thermo.timer)}y={};b&&b()};return E}();
xnm.aio.netatmo.MNetatmo=function(){var y=function(p){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.MNetatmo");this._interval=0;this._on={};this._updateInterval=12E4;this._url=null;this._username=p?p.username:null;this._password=p?p.password:null;this._basicAuth=p?p.basicAuth:null};y.CLOUD_URL="cloud.mediola.com";y.prototype={_doUpdate:function(p){var a=this;APP.isInDemoMode||this.getStates(null,function(f,c){if(c&&c.XC_SUC){XC.debugf("[MNetatmo] Received update.");for(var l in c.XC_SUC){f=
c.XC_SUC[l];for(var h in f){var d=f[h],k=l+"_"+h;if(d.states)for(var m in d.states)CommandHandler.setState(k+":"+m,d.states[m],!0)}}p&&p();if(Array.isArray(a._on.update))for(c={type:"update"},l=0;l<a._on.update.length;l++)(h=a._on.update[l])&&h(c)}})},_sendRequest:function(p,a){"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var f=require("https"),c=this._getURL();c=c.replace("https://","");p={host:c,method:"GET",path:p||"/",headers:{}};(c=this._getBasicAuthHeader())&&
(p.headers.Authorization=c);var l=this,h=a,d=f.request(p,function(k){k.setEncoding("utf-8");var m="";k.on("data",function(r){m+=r});k.on("end",function(){l._logger.log("trace","http reponse:"+m+" statusCode:"+k.statusCode);if(200!=k.statusCode)h&&h(Error("http response with code:"+k.statusCode),null);else try{var r=JSON.parse(m);r&&r.XC_SUC?h&&h(null,r.XC_SUC):r&&r.XC_ERR?h&&h(Error(r.XC_ERR.msg)):h&&h(Error("http reponse format valid"));h=null}catch(w){l._logger.log("trace","http reponse is not valid json:"+
w.message),h&&h(w,null),h=null}})});d.setTimeout(1E4,function(){l._logger.log("trace","http request timeout");d.abort();h&&h(Error("http timeout"));h=null});d.on("error",function(k){l._logger.log("trace","http request error:"+k.message);h&&h(k);h=null});d.end()},_getURL:function(){return this._url?this._url:y.CLOUD_URL},_getBasicAuthHeader:function(){return this._basicAuth?this._basicAuth:this._username?"Basic "+(new Buffer(this._username+":"+(this._password?this._password:""))).toString("base64"):
null},_getStates:function(p){this._sendRequest("/netatmo/getStates",p)},addEventListener:function(p,a){this._on[p]||(this._on[p]=[]);this._on[p].push(a)},setUrl:function(p){this._url=p},getDevices:function(p){this._sendRequest("/netatmo/getDevices",p)},getStates:function(p,a,f){this._getStates(function(c,l){if(c)f&&f(null);else if(a){c={};for(var h in l){var d=l[h];if(d)for(var k in d)if(a&&a.address==k){var m=d[k];if(m&&m.states){c=m.states;break}}}if(p)for(var r in c)p.setState(a.id+":"+r,c[r]);
f&&f(c)}else f&&f(l)})},removeEventListener:function(p,a){if(this._on[p])for(var f=0;f<this._on[p].length;f++)if(this._on[p][f]===a){this._on[p].splice(f,1);break}},startUpdating:function(p){if(!this._interval)if(APP.isInDemoMode)XC.debugf("[MNetatmo.startUpdating] Ignored. App is in demo mode.");else{var a=this;XC.debugf("[MNetatmo.startUpdating] Start.");this._doUpdate();this._interval=setInterval(function(){a._doUpdate()},this._updateInterval)}},stopUpdating:function(){clearInterval(this._interval);
XC.debugf("[MNetatmo.stopUpdating] Stop.")}};return y}();
xnm.aio.netatmo.Client=function(){var y=function(){var a=function(){this._homes={};this._weather={};this._thermo={};this._coach={};this._states={};this._smartThermoDuraion={}};a.prototype.getStates=function(){return this._states};a.prototype.areStatesExpired=function(){var f={weather:!1,thermo:!1,coach:!1,hasWeatherDevice:!1,hasThermoDevice:!1,hasCoachDevice:!1};this._homes.lastReqTime?this._homes.lastReqOk?(f.weather=!(!this._homes.weather||!this._homes.weather.length),f.hasWeatherDevice=f.weather,
f.thermo=!(!this._homes.thermo||!this._homes.thermo.length),f.hasThermoDevice=f.thermo):300<Math.round((new Date).getTime()/1E3)-this._homes.lastReqTime&&(f.weather=!0,f.thermo=!0):(f.weather=!0,f.thermo=!0);this._coach&&(f.coach=!0);f.weather&&(f.weather=this._isWeatherExpired());f.thermo&&(f.thermo=this._isThermoExpired());f.coach&&(f.coach=this._isCoachExpired());return f};a.prototype._isWeatherExpired=function(){if(!this._weather.lastReqTime)return!0;var f=Math.round((new Date).getTime()/1E3);
return this._weather.lastReqOk?this._weather.weatherTimeChanged?this._weather.expired:660<f-this._weather.lastReqTime?!0:!1:300<f-this._weather.lastReqTime?!0:!1};a.prototype._isThermoExpired=function(){if(!this._thermo.lastReqTime)return!0;var f=Math.round((new Date).getTime()/1E3);return this._thermo.lastReqOk?660<f-this._thermo.lastReqTime?!0:!1:300<f-this._thermo.lastReqTime?!0:!1};a.prototype._isCoachExpired=function(){if(!this._coach.lastReqTime)return!0;var f=Math.round((new Date).getTime()/
1E3);return this._coach.lastReqOk?this._coach.coachTimeChanged?this._coach.expired:660<f-this._coach.lastReqTime?!0:!1:300<f-this._coach.lastReqTime?!0:!1};a.prototype.updateReqTime=function(f,c){switch(f){case "weather":this._weather.lastReqTime=c;break;case "thermo":this._thermo.lastReqTime=c;break;case "coach":this._coach.lastReqTime=c;break;case "homes":this._homes.lastReqTime=c}};a.prototype.updateReqOK=function(f,c){switch(f){case "weather":this._weather.lastReqOk=c;break;case "thermo":this._thermo.lastReqOk=
c;break;case "coach":this._coach.lastReqOk=c;break;case "homes":this._homes.lastReqOk=c}};a.prototype.updateHomesInfo=function(f,c){if(f&&c){this._homes.weather=c.weather;this._homes.thermo=c.thermo;this._homes.coach=c.coach;for(var l in f)this._states[l]=f[l]}};a.prototype.updateWeatherStatus=function(f,c,l){if(f&&c&&l){var h=this._weather.weatherTime;this._weather.weatherTime=c;this._weather.weatherTimeChanged=c!=h;this._weather.expired=660<l-c;if(!this._weather.expired){this._weather.expireTo&&
clearTimeout(this._weather.expireTo);var d=this;this._weather.expireTo=setTimeout(function(){d._weather.expired=!0},1E3*(c+660-l))}for(var k in f)this._states[k]=f[k]}};a.prototype.updateThermoStatus=function(f){if(f)for(var c in f)this._states[c]=f[c]};a.prototype.updateCoachStatus=function(f,c,l){if(f&&c&&l){var h=this._coach.coachTime;this._coach.coachTime=c;this._coach.coachTimeChanged=c!=h;this._coach.expired=660<l-c;if(!this._coach.expired){this._coach.expireTo&&clearTimeout(this._coach.expireTo);
var d=this;this._coach.expireTo=setTimeout(function(){d._coach.expired=!0},1E3*(c+660-l))}for(var k in f)this._states[k]=f[k]}};a.prototype.thermoStatusChanged=function(){this._thermo.lastReqTime=null};a.prototype.setSmartThermoDuration=function(f,c){f&&f.module&&(this._smartThermoDuraion[f.module]=c)};a.prototype.getSmartThermoDuration=function(f){if(f&&f.module)return this._smartThermoDuraion[f.module]};return a}(),p=function(a,f,c){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Client");
this.username=a;this.password=f;this.refreshToken=c;this.accessToken=null;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._stateBuffer=new y;this._renewTokenCBs=[];this._getHomesInfoCBs=[];this._getWeatherStatusCBs=[];this._getThermoStatusCBs=[];this._getCoachStatusCBs=[]};p.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.username,password:this.password,refreshToken:this.refreshToken}};
p.prototype.equalsTo=function(a){return a&&a instanceof p?this.refreshToken?this.refreshToken===a.refreshToken:this.user==a.user&&this.password==a.password:!1};p.prototype.executeCommandCreator=function(a,f,c){f&&f.value?"NATherm1"==a.type?this._setSmartThermostat(a,f,function(l){c&&c(l)}):"home"==a.type?this._setHomeThermMode(a,f,function(l){c&&c(l)}):"room"==a.type?this._setRoomTherm(a,f,function(l){c&&c(l)}):c&&c(Error("device has no command")):c&&c(Error("command format invalid"))};p.prototype.getStatesCreator=
function(a,f,c){f?this.getAllStatus(function(l,h){for(var d=[],k=0;k<f.length;k++){var m=f[k];if(m.id){var r,w="?";!l&&h&&m.device&&m.device.type&&(r="NAMain"==m.device.type||"NHC"==m.device.type||"NAPlug"==m.device.type?m.device.address:"room"==m.device.type||"home"==m.device.type?m.device.address:m.device.module)&&m.status&&m.status.value&&(r=h[r])&&(w=r[m.status.value],null==w||"undefined"==typeof w)&&(w="?");d.push({id:m.id,status:w})}}c&&c(null,d)}):c&&c(Error("deviceList is null"))};p.prototype._setHomeThermMode=
function(a,f,c){if(a&&a.address&&"home"==a.type){var l=this;a=a.address;switch(f.value){case "thermoAuto":var h="schedule";break;case "thermoAway":h="away";break;case "thermoAwayUntil":if(!f.ext){c(Error("invalid command"));return}h="away";var d=parseInt(f.ext);break;case "thermoHg":h="hg";break;case "thermoHgUntil":if(!f.ext){c(Error("invalid command"));return}h="hg";d=parseInt(f.ext);break;default:c(Error("unknown command"))}this._setThermMode(a,h,d,null,function(k,m){k?c(k):(l._stateBuffer.thermoStatusChanged(),
c())})}else c(Error("invalid device"))};p.prototype._setRoomTherm=function(a,f,c){if(a&&a.address&&a.homeId&&"room"==a.type){var l=this,h=a.homeId,d=a.address;switch(f.value){case "thermoAuto":var k="home";break;case "thermoManu":if(!f.ext){c(Error("invalid command"));return}k="manual";var m=parseFloat(f.ext);7>m&&(m=7);30<m&&(m=30);break;case "thermoManuUntil":if(!f.ext){c(Error("invalid command"));return}k="manual";for(a=0;a<f.ext.length;a++){var r=f.ext[a];if(r)switch(r.value){case "temp":m=parseFloat(r.ext);
break;case "endtime":var w=parseInt(r.ext)}}if(!m||!w){c(Error("invalid command"));return}7>m&&(m=7);30<m&&(m=30);break;case "thermoUp":case "thermoDown":this.getAllStatus(function(C,D){C?c(C):(C=D?D[d]:null)?(w=C.tempEnd,m=parseFloat(C.manuT),isNaN(m)?c(Error("unknown current room setpoint")):(m="thermoUp"==f.value?m+.5:m-.5,7>m&&(m=7),30<m&&(m=30),k="manual",l._setRoomThermPoint(h,d,k,m,w,function(B,F){B?c(B):(l._stateBuffer.thermoStatusChanged(),c())}))):c(Error("unknown current room status"))});
return;default:c(Error("unknown command"))}this._setRoomThermPoint(h,d,k,m,w,function(C,D){C?c(C):(l._stateBuffer.thermoStatusChanged(),c())})}else c(Error("invalid device"))};p.prototype._setSmartThermostat=function(a,f,c){var l=this,h=this._stateBuffer.getSmartThermoDuration(a);h||(h=60);var d={};switch(f.value){case "thermoAuto":d.setpoint_mode="program";break;case "thermoAway":d.setpoint_mode="away";break;case "thermoHg":d.setpoint_mode="hg";break;case "thermoOff":d.setpoint_mode="off";break;
case "thermoMax":d.setpoint_mode="max";d.setpoint_endtime=Math.round(((new Date).getTime()+6E4*h)/1E3);break;case "thermoManu":if(null==f.ext||"undefined"==typeof f.ext){c&&c(Error("command ext invalid"));return}var k=f.ext;"string"==typeof f.ext&&(k=parseFloat(f.ext));5.5>k&&(k=5.5);30<k&&(k=30);d.setpoint_mode="manual";d.setpoint_endtime=Math.round(((new Date).getTime()+6E4*h)/1E3);d.setpoint_temp=k;break;case "tempDuration":if(null==f.ext||"undefined"==typeof f.ext){c&&c(Error("command ext invalid"));
return}h=f.ext;"string"==typeof f.ext&&(h=parseFloat(f.ext));15>h&&(h=15);720<h&&(h=720);this._stateBuffer.setSmartThermoDuration(a,h);c&&c();return;default:c&&c(Error("unknow command"))}a&&a.address&&a.module?d&&d.setpoint_mode?"max"!=d.setpoint_mode||d.setpoint_endtime?"manual"!=d.setpoint_mode||d.setpoint_endtime&&d.setpoint_temp?this._setThermPoint(a.address,a.module,d.setpoint_mode,d.setpoint_endtime,d.setpoint_temp,function(m,r){m?c&&c(m):(l._stateBuffer.thermoStatusChanged(),c&&c(null,r))}):
c&&c(Error("param format invalid")):c&&c(Error("param format invalid")):c&&c(Error("param format invalid")):c&&c(Error("device format invalid"))};p.prototype.auth=function(a){this._logger.log("debug","auth");this.username&&this.password?this._auth(function(f,c){a&&a(f,c)}):this.refreshToken?this._refreshToken(function(f,c){a&&a(f,c)}):a&&a(Error(""))};p.prototype.getDeviceList=function(a){var f=this,c=[];this._getHomeCoachsData(null,function(l,h){l?f._logger.log("error","getHomeCoachsData error: "+
l.message):h&&Array.isArray(h.devices)&&h.devices.forEach(function(d){var k=d.name||d.type;d.station_name&&(k+=" ("+d.station_name+")");c.push({address:d._id,type:d.type,name:k,room:null,home:null,dashboard_data:d.dashboard_data})});f._getHomesData(null,null,function(d,k){d?0===c.length?a&&a(d):a&&a(null,c):(k&&k.length&&k.forEach(function(m){if(m&&m.modules&&m.modules.length){var r={};m.rooms&&m.rooms.forEach(function(B){r[B.id]={name:B.name,hasThermo:!1}});var w=!1;m.modules.forEach(function(B){if(B&&
B.id&&B.type)switch(B.type){case "NAMain":var F={address:B.id,type:B.type,name:B.name?B.name:null,room:null,home:m.name};B.room_id&&r[B.room_id]&&(F.room=r[B.room_id].name);c.push(F);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":F={module:B.id,address:B.bridge,type:B.type,name:B.name?B.name:null,room:null,home:m.name};B.room_id&&r[B.room_id]&&(F.room=r[B.room_id].name);c.push(F);break;case "NAPlug":w=!0;F={address:B.id,type:B.type,name:B.name?B.name:null,room:null,home:m.name};
B.room_id&&r[B.room_id]&&(F.room=r[B.room_id].name,r[B.room_id].hasThermo=!0);c.push(F);break;case "NATherm1":case "NRV":w=!0;F={address:B.bridge,module:B.id,type:B.type,name:B.name?B.name:null,room:null,home:m.name};B.room_id&&r[B.room_id]&&(F.room=r[B.room_id].name,r[B.room_id].hasThermo=!0);c.push(F);break;case "NHC":F={address:B.id,type:B.type,name:B.name?B.name:m.name,room:null,home:m.name},B.room_id&&r[B.room_id]&&(F.room=r[B.room_id].name),c.push(F)}});for(var C in r){var D=r[C];D.hasThermo&&
c.push({address:C,type:"room",name:D.name,home:m.name,homeId:m.id})}w&&c.push({address:m.id,type:"home",name:m.name})}}),a&&a(null,c))})})};p.prototype.getCamList=function(a){var f=this;this._getHomeData(null,null,function(c,l){if(c)a&&a(c);else{c={cam:[]};if(l){for(var h=[],d=0;d<l.length;d++)if(l[d]&&l[d].id){var k=l[d].name,m=l[d].cameras;if(m)for(var r=0;r<m.length;r++)if(m[r]&&m[r].id){var w="welcome";"NACamera"==m[r].type?w="welcome":"NOC"==m[r].type&&(w="presence");w&&(w={sys:"cam",type:"system",
manufacturer:"netatmo",model:w,address:m[r].id},m[r].name&&(w.name=m[r].name+(k?" ("+k+")":"")),h.push(w))}}c.cam=h}if(c.cam&&0<c.cam.length)for(l=0;l<c.cam.length;l++)c.cam[l].refreshToken=f.refreshToken;a&&a(null,c)}})};p.prototype.getCamUrl=function(a,f){var c=this;this._getHomeData(null,null,function(l,h){if(l)f&&f(l);else if(h){for(l=0;l<h.length;l++)if(h[l]&&h[l].cameras){for(var d=h[l].cameras,k=0;k<d.length;k++)if(d[k]&&d[k].id==a&&d[k].vpn_url){var m=d[k];break}if(m)break}m?1==m.is_local?
c._getLocalCamUrl(m.vpn_url,function(r,w){f&&f(r,w)}):f&&f(null,m.vpn_url+"/live/index.m3u8"):f&&f("no cam with address:"+a)}else f&&f("get cams data reponse invalid")})};p.prototype._getLocalCamUrl=function(a,f){var c=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(l,h){!l&&h&&h.local_url?c._doUrlRequest("get",h.local_url+"/command/ping",null,function(d,k){d||!k||k.local_url!=h.local_url?f&&f(null,a+"/live/index.m3u8"):f&&f(null,k.local_url+"/live/index.m3u8")}):
f&&f(null,a+"/live/index.m3u8")})};p.prototype.getAllStatus=function(a){var f=this,c=this._stateBuffer.areStatesExpired();c.weather||c.thermo||c.coach?this._getAllStatus(c,function(l){l?a&&a(l):a&&a(null,f._stateBuffer.getStates())}):a&&a(null,this._stateBuffer.getStates())};p.prototype._getAllStatus=function(a,f){var c=this,l=function(k,m){k&&k.weather?c._getWeatherStatus(m):m()},h=function(k,m){k&&k.thermo?c._getThermoStatus(k.home,m):m()},d=function(k,m){k&&k.coach?c._getHomeCoachStatus(m):m()};
this._getHomesInfo(function(k,m,r){k?f(k):("object"===typeof r&&r?(a.weather=r.weather&&0<r.weather.length,a.thermo=r.thermo&&0<r.thermo.length,r.coach&&0<r.coach.length&&(a.coach=!0),a.thermo&&(a.home=r.home)):(a.weather=!1,a.thermo=!1),l(a,function(w){w?f(w):h(a,function(C){C?f(C):d(a,function(D){f(D)})})}))})};p.prototype._getHomesInfo=function(a){var f=this._getHomesInfoCBs.length;-1==this._getHomesInfoCBs.indexOf(a)&&this._getHomesInfoCBs.push(a);if(0==f){var c=this;this._stateBuffer.updateReqTime("homes",
Math.round((new Date).getTime()/1E3));this._getHomesData(null,null,function(l,h,d){c._stateBuffer.updateReqOK("homes",l?!1:!0);d=c._getHomesInfoCBs;c._getHomesInfoCBs=[];l&&d.forEach(function(D){try{D&&D(l)}catch(B){}});if(h&&h.length){var k=[],m=[],r=[],w=[],C={};h.forEach(function(D){if(D&&D.modules&&D.modules.length){D.modules.forEach(function(G){if(G&&G.id&&G.type)switch(G.type){case "NAMain":case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":m.push(G.id);break;case "NATherm1":case "NAPlug":case "NRV":-1==
k.indexOf(D.id)&&k.push(D.id);r.push(G.id);break;case "NHC":w.push(G.id)}});var B=c._resolveHomeStatus(D);if(B)for(var F in B)C[F]=B[F]}});c._stateBuffer.updateHomesInfo(C,{weather:m,thermo:r,coach:w});d.forEach(function(D){try{D&&D(null,C,{weather:m,thermo:r,coach:w,home:k})}catch(B){}})}else c._stateBuffer.updateHomesInfo({},{}),d.forEach(function(D){try{D&&D(null,{})}catch(B){}})})}};p.prototype._resolveHomeStatus=function(a){if(!a)return null;var f={};f.mode=a.therm_mode;f.tempEnd=a.therm_mode_endtime;
if(f.tempEnd)if(f.tempEndStr=(new Date(1E3*f.tempEnd)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{f.tempEndStr=dateFormat(f.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(l){}else f.tempEndStr=f.tempEndStr.toLocaleString();var c={};c[a.id]=f;return c};p.prototype._getWeatherStatus=function(a){var f=this._getWeatherStatusCBs.length;-1==this._getWeatherStatusCBs.indexOf(a)&&this._getWeatherStatusCBs.push(a);if(0==f){var c=this;this._stateBuffer.updateReqTime("weather",Math.round((new Date).getTime()/
1E3));this._getStationsData(null,!1,function(l,h,d){c._stateBuffer.updateReqOK("weather",l?!1:!0);var k=c._getWeatherStatusCBs;c._getWeatherStatusCBs=[];if(l)k.forEach(function(w){try{w&&w(l,homes,d)}catch(C){}});else{var m=null,r={};h.devices&&h.devices.length&&h.devices.forEach(function(w){if(w&&"NAMain"==w.type&&(w.last_status_store&&(m=Math.max(w.last_status_store,m)),w=c._resolveWeatherStatus(w,h.user?h.user.administrative:null)))for(var C in w)r[C]=w[C]});m&&c._stateBuffer.updateWeatherStatus(r,
m,d);k.forEach(function(w){try{w&&w(null,r)}catch(C){}})}})}};p.prototype._resolveWeatherStatus=function(a,f){if(!a||"NAMain"!=a.type)return null;var c={};if(a._id){var l={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(l.wifi=a.wifi_status,l.wifiStatus=86<=l.wifi?"bad":71<=l.wifi?"middle":56<=l.wifi?"good":"very_good");if(a.dashboard_data){var h=this._resolveDashboard(a.dashboard_data);if(h)for(var d in h)h.hasOwnProperty(d)&&(l[d]=h[d])}l.tempFelt=null;"undefined"!=typeof l.temp&&"undefined"!=
typeof l.hum&&f&&(l.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(l.temp,l.hum,f));c[a._id]=l}var k=this;a.modules&&a.modules.forEach(function(m){var r=k._resolveModuleStatus(m,f);m&&m._id&&r&&(c[m._id]=r)});return c};p.prototype._resolveModuleStatus=function(a,f){var c={};null!=a.rf_status&&"undefined"!=typeof a.rf_status&&(c.rf=a.rf_status,c.rfStatus=90<=c.rf?"very_low":80<=c.rf?"low":70<=c.rf?"medium":60<=c.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(c.bat=a.battery_vp,
a.type){case "NAModule4":c.batStatus=5640<=c.bat?"full":5280<=c.bat?"high":4920<=c.bat?"medium":4560<=c.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":c.batStatus=5500<=c.bat?"full":5E3<=c.bat?"high":4500<=c.bat?"medium":4E3<=c.bat?"low":"very_low";break;case "NAModule2":c.batStatus=5900<=c.bat?"full":5180<=c.bat?"high":4770<=c.bat?"medium":4360<=c.bat?"low":"very_low";break;case "NATherm1":c.batStatus=4100<=c.bat?"full":3600<=c.bat?"high":3300<=c.bat?"medium":3E3<=c.bat?"low":"very_low"}var l,
h;if("NATherm1"==a.type&&(l=this._resolveThermoStat(a)))for(h in l)l.hasOwnProperty(h)&&(c[h]=l[h]);if(a.dashboard_data){if(l=this._resolveDashboard(a.dashboard_data))for(h in l)l.hasOwnProperty(h)&&(c[h]=l[h]);"undefined"!=typeof c.winD&&null!=c.winD&&(a=Number(c.winD),isNaN(a)||(c.winDName=23<a&&68>=a?"NO":68<a&&113>=a?"O":113<a&&158>=a?"SO":158<a&&203>=a?"S":203<a&&248>=a?"SW":248<a&&293>=a?"W":293<a&&338>=a?"NW":"N"));"undefined"!=typeof c.temp&&"undefined"!=typeof c.hum&&f&&(c.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(c.temp,
c.hum,f))}return c};p.prototype._resolveDashboard=function(a){var f=function(h,d){return null!=h[d]&&"undefined"!=typeof h[d]},c={};f(a,"AbsolutePressure")&&(c.absPres=a.AbsolutePressure);f(a,"CO2")&&(c.co2=a.CO2);f(a,"Humidity")&&(c.hum=a.Humidity);f(a,"Noise")&&(c.noise=a.Noise);f(a,"Pressure")&&(c.pres=a.Pressure);f(a,"Rain")&&(c.rain=a.Rain);f(a,"sum_rain_1")&&(c.rain1h=a.sum_rain_1);f(a,"sum_rain_24")&&(c.rain24h=a.sum_rain_24);f(a,"Temperature")&&(c.temp=a.Temperature);if(f(a,"date_max_temp")){c.timeMaxTemp=
a.date_max_temp;var l=1E3*a.date_max_temp;c.timeMaxTempStr=new Date(l);c.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):c.timeMaxTempStr.toLocaleString()}f(a,"date_min_temp")&&(c.timeMinTemp=a.date_min_temp,l=1E3*a.date_min_temp,c.timeMinTempStr=new Date(l),c.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):c.timeMinTempStr.toLocaleString());f(a,"max_temp")&&(c.maxTemp=a.max_temp);
f(a,"min_temp")&&(c.minTemp=a.min_temp);f(a,"WindAngle")&&(c.winD=a.WindAngle);f(a,"WindStrength")&&(c.winS=a.WindStrength);f(a,"GustAngle")&&(c.gwinD=a.GustAngle);f(a,"GustStrength")&&(c.gwinS=a.GustStrength);f(a,"time_utc")&&(c.mesureT=a.time_utc,l=1E3*a.time_utc,c.mesureTStr=new Date(l),c.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):c.mesureTStr.toLocaleString());f(a,"date_max_wind_str")&&(c.timeMaxWind=a.date_max_wind_str,l=1E3*a.date_max_wind_str,
c.timeMaxWindStr=new Date(l),c.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):c.timeMaxWindStr.toLocaleString());f(a,"max_wind_angle")&&(c.maxWinD=a.max_wind_angle);f(a,"max_wind_str")&&(c.maxWinS=a.max_wind_str);f(a,"temp_trend")&&(c.tempTrend=a.temp_trend);f(a,"pressure_trend")&&(c.presTrend=a.pressure_trend);if(f(a,"health_idx"))switch(c.healthIdxLvl=a.health_idx,parseInt(c.healthIdx)){case 0:c.healthIdx="healthy";break;case 1:c.healthIdx=
"fine";break;case 2:c.healthIdx="fair";break;case 3:c.healthIdx="poor";break;case 4:c.healthIdx="unhealthy"}return c};p.prototype._getThermoStatus=function(a,f){if(a&&a.length){var c=this._getThermoStatusCBs.length;-1==this._getThermoStatusCBs.indexOf(f)&&this._getThermoStatusCBs.push(f);if(0==c){var l=this;this._stateBuffer.updateReqTime("thermo",Math.round((new Date).getTime()/1E3));var h=0,d={},k=function(m,r){var w=l._getThermoStatusCBs;m?(l._stateBuffer.updateReqOK("thermo",!1),l._getThermoStatusCBs=
[],w.forEach(function(C){try{C&&C(m)}catch(D){}})):(r&&(r.modules&&r.modules.forEach(function(C){if(C&&C.id){var D=l._resolveThermoModuleStatus(C);D&&(d[C.id]=D)}}),r.rooms&&r.rooms.forEach(function(C){if(C&&C.id){var D=l._resolveThermoRoomStatus(C);D&&(d[C.id]=D)}})),h++,h<a.length?l._getHomeStatus(a[h],null,k):(l._stateBuffer.updateReqOK("thermo",!0),l._stateBuffer.updateThermoStatus(d),l._getThermoStatusCBs=[],w.forEach(function(C){try{C&&C(null,d)}catch(D){}})))};this._getHomeStatus(a[h],null,
k)}}else f(null,null)};p.prototype._resolveThermoModuleStatus=function(a){if(!a)return null;var f=function(l,h){return null!=l[h]&&"undefined"!=typeof l[h]},c={};f(a,"rf_strength")&&(c.rf=a.rf_strength,c.rfStatus=90<c.rf?"very_low":80<c.rf?"low":70<c.rf?"medium":60<c.rf?"high":"full");f(a,"wifi_strength")&&(c.wifi=a.wifi_status,c.wifiStatus=86<=c.wifi?"bad":71<=c.wifi?"middle":56<=c.wifi?"good":"very_good");f(a,"battery_level")&&(c.bat=a.battery_level);f(a,"battery_state")&&(c.batStatus=a.battery_state);
return c};p.prototype._resolveThermoRoomStatus=function(a){if(!a)return null;var f={};f.mode=a.therm_setpoint_mode;f.manuT=a.therm_setpoint_temperature;f.tempEnd=a.therm_setpoint_end_time;if(f.tempEnd)if(f.tempEndStr=(new Date(1E3*f.tempEnd)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{f.tempEndStr=dateFormat(f.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(c){}else f.tempEndStr=f.tempEndStr.toLocaleString();f.currentTemp=a.therm_measured_temperature;return f};p.prototype._getHomeCoachStatus=
function(a){var f=this._getCoachStatusCBs.length;-1==this._getCoachStatusCBs.indexOf(a)&&this._getCoachStatusCBs.push(a);if(0==f){var c=this;this._stateBuffer.updateReqTime("coach",Math.round((new Date).getTime()/1E3));this._getHomeCoachsData(null,function(l,h,d){c._stateBuffer.updateReqOK("coach",l?!1:!0);var k=c._getCoachStatusCBs;c._getCoachStatusCBs=[];if(l)k.forEach(function(w){try{w&&w(l,h,d)}catch(C){}});else{var m=null,r={};h.devices&&h.devices.length&&h.devices.forEach(function(w){if(w&&
"NHC"==w.type&&(w.last_status_store&&(m=Math.max(w.last_status_store,m)),w=c._resolveCoachStatus(w,h.user?h.user.administrative:null)))for(var C in w)r[C]=w[C]});m&&c._stateBuffer.updateCoachStatus(r,m,d);k.forEach(function(w){try{w&&w(null,r)}catch(C){}})}})}};p.prototype._resolveCoachStatus=function(a,f){var c={};c.wifi=a.wifi_status;c.wifiStatus=86<=c.wifi?"bad":71<=c.wifi?"middle":56<=c.wifi?"good":"very_good";if(a.dashboard_data){var l=this._resolveDashboard(a.dashboard_data);if(l)for(var h in l)l.hasOwnProperty(h)&&
(c[h]=l[h])}c.tempFelt=null;"undefined"!=typeof c.temp&&"undefined"!=typeof c.hum&&f&&(c.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(c.temp,c.hum,f));f={};f[a._id]=c;return f};p.prototype._renewAccessToken=function(a){var f=this._renewTokenCBs.length;a&&-1==this._renewTokenCBs.indexOf(a)&&this._renewTokenCBs.push(a);if(0==f){var c=this;a=function(l,h){var d=!1;!l&&h&&(h.access_token&&(c.accessToken=h.access_token,d=!0),h.refresh_token&&(c.refreshToken=h.refresh_token));l||d||(l=Error("invalid token response"));
h=c._renewTokenCBs;c._renewTokenCBs=[];for(d=0;d<h.length;d++)try{h[d](l)}catch(k){}};this.refreshToken?this._refreshToken(a):this.username&&this.password?this._auth(a):a(Error("no refresh token or username/password"))}};p.prototype._auth=function(a){this._logger.log("trace","_auth");var f={grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.username,password:this.password,scope:this._scope.join(" ")},c=[],l;for(l in f)c.push(l+
"="+encodeURIComponent(f[l]));f=c.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},f,function(h,d,k){if(h)a(h);else if(d)try{var m=JSON.parse(d);200!=k?(h=Error(m.error),a(h)):a(null,m)}catch(r){a(r)}else a(Error("invalid response"))})};p.prototype._refreshToken=function(a){this._logger.log("trace","_refreshToken");var f={grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:this.refreshToken},
c=[],l;for(l in f)c.push(l+"="+encodeURIComponent(f[l]));f=c.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},f,function(h,d,k){if(h)a(h);else if(d)try{var m=JSON.parse(d);200!=k?(h=Error(m.error),a(h)):a(null,m)}catch(r){a(r)}else a(Error("invalid response"))})};p.prototype._getStationsData=function(a,f,c){this._logger.log("debug","_getStationsData");var l="/api/getstationsdata",h=[];a&&h.push("device_id="+a);f&&h.push("get_favorites="+get_favorites);
h.length&&(l+="?"+h.join("&"));this._doAPIRequest("GET",l,null,function(d,k){d?c(d):k&&k.body?c(null,k.body,k.time_server):c(Error("invalid get stations data response"))})};p.prototype._getHomesData=function(a,f,c){this._logger.log("debug","_getHomesData");var l="/api/homesdata",h=[];a&&h.push("home_id="+a);f&&h.push("gateway_types="+f);h.length&&(l+="?"+h.join("&"));this._doAPIRequest("GET",l,null,function(d,k){d?c(d):k&&k.body&&k.body.homes?c(null,k.body.homes,k.time_server):c(Error("invalid get homes data response"))})};
p.prototype._getHomeStatus=function(a,f,c){this._logger.log("debug","_getHomeStatus");var l="/api/homestatus",h=[];a&&h.push("home_id="+a);f&&f.length&&f.forEach(function(d){h.push("device_types="+d)});h.length&&(l+="?"+h.join("&"));this._doAPIRequest("GET",l,null,function(d,k){d?c(d):k&&k.body&&k.body.home?c(null,k.body.home,k.time_server):c(Error("invalid get home status response"))})};p.prototype._getHomeCoachsData=function(a,f){this._logger.log("debug","_getHomeCoachsData");var c="/api/gethomecoachsdata",
l=[];a&&l.push("device_id="+a);l.length&&(c+="?"+l.join("&"));this._doAPIRequest("GET",c,null,function(h,d){h?f(h):d&&d.body?f(null,d.body,d.time_server):f(Error("invalid get stations data response"))})};p.prototype._setThermPoint=function(a,f,c,l,h,d){var k="/api/setthermpoint",m=[];a&&m.push("device_id="+a);f&&m.push("module_id="+f);c&&m.push("setpoint_mode="+c);l&&m.push("setpoint_endtime="+l);h&&m.push("setpoint_temp="+h);m.length&&(k+="?"+m.join("&"));this._doAPIRequest("GET",k,null,d)};p.prototype._setThermMode=
function(a,f,c,l,h){this._logger.log("debug","_setThermMode");var d="/api/setthermmode",k=[];a&&k.push("home_id="+a);f&&k.push("mode="+f);c&&k.push("endtime="+c);l&&k.push("schedule_id="+l);k.length&&(d+="?"+k.join("&"));this._doAPIRequest("GET",d,null,function(m,r){h(m)})};p.prototype._setRoomThermPoint=function(a,f,c,l,h,d){this._logger.log("debug","_setRoomThermPoint");var k="/api/setroomthermpoint",m=[];a&&m.push("home_id="+a);f&&m.push("room_id="+f);c&&m.push("mode="+c);l&&m.push("temp="+l);
h&&m.push("endtime="+h);m.length&&(k+="?"+m.join("&"));this._doAPIRequest("GET",k,null,function(r,w){d(r)})};p.prototype._getHomeData=function(a,f,c){this._logger.log("debug","_getHomeData");var l="/api/gethomedata",h=[];a&&h.push("home_id="+a);f&&h.push("size="+f);h.length&&(l+="?"+h.join("&"));this._doAPIRequest("GET",l,null,function(d,k){d?c(d):k&&k.body&&k.body.homes?c(null,k.body.homes,k.time_server):c(Error("invalid get homes data response"))})};p.prototype._doAPIRequest=function(a,f,c,l){var h=
this;this.accessToken?this._doJsonRequest(a,f,c,function(d,k){!d||2!=d.code&&3!=d.code||401!=d.status&&403!=d.status?l(d,k):h._renewAccessToken(function(m){m?l(m):h._doJsonRequest(a,f,c,function(r,w){l(r,w)})})}):this._renewAccessToken(function(d){d?l(d):h._doJsonRequest(a,f,c,function(k,m){l(k,m)})})};p.prototype._doJsonRequest=function(a,f,c,l){var h=this;this._doRequest(a,f,{Authorization:"Bearer "+this.accessToken},c?JSON.stringify(c):null,function(d,k,m){if(d)l(d);else if(k)try{var r=JSON.parse(k);
if(200!=m){h._logger.log("error","[_doJsonRequest] Status: "+m+". Error: "+k);var w=r.error?r.error.code?r.error.code:0:0;d=Error(r.error?r.error.message?r.error.message:"invalid error response":"invalid error response");d.code=w;d.status=m;l(d)}else l(null,r)}catch(C){l(C)}else l(Error("invalid response"))})};p.prototype._doRequest=function(a,f,c,l,h){a={host:"api.netatmo.net",port:443,path:f,method:a,headers:{Connection:"close","Content-Type":"application/json; charset=UTF-8"}};if(c)for(var d in c)a.headers[d]=
c[d];c=require("https");d=JSON.parse(JSON.stringify(a));d.headers&&(d.headers.auth&&(d.headers.auth="*********"),d.headers.Authorization&&(d.headers.Authorization="*********"));d.auth&&(d.auth="********");this._logger.log("trace","do request:"+JSON.stringify(d));var k=this,m=h,r=c.request(a,function(w){w.setEncoding("utf-8");var C="";w.on("data",function(D){C+=D});w.on("end",function(){k._logger.log("trace","receive code:"+w.statusCode+" headers:"+JSON.stringify(w.headers)+" response:"+C);m&&(m(null,
C,w.statusCode),m=null)})});if(r.on)r.on("error",function(w){k._logger.log("trace","do request error:"+w.message);m&&(m(w),m=null)});r.setTimeout&&r.setTimeout(1E4,function(){k._logger.log("trace","do request timeout");r.abort();m&&(m(Error("timeout")),m=null)});l&&(this._logger.log("trace","send body:"+l),r.write(l));r.end()};p.prototype._doUrlRequest=function(a,f,c,l){var h=this,d=l,k=null;try{k=JSON.parse(JSON.stringify(c)),k.username&&(k.username="xxxxxx"),k.password&&(k.password="xxxxxx")}catch(m){k=
c}this._logger.log("trace","send "+a+" req to:"+f+" data:"+JSON.stringify(k));$.ajax({url:f,type:a,timeout:1E4,dataType:"json",data:c,cache:!1,success:function(m){h._logger.log("trace","http request success:"+JSON.stringify(m));l&&l(null,m)},error:function(m,r,w){r="http request error:"+(m?m.status:"0")+"-"+r;h._logger.log("warn","http request error:"+r);r=Error(r);w&&(h._logger.log("warn","http request http error:"+w),r.httpError=!0,r.statusCode=m?m.status:0);d&&(d(r,m?m.responseText:null),d=null)}})};
return p}();
xnm.aio.netatmo.DM=function(){var y=function(h,d){this.code=h;this.message=d;this.stack=Error().stack};y.prototype=Error();y.prototype.name="NetatmoDmError";y.prototype.code=0;y.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var p=y.ERROR_CODE,a=[{type:"float",name:"absolute pressure",ref:{value:"absPres",value_t:"pressureAbsolute"}},{type:"int",name:"co2",ref:{value:"co2"}},{type:"int",name:"humidity",ref:{value:"hum"}},{type:"int",name:"noise",ref:{value:"noise"}},
{type:"float",name:"pressure",ref:{value:"pres",value_t:"pressure"}},{type:"float",name:"rain",ref:{value:"rain"}},{type:"float",name:"rain last hour",ref:{value:"rain1h"}},{type:"float",name:"rain last 24 hours",ref:{value:"rain24h"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"time max temperatue",ref:{value:"timeMaxTemp"}},{type:"int",name:"time min temperatue",ref:{value:"timeMinTemp"}},{type:"float",name:"max temperatue",ref:{value:"maxTemp"}},{type:"float",name:"min temperatue",
ref:{value:"minTemp"}},{type:"int",name:"wind direction",ref:{value:"winD"}},{type:"float",name:"wind speed",ref:{value:"winS"}},{type:"int",name:"gust wind direction",ref:{value:"gwinD"}},{type:"float",name:"gust wind speed",ref:{value:"gwinS"}},{type:"int",name:"last measure time",ref:{value:"mesureT",value_t:"lastMeasureTime"}},{type:"int",name:"time max wind",ref:{value:"timeMaxWind"}},{type:"int",name:"max wind direction",ref:{value:"maxWinD"}},{type:"float",name:"max wind speed",ref:{value:"maxWinS"}},
{type:"float",name:"rf level",ref:{value:"rf"}},{type:"enum",name:"rf status",ref:{value:"rfStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"battery level",ref:{value:"bat",value_t:"battery_level",extMeta:"3000-6000"}},{type:"enum",name:"battery status",ref:{value:"batStatus",value_t:"battery_state",options:["very_low","low","medium","high","full"]}},{type:"float",name:"wifi level",ref:{value:"wifi"}},{type:"enum",name:"wifi status",ref:{value:"wifiStatus",options:["bad",
"middle","good","very_good"]}},{type:"enum",name:"mode",ref:{value:"mode",options:"auto away frost-guard manu off boost".split(" ")}},{type:"float",name:"manual temperature",ref:{value:"manuT",extMeta:"5.5-30",scale:"0.5"}},{type:"int",name:"manual/boost endtime",ref:{value:"tempEnd"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",extMeta:"15-720",scale:"15"}},{type:"string",name:"manual/boost endtime string",
ref:{value:"tempEndStr"}},{type:"string",name:"time string max temperatue",ref:{value:"timeMaxTempStr"}},{type:"string",name:"time string min temperatue",ref:{value:"timeMinTempStr"}},{type:"string",name:"last measure time string",ref:{value:"mesureTStr",value_t:"lastMeasureTimeStr"}},{type:"string",name:"time string max wind",ref:{value:"timeMaxWindStr"}},{type:"float",name:"felt temperature",ref:{value:"tempFelt"}},{type:"string",name:"wind direction named",ref:{value:"winDName",options:"N NO O SO S SW W NW".split(" ")}},
{type:"enum",name:"temperature trend",ref:{value:"tempTrend",options:["up","down","stable"]}},{type:"enum",name:"pressure trend",ref:{value:"presTrend",value_t:"pressureTrend",options:["up","down","stable"]}},{type:"enum",name:"health index",ref:{value:"healthIdx",options:["healthy","fine","fair","poor","unhealthy"]}},{type:"int",name:"health index level",ref:{value:"healthIdxLvl",extMeta:"0-4"}}],f=[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},
{type:"enum",name:"frost-guard",ref:{value:"thermoHg"}},{type:"enum",name:"off",ref:{value:"thermoOff"}},{type:"enum",name:"max",ref:{value:"thermoMax"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"5.5-30",scale:"0.5"}},{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",ext:"%d",extMeta:"15-720",scale:"15"}}],c={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},
{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"multi",name:"manu until",ref:{value:"thermoManuUntil",ext:"%multi",extMeta:[{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"time",name:"end time",ref:{value:"endtime",ext:"%time"}}]}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:"manual max off schedule away hg".split(" ")}},
{type:"float",name:"setpoint temperature",ref:{value:"manuT",value_t:"setTemperature",extMeta:"7-30",scale:"0.5"}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}}]},l={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},{type:"time",name:"away until",ref:{value:"thermoAwayUntil",ext:"%time"}},{type:"enum",
name:"frost-guard",ref:{value:"thermoHg"}},{type:"time",name:"frost-guard until",ref:{value:"thermoHgUntil",ext:"%time"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["schedule","away","frost_guard"]}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}}]};return{SYS:"netatmo",getGatewayType:function(){return[{sys:this.SYS,name:"Netatmo (Online)",port:443}]},getGatewayDeviceType:function(h){return[{sys:this.SYS,
type:"NAMain",name:"Base Station"},{sys:this.SYS,type:"NAModule1",name:"Outdoor module"},{sys:this.SYS,type:"NAModule4",name:"Additional indoor module"},{sys:this.SYS,type:"NAModule3",name:"Rain gauge module"},{sys:this.SYS,type:"NAModule2",name:"Wind gauge module"},{sys:this.SYS,type:"NATherm1",name:"Thermostat"},{sys:this.SYS,type:"NHC",name:"Home Coach"}]},_checkInfo:function(h,d,k){if(h)if(h.gateway)if(h.type)if(h.address)if(d.data&&d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;
var m;for(m=0;m<d.length;m++)if(d[m].index===h.gateway){var r=d[m];break}r?k():k(new y(p.NOT_FOUND,"gateway with index "+h.gateway+" not exists"))}else k(new y(p.NOT_FOUND,"gateway with index "+h.gateway+" not exists"));else k(new y(p.INVALID,"address is invalid"));else k(new y(p.INVALID,"type is invalid"));else k(new y(p.INVALID,"gateway is invalid"));else k(new y(p.INVALID,"info is invalid"))},createGateway:function(h,d,k){h?h.refreshToken||h.username&&h.password?k(null,h):k(new y(p.INVALID,"refreshToken is invalid")):
k(new y(p.INVALID,"info is invalid"))},updateGateway:function(h,d,k,m){d?d.refreshToken||d.username&&d.password?m(null,d):m(new y(p.INVALID,"refreshToken is invalid")):m(new y(p.INVALID,"info is invalid"))},deleteGateway:function(h,d,k){k()},createDevice:function(h,d,k){this._checkInfo(h,d,function(m){k(m,h)})},updateDevice:function(h,d,k){this._checkInfo(h,d,function(m){k(m,h)})},deleteDevice:function(h,d,k){k(null,h)},applyUIFilter:function(h,d){var k=function(D,B){if("*"==D)return!0;for(var F=
!1,G=0;G<D.length;G++)if(D[G]==B){F=!0;break}return F},m=function(D,B,F){var G=[];switch(F.catagory){case "command":D.command&&D.command.forEach(function(K){k(F.elems,K.type)&&(K=JSON.parse(JSON.stringify(K)),G.push(K))});break;case "status":D.status&&D.status.forEach(function(K){k(F.elems,K.type)&&(K=JSON.parse(JSON.stringify(K)),G.push(K))})}return G},r=function(D,B){var F=[],G=this.getCommandStatusMap(D);G&&(D=m(G,D,B),F=F.concat(D));return F};if(!h.sys)return null;var w=JSON.parse(JSON.stringify(h)),
C=null;switch(d.catagory){case "command":C=r.call(this,h,d);w.command=C;break;case "status":C=r.call(this,h,d);w.status=C;break;default:return null}return C&&0!=C.length?w:null},applyIPEventFilter:function(h,d){if(!h.sys)return null;d=JSON.parse(JSON.stringify(h));h=this.getIPevtMap(h);if(!h)return d;d.ipevt=h.ipevt;return d},getCommandStatusMap:function(h){var d={command:[],status:[]};switch(h.type){case "NAMain":d.status.push(a[25]);d.status.push(a[26]);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":case "NATherm1":d.status.push(a[21]);
d.status.push(a[22]);d.status.push(a[23]);d.status.push(a[24]);"NATherm1"==h.type&&(d.status.push(a[27]),d.status.push(a[28]),d.status.push(a[29]),d.status.push(a[30]),d.status.push(a[31]),d.status.push(a[32]));break;case "NHC":d.status.push(a[25]),d.status.push(a[26])}"NATherm1"==h.type&&(d.command=f);if(h.dashboard_data)for(var k in h.dashboard_data)if(h.dashboard_data.hasOwnProperty(k))switch(k){case "AbsolutePressure":d.status.push(a[0]);break;case "CO2":d.status.push(a[1]);break;case "Humidity":d.status.push(a[2]);
d.status.push(a[37]);break;case "Noise":d.status.push(a[3]);break;case "Pressure":d.status.push(a[4]);break;case "Rain":d.status.push(a[5]);break;case "sum_rain_1":d.status.push(a[6]);break;case "sum_rain_24":d.status.push(a[7]);break;case "Temperature":d.status.push(a[8]);break;case "date_max_temp":d.status.push(a[9]);d.status.push(a[33]);break;case "date_min_temp":d.status.push(a[10]);d.status.push(a[34]);break;case "max_temp":d.status.push(a[11]);break;case "min_temp":d.status.push(a[12]);break;
case "WindAngle":d.status.push(a[13]);d.status.push(a[38]);break;case "WindStrength":d.status.push(a[14]);break;case "GustAngle":d.status.push(a[15]);break;case "GustStrength":d.status.push(a[16]);break;case "time_utc":d.status.push(a[17]);d.status.push(a[35]);break;case "date_max_wind_str":d.status.push(a[18]);d.status.push(a[36]);break;case "max_wind_angle":d.status.push(a[19]);break;case "max_wind_str":d.status.push(a[20]);break;case "temp_trend":d.status.push(a[39]);break;case "pressure_trend":d.status.push(a[40]);
break;case "health_idx":d.status.push(a[41]),d.status.push(a[42])}return d},getCommandStatusMap2:function(h){var d={command:[],status:[]},k=null;switch(h.type){case "NAMain":k="time_utc Temperature CO2 Humidity Noise Pressure AbsolutePressure min_temp max_temp date_min_temp date_max_temp temp_trend pressure_trend".split(" ");d.status.push(a[25]);d.status.push(a[26]);break;case "NAModule1":k="time_utc Temperature Humidity min_temp max_temp date_min_temp date_max_temp temp_trend".split(" ");d.status.push(a[21]);
d.status.push(a[22]);d.status.push(a[23]);d.status.push(a[24]);break;case "NAModule2":k="time_utc WindStrength WindAngle GustStrength GustAngle max_wind_str max_wind_angle date_max_wind_str".split(" ");d.status.push(a[21]);d.status.push(a[22]);d.status.push(a[23]);d.status.push(a[24]);break;case "NAModule3":k=["time_utc","Rain","sum_rain_24","sum_rain_1"];d.status.push(a[21]);d.status.push(a[22]);d.status.push(a[23]);d.status.push(a[24]);break;case "NAModule4":k="time_utc Temperature CO2 Humidity Pressure AbsolutePressure min_temp max_temp date_min_temp date_max_temp temp_trend".split(" ");
d.status.push(a[21]);d.status.push(a[22]);d.status.push(a[23]);d.status.push(a[24]);break;case "NATherm1":d.status.push(a[21]);d.status.push(a[22]);d.status.push(a[23]);d.status.push(a[24]);break;case "NRV":d.status.push(a[21]);d.status.push(a[22]);d.status.push(a[23]);d.status.push(a[24]);break;case "NAPlug":d.status.push(a[21]);d.status.push(a[22]);d.status.push(a[25]);d.status.push(a[26]);break;case "NHC":k="time_utc Temperature CO2 Humidity Noise Pressure AbsolutePressure health_idx min_temp max_temp date_min_temp date_max_temp".split(" ");
d.status.push(a[25]);d.status.push(a[26]);break;case "room":d=c;break;case "home":d=l}k&&k.forEach(function(m){switch(m){case "AbsolutePressure":d.status.push(a[0]);break;case "CO2":d.status.push(a[1]);break;case "Humidity":d.status.push(a[2]);d.status.push(a[37]);break;case "Noise":d.status.push(a[3]);break;case "Pressure":d.status.push(a[4]);break;case "Rain":d.status.push(a[5]);break;case "sum_rain_1":d.status.push(a[6]);break;case "sum_rain_24":d.status.push(a[7]);break;case "Temperature":d.status.push(a[8]);
break;case "date_max_temp":d.status.push(a[9]);d.status.push(a[33]);break;case "date_min_temp":d.status.push(a[10]);d.status.push(a[34]);break;case "max_temp":d.status.push(a[11]);break;case "min_temp":d.status.push(a[12]);break;case "WindAngle":d.status.push(a[13]);d.status.push(a[38]);break;case "WindStrength":d.status.push(a[14]);break;case "GustAngle":d.status.push(a[15]);break;case "GustStrength":d.status.push(a[16]);break;case "time_utc":d.status.push(a[17]);d.status.push(a[35]);break;case "date_max_wind_str":d.status.push(a[18]);
d.status.push(a[36]);break;case "max_wind_angle":d.status.push(a[19]);break;case "max_wind_str":d.status.push(a[20]);break;case "temp_trend":d.status.push(a[39]);break;case "pressure_trend":d.status.push(a[40]);break;case "health_idx":d.status.push(a[41]),d.status.push(a[42])}});return d},getIPevtMap:function(h){return(h=this.getCommandStatusMap(h))?{ipevt:h.status}:null},calcFeltTemp:function(h,d,k){if(k&&"object"==typeof k&&0===k.feel_like_algo)k=243.5,d=Math.log(.01*d)+17.67*h/(k+h),d=h+.5555*
(6.11*Math.exp(5417.753*(1/273.16-1/(k*d/(17.67-d)+273.15)))-10);else{k=[-42.379,2.04901523,10.14333127,-.22475541,-.00683783,-.05481717,.00122874,8.5282E-4,-1.99E-6];h=9*h/5+32;var m=h*h,r=d*d;d=k[0]+k[1]*h+k[2]*d+k[3]*h*d+k[4]*m+k[5]*r+k[6]*m*d+k[7]*h*r+k[8]*m*r;d=5*(d-32)/9}return Math.round(10*d)/10},supportSmartWidget:function(h){return h&&h.type?0<=["home","room"].indexOf(h.type):!1},applySmartWidgetFilter:function(h,d,k,m,r){if(!d||!d.type)return!1;k=[];if("home"===d.type){d={"%auto%":{value:"thermoAuto"},
"%away%":{value:"thermoAway"},"%awayUntil%":{value:"thermoAwayUntil",ext:"%time"},"%frostGuard%":{value:"thermoHg"},"%frostGuardUntil%":{value:"thermoHgUntil",ext:"%time"}};var w={"%mode%":{value:"mode",options:["schedule","away","frost_guard"]}};k.push("netatmo_thermo")}else if("room"===d.type)d={"%auto%":{value:"thermoAuto"},"%thermoUp%":{value:"thermoUp"},"%thermoDown%":{value:"thermoDown"},"%thermoManu%":{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:.5}},w={"%mode%":{value:"mode",options:"manual max off schedule away hg".split(" ")},
"%setTemp%":{value:"manuT",extMeta:"7-30",scale:.5},"%currentTemp%":{value:"currentTemp"}},k.push("netatmo_thermo");else return!1;return h._injectToSmartWidgetTemplate(m,k,r,d,w)}}}();xnm.aio.netatmo.DM.getCommandStatusMap=xnm.aio.netatmo.DM.getCommandStatusMap2;xnm.aio.netatmo.Cloud=xnm.aio.netatmo.Client;
xnm.aio.netatmo.Handler=function(){var y=function(){this._updateListener=[]};y.prototype.Client=xnm.aio.netatmo.Client;y.prototype.Cloud=xnm.aio.netatmo.Cloud;y.prototype.MNetatmo=xnm.aio.netatmo.MNetatmo;y.prototype.devicemanager=xnm.aio.netatmo.DM;y.prototype.registModule=function(p){p.register(this.devicemanager.SYS,"netatmo")};y.prototype.resolveGateway=function(p){return p.refreshToken||p.username&&p.password?new xnm.aio.netatmo.Cloud(p.username,p.password,p.refreshToken):null};y.prototype.getDeviceCommands=
function(p,a){p=(p=xnm.aio.netatmo.DM.applyUIFilter(p,{catagory:"command",elems:"*"}))?p.command:[];a&&a(null,p)};y.prototype.getDeviceStatus=function(p,a){p=(p=xnm.aio.netatmo.DM.applyUIFilter(p,{catagory:"status",elems:"*"}))?p.status:[];a&&a(null,p)};y.prototype.login=function(p,a){(p=this.resolveGateway(p))?p.auth(function(f,c){f?a&&a(f):a&&a(f,{refreshToken:c.refresh_token})}):a&&a(Error("gateway json format invalid"))};y.prototype.doCommand=function(p,a,f,c){(p=this.resolveGateway(p))?p.executeCommandCreator(a,
f,function(l){c&&c(l)}):c&&c(Error("gateway json format invalid"))};y.prototype.doStatus=function(p,a,f,c,l){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:p,device:f,status:c}],function(h,d){h?l&&l(h):l&&l(null,d[0])}):l&&l(Error("gateway json format invalid"))};y.prototype.getDeviceList=function(p,a){(p=this.resolveGateway(p))?p.getDeviceList(a):a&&a(Error("gateway json format invalid"))};y.prototype.getCamList=function(p,a){(p=this.resolveGateway(p))?p.getCamList(a):a&&a(Error("gateway json format invalid"))};
y.prototype.pause=function(p){xnm.aio.netatmo.Cloud.pause(p)};y.prototype.addUpdateListener=function(p){p&&-1==this._updateListener.indexOf(p)&&this._updateListener.push(p)};y.prototype.getDevice=function(p){return new this.MNetatmo(p)};y.prototype.setMNetatmoCloudUrl=function(p){this.MNetatmo.CLOUD_URL=p};return y}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.netatmo.Handler);
