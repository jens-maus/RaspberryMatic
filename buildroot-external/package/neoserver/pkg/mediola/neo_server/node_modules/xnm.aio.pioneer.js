var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,c,h){e!=Array.prototype&&e!=Object.prototype&&(e[c]=h.value)};$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global&&null!=global?global:e};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var e=0;return function(c){return $jscomp.SYMBOL_PREFIX+(c||"")+e++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(e){var c=0;return $jscomp.iteratorPrototype(function(){return c<e.length?{done:!1,value:e[c++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};$jscomp.iteratorFromArray=function(e,c){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var h=0,g={next:function(){if(h<e.length){var f=h++;return{value:c(f,e[f]),done:!1}}g.next=function(){return{done:!0,value:void 0}};return g.next()}};g[Symbol.iterator]=function(){return g};return g};
$jscomp.polyfill=function(e,c,h,g){if(c){h=$jscomp.global;e=e.split(".");for(g=0;g<e.length-1;g++){var f=e[g];f in h||(h[f]={});h=h[f]}e=e[e.length-1];g=h[e];c=c(g);c!=g&&null!=c&&$jscomp.defineProperty(h,e,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.pioneer=xnm.aio.pioneer||{};
xnm.aio.pioneer.AVReceiver=function(){var e=[1,2,3,4,5],c=function(a,b,d,l){this._taskBuffer=a;this._avr=b;this._datapoints=d;this._callback=l};c.prototype.run=function(){this._avr._logger.log("debug","run status task: "+JSON.stringify(this._datapoints));var a=this,b={},d=0,l=function(c,f){if(c&&4!=c.errorCode&&5!=c.errorCode)1==c.errorCode||2==c.errorCode||3==c.errorCode?a._taskBuffer._finishAllTask(c):a._taskBuffer._finishLastTask(c);else{c=a._datapoints[d];var e=null,h=c.indexOf(":");0<h&&(e=c.substr(0,
h),c=c.substr(h+1));h="?";f&&(e||null==f[c]||"undefined"==typeof f[c]?e&&f[e]&&null!=f[e][c]&&"undefined"!=typeof f[e][c]&&(h=f[e][c]):h=f[c]);b[a._datapoints[d]]=h;d+=1;d<a._datapoints.length?(f=a._avr._getStateQuest(a._datapoints[d]),a._avr._doStateReq(f,l)):a._taskBuffer._finishLastTask(null,b)}},c=this._avr._getStateQuest(this._datapoints[d]);this._avr._doStateReq(c,l)};c.prototype.merge=function(a){if(a&&a._datapoints)if(this._datapoints){a=this._datapoints.concat(a._datapoints);for(var b=0;b<
a.length;++b)for(var d=b+1;d<a.length;++d)a[b]===a[d]&&a.splice(d,1);this._datapoints=a}else this._datapoints=a._datapoints};var h=function(a,b,d,l){this._taskBuffer=a;this._avr=b;this._commandTxt=d;this._callback=l};h.prototype.run=function(){this._avr._logger.log("debug","run command task: "+this._commandTxt);var a=this,b=this._avr._getCommandQuest(this._commandTxt);this._avr._doCommandReq(b,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):a._taskBuffer._finishAllTask(b)})};
var g=function(a){this._avr=a;this._buffer=[]};g.prototype.executeTask=function(a){if(0==this._buffer.length)this._buffer.push(a),this._doNextTask();else{if(!(a instanceof h)&&a instanceof c){var b=[];if(1<this._buffer.length){for(var d=1;d<this._buffer.length;d++)this._buffer[d]&&this._buffer[d]instanceof c&&(b.push(d),a.merge(this._buffer[d]));for(d=0;d<b.length;d++)this._buffer.splice(b[d],1)}}this._buffer.push(a)}};g.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run()};
g.prototype._finishLastTask=function(a,b){if(0<this._buffer.length){var d=this._buffer[0];d&&d._callback&&(d._callback(a,b),d._callback=null);this._buffer.splice(0,1)}this._doNextTask()};g.prototype._finishAllTask=function(a){var b=this._buffer;this._buffer=[];for(var d=0;d<b.length;d++)b[d]&&b[d]._callback&&(b[d]._callback(a),b[d]._callback=null)};var f=function(a){this._avr=a;this._buffer=[];this._bufferEmptyTo=null};f.prototype.RESPONSE_TO=500;f.prototype.sendPacket=function(a,b,d){if(a){var l=
this._buffer.length;this._buffer.push({packet:a,ignoreRsp:b,callback:d});this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);0==l&&this._sendNextPacket()}else d&&d(Error("ISCP message is null"))};f.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var a=this,b=this._buffer[0];this._avr._sendPacket(b.packet,function(d){d?(d.errorCode=e[0],a._finishAllPacket(d)):b.ignoreRsp?a._finishLastPacket():b.timeout=setTimeout(function(){a._avr._logger.log("warn","packet response timeout");
var b=Error("packet reponse timeout");b.errorCode=e[3];a._finishLastPacket(b)},a.RESPONSE_TO)})}};f.prototype._finishLastPacket=function(a,b){0<this._buffer.length&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(a,b),this._buffer[0].callback=null)),this._buffer.splice(0,1));if(0==this._buffer.length){var d=this;this._bufferEmptyTo=setTimeout(function(){d._bufferEmptyTo=null;0==d._buffer.length&&
d._avr._disconnect()},500)}else this._sendNextPacket()};f.prototype._finishAllPacket=function(a){var b=this._buffer;this._buffer=[];this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var d=0;d<b.length;d++)b[d]&&(b[d].timeout&&(clearTimeout(b[d].timeout),b[d].timeout=null),b[d].callback&&(b[d].callback(a),b[d].callback=null))};f.prototype._onSocketData=function(a){a=new Buffer(a);a=a.toString("hex");a=new Buffer(a,"hex");var b=a.toString();if(0<this._buffer.length&&
this._buffer[0]&&this._buffer[0].packet)if("?"==this._buffer[0].packet.substr(0,1)){a=b.split("\r");-1!=b.indexOf("\n")&&(a=b.split("\n"));b=this._avr._getRspPrefix(this._buffer[0].packet);for(var d=!1,l="",c=0;c<a.length;c++)if(b&&a[c]&&0==a[c].indexOf(b)){this._finishLastPacket(null,a[c].trim());break}else 0==a[c].indexOf("E")&&(d=!0,l=a[c]);d&&(a=Error("pioneer response error code:"+l),a.errorCode=e[4],this._finishLastPacket(a))}else this._finishLastPacket(null,b)};f.prototype._onSocketTimeout=
function(){};f.prototype._onSocketError=function(a){a.errorCode=e[1];this._finishAllPacket(a)};f.prototype._onSocketClose=function(a){a=Error("socket closed");a.errorCode=e[2];this._finishAllPacket(a)};var k=function(a,b,d,l,c){this._ip=a;this._port=b;this._port||(this._port=23);this._uuid=d;this._name=l;this._model=c;this._logger=require("x.logger.js").getLogger("xnm.aio.pioneer.AVReceiver");this._socket=null;this._taskBuffer=new g(this);this._packetBuffer=new f(this)};k.prototype.executeCommandCreator=
function(a,b,d){if(b&&b.value)if("openNative"==b.value)window&&window.XC&&window.XC.callHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?window.XC.callHost("SYSTEM","startApp",{scheme:"icontrolav5://"}):"Android"==window.XCHost.getType()&&window.XC.callHost("SYSTEM","startApp",{scheme:"jp.pioneer.avsoft.android.icontrolav2014"})),d&&d();else{a="";b.path&&b.path[0]&&"global"!=b.path[0]&&(a=b.path[0]+":");var l=a+b.value;if("setTo"==b.value||"tuner"==b.value){if(null==b.ext||"undefined"==
typeof b.ext){d&&d(Error("command setTo ext format invalid"));return}l+=b.ext}else if("audioMode"==b.value){if(!b.ext){d&&d(Error("command audioMode ext format invalid"));return}l=a+b.ext}else if("setInput"==b.value){if(!b.ext){d&&d(Error("command setInput ext format invalid"));return}l=a+b.ext}else if("setTone"==b.value){if(!b.ext){d&&d(Error("command setTone ext format invalid"));return}l+=b.ext}else if("bassTo"==b.value||"trebleTo"==b.value){if(null==b.ext||"undefined"==typeof b.ext){d&&d(Error("command ext format invalid"));
return}l+=b.ext}else if("customCMD"==b.value){if(!b.ext){d&&d(Error("command customCMD ext format invalid"));return}l=a+b.ext}this._executeCommand(l,function(a){a?d&&d(a):b.path&&b.path[0]&&"mainzone"==b.path[0]&&("on"==b.value||"off"==b.value||"toggle"==b.value)?setTimeout(function(){d&&d()},5E3):d&&d()})}else d&&d(Error("command json format invalid"))};k.prototype.getStatesCreator=function(a,b,d){a=function(a,b){for(var d=0;d<b.length;d++)if(b[d]===a)return!0;return!1};for(var l=[],c=[],f=0;f<b.length;f++)if(b[f]&&
b[f].id&&b[f].status&&b[f].status.value){var e="";b[f].status.path&&b[f].status.path[0]&&"global"!=b[f].status.path[0]&&(e=b[f].status.path[0]+":");var h=b[f].status.value;l.push({id:b[f].id,datapoint:e+h});a(e+h,c)||c.push(e+h)}this._getStates(c,function(a,b){if(a)d&&d(a);else{a=[];for(var c=0;c<l.length;c++){var f="?",e=l[c].id,h=l[c].datapoint;b&&null!=b[h]&&"undefined"!=typeof b[h]&&(f=b[h]);a.push({id:e,status:f})}d&&d(null,a)}})};k.prototype.executeCommand=function(a,b){this._executeCommand(a,
b)};k.prototype.getStates=function(a){var b=Object.keys(k.STATUS_DPT_QUEST);this._getStates(b,function(b,c){a&&a(b,c)})};k.prototype._executeCommand=function(a,b){this._logger.log("debug","execute command: "+a);a=new h(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(a)};k.prototype._getStates=function(a,b){this._logger.log("debug","get states: "+JSON.stringify(a));a=new c(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(a)};k.prototype._getCommandQuest=function(a){console.log("pionner",
a);var b=a,d=null,c=a.indexOf(":");0<c&&(d=a.substr(0,c),a=a.substr(c+1));if("on"==a)b="zoneHD"==d?"ZEO":"zone3"==d?"BPO":"zone2"==d?"APO":"PO";else if("off"==a)b="zoneHD"==d?"ZEF":"zone3"==d?"BPF":"zone2"==d?"APF":"PF";else if("toggle"==a)b="zoneHD"==d?"ZEZ":"zone3"==d?"BPZ":"zone2"==d?"APZ":"PZ";else if("mute"==a)b="zoneHD"==d?"HZMO":"zone3"==d?"Z3MO":"zone2"==d?"Z2MO":"MO";else if("unmute"==a)b="zoneHD"==d?"HZMF":"zone3"==d?"Z3MF":"zone2"==d?"Z2MF":"MF";else if("toggleMute"==a)b="zoneHD"==d?"HZMZ":
"zone3"==d?"Z3MZ":"zone2"==d?"Z2MZ":"MZ";else if("volumeUp"==a)b="zoneHD"==d?"HZU":"zone3"==d?"YU":"zone2"==d?"ZU":"VU";else if("volumeDown"==a)b="zoneHD"==d?"HZD":"zone3"==d?"YD":"zone2"==d?"ZD":"VD";else if("BD"==a||"DVD"==a||"SAT/CBL"==a||"DVR/BDR"==a||"HDMI1"==a||"HDMI2"==a||"HDMI3"==a||"HDMI4"==a||"HDMI5"==a||"HDMI6"==a||"HDMI7"==a||"NETRADIO"==a||"Spotify"==a||"MEDIASERVER"==a||"FAVORITES"==a||"iPod/USB"==a||"TV"==a||"TUNER"==a||"BTAUDIO"==a||"CD"==a){switch(a){case "BD":b="25";break;case "DVD":b=
"04";break;case "SAT/CBL":b="06";break;case "DVR/BDR":b="15";break;case "HDMI1":b="19";break;case "HDMI2":b="20";break;case "HDMI3":b="21";break;case "HDMI4":b="22";break;case "HDMI5":b="23";break;case "HDMI6":b="24";break;case "HDMI7":b="34";break;case "NETRADIO":b="38";break;case "Spotify":b="53";break;case "MEDIASERVER":b="44";break;case "FAVORITES":b="45";break;case "iPod/USB":b="17";break;case "TV":b="05";break;case "TUNER":b="02";break;case "BTAUDIO":b="33";break;case "CD":b="01"}b="zoneHD"==
d?b+"ZEA":"zone3"==d?b+"ZT":"zone2"==d?b+"ZS":b+"FN"}else if("AUTO"==a||"MOVIE"==a||"MUSIC"==a||"GAME"==a||"ALC"==a||"DIRECT"==a||"PURE_DIRECT"==a||"F.S.SURR_FOCUS"==a||"DRAMA"==a||"ACTION"==a||"CLASSICAL"==a||"ROCK/POP"==a||"EXT_STEREO"==a||"ADV_GAME"==a||"SPORT"==a)"AUTO"==a?b="0006SR":"MOVIE"==a?b="0101SR":"MUSIC"==a?b="0041SR":"GAME"==a?b="0118SR":"ALC"==a?b="0151SR":"DIRECT"==a?b="0007SR":"PURE_DIRECT"==a?b="0008SR":"F.S.SURR_FOCUS"==a?b="0003SR":"DRAMA"==a?b="0103SR":"ACTION"==a?b="0101SR":
"CLASSICAL"==a?b="0107SR":"ROCK/POP"==a?b="0110SR":"EXT_STEREO"==a?b="0041SR":"ADV_GAME"==a?b="0118SR":"SPORT"==a&&(b="0117SR");else if("play"==a)switch(d){case "net":b="10NW"}else if("pause"==a)switch(d){case "net":b="11NW"}else if("stop"==a)switch(d){case "net":b="20NW"}else if("previous"==a)switch(d){case "net":b="12NW"}else if("next"==a)switch(d){case "net":b="13NW"}else if("enter"==a)switch(d){case "net":b="30NW"}else if("return"==a)switch(d){case "net":b="31NW"}else if("up"==a)switch(d){case "net":b=
"26NW"}else if("down"==a)switch(d){case "net":b="27NW"}else if("right"==a)switch(d){case "net":b="28NW"}else if("left"==a)switch(d){case "net":b="29NW"}else if(0==a.indexOf("setTone"))switch(a=a.replace(/setTone/g,""),d){case "mainzone":"ON"==a?b="1TO":"BYPASS"==a&&(b="0TO")}else if(0==a.indexOf("tuner"))a=a.replace(/tuner/g,""),b="Up"==a?"TPI":"Down"==a?"TPD":2==a.length?a.charAt(0)+"0"+a.charAt(1)+"PR":3==a.length?a+"PR":a.charAt(0)+"TP";else if(0==a.indexOf("bass"))if(a=a.replace(/bass/g,""),"Up"==
a)switch(d){case "mainzone":b="BI"}else if("Down"==a)switch(d){case "mainzone":b="BD"}else{a=a.replace(/To/g,"");a=a.replace(/%/g,"");a=parseInt(a);-6>a?a=-6:6<a&&(a=6);for(a=(6-a).toString();2>a.length;)a="0"+a;b=a+"BA"}else if(0==a.indexOf("treble"))if(a=a.replace(/treble/g,""),"Up"==a)switch(d){case "mainzone":b="TI"}else if("Down"==a)switch(d){case "mainzone":b="TD"}else{a=a.replace(/To/g,"");a=a.replace(/%/g,"");a=parseInt(a);-6>a?a=-6:6<a&&(a=6);for(a=(6-a).toString();2>a.length;)a="0"+a;b=
a+"TR"}else if(0==a.indexOf("setTo")||/^\d+$/.test(a))if(0==a.indexOf("setTo")&&(a=a.replace(/setTo/g,"")),a=a.replace(/%/g,""),"zone2"==d||"zone3"==d||"zoneHD"==d){b="ZV";"zone3"==d?b="YV":"zoneHD"==d&&(b="HZV");a=parseInt(a);-81>a?a=-81:0<a&&(a=0);for(a=(a+81).toString();2>a.length;)a="0"+a;b=a+b}else{a=parseFloat(a);-80.5>a?a=-80.5:12<a&&(a=12);for(a=((a+80.5)/.5).toString();3>a.length;)a="0"+a;b=a+"VL"}console.log("cmd",b);return b};k.STATUS_DPT_QUEST={audioMode:"?S","mainzone:power":"?P","mainzone:volume":"?V",
"mainzone:mute":"?M","mainzone:input":"?F","mainzone:tone":"?TO","mainzone:bass":"?BA","mainzone:treble":"?TR","zone2:power":"?AP","zone2:volume":"?ZV","zone2:mute":"?Z2M","zone2:input":"?ZS","zone3:power":"?BP","zone3:volume":"?YV","zone3:mute":"?Z3M","zone3:input":"?ZT","zoneHD:power":"?ZEP","zoneHD:volume":"?HZV","zoneHD:mute":"?HZM","zoneHD:input":"?ZEA"};k.prototype._getStateQuest=function(a){return a?k.STATUS_DPT_QUEST[a]:null};k.STATUS_RSP_PREFIX={"?S":"SR","?V":"VOL","?P":"PWR","?M":"MUT",
"?F":"FN","?TO":"TO","?BA":"BA","?TR":"TR","?AP":"APR","?ZV":"ZV","?ZS":"Z2F","?Z2M":"Z2MUT","?BP":"BPR","?YV":"YV","?ZT":"Z3F","?Z3M":"Z3MUT","?ZEP":"ZEP","?HZV":"XV","?HZM":"HZMUT","?ZEA":"ZEA"};k.prototype._getRspPrefix=function(a){return a?k.STATUS_RSP_PREFIX[a]:null};k.prototype._buildData=function(a){for(var b=[],d=0;d<a.length;d++)b.push(a.charCodeAt(d));b.push(13);return new Buffer(b)};k.prototype._resolveStatus=function(a){var b=function(a){if("string"==typeof a&&a)for(;"0"==a.charAt(0)&&
1<a.length;)a=a.substr(1);return parseInt(a)},d={mainzone:{},zone2:{},zone3:{},zoneHD:{}};if(0==a.indexOf("VOL"))d.mainzone.volume=.5*b(a.substr(3,3))-80.5;else if(0==a.indexOf("BA"))d.mainzone.bass=6-b(a.substr(2,2));else if(0==a.indexOf("TR"))d.mainzone.treble=6-b(a.substr(2,2));else if(0==a.indexOf("ZV")||0==a.indexOf("YV")||0==a.indexOf("XV")){var c=d.zone2;0==a.indexOf("YV")?c=d.zone3:0==a.indexOf("XV")&&(c=d.zoneHD);c.volume=b(a.substr(2,2))-81}else if(0==a.indexOf("PWR")||0==a.indexOf("APR")||
0==a.indexOf("BPR")||0==a.indexOf("ZEP"))c=d.mainzone,0==a.indexOf("APR")?c=d.zone2:0==a.indexOf("BPR")?c=d.zone3:0==a.indexOf("ZEP")&&(c=d.zoneHD),"0"==a.substr(3,1)?c.power="on":c.power="off";else if(0==a.indexOf("MUT")||0==a.indexOf("Z2MUT")||0==a.indexOf("Z3MUT")||0==a.indexOf("HZMUT"))c=d.mainzone,b=a.substr(3,1),0==a.indexOf("Z2MUT")?(c=d.zone2,b=a.substr(5,1)):0==a.indexOf("Z3MUT")?(c=d.zone3,b=a.substr(5,1)):0==a.indexOf("HZMUT")&&(c=d.zoneHD,b=a.substr(5,1)),c.mute="0"==b?"on":"off";else if(0==
a.indexOf("SR"))switch(a=a.trim(),a.substr(2)){case "0006":d.audioMode="AUTO";break;case "0101":d.audioMode="MOVIE";break;case "0041":d.audioMode="MUSIC";break;case "0118":d.audioMode="GAME";break;case "0151":d.audioMode="ALC";break;case "0007":d.audioMode="DIRECT";break;case "0008":d.audioMode="PURE_DIRECT";break;case "0003":d.audioMode="F.S.SURR_FOCUS";break;case "0103":d.audioMode="DRAMA";break;case "0107":d.audioMode="CLASSICAL";break;case "0110":d.audioMode="ROCK/POP";break;case "0117":d.audioMode=
"SPORT"}else if(0==a.indexOf("FN")||0==a.indexOf("Z2F")||0==a.indexOf("Z3F")||0==a.indexOf("ZEA"))switch(c=d.mainzone,b=a.substr(2),0==a.indexOf("Z2F")?(c=d.zone2,b=a.substr(3)):0==a.indexOf("Z3F")?(c=d.zone3,b=a.substr(3)):0==a.indexOf("ZEA")&&(c=d.zoneHD,b=a.substr(3)),b){case "25":c.input="BD";break;case "04":c.input="DVD";break;case "06":c.input="SAT/CBL";break;case "15":c.input="DVR/BDR";break;case "19":c.input="HDMI1";break;case "20":c.input="HDMI2";break;case "21":c.input="HDMI3";break;case "22":c.input=
"HDMI4";break;case "23":c.input="HDMI5";break;case "24":c.input="HDMI6";break;case "34":c.input="HDMI7";break;case "38":c.input="NETRADIO";break;case "53":c.input="Spotify";break;case "44":c.input="MEDIASERVER";break;case "45":c.input="FAVORITES";break;case "17":c.input="iPod/USB";break;case "05":c.input="TV";break;case "01":c.input="CD";break;case "02":c.input="TUNER";break;case "33":c.input="BTAUDIO"}else 0==a.indexOf("TO")&&(c=d.mainzone,"0"==a.substr(2,1)?c.tone="BYPASS":"1"==a.substr(2,1)&&(c.tone=
"ON"));return d};k.prototype._doCommandReq=function(a,b){this._packetBuffer.sendPacket(a,!0,b)};k.prototype._doStateReq=function(a,b){var d=this;this._packetBuffer.sendPacket(a,!1,function(a,c){a?b(a):(a=d._resolveStatus(c),b(null,a))})};k.prototype._sendPacket=function(a,b){if(this._socket){this._logger.log("trace","send packet:"+a);var d=this._buildData(a);this._socket.write(d,"binary");b()}else{var c=this;this._connect(function(d){d?b(d):c._sendPacket(a,b)})}};k.prototype._connect=function(a){this._socket&&
(this._socket.end(),this._socket=null);var b=this,d={port:this._port,host:this._ip},c=require("net").connect(d);c.setTimeout(1E3);c.__connected=!1;c.on("connect",function(){b._logger.log("trace","connect to pioneer avr:"+b._ip);c.__connected=!0;b._socket=c;a()});c.on("data",function(a){b._logger.log("trace","receive from pioneer avr "+(c.__disconnected?"(closed)":"")+":"+b._ip+" data:"+a);c.__disconnected||b._packetBuffer._onSocketData(a)});c.on("error",function(d){c.__connected?(b._logger.log("trace",
"pioneer avr"+(c.__disconnected?"(closed)":"")+":"+b._ip+" error:"+d.message),c.destroy(),c.__disconnected||(c.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketError(d))):(b._logger.log("trace","pioneer avr:"+b._ip+" connection error:"+d.message),a(d))});c.on("timeout",function(){c.__connected?(b._logger.log("trace","pioneer avr"+(c.__disconnected?"(closed)":"")+":"+b._ip+" data timeout"),c.__disconnected||b._packetBuffer._onSocketTimeout()):(b._logger.log("trace","pioneer avr:"+b._ip+" connection timeout"),
c.destroy&&c.destroy(),a(Error("timeout")))});c.on("close",function(){b._logger.log("trace","pioneer avr"+(c.__disconnected?"(closed)":"")+":"+b._ip+" close socket");c.__disconnected||(c.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketClose(c))});c._doConnect&&"function"==typeof c._doConnect&&c._doConnect();return c};k.prototype._disconnect=function(){this._logger.log("debug","disconnect socket");this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null)};k.prototype.toJSON=
function(){var a={sys:xnm.aio.pioneer.DM.SYS,type:"avr",ip:this._ip,port:this._port,uuid:this._uuid};this._name&&(a.name=this._name);this._model&&(a.model=this._model);return a};k.prototype.equalsTo=function(a){return a&&a instanceof k?this._ip==a._ip&&this._port==a._port:!1};k.parseJSON=function(a){return a.ip?new k(a.ip,a.port,a.uuid,a.name,a.model):null};return k}();
xnm.aio.pioneer.DM=function(){var e=function(c,e){this.code=c;this.message=e;this.stack=Error().stack};e.prototype=Error();e.prototype.name="PioneerDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var c={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"open pioneer iControlAV5",ref:{value:"openNative"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",
ref:{value:"tunerDown"}},{type:"enum",name:"set tuner to preset",ref:{value:"tuner",ext:"%e",extMeta:"A1 A2 A3 A4 A5 A6 A7 A8 A9 B1 B2 B3 B4 B5 B6 B7 B8 B9 C1 C2 C3 C4 C5 C6 C7 C8 C9 D1 D2 D3 D4 D5 D6 D7 D8 D9 E1 E2 E3 E4 E5 E6 E7 E8 E9 F1 F2 F3 F4 F5 F6 F7 F8 F9 G1 G2 G3 G4 G5 G6 G7 G8 G9".split(" ")}},{type:"enum",name:"set listening mode",ref:{value:"audioMode",ext:"%e",extMeta:"MOVIE MUSIC GAME AUTO ALC DIRECT PURE_DIRECT F.S.SURR_FOCUS DRAMA CLASSICAL ROCK/POP SPORT".split(" ")}},{type:"string",
name:"custom command",ref:{value:"customCMD",ext:"%s"}}]},{type:"root",name:"NET Radio",value:"net",children:[{type:"enum",name:"play",ref:{path:["global"],value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"enter",ref:{value:"enter"}},{type:"enum",name:"return",ref:{value:"return"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",
name:"down",ref:{value:"down"}},{type:"enum",name:"left",ref:{value:"left"}},{type:"enum",name:"right",ref:{value:"right"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"float",name:"volume to",ref:{value:"setTo",unit:"db",
ext:"%f",extMeta:"-80.5-12.0",scale:"0.5"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:["BYPASS","ON"]}},{type:"enum",name:"bass up",ref:{value:"bassUp"}},{type:"enum",name:"bass down",ref:{value:"bassDown"}},{type:"int",name:"bass to",ref:{value:"bassTo",unit:"db",ext:"%d",extMeta:"-6-6",scale:"1"}},{type:"enum",name:"treble up",ref:{value:"trebleUp"}},{type:"enum",name:"treble down",ref:{value:"trebleDown"}},{type:"int",name:"treble to",ref:{value:"trebleTo",unit:"db",ext:"%d",
extMeta:"-6-6",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",
name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",ext:"%d",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",
extMeta:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",
ref:{value:"setTo",ext:"%d",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},{type:"root",name:"zone HD",value:"zoneHD",children:[{type:"enum",name:"power on",
ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",ext:"%d",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",
ref:{value:"setInput",ext:"%e",extMeta:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]}],status:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"listening mode",ref:{value:"audioMode",options:["MOVIE","MUSIC","GAME","AUTO"]}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"float",name:"volume",ref:{value:"volume",unit:"db",extMeta:"-80.5-12.0",scale:"0.5"}},
{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}},{type:"enum",name:"tone",ref:{value:"tone",options:["ON","BYPASS"]}},{type:"int",name:"bass",ref:{value:"bass",unit:"db",extMeta:"-6-6",scale:"1"}},{type:"int",name:"treble",
ref:{value:"treble",unit:"db",extMeta:"-6-6",scale:"1"}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},
{type:"root",name:"zone 3",value:"zone3",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},{type:"root",name:"zone HD",value:"zoneHD",
children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]}]}};return{SYS:"pioneer",getIPDeviceType:function(){return[{sys:this.SYS,name:"Pioneer AV Receiver",
type:"avr"}]},createDevice:function(c,g,f){g=e.ERROR_CODE;c?c.ip?f(null,c):f(new e(g.INVALID,"ip is invalid")):f(new e(g.INVALID,"info is invalid"))},updateDevice:function(c,g,f){g=e.ERROR_CODE;c?c.ip?f(null,c):f(new e(g.INVALID,"ip is invalid")):f(new e(g.INVALID,"info is invalid"))},deleteDevice:function(c,e,f){f()},applyUIFilter:function(c,e,f){var h=function(a,b,c){var d=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var f=h(a.children,b,c);f&&0<f.length&&(a.children=
f,d.push(a))}else{f=c.elems;if("*"==f)f=!0;else{for(var e=!1,g=0;g<f.length;g++)if(f[g]==a.type){e=!0;break}f=e}f&&(a=JSON.parse(JSON.stringify(a)),d.push(a))}});return d},a=function(a,b){var c=[],d=xnm.aio.pioneer.DM.getCommandStatusMap(a,f);if(d){var e=[];switch(b.catagory){case "command":d.command&&(e=h(d.command,a,b));break;case "status":d.status&&(e=h(d.status,a,b))}c=c.concat(e)}return c};if(!c.sys)return null;var b=JSON.parse(JSON.stringify(c)),d=null;switch(e.catagory){case "command":d=a(c,
e);b.command=d;break;case "status":d=a(c,e);b.status=d;break;default:return null}return d&&0!=d.length?b:null},getCommandStatusMap:function(e){return e&&e.type?c[e.type]:null}}}();
xnm.aio.pioneer.Handler=function(){var e=function(){this.detected={}};e.prototype.devicemanager=xnm.aio.pioneer.DM;e.prototype.AVReceiver=xnm.aio.pioneer.AVReceiver;e.prototype.registModule=function(c){c.register(xnm.aio.pioneer.DM.SYS,"pioneer")};e.prototype.resolveDevice=function(c){if(!c)return null;switch(c.type){case "avr":return xnm.aio.pioneer.AVReceiver.parseJSON(c);default:return null}};e.prototype.getDeviceCommands=function(c,e){c=(c=xnm.aio.pioneer.DM.applyUIFilter(c,{catagory:"command",
elems:"*"}))?c.command:[];e&&e(null,c)};e.prototype.getDeviceStatus=function(c,e){c=(c=xnm.aio.pioneer.DM.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];e&&e(null,c)};e.prototype.doCommand=function(c,e,g){var f=this.resolveDevice(c);f?f.executeCommandCreator(c,e,function(c){g&&g(c)}):g&&g(Error("device json format invalid"))};e.prototype.doStatus=function(c,e,g,f){var h=this.resolveDevice(e);h?h.getStatesCreator(null,[{id:c,device:e,status:g}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):
f&&f(Error("device json format invalid"))};e.prototype.getDeviceCommandList=function(c,e,g){var f=[];if(e)f.push({id:window.XC_Text.on,cmd:"on"}),f.push({id:window.XC_Text.off,cmd:"off"});else if(g&&"avr"==c.type){c=[];c.push({id:"on",cmd:"on"});c.push({id:"off",cmd:"off"});c.push({id:"toggle",cmd:"toggle"});c.push({id:"volumeDown",cmd:"volumeDown"});c.push({id:"volumeUp",cmd:"volumeUp"});c.push({id:"set volume",cmd:"setTo",step:"1",max:"80"});c.push({id:"mute",cmd:"mute"});c.push({id:"unmute",cmd:"unmute"});
c.push({id:"toggleMute",cmd:"toggleMute"});c.push({id:"CBLSAT",cmd:"CBLSAT"});c.push({id:"BDDVD",cmd:"BDDVD"});c.push({id:"STRMBOX",cmd:"STRMBOX"});c.push({id:"GAME",cmd:"GAME"});c.push({id:"AUX",cmd:"AUX"});c.push({id:"PC",cmd:"PC"});c.push({id:"CD",cmd:"CD"});c.push({id:"TV",cmd:"TV"});c.push({id:"NET",cmd:"NET"});c.push({id:"BLUETOOTH",cmd:"BLUETOOTH"});c.push({id:"FM",cmd:"FM"});c.push({id:"AM",cmd:"AM"});c.push({id:"tunerUp",cmd:"tunerUp"});c.push({id:"tunerDown",cmd:"tunerDown"});c.push({id:"set tuner to",
cmd:"tuner",step:"1",min:"1",max:"40"});cl=c.length;for(e=0;e<cl;e++)g=JSON.parse(JSON.stringify(c[e])),g.ch="mainzone",f.push(g),g=JSON.parse(JSON.stringify(c[e])),g.ch="zone2",f.push(g);f.push({id:"MOVIE",cmd:"MOVIE"});f.push({id:"MUSIC",cmd:"MUSIC"});f.push({id:"GAME",cmd:"GAME"});f.push({id:"STEREO",cmd:"STEREO"});f.push({id:"play",cmd:"play"});f.push({id:"pause",cmd:"pause"});f.push({id:"stop",cmd:"stop"});f.push({id:"previous",cmd:"previous"});f.push({id:"next",cmd:"next"})}return f};e.prototype.discover=
function(c){var e=require("x.upnp.js");if(e){var g=this;e.discoverDevicesWithTimeout(3E3,function(e){if(e.manufacturer&&-1!=e.manufacturer.toLowerCase().indexOf("pioneer")&&e.modelName&&(-1!=e.modelName.toLowerCase().indexOf("vsx")||-1!=e.modelName.toLowerCase().indexOf("sc"))){var f=e.modelName,a=f.indexOf("/");-1!=a&&(f=f.substr(0,a));f=new xnm.aio.pioneer.AVReceiver(e.ip,0,e.uuid,e.name,f);g.detected[e.uuid]=f;c(f)}})}};e.prototype.discoverWithTimeout=function(c,e){var g={};this.discover(function(c){c&&
c._uuid&&!g[c._uuid]&&(g[c._uuid]=c)});setTimeout(function(){var c=[],h;for(h in g)g.hasOwnProperty(h)&&c.push(g[h]);e&&e(null,c)},c)};return e}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.pioneer.Handler);
