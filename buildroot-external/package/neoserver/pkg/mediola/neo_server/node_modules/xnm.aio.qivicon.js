var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.qivicon=xnm.aio.qivicon||{},xnm.aio.qivicon.SessionCache={_cache:{},getSessionID:function getSessionID(e){return e&&this._cache[e]?this._cache[e].sessionID:null;},getToken:function getToken(e){return e&&this._cache[e]?this._cache[e].token:null;},setSessionID:function setSessionID(e,t){if(e&&t){var n=this._cache[e];n||(this._cache[e]={},n=this._cache[e]),n.sessionID=t;}},setToken:function setToken(e,t){if(e&&t){var n=this._cache[e];n||(this._cache[e]={},n=this._cache[e]),n.token=t;}}},xnm.aio.qivicon.HomeBase=function(){var e=function e(_e,t,n,a,i){this._logger=require("x.logger.js").getLogger("xnm.aio.qivicon.HomeBase"),this.ip=_e,this.port=t,t||(this.port=443),this.user=n,this.password=a,this.uuid=i,this.CommandHandler=null;};return e.prototype._setSessionID=function(e){return xnm.aio.qivicon.SessionCache.setSessionID(this.ip,e);},e.prototype._getSessionID=function(){return xnm.aio.qivicon.SessionCache.getSessionID(this.ip);},e.prototype._setCachedToken=function(e){return xnm.aio.qivicon.SessionCache.setToken(this.ip,e);},e.prototype._getCachedToken=function(){return xnm.aio.qivicon.SessionCache.getToken(this.ip);},e.prototype._doRequest=function(e,t,n,a){var i={host:this.ip,port:this.port,path:t,method:e,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};n&&(i.headers["Content-Length"]=n.length),this._getSessionID()&&(i.headers.Cookie="JSESSIONID="+this._getSessionID()+"End"),this._getCachedToken()&&(i.headers.Authorization="Bearer "+this._getCachedToken());var o=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),this._logger.log("trace","do request:"+JSON.stringify(i));var s=this,r=a,c=o.request(i,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){s._logger.log("trace","receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t),r&&(r(null,t,e),r=null);});});c.on&&c.on("error",function(e){r&&(r(e),r=null);}),c.setTimeout&&c.setTimeout(2e3,function(){s._logger.log("trace","do request timeout"),c.abort(),r&&(r(new Error("timeout")),r=null);}),c.setAllowRedirect&&c.setAllowRedirect(!1),n&&("/system/http/login"==t?this._logger.log("trace","do request send body:u=xxxxxx&p=xxxxxx"):this._logger.log("trace","do request send body:"+n),c.write(n)),c.end();},e.prototype._sendRequest=function(e,t,n,a){var i=this;this._doRequest(e,t,n,function(o,s,r){o?a&&a(o):r&&401==r.statusCode?i._login(function(o){o?a&&a(o):i._sendRequest(e,t,n,a);}):(o=r&&200==r.statusCode?null:new Error("http error"),a&&a(o,s));});},e.prototype._doJSONRPC=function(e,t){var n=JSON.stringify(e);this._sendRequest("POST","/remote/json-rpc",n,function(e,n){if(e||!n)return e||n||(e=new Error("response text invalid")),void(t&&t(e));var a=null;try{a=JSON.parse(n);}catch(t){e=t;}t&&t(e,a);});},e.prototype._getToken=function(e){var t=this;this._doRequest("GET","/dashboard/system.app.basicclient/index.html",null,function(n,a){var i;if(a){var o=a.indexOf(' data-access-token="');if(o>0){var s=(a=a.substring(o+20)).indexOf('" ');s>0&&(i=a.substring(0,s));}}i?t._setCachedToken(i):n=new Error("get token response error"),e&&e(n,i);});},e.prototype._login=function(e){var t="u="+encodeURIComponent(this.user)+"&p="+encodeURIComponent(this.password),n=this;this._doRequest("POST","/system/http/login",t,function(t,a,i){if(t)e&&e(t);else{if(i&&302==i.statusCode){var o=null;if(i.headers&&i.headers["set-cookie"]){var s=i.headers["set-cookie"];s.constructor===Array&&(s=s[0]);var r=s.indexOf("End;");0==s.indexOf("JSESSIONID=")&&r>0&&(o=s.substring(11,r));}if(o)return n._setSessionID(o),void n._getToken(function(t){e&&e(t);});}e&&e(new Error("login error"));}});},e.prototype._executeCommand=function(e,t,n,a,i){var o=[{jsonrpc:"2.0",method:"BasicClientJsonRpc/processDevice",params:[e,t,n,JSON.parse(a)]}];this._doJSONRPC(o,function(e){i&&i(e);});},e.prototype.getDevices=function(e){this._doJSONRPC([{jsonrpc:"2.0",method:"BasicClientJsonRpc/getAllRooms",id:"mk98-4",params:[]},{jsonrpc:"2.0",method:"BasicClientJsonRpc/getAllDevices",id:"mk98-6",params:[]}],function(t,n){if(t)e&&e(t);else{var a={};if(n&&n.length>0)for(var i=0;i<n.length;i++){var o=n[i];if(o.result){if(o.result.devices)for(var s=0;s<o.result.devices.length;s++){var r=o.result.devices[s];if(r.roomId){a[r.roomId]||(a[r.roomId]={}),a[r.roomId].devices||(a[r.roomId].devices={});var c={channels:{}};if(c.name=r.name,c.state=r.status,r.compoundType&&r.compoundType.id&&(c.address=r.compoundType.id),r.compoundType&&r.compoundType.deviceTypeName&&(c.type=r.compoundType.deviceTypeName),r.compoundType&&r.compoundType.types)for(var u=r.compoundType.types,l=0;l<u.length;l++)if(u[l].states){for(var d=u[l].id,m=u[l].deviceClassName,p={},v=0;v<u[l].states.length;v++){var f=u[l].states[v];f.name&&null!=f.value&&(p[f.name]=f.value);}if(d&&m)if(c.channels[m]){for(var h=1,y=m;c.channels[m];)m=y+"@"+ ++h;c.channels[m]={address:d,state:p,type:u[l].deviceTypeName};}else c.channels[m]={address:d,state:p,type:u[l].deviceTypeName};}a[r.roomId].devices[r.id]=c;}}if(o.result.rooms)for(s=0;s<o.result.rooms.length;s++){var w=o.result.rooms[s];a[w.id]||(a[w.id]={}),a[w.id].name=w.name,a[w.id].devices={};}}}e&&e(null,a);}});},e.prototype.executeCommand=function(e,t,n){var a=e.address,i=null,o=null,s="[]";"on"==t?(o="turnOn",i="binarySwitch"):"off"==t?(o="turnOff",i="binarySwitch"):"toggle"==t?(o=t,i="binarySwitch"):"dimUp"==t?(o="stepUp",i="multiLevelSwitch"):"dimDown"==t?(o="stepDown",i="multiLevelSwitch"):"stopMovement"==t?(o=t,i="blinds"):0==t.indexOf("dimTo")?(o="setLevel",i="multiLevelSwitch",s='["'+(t=parseInt(t.replace(/dimTo/g,"")))+'"]'):0==t.indexOf("moveTo")?(o="setLevel",i="blinds",s='["'+(t=parseInt(t.replace(/moveTo/g,"")))+'"]'):0==t.indexOf("setTo")&&("0"!=(t=t.replace(/setTo/g,""))&&"100"!=t&&(t=(parseFloat(t)/2).toFixed(1)),o="setTemperature",i="temperatureActuator",s='["'+t+'"]'),i&&o?(e.channels&&e.channels[i]&&e.channels[i].address&&(a=e.channels[i].address),this._executeCommand(a,i,o,s,n)):n&&n();},e.prototype.getStates=function(e,t,n){this.CommandHandler=e,this.getDevices(function(e,a){var i={};for(var o in a)for(var s in a[o].devices)for(var r=0;r<t.length;r++){var c=t[r];if(c.address==s){for(var u in c.id||(c.id=s),i[c.id]={},a[o].devices[s].channels)for(var l in i[c.id][u]={},a[o].devices[s].channels[u].state)i[c.id][u][l]=a[o].devices[s].channels[u].state[l];"2"==a[o].devices[s].state?i[c.id].reachable=!0:i[c.id].reachable=!1;break;}}n&&n(i);});},e.prototype.getStateValues=function(e,t){return t;},e.prototype.executeCommandCreator=function(e,t,n){if(e&&e.address&&e.channels){if(t&&t.value){var a=t.value;if("dimTo"==t.value){if(void 0===t.ext||null==t.ext)return void(n&&n(new Error("command dimTo ext format invalid")));a=t.value+t.ext;}else if("setTo"==t.value){if(void 0===t.ext||null==t.ext)return void(n&&n(new Error("command setTo ext format invalid")));var i=parseFloat(t.ext);a=t.value+2*i;}else if("moveTo"==t.value){if(void 0===t.ext||null==t.ext)return void(n&&n(new Error("command moveTo ext format invalid")));a=t.value+t.ext;}this.executeCommand(e,a,function(e){n&&n(e);});}else n&&n(new Error("command json format invalid"));}else n&&n(new Error("device json format invalid"));},e.prototype.getStatesCreator=function(e,t,n){if(t){if(0!=t.length){for(var a=this,i=[],o=0;o<t.length;o++)if(t[o]&&t[o].device&&t[o].device.address){for(var s=t[o].device.address,r=!1,c=0;c<i.length;c++)if(i[c].address==s){r=!0;break;}r||i.push(t[o].device);}this.getStates(e,i,function(e){var i=[];if(e)for(var o=0;o<t.length;o++)if(t[o]&&t[o].id){var s="?";t[o].device&&t[o].device.address&&t[o].status&&t[o].status.value&&e[t[o].device.address]&&(s=a._resolveState(e[t[o].device.address],t[o].status,t[o].device)),s||(s="?"),i.push({id:t[o].id,status:s});}n&&n(null,i);});}else n&&n(null,[]);}else n&&n(new Error("deviceList is null"));},e.prototype._resolveState=function(e,t,n){if(!e||!t||!t.value)return null;var a,i,o,s=e;switch(t.value){case"switchState":"0"==(a=(e=s.binarySwitch).state)?a="off":"1"==a&&(a="on");break;case"dimState":(a=(e=s.multiLevelSwitch).level)&&(a=parseInt(a));break;case"tempSet":(a=(e=s.temperatureActuator).temperature)&&(a=parseFloat(a).toFixed(1));break;case"currentTemp":if(i="multiLevelSensor",n&&n.channels)for(o in n.channels)if(n.channels.hasOwnProperty(o)&&n.channels[o]&&"TemperatureSensor"==n.channels[o].type){i=o;break;}(a=(e=s[i]).value)&&(a=parseFloat(a).toFixed(1));break;case"currentHum":if(i="multiLevelSensor",n&&n.channels)for(o in n.channels)if(n.channels.hasOwnProperty(o)&&n.channels[o]&&"HumiditySensor"==n.channels[o].type){i=o;break;}(a=(e=s[i]).value)&&(a=parseInt(a));break;case"currentBri":if(i="multiLevelSensor",n&&n.channels)for(o in n.channels)if(n.channels.hasOwnProperty(o)&&n.channels[o]&&"MotionDetector"==n.channels[o].type){i=o;break;}(a=(e=s[i]).value)&&(a=parseInt(a));break;case"waterState":if(i="multiLevelSensor",n&&n.channels)for(o in n.channels)if(n.channels.hasOwnProperty(o)&&n.channels[o]&&"WaterSensor"==n.channels[o].type){i=o;break;}(a=(e=s[i]).value)&&(a=parseInt(a)),1==a?a="dry":2==a?a="wet":3==a&&(a="water");break;case"blindState":(a=(e=s.blinds).level)&&(a=parseInt(a));break;case"meterTotalPower":(a=(e=s.meter).total)&&(a=(1e3*parseFloat(a)).toFixed(2));break;case"meterCurrentPower":(a=(e=s.meter).current)&&(a=(1e3*parseFloat(a)).toFixed(2));break;case"contactState":a="true"==(a=(e=s.binarySensor).state)?"open":"closed";break;case"motionState":a="true"==(a=(e=s.binarySensor).state)?"on":"off";break;case"binaryState":a=(e=s.binarySensor).state;break;case"reachable":a=e.reachable;break;default:return null;}return a;},e.prototype.toJSON=function(){return{sys:xnm.aio.qivicon.DM.SYS,ip:this.ip,port:this.port,username:this.user,password:this.password,uuid:this.uuid};},e.prototype.equalsTo=function(t){return!!t&&t instanceof e&&this.ip==t.ip&&this.port==t.port&&this.user==t.user&&this.password==t.password;},e;}(),xnm.aio.qivicon.DM=function(){var e=function e(_e2,t){this.code=_e2,this.message=t,this.stack=new Error().stack;};return(e.prototype=new Error()).name="QiviconDMError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"qivicon",MAP:{binarySwitch:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",options:["on","off"]}}]},multiLevelSwitch:{command:[{type:"enum",name:"dim up",ref:{value:"dimUp"}},{type:"enum",name:"dim down",ref:{value:"dimDown"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"dim level",ref:{value:"dimState",extMeta:"0-100"}}]},temperatureActuator:{command:[{type:"float",name:"temperature",ref:{value:"setTo",ext:"%f",extMeta:"5.0-30.0",scale:"0.5"}}],status:[{type:"float",name:"set temperature",ref:{value:"tempSet",extMeta:"5.0-30.0",scale:"0.5"}}]},multiLevelSensor:{},binarySensor:{},blinds:{command:[{type:"enum",name:"blind stop",ref:{value:"stopMovement"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"blind position",ref:{value:"blindState",extMeta:"0-100"}}]},meter:{status:[{type:"float",name:"total power",ref:{value:"meterTotalPower"}},{type:"float",name:"current power",ref:{value:"meterCurrentPower"}}]},general:{status:[{type:"enum",name:"reachable",ref:{value:"reachable",options:["true","false"]}}]}},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"QIVICON / Magenta SmartHome",port:443}];},getGatewayDeviceType:function getGatewayDeviceType(){return[{sys:this.SYS,type:"OnOffSocket",name:"Switch"},{sys:this.SYS,type:"Thermostat",name:"Thermostat"},{sys:this.SYS,type:"ColorLight",name:"Color Light"},{sys:this.SYS,type:"BlindsUnit",name:"Blind"},{sys:this.SYS,type:"OnOffMeter",name:"Power Meter Swicth"}];},createGateway:function createGateway(t,n,a){var i=e,o=e.ERROR_CODE;t?t.ip?t.username?t.password?a(null,t):a(new i(o.INVALID,"password is invalid")):a(new i(o.INVALID,"username is invalid")):a(new i(o.INVALID,"ip is invalid")):a(new i(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(t,n,a,i){var o=e,s=e.ERROR_CODE;n?n.ip?n.username?n.password?i(null,n):i(new o(s.INVALID,"password is invalid")):i(new o(s.INVALID,"username is invalid")):i(new o(s.INVALID,"ip is invalid")):i(new o(s.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(t,n,a){var i=e,o=e.ERROR_CODE;if(t){if(t.gateway){if(t.address){if(t.type){if(t.channels){if(n.data&&n.data.gateways&&0!==n.data.gateways.length){var s,r,c=n.data.gateways;for(s=0;s<c.length;s++)if(c[s].index===t.gateway){r=c[s];break;}r?a(null,t):a(new i(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new i(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new i(o.INVALID,"channels is invalid"));}else a(new i(o.INVALID,"type is invalid"));}else a(new i(o.INVALID,"address is invalid"));}else a(new i(o.INVALID,"gateway is invalid"));}else a(new i(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,n,a){var i=e,o=e.ERROR_CODE;if(t){if(t.gateway){if(t.address){if(t.type){if(t.channels){if(n.data&&n.data.gateways&&0!==n.data.gateways.length){var s,r,c=n.data.gateways;for(s=0;s<c.length;s++)if(c[s].index===t.gateway){r=c[s];break;}r?a(null,t):a(new i(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new i(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new i(o.INVALID,"channels is invalid"));}else a(new i(o.INVALID,"type is invalid"));}else a(new i(o.INVALID,"address is invalid"));}else a(new i(o.INVALID,"gateway is invalid"));}else a(new i(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t){var n=this,a=function a(e,t){if("*"==e)return!0;for(var n=!1,a=0;a<e.length;a++)if(e[a]==t){n=!0;break;}return n;},i=function i(e,t){var i=[],o=null,s=n.getCommandStatusMap(e);return s&&(o=function(e,t,n){var i=[];switch(n.catagory){case"command":e.command&&e.command.forEach(function(e){if(a(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));i.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(a(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));i.push(t);}});}return i;}(s,0,t),i=i.concat(o)),i;};if(!e||null==e.type||void 0===e.type)return null;var o=JSON.parse(JSON.stringify(e)),s=null;switch(t.catagory){case"command":s=i(e,t),o.command=s;break;case"status":s=i(e,t),o.status=s;break;default:return null;}return s&&0!=s.length?o:null;},getCommandStatusMap:function getCommandStatusMap(e){if(!e||!e.channels)return null;var t={command:[],status:[]};for(var n in e.channels)if(n&&e.channels.hasOwnProperty(n)){var a=e.channels[n],i=n.indexOf("@");-1!=i&&(n=n.substr(0,i));var o=this.MAP[n];if(!o)continue;var s=e.type;if(a.type&&(s=a.type),"multiLevelSensor"==n){"Thermostat"==s||"TemperatureSensor"==s?t.status=t.status.concat([{type:"float",name:"current temperature",ref:{value:"currentTemp"}}]):"HumiditySensor"==s?t.status=t.status.concat([{type:"int",name:"current humidity",ref:{value:"currentHum"}}]):"MotionDetector"==s?t.status=t.status.concat([{type:"int",name:"current brightness",ref:{value:"currentBri"}}]):"WaterSensor"==s&&(t.status=t.status.concat([{type:"enum",name:"water state",ref:{value:"waterState",options:["dry","wet","water"]}}]));continue;}if("binarySensor"==n){t.status="ContactDetector"==s?t.status.concat([{type:"enum",name:"state",ref:{value:"contactState",options:["open","closed"]}}]):"MotionDetector"==s?t.status.concat([{type:"enum",name:"motion state",ref:{value:"motionState",options:["on","off"]}}]):t.status.concat([{type:"enum",name:"sensor state",ref:{value:"binaryState",options:["true","false"]}}]);continue;}o&&o.command&&(t.command=t.command.concat(o.command)),o&&o.status&&(t.status=t.status.concat(o.status));}return t.status=t.status.concat(this.MAP.general.status),t;}};}(),xnm.aio.qivicon.Handler=function(){this.detectedHomebases={};},xnm.aio.qivicon.Handler.prototype.HomeBase=xnm.aio.qivicon.HomeBase,xnm.aio.qivicon.Handler.prototype.devicemanager=xnm.aio.qivicon.DM,xnm.aio.qivicon.Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"qivicon");},xnm.aio.qivicon.Handler.prototype.resolveGateway=function(e){return e&&e.ip?new xnm.aio.qivicon.HomeBase(e.ip,e.port,e.username,e.password,e.uuid):null;},xnm.aio.qivicon.Handler.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),a=n?n.command:[];t&&t(null,a);},xnm.aio.qivicon.Handler.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),a=n?n.status:[];t&&t(null,a);},xnm.aio.qivicon.Handler.prototype.doCommand=function(e,t,n,a){var i=this.resolveGateway(e);i?i.executeCommandCreator(t,n,function(e){a&&a(e);}):a&&a(new Error("gateway json format invalid"));},xnm.aio.qivicon.Handler.prototype.doStatus=function(e,t,n,a,i){var o=this.resolveGateway(t);if(o){var s=[{id:e,device:n,status:a}];o.getStatesCreator(null,s,function(e,t){e?i&&i(e):i&&i(null,t[0]);});}else i&&i(new Error("gateway json format invalid"));},xnm.aio.qivicon.Handler.prototype.discoverWithTimeout=function(e,t){var n={};this.discoverHomeBases(function(e){e&&e.uuid&&!n[e.uuid]&&(n[e.uuid]=e);}),setTimeout(function(){var e=[];for(var a in n)n.hasOwnProperty(a)&&e.push(n[a]);t&&t(null,e);},e);},xnm.aio.qivicon.Handler.prototype.discoverHomeBases=function(e){var t=require("x.upnp.js");if(t){var n=this;t.discoverDevices(function(t){if(0==t.name.toLowerCase().indexOf("qivicon")){var a=new xnm.aio.qivicon.HomeBase(t.ip,443,null,null,t.uuid);n.detectedHomebases["uuid:"+t.uuid]||(n.detectedHomebases["uuid:"+t.uuid]=a),e(a);}});}},xnm.aio.qivicon.Handler.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getDevices(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},xnm.aio.qivicon.Handler.prototype.getStateValues=function(e,t){return new xnm.aio.qivicon.HomeBase().getStateValues(e.type,t);},xnm.aio.qivicon.Handler.prototype.getDeviceCommandList=function(e,t,n){var a=[];if(t)a.push({id:window.XC_Text.on,cmd:"on"}),a.push({id:window.XC_Text.off,cmd:"off"});else if(n&&e.channels)for(var i in e.channels)"binarySwitch"==i?(a.push({id:"on",cmd:"on"}),a.push({id:"off",cmd:"off"}),a.push({id:"toggle",cmd:"toggle"})):"multiLevelSwitch"==i?(a.push({id:"dimUp",cmd:"dimUp"}),a.push({id:"dimDown",cmd:"dimDown"}),a.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"})):"temperatureActuator"==i?a.push({id:"setTo",cmd:"setTo",step:"0.5",min:"5",max:"30",fact:"2"}):"blinds"==i&&(a.push({id:"moveTo",cmd:"moveTo",step:"1",min:"0",max:"100"}),a.push({id:"stop",cmd:"stopMovement"}));return a;},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.qivicon.Handler());