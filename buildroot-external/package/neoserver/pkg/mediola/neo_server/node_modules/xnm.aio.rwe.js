var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(d,b,a){d instanceof String&&(d=String(d));for(var c=d.length,e=0;e<c;e++){var f=d[e];if(b.call(a,f,e,d))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,b,a){if(d==Array.prototype||d==Object.prototype)return d;d[b]=a.value;return d};$jscomp.getGlobal=function(d){d=["object"==typeof globalThis&&globalThis,d,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<d.length;++b){var a=d[b];if(a&&a.Math==Math)return a}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(d,b){var a=$jscomp.propertyToPolyfillSymbol[b];if(null==a)return d[b];a=d[a];return void 0!==a?a:d[b]};
$jscomp.polyfill=function(d,b,a,c){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(d,b,a,c):$jscomp.polyfillUnisolated(d,b,a,c))};$jscomp.polyfillUnisolated=function(d,b,a,c){a=$jscomp.global;d=d.split(".");for(c=0;c<d.length-1;c++){var e=d[c];if(!(e in a))return;a=a[e]}d=d[d.length-1];c=a[d];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(a,d,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(d,b,a,c){var e=d.split(".");d=1===e.length;c=e[0];c=!d&&c in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<e.length-1;f++){var h=e[f];if(!(h in c))return;c=c[h]}e=e[e.length-1];a=$jscomp.IS_SYMBOL_NATIVE&&"es6"===a?c[e]:null;b=b(a);null!=b&&(d?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==a&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&($jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(e):
$jscomp.POLYFILL_PREFIX+e),$jscomp.defineProperty(c,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:b})))};$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(b,a){return $jscomp.findInternal(this,b,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rwe=xnm.aio.rwe||{};
xnm.aio.rwe.Cache={STATUS_EXPIRE_TO:3E5,_cache:{},_statusBuffer:{},_stateMachine:{},_centralBuffer:{},_getCache:function(d){return d?this._cache[d]:null},_ensureCache:function(d){if(!d)return null;this._cache[d]||(this._cache[d]={});return this._cache[d]},_getStateMachine:function(d){return d?this._stateMachine[d]:null},_ensureStateMachine:function(d){if(!d)return null;this._stateMachine[d]||(this._stateMachine[d]={state:0,loginCallbacks:[]});return this._stateMachine[d]},_getStateBuffer:function(d){return d?
this._statusBuffer[d]:null},_ensureStateBuffer:function(d){if(!d)return null;this._statusBuffer[d]||(this._statusBuffer[d]={});return this._statusBuffer[d]},setSessionID:function(d,b){if(!d)return null;d=this._ensureCache(d);if(!d)return null;d.sessionID=b},getSessionID:function(d){return d?(d=this._getCache(d))?d.sessionID:null:null},setCurrentConfig:function(d,b){if(!d)return null;d=this._ensureCache(d);if(!d)return null;d.currentConfig=b},getCurrentConfig:function(d){return d?(d=this._getCache(d))?
d.currentConfig:null:null},setVersion:function(d,b){if(!d)return null;d=this._ensureCache(d);if(!d)return null;d.version=b},getVersion:function(d){return d?(d=this._getCache(d))&&d.version?d.version:"1.70":null},setStateMachineState:function(d,b){d&&(d=this._ensureStateMachine(d))&&(d.state=b?b:0)},getStateMachineState:function(d){return d?(d=this._getStateMachine(d))&&d.state?d.state:0:null},addLoginCallback:function(d,b){if(!d||!b)return null;if(d=this._ensureStateMachine(d))d.loginCallbacks||(d.loginCallbacks=
[]),d.loginCallbacks.push(b)},getLoginCallbacks:function(d){return d?(d=this._getStateMachine(d))?d.loginCallbacks:null:null},clearLoginCallbacks:function(d){if(!d)return null;if(d=this._getStateMachine(d))d.loginCallbacks=[]},setCentral:function(d,b){if(!d)return null;this._centralBuffer[d]=b},getCentral:function(d){return this._centralBuffer[d]},setStatusBuffer:function(d,b){if(!d)return null;var a=this._ensureStateBuffer(d);if(a){var c=this;null==a.timer&&(a.timer=setInterval(function(){var e=
c.getCentral(d);e&&e.refreshStates()},2E3));a.status=b;a.timestamp=(new Date).getTime()}},getStatusBuffer:function(d){if(!d)return null;var b=(new Date).getTime(),a=this._ensureStateBuffer(d);if(!a.status)return a.status={},a.timestamp=b,null;if(a.timestamp&&-a.timestamp>this.STATUS_EXPIRE_TO)return a.timestamp=b,null;var c=this;null==a.timer&&(a.timer=setInterval(function(){var e=c.getCentral(d);e&&e.refreshStates()},2E3));return a.status},updateStatusBuffer:function(d,b){if(!d||!b)return null;d=
this._ensureStateBuffer(d);d.status||(d.status={});var a=!1,c;for(c in b)b.hasOwnProperty(c)&&b[c]&&(a=!0,d.status[c]=b[c]);a&&(d.timestamp=(new Date).getTime())},getSingleBufferedStatus:function(d,b){if(!d||!b)return null;d=this._ensureStateBuffer(d);return d.status?d.status[b]:null},finalize:function(d){var b=(new Date).getTime()-24E4,a;for(a in this._statusBuffer)if(this._statusBuffer.hasOwnProperty(a)){var c=this._statusBuffer[a];c&&(c.timer&&(clearInterval(c.timer),c.timer=null),c.timestamp=
b)}d&&d()}};
xnm.aio.rwe.Central=function(){var d=function(b,a,c,e){this._logger=require("x.logger.js").getLogger("xnm.aio.rwe.Central");this.ip=b;this.port=a;a||(this.port=443);this.user=c;this.password=e;this._clientID=this._generateGUID();this.CommandHandler=null};d.DEVICE_TYPE_LIST="SwitchActuator DimmerActuator RollerShutterActuator RoomHumiditySensor RoomTemperatureSensor RoomTemperatureActuator AlarmActuator WindowDoorSensor SmokeDetectionSensor GenericActuator".split(" ");d.prototype._getSessionID=function(){return xnm.aio.rwe.Cache.getSessionID(this.ip)};
d.prototype._setSessionID=function(b){return xnm.aio.rwe.Cache.setSessionID(this.ip,b)};d.prototype._getCurrentConfig=function(){return xnm.aio.rwe.Cache.getCurrentConfig(this.ip)};d.prototype._setCurrentConfig=function(b){return xnm.aio.rwe.Cache.setCurrentConfig(this.ip,b)};d.prototype._getVersion=function(){return xnm.aio.rwe.Cache.getVersion(this.ip)};d.prototype._setVersion=function(b){return xnm.aio.rwe.Cache.setVersion(this.ip,b)};d.prototype._getStateMachineState=function(){return xnm.aio.rwe.Cache.getStateMachineState(this.ip)};
d.prototype._setStateMachineState=function(b){xnm.aio.rwe.Cache.setStateMachineState(this.ip,b)};d.prototype._addLoginCallback=function(b){xnm.aio.rwe.Cache.addLoginCallback(this.ip,b)};d.prototype._getLoginCallbacks=function(){return xnm.aio.rwe.Cache.getLoginCallbacks(this.ip)};d.prototype._clearLoginCallbacks=function(){xnm.aio.rwe.Cache.clearLoginCallbacks(this.ip)};d.prototype._setBufferedCentral=function(){xnm.aio.rwe.Cache.setCentral(this.ip,this)};d.prototype._getStatusBuffer=function(){return xnm.aio.rwe.Cache.getStatusBuffer(this.ip)};
d.prototype._setStatusBuffer=function(b){xnm.aio.rwe.Cache.setStatusBuffer(this.ip,b)};d.prototype._updateStatusBuffer=function(b){xnm.aio.rwe.Cache.updateStatusBuffer(this.ip,b)};d.prototype._getSingleBufferedStatus=function(b){return xnm.aio.rwe.Cache.getSingleBufferedStatus(this.ip,b)};d.prototype._generateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var a=16*Math.random()|0;return("x"==b?a:a&3|8).toString(16)})};d.prototype._parseDeviceData=function(b){var a=
{},c={},e={},f={};b.find("LC").each(function(){var l=$(this),n=l.find("Name");l=l.find("Id");n&&l&&(c[$(l[0]).text()]={name:$(n[0]).text(),devices:{}})});b.find("BD").each(function(){var l=$(this).find("Id");l&&(e[$(l[0]).text()]={address:$(l[0]).text(),channels:{}})});b.find("LD").each(function(){var l=$(this),n=l.attr("xsi:type");if(n){var m=l.attr("Name"),p=l.attr("LCID"),q=l.find("BDId");q=q&&0<q.length?$(q[0]).text():null;var r=l.find("UDvIds");r=r&&0<r.length?(r=$(r[0]).find("guid"))&&0<r.length?
$(r[0]).text():null:null;var t=l.find("Id");t=t&&0<t.length?$(t[0]).text():null;n={name:m,type:n,address:t,bid:q,udvid:r,lid:p};(l=l.find("ActCls"))&&0<l.length&&(n.data=$(l[0]).text());f[t]=n}});for(var h in f)if(f.hasOwnProperty(h)){var g=f[h];if(g.type&&-1!=d.DEVICE_TYPE_LIST.indexOf(g.type)&&g.lid&&c[g.lid])if("GenericActuator"==g.type&&g.address)c[g.lid].devices[g.address]={address:g.address,channels:{}},b=c[g.lid].devices[g.address],delete g.bid,delete g.udvid,delete g.lid,b.channels[g.address]=
g;else{var k=g.bid;!k&&g.udvid&&f[g.udvid]&&f[g.udvid].bid&&(k=f[g.udvid].bid);k&&e[k]&&g.address&&(b=c[g.lid].devices[k],b||(c[g.lid].devices[k]=e[k],b=c[g.lid].devices[k]),delete g.bid,delete g.udvid,delete g.lid,b.channels[g.address]=g)}}a.data=c;return a};d.prototype._parseMessageData=function(b){var a={},c={};b.find("MessageContainer").each(function(){var e=$(this),f=e.attr("State");if(e=e.find("Message")){e=$(e[0]);var h=e.attr("Id"),g=e.attr("Type"),k=e.attr("TimeStamp");if(h&&g&&k){c[h]={type:g,
time:k,read:"Read"==f};var l={};e.find("MessageParameter").each(function(){var n=$(this),m=n.attr("Key");n=n.attr("Value");m&&n&&(l[m]=n)});c[h].params=l}}});a.data=c;return a};d.prototype._parseDeviceStateData=function(b){var a={},c={};b.find("LogicalDeviceState").each(function(){var e=$(this),f=e.attr("LID"),h=e.attr("xsi:type");if(f&&h){var g=null;if("SwitchActuatorState"==h){g={state:"?"};var k=e.attr("IsOn");"True"==k?g.state="on":"False"==k&&(g.state="off")}else if("DimmerActuatorState"==h)g=
{state:"?"},k=e.attr("DmLvl")||"0","string"==typeof k&&0<k.length&&(g.state=parseInt(k));else if("RollerShutterActuatorState"==h)g={state:"?"},(e=e.find("ShutterLevel"))&&0<e.length&&(g.state=parseInt($(e[0]).text())||0);else if("RoomHumiditySensorState"==h)g={state:"?"},k=e.attr("Humidity"),"string"==typeof k&&0<k.length&&(g.state=k);else if("RoomTemperatureSensorState"==h)g={state:"?"},k=e.attr("Temperature"),"string"==typeof k&&0<k.length&&(g.state=parseFloat(k).toFixed(1));else if("RoomTemperatureActuatorState"==
h)g={state:"?"},k=e.attr("PtTmp"),"string"==typeof k&&0<k.length&&(g.state=parseFloat(k).toFixed(1)),k=e.attr("OpnMd"),"string"==typeof k&&0<k.length&&(g.mode=k.toLowerCase());else if("AlarmActuatorState"==h)g={state:"?"},(k=e.attr("IsOn"))&&(k=k.toLowerCase()),"true"==k?g.state="on":"false"==k&&(g.state="off");else if("WindowDoorSensorState"==h)g={state:"?"},(e=e.find("IsOpen"))&&0<e.length&&((k=$(e[0]).text())&&(k=k.toLowerCase()),"true"==k?g.state="open":"false"==k&&(g.state="closed"));else if("SmokeDetectionSensorState"==
h)g={state:"?"},(e=e.find("IsSmokeAlarm"))&&0<e.length&&((k=$(e[0]).text())&&(k=k.toLowerCase()),"true"==k?g.state="on":"false"==k&&(g.state="off"));else if("GenericDeviceState"==h){g={state:"?"};var l=e.find("Ppt");if(l&&0<l.length){l=$(l[0]);e=l.attr("xsi:type");k=l.attr("Name");l=l.attr("Value");if("undefined"==typeof l||null==l)l="?";"string"==typeof e&&0<e.length&&"string"==typeof k&&0<k.length&&"string"==typeof l&&("BooleanProperty"==e?(g.state=l.toLowerCase(),h="BooleanProperty:Value"):(g.state=
l,h=e+":"+k))}}g&&(c[f]={state:g,type:h})}});a.data=c;return a};d.prototype._parseResult=function(b){var a={};b=$($($.parseXML(b)).children()[0]);if(!b)return a.error="invalid reponse",a;if("NotificationList"==b.prop("tagName"))a=this._parseDeviceStateData(b);else switch(b.attr("xsi:type")){case "AuthenticationErrorResponse":a.error=b.attr("Error");break;case "VersionMismatchErrorResponse":var c=b.attr("Version");this._setVersion(c);a.error="VersionMismatch";break;case "AcknowledgeResponse":a.data=
{result:"ok"};break;case "ControlResultResponse":"Ok"==b.attr("Result")?a.data={result:"ok"}:a.error=b.attr("Result");break;case "LoginResponse":(c=b.attr("SessionId"))&&this._setSessionID(c);(b=b.attr("CurrentConfigurationVersion"))&&this._setCurrentConfig(b);a.data={sessionID:c,currentConfig:b};break;case "GetEntitiesResponse":a=this._parseDeviceData(b);break;case "GetAllLogicalDeviceStatesResponse":"Ok"==b.attr("Result")?a=this._parseDeviceStateData(b):a.error=b.attr("Result");break;case "MessageListResponse":a=
this._parseMessageData(b);break;default:b.attr("Error")?a.error=b.attr("Error"):a.error="unknown response type:"+b.attr("xsi:type")}return a};d.prototype._doRequest=function(b,a,c,e){b||(b="/cmd");if("object"==typeof c&&c&&c.body)var f=c.body;else{f='<BaseRequest xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Version="'+this._getVersion()+'" RequestId="'+this._generateGUID()+'" ';var h=this._getSessionID();h&&(f+='SessionId="'+h+'" ');f=(h=this._getCurrentConfig())?f+('BasedOnConfigVersion="'+
h+'" '):f+'BasedOnConfigVersion="0" ';for(var g in a)f+=g+'="'+a[g]+'" ';f=c&&0<c.length?f+(">"+c+"</BaseRequest>"):f+"/>"}g={};"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",g=require("constants"));g={host:this.ip,port:this.port,path:b,method:"POST",headers:{Referer:"https://smarthome.blob.core.windows.net/silverlight/latest/application/RWE.SmartHome.UI.Shell.xap",ClientId:this._clientID,"Content-Type":"text/xml; charset=UTF-8","cache-control":"no-cache",
pragma:"no-cache","User-Agent":"Java/1.7.0_07",Accept:"text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2",Connection:"close","Content-Length":f.length},rejectUnauthorized:!1,secureOptions:g.SSL_OP_NO_TLSv1,strictSSL:!1,secureProtocol:"TLSv1_client_method"};this._logger.log("trace","do request:"+JSON.stringify(g));var k=this,l=e,n=require("https").request(g,function(m){m.setEncoding("utf-8");var p="";m.on("data",function(q){p+=q});m.on("end",function(){k._logger.log("trace","receive code:"+m.statusCode+
" headers:"+JSON.stringify(m.headers)+" response:"+p);var q;if(200==m.statusCode)try{if((q=k._parseResult(p))&&"VersionMismatch"==q.error){k._doRequest(b,a,c,e);return}}catch(t){console.error(t);var r=t}l&&(l(r,q,m),l=null)})});if(n.on)n.on("error",function(m){k._logger.log("trace","do request error:"+m.message);l&&(l(m),l=null)});n.setTimeout&&n.setTimeout(6E4,function(){k._logger.log("trace","do request timeout");n.abort();l&&(l(Error("timeout")),l=null)});this._logger.log("trace","do request send body:"+
f);n.write(f);n.end()};d.prototype._sendRequest=function(b,a,c,e){var f=this,h=this._getSessionID(),g=this._getCurrentConfig();h&&g?this._doRequest(b,a,c,function(k,l,n){k?e&&e(k):n&&401==n.statusCode?(f._logger.log("debug","http request error with code:"+n.statusCode),f._setSessionID(null),f._setCurrentConfig(null),f._sendRequest(b,a,c,e)):n&&200!=n.statusCode?(k=Error("http request error with code:"+n.statusCode),e&&e(k)):!l||"IllegalSessionId"!=l.error&&"ConfigurationOutOfDate"!=l.error?(l&&l.error&&
(f._logger.log("debug","send request response error:"+l.error),k||(k=Error(l.error))),e&&e(k,l?l.data:l)):(f._logger.log("debug","send request response error:"+l.error),f._setSessionID(null),f._setCurrentConfig(null),f._sendRequest(b,a,c,e))}):this._login(function(k){k?e&&e(k):f._sendRequest(b,a,c,e)})};d.prototype._login=function(b){this._logger.log("debug","LoginRequest");if(this.user&&this.password){if(this._addLoginCallback(b),1!=this._getStateMachineState()){this._setStateMachineState(1);b=require("x.crypt.js");
b=(new Buffer(b.SHA256(this.password),"hex")).toString("base64");var a=this;this._doRequest(null,{"xsi:type":"LoginRequest",UserName:this.user,Password:b},null,function(c,e,f){var h=a._getLoginCallbacks();a._clearLoginCallbacks();c?a._logger.log("debug","login error:"+c.message):f&&200!=f.statusCode?(a._logger.log("debug","login http error:"+f.statusCode),c=Error("login http request error with code:"+f.statusCode)):e&&e.error&&(a._logger.log("debug","login response error:"+e.error),c=Error(e.error));
c?(a._setStateMachineState(0),h&&h.forEach(function(g){g&&g(c)})):a._subscribeNotification(function(g){g?(a._setStateMachineState(0),h&&h.forEach(function(k){k&&k(g)})):(a._logger.log("debug","login success:"+JSON.stringify(e)),a._setStateMachineState(2),a._setBufferedCentral(),h&&h.forEach(function(k){k&&k(null,e?e.data:e)}))})})}}else b&&b(Error("username or password in null"))};d.prototype._subscribeNotification=function(b){this._logger.log("debug","NotificationRequest");var a=this;this._sendRequest(null,
{"xsi:type":"NotificationRequest"},"<Action>Subscribe</Action><NotificationType>DeviceStateChanges</NotificationType>",function(c,e){c&&a._logger.log("debug","NotificationRequest error:"+c.message);e&&a._logger.log("debug","NotificationRequest response:"+JSON.stringify(e));b&&b(c,e)})};d.prototype._getUpd=function(b){this._logger.log("debug","Get Update Notification");var a=this;this._sendRequest("/upd",null,{body:"upd"},function(c,e){c&&a._logger.log("debug","Update Notification error:"+c.message);
e&&a._logger.log("debug","Update Notification response:"+JSON.stringify(e));b&&b(c,e)})};d.prototype._getEntities=function(b){this._logger.log("debug","GetEntitiesRequest");var a=this;this._sendRequest(null,{"xsi:type":"GetEntitiesRequest"},"<EntityType>Configuration</EntityType>",function(c,e){c&&a._logger.log("debug","GetEntitiesRequest error:"+c.message);e&&a._logger.log("debug","GetEntitiesRequest response:"+JSON.stringify(e));b&&b(c,e)})};d.prototype._getDeviceStates=function(b){this._logger.log("debug",
"_getDeviceStates");var a=this._getStatusBuffer();if(a)console.log("status buffer",a),b&&b(null,a);else{this._logger.log("debug","GetAllLogicalDeviceStatesRequest");var c=this;this._sendRequest(null,{"xsi:type":"GetAllLogicalDeviceStatesRequest"},null,function(e,f){e?(c._logger.log("debug","GetAllLogicalDeviceStatesRequest error:"+e.message),c._setStatusBuffer(null),b&&b(e)):(f&&(c._logger.log("debug","GetAllLogicalDeviceStatesRequest response:"+JSON.stringify(f)),c._setStatusBuffer(f)),b&&b(null,
f))})}};d.prototype._getDeviceState=function(b,a){this._getDeviceStates(function(c,e){c?a&&a(c):(c=null,e&&e[b]&&(c=e[b].state),a&&a(null,c))})};d.prototype._addSpecialTypesFromStates=function(b,a){for(var c in b){var e=[],f=b[c],h;for(h in f.devices){var g=f.devices[h],k;for(k in g.channels){var l=g.channels[k];l.data&&"Generic"!=l.data||!a[k]||(a[k].type&&-1==a[k].type.indexOf(":")&&"Generic"==l.data?e.push(h):l.data=a[k].type)}}for(g=0;g<e.length;g++)e[g]&&delete f.devices[e[g]]}return b};d.prototype.getDevices=
function(b){var a=this;this._getEntities(function(c,e){c?b&&b(c):a._getDeviceStates(function(f,h){f?b&&b(f):(f=a._addSpecialTypesFromStates(e,h),b&&b(null,f))})})};d.prototype.getMessages=function(b){this._doRequest(null,{"xsi:type":"GetMessageListRequest"},null,function(a){b&&(a&&a.data?b&&b(a.data):b&&b(null))})};d.prototype.executeCommand=function(b,a,c){if(b&&b.channels){var e=null,f=null;if("on"==a||"off"==a||"toggle"==a)f="SwitchActuator";else if("auto"==a||"manu"==a||"tempOff"==a||0==a.indexOf("tempTo"))f=
"RoomTemperatureActuator";else if("dimUp"==a||"dimDown"==a||0==a.indexOf("dimTo"))f="DimmerActuator";else if("moveUp"==a||"moveDown"==a||0==a.indexOf("moveTo"))f="RollerShutterActuator";else if("alarmOn"==a||"alarmOff"==a||"alarmToggle"==a)f="AlarmActuator";else if("boolTrue"==a||"boolFalse"==a||"boolToggle"==a||0==a.indexOf("numTo"))f="GenericActuator";if(f){for(var h in b.channels)if(b.channels.hasOwnProperty(h)&&b.channels[h]&&b.channels[h].type==f){e=b.channels[h];break}e?this._executeCommand(e,
a,c):c&&c(Error("device has no channel:"+f))}else c&&c(Error("unknown command"))}else c&&c(Error("device format invalid"))};d.prototype._executeCommand=function(b,a,c){if(b&&b.type&&b.address)if("undefined"==typeof a||null==a)c&&c(Error("command invalid"));else{var e=this,f=null,h=null,g=!0;switch(b.type){case "SwitchActuator":switch(a){case "on":h="True";break;case "off":h="False";break;case "toggle":g=!1,this._getDeviceState(b.address,function(m,p){m||!p?(m||(m=Error("current state rsp of switch is invalid")),
c&&c(m)):"off"==p.state?e._executeCommand(b,"on",c):e._executeCommand(b,"off",c)})}h&&(f='<ActuatorStates><LogicalDeviceState xsi:type="SwitchActuatorState" LID="'+b.address+'" IsOn="'+h+'" /></ActuatorStates>');break;case "DimmerActuator":switch(a){case "dimUp":case "dimDown":g=!1;this._getDeviceState(b.address,function(m,p){m||!p?(m||(m=Error("current state rsp of dimmer is invalid")),c&&c(m)):(m=parseInt(p.state),isNaN(m)?c&&c(Error("current dimmer state invalid")):(m="dimUp"==a?m+5:m-5,e._executeCommand(b,
"dimTo"+m,c)))});break;default:0==a.indexOf("dimTo")&&(h=parseInt(a.replace(/dimTo/g,"")),0>h&&(h=0),100<h&&(h=100))}"undefined"!=typeof h&&null!=h&&(f='<ActuatorStates><LogicalDeviceState xsi:type="DimmerActuatorState" LID="'+b.address+'" DmLvl="'+h+'" /></ActuatorStates>');break;case "RollerShutterActuator":switch(a){case "moveUp":case "moveDown":g=!1;this._getDeviceState(b.address,function(m,p){m||!p?(m||(m=Error("current state rsp of blind is invalid")),c&&c(m)):(m=parseInt(p.state),isNaN(m)?
c&&c(Error("current blind state invalid")):(m="moveUp"==a?m+5:m-5,e._executeCommand(b,"moveTo"+m,c)))});break;default:0==a.indexOf("moveTo")&&(h=parseInt(a.replace(/moveTo/g,"")),0>h&&(h=0),100<h&&(h=100))}"undefined"!=typeof h&&null!=h&&(f='<ActuatorStates><LogicalDeviceState xsi:type="RollerShutterActuatorState" LID="'+b.address+'" ><ShutterLevel>'+h+"</ShutterLevel></LogicalDeviceState></ActuatorStates>");break;case "RoomTemperatureActuator":switch(a){case "manu":f='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+
b.address+'" OpnMd="Manu" /></ActuatorStates>';break;case "auto":f='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+b.address+'" OpnMd="Auto" /></ActuatorStates>';break;case "tempOff":f='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+b.address+'" PtTmp="6.0" /></ActuatorStates>';break;default:0==a.indexOf("tempTo")&&(h=a.replace(/tempTo/g,""),h=(parseFloat(h)/2).toFixed(1),f='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+
b.address+'" PtTmp="'+h+'" /></ActuatorStates>')}break;case "AlarmActuator":switch(a){case "alarmOn":h="True";break;case "alarmOff":h="False";break;case "alarmToggle":g=!1,this._getDeviceState(b.address,function(m,p){m?c&&c(m):p&&"off"==p.state?e._executeCommand(b,"alarmOn",c):e._executeCommand(b,"alarmOff",c)})}h&&(f='<ActuatorStates><LogicalDeviceState xsi:type="AlarmActuatorState" LID="'+b.address+'" IsOn="'+h+'" /></ActuatorStates>');break;case "GenericActuator":var k=null,l=null;h=null;if(b.data){var n=
b.data.split(":");if(2==n.length)if(k=n[0],l=n[1],"on"==a||"true"==a||"boolTrue"==a)h="True";else if("off"==a||"false"==a||"boolFalse"==a)h="False";else if(0==a.indexOf("numTo"))h=a.replace(/numTo/g,""),h=parseFloat(h),(n=this._buildCMDStatus(b,a))&&this._updateStatusBuffer(n);else if("boolToggle"==a){g=!1;this._getDeviceState(b.address,function(m,p){m||!p?(m||(m=Error("current state rsp of switch is invalid")),c&&c(m)):"false"==p.state?e._executeCommand(b,"true",c):e._executeCommand(b,"false",c)});
break}}k&&l&&null!=h&&(f='<ActuatorStates><LogicalDeviceState xsi:type="GenericDeviceState" LID="'+b.address+'"><Ppts><Ppt xsi:type="'+k+'" Name="'+l+'" Value="'+h+'" /></Ppts></LogicalDeviceState></ActuatorStates>')}g&&(f?this._sendRequest(null,{"xsi:type":"SetActuatorStatesRequest"},f,function(m){if(!m){var p=e._buildCMDStatus(b,a);p&&e._updateStatusBuffer(p)}c&&c(m)}):c&&c(Error("unknow command")))}else c&&c(Error("channel format invalid"))};d.prototype._buildCMDStatus=function(b,a){if(!(b&&b.address&&
b.type&&a))return null;var c=null;switch(b.type){case "SwitchActuator":if("on"==a||"off"==a)c={},c[b.address]={state:{state:a},type:"SwitchActuatorState"};break;case "DimmerActuator":0==a.indexOf("dimTo")&&(c={},a=parseInt(a.replace(/dimTo/g,"")),0>a&&(a=0),100<a&&(a=100),c[b.address]={state:{state:""+a},type:"DimmerActuatorState"});break;case "RollerShutterActuator":0==a.indexOf("moveTo")&&(c={},a=parseInt(a.replace(/moveTo/g,"")),0>a&&(a=0),100<a&&(a=100),c[b.address]={state:{state:""+a},type:"RollerShutterActuatorState"});
break;case "RoomTemperatureActuator":if("auto"==a||"manu"==a)c={},c[b.address]={state:{mode:a},type:"RoomTemperatureActuatorState"},(a=this._getSingleBufferedStatus(b.address))&&a.state&&(c[b.address].state.state=a.state.state);else if("tempOff"==a||0==a.indexOf("tempTo"))c={},"tempOff"==a?a="6.0":(a=a.replace(/tempTo/g,""),a=(parseFloat(a)/2).toFixed(1)),c[b.address]={state:{state:a},type:"RoomTemperatureActuatorState"},(a=this._getSingleBufferedStatus(b.address))&&a.state&&(c[b.address].state.mode=
a.state.mode);break;case "AlarmActuator":if("alarmOn"==a||"alarmOff"==a)c={},c[b.address]={state:{state:"alarmOn"==a?"on":"off"},type:"AlarmActuatorState"};break;case "GenericActuator":"boolTrue"==a||"boolFalse"==a?(c={},c[b.address]={state:{state:"boolTrue"==a?"true":"false"},type:b.data}):0==a.indexOf("numTo")&&(c={},a=parseFloat(a.replace(/numTo/g,"")),c[b.address]={state:{state:""+a},type:b.data});break;default:return null}return c};d.prototype.getStates=function(b,a,c){var e=this;this.CommandHandler=
b;this._getDeviceStates(function(f,h){for(var g=0;g<a.length;g++)if(h&&h[a[g].address]){var k=a[g],l=h[a[g].address].state,n=e.getStateValues(k.subtype,l);if(e.CommandHandler&&e.CommandHandler.setState)for(var m in n)"state"==m?e.CommandHandler.setState(k.id,n[m]):e.CommandHandler.setState(k.id+":"+m,n[m]);else e.CommandHandler&&e.CommandHandler.receivedState&&e.CommandHandler.receivedState("rwe",k.address,l);if(c)for(m in n);}c&&c(f,h)})};d.prototype.getStateValues=function(b,a){return a};d.prototype.executeCommandCreator=
function(b,a,c){if(b)if(a&&a.value){var e=a.value;if("tempAuto"==a.value)e="auto";else if("tempManu"==a.value)e="manu";else if("tempTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command setTo ext format invalid"));return}e=parseFloat(a.ext);e=a.value+2*e}else if("dimTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command dimTo ext format invalid"));return}e=a.value+a.ext}else if("moveTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command dimTo ext format invalid"));
return}e=a.value+a.ext}else if("numTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command numTo ext format invalid"));return}e=a.value+a.ext}this.executeCommand(b,e,function(f){c&&c(f)})}else c&&c(Error("command json format invalid"));else c&&c(Error("device json format invalid"))};d.prototype.getStatesCreator=function(b,a,c){if(a)if(0==a.length)c&&c(null,[]);else{var e=this;this.getStates(b,[],function(f,h){f=[];if(h)for(var g=0;g<a.length;g++)if(a[g]&&a[g].id){var k="?",l=
e._findStatusChannel(a[g].device,a[g].status);l&&l.address&&a[g].status&&a[g].status.value&&h[l.address]&&(k=e._resolveState(l,a[g].status,h[l.address]));if("undefined"==typeof k||null==k)k="?";f.push({id:a[g].id,status:k})}c&&c(null,f)})}else c&&c(Error("deviceList is null"))};d.prototype.refreshStates=function(){var b=this;this._getUpd(function(a,c){!a&&c&&b._updateStatusBuffer(c)})};d.prototype._findStatusChannel=function(b,a){if(!(b&&b.channels&&a&&a.value))return null;var c=null;switch(a.value){case "switchState":a=
"SwitchActuator";break;case "dimLevel":a="DimmerActuator";break;case "blindPos":a="RollerShutterActuator";break;case "humState":a="RoomHumiditySensor";break;case "tempState":a="RoomTemperatureSensor";break;case "tempMode":case "setTempState":a="RoomTemperatureActuator";break;case "alarmState":a="AlarmActuator";break;case "contactState":a="WindowDoorSensor";break;case "smokeState":a="SmokeDetectionSensor";break;case "boolState":case "numState":case "stringState":a="GenericActuator";break;default:return null}if(!a)return null;
for(var e in b.channels)if(b.channels.hasOwnProperty(e)&&b.channels[e]&&b.channels[e].type==a){c=b.channels[e];break}return c};d.prototype._resolveState=function(b,a,c){if(!(b&&b.type&&a&&a.value&&c&&c.type&&c.state))return null;var e=null;switch(b.type){case "SwitchActuator":"SwitchActuatorState"==c.type&&(e=c.state.state);break;case "DimmerActuator":"DimmerActuatorState"==c.type&&(e=parseInt(c.state.state));break;case "RollerShutterActuator":"RollerShutterActuatorState"==c.type&&(e=parseInt(c.state.state));
break;case "RoomHumiditySensor":"RoomHumiditySensorState"==c.type&&(e=parseFloat(c.state.state).toFixed(1));break;case "RoomTemperatureSensor":"RoomTemperatureSensorState"==c.type&&(e=parseFloat(c.state.state).toFixed(1));break;case "RoomTemperatureActuator":"RoomTemperatureActuatorState"==c.type&&("setTempState"==a.value?e=parseFloat(c.state.state).toFixed(1):"tempMode"==a.value&&(e=c.state.mode));break;case "AlarmActuator":"AlarmActuatorState"==c.type&&(e=c.state.state);break;case "WindowDoorSensor":"WindowDoorSensorState"==
c.type&&(e=c.state.state);break;case "SmokeDetectionSensor":"SmokeDetectionSensorState"==c.type&&(e=c.state.state);break;case "GenericActuator":c.type==b.data&&(e=c.state.state);break;default:return null}return e};d.prototype.toJSON=function(){return{sys:"rwe",ip:this.ip,port:this.port,username:this.user,password:this.password}};d.prototype.equalsTo=function(b){return b&&b instanceof d?this.ip==b.ip&&this.port==b.port&&this.user==b.user&&this.password==b.password:!1};return d}();
xnm.aio.rwe.DM=function(){var d=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};d.prototype=Error();d.prototype.name="RWEDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"rwe",MAP:{SwitchActuator:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",
options:["on","off"]}}]},DimmerActuator:{command:[{type:"enum",name:"dim down",ref:{value:"dimUp"}},{type:"enum",name:"dim up",ref:{value:"dimDown"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d"}}],status:[{type:"int",name:"dim level",ref:{value:"dimLevel"}}]},RollerShutterActuator:{command:[{type:"enum",name:"move down",ref:{value:"moveUp"}},{type:"enum",name:"move up",ref:{value:"moveDown"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d"}}],status:[{type:"int",name:"blind position",
ref:{value:"blindPos"}}]},RoomHumiditySensor:{status:[{type:"float",name:"humidity",ref:{value:"humState"}}]},RoomTemperatureSensor:{status:[{type:"float",name:"temperature",ref:{value:"tempState"}}]},RoomTemperatureActuator:{command:[{type:"enum",name:"auto mode",ref:{value:"tempAuto"}},{type:"enum",name:"manual mode",ref:{value:"tempManu"}},{type:"enum",name:"thermostat off",ref:{value:"tempOff"}},{type:"float",name:"set temperature",ref:{value:"tempTo",ext:"%f",extMeta:"6.0-30.0",scale:"0.5"}}],
status:[{type:"enum",name:"thermostat mode",ref:{value:"tempMode",options:["auto","manu"]}},{type:"float",name:"target temperature",ref:{value:"setTempState"}}]},AlarmActuator:{command:[{type:"enum",name:"alarm off",ref:{value:"alarmOff"}},{type:"enum",name:"alarm on",ref:{value:"alarmOn"}},{type:"enum",name:"alarm toggle",ref:{value:"alarmToggle"}}],status:[{type:"enum",name:"alarm status",ref:{value:"alarmState",options:["on","off"]}}]},WindowDoorSensor:{status:[{type:"enum",name:"contact status",
ref:{value:"contactState",options:["open","closed"]}}]},SmokeDetectionSensor:{status:[{type:"enum",name:"smoke alarm status",ref:{value:"smokeState",options:["on","off"]}}]},GenericActuator:{BooleanProperty:{command:[{type:"enum",name:"set true",ref:{value:"boolTrue"}},{type:"enum",name:"set false",ref:{value:"boolFalse"}},{type:"enum",name:"boolean toggle",ref:{value:"boolToggle"}}],status:[{type:"enum",name:"boolean state",ref:{value:"boolState",options:["true","false"]}}]},NumericProperty:{command:[{type:"float",
name:"set numeric value",ref:{value:"numTo",ext:"%f"}}],status:[{type:"float",name:"numberic state",ref:{value:"numState",options:["true","false"]}}]}}},getGatewayType:function(){return[{sys:this.SYS,name:"RWE / innogy SmartHome",port:443}]},getGatewayDeviceType:function(){return[]},createGateway:function(b,a,c){a=d.ERROR_CODE;b?b.ip?b.username?b.password?c(null,b):c(new d(a.INVALID,"password is invalid")):c(new d(a.INVALID,"username is invalid")):c(new d(a.INVALID,"ip is invalid")):c(new d(a.INVALID,
"info is invalid"))},updateGateway:function(b,a,c,e){b=d.ERROR_CODE;a?a.ip?a.username?a.password?e(null,a):e(new d(b.INVALID,"password is invalid")):e(new d(b.INVALID,"username is invalid")):e(new d(b.INVALID,"ip is invalid")):e(new d(b.INVALID,"update is invalid"))},deleteGateway:function(b,a,c){c()},createDevice:function(b,a,c){var e=d.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===
b.gateway){var h=a[f];break}h?c(null,b):c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new d(e.INVALID,"type is invalid"));else c(new d(e.INVALID,"address is invalid"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"info is invalid"))},updateDevice:function(b,a,c){var e=d.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=
a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===b.gateway){var h=a[f];break}h?c(null,b):c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new d(e.INVALID,"type is invalid"));else c(new d(e.INVALID,"address is invalid"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"info is invalid"))},deleteDevice:function(b,a,c){c()},applyUIFilter:function(b,a){var c=this,e=function(l,
n){if("*"==l)return!0;for(var m=!1,p=0;p<l.length;p++)if(l[p]==n){m=!0;break}return m},f=function(l,n,m){var p=[];switch(m.catagory){case "command":l.command&&l.command.forEach(function(q){e(m.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))});break;case "status":l.status&&l.status.forEach(function(q){e(m.elems,q.type)&&(q=JSON.parse(JSON.stringify(q)),p.push(q))})}return p},h=function(l,n){var m=[],p=c.getCommandStatusMap(l);p&&(l=f(p,l,n),m=m.concat(l));return m};if(!b)return null;var g=
JSON.parse(JSON.stringify(b)),k=null;switch(a.catagory){case "command":k=h(b,a);g.command=k;break;case "status":k=h(b,a);g.status=k;break;default:return null}return k&&0!=k.length?g:null},getCommandStatusMap:function(b){if(!b||!b.channels)return null;var a={command:[],status:[]},c;for(c in b.channels){var e=b.channels[c];if(e&&e.type&&this.MAP[e.type]){var f=this.MAP[e.type];if("GenericActuator"==e.type&&e.data&&(e=e.data.split(":"),2<=e.length&&f[e[0]]))return f[e[0]];f&&f.command&&(a.command=a.command.concat(f.command));
f&&f.status&&(a.status=a.status.concat(f.status))}}return a}}}();
xnm.aio.rwe.Handler=function(){var d=function(){};d.prototype.Central=xnm.aio.rwe.Central;d.prototype.devicemanager=xnm.aio.rwe.DM;d.prototype.discoverCentrals=function(b,a){var c=require("x.mdns.js");c.clearRecordBuffer();c.discoverServiceWithTimeout("_http._tcp.local",b,function(e,f){if(e)a&&a(e);else{e=[];for(var h=0;h<f.length;h++){var g=f[h];g.target&&g.ip&&0<g.ip.length&&0==g.target.indexOf("SMARTHOME")&&(g=new xnm.aio.rwe.Central(g.ip[0]),e.push(g))}a&&a(null,e)}})};d.prototype.registModule=
function(b){b.register(this.devicemanager.SYS,"rwe")};d.prototype.resolveGateway=function(b){return b&&b.ip?new this.Central(b.ip,b.port,b.username,b.password):null};d.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};d.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};d.prototype.doCommand=function(b,a,c,e){(b=this.resolveGateway(b))?
b.executeCommandCreator(a,c,function(f){e&&e(f)}):e&&e(Error("gateway json format invalid"))};d.prototype.doStatus=function(b,a,c,e,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:e}],function(h,g){h?f&&f(h):f&&f(null,g[0])}):f&&f(Error("gateway json format invalid"))};d.prototype.getDeviceList=function(b,a){(b=this.resolveGateway(b))?b.getDevices(function(c,e){a&&a(c,e)}):a&&a(Error("gateway json format invalid"))};d.prototype.getStateValues=function(b,a){return(new xnm.aio.rwe.Central).getStateValues(b.type,
a)};d.prototype.getDeviceCommandList=function(b,a,c){var e=[];a?(e.push({id:window.XC_Text.on,cmd:"on"}),e.push({id:window.XC_Text.off,cmd:"off"})):c&&("SwitchActuator"==b.type?(e.push({id:"on",cmd:"on"}),e.push({id:"off",cmd:"off"}),e.push({id:"toggle",cmd:"toggle"})):"DimmerActuator"==b.type?(e.push({id:"off",cmd:"dimTo0"}),e.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"})):"RollerShutterActuator"==b.type?(e.push({id:"moveUp",cmd:"moveTo0"}),e.push({id:"moveDown",cmd:"moveTo100"}),e.push({id:"moveTo",
cmd:"moveTo",step:"1",min:"0",max:"100"})):"RoomTemperatureActuator"==b.type?(e.push({id:"setTo",cmd:"tempTo",step:"0.5",min:"6.5",max:"30",fact:"2"}),e.push({id:"off",cmd:"tempTo12"}),e.push({id:"setAuto",cmd:"auto"}),e.push({id:"setManu",cmd:"manu"})):"GenericActuator"==b.type&&("BooleanProperty:Value"==b.data?(e.push({id:"true",cmd:"true"}),e.push({id:"false",cmd:"false"})):"NumericProperty:Brightness"==b.data&&(e.push({id:"off",cmd:"setTo0"}),e.push({id:"setTo",cmd:"setTo",step:"1",min:"0",max:"100"}))));
return e};d.prototype.finalize=function(b){var a=b;setTimeout(function(){a&&(a(),a=null)},3E3);xnm.aio.rwe.Cache.finalize(function(){a&&(a(),a=null)})};d.prototype.pause=function(b){this.finalize(b)};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rwe.Handler);
