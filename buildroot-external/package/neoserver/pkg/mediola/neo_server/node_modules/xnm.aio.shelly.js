var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.shelly=xnm.aio.shelly||{};
xnm.aio.shelly={_logger:{log:function(){}},_buildRequestOptions:function(a,b,c,d){b={host:a.ip,port:a.port||80,path:"/"+c.path,method:b,headers:{"Content-Type":'application/json; charset="utf-8"',Connection:"close"}};"string"===typeof a.username&&"string"===typeof a.password&&(b.auth=a.username+":"+a.password);"string"===typeof d&&(b.headers["Content-Length"]=d.length);return b},_handleResponse:function(a,b,c,d){if(200===c.statusCode){var e="";c.on("data",function(f){e+=String(f)});c.on("end",function(){if("undefined"===
typeof b.dataType||"json"===b.dataType)try{e=JSON.parse(e)}catch(f){xnm.aio.shelly._logger.log("error","[_handleResponse] Failed to parse result as JSON: "+f.message)}d&&d(null,{statusCode:c.statusCode,response:e});d=null})}else 204===c.statusCode?d&&d(null,{statusCode:c.statusCode,response:null}):(a=Error(a+' request for "'+b.path+'" failed with status code '+c.statusCode),xnm.aio.shelly._logger.log("error","[_handleResponse] "+a.message),d&&d(a,{statusCode:c.statusCode,response:null}))},doRequest:function(a,
b,c,d){var e=null;if("GET"!==b&&"undefined"!==typeof c.data&&null!==c.data)try{e=JSON.stringify(c.data)}catch(h){xnm.aio.shelly._logger.log("error","[doRequest] Failed to parse body. Error: "+h.message);d&&d(h,null);return}var f=require("http");a=xnm.aio.shelly._buildRequestOptions(a,b,c,e);f=f.request(a,function(h){xnm.aio.shelly._handleResponse(b,c,h,d)});"function"===typeof f.setEncoding&&f.setEncoding("utf8");if("function"===typeof f.on)f.on("error",function(h){h&&xnm.aio.shelly._logger.log("error",
"[doRequest] Error: "+h.message);d&&d(h);d=null});"number"!==typeof c.timeout||isNaN(c.timeout)||"function"!==typeof f.setTimeout||f.setTimeout(c.timeout);e&&f.write(e);f.end()},parseJSON:function(a){if(!a||!a.ip)return xnm.aio.shelly._logger.log("warn","[parseJSON] Missing IP."),null;var b=xnm.aio.shelly;switch(a.type){case b.Dimmer.TYPE:return new b.Dimmer(a.ip,a);case b.EM3.TYPE:return new b.EM3(a.ip,a);case b.Plug.TYPE:return new b.Plug(a.ip,a);case b.PlugS.TYPE:return new b.PlugS(a.ip,a);case b.RGBW2.TYPE:return new b.RGBW2(a.ip,
a);case b.Switch1.TYPE:return new b.Switch1(a.ip,a);case b.Switch1PM.TYPE:return new b.Switch1PM(a.ip,a);case b.Switch2.TYPE:return new b.Switch2(a.ip,a);case b.Switch25.TYPE:return new b.Switch25(a.ip,a)}return new b.Device(a.ip,a)}};
xnm.aio.shelly.DM={MAP:{1:{command:[{type:"enum",name:"on",ref:{value:"ch1_on",value_t:"on"}},{type:"enum",name:"off",ref:{value:"ch1_off",value_t:"off"}},{type:"enum",name:"toggle",ref:{value:"ch1_toggle",value_t:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"ch1_state",value_t:"state",options:["on","off"]}},{type:"float",name:"addon 1: temperature (Celsius)",ref:{value:"addonTemp0C",ext:"%f",unit:"\u00b0C"}},{type:"float",name:"addon 2: temperature (Celsius)",ref:{value:"addonTemp1C",
ext:"%f",unit:"\u00b0C"}},{type:"float",name:"addon 3: temperature (Celsius)",ref:{value:"addonTemp2C",ext:"%f",unit:"\u00b0C"}},{type:"float",name:"addon 1: temperature (Fahrenheit)",ref:{value:"addonTemp0F",ext:"%f",unit:"\u00b0F"}},{type:"float",name:"addon 2: temperature (Fahrenheit)",ref:{value:"addonTemp1F",ext:"%f",unit:"\u00b0F"}},{type:"float",name:"addon 3: temperature (Fahrenheit)",ref:{value:"addonTemp2F",ext:"%f",unit:"\u00b0F"}},{type:"float",name:"addon: humidity",ref:{value:"addonHum0",
ext:"%f",unit:"%"}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",unit:"%"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"brightness",extMeta:"0-100",unit:"%"}},{type:"float",name:"power",ref:{value:"ch1_power",value_t:"power",ext:"%f",unit:"W"}},
{type:"float",name:"power total",ref:{value:"ch1_powerTotal",value_t:"powerTotal",ext:"%f",unit:"Wmin"}},{type:"float",name:"temperature (Celsius)",ref:{value:"tempC",ext:"%f",unit:"\u00b0C"}},{type:"float",name:"temperature (Fahrenheit)",ref:{value:"tempF",ext:"%f",unit:"\u00b0F"}}]},em3:{command:[{type:"enum",name:"reset all data",ref:{value:"reset"}},{type:"enum",name:"meter 1: reset totals",ref:{value:"ch1_reset",value_t:"meter1reset"}},{type:"enum",name:"meter 2: reset totals",ref:{value:"ch2_reset",
value_t:"meter2reset"}},{type:"enum",name:"meter 3: reset totals",ref:{value:"ch3_reset",value_t:"meter3reset"}}],status:[{type:"float",name:"meter 1: power",ref:{value:"ch1_power",value_t:"meter1power",ext:"%f",unit:"W"}},{type:"float",name:"meter 1: current",ref:{value:"ch1_current",value_t:"meter1current",ext:"%f",unit:"A"}},{type:"float",name:"meter 1: voltage",ref:{value:"ch1_voltage",value_t:"meter1voltage",ext:"%f",unit:"V"}},{type:"float",name:"meter 1: total",ref:{value:"ch1_total",value_t:"meter1total",
ext:"%f",unit:"Wh"}},{type:"float",name:"meter 1: total returned",ref:{value:"ch1_totalReturned",value_t:"meter1totalReturned",ext:"%f",unit:"Wh"}},{type:"float",name:"meter 2: power",ref:{value:"ch2_power",value_t:"meter2power",ext:"%f",unit:"W"}},{type:"float",name:"meter 2: current",ref:{value:"ch2_current",value_t:"meter2current",ext:"%f",unit:"A"}},{type:"float",name:"meter 2: voltage",ref:{value:"ch2_voltage",value_t:"meter2voltage",ext:"%f",unit:"V"}},{type:"float",name:"meter 2: total",ref:{value:"ch2_total",
value_t:"meter2total",ext:"%f",unit:"Wh"}},{type:"float",name:"meter 2: total returned",ref:{value:"ch2_totalReturned",value_t:"meter2totalReturned",ext:"%f",unit:"Wh"}},{type:"float",name:"meter 3: power",ref:{value:"ch3_power",value_t:"meter3power",ext:"%f",unit:"W"}},{type:"float",name:"meter 3: current",ref:{value:"ch3_current",value_t:"meter3current",ext:"%f",unit:"A"}},{type:"float",name:"meter 3: voltage",ref:{value:"ch3_voltage",value_t:"meter3voltage",ext:"%f",unit:"V"}},{type:"float",name:"meter 3: total",
ref:{value:"ch3_total",value_t:"meter3total",ext:"%f",unit:"Wh"}},{type:"float",name:"meter 3: total returned",ref:{value:"ch3_totalReturned",value_t:"meter3totalReturned",ext:"%f",unit:"Wh"}}]},plug:{command:[{type:"enum",name:"on",ref:{value:"ch1_on",value_t:"on"}},{type:"enum",name:"off",ref:{value:"ch1_off",value_t:"off"}},{type:"enum",name:"toggle",ref:{value:"ch1_toggle",value_t:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"ch1_state",value_t:"state",options:["on","off"]}},{type:"float",
name:"power",ref:{value:"ch1_power",value_t:"power",ext:"%f",unit:"W"}},{type:"float",name:"power total",ref:{value:"ch1_powerTotal",value_t:"powerTotal",ext:"%f",unit:"Wmin"}}]},rgbw2:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"color brightness",ref:{value:"gain",value_t:"colorGain",ext:"%d",extMeta:"0-100"}},{type:"rgb",name:"color",ref:{value:"color",ext:"%rgb"}},{type:"rgbw",name:"rgb + white color",
ref:{value:"color",ext:"%rgbw"}},{type:"int",name:"red",ref:{value:"red",ext:"%d",extMeta:"0-100"}},{type:"int",name:"green",ref:{value:"green",ext:"%d",extMeta:"0-100"}},{type:"int",name:"blue",ref:{value:"blue",ext:"%d",extMeta:"0-100"}},{type:"int",name:"white",ref:{value:"white",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"effect",ref:{value:"effect",ext:"%e",extMeta:["off","Meteor shower","Gradual change","Flash","Red/Green change"]}},{type:"enum",name:"white 1: on",ref:{value:"ch1_on",value_t:"white1on"}},
{type:"enum",name:"white 2: on",ref:{value:"ch2_on",value_t:"white2on"}},{type:"enum",name:"white 3: on",ref:{value:"ch3_on",value_t:"white3on"}},{type:"enum",name:"white 4: on",ref:{value:"ch4_on",value_t:"white4on"}},{type:"enum",name:"white 1: off",ref:{value:"ch1_off",value_t:"white1off"}},{type:"enum",name:"white 2: off",ref:{value:"ch2_off",value_t:"white2off"}},{type:"enum",name:"white 3: off",ref:{value:"ch3_off",value_t:"white3off"}},{type:"enum",name:"white 4: off",ref:{value:"ch4_off",
value_t:"white4off"}},{type:"int",name:"white 1: brightness",ref:{value:"ch1_brightness",value_t:"white1bri",ext:"%d",extMeta:"0-100",unit:"%"}},{type:"int",name:"white 2: brightness",ref:{value:"ch2_brightness",value_t:"white2bri",ext:"%d",extMeta:"0-100",unit:"%"}},{type:"int",name:"white 3: brightness",ref:{value:"ch3_brightness",value_t:"white3bri",ext:"%d",extMeta:"0-100",unit:"%"}},{type:"int",name:"white 4: brightness",ref:{value:"ch4_brightness",value_t:"white4bri",ext:"%d",extMeta:"0-100",
unit:"%"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["color","white"]}},{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"int",name:"color brightness",ref:{value:"gain",value_t:"colorGain",ext:"%d",extMeta:"0-100"}},{type:"float",name:"power",ref:{value:"power",ext:"%f",unit:"W"}},{type:"rgbw",name:"color",ref:{value:"color",ext:"%s"}},{type:"rgbw",name:"rgb + white color",ref:{value:"color_white",ext:"%s"}},{type:"int",name:"red",ref:{value:"red",ext:"%d",
extMeta:"0-100"}},{type:"int",name:"green",ref:{value:"green",ext:"%d",extMeta:"0-100"}},{type:"int",name:"blue",ref:{value:"blue",ext:"%d",extMeta:"0-100"}},{type:"int",name:"white",ref:{value:"white",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"effect",ref:{value:"effect",options:["off","Meteor shower","Gradual change","Flash","Red/Green change"]}},{type:"enum",name:"white 1: state",ref:{value:"ch1_state",value_t:"white1state",options:["on","off"]}},{type:"enum",name:"white 2: state",ref:{value:"ch2_state",
value_t:"white2state",options:["on","off"]}},{type:"enum",name:"white 3: state",ref:{value:"ch3_state",value_t:"white3state",options:["on","off"]}},{type:"enum",name:"white 4: state",ref:{value:"ch4_state",value_t:"white4state",options:["on","off"]}},{type:"int",name:"white 1: brightness",ref:{value:"ch1_brightness",value_t:"white1bri",extMeta:"0-100",unit:"%"}},{type:"int",name:"white 2: brightness",ref:{value:"ch2_brightness",value_t:"white2bri",extMeta:"0-100",unit:"%"}},{type:"int",name:"white 3: brightness",
ref:{value:"ch3_brightness",value_t:"white3bri",extMeta:"0-100",unit:"%"}},{type:"int",name:"white 4: brightness",ref:{value:"ch4_brightness",value_t:"white4bri",extMeta:"0-100",unit:"%"}},{type:"float",name:"white 1: power",ref:{value:"ch1_power",value_t:"white1power",ext:"%f",unit:"W"}},{type:"float",name:"white 2: power",ref:{value:"ch2_power",value_t:"white2power",ext:"%f",unit:"W"}},{type:"float",name:"white 3: power",ref:{value:"ch3_power",value_t:"white3power",ext:"%f",unit:"W"}},{type:"float",
name:"white 4: power",ref:{value:"ch4_power",value_t:"white4power",ext:"%f",unit:"W"}}]},switch:{command:[{type:"enum",name:"switch 1 on",ref:{value:"ch1_on",value_t:"switch1on"}},{type:"enum",name:"switch 1 off",ref:{value:"ch1_off",value_t:"switch1off"}},{type:"enum",name:"switch 1 toggle",ref:{value:"ch1_toggle",value_t:"switch1toggle"}},{type:"enum",name:"switch 2 on",ref:{value:"ch2_on",value_t:"switch2on"}},{type:"enum",name:"switch 2 off",ref:{value:"ch2_off",value_t:"switch2off"}},{type:"enum",
name:"switch 2 toggle",ref:{value:"ch2_toggle",value_t:"switch2toggle"}},{type:"int",name:"shutter position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"shutter up",ref:{value:"up",value_t:"moveUp"}},{type:"enum",name:"shutter down",ref:{value:"down",value_t:"moveDown"}},{type:"enum",name:"shutter stop",ref:{value:"stop"}}],status:[{type:"enum",name:"switch 1 state",ref:{value:"ch1_state",value_t:"switch1state",options:["on","off"]}},{type:"enum",name:"switch 2 state",ref:{value:"ch2_state",
value_t:"switch2state",options:["on","off"]}},{type:"enum",name:"shutter state",ref:{value:"roller_state",options:["open","closed","middle"]}},{type:"int",name:"shutter position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"shutter last direction",ref:{value:"roller_lastDirection",options:["open","closed"]}},{type:"enum",name:"shutter stop reason",ref:{value:"roller_stopReason",options:["normal","safety_switch","obstacle"]}},{type:"float",name:"shutter power",ref:{value:"roller_power",
ext:"%f",unit:"W"}},{type:"float",name:"power",ref:{value:"ch1_power",value_t:"power",ext:"%f",unit:"W"}},{type:"float",name:"power total",ref:{value:"ch1_powerTotal",value_t:"powerTotal",ext:"%f",unit:"Wmin"}}]},switch25:{command:[{type:"enum",name:"switch 1 on",ref:{value:"ch1_on",value_t:"switch1on"}},{type:"enum",name:"switch 1 off",ref:{value:"ch1_off",value_t:"switch1off"}},{type:"enum",name:"switch 1 toggle",ref:{value:"ch1_toggle",value_t:"switch1toggle"}},{type:"enum",name:"switch 2 on",
ref:{value:"ch2_on",value_t:"switch2on"}},{type:"enum",name:"switch 2 off",ref:{value:"ch2_off",value_t:"switch2off"}},{type:"enum",name:"switch 2 toggle",ref:{value:"ch2_toggle",value_t:"switch2toggle"}},{type:"int",name:"shutter position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"shutter up",ref:{value:"up",value_t:"moveUp"}},{type:"enum",name:"shutter down",ref:{value:"down",value_t:"moveDown"}},{type:"enum",name:"shutter stop",ref:{value:"stop"}}],status:[{type:"enum",
name:"switch 1 state",ref:{value:"ch1_state",value_t:"switch1state",options:["on","off"]}},{type:"enum",name:"switch 1 over temperature",ref:{value:"ch1_overTemp",value_t:"switch1overTemp",options:["true","false"]}},{type:"enum",name:"switch 2 state",ref:{value:"ch2_state",value_t:"switch2state",options:["on","off"]}},{type:"enum",name:"switch 2 over temperature",ref:{value:"ch2_overTemp",value_t:"switch2overTemp",options:["true","false"]}},{type:"enum",name:"shutter state",ref:{value:"roller_state",
options:["open","closed","middle"]}},{type:"int",name:"shutter position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"shutter last direction",ref:{value:"roller_lastDirection",options:["open","closed"]}},{type:"enum",name:"shutter stop reason",ref:{value:"roller_stopReason",options:["normal","safety_switch","obstacle"]}},{type:"float",name:"shutter power",ref:{value:"roller_power",ext:"%f",unit:"W"}},{type:"enum",name:"shutter over temperature",ref:{value:"roller_overTemp",
options:["true","false"]}},{type:"float",name:"meter 1 power",ref:{value:"ch1_power",value_t:"meter1power",ext:"%f",unit:"W"}},{type:"float",name:"meter 1 power total",ref:{value:"ch1_powerTotal",value_t:"meter1powerTotal",ext:"%f",unit:"Wmin"}},{type:"float",name:"meter 2 power",ref:{value:"ch2_power",value_t:"meter2power",ext:"%f",unit:"W"}},{type:"float",name:"meter 2 power total",ref:{value:"ch2_powerTotal",value_t:"meter2powerTotal",ext:"%f",unit:"Wmin"}},{type:"float",name:"temperature (Celsius)",
ref:{value:"tempC",ext:"%f",unit:"\u00b0C"}},{type:"float",name:"temperature (Fahrenheit)",ref:{value:"tempF",ext:"%f",unit:"\u00b0F"}}]}},SYS:"shelly",applyUIFilter:function(a,b,c){if(!a.sys)return null;var d=function(g,p){if("*"===g||"*"===g[0])return!0;for(var l=0;l<g.length;l++)if(g[l]==p)return!0;return!1},e=function(g,p,l){var n=[];switch(l.catagory){case "command":g.command&&g.command.forEach(function(m){d(l.elems,m.type)&&(m=JSON.parse(JSON.stringify(m)),n.push(m))});break;case "status":g.status&&
g.status.forEach(function(m){d(l.elems,m.type)&&(m=JSON.parse(JSON.stringify(m)),n.push(m))})}return n},f=function(g,p){var l=[],n=xnm.aio.shelly.DM.getCommandStatusMap(g,c);n&&(g=e(n,g,p),l=l.concat(g));return l},h=JSON.parse(JSON.stringify(a)),k=null;switch(b.catagory){case "command":k=f(a,b);h.command=k;break;case "status":k=f(a,b);h.status=k;break;default:return null}return k&&0!=k.length?h:null},createDevice:function(a,b,c){b=xnm.aio.shelly.DM;a?a.type?a.ip?c(null,a):c(new b.Error(b.Error.ERROR_CODE.INVALID,
"IP is missing")):c(new b.Error(b.Error.ERROR_CODE.INVALID,"type is missing")):c(new b.Error(b.Error.ERROR_CODE.INVALID,"info is missing"))},deleteDevice:function(a,b,c){c&&c()},getCommandStatusMap:function(a,b){if(!a.type)return null;b=xnm.aio.shelly.DM.MAP[a.type]||null;if(!b)return b;b={command:b.command.slice(0),status:b.status.slice(0)};a.type===xnm.aio.shelly.RGBW2.TYPE?"color"===a.mode?(b.command.splice(11,12),b.status.splice(11,12)):"white"===a.mode&&(b.command.splice(0,11),b.status.splice(1,
10)):a.type===xnm.aio.shelly.Switch2.TYPE?"roller"===a.mode?(b.command.splice(0,6),b.status.splice(0,2)):"relay"===a.mode&&(b.command.splice(6,4),b.status.splice(2,5)):a.type===xnm.aio.shelly.Switch25.TYPE&&("roller"===a.mode?(b.command.splice(0,6),b.status.splice(0,4)):"relay"===a.mode&&(b.command.splice(6,4),b.status.splice(4,6)));return b},getIPDeviceType:function(){return[{sys:xnm.aio.shelly.DM.SYS,name:"Shelly"}]},toGeneralDevice:function(a){return(a=xnm.aio.shelly.parseJSON(a))&&"function"===
typeof a.toGeneralDevice?a.toGeneralDevice():null},updateDevice:function(a,b,c){b=xnm.aio.shelly.DM;a?a.type?a.ip?c(null,a):c(new b.Error(b.Error.ERROR_CODE.INVALID,"IP is missing")):c(new b.Error(b.Error.ERROR_CODE.INVALID,"type is missing")):c(new b.Error(b.Error.ERROR_CODE.INVALID,"info is missing"))}};xnm.aio.shelly.DM.MAP["1pm"]={command:xnm.aio.shelly.DM.MAP["1"].command.slice(0),status:xnm.aio.shelly.DM.MAP["1"].status.slice(0)};
xnm.aio.shelly.DM.MAP["1pm"].status.push({type:"float",name:"power",ref:{value:"ch1_power",value_t:"power",ext:"%f",unit:"W"}},{type:"float",name:"power total",ref:{value:"ch1_powerTotal",value_t:"powerTotal",ext:"%f",unit:"Wmin"}},{type:"enum",name:"over temperature",ref:{value:"overTemp",options:["true","false"]}},{type:"float",name:"temperature (Celsius)",ref:{value:"tempC",ext:"%f",unit:"\u00b0C"}},{type:"float",name:"temperature (Fahrenheit)",ref:{value:"tempF",ext:"%f",unit:"\u00b0F"}});
xnm.aio.shelly.DM.MAP["plug-s"]={command:xnm.aio.shelly.DM.MAP.plug.command.slice(0),status:xnm.aio.shelly.DM.MAP.plug.status.slice(0)};xnm.aio.shelly.DM.MAP["plug-s"].status.push({type:"enum",name:"over temperature",ref:{value:"overTemp",options:["true","false"]}},{type:"float",name:"temperature (Celsius)",ref:{value:"tempC",ext:"%f",unit:"\u00b0C"}},{type:"float",name:"temperature (Fahrenheit)",ref:{value:"tempF",ext:"%f",unit:"\u00b0F"}});
xnm.aio.shelly.DM.Error=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};xnm.aio.shelly.DM.Error.prototype=Error();xnm.aio.shelly.DM.Error.prototype.name="ShellyDMError";xnm.aio.shelly.DM.Error.prototype.code=0;xnm.aio.shelly.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,INVALID:2,UNKNOWN:3,NOT_FOUND:4,IP_EXISTS:5};
xnm.aio.shelly.Device=function(a,b){this.ip=a;this.port=80;this.type=null;b&&(this.firmware=b.firmware||null,this.id=b.id||null,this.mode=b.mode||null,this.password=b.password||null,this.port=b.port||this.port,this.type=b.type,this.username=b.username||null)};
xnm.aio.shelly.Device.prototype={_getStateFromResult:function(a,b){if(!a||!b)return null;if(Array.isArray(a.meters)){if(0<a.meters.length){var c=a.meters[0];switch(b){case "ch1_power":return c.power;case "ch1_powerTotal":return c.total}}if(1<a.meters.length)switch(c=a.meters[1],b){case "ch2_power":return c.power;case "ch2_powerTotal":return c.total}}if(a.tmp)switch(c=a.tmp,b){case "tempC":return c.tC;case "tempF":return c.tF}switch(b){case "overTemp":return a.overtemperature?"true":"false"}return null},
equalsTo:function(a){return a&&a instanceof xnm.aio.shelly.Device?this.ip===a.ip&&this.id===a.id:!1},executeCommand:function(a,b,c){(a=xnm.aio.shelly.parseJSON(a))?a._executeCommand(b,c):(b=Error("Could not create device from data."),c&&c(b,null))},executeCommandCreator:function(a,b,c){b&&b.value?this.executeCommand(a,b,function(d){c&&c(d)}):c&&c(Error("Command value is empty."))},getState:function(a){xnm.aio.shelly._logger.log("trace","[Device.getState] Sending request.");xnm.aio.shelly.doRequest(this,
"GET",{path:"status"},function(b,c){b?a&&a(b,null):a&&a(null,c.response)})},getStatesCreator:function(a,b,c){var d=this;this.getState(function(e,f){if(f){e=[];for(var h=0;h<b.length;h++){var k=b[h];if(k&&k.id&&k.status){var g=d._getStateFromResult(f,k.status.value);null!==g&&e.push({id:k.id,status:g})}}c&&c(null,e)}else c&&c(Error("Failed to get states."))})},toJSON:function(){return{sys:xnm.aio.shelly.DM.SYS,type:this.type,ip:this.ip,id:this.id,firmware:this.firmware}}};
xnm.aio.shelly.GenericSwitch=function(a,b){xnm.aio.shelly.Device.call(this,a,b)};xnm.aio.shelly.GenericSwitch.prototype=Object.create(xnm.aio.shelly.Device.prototype);xnm.aio.shelly.GenericSwitch.constructor=xnm.aio.shelly.GenericSwitch;
xnm.aio.shelly.GenericSwitch.prototype._executeCommand=function(a,b){switch(a.value){case "ch1_off":this.cmdOff(0,b);break;case "ch1_on":this.cmdOn(0,b);break;case "ch1_toggle":this.cmdToggle(0,b);break;case "ch2_off":this.cmdOff(1,b);break;case "ch2_on":this.cmdOn(1,b);break;case "ch2_toggle":this.cmdToggle(1,b);break;case "down":this.cmdMoveDown(b);break;case "position":this.cmdSetPosition(a.ext,b);break;case "stop":this.cmdMoveStop(b);break;case "up":this.cmdMoveUp(b);break;default:a=Error("Unknown command: "+
a.value),xnm.aio.shelly._logger.log("warn","[GenericSwitch._executeCommand] "+a.message),b(a,null)}};
xnm.aio.shelly.GenericSwitch.prototype._getStateFromResult=function(a,b){if(!a||!b)return null;if(Array.isArray(a.relays)){if(0<a.relays.length){var c=a.relays[0];switch(b){case "ch1_overTemp":return c.overtemperature?"true":"false";case "ch1_state":return c.ison?"on":"off"}}if(1<a.relays.length)switch(c=a.relays[1],b){case "ch2_overTemp":return c.overtemperature?"true":"false";case "ch2_state":return c.ison?"on":"off"}}if(Array.isArray(a.rollers)&&0<a.rollers.length)switch(c=a.rollers[0],b){case "position":return 100-
c.current_pos;case "roller_lastDirection":return"close"===c.last_direction?"closed":c.last_direction;case "roller_overTemp":return c.overtemperature?"true":"false";case "roller_power":return c.power;case "roller_state":return 66<=c.current_pos?"open":33>=c.current_pos?"closed":"middle";case "roller_stopReason":return c.stop_reason}if(a.ext_temperature&&0===b.indexOf("addonTemp")){c=a.ext_temperature;var d=b.substring(9,10);c=c[d];d=b.substring(10,11);if(c&&(c=c["t"+d],"number"===typeof c))return c}return a.ext_humidity&&
0===b.indexOf("addonHum")&&(c=a.ext_humidity,d=b.substring(8,9),c=c[d])&&(c=c.hum,"number"===typeof c)?c:xnm.aio.shelly.Device.prototype._getStateFromResult.call(this,a,b)};xnm.aio.shelly.GenericSwitch.prototype.cmdMoveDown=function(a){xnm.aio.shelly._logger.log("trace","[GenericSwitch.cmdMoveDown] Sending request.");xnm.aio.shelly.doRequest(this,"GET",{path:"roller/0?go=close"},function(b,c){a&&a(b,c)})};
xnm.aio.shelly.GenericSwitch.prototype.cmdMoveStop=function(a){xnm.aio.shelly._logger.log("trace","[GenericSwitch.cmdMoveStop] Sending request.");xnm.aio.shelly.doRequest(this,"GET",{path:"roller/0?go=stop"},function(b,c){a&&a(b,c)})};xnm.aio.shelly.GenericSwitch.prototype.cmdMoveUp=function(a){xnm.aio.shelly._logger.log("trace","[GenericSwitch.cmdMoveUp] Sending request.");xnm.aio.shelly.doRequest(this,"GET",{path:"roller/0?go=open"},function(b,c){a&&a(b,c)})};
xnm.aio.shelly.GenericSwitch.prototype.cmdOff=function(a,b){a={path:"relay/"+a+"?turn=off"};xnm.aio.shelly._logger.log("trace","[GenericSwitch.cmdOff] Sending request.");xnm.aio.shelly.doRequest(this,"GET",a,function(c,d){b&&b(c,d)})};xnm.aio.shelly.GenericSwitch.prototype.cmdOn=function(a,b){a={path:"relay/"+a+"?turn=on"};xnm.aio.shelly._logger.log("trace","[GenericSwitch.cmdOn] Sending request.");xnm.aio.shelly.doRequest(this,"GET",a,function(c,d){b&&b(c,d)})};
xnm.aio.shelly.GenericSwitch.prototype.cmdSetPosition=function(a,b){"number"!==typeof a||isNaN(a)||0>a||100<a?(a=Error("Invalid value for position: "+a),xnm.aio.shelly._logger.log("error","[GenericSwitch.cmdSetPosition] "+a.message),b&&b(a,null)):(a={path:"roller/0?go=to_pos&roller_pos="+Math.round(100-a)},xnm.aio.shelly._logger.log("trace","[GenericSwitch.cmdSetPosition] Sending request."),xnm.aio.shelly.doRequest(this,"GET",a,function(c,d){b&&b(c,d)}))};
xnm.aio.shelly.GenericSwitch.prototype.cmdToggle=function(a,b){a={path:"relay/"+a+"?turn=toggle"};xnm.aio.shelly._logger.log("trace","[GenericSwitch.cmdToggle] Sending request.");xnm.aio.shelly.doRequest(this,"GET",a,function(c,d){b&&b(c,d)})};xnm.aio.shelly.Switch1=function(a,b){xnm.aio.shelly.GenericSwitch.call(this,a,b);this.type=xnm.aio.shelly.Switch1.TYPE};xnm.aio.shelly.Switch1.TYPE="1";xnm.aio.shelly.Switch1.prototype=Object.create(xnm.aio.shelly.GenericSwitch.prototype);
xnm.aio.shelly.Switch1.constructor=xnm.aio.shelly.Switch1;
xnm.aio.shelly.Switch1.prototype.toGeneralDevice=function(){return{type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},details:{commands:{on:{value:"ch1_on"},off:{value:"ch1_off"},toggle:{value:"ch1_toggle"}},states:{state:{value:"ch1_state"},addonHum0:{value:"addonHum0"},addonTemp0C:{value:"addonTemp0C"},addonTemp0F:{value:"addonTemp0F"},addonTemp1C:{value:"addonTemp1C"},addonTemp1F:{value:"addonTemp1F"},addonTemp2C:{value:"addonTemp2C"},addonTemp2F:{value:"addonTemp2F"}}}}};
xnm.aio.shelly.Switch1PM=function(a,b){xnm.aio.shelly.Switch1.call(this,a,b);this.type=xnm.aio.shelly.Switch1PM.TYPE};xnm.aio.shelly.Switch1PM.TYPE="1pm";xnm.aio.shelly.Switch1PM.prototype=Object.create(xnm.aio.shelly.Switch1.prototype);xnm.aio.shelly.Switch1PM.constructor=xnm.aio.shelly.Switch1PM;
xnm.aio.shelly.Switch1PM.prototype.toGeneralDevice=function(){return{type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]},overTemp:{values:["true","false"]}},details:{commands:{on:{value:"ch1_on"},off:{value:"ch1_off"},toggle:{value:"ch1_toggle"}},states:{state:{value:"ch1_state"},overTemp:{value:"overTemp",options:["true","false"]}}}}};xnm.aio.shelly.Plug=function(a,b){xnm.aio.shelly.GenericSwitch.call(this,a,b);this.type=xnm.aio.shelly.Plug.TYPE};
xnm.aio.shelly.Plug.TYPE="plug";xnm.aio.shelly.Plug.prototype=Object.create(xnm.aio.shelly.GenericSwitch.prototype);xnm.aio.shelly.Plug.constructor=xnm.aio.shelly.Plug;xnm.aio.shelly.Plug.prototype.toGeneralDevice=function(){return{type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},details:{commands:{on:{value:"ch1_on"},off:{value:"ch1_off"},toggle:{value:"ch1_toggle"}},states:{state:{value:"ch1_state"}}}}};
xnm.aio.shelly.PlugS=function(a,b){xnm.aio.shelly.Plug.call(this,a,b);this.type=xnm.aio.shelly.PlugS.TYPE};xnm.aio.shelly.PlugS.TYPE="plug-s";xnm.aio.shelly.PlugS.prototype=Object.create(xnm.aio.shelly.Plug.prototype);xnm.aio.shelly.PlugS.constructor=xnm.aio.shelly.PlugS;
xnm.aio.shelly.PlugS.prototype.toGeneralDevice=function(){return{type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]},overTemp:{values:["true","false"]}},details:{commands:{on:{value:"ch1_on"},off:{value:"ch1_off"},toggle:{value:"ch1_toggle"}},states:{state:{value:"ch1_state"},overTemp:{value:"overTemp",options:["true","false"]}}}}};xnm.aio.shelly.Switch2=function(a,b){xnm.aio.shelly.GenericSwitch.call(this,a,b);this.type=xnm.aio.shelly.Switch2.TYPE};
xnm.aio.shelly.Switch2.TYPE="switch";xnm.aio.shelly.Switch2.prototype=Object.create(xnm.aio.shelly.GenericSwitch.prototype);xnm.aio.shelly.Switch2.constructor=xnm.aio.shelly.Switch2;
xnm.aio.shelly.Switch2.prototype.toGeneralDevice=function(){return"relay"===this.mode?{type:"switch",commands:{on:{},off:{},toggle:{},ch2_on:{},ch2_off:{},ch2_toggle:{}},states:{state:{values:["on","off"]},ch2_state:{values:["on","off"]},power:{type:"FLOAT"},powerTotal:{type:"FLOAT"}},details:{commands:{on:{value:"ch1_on"},off:{value:"ch1_off"},toggle:{value:"ch1_toggle"},ch2_on:{value:"ch2_on"},ch2_off:{value:"ch2_off"},ch2_toggle:{value:"ch2_toggle"}},states:{state:{value:"ch1_state"},ch2_state:{value:"ch2_state"},
power:{value:"ch1_power",ext:"%f",unit:"W"},powerTotal:{value:"ch1_powerTotal",ext:"%f",unit:"Wmin"}}}}:"roller"===this.mode?{type:"shutter",commands:{position:{type:"INT",min:0,max:100,unit:"%"},up:{},down:{},stop:{}},states:{position:{type:"INT",min:0,max:100,unit:"%"},state:{values:["open","closed","middle"]},lastDirection:{values:["open","closed"]},stopReason:{values:["normal","safety_switch","obstacle"]},power:{type:"FLOAT"},powerTotal:{type:"FLOAT"}},details:{commands:{position:{value:"position",
ext:"%d",extMeta:"0-100",unit:"%"},up:{value:"up"},down:{value:"down"},stop:{value:"stop"}},states:{position:{value:"position",ext:"%d",extMeta:"0-100",unit:"%"},state:{value:"roller_state",options:["open","closed","middle"]},lastDirection:{value:"roller_lastDirection",options:["open","closed"]},stopReason:{value:"roller_stopReason",options:["normal","safety_switch","obstacle"]},power:{value:"ch1_power",ext:"%f",unit:"W"},powerTotal:{value:"ch1_powerTotal",ext:"%f",unit:"Wmin"}}}}:null};
xnm.aio.shelly.Switch25=function(a,b){xnm.aio.shelly.GenericSwitch.call(this,a,b);this.type=xnm.aio.shelly.Switch25.TYPE;this.mode=this.mode||"relay"};xnm.aio.shelly.Switch25.TYPE="switch25";xnm.aio.shelly.Switch25.prototype=Object.create(xnm.aio.shelly.GenericSwitch.prototype);xnm.aio.shelly.Switch25.constructor=xnm.aio.shelly.Switch25;
xnm.aio.shelly.Switch25.prototype.toGeneralDevice=function(){return"relay"===this.mode?{type:"switch",commands:{on:{},off:{},toggle:{},ch2_on:{},ch2_off:{},ch2_toggle:{}},states:{state:{values:["on","off"]},ch2_state:{values:["on","off"]}},details:{commands:{on:{value:"ch1_on"},off:{value:"ch1_off"},toggle:{value:"ch1_toggle"},ch2_on:{value:"ch2_on"},ch2_off:{value:"ch2_off"},ch2_toggle:{value:"ch2_toggle"}},states:{state:{value:"ch1_state"},ch2_state:{value:"ch2_state"}}}}:"roller"===this.mode?{type:"blind",
commands:{position:{value:{type:"INT",min:0,max:100,unit:"%"}},up:{},down:{},stop:{}},states:{position:{type:"INT",min:0,max:100,unit:"%"},state:{values:["open","closed","middle"]}},details:{commands:{position:{value:"position",ext:"%d",extMeta:"0-100",unit:"%"},up:{value:"up"},down:{value:"down"},stop:{value:"stop"}},states:{position:{value:"position",ext:"%d",extMeta:"0-100",unit:"%"},state:{value:"roller_state",options:["open","closed","middle"]}}}}:null};
xnm.aio.shelly.GenericLight=function(a,b){xnm.aio.shelly.Device.call(this,a,b)};xnm.aio.shelly.GenericLight.prototype=Object.create(xnm.aio.shelly.Device.prototype);xnm.aio.shelly.GenericLight.constructor=xnm.aio.shelly.GenericLight;
xnm.aio.shelly.GenericLight.prototype._executeCommand=function(a,b){switch(a.value){case "blue":this.cmdSetSingleColor("blue",a.ext,b);break;case "brightness":this.cmdSetBrightness(a.ext,b);break;case "color":this.cmdSetColor(a.ext,b);break;case "gain":this.cmdSetGain(a.ext,b);break;case "green":this.cmdSetSingleColor("green",a.ext,b);break;case "mode":this.cmdSetMode(a.ext,b);break;case "off":this.cmdOff(b);break;case "on":this.cmdOn(b);break;case "red":this.cmdSetSingleColor("red",a.ext,b);break;
case "toggle":this.cmdToggle(b);break;case "white":this.cmdSetSingleColor("white",a.ext,b);break;case "effect":this.cmdSetEffect(a.ext,b);break;default:a=Error("Unknown command: "+a.value),xnm.aio.shelly._logger.log("warn","[GenericLight._executeCommand] "+a.message),b(a,null)}};
xnm.aio.shelly.GenericLight.prototype._getStateFromResult=function(a,b){if(!a||!b)return null;if(Array.isArray(a.lights)&&0<a.lights.length){var c=a.lights[0];switch(b){case "red":return Math.round(c.red/2.55);case "green":return Math.round(c.green/2.55);case "blue":return Math.round(c.blue/2.55);case "white":return Math.round(c.white/2.55);case "gain":return c.ison?c.gain:0;case "effect":return"function"===typeof this.getEffectName?this.getEffectName(c.effect):c.effect;case "brightness":return c.ison?
c.brightness:0;case "temp":return c.temp;case "mode":return c.mode;case "state":return c.ison?"on":"off"}}return xnm.aio.shelly.Device.prototype._getStateFromResult.call(this,a,b)};xnm.aio.shelly.GenericLight.prototype.cmdOff=function(a){var b={path:"light/0?turn=off"};this instanceof xnm.aio.shelly.RGBW2&&(b.path="color/0?turn=off");xnm.aio.shelly._logger.log("trace","[GenericLight.cmdOff] Sending request.");xnm.aio.shelly.doRequest(this,"GET",b,function(c,d){a&&a(c,d)})};
xnm.aio.shelly.GenericLight.prototype.cmdOn=function(a){var b={path:"light/0?turn=on"};this instanceof xnm.aio.shelly.RGBW2&&(b.path="color/0?turn=on");xnm.aio.shelly._logger.log("trace","[GenericLight.cmdOn] Sending request.");xnm.aio.shelly.doRequest(this,"GET",b,function(c,d){a&&a(c,d)})};
xnm.aio.shelly.GenericLight.prototype.cmdSetBrightness=function(a,b){if("number"!==typeof a||isNaN(a)||0>a||100<a)a=Error("Invalid value for brightness: "+a),xnm.aio.shelly._logger.log("error","[GenericLight.cmdSetBrightness] "+a.message),b&&b(a,null);else{var c={path:null};this instanceof xnm.aio.shelly.Dimmer?(c.path="light/0?",c.path=0===a?c.path+"turn=off":c.path+("turn=on&brightness="+a)):c.path="white/0?mode=white&turn=on&brightness="+a;xnm.aio.shelly._logger.log("trace","[GenericLight.cmdSetBrightness] Sending request.");
xnm.aio.shelly.doRequest(this,"GET",c,function(d,e){b&&b(d,e)})}};
xnm.aio.shelly.GenericLight.prototype.cmdSetColor=function(a,b){if("string"!==typeof a||6>a.length||9<a.length)a=Error("Invalid value for color: "+a),xnm.aio.shelly._logger.log("error","[GenericLight.cmdSetColor] "+a.message),b&&b(a,null);else{a=a.replace("#","");var c=parseInt(a.substring(0,2),16),d=parseInt(a.substring(2,4),16),e=parseInt(a.substring(4,6),16);c="&red="+c+("&green="+d)+("&blue="+e);8===a.length?(a=parseInt(a.substring(6,8),16),c+="&white="+a):c+="&white=0";a={path:"color/0?turn=on&mode=color"+
c};xnm.aio.shelly._logger.log("trace","[GenericLight.cmdSetColor] Sending request.");xnm.aio.shelly.doRequest(this,"GET",a,function(f,h){b&&b(f,h)})}};
xnm.aio.shelly.GenericLight.prototype.cmdSetEffect=function(a,b){"string"===typeof a&&"function"===typeof this.getEffectIndex&&(a=this.getEffectIndex(a));"number"!==typeof a||0>a?(a=Error("Invalid value for effect: "+a),xnm.aio.shelly._logger.log("error","[GenericLight.cmdSetEffect] "+a.message),b&&b(a,null)):(a={path:"color/0?turn=on&mode=color&effect="+a},xnm.aio.shelly._logger.log("trace","[GenericLight.cmdSetEffect] Sending request."),xnm.aio.shelly.doRequest(this,"GET",a,function(c,d){b&&b(c,
d)}))};
xnm.aio.shelly.GenericLight.prototype.cmdSetSingleColor=function(a,b,c){"number"!==typeof b||isNaN(b)||0>b||100<b?(a=Error("Invalid value for color: "+b),xnm.aio.shelly._logger.log("error","[GenericLight.cmdSetSingleColor] "+a.message),c&&c(a,null)):0>["red","green","blue","white"].indexOf(a)?(a=Error("Invalid value for key: "+a),xnm.aio.shelly._logger.log("error","[GenericLight.cmdSetSingleColor] "+a.message),c&&c(a,null)):(b=Math.round(2.55*b),a={path:"color/0?turn=on&mode=color&"+(a+"="+b)},xnm.aio.shelly._logger.log("trace",
"[GenericLight.cmdSetSingleColor] Sending request."),xnm.aio.shelly.doRequest(this,"GET",a,function(d,e){c&&c(d,e)}))};
xnm.aio.shelly.GenericLight.prototype.cmdSetGain=function(a,b){"number"!==typeof a||isNaN(a)||0>a||100<a?(a=Error("Invalid value for gain: "+a),xnm.aio.shelly._logger.log("error","[GenericLight.cmdSetGain] "+a.message),b&&b(a,null)):(a={path:"color/0?turn=on&mode=color&gain="+a},xnm.aio.shelly._logger.log("trace","[GenericLight.cmdSetGain] Sending request."),xnm.aio.shelly.doRequest(this,"GET",a,function(c,d){b&&b(c,d)}))};
xnm.aio.shelly.GenericLight.prototype.cmdSetMode=function(a,b){if(0>["color","white"].indexOf(a))a=Error("Invalid value for mode: "+a),xnm.aio.shelly._logger.log("error","[GenericLight.cmdSetMode] "+a.message),b&&b(a,null);else{var c={};c.path=this instanceof xnm.aio.shelly.RGBW2?"settings/?mode="+a:"light/0?turn=on&mode="+a;xnm.aio.shelly._logger.log("trace","[GenericLight.cmdSetMode] Sending request.");xnm.aio.shelly.doRequest(this,"GET",c,function(d,e){b&&b(d,e)})}};
xnm.aio.shelly.GenericLight.prototype.cmdToggle=function(a){var b={path:"light/0?turn=toggle"};this instanceof xnm.aio.shelly.RGBW2&&(b.path="color/0?turn=toggle");xnm.aio.shelly._logger.log("trace","[GenericLight.cmdToggle] Sending request.");xnm.aio.shelly.doRequest(this,"GET",b,function(c,d){a&&a(c,d)})};xnm.aio.shelly.Dimmer=function(a,b){xnm.aio.shelly.GenericLight.call(this,a,b);this.type=xnm.aio.shelly.Dimmer.TYPE};xnm.aio.shelly.Dimmer.TYPE="dimmer";xnm.aio.shelly.Dimmer.prototype=Object.create(xnm.aio.shelly.GenericLight.prototype);
xnm.aio.shelly.Dimmer.constructor=xnm.aio.shelly.Dimmer;
xnm.aio.shelly.Dimmer.prototype.toGeneralDevice=function(){return{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}}},states:{brightness:{type:"INT",min:0,max:100},state:{values:["on","off"]},power:{type:"FLOAT"},powerTotal:{type:"FLOAT"},tempC:{type:"FLOAT"},tempF:{type:"FLOAT"}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"brightness",ext:"%d",extMeta:"1-100",unit:"%"}},states:{brightness:{value:"brightness",
ext:"%d",extMeta:"1-100",unit:"%"},state:{value:"state"},power:{value:"ch1_power",ext:"%f",unit:"W"},powerTotal:{value:"ch1_powerTotal",ext:"%f",unit:"Wmin"},tempC:{value:"tempC",ext:"%f",unit:"\u00b0C"},tempF:{value:"tempF",ext:"%f",unit:"\u00b0F"}}}}};xnm.aio.shelly.EM3=function(a,b){xnm.aio.shelly.Device.call(this,a,b);this.type=xnm.aio.shelly.EM3.TYPE};xnm.aio.shelly.EM3.TYPE="em3";xnm.aio.shelly.EM3.prototype=Object.create(xnm.aio.shelly.Device.prototype);xnm.aio.shelly.EM3.constructor=xnm.aio.shelly.EM3;
xnm.aio.shelly.EM3.prototype._executeCommand=function(a,b){var c={path:null};switch(a.value){case "ch1_reset":c.path="emeter/0?reset_totals=1";break;case "ch2_reset":c.path="emeter/1?reset_totals=1";break;case "ch3_reset":c.path="emeter/2?reset_totals=1";break;case "reset_totals":c.path="reset_data"}xnm.aio.shelly._logger.log("trace","[EM3._executeCommand] Sending request.");xnm.aio.shelly.doRequest(this,"GET",c,function(d,e){b&&b(d,e)})};
xnm.aio.shelly.EM3.prototype._getStateFromResult=function(a,b){if(!a||!b)return null;var c=-1;0===b.indexOf("ch1_")?c=0:0===b.indexOf("ch2_")?c=1:0===b.indexOf("ch3_")&&(c=2);if(Array.isArray(a.emeters)&&0<=c){c=a.emeters[c];if(!c)return null;if(3===b.indexOf("_power"))return c.power;if(3===b.indexOf("_current"))return c.current;if(3===b.indexOf("_voltage"))return c.voltage;if(3===b.indexOf("_total"))return c.total;if(3===b.indexOf("_totalReturned"))return c.total_returned}return xnm.aio.shelly.Device.prototype._getStateFromResult.call(this,
a,b)};
xnm.aio.shelly.EM3.prototype.toGeneralDevice=function(){return{type:"meter",commands:{},states:{power:{type:"FLOAT"},ch2_power:{type:"FLOAT"},ch3_power:{type:"FLOAT"},current:{type:"FLOAT"},ch2_current:{type:"FLOAT"},ch3_current:{type:"FLOAT"},voltage:{type:"FLOAT"},ch2_voltage:{type:"FLOAT"},ch3_voltage:{type:"FLOAT"},total:{type:"FLOAT"},ch2_total:{type:"FLOAT"},ch3_total:{type:"FLOAT"},total_returned:{type:"FLOAT"},ch2_total_returned:{type:"FLOAT"},ch3_total_returned:{type:"FLOAT"}},details:{commands:{},states:{power:{value:"ch1_power",
ext:"%f",unit:"W"},ch2_power:{value:"ch2_power",ext:"%f",unit:"W"},ch3_power:{value:"ch3_power",ext:"%f",unit:"W"},current:{value:"ch1_current",ext:"%f",unit:"A"},ch2_current:{value:"ch2_current",ext:"%f",unit:"A"},ch3_current:{value:"ch3_current",ext:"%f",unit:"A"},voltage:{value:"ch1_voltage",ext:"%f",unit:"V"},ch2_voltage:{value:"ch2_voltage",ext:"%f",unit:"V"},ch3_voltage:{value:"ch3_voltage",ext:"%f",unit:"V"},total:{value:"ch1_total",ext:"%f",unit:"Wh"},ch2_total:{value:"ch2_total",ext:"%f",
unit:"Wh"},ch3_total:{value:"ch3_total",ext:"%f",unit:"Wh"},total_returned:{value:"ch1_totalReturned",ext:"%f",unit:"Wh"},ch2_total_returned:{value:"ch2_totalReturned",ext:"%f",unit:"Wh"},ch3_total_returned:{value:"ch3_totalReturned",ext:"%f",unit:"Wh"}}}}};xnm.aio.shelly.RGBW2=function(a,b){xnm.aio.shelly.GenericLight.call(this,a,b);this.type=xnm.aio.shelly.RGBW2.TYPE;this.mode=this.mode||"color"};xnm.aio.shelly.RGBW2.EFFECTS=["off","Meteor shower","Gradual change","Flash","Red/Green change"];
xnm.aio.shelly.RGBW2.TYPE="rgbw2";xnm.aio.shelly.RGBW2.prototype=Object.create(xnm.aio.shelly.GenericLight.prototype);xnm.aio.shelly.RGBW2.constructor=xnm.aio.shelly.RGBW2;
xnm.aio.shelly.RGBW2.prototype._executeCommand=function(a,b){switch(a.value){case "ch1_brightness":this.cmdSetWhiteBrightness(0,a.ext,b);break;case "ch2_brightness":this.cmdSetWhiteBrightness(1,a.ext,b);break;case "ch3_brightness":this.cmdSetWhiteBrightness(2,a.ext,b);break;case "ch4_brightness":this.cmdSetWhiteBrightness(3,a.ext,b);break;case "ch1_off":this.cmdWhiteOff(0,b);break;case "ch2_off":this.cmdWhiteOff(1,b);break;case "ch3_off":this.cmdWhiteOff(2,b);break;case "ch4_off":this.cmdWhiteOff(3,
b);break;case "ch1_on":this.cmdWhiteOn(0,b);break;case "ch2_on":this.cmdWhiteOn(1,b);break;case "ch3_on":this.cmdWhiteOn(2,b);break;case "ch4_on":this.cmdWhiteOn(3,b);break;case "ch1_toggle":this.cmdWhiteToggle(0,b);break;case "ch2_toggle":this.cmdWhiteToggle(1,b);break;case "ch3_toggle":this.cmdWhiteToggle(2,b);break;case "ch4_toggle":this.cmdWhiteToggle(3,b);break;default:xnm.aio.shelly.GenericLight.prototype._executeCommand.call(this,a,b)}};
xnm.aio.shelly.RGBW2.prototype._getColorHex=function(a,b,c,d){var e="#";a=Number(a).toString(16);b=Number(b).toString(16);c=Number(c).toString(16);2>a.length&&(a="0"+a);2>b.length&&(b="0"+b);2>c.length&&(c="0"+c);e+=a+b+c;"number"!==typeof d||isNaN(d)||(d=Number(d).toString(16),2>d.length&&(d="0"+d),e+=d);return e.toUpperCase()};
xnm.aio.shelly.RGBW2.prototype._getStateFromResult=function(a,b){if(!a||!b)return null;if(Array.isArray(a.lights)&&0<a.lights.length){var c=a.lights[0];if("color"===c.mode)switch(b){case "color":return this._getColorHex(c.red,c.green,c.blue);case "color_white":return this._getColorHex(c.red,c.green,c.blue,c.white);case "red":return Math.round(c.red/2.55);case "green":return Math.round(c.green/2.55);case "blue":return Math.round(c.blue/2.55);case "white":return c.ison?Math.round(c.white/2.55):0;case "gain":return c.ison?
c.gain:0;case "effect":return this.getEffectName(c.effect);case "mode":return c.mode;case "power":return c.power;case "state":return c.ison?"on":"off"}else if("white"===c.mode){switch(b){case "ch1_state":return a.lights[0].ison?"on":"off";case "ch1_brightness":return a.lights[0].brightness;case "ch1_power":return a.lights[0].power;case "mode":return a.lights[0].mode}if(1<a.lights.length)switch(b){case "ch2_state":return a.lights[1].ison?"on":"off";case "ch2_brightness":return a.lights[1].brightness;
case "ch2_power":return a.lights[1].power}if(2<a.lights.length)switch(b){case "ch3_state":return a.lights[2].ison?"on":"off";case "ch3_brightness":return a.lights[2].brightness;case "ch3_power":return a.lights[2].power}if(3<a.lights.length)switch(b){case "ch4_state":return a.lights[3].ison?"on":"off";case "ch4_brightness":return a.lights[3].brightness;case "ch4_power":return a.lights[3].power}}}return xnm.aio.shelly.Device.prototype._getStateFromResult.call(this,a,b)};
xnm.aio.shelly.RGBW2.prototype.cmdSetWhiteBrightness=function(a,b,c){"number"!==typeof b||isNaN(b)||0>b||100<b?(a=Error("Invalid value for brightness: "+b),xnm.aio.shelly._logger.log("error","[RGBW2.cmdSetWhiteBrightness] "+a.message),c&&c(a,null)):(a={path:"white/"+a+"?turn=on&brightness="+b},xnm.aio.shelly._logger.log("trace","[RGBW2.cmdSetWhiteBrightness] Sending request."),xnm.aio.shelly.doRequest(this,"GET",a,function(d,e){c&&c(d,e)}))};
xnm.aio.shelly.RGBW2.prototype.cmdWhiteOff=function(a,b){a={path:"white/"+a+"?turn=off"};xnm.aio.shelly._logger.log("trace","[RGBW2.cmdWhiteOff] Sending request.");xnm.aio.shelly.doRequest(this,"GET",a,function(c,d){b&&b(c,d)})};xnm.aio.shelly.RGBW2.prototype.cmdWhiteOn=function(a,b){a={path:"white/"+a+"?turn=on"};xnm.aio.shelly._logger.log("trace","[RGBW2.cmdWhiteOn] Sending request.");xnm.aio.shelly.doRequest(this,"GET",a,function(c,d){b&&b(c,d)})};
xnm.aio.shelly.RGBW2.prototype.cmdWhiteToggle=function(a,b){a={path:"white/"+a+"?turn=toggle"};xnm.aio.shelly._logger.log("trace","[RGBW2.cmdWhiteToggle] Sending request.");xnm.aio.shelly.doRequest(this,"GET",a,function(c,d){b&&b(c,d)})};xnm.aio.shelly.RGBW2.prototype.getEffectIndex=function(a){a=String(a).toLowerCase();for(var b=xnm.aio.shelly.RGBW2.EFFECTS,c=0;c<b.length;c++)if(b[c].toLowerCase()===a)return c;return 0};
xnm.aio.shelly.RGBW2.prototype.getEffectName=function(a){return xnm.aio.shelly.RGBW2.EFFECTS[a]||a};
xnm.aio.shelly.RGBW2.prototype.toGeneralDevice=function(){return"color"===this.mode?{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}},color:{value:{type:"RGB"}},color_white:{value:{type:"RGBW"}},red:{value:{type:"INT",min:0,max:100}},green:{value:{type:"INT",min:0,max:100}},blue:{value:{type:"INT",min:0,max:100}},white:{value:{type:"INT",min:0,max:100}},gain:{value:{type:"INT",min:0,max:100}},effect:{values:xnm.aio.shelly.RGBW2.EFFECTS.slice(0)}},states:{brightness:{type:"INT",
min:0,max:100},color:{type:"RGB"},color_white:{type:"RGBW"},red:{type:"INT",min:0,max:100},green:{type:"INT",min:0,max:100},blue:{type:"INT",min:0,max:100},white:{type:"INT",min:0,max:100},gain:{type:"INT",min:0,max:100},mode:{values:["color","white"]},state:{values:["on","off"]},power:{type:"FLOAT"},effect:{values:xnm.aio.shelly.RGBW2.EFFECTS.slice(0)}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"gain",ext:"%d",extMeta:"0-100",unit:"%"},color:{value:"color",
ext:"%rgb"},color_white:{value:"color",ext:"%rgbw"},red:{value:"red",ext:"%d",extMeta:"0-100"},green:{value:"green",ext:"%d",extMeta:"0-100"},blue:{value:"blue",ext:"%d",extMeta:"0-100"},white:{value:"white",ext:"100",extMeta:"0-100"},gain:{value:"gain",ext:"%d",extMeta:"0-100"},effect:{value:"effect",ext:"%e",options:xnm.aio.shelly.RGBW2.EFFECTS.slice(0)}},states:{brightness:{value:"gain",ext:"%d",extMeta:"0-100",unit:"%"},color:{value:"color",ext:"%rgb"},color_white:{value:"color_white",ext:"%rgbw"},
red:{value:"red",ext:"%d",extMeta:"0-100"},green:{value:"green",ext:"%d",extMeta:"0-100"},blue:{value:"blue",ext:"%d",extMeta:"0-100"},white:{value:"white",ext:"%d",extMeta:"0-100"},gain:{value:"gain",ext:"%d",extMeta:"0-100"},mode:{value:"mode"},state:{value:"state"},power:{value:"power",ext:"%f",unit:"W"},effect:{value:"effect"}}}}:"white"===this.mode?{type:"dimmer",commands:{on:{},off:{},brightness:{value:{type:"INT",min:0,max:100}},ch2_on:{},ch2_off:{},ch2_brightness:{value:{type:"INT",min:0,
max:100}},ch3_on:{},ch3_off:{},ch3_brightness:{value:{type:"INT",min:0,max:100}},ch4_on:{},ch4_off:{},ch4_brightness:{value:{type:"INT",min:0,max:100}}},states:{state:{values:["on","off"]},ch2_state:{values:["on","off"]},ch3_state:{values:["on","off"]},ch4_state:{values:["on","off"]},brightness:{type:"INT",min:0,max:100},ch2_brightness:{type:"INT",min:0,max:100},ch3_brightness:{type:"INT",min:0,max:100},ch4_brightness:{type:"INT",min:0,max:100},power:{type:"FLOAT"},ch2_power:{type:"FLOAT"},ch3_power:{type:"FLOAT"},
ch4_power:{type:"FLOAT"},mode:{values:["color","white"]}},details:{commands:{on:{value:"ch1_on"},off:{value:"ch1_off"},brightness:{value:"ch1_brightness",ext:"%d",extMeta:"0-100",unit:"%"},ch2_on:{value:"ch2_on"},ch2_off:{value:"ch2_off"},ch2_brightness:{value:"ch2_brightness",ext:"%d",extMeta:"0-100",unit:"%"},ch3_on:{value:"ch3_on"},ch3_off:{value:"ch3_off"},ch3_brightness:{value:"ch3_brightness",ext:"%d",extMeta:"0-100",unit:"%"},ch4_on:{value:"ch4_on"},ch4_off:{value:"ch4_off"},ch4_brightness:{value:"ch4_brightness",
ext:"%d",extMeta:"0-100",unit:"%"}},states:{state:{value:"ch1_state"},brightness:{value:"ch1_brightness",ext:"%d",extMeta:"0-100",unit:"%"},power:{value:"ch1_power",ext:"%f",unit:"W"},ch2_state:{value:"ch2_state"},ch2_brightness:{value:"ch2_brightness",ext:"%d",extMeta:"0-100",unit:"%"},ch2_power:{value:"ch2_power",ext:"%f",unit:"W"},ch3_state:{value:"ch3_state"},ch3_brightness:{value:"ch3_brightness",ext:"%d",extMeta:"0-100",unit:"%"},ch3_power:{value:"ch3_power",ext:"%f",unit:"W"},ch4_state:{value:"ch4_state"},
ch4_brightness:{value:"ch4_brightness",ext:"%d",extMeta:"0-100",unit:"%"},ch4_power:{value:"ch4_power",ext:"%f",unit:"W"},mode:{value:"mode"}}}}:null};xnm.aio.shelly.Handler=function(){var a=require("x.logger.js");a&&(xnm.aio.shelly._logger=a.getLogger("xnm.aio.shelly"))};
xnm.aio.shelly.Handler.prototype={devicemanager:xnm.aio.shelly.DM,discoverWithTimeout:function(a,b){var c=require("x.mdns.js");c.clearRecordBuffer();if("number"!==typeof a||isNaN(a))a=1E4;c.discoverServiceWithTimeout("_http._tcp.local",a,function(d,e){if(d)b&&b(d,null);else{for(var f=[],h=0;h<e.length;h++){var k=e[h];if(0===String(k.target).indexOf("shelly")&&k.ip&&0<k.ip.length&&k.info){var g=String(k.info.id).substring(6);g=g.split("-");g.splice(g.length-1,1);g=g.join("-");f.push({firmware:k.info.fw_id,
id:k.info.id,ip:k.ip[0],port:80,sys:xnm.aio.shelly.DM.SYS,type:g})}}b&&b(d,f)}})},doCommand:function(a,b,c){var d=this.resolveDevice(a);d?d.executeCommandCreator(a,b,function(e){c&&c(e)}):c&&c(Error("device format invalid"))},doStatus:function(a,b,c,d){(b=this.resolveDevice(b))?b.getStatesCreator(null,[{id:a,status:c}],function(e,f){e?d&&d(e):d&&d(null,f[0])}):d&&d(Error("device format invalid"))},getDeviceCommands:function(a,b){a=(a=xnm.aio.shelly.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?
a.command:[];b&&b(null,a)},getDeviceStatus:function(a,b){a=(a=xnm.aio.shelly.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)},registModule:function(a){a.register(xnm.aio.shelly.DM.SYS,"shelly")},resolveDevice:function(a){return a?xnm.aio.shelly.parseJSON(a):null}};"undefined"!==typeof exports&&"undefined"!==typeof module&&module.exports&&(exports=module.exports=new xnm.aio.shelly.Handler);
