var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.systemdata=xnm.aio.systemdata||{};
xnm.aio.systemdata.SystemData=function(){this._sceneData=this._sysData=null;this._dataKey="system";this._sceneKey="scenes";this.reset=function(){XC.localStorage.removeItem(this._dataKey);XC.localStorage.removeItem(this._sceneKey);this.init()};this.init=function(){this._sysData=this.load();if(!this._sysData||this._sysData.demo)this._sysData={rooms:[],devices:[],gateways:[]},this.save();this._sceneData=this.loadScenes();this._sceneData||(this._sceneData={groups:[{index:1,macros:[],name:"Gruppe",classid:"group"}]},
this.saveScenes())};this.save=function(a){a?(XC.localStorage.setJson(this._dataKey,a),this._sysData=a):XC.localStorage.setJson(this._dataKey,this._sysData)};this.saveScenes=function(a){a?(XC.localStorage.setJson(this._sceneKey,a),this._sceneData=a):XC.localStorage.setJson(this._sceneKey,this._sceneData)};this.load=function(){return XC.localStorage.getJson(this._dataKey)};this.loadScenes=function(){return XC.localStorage.getJson(this._sceneKey)};this._getNextIndex=function(a){if(0===a.length)return 1;
for(var b=0,c=0;c<a.length;c++)b<a[c].index&&(b=a[c].index);return b+1};this.addGateway=function(a,b){if(!("gtw"===b.common_type?0<this.getGateways(function(d){return d.info.address==b.address}).length:0<this.getGateways(function(d){return d.info.mac==b.mac}).length)){var c=this._getNextIndex(this._sysData.gateways);a=this._getFreeGatewayName(a);this._sysData.gateways.push({name:a,index:c,info:b});this.save();return this._sysData.gateways[this._sysData.gateways.length-1]}};this.saveGateway=function(a){for(var b=
0;b<this._sysData.gateways.length;b++){var c=this._sysData.gateways[b];if(c.index===a.index){c.name=a.name;c.user=a.user;c.pwd=a.pwd;c.tasks=a.tasks;c.info.ip=a.info.ip;c.info.sid=a.info.sid;c._codeNames=a._codeNames;c.info._token=a.info._token;c.info.server=a.info.server;c.info.firmware=a.info.firmware;c.info._cloudAccessActive=a.info._cloudAccessActive;this.save();XC.debugf("gateway changed saved");break}}};this.getGateways=function(a,b){b=void 0===b?!1:b;var c=this._sysData.gateways.slice(0);b||
(c=c.filter(function(e){return"aio"===e.info.sys&&"gtw"!==e.info.common_type||"cloudservice"===e.info.sys}));if(!a)return c;b=[];for(var d=0;d<c.length;d++)a(c[d])&&b.push(c[d]);return b};this.deleteGateways=function(a){for(var b=this._sysData.gateways.length;b--;)a(this._sysData.gateways[b])&&this._sysData.gateways.splice(b,1);this.save()};this.addRoom=function(a){a.index=this._getNextIndex(this._sysData.rooms);this._sysData.rooms.push(a);this.save();return a};this.saveRoom=function(a){for(var b=
0;b<this._sysData.rooms.length;b++){var c=this._sysData.rooms[b];if(c.index===a.index){c.name=a.name;c.type=a.type;this.save();break}}};this.getRooms=function(a){var b=this._sysData.rooms.slice(0);if(!a)return b;filtered=[];for(var c=0;c<b.length;c++)a(b[c])&&filtered.push(b[c]);return filtered};this.deleteRooms=function(a){for(var b=this._sysData.rooms.length;b--;)a(this._sysData.rooms[b])&&(this.deleteDevices(function(c){return c.room===this._sysData.rooms[b].index}.bind(this)),this._sysData.rooms.splice(b,
1));this.save()};this.addDevice=function(a){if(a)if(0<this.getDevices(function(b){return"CODE"!==b.info.type&&"FX3"!==b.info.type&&b.info.address&&a.info.address&&b.info.address==a.info.address}).length)this.addDeviceDuplicate&&"function"===typeof this.addDeviceDuplicate&&this.addDeviceDuplicate();else return a.index=this._getNextIndex(this._sysData.devices),a.cloud={enabled:!0},this._sysData.devices.push(a),this.save(),a};this.addDeviceDuplicate=null;this.saveDevice=function(a){for(var b=0;b<this._sysData.devices.length;b++){var c=
this._sysData.devices[b];if(c.index===a.index){c.name=a.name;c.order=a.order;c.info._isFav=a.info._isFav;c.info._target=a.info._target;this.save();break}}};this.getDevices=function(a){var b=this._sysData.devices.slice(0);if(!a)return b;filtered=[];for(var c=0;c<b.length;c++)a(b[c])&&filtered.push(b[c]);return filtered};this.deleteDevices=function(a){for(var b=this._sysData.devices.length;b--;)a(this._sysData.devices[b])&&(this._unlearnDevice(this._sysData.devices[b]),this._sysData.devices.splice(b,
1));this.save()};this.addScene=function(a){a.index=this._getNextIndex(this._getSceneList());a.cloud={enabled:!0};this._getSceneList().push(a);this.saveScenes();return a};this.saveScene=function(a){for(var b=this._getSceneList(),c=0;c<b.length;c++){var d=b[c];if(d.index===a.index){d.name=a.name;d.pause=a.pause;d.commands=a.commands;this.saveScenes();break}}};this.getScenes=function(a){var b=this._getSceneList().slice(0);if(!a)return b;for(var c=[],d=0;d<b.length;d++)a(b[d])&&c.push(b[d]);return c};
this.deleteScenes=function(a){for(var b=this._getSceneList(),c=b.length;c--;)a(b[c])&&b.splice(c,1);this.saveScenes()};this._getSceneList=function(){return this._sceneData.groups[0].macros};this.getHueGatewayInfo=function(a){return{ip:a.ip,sys:"hue",port:a.port,uuid:a.uuid,username:a._USER,password:""}};this.getV6Info=function(a){return{ip:a.IP,sn:a.SN,dns:a.DNS,mac:a.MAC,hwv:a.HWV,vid:a.VID,sys:"aio",name:a.NAME,dhcp:a.DHCP,server:a.SERVER,version:a.VER,gateway_vendor:"mediola"}};this.getV5PlusInfo=
function(a){return{ip:a.ip,tz:a.TZ,mac:a.mac,ntp:a.ntp,sys:"aio",lat:a.LAT,hwv:a.hwv,port:80,long:a.LONG,name:a.name,server:a.server,rfmode:a.RFM,username:"user",password:"",firmware:a.msv,gateway_vendor:"mediola",_cloudAccessActive:!(Number("0x"+a.cfg)&64)}};this._getFreeGatewayName=function(a){for(var b=this,c=1,d="",e=function(){return!b.getGateways(function(f){return f.name===a+d},!0)[0]};!e();)c++,d=" "+c;return a+d};this._unlearnDevice=function(a){var b=this._getGatewayByDevice(a);if(b){var c=
require("xnm.aio.gateway.js");if(b=c.resolveGateway(b.info))if(c=c.devicemanager.getSystem(a.info,b.info))c.delSensor&&c.delSensor(b,a.info.address,function(d){d&&XC.debugf("SystemData: unlearn device error: "+d)}),c.deleteDevice&&a.info.id&&c.deleteDevice(b,{id:a.info.id},function(d){d&&XC.debugf("SystemData: unlearn device error: "+d)})}};this._getGatewayByDevice=function(a){return this.getGateways(function(b){return b.index===a.info.gateway},!0)[0]};this.init()};xnm.aio.systemdata.Handler=function(){};
xnm.aio.systemdata.Handler.prototype.SystemData=xnm.aio.systemdata.SystemData;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.systemdata.Handler);
