var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tahoma=xnm.aio.tahoma||{};
xnm.aio.tahoma.Box=function(){var d={_cache:{},getCookie:function(a,b){return a||b?this._cache[(a?a:"")+":"+(b?b:"")]:null},setCookie:function(a,b,e){if(!a&&!b)return null;this._cache[(a?a:"")+":"+(b?b:"")]=e}},c=function(a,b,e){this._logger=require("x.logger.js").getLogger("xnm.aio.tahoma.Box");this.username=a;this.password=b};c.prototype.executeCommandCreator=function(a,b,e){this.executeCommand(a,b,function(b){e&&e(b)})};c.prototype.getStatesCreator=function(a,b,e){if(b)if(0==b.length)e&&e(null,
[]);else{for(var c=[],d=0;d<b.length;d++)if(b[d]&&b[d].device&&b[d].device.address&&b[d].status&&b[d].status.value){for(var k=b[d].device.address,h=!1,f=0;f<c.length;f++)if(c[f].address==k){h=!0;var l=c[f].states;-1==l.indexOf(b[d].status.value)&&l.push(b[d].status.value)}h||c.push({address:k,states:[b[d].status.value]})}this.getStates(a,c,function(a,c){var d=[];if(!a&&c)for(a=0;a<b.length;a++)if(b[a]&&b[a].id){var g="?";if(b[a].device&&b[a].device.address&&b[a].status&&b[a].status.value)for(var f=
0;f<c.length;f++)c[f].address==b[a].device.address&&(g=c[f].states[b[a].status.value]);g||(g="?");d.push({id:b[a].id,status:g})}e&&e(null,d)})}else e&&e(Error("deviceList is null"))};c.prototype.executeCommand=function(a,b,e){if(a&&a.address)if(b&&b.value){var c={actions:[]},d={deviceURL:a.address,commands:[]};c.actions.push(d);switch(b.value){case "on":case "off":case "close":case "down":case "my":case "open":case "reset":case "stop":case "up":d.commands.push({name:b.value});break;case "setOnOff":if(!b.ext||
"on"!=b.ext&&"off"!=b.ext){e&&e(Error("command ext invalid"));return}d.commands.push({name:b.value,parameters:[b.ext]});break;case "onWithTimer":if("undefined"==typeof b.ext||null==b.ext){e&&e(Error("command ext invalid"));return}var k=parseInt(b.ext);5>k&&(k=5);14400<k&&(k=14400);d.commands.push({name:b.value,parameters:[k]});break;case "setIntensity":if("undefined"==typeof b.ext||null==b.ext){e&&e(Error("command ext invalid"));return}k=parseInt(b.ext);0>k&&(k=0);100<k&&(k=100);d.commands.push({name:b.value,
parameters:[k]});break;default:e&&e(Error("command unknonwn"));return}var h=this;this.getExecutionID(a.address,function(a,d){a?e&&e(a):d?"stop"==b.value||"my"==b.value?h._cancelExecution(d,e):e&&e(Error("device running")):h._apply(c,e)})}else e&&e(Error("command invaild"));else e&&e(Error("device invaild"))};c.prototype.getStates=function(a,b,e){if(b&&0!=b.length){a=[];for(var c=0;c<b.length;c++)if(b[c]&&b[c].address&&b[c].states&&0<b[c].states.length){for(var d={deviceURL:b[c].address,states:[]},
k=0;k<b[c].states.length;k++)d.states.push({name:b[c].states[k]});a.push(d)}this._getStates(a,function(a,b){if(a)e&&e(a);else if(b&&b.devices){a=[];for(var c=0;c<b.devices.length;c++){var d=b.devices[c];if(d&&d.deviceURL&&d.states&&0<d.states.length){for(var g={address:d.deviceURL,states:{}},f=0;f<d.states.length;f++)g.states[d.states[f].name]=d.states[f].value;a.push(g)}}e&&e(null,a)}else e&&e(Error("get states return invalid response"))})}else e&&e(null,[])};c.prototype.listDevices=function(a){this._getSetup(function(b,
e){if(b)a&&a(b);else if(e&&e.setup){b={places:{},devices:[]};b.places=e.setup.rootPlace;e=e.setup.devices;for(var c=0;c<e.length;c++){var d=e[c];b.devices.push({sys:"tahoma",name:d.label,address:d.deviceURL,placeOID:d.placeOID,type:d.uiClass,definition:d.definition})}a&&a(null,b)}else a&&a(Error("get setup return format invalid"))})};c.prototype.getExecutionID=function(a,b){this._getCurrentExecutions(function(e,c){if(e)b&&b(e);else if(c&&c.executions){e=!1;for(var d=null,g=0;g<c.executions.length;g++){var h=
c.executions[g];if(h&&h.actionGroup&&h.actionGroup.actions){for(var f=h.actionGroup.actions,l=0;l<f.length;l++){var n=f[l];if(n&&n.deviceURL==a){e=!0;break}}if(e){d=h.id;break}}}b&&b(null,d)}else b&&b(null,null)})};c.prototype._cancelExecution=function(a,b){this._doExecRequest("DELETE","/current/setup/"+a,null,function(a){b&&b(a)})};c.prototype._getCurrentExecutions=function(a){this._doJsonRequest("/getCurrentExecutions",null,function(b,e){a&&a(b,e)})};c.prototype._apply=function(a,b){this._doJsonRequest("/apply",
JSON.stringify(a),function(a,c){b&&b(a,c)})};c.prototype._getStates=function(a,b){this._doJsonRequest("/getStates",JSON.stringify(a),function(a,c){b&&b(a,c)})};c.prototype._getSetup=function(a){this._doJsonRequest("/getSetup",null,function(b,e){a&&a(b,e)})};c.prototype._login=function(a){var b="userId="+encodeURIComponent(this.username)+"&userPassword="+encodeURIComponent(this.password),e=this;this._logger.log("debug","do login request with data:"+b);this._doRequest("POST","/externalAPI/json/login",
{"Content-Type":"application/x-www-form-urlencoded"},b,function(b,c,k){if(b)e._logger.log("warn","login failed with error:"+b.message),a&&a(b);else if(k&&200==k.statusCode)try{var g=JSON.parse(c);if(g.success){if(k.headers&&k.headers["set-cookie"]){var f=k.headers["set-cookie"];f.constructor===Array&&(f=f.join(";"));e._logger.log("debug","login success with cookie:"+f);d.setCookie(e.username,e.password,f)}a&&a(null,g)}else e._logger.log("warn","login failed with success not true:"+c),a&&a(Error("login fail"),
g)}catch(l){e._logger.log("warn","login error with invalid json response:"+c),a&&a(Error("login error with invalid json response"))}else e._logger.log("warn","login error with status code:"+(k?k.statusCode:-1)+" data:"+c),a&&a(Error("login error with status code:"+(k?k.statusCode:-1)))})};c.prototype._doJsonRequest=function(a,b,c){var e=this;this._logger.log("debug","do json request "+a+" data:"+JSON.stringify(b));this._doRequest("POST","/externalAPI/json"+a,{"Content-Type":"application/json"},b,
function(d,g,h){if(d)c&&c(d);else if(h&&401==h.statusCode)e._logger.log("warn","do json request return 401, try to login again"),e._login(function(d){d?c&&c(d):e._doJsonRequest(a,b,c)});else if(e._logger.log("debug","do json request return status code "+(h?h.statusCode:-1)),d=!h||200!=h.statusCode&&204!=h.statusCode?Error("http error with status code "+(h?h.statusCode:-1)):null)e._logger.log("warn","do json request return "+h.statusCode+" data:"+g),c&&c(d,g);else try{var f=JSON.parse(g);c&&c(null,
f)}catch(l){e._logger.log("warn","do json request return invalid json: "+g),c&&c(l)}})};c.prototype._doExecRequest=function(a,b,c,d){var e=this;this._logger.log("debug","do exec request "+b+" data:"+JSON.stringify(c));this._doRequest(a,"/enduserAPI/exec"+b,null,c,function(g,h,f){g?d&&d(g):f&&401==f.statusCode?(e._logger.log("warn","do exec request return 401, try to login again"),e._login(function(f){f?d&&d(f):e._doExecRequest(a,b,c,d)})):(e._logger.log("debug","do exec request return status code "+
(f?f.statusCode:-1)),(g=!f||200!=f.statusCode&&204!=f.statusCode?Error("http error with status code "+(f?f.statusCode:-1)):null)?(e._logger.log("warn","do exec request return "+f.statusCode+" data:"+h),d&&d(g,h)):d&&d(null,h))})};c.prototype._doRequest=function(a,b,c,g,m){a={host:"www.tahomalink.com",port:443,path:"/enduser-mobile-web"+b,method:a,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};if(c)for(var e in c)c.hasOwnProperty(e)&&(a.headers[e]=c[e]);g&&(a.headers["Content-Length"]=
g.length);(c=d.getCookie(this.username,this.password))&&(a.headers.Cookie=c);c=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");this._logger.log("trace","do request:"+JSON.stringify(a));var h=this,f=m,l=c.request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){h._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);f&&(f(null,b,
a),f=null)})});if(l.on)l.on("error",function(a){h._logger.log("trace","do request error:"+a.message);f&&(f(a),f=null)});l.setTimeout&&l.setTimeout(2E3,function(){h._logger.log("trace","do request timeout");l.abort();f&&(f(Error("timeout")),f=null)});l.setAllowRedirect&&l.setAllowRedirect(!1);g&&(this._logger.log("trace","do request send body:"+g),l.write(g));l.end()};c.prototype.toJSON=function(){return{sys:"tahoma",username:this.username,password:this.password}};c.prototype.equalsTo=function(a){return a&&
a instanceof c?this.username==a.username&&this.password==a.password:!1};return c}();
xnm.aio.tahoma.DM=function(){var d=function(c,a){this.code=c;this.message=a;this.stack=Error().stack};d.prototype=Error();d.prototype.name="TahomaDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"tahoma",getGatewayType:function(){return[{sys:this.SYS,name:"TaHoma Box"}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"Light",name:"Light"},{sys:this.SYS,type:"OnOff",name:"Switch"},{sys:this.SYS,type:"RollerShutter",
name:"Blind"}]},createGateway:function(c,a,b){a=d.ERROR_CODE;c?c.username?c.password?b(null,c):b(new d(a.INVALID,"password is invalid")):b(new d(a.INVALID,"username is invalid")):b(new d(a.INVALID,"info is invalid"))},updateGateway:function(c,a,b,e){c=d.ERROR_CODE;a?a.username?a.password?e(null,a):e(new d(c.INVALID,"password is invalid")):e(new d(c.INVALID,"username is invalid")):e(new d(c.INVALID,"update is invalid"))},deleteGateway:function(c,a,b){b()},createDevice:function(c,a,b){var e=d.ERROR_CODE;
if(c)if(c.gateway)if(c.address)if(c.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var g;for(g=0;g<a.length;g++)if(a[g].index===c.gateway){var m=a[g];break}m?b(null,c):b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else b(new d(e.INVALID,"type is invalid"));else b(new d(e.INVALID,"address is invalid"));else b(new d(e.INVALID,"gateway is invalid"));else b(new d(e.INVALID,"info is invalid"))},
updateDevice:function(c,a,b){var e=d.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(c.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var g;for(g=0;g<a.length;g++)if(a[g].index===c.gateway){var m=a[g];break}m?b(null,c):b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else b(new d(e.INVALID,"type is invalid"));else b(new d(e.INVALID,"address is invalid"));else b(new d(e.INVALID,
"gateway is invalid"));else b(new d(e.INVALID,"info is invalid"))},deleteDevice:function(c,a,b){b()},applyUIFilter:function(c,a){var b=this,d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},g=function(a,b,c){var e=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),
e.push(a))})}return e},m=function(a,c){var d=[],e=b.getCommandStatusMap(a);e&&(a=g(e,a,c),d=d.concat(a));return d};if(!c||null==c.type||"undefined"==typeof c.type)return null;var k=JSON.parse(JSON.stringify(c)),h=null;switch(a.catagory){case "command":h=m(c,a);k.command=h;break;case "status":h=m(c,a);k.status=h;break;default:return null}return h&&0!=h.length?k:null},getCommandStatusMap:function(c){if(!c||!c.definition)return null;var a={command:[],status:[]},b=c.definition.commands;b&&b.forEach(function(b){if(b)switch(b.commandName){case "on":a.command.push({type:"enum",
name:"on",ref:{value:"on"}});break;case "off":a.command.push({type:"enum",name:"off",ref:{value:"off"}});break;case "setOnOff":a.command.push({type:"enum",name:"set on/off",ref:{value:"setOnOff",ext:"%e",extMeta:["on","off"]}});break;case "onWithTimer":a.command.push({type:"int",name:"on for",ref:{value:"onWithTimer",ext:"%d",extMeta:"5-14400"}});break;case "close":a.command.push({type:"enum",name:"close",ref:{value:"close"}});break;case "down":a.command.push({type:"enum",name:"down",ref:{value:"down"}});
break;case "my":a.command.push({type:"enum",name:"my",ref:{value:"my"}});break;case "open":a.command.push({type:"enum",name:"open",ref:{value:"open"}});break;case "reset":a.command.push({type:"enum",name:"reset",ref:{value:"reset"}});break;case "stop":a.command.push({type:"enum",name:"stop",ref:{value:"stop"}});break;case "up":a.command.push({type:"enum",name:"up",ref:{value:"up"}});break;case "setIntensity":a.command.push({type:"int",name:"dim to",ref:{value:"setIntensity",ext:"%d"}})}});(c=c.definition.states)&&
c.forEach(function(b){if(b)switch(b.qualifiedName){case "core:OnOffState":a.status.push({type:"enum",name:"on/off state",ref:{value:"core:OnOffState",options:["on","off"]}});break;case "core:LightIntensityState":a.status.push({type:"int",name:"dimmer level",ref:{value:"core:LightIntensityState",ext:"%d"}})}});return a}}}();xnm.aio.tahoma.Handler=function(){this.detectedHomebases={}};xnm.aio.tahoma.Handler.prototype.Box=xnm.aio.tahoma.Box;xnm.aio.tahoma.Handler.prototype.devicemanager=xnm.aio.tahoma.DM;
xnm.aio.tahoma.Handler.prototype.registModule=function(d){d.register(this.devicemanager.SYS,"tahoma")};xnm.aio.tahoma.Handler.prototype.resolveGateway=function(d){return d&&d.username?new this.Box(d.username,d.password):null};xnm.aio.tahoma.Handler.prototype.getDeviceCommands=function(d,c){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}))?d.command:[];c&&c(null,d)};
xnm.aio.tahoma.Handler.prototype.getDeviceStatus=function(d,c){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}))?d.status:[];c&&c(null,d)};xnm.aio.tahoma.Handler.prototype.doCommand=function(d,c,a,b){(d=this.resolveGateway(d))?d.executeCommandCreator(c,a,function(a){b&&b(a)}):b&&b(Error("gateway json format invalid"))};
xnm.aio.tahoma.Handler.prototype.doStatus=function(d,c,a,b,e){(c=this.resolveGateway(c))?c.getStatesCreator(null,[{id:d,device:a,status:b}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};xnm.aio.tahoma.Handler.prototype.getDeviceList=function(d,c){(d=this.resolveGateway(d))?d.listDevices(function(a,b){c&&c(a,b)}):c&&c(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.tahoma.Handler);
