var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};
$jscomp.polyfill=function(a,b,c,h){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,h):$jscomp.polyfillUnisolated(a,b,c,h))};$jscomp.polyfillUnisolated=function(a,b,c,h){c=$jscomp.global;a=a.split(".");for(h=0;h<a.length-1;h++){var d=a[h];if(!(d in c))return;c=c[d]}a=a[a.length-1];h=c[a];b=b(h);b!=h&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,h){var d=a.split(".");a=1===d.length;h=d[0];h=!a&&h in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var e=0;e<d.length-1;e++){var l=d[e];if(!(l in h))return;h=h[l]}d=d[d.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?h[d]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,d,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[d]&&($jscomp.propertyToPolyfillSymbol[d]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(d):
$jscomp.POLYFILL_PREFIX+d),$jscomp.defineProperty(h,$jscomp.propertyToPolyfillSymbol[d],{configurable:!0,writable:!0,value:b})))};$jscomp.polyfill("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(b,c){var h=this;h instanceof String&&(h=String(h));var d=h.length;c=c||0;for(0>c&&(c=Math.max(c+d,0));c<d;c++){var e=h[c];if(e===b||Object.is(e,b))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(b,c){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,c||0)}},"es6","es3");
$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var h=a.length,d=0;d<h;d++){var e=a[d];if(b.call(c,e,d,a))return{i:d,v:e}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(b,c){return $jscomp.findInternal(this,b,c).v}},"es6","es3");$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(a){if(a)return a;var b=function(d,e){this.$jscomp$symbol$id_=d;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:e})};b.prototype.toString=function(){return this.$jscomp$symbol$id_};var c=0,h=function(d){if(this instanceof h)throw new TypeError("Symbol is not a constructor");return new b("jscomp_symbol_"+(d||"")+"_"+c++,d)};return h},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<b.length;c++){var h=$jscomp.global[b[c]];"function"===typeof h&&"function"!=typeof h.prototype[a]&&$jscomp.defineProperty(h.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){a instanceof String&&(a+="");var c=0,h=!1,d={next:function(){if(!h&&c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}h=!0;return{done:!0,value:void 0}}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.taskmanager=xnm.aio.taskmanager||{};xnm.aio.taskmanager.Taskmanager=function(){};xnm.aio.taskmanager.Taskmanager.prototype.setCloudService=function(a){this._cloudService=a;this._cloudTM=new require("xnm.aio.cloudTaskmanager");this._cloudTM.setCloudService(a);this._cloudTM.setCloudAccessUrl(this._cloudAccessUrl);return this};xnm.aio.taskmanager.Taskmanager.prototype.setWebserviceUrl=function(a){this._webServiceUrl=a;return this};
xnm.aio.taskmanager.Taskmanager.prototype.setCloudAccessUrl=function(a){this._cloudAccessUrl=a;this._cloudTM&&this._cloudTM.setCloudAccessUrl(this._cloudAccessUrl);return this};xnm.aio.taskmanager.Taskmanager.prototype.setAuth=function(a){this._auth=a;return this};xnm.aio.taskmanager.Taskmanager.prototype.setSystemData=function(a){xnm.aio.taskmanager.SystemData=a;return this};
xnm.aio.taskmanager.Taskmanager.prototype.runTask=function(a,b){(xnm.aio.taskmanager.isVx(a.aio)?xnm.aio.taskmanager.runVxTask:xnm.aio.taskmanager.runVxProTask)(a,b)};xnm.aio.taskmanager.Taskmanager.prototype.saveTask=function(a,b){xnm.aio.taskmanager.isVx(a.aio)?this.runVxSaving(a,b):this.runVxProSaving(a,b)};
xnm.aio.taskmanager.Taskmanager.prototype.runVxSaving=function(a,b){var c=a.root.if.filter(function(e){return e.cloud}),h=a.root.then[0].then.filter(function(e){return e.cloud});a.root.if=a.root.if.filter(function(e){return!e.cloud});a.root.then[0].then=a.root.then[0].then.filter(function(e){return!e.cloud});var d=[];d=[xnm.aio.taskmanager.addVxLocalCloudActions.bind(this,a,h),this.createVxEspActions.bind(this,a),xnm.aio.taskmanager.saveVxTask.bind(this,a,d),this.saveVxSnsData.bind(this,a,d)];xnm.aio.taskmanager.hasCloudDevices()&&
d.push(this._cloudTM.saveVxCloudData.bind(this._cloudTM,a,c,h));(new xnm.aio.taskmanager.FunctionStack(d)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.runVxProSaving=function(a,b){var c=a.root.if.filter(function(e){return e.cloud}),h=a.root.then[0].then.filter(function(e){return e.cloud}),d=xnm.aio.taskmanager.SystemData.getGateways(function(e){return"cloudservice"===e.info.sys})[0];d&&(d.info.__neoIndex=d.index,c.forEach(function(e){e.type="cloud.trigger.device";e.gateway=d.info}),h.forEach(function(e){e.gateway=d.info}));xnm.aio.taskmanager.convertVxProTimespan(a);h=[this.saveVxProSnsData.bind(this,a),
xnm.aio.taskmanager.saveVxProTask.bind(this,a)];xnm.aio.taskmanager.hasCloudDevices()&&h.push(this._cloudTM.saveVxProCloudData.bind(this._cloudTM,a,c));(new xnm.aio.taskmanager.FunctionStack(h)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.deleteTask=function(a,b){var c=xnm.aio.taskmanager.isVx(a.aio)?xnm.aio.taskmanager.deleteVxTask:xnm.aio.taskmanager.deleteVxProTask,h=xnm.aio.taskmanager.isVx(a.aio)?this._cloudTM.deleteVxCloudData:this._cloudTM.deleteVxProCloudData;c=[c.bind(this,a)];xnm.aio.taskmanager.hasCloudDevices()&&c.push(h.bind(this._cloudTM,a));xnm.aio.taskmanager.isVx(a.aio)&&c.push(this.deleteEspActions.bind(this,a));(new xnm.aio.taskmanager.FunctionStack(c)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.setTaskActive=function(a,b,c){(xnm.aio.taskmanager.isVx(a.aio)?xnm.aio.taskmanager.setVxTaskActive:xnm.aio.taskmanager.setVxProTaskActive)(a,b,c)};xnm.aio.taskmanager.Taskmanager.prototype.clear=function(a){xnm.aio.taskmanager.isVx(a)&&xnm.aio.taskmanager.getVxTasks(a,function(b,c){b||c.forEach(function(h){return xnm.aio.taskmanager.deleteVxElement(a,h)})})};
xnm.aio.taskmanager.Taskmanager.prototype.getAllTasks=function(a,b){function c(f){return function(g,m){g||!Array.isArray(m)?k=g||Error("Unknown"):(g=h?xnm.aio.taskmanager.mapVxTasksToPro(f,m):m.map(function(r){r.aio=f;xnm.aio.taskmanager.reconvertVxProTimespan(r);return r}),e=e.concat(g));++l===a.length&&b(k,e)}}if(!Array.isArray(a)||!a.length)return b(Error("invalid params"));var h=xnm.aio.taskmanager.isVx(a[0]),d=h?xnm.aio.taskmanager.getVxTasks:xnm.aio.taskmanager.getVxProTasks,e=[],l=0;a.forEach(function(f){return d(f,
c(f))});var k=null};xnm.aio.taskmanager.getGroups=function(a,b){var c=function(h,d){return d.filter(function(e){return e.group&&e.group.includes(h.sid)}).map(function(e){return e.sid})};a._executeRequest("getStates",{config:1},null,function(h,d){if(h)return b(h);if(!Array.isArray(d))return b(null,[]);h=d.filter(function(e){return"SGROUP"==e.type}).map(function(e){e.devices=c(e,d);return e});b(null,h)})};
xnm.aio.taskmanager.Taskmanager.prototype.markGroupActions=function(a,b){xnm.aio.taskmanager.getGroups(a.aio,function(c,h){c&&b(c);var d=h.map(function(e){return e.sid});a.root.then[0].then.forEach(function(e){e.device&&d.includes(e.device.sid)&&(e.group=h.find(function(l){return l.sid==e.device.sid}),e.subtype="group")});b(null,{})})};
xnm.aio.taskmanager.Taskmanager.prototype.fetchDetailData=function(a,b){var c=[this.unifyStructure.bind(this,a),this.addSnsData.bind(this,a)];xnm.aio.taskmanager.isVx(a.aio)&&c.push(this.addEspActionData.bind(this,a));xnm.aio.taskmanager.hasCloudDevices()&&c.push(this.addCloudData.bind(this,a));xnm.aio.taskmanager.isSelve(a.aio)&&c.push(this.markGroupActions.bind(this,a));(new xnm.aio.taskmanager.FunctionStack(c)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.unifyStructure=function(a,b){a=a.root;a.if||(a.if=[]);a.then||(a.then=[]);a.then[0]||(a.then[0]={if:[],then:[],type:"condition"});if(!a.then[0].then){var c=a.then;delete a.then;a.then=[{if:[],then:c,type:"condition"}]}b(null,{})};xnm.aio.taskmanager.Taskmanager.prototype.addCloudData=function(a,b){return xnm.aio.taskmanager.isVx(a.aio)?this._cloudTM.addVxCloudData(a,b):this._cloudTM.addVxProCloudData(a,b)};
xnm.aio.taskmanager.Taskmanager.prototype.addSnsData=function(a,b){var c=["EMAIL","PUSH","SMS"],h=[],d=function(e,l){$.ajax({method:"GET",url:this._webServiceUrl+(e.isVx?"ai2/m.php":"xhub/sns/getsns"),headers:{Authorization:this._auth},data:e.isVx?{XC_FNC:"getMessage",SID:a.aio._sid,AID:e.id}:{token:e.token},success:function(k){e.isVx?(k=k.replace("{XC_SUC}",""),k=JSON.parse(k||"{}"),e.recipients=k.mail,"PUSH"===k.snsType&&(e.subtype="PUSH")):(e.recipients=k.recipients,e.subject=k.subject);e.message=
k.message;e.snsType=k.snsType;"no such action"===e.message&&(e.failed=!0,e.message="");l(null,k)},error:function(k){e.failed=!0;l(null,{})}})};a.root.then[0].then.forEach(function(e){c.includes(e.subtype)&&h.push(d.bind(this,e))}.bind(this));(new xnm.aio.taskmanager.FunctionStack(h)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.saveVxProSnsData=function(a,b){var c=["EMAIL","PUSH","SMS"],h=[],d=function(e,l){var k=e.message;"string"===typeof k&&(k={subject:"",snsType:e.snsType,message:e.message,recipients:e.recipients});$.ajax({method:"POST",url:this._webServiceUrl+"xhub/sns/setsns",contentType:"application/json; charset=utf-8",headers:{Authorization:this._auth},data:JSON.stringify(k),success:function(f){if(f&&f.error)return l(f,null);e.isVx||(e.token=f.token);l(null,f)},error:function(){e.failed=
!0;l(null,{})}})};a.root.then[0].then.forEach(function(e){c.includes(e.subtype)&&h.push(d.bind(this,e))}.bind(this));(new xnm.aio.taskmanager.FunctionStack(h)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.saveVxSnsData=function(a,b,c){var h=function(d,e){XC.debugf(d);$.ajax({method:"POST",url:this._webServiceUrl+"ai2/m.php?XC_FNC=setMessage&SID="+a.aio._sid+"&AID="+d.id,contentType:"application/x-www-form-urlencoded",headers:{Authorization:this._auth},data:{data:JSON.stringify({sns:"PUSH"===d.snsType?"PUSH":void 0,email:d.recipients,message:d.message})},success:function(l){if(l&&l.error)return e(l,null);e()},error:function(l){d.failed=!0;e(null,{})}})};b=b.map(function(d){return h.bind(this,
d)}.bind(this));(new xnm.aio.taskmanager.FunctionStack(b)).start(c)};
xnm.aio.taskmanager.Taskmanager.prototype.addEspActionData=function(a,b){a.espActionIds=[];a.aio._executeRequest("/api/actions",null,null,function(c,h){a.root.then[0].then.filter(function(d){return d.ipDevice}).forEach(function(d){var e=parseInt(d.code,16);a.espActionIds.push(e);e=h[e]||{};d.ipDevEvent=!0;d.command={ref:{value:e.command,ext:e.value}};d.device={id:e.id,ipDevice:!0};"alarm"==e.command&&(d.type="action",d.subtype="audio")});b()})};
xnm.aio.taskmanager.Taskmanager.prototype.createVxEspActions=function(a,b){var c=this,h=[],d=function(f,g){a.aio._executeRequest("/data/act/"+f,null,{method:"POST"},g)},e=a.espActionIds?a.espActionIds.map(function(f){return d.bind(c,f)}):[],l=function(f,g){var m;a:if(h.length){for(m=1;255>m;m++)if(!h.includes(m))break a;m=void 0}else m=1;h.push(m);f.espId=m;a.aio._executeRequest("/data/act/"+m,{id:f.device.id,command:f.command.ref.value,value:f.command.ref.ext},{method:"POST"},g)},k=a.root.then[0].then.filter(function(f){return"action"===
f.type&&f.device&&"aio"===f.device.sys&&f.device.mod}).map(function(f){return l.bind(c,f)});e=[].concat($jscomp.arrayFromIterable(e),[function(f){a.aio._executeRequest("/api/actions",null,null,function(g,m){if(g||!m)return f("ESP Error");h=Object.keys(m).map(function(r){return parseInt(r)});f(g,m)})}],$jscomp.arrayFromIterable(k));(new xnm.aio.taskmanager.FunctionStack(e)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.deleteEspActions=function(a,b){var c=this,h=function(e,l){a.aio._executeRequest("/data/act/"+e,null,{method:"POST"},l)},d=a.root.then[0].then.filter(function(e){return e.ipDevice}).map(function(e){e=parseInt(e.code,16);return h.bind(c,e)});(new xnm.aio.taskmanager.FunctionStack(d)).start(b)};xnm.aio.taskmanager.hasCloudDevices=function(){return 0<xnm.aio.taskmanager.SystemData.getDevices(function(a){return"cloudservice"==a.info.sys}).length};
xnm.aio.taskmanager.mapVxTasksToPro=function(a,b){function c(d,e){try{return h.tasks.find(function(l){return l.id==e}).name}catch(l){return"Task "+e}}var h=xnm.aio.taskmanager.SystemData.getGateways(function(d){return d.info.mac==a._mac})[0];return b.filter(function(d){return"GROUP"==d.sys}).map(function(d){var e={id:d.id,aio:a,root:{},name:c(a,d.id),active:1==d.active,isAlarmTask:"FF"==d.id};e.root.if=[];0<d.triggerids.length&&(e.root.if=d.triggerids.match(/.{1,2}/g).map(function(k){var f={},g=b.find(function(m){return["EVENT",
"SEVENT","TASK","ASTRO"].includes(m.sys)&&m.id==k});if(!g)return null;switch(g.sys){case "EVENT":f="IRCODE"===g.type?{type:"ir",ir:{code:g.code}}:{type:"device.status",device:{type:g.type,address:g.code},status:g.code};break;case "SEVENT":f={type:"device.status",proEvent:!0,device:{sid:g.device},status:g.condition.state,value:g.condition.value,op:g.condition.type};break;case "TASK":f={op:"=",type:"timer",time:g.time,week:g.days,start:g.dateStart,end:g.dateEnd};break;case "ASTRO":f=parseInt(g.delay,
16),0<(f&32768)&&(f-=65536),f={type:"astro",astro:1==g.time?"sunrise":"sunset",delay:f,week:g.days,start:g.dateStart,end:g.dateEnd}}f.id=g.id;f.active=g.active;return f}).filter(function(k){return null!=k}));e.root.then=[{if:[],then:[]}];if(d.conditionids&&0<d.conditionids.length){e.root.then[0].if=d.conditionids.match(/.{1,2}/g).map(function(k){var f={},g=b.find(function(m){return["TIME","SEVENT"].includes(m.sys)&&m.id==k});if(!g)return null;switch(g.sys){case "TIME":f="00:00"===g.start||"00:00"===
g.end?{type:"timer",op:"00:00"===g.start?"<=":">=",time:"00:00"===g.start?g.end:g.start,week:g.days,start:g.dateStart,end:g.dateEnd}:{type:"timespan",startTime:g.start,endTime:g.end,week:g.days,start:g.dateStart,end:g.dateEnd};break;case "SEVENT":f={type:"device.status",proEvent:!0,device:{sid:g.device},status:g.condition.state,value:g.condition.value,op:g.condition.type}}f.id=g.id;f.active=g.active;return f}).filter(function(k){return null!=k});var l=[];e.root.then[0].if.forEach(function(k){l.push(k);
l.push({type:"logic.operator",op:"AND"})});l.pop();e.root.then[0].if=l}0<d.actionids.length&&(e.root.then[0].then=d.actionids.match(/.{1,2}/g).map(function(k){var f={},g=b.find(function(m){return["ACTION","DEVICEACTION"].includes(m.sys)&&m.id==k});if(!g)return null;switch(g.sys){case "DEVICEACTION":f={type:"action",subtype:"command",proEvent:!0,device:{sid:g.device},command:{ref:{ext:g.value,value:g.cmd}},gateway:null};break;case "ACTION":f="RGB"===g.type?{type:"action",subtype:"command",gwRgb:!0,
command:{type:"enum",ref:{value:{"0000":"ledOff","0001":"ledGreen","0002":"ledBlue","0003":"ledRed","0004":"ledYellow","0005":"ledWhite","0006":"ledPurple","0007":"ledCyan"}[g.code]}}}:"CLOUD"===g.type?{type:"CLOUD",internal:!0}:"AIO"===g.type?{type:"action",subtype:"EMAIL",isVx:!0}:"IP"===g.type?{type:"action",subtype:"command",ipDevice:!0,code:g.code}:{type:"action",subtype:"command",device:{type:g.type,address:g.code},command:{ref:{value:g.code}},gateway:null}}f.id=g.id;return f}).filter(function(k){return null!=
k}));return e})};
xnm.aio.taskmanager.mapProTaskToVx=function(a){var b=this,c="",h="",d="",e=a.root.if.filter(function(f){return!f.internal}).map(function(f){var g={};d+=f.id;switch(f.type){case "device.status":g=f.device.proDevice?{sys:"SEVENT",device:f.device.sid,condition:{type:f.op,state:f.status,value:f.value}}:{sys:"EVENT",type:f.device.type,code:f.code};break;case "timer":g={sys:"TASK",days:f.week,time:f.time,dateStart:f.start||"2000-00-00",dateEnd:f.end||"2099-00-00"};break;case "ir":g={sys:"EVENT",type:"IRCODE",
code:f.ir.code};break;case "astro":g=f.delay,0>g&&(g+=65536),g=b.intToStrHex(g,4),g={sys:"ASTRO",active:1,days:f.week,time:"sunrise"===f.astro?1:2,dateStart:f.start,dateEnd:f.end,delay:g,t:"00:00"}}g.id=f.id;g.active="1";return g}),l=a.root.then[0].if.filter(function(f){return!f.internal}).filter(function(f){return"logic.operator"!==f.type}).map(function(f){var g={};h+=f.id;switch(f.type){case "timer":g={sys:"TIME",days:f.week,start:"<="===f.op?"00:00":f.time,end:">="===f.op?"00:00":f.time,dateStart:f.start||
"2000-00-00",dateEnd:f.end||"2099-00-00"};break;case "timespan":g={sys:"TIME",days:f.week,start:f.startTime,end:f.endTime,dateStart:f.start||"2000-00-00",dateEnd:f.end||"2099-00-00"};break;case "device.status":g={sys:"SEVENT",device:f.device.sid,condition:{type:f.op,state:f.status,value:f.value}}}g.id=f.id;g.active="1";return g}),k=a.root.then[0].then.map(function(f){var g={};c+=f.id;switch(f.type){case "CLOUD":g={type:"CLOUD",sys:"ACTION"};break;case "action":"EMAIL"===f.subtype||"PUSH"===f.subtype?
(g={code:"",type:"AIO",sys:"ACTION",snsType:f.subtype},"string"===typeof f.message?(g.message=f.message,g.recipients=f.recipients):(g.message=f.message.message,g.recipients=f.message.recipients)):g=f.gwRgb?{type:"RGB",sys:"ACTION",code:{ledOn:"0005",ledOff:"0000",ledGreen:"0001",ledBlue:"0002",ledRed:"0003",ledYellow:"0004",ledWhite:"0005",ledPurple:"0006",ledCyan:"0007"}[f.command.ref.value]}:f.device.proDevice?{sys:"DEVICEACTION",device:f.device.sid,cmd:f.command.ref.value,value:f.command.ref.ext}:
f.device.ipDevice?{sys:"ACTION",type:"IP",code:xnm.aio.taskmanager.intToStrHex(f.espId)}:{sys:"ACTION",type:f.sys,code:f.command.ref.value}}g.id=f.id;return g});return{group:{id:a.id,sys:"GROUP",actionids:c,conditionids:h,triggerids:d,active:a.active?"1":"0"},actions:k,triggers:e,conditions:l}};
xnm.aio.taskmanager.convertVxProTimespan=function(a){var b=[];a.root.then[0].if.forEach(function(c){if("timespan"!==c.type)return b.push(c);b.push({type:"timer",op:">=",time:c.startTime,week:c.week,start:c.start,end:c.end},{type:"logic.operator",op:"AND"},{type:"timer",op:"<=",time:c.endTime,week:c.week,start:c.start,end:c.end})});a.root.then[0].if=b};
xnm.aio.taskmanager.reconvertVxProTimespan=function(a){for(var b=[],c=a.root.then[0].if||a.root.then[1].if,h=0;h<c.length;h++){var d=c[h];if("timer"!==d.type)b.push(d);else{var e=c[h+1],l=c[h+2];"timer"===d.type&&">="===d.op&&e&&l&&"AND"===e.op&&"timer"===l.type&&"<="===l.op&&d.week===l.week&&d.start===l.start&&d.end===l.end?(b.push({type:"timespan",startTime:d.time,endTime:l.time,week:d.week,start:d.start,end:d.end}),h+=2):b.push(d)}}a.root.then[0].if=b};
xnm.aio.taskmanager.getVxIdList=function(a,b){return a.filter(function(c){return b.includes(c.sys)}).map(function(c){return c.id})};xnm.aio.taskmanager.getNextVxElementId=function(a){if(!a.length)return xnm.aio.taskmanager.intToStrHex(1);for(var b=1;255>b;b++){var c=xnm.aio.taskmanager.intToStrHex(b);if(!a.includes(c))return c}return null};xnm.aio.taskmanager.runVxTask=function(a,b){a.aio._executeRequest("doGroup",{id:a.id},null,b)};
xnm.aio.taskmanager.runVxProTask=function(a,b){xnm.aio.taskmanager._callVxPro(a.aio,"doTask",{id:a.id},b)};xnm.aio.taskmanager.getVxTasks=function(a,b){a._executeRequest("GetAll",null,null,function(c,h){b(c,h)})};xnm.aio.taskmanager.getVxProTasks=function(a,b){xnm.aio.taskmanager._callVxPro(a,"GetTask",null,b)};xnm.aio.taskmanager.setVxTaskActive=function(a,b,c){a.aio._executeRequest("SaveGroup",{id:a.id,active:b?1:0},null,c)};
xnm.aio.taskmanager.setVxProTaskActive=function(a,b,c){xnm.aio.taskmanager._callVxPro(a.aio,"SetTaskActive",{id:a.id,active:b},c)};
xnm.aio.taskmanager.saveVxTask=function(a,b,c){function h(n,p,q){XC.debugf("# del elements: "+n);var t=0,v=w[n],u=g[n];if(0===v.length)return q();v.forEach(function(x){var A=f.filter(function(y){return y.id==x&&u.includes(y.sys)})[0];if(!A)return q(Error(n+" not found"));xnm.aio.taskmanager.deleteVxElement(l,A,function(y,B){if(y)return q(y);r[p].splice(r[p].indexOf(A.id),1);++t===v.length&&q()})})}function d(n,p,q){XC.debugf("# add elements: "+n);var t=k[n];if(!t||!t.length)return q();var v=0;t.forEach(function(u){u.id=
xnm.aio.taskmanager.getNextVxElementId(r[p]);m[n]+=u.id;r[p].push(u.id);xnm.aio.taskmanager.addVxElement(l,u,function(x,A){if(x)return XC.debugf(x),q(Error("add element failed"));"ACTION"===u.sys&&"AIO"===u.type&&b.push(u);"ACTION"===u.sys&&"CLOUD"===u.type&&(a._localCloudId=u.id);++v===t.length&&q()})}.bind(this))}function e(n){XC.debugf("# del all");if(!a.id)return n();var p={id:a.id,options:"all"};a.alarmPin&&(p.pin=a.alarmPin);a.aio._executeRequest("DelGroup",p,null,function(q,t){if(q)return a.isAlarmTask?
n({msg:"pin error"}):n(Error("del group failed"));n()})}var l=a.aio,k=xnm.aio.taskmanager.mapProTaskToVx(a),f=null,g={groups:["GROUP"],actions:["ACTION","DEVICEACTION"],triggers:["TASK","ASTRO","EVENT","SEVENT"],conditions:["TIME"]},m={actions:"",triggers:"",conditions:""},r={groups:[],actions:[],triggers:[]},w={actions:[],triggers:[],conditions:[]},z=xnm.aio.taskmanager.hasDeleteAll(a.aio)?[e.bind(this)]:[h.bind(this,"triggers","triggers"),h.bind(this,"conditions","triggers"),h.bind(this,"actions",
"actions")];z=[function(n){function p(q){return q&&q.match(/.{1,2}/g)||[]}XC.debugf("# init");xnm.aio.taskmanager.getVxTasks(l,function(q,t){if(q)return n(q);f=t;if(a.id){q=t.filter(function(v){return"GROUP"===v.sys&&v.id==a.id})[0];if(!q)return n(Error("group not found"));w.actions=p(q.actionids);w.conditions=p(q.conditionids);w.triggers=p(q.triggerids)}r.groups=xnm.aio.taskmanager.getVxIdList(t,g.groups);r.actions=xnm.aio.taskmanager.getVxIdList(t,g.actions).concat(xnm.aio.taskmanager.getVxIdList(t,
g.conditions));r.triggers=xnm.aio.taskmanager.getVxIdList(t,g.triggers);n()})}].concat($jscomp.arrayFromIterable(z),[d.bind(this,"triggers","triggers"),d.bind(this,"conditions","triggers"),d.bind(this,"actions","actions"),function(n){var p=k.group;p.actionids=m.actions;p.triggerids=m.triggers;p.conditionids=m.conditions;p.id||(p.id=xnm.aio.taskmanager.getNextVxElementId(r.groups));a.id=p.id;var q=xnm.aio.taskmanager.SystemData,t=q.getGateways(function(u){return u.info.mac==a.aio._mac})[0];t.tasks||
(t.tasks=[]);var v=t.tasks.find(function(u){return u.id==a.id});v?v.name=a.name:t.tasks.push({id:a.id,name:a.name});q.saveGateway(t);a.alarmPin&&(p.pin=a.alarmPin);l._executeRequest("AddGroup",p,null,function(u,x){if(u)return a.isAlarmTask?n({msg:"pin error"}):n(Error("save group failed"));n()})}]);try{(new xnm.aio.taskmanager.FunctionStack(z)).start(c)}catch(n){XC.debugf(n)}};
xnm.aio.taskmanager.saveVxProTask=function(a,b){var c={data:a};a.alarmPin&&(c.pin=a.alarmPin);xnm.aio.taskmanager._callVxPro(a.aio,a.id?"UpdateTask":"CreateTask",c,function(h,d){if(h)return b(h,d);d&&d.id&&(a.id=d.id);b(null,d)})};xnm.aio.taskmanager.addVxLocalCloudActions=function(a,b,c){var h=a.root.then[0].then;b.some(function(d){return d.cloud})?h.some(function(d){return"CLOUD"===d.type})||h.push({type:"CLOUD",sys:"ACTION"}):a.root.then[0].then=h.filter(function(d){return"CLOUD"!==d.type});c()};
xnm.aio.taskmanager.deleteVxTask=function(a,b){function c(k,f,g){XC.debugf("# del elements: "+k);var m=0,r=e[k],w=d[k];if(0===r.length)return g();r.forEach(function(z){var n=h.filter(function(p){return p.id==z&&w.includes(p.sys)})[0];if(!n)return g();xnm.aio.taskmanager.deleteVxElement(a.aio,n,function(p,q){if(p)return g(p);++m===r.length&&g()})})}(function(k){var f=xnm.aio.taskmanager.SystemData,g=f.getGateways(function(r){return r.info.mac==k.aio._mac})[0];if(g.tasks){for(var m=g.tasks.length;m--;)g.tasks[m].id==
k.id&&g.tasks.splice(m,1);f.saveGateway(g)}})(a);if(xnm.aio.taskmanager.hasDeleteAll(a.aio))return a.aio._executeRequest("DelGroup",{id:a.id,options:"all"},null,b);var h=null,d={groups:["GROUP"],actions:["ACTION","DEVICEACTION"],conditions:["TIME"],triggers:["TASK","ASTRO","EVENT","SEVENT"]},e={actions:[],triggers:[],conditions:[]},l=[function(k){function f(g){return g&&g.match(/.{1,2}/g)||[]}XC.debugf("# init");xnm.aio.taskmanager.getVxTasks(a.aio,function(g,m){if(g)return k(g);h=m;if(a.id){g=m.filter(function(r){return"GROUP"===
r.sys&&r.id==a.id})[0];if(!g)return k(Error("group not found"));e.actions=f(g.actionids);e.conditions=f(g.conditionids);e.triggers=f(g.triggerids)}k()})},c.bind(this,"triggers","triggers"),c.bind(this,"conditions","triggers"),c.bind(this,"actions","actions"),function(k){a.aio._executeRequest("DelGroup",{id:a.id},null,k)}];(new xnm.aio.taskmanager.FunctionStack(l)).start(b)};xnm.aio.taskmanager.deleteVxProTask=function(a,b){xnm.aio.taskmanager._callVxPro(a.aio,"DeleteTask",{id:a.id},b)};
xnm.aio.taskmanager.addVxElement=function(a,b,c){var h={},d={SEVENT:"SensorEvent",DEVICEACTION:"DeviceAction"};d[b.sys]?(d="Add"+d[b.sys],h.method="POST"):d="Add"+b.sys.charAt(0).toUpperCase()+b.sys.toLowerCase().slice(1);a._executeRequest(d,b,h,c)};xnm.aio.taskmanager.deleteVxElement=function(a,b,c){var h={SEVENT:"SensorEvent"};h=h[b.sys]?"Del"+h[b.sys]:"Del"+b.sys.charAt(0).toUpperCase()+b.sys.toLowerCase().slice(1);a._executeRequest(h,{id:b.id},null,c)};
xnm.aio.taskmanager._callVxPro=function(a,b,c,h){(c=JSON.parse(JSON.stringify(c)))||(c={});c.XC_FNC=b;c.at=a._at;c.data&&delete c.data.aio;a.executeRequestV5Plus(c,function(d){if(h){if(!d)return h("error",d);if(d.error)return h(d.error,d);h(null,d.data)}})};xnm.aio.taskmanager.isVx=function(a){return"EA"!==a._hwv};xnm.aio.taskmanager.isSelve=function(a){return"E7"===a._hwv};xnm.aio.taskmanager.hasDeleteAll=function(a){return["e7","c1","c2","c3","c4"].includes(a._hwv.toLowerCase())};
xnm.aio.taskmanager.intToStrHex=function(a,b){b||(b=2);for(a=a.toString(16);a.length<b;)a="0"+a;return a.toUpperCase()};xnm.aio.taskmanager.FunctionStack=function(a){this._stack=a;this._onNext=function(b,c){if(b)return this._callback(b);var h=this._stack.shift();h?h(this._onNext.bind(this)):this._callback(b,c)};this.start=function(b){this._callback=b;this._onNext()}};xnm.aio.taskmanager.Handler=xnm.aio.taskmanager.Taskmanager;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.taskmanager.Handler);
